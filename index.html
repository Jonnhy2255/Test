<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>App Messagerie Firebase</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 450px;
    margin: 30px auto;
    padding: 0 15px;
  }
  h2 {
    text-align: center;
  }
  input, button {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  button {
    background: #007bff;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover {
    background: #0056b3;
  }
  #log {
    margin-top: 15px;
    padding: 12px;
    font-weight: bold;
    border-radius: 6px;
    white-space: pre-line;
  }
  #log.info {
    background: #d1ecf1;
    color: #0c5460;
  }
  #log.success {
    background: #d4edda;
    color: #155724;
  }
  #log.error {
    background: #f8d7da;
    color: #721c24;
  }
  #messages {
    margin-top: 20px;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 6px;
  }
  .message {
    padding: 6px;
    border-bottom: 1px solid #eee;
  }
  .message:last-child {
    border-bottom: none;
  }
  .message .user {
    font-weight: bold;
  }
</style>
</head>
<body>

  <h2>Inscription / Connexion</h2>

  <input id="email" type="email" placeholder="Email" autocomplete="off" />
  <input id="password" type="password" placeholder="Mot de passe" autocomplete="off" />
  <button id="registerBtn">S'inscrire</button>
  <button id="loginBtn">Se connecter</button>

  <div id="log" class="info" style="display:none;"></div>

  <div id="app" style="display:none;">
    <h2>Envoyer un message</h2>
    <textarea id="messageInput" rows="3" placeholder="Écris ton message ici..."></textarea>
    <button id="sendMessageBtn">Envoyer</button>

    <h3>Messages</h3>
    <div id="messages"></div>

    <button id="logoutBtn" style="margin-top: 20px; background: #dc3545;">Se déconnecter</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDTPLxUiA8lj82kqc6CyCPLQDITc0CtLUE",
    authDomain: "ichat-betai.firebaseapp.com",
    databaseURL: "https://ichat-betai-default-rtdb.firebaseio.com",
    projectId: "ichat-betai",
    storageBucket: "ichat-betai.appspot.com",
    messagingSenderId: "168337722600",
    appId: "1:168337722600:web:beb331f83cc4778c5b4d5d",
    measurementId: "G-STXPSZN7X8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const registerBtn = document.getElementById("registerBtn");
  const loginBtn = document.getElementById("loginBtn");
  const logDiv = document.getElementById("log");
  const appDiv = document.getElementById("app");
  const logoutBtn = document.getElementById("logoutBtn");
  const messageInput = document.getElementById("messageInput");
  const sendMessageBtn = document.getElementById("sendMessageBtn");
  const messagesDiv = document.getElementById("messages");

  function showLog(text, type="info") {
    logDiv.textContent = text;
    logDiv.className = type;
    logDiv.style.display = "block";
  }

  async function createUserProfile(uid, email) {
    // Vérifie si admin déjà défini
    const adminRef = doc(db, "Config", "admin");
    const adminSnap = await getDoc(adminRef);

    let statut = "simple";
    if (!adminSnap.exists()) {
      statut = "admin";
      // Crée l'admin dans Config
      await setDoc(adminRef, {
        uid: uid,
        email: email,
        createdAt: new Date().toISOString()
      });
    }

    // Crée le profil utilisateur dans Users
    const userRef = doc(db, "Users", uid);
    await setDoc(userRef, {
      email: email,
      statut: statut,
      createdAt: new Date().toISOString()
    });
    return statut;
  }

  registerBtn.addEventListener("click", async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) {
      showLog("Merci de remplir email et mot de passe.", "error");
      return;
    }
    showLog("Inscription en cours...", "info");
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;
      const statut = await createUserProfile(uid, email);
      showLog(`Inscription réussie. Statut : ${statut}`, "success");
      appDiv.style.display = "block";
    } catch (error) {
      showLog("Erreur inscription : " + error.message, "error");
    }
  });

  loginBtn.addEventListener("click", async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) {
      showLog("Merci de remplir email et mot de passe.", "error");
      return;
    }
    showLog("Connexion en cours...", "info");
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      showLog("Connexion réussie !", "success");
      appDiv.style.display = "block";
    } catch (error) {
      showLog("Erreur connexion : " + error.message, "error");
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    appDiv.style.display = "none";
    showLog("Déconnecté.", "info");
  });

  // Afficher les messages en temps réel
  function listenMessages() {
    const messagesRef = collection(db, "Messages");
    const q = query(messagesRef, orderBy("createdAt", "asc"));
    onSnapshot(q, (querySnapshot) => {
      messagesDiv.innerHTML = "";
      querySnapshot.forEach(docSnap => {
        const msg = docSnap.data();
        const div = document.createElement("div");
        div.classList.add("message");
        div.innerHTML = `<span class="user">${msg.email}:</span> ${msg.text}`;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  sendMessageBtn.addEventListener("click", async () => {
    const text = messageInput.value.trim();
    if (!text) {
      showLog("Le message est vide.", "error");
      return;
    }
    const user = auth.currentUser;
    if (!user) {
      showLog("Utilisateur non connecté.", "error");
      return;
    }
    showLog("Envoi du message...", "info");
    try {
      const messagesRef = collection(db, "Messages");
      await addDoc(messagesRef, {
        uid: user.uid,
        email: user.email,
        text: text,
        createdAt: new Date()
      });
      messageInput.value = "";
      showLog("Message envoyé.", "success");
    } catch (e) {
      showLog("Erreur envoi message : " + e.message, "error");
    }
  });

  // Sur changement d'état de connexion
  onAuthStateChanged(auth, (user) => {
    if (user) {
      showLog(`Connecté : ${user.email}`, "success");
      appDiv.style.display = "block";
      listenMessages();
    } else {
      appDiv.style.display = "none";
      showLog("Connectez-vous ou inscrivez-vous.", "info");
    }
  });

</script>

</body>
</html>
