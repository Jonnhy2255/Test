<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChatXchange</title>
    
    <!-- PWA Meta Tags pour iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChatXchange">
    <meta name="theme-color" content="#5D5CDE">
    
    <!-- Icônes pour iOS -->
    <link rel="apple-touch-icon" href="data:image/png;base64,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">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/png;base64,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">
    <link rel="apple-touch-icon" sizes="167x167" href="data:image/png;base64,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">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,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">
    
    <!-- Splash Screens pour iOS -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAAJACAYAAAD1CiXWAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAVnSURBVHgB7dRBDQAhEATB5cMR/AcTQXA2HiCgqgJ2JAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMBHOmJmZ7b0CfzFSh+Ax07HJ/xrCiCJAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBI9AJ2ugJ31Yvo4AAAAABJRU5ErkJggg==">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPoAAAGECAYAAAAmj3KmAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAYgSURBVHgB7dRBDQAhEATB5cMR/AcTQXA2HiCgqgJ2JAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMBHOmJmZ7b0CfzFSh+Ax07HJ/xrCiCJAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBI9AJ2ugJ31Yvo4AAAAABJRU5ErkJggg==">
    
    <!-- Manifest Web App -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkNoYXRYY2hhbmdlIiwKICAic2hvcnRfbmFtZSI6ICJDaGF0WGNoYW5nZSIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBT0FBQUFEZ0NBWUFBQUNMWXYrbEFBQUFDWFpJV1hNQUFBc1RBQUFMRXdFQW1wd1lBQUFBQVhOU1IwSUFyczRjNlFBQUFBUm5RVTFCQUFDeGp3djhZUVVBQUFxblNVUkJWSGdCN1oxZGJCUlZGTWZQbmRsQ0FiVlFDZ1hhbHJJVUVDVDRMWWlKeGtTTmlaRkVqUnFKYndhanR0RVlYM3p3eFFjZk5ERkdpSWthbzlFSFF6U0JLUEdqZ0ZIRUlsSkstU2d0M2U1dVd5aUZRZ3VGZCtnY3o1M3RsaTVsdTlPOU4yYnV6UG05UUhmMzdHeXYvdCtuelhWckF4U2srVW9oa3JRaUVVaW9WV2xTaW1oQ0thSjJFUWxHYzdxUUZGSGdMeWg0MDQ5WEVEaUZaSFJBQWdsRXdlQWVTMW5pRHJzOFpTZnNBNVo5ODVZbHJJNVhnWEdUb21rbUVBR1R4Q1JqWVQ2bXo1SUtJNEx5OWJwTUtBRENBdEE0dWg4Mk9EdWsrd01OZ3lNVTZRaERCV2dMZ09ZSi9XQWYxVGppcXdRV0NHbFBHQlZkTU5qOUtiQjF3RmZ4QUdpWU9PQ3ByajBUT21JTDUweVh0K29JQkcwQTBEaXhseVh0TFdBaHQ4MjhnYnZoazhiYUNLdzNjZ010MjBod0ZqUXdIK1Y3SFJ2c00wRkE5SWJqNFdZYlZKU1oyeXZaQXhjbGdJZmdOdWdMZ09ZSi9hNE45dWtnQUIxbHhmV0dnVUhxKzUwZ1VKTDNPT2llU3gydjZndGhvYXN6V0lkeVdnRXdoc21CanV5MEN6UDJCdFAvMlpHMXdXWGdHeEg0MXJjZnJjbUV0dE5INkJoMXJxZDlPQitPaXdrQmVnTFFOTEhQVXVZeVZSK0JNR09uQW4vd241VFFCNUN0Z1c5OUc4QVdnSTJUK3owYjdETkIyTG1ycE9nR3ZqY2dDdnVSOGI3MXZnWnRBZGp5elg2ZHR6NHdScVlqMXU1Y0JuOVpBeXVQT3g0QkxjbDRJMnVEZmdiOER0c09mNkgwMWljZCtIRHYzVmxCVXpDYWhqcTh2QnJLU3FCdGg3NVF2dlg1WTlyc1J3cFlLOW5TdzhOVk1KUUVZTXZCLzVRcy9aY2hEeEVDQm05b1dtY0x2a2xGQUZUVmVla0VxaHUwRWdJV3ZQVkp1UlZyZC8xMVVCeGxKZEhPdzUvclZ2VEpEZ05mYTMrV28wWFRqc09xbzF6TDcrZk9uNDA1WDNYN2xzRm4zVDhEUlZFU2dNOSsvU0x3STE4bWVERnQ4KzVsc2hHeEIxUkdPUW4wMlpHdmZKL2Y5d3BlNXVMc1dCMGtrV0lpaW9JU0FIU2Q2QTJVOXM4WHFiTGc5YzZsTU5CeGI4Z2lLRE1Gc2hKcFRrUWtwZ0ZKMjVJbmdDMEhHVXVoREFCZDAwK1REUnU5dC9saENFRlFBZ0FkdGIrWXVPM1FsdXBlaW1DT1FOdU9mQ1BYUElRQUJnY0dRUkY4RDBEMTBXL2x1WHZnUStERm9HWHdkUXFrUStLckhNeERrWXc3bTViQitiRXJzcFg4ZmdjZ0tHbm9aODhmUEtGOTJ3RjJuem9ReU5iL2JQRFh1L1pZV3dJLy91ZnR0djJBWEFkQTk4V3ZYSWxIeGE2V3hVOGhBdUFINWpyYTlwWHVudzM1T2ozWkQwblRuL1dxR1FBZ3B6d2c3ZTlwcDNTUjdaajVCZ0F2ZlNZc2Z6YitQT2ZBSW53RFFMNERuUEtuTnZWcFhDdktRUGNBakk5Snhd2NoV1RZLy9RM1BnRWcrcjEvbUIxQzY1SUt3VlVsTGgxOTRGei8vS3ZIUzF2ZWg4dFgvZzJWcWcxdzJyd2lnU1FxTlJzanYwY2dOWTRIZnpLanhhK2V2OXQ4azE4QWlDb3ZmdHhnMC81ZU12VUFzdlRsQzZLaG1DY1lMSUx0TnZJRkFMKzFQejlpME56OU8rekZZNkhXeXA5S2Z3RVFCdjAvSHA3MURTZEgyangvbHVjQStMbjJ1YjZxRmpadFh3cXUyeFlEVVJ5QTUwWVlodXlLSWNnUXp6TUFncUQrS1hDK0V1Ylh0Y0F6dFcydyByL3Z4SXVOYW4wKzQySExzTmlQbXE4QklBVnhRc2xyWCt1cjZtQ1Q5cVd3U2R0aUtJbjc4ZHdJdzVEZE1RUzU0SGtHUUJEV1A1a1g2MkZCWFFzOFc5c0dhendiQlRCU2Ew7Qnc3cm9JZ2ZZVnZBMkRaSVg0Z2FwU2wvVW7ReUo1dVh3UXRNOHFLcHR1Yjh5U0luR2FrR3loTlRPbXVRYWdGRFpZZkU1QWV3bzhyY0o0QVlEaGV5TWdDTS9xbWtnRUwwWTVWbmtDUUdWR01ka1RuYUptVmxwNkFvRFg1ZjljV09IcUJsWkdwbmxuNzdwWEFGUmtHVWdUSWYySEpKUThWU1ZBS0VxSnlIaEZRTWhTQi9HdG56Y0FoRldHcFprWkk4aHc0cTQzQUlSdytqTktxSXFZRTZSZEF4Q09GSWpzakFBb0k3bE0xd0JVbGxXRUJnQW0wbEJWQXc3QkNKVVY1bk5jcmdFSVExYU0wVVl3SW12QUlYQUZnQnZka2VYK2RtdU5BUzA4WTYwMVZ2WWdjOW5xK3JJQlprdmdQQURsSk9NeTRLbmFCbml2YVI2czllRDg5dG5CUGNHNlowRlNGcGRUSVZjQVJFSjJzVnRRMGlEdjNIemwxOXJUWjdtM0hmOEQya2Zpb1V1TGNwV29oUlRwQ29ESzBtclJXNmRNd2l1elowSHEabnRWbTM0TEpOeVR1YXlIbGc4ZFNxeERPRjBCNEZiL2N3cS85VmdsckdpWUkwZDZKM2VNWU1td3YyN3dDMlpaTTNTdWdEc3VBWWlRcnZzWUFFNkIrRTd4cStmT2x1TFdUdkg3ekZ5TkJNcW5RVllTS0p4OCtJUWJIU0JFZmI0WHhDamd6K2ZQakk1NmQwZ2JBSHJFbjF0S3c4eUFRTzN4RjVNZWdiS1F6OHNJZHVYTWZ1c09EYnRUdjBoYVhwUXNLVXVCQkFLeWVsWW5zRjNIM3JwMmFyVWN6VGtsa1Z6bGVlUk5ZSS8xcGdOcUE4QlRvYS9KMTJxcGtYdVZlcnRkL2NpVkttQ2U0U3JkcXl3dEJaQWpEK3lBSlRIL25iUTAvQzlXNVFwWEhZUFdqdE5NbWhYK3VrNUs0Y3NuVk91OC9iWEdqUUVybkNsa29Sa093V0VDRktpK3FxcHEyRHg3T1pEdm1qOTc7Y3ZNd1lEQitDc2o0cUY0QUVKVkNqRjA5bXpCOS9WQkJUWWRrNVRwblN4bmlrUi9mQmFWSGdmNHhiekR1RFhjU2ZJRWdLT1Q0emNEbGI0dTJPZ3hBTVJ1V3FxeWxrbVhRbGhTVTlnTXlCVUZpcUljam9nQ2hMNEt4SnpJcjZTbXNJVWRuMTBtb1JxaGJDblFybyt1d1NtVFg0eEtBU1NMSGF0YkloQ29DVkQzaXFqOHlMS1YvN01rT2tCRWRVRWFIRnFnUlRJd1lT44PRGN1OG1RY0haYkNWakR0d0VmTUdRQ2RCMjJ6RHdCV0pUalVPWFJCOTBTWE5vTTl0YTZoSlB3Q0JHRVRjYWxpeXJSRjk1Y0R1alVpMDZBQlFDZ0xRT2ZnT2NoNUNPMlE1WFF0WXhaQWkwanlicmRsd3hNSkdhZVdJam1ZWFNkUHlvejRtSjFBUDZFb3FZMU5jOUE3MkFjNncvWXpKL3RJWDkydGVXMEpEVjNabWdpN0FVOEwxNHk5anFnZVprdUdzQngrN05JNEh4djhGOVNIcXZjWXBmSU5YV09uUU8rWmoyVlZoKykrOE5ucWkwcUs0Y2VHdjZFMUVUYUN5TEg5b0haOEdaSG5KeHpKMzlGTGh5ODlLQU5BVlZtRmZLckN1TnB1S0JhemZWMUIyWFd5RTdwTzlVRFhTSDlrcDBsQlFVTnZuaGZHOXJidE87VDN6RW5ZRnJzdkowY1hFTFlnUElIWUFGUldWc0NzK3B5OHFpb1VzNzI5dnFwbXZPM3Y5OCt1QnJxS05BMk9VRHo0QitUNVUwaDJ2UUcyQVZGVU16UjNCRVE3ME53TDBIZXFCZmFkUGg0N1hZS2MwNz1qNWdmSU5QVmlYQStWSUhicWlaTVFmTGE3emtVYmdhbkg1eFhmTnVHZlB1ODllVkFtclMxWk5qdlRBQkR0QW5oRzNBekdOQUY3TWg0VUo4TnlwaGZHZlV3QmNTRgtXLXdkL1gvMnZGUUNqSVdDL3N0L0NON3Y0Ri9QK0ZaTHJVNTRHZXBtbCtWL2trZFNYdEhqcEJOZlRna2RzQUF3dks3MVB3T1AxTSgzdGtKRE5QOTRHK1JGd1UxQkNJVndjeVJVT2JreXhuYUc0Mm1XVnRHSnZVU0tDK0hqUDYyZ0N1U0cwYzZvTkNjTG5LZKhwMUNYMEFVQ250RHdaIxZLW0VGZFhSWGNVbFFOei9YdGc1TTkvVkw2Y0Rib0pKTEN3eGxsVXdDOFI5eGE2bzMwZ3NPOHdGQU9kcTJuWDNVQStFdnhmSlJmWjBXYm4yTDFqd3dWUUZRUHVJYmo3UngvMVA2QkJhUE9saGxPZ1NSRTBNb3dwUVdPVk01MmZyTUFpRUNPQ0Z6WXlVUGdYK3psdGFMZ2pBUTYyc2h2KzlIZStPZ1Y3WnQ4RFhUOXNoYkprT2ZHZVhHbVMrR0tXWW5hZUxGYlFsQXJjaXNrUG1xaHplRmk3eko3SnZzOXJMZThqNmMzMkFldndhaFFRVmRxQXlTd25MaGNleU5Pam9BN1RiN2RMQ2JBTUFRTUJram1hOTBiK200MmxlL2diUmJWcGQzdE5aMlRyYUU3QklGVkhmNEgxWlVWNzBRNHdmb0FBQUFBQUVsRlRrU3VRbUNDIiwKICAgICAg5XNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXSwKICAic3RhcnRfdXJsIjogIi4vaW5kZXguaHRtbCIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzVkNWNkZSIsCiAgInRoZW1lX2NvbG9yIjogIiM1ZDVjZGUiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIKfQo=">

    <style>
        /* Base styles avec ajout de préfixes pour iOS 12 Safari */
        * {
            margin: 0;
            padding: 0;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-user-select: none;
            user-select: none; /* Prevent text selection */
        }
        
        :root {
            --accent-color: #5D5CDE;
            --accent-color-dark: #4C4BAE;
            --accent-color-light: #7A79E8;
            --accent-gradient: -webkit-linear-gradient(315deg, var(--accent-color), var(--accent-color-dark));
            
            /* New gradient themes */
            --purple-gradient: -webkit-linear-gradient(315deg, #9D50BB, #6E48AA);
            --blue-gradient: -webkit-linear-gradient(315deg, #2193b0, #6dd5ed);
            --green-gradient: -webkit-linear-gradient(315deg, #11998e, #38ef7d);
            --orange-gradient: -webkit-linear-gradient(315deg, #FF8008, #FFC837);
            --red-gradient: -webkit-linear-gradient(315deg, #ED213A, #93291E);
            --pink-gradient: -webkit-linear-gradient(315deg, #F857A6, #FF5858);
            --teal-gradient: -webkit-linear-gradient(315deg, #11998e, #38ef7d);
            
            --text-color: #333;
            --bg-color: #ffffff;
            --card-bg: #ffffff;
            --border-color: #eaeaea;
            --secondary-bg: #f5f5f5;
            --secondary-text: #777;
            --header-height: 60px;
            --footer-height: 56px;
            --input-height: 60px;
            --success-color: #4CAF50;
            --success-color-dark: #388E3C;
            --error-color: #EF4444;
            --error-color-dark: #DC2626;
            --warning-color: #F59E0B;
            --warning-color-dark: #D97706;
            --info-color: #3B82F6;
            --info-color-dark: #2563EB;
        }
        
        .dark {
            --text-color: #f5f5f5;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --secondary-bg: #252525;
            --secondary-text: #aaa;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
        }
        
        /* Pour désactiver le zoom sur iOS */
        body {
            -webkit-touch-action: manipulation;
            touch-action: manipulation;
        }
        
        /* Adaptations pour le zoom iOS */
        input, textarea, select, button {
            font-size: 16px; /* Empêche le zoom sur iOS */
        }
        
        /* Empêcher le surlignage sur les appuis longs sur iOS */
        * {
            -webkit-touch-callout: none;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            height: 100%;
            display: -webkit-box;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            background-color: var(--bg-color);
            position: relative;
            -webkit-box-shadow: 0 0 10px rgba(0,0,0,0.05);
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .dark .container {
            -webkit-box-shadow: 0 0 10px rgba(0,0,0,0.2);
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        
        .header {
            padding: 12px 16px;
            background: var(--accent-gradient);
            color: white;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 100;
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            height: var(--header-height);
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 600;
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            text-align: center;
        }
        
        .back-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-transition: background-color 0.2s;
            transition: background-color 0.2s;
        }
        
        .back-button:active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .more-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-transition: background-color 0.2s;
            transition: background-color 0.2s;
        }
        
        .more-button:active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .search-bar {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 8px 16px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            margin: 0 8px;
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            -webkit-transition: background-color 0.3s;
            transition: background-color 0.3s;
        }
        
        .search-bar:focus-within {
            background-color: rgba(255, 255, 255, 0.25);
        }
        
        .search-input {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            width: 100%;
            padding: 0 8px;
            outline: none;
        }
        
        .search-input::-webkit-input-placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .main {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: var(--footer-height);
            position: relative;
        }
        
        .main::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari and Opera */
        }
        
        .tab-bar {
            display: -webkit-box;
            display: flex;
            background-color: var(--card-bg);
            -webkit-box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            border-top: 1px solid var(--border-color);
            height: var(--footer-height);
        }
        
        .tab-button {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            padding: 6px 0;
            text-align: center;
            cursor: pointer;
            display: -webkit-box;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            color: var(--secondary-text);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            position: relative;
        }
        
        .tab-button.active {
            color: var(--accent-color);
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 20%;
            height: 3px;
            background: var(--accent-gradient);
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            border-radius: 3px 3px 0 0;
        }
        
        .tab-button-icon {
            margin-bottom: 4px;
            -webkit-transition: -webkit-transform 0.2s ease;
            transition: transform 0.2s ease;
        }
        
        .tab-button:active .tab-button-icon {
            -webkit-transform: scale(0.9);
            transform: scale(0.9);
        }
        
        .tab-button-label {
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Auth screen */
        .auth-container {
            height: 100%;
            display: -webkit-box;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            padding: 20px;
            background: -webkit-linear-gradient(top, rgba(93, 92, 222, 0.1), rgba(93, 92, 222, 0.05));
        }
        
        .dark .auth-container {
            background: -webkit-linear-gradient(top, rgba(93, 92, 222, 0.2), rgba(93, 92, 222, 0.1));
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 32px;
            -webkit-animation: fadeIn 1s ease-out;
            animation: fadeIn 1s ease-out;
        }
        
        @-webkit-keyframes fadeIn {
            from { opacity: 0; -webkit-transform: translateY(-20px); transform: translateY(-20px); }
            to { opacity: 1; -webkit-transform: translateY(0); transform: translateY(0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; -webkit-transform: translateY(-20px); transform: translateY(-20px); }
            to { opacity: 1; -webkit-transform: translateY(0); transform: translateY(0); }
        }
        
        .auth-logo h1 {
            color: var(--accent-color);
            font-size: 32px;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .auth-form {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            -webkit-box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            -webkit-animation: slideUp 0.5s ease-out;
            animation: slideUp 0.5s ease-out;
        }
        
        @-webkit-keyframes slideUp {
            from { opacity: 0; -webkit-transform: translateY(30px); transform: translateY(30px); }
            to { opacity: 1; -webkit-transform: translateY(0); transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; -webkit-transform: translateY(30px); transform: translateY(30px); }
            to { opacity: 1; -webkit-transform: translateY(0); transform: translateY(0); }
        }
        
        .dark .auth-form {
            -webkit-box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .auth-tabs {
            display: -webkit-box;
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .auth-tab {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            position: relative;
            font-weight: 500;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .auth-tab.active {
            color: var(--accent-color);
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-gradient);
            -webkit-animation: growWidth 0.3s ease-out;
            animation: growWidth 0.3s ease-out;
        }
        
        @-webkit-keyframes growWidth {
            from { -webkit-transform: scaleX(0); transform: scaleX(0); }
            to { -webkit-transform: scaleX(1); transform: scaleX(1); }
        }
        
        @keyframes growWidth {
            from { -webkit-transform: scaleX(0); transform: scaleX(0); }
            to { -webkit-transform: scaleX(1); transform: scaleX(1); }
        }
        
        .form-group {
            margin-bottom: 16px;
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            color: var(--text-color);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            -webkit-box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.2);
            box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.2);
        }
        
        .btn {
            padding: 14px 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            background: -webkit-linear-gradient(315deg, var(--accent-color-light), var(--accent-color));
            -webkit-transform: translateY(-1px);
            transform: translateY(-1px);
            -webkit-box-shadow: 0 4px 8px rgba(93, 92, 222, 0.3);
            box-shadow: 0 4px 8px rgba(93, 92, 222, 0.3);
        }
        
        .btn-primary:active {
            -webkit-transform: translateY(1px);
            transform: translateY(1px);
            -webkit-box-shadow: 0 2px 4px rgba(93, 92, 222, 0.3);
            box-shadow: 0 2px 4px rgba(93, 92, 222, 0.3);
        }
        
        /* Conversation list */
        .conversation-list {
            display: -webkit-box;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
        }
        
        .conversation-item {
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
            position: relative;
            border-bottom: 1px solid var(--border-color);
        }
        
        .conversation-item:active {
            background-color: var(--secondary-bg);
        }
        
        .conversation-item.selected {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .dark .conversation-item.selected {
            background-color: rgba(93, 92, 222, 0.2);
        }
        
        .conversation-checkbox {
            margin-right: 14px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
        }
        
        .conversation-item.selected .conversation-checkbox {
            border-color: var(--accent-color);
            background-color: var(--accent-color);
        }
        
        .conversation-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--accent-gradient);
            color: white;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin-right: 14px;
            position: relative;
            -webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .dark .conversation-avatar {
            -webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .conversation-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            -o-object-fit: cover;
            object-fit: cover;
        }
        
        .conversation-status {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid var(--card-bg);
            background-color: #ccc;
        }
        
        .conversation-status.online {
            background-color: var(--success-color);
            -webkit-box-shadow: 0 0 0 2px var(--card-bg), 0 0 0 4px rgba(76, 175, 80, 0.3);
            box-shadow: 0 0 0 2px var(--card-bg), 0 0 0 4px rgba(76, 175, 80, 0.3);
            -webkit-animation: pulse 2s infinite;
            animation: pulse 2s infinite;
        }
        
        @-webkit-keyframes pulse {
            0% {
                -webkit-box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
            }
            70% {
                -webkit-box-shadow: 0 0 0 6px rgba(76, 175, 80, 0);
                box-shadow: 0 0 0 6px rgba(76, 175, 80, 0);
            }
            100% {
                -webkit-box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }
        
        @keyframes pulse {
            0% {
                -webkit-box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
            }
            70% {
                -webkit-box-shadow: 0 0 0 6px rgba(76, 175, 80, 0);
                box-shadow: 0 0 0 6px rgba(76, 175, 80, 0);
            }
            100% {
                -webkit-box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }
        
        .conversation-content {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            overflow: hidden;
        }
        
        .conversation-name {
            font-weight: 600;
            margin-bottom: 4px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            color: var(--text-color);
        }
        
        .conversation-blocked {
            margin-left: 6px;
            font-size: 12px;
            font-weight: normal;
            color: var(--error-color);
        }
        
        .conversation-message {
            color: var(--secondary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }
        
        .conversation-meta {
            display: -webkit-box;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-box-align: end;
            -webkit-align-items: flex-end;
            align-items: flex-end;
            margin-left: 8px;
        }
        
        .conversation-time {
            color: var(--secondary-text);
            font-size: 12px;
            white-space: nowrap;
            margin-bottom: 4px;
        }
        
        .conversation-badge {
            background: var(--accent-gradient);
            color: white;
            font-size: 12px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Chat screen */
        .chat-container {
            display: -webkit-box;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%235d5cde' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .dark .chat-container {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%235d5cde' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .chat-header {
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            padding: 12px 16px;
            background: var(--accent-gradient);
            color: white;
            -webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            height: var(--header-height);
        }
        
        .chat-title {
            font-weight: 600;
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
        }
        
        .chat-title-status {
            font-size: 12px;
            font-weight: normal;
            margin-left: 6px;
            opacity: 0.8;
        }
        
        .chat-menu-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-transition: background-color 0.3s;
            transition: background-color 0.3s;
        }
        
        .chat-menu-button:active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .chat-menu {
            position: absolute;
            top: 100%;
            right: 10px;
            background-color: var(--card-bg);
            border-radius: 8px;
            -webkit-box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            overflow: hidden;
            -webkit-transform-origin: top right;
            transform-origin: top right;
            -webkit-animation: scale-in 0.2s ease-out;
            animation: scale-in 0.2s ease-out;
        }
        
        @-webkit-keyframes scale-in {
            from { -webkit-transform: scale(0.9); transform: scale(0.9); opacity: 0; }
            to { -webkit-transform: scale(1); transform: scale(1); opacity: 1; }
        }
        
        @keyframes scale-in {
            from { -webkit-transform: scale(0.9); transform: scale(0.9); opacity: 0; }
            to { -webkit-transform: scale(1); transform: scale(1); opacity: 1; }
        }
        
        .chat-menu-item {
            padding: 12px 16px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            cursor: pointer;
            -webkit-transition: background-color 0.3s;
            transition: background-color 0.3s;
            white-space: nowrap;
            color: var(--text-color);
        }
        
        .chat-menu-item:active {
            background-color: var(--secondary-bg);
        }
        
        .chat-menu-item svg {
            margin-right: 12px;
            width: 20px;
            height: 20px;
        }
        
        .chat-menu-item.danger {
            color: var(--error-color);
        }
        
        .chat-messages {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-top: calc(var(--header-height) + 16px);
            padding-bottom: calc(var(--input-height) + 16px); /* Extra padding for input bar */
            background-color: rgba(245, 245, 245, 0.8);
            -webkit-overflow-scrolling: touch;
            height: 100%;
        }
        
        .chat-messages::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Safari */
        }
        
        .dark .chat-messages {
            background-color: rgba(18, 18, 18, 0.8);
        }
        
        .message-day-separator {
            text-align: center;
            padding: 12px 0;
            position: relative;
            margin: 20px 0;
        }
        
        .message-day-separator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background-color: rgba(0, 0, 0, 0.1);
            z-index: -1;
        }
        
        .dark .message-day-separator::before {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .message-day-text {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            color: #888;
            display: inline-block;
        }
        
        .dark .message-day-text {
            background-color: rgba(30, 30, 30, 0.8);
        }
        
        .message-group {
            margin-bottom: 8px;
            display: -webkit-box;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            position: relative;
        }
        
        .message-group.sent {
            -webkit-box-align: end;
            -webkit-align-items: flex-end;
            align-items: flex-end;
        }
        
        .message-group.received {
            -webkit-box-align: start;
            -webkit-align-items: flex-start;
            align-items: flex-start;
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 2px;
            position: relative;
            -webkit-transform-origin: bottom;
            transform-origin: bottom;
            -webkit-box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-break: break-word;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .message-bubble.selected {
            background-color: rgba(93, 92, 222, 0.2) !important;
        }
        
        .message-sent {
            background: var(--accent-gradient);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-received {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            text-align: right;
            margin-top: 4px;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .message-sent .message-time {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .message-status {
            display: -webkit-inline-box;
            display: -webkit-inline-flex;
            display: inline-flex;
            margin-left: 4px;
        }
        
        .message-status svg {
            width: 14px;
            height: 14px;
        }
        
        .message-image-container {
            position: relative;
            margin-bottom: 4px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .message-image {
            max-width: 250px;
            max-height: 200px;
            display: block;
            border-radius: 8px;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .message-image:active {
            opacity: 0.9;
        }

        /* Message reactions */
        .message-reactions {
            display: -webkit-box;
            display: flex;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }
        
        .message-reaction {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        
        .message-received .message-reaction {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .message-reaction-count {
            font-size: 10px;
            font-weight: bold;
        }
        
        .reaction-picker {
            position: absolute;
            background-color: var(--card-bg);
            border-radius: 24px;
            -webkit-box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 6px;
            display: -webkit-box;
            display: flex;
            gap: 4px;
            z-index: 100;
            -webkit-transform-origin: center;
            transform-origin: center;
            -webkit-animation: scale-in 0.2s ease-out;
            animation: scale-in 0.2s ease-out;
        }
        
        .reaction-picker-item {
            font-size: 18px;
            padding: 6px;
            cursor: pointer;
            border-radius: 50%;
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
        }
        
        .reaction-picker-item:active {
            background-color: var(--secondary-bg);
            -webkit-transform: scale(1.1);
            transform: scale(1.1);
        }
        
        /* Top message action buttons */
        .message-action-buttons {
            display: -webkit-box;
            display: flex;
            gap: 10px;
            margin-right: 10px;
        }
        
        .message-action-btn {
            background: none;
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 14px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            cursor: pointer;
            -webkit-transition: background-color 0.2s;
            transition: background-color 0.2s;
        }
        
        .message-action-btn:active {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .message-action-btn svg {
            margin-right: 4px;
            width: 18px;
            height: 18px;
        }
        
        .chat-input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            z-index: 100;
            padding: 8px 16px;
            height: var(--input-height);
        }
        
        .chat-input {
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            background-color: var(--secondary-bg);
            padding: 4px 8px;
            border-radius: 24px;
        }
        
        .dark .chat-input {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .media-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: none;
            border: none;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            color: var(--secondary-text);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .media-button:active {
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
            color: var(--accent-color);
        }

        /* Emoji button */
        .emoji-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: none;
            border: none;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            color: var(--secondary-text);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .emoji-button:active {
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
            color: var(--accent-color);
        }
        
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 16px 16px 0 0;
            -webkit-box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            padding: 16px;
            z-index: 100;
            -webkit-animation: slide-up 0.3s ease-out;
            animation: slide-up 0.3s ease-out;
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @-webkit-keyframes slide-up {
            from { -webkit-transform: translateY(100%); transform: translateY(100%); }
            to { -webkit-transform: translateY(0); transform: translateY(0); }
        }
        
        @keyframes slide-up {
            from { -webkit-transform: translateY(100%); transform: translateY(100%); }
            to { -webkit-transform: translateY(0); transform: translateY(0); }
        }
        
        .emoji-category {
            margin-bottom: 16px;
        }
        
        .emoji-category-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--secondary-text);
        }
        
        .emoji-grid {
            display: -webkit-box;
            display: flex;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .emoji-item {
            font-size: 20px;
            height: 36px;
            width: 36px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
        }
        
        .emoji-item:active {
            background-color: var(--secondary-bg);
            -webkit-transform: scale(1.1);
            transform: scale(1.1);
        }
        
        .message-input-container {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            position: relative;
            margin: 0 8px;
        }
        
        .message-input {
            width: 100%;
            padding: 10px 0;
            border: none;
            border-radius: 0;
            font-size: 16px;
            background: none;
            color: var(--text-color);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .message-input:focus {
            outline: none;
        }
        
        .send-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: none;
            border: none;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            color: var(--accent-color);
        }
        
        .send-button:active {
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
        }

        /* Custom image preview */
        .custom-image-preview {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: -webkit-box;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            z-index: 1000;
            -webkit-animation: fadeIn 0.2s ease-out;
            animation: fadeIn 0.2s ease-out;
        }
        
        .custom-image-preview-content {
            position: relative;
            max-width: 90%;
            max-height: 80vh;
        }
        
        .custom-image-preview img {
            max-width: 100%;
            max-height: 80vh;
            -o-object-fit: contain;
            object-fit: contain;
            border-radius: 8px;
            -webkit-animation: scaleIn 0.3s ease-out;
            animation: scaleIn 0.3s ease-out;
        }
        
        @-webkit-keyframes scaleIn {
            from { -webkit-transform: scale(0.9); transform: scale(0.9); }
            to { -webkit-transform: scale(1); transform: scale(1); }
        }
        
        @keyframes scaleIn {
            from { -webkit-transform: scale(0.9); transform: scale(0.9); }
            to { -webkit-transform: scale(1); transform: scale(1); }
        }
        
        .custom-image-preview-actions {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: -webkit-box;
            display: flex;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            gap: 20px;
            padding: 10px;
        }
        
        .custom-image-preview-action {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
        }
        
        .custom-image-preview-action:active {
            background-color: rgba(255, 255, 255, 0.4);
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
        }
        
        .custom-image-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* Message sending animation */
        .message-sending {
            opacity: 0.7;
            position: relative;
        }
        
        .message-sending::after {
            content: '';
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: transparent;
            border-radius: 50%;
            -webkit-animation: spinner 0.8s linear infinite;
            animation: spinner 0.8s linear infinite;
        }
        
        @-webkit-keyframes spinner {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }
        
        @keyframes spinner {
            to { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }
        
        /* Last seen indicator - enhanced */
        .last-seen-indicator {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 4px;
        }
        
        .user-last-active {
            font-style: italic;
            opacity: 0.9;
        }
        
        /* Fix for mobile keyboard */
        @media screen and (max-height: 600px) {
            .chat-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
            }
            
            .chat-input-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 1000;
            }
            
            .chat-messages {
                margin-top: var(--header-height);
                margin-bottom: var(--input-height);
                height: calc(100vh - var(--header-height) - var(--input-height));
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
            }
        }
        
        /* Modifications pour iOS 12 */
        @supports (-webkit-overflow-scrolling: touch) {
            /* Correction pour le débordement sur iOS */
            .chat-messages, .main, .emoji-picker {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Éviter les problèmes de sélection sur iOS */
            * {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
            }
            
            /* Permettre la sélection dans les entrées */
            input, textarea {
                -webkit-user-select: text;
            }
            
            /* Éviter le zoom sur les entrées */
            input, textarea, select, button {
                font-size: 16px;
            }
            
            /* Empêcher le recalcul de hauteur quand le clavier apparaît */
            body {
                height: 100%;
                position: fixed;
                overflow: hidden;
                width: 100%;
            }
            
            .container, .main {
                overflow: auto;
            }
        }
        
        /* Fixes for iOS Keyboard */
        @supports (-webkit-touch-callout: none) {
            .keyboard-open .chat-input-container {
                position: absolute;
                bottom: 0;
            }
        }
        
        /* Classes d'animation simplifiées pour iOS 12 */
        .message-new {
            -webkit-animation: simple-fade-in 0.3s ease-out;
            animation: simple-fade-in 0.3s ease-out;
        }
        
        @-webkit-keyframes simple-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes simple-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Réglages spécifiques pour Safari iOS 12 */
        @media not all and (min-resolution:.001dpcm) { 
            @supports (-webkit-appearance:none) {
                .chat-messages, .main {
                    height: 100%;
                    -webkit-transform: translateZ(0);
                }
                
                /* Améliorer le scroll */
                .main::-webkit-scrollbar {
                    width: 0px;
                }
                
                /* Réduire les animations complexes */
                @-webkit-keyframes pulse {
                    0% { opacity: 0.8; }
                    50% { opacity: 1; }
                    100% { opacity: 0.8; }
                }
                
                .conversation-status.online {
                    -webkit-animation: pulse 2s infinite;
                    -webkit-box-shadow: none;
                }
            }
        }
        
        /* Batch action bar */
        .batch-actions-bar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            padding: 12px 16px;
            background-color: var(--accent-color);
            color: white;
            z-index: 95;
            -webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            -webkit-animation: slide-down-banner 0.3s forwards;
            animation: slide-down-banner 0.3s forwards;
        }
        
        .batch-actions-title {
            font-weight: 600;
        }
        
        .batch-action-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            margin-left: 8px;
            cursor: pointer;
        }
        
        .batch-action-button:active {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Empty states */
        .empty-state {
            display: -webkit-box;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }
        
        .empty-state-icon {
            width: 80px;
            height: 80px;
            color: #ccc;
            margin-bottom: 20px;
        }
        
        .dark .empty-state-icon {
            color: #444;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        
        .empty-state-text {
            color: var(--secondary-text);
            max-width: 250px;
        }
        
        /* Search styles */
        .search-container {
            padding: 8px 16px;
            position: -webkit-sticky;
            position: sticky;
            top: var(--header-height);
            z-index: 90;
            background-color: var(--bg-color);
            -webkit-animation: fade-in 0.3s;
            animation: fade-in 0.3s;
        }
        
        .search-wrapper {
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            background-color: var(--secondary-bg);
            border-radius: 10px;
            padding: 8px 12px;
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
        }
        
        .search-wrapper:focus-within {
            -webkit-box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.2);
            box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.2);
        }
        
        .dark .search-wrapper:focus-within {
            -webkit-box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.4);
            box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.4);
        }
        
        .search-icon {
            color: var(--secondary-text);
            margin-right: 8px;
        }
        
        .search-clear {
            background: none;
            border: none;
            color: var(--secondary-text);
            cursor: pointer;
            padding: 4px;
            margin-left: 4px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .search-clear:active {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .dark .search-clear:active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Loading */
        .loading {
            display: -webkit-box;
            display: flex;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            height: 100%;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(93, 92, 222, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }
        
        @keyframes spin {
            0% { -webkit-transform: rotate(0deg); transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); transform: rotate(360deg); }
        }
        
        /* Banner notifications - IMPROVED */
        .banner-notification {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            padding: 16px;
            color: white;
            z-index: 2000;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-transform: translateY(-100%);
            transform: translateY(-100%);
            -webkit-animation: slide-down-banner 0.3s forwards;
            animation: slide-down-banner 0.3s forwards;
            -webkit-box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border-radius: 0 0 12px 12px;
        }
        
        .banner-notification.success {
            background: -webkit-linear-gradient(315deg, var(--success-color), var(--success-color-dark));
        }
        
        .banner-notification.error {
            background: -webkit-linear-gradient(315deg, var(--error-color), var(--error-color-dark));
        }
        
        .banner-notification.warning {
            background: -webkit-linear-gradient(315deg, var(--warning-color), var(--warning-color-dark));
        }
        
        .banner-notification.info {
            background: -webkit-linear-gradient(315deg, var(--info-color), var(--info-color-dark));
        }
        
        @-webkit-keyframes slide-down-banner {
            from { -webkit-transform: translateY(-100%); transform: translateY(-100%); }
            to { -webkit-transform: translateY(0); transform: translateY(0); }
        }
        
        @keyframes slide-down-banner {
            from { -webkit-transform: translateY(-100%); transform: translateY(-100%); }
            to { -webkit-transform: translateY(0); transform: translateY(0); }
        }
        
        @-webkit-keyframes slide-up-banner {
            from { -webkit-transform: translateY(0); transform: translateY(0); }
            to { -webkit-transform: translateY(-100%); transform: translateY(-100%); }
        }
        
        @keyframes slide-up-banner {
            from { -webkit-transform: translateY(0); transform: translateY(0); }
            to { -webkit-transform: translateY(-100%); transform: translateY(-100%); }
        }
        
        .banner-notification.closing {
            -webkit-animation: slide-up-banner 0.3s forwards;
            animation: slide-up-banner 0.3s forwards;
        }
        
        .banner-content {
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
        }
        
        .banner-icon {
            margin-right: 12px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            min-width: 28px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }
        
        .banner-message {
            font-weight: 500;
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
        }
        
        .banner-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            opacity: 0.8;
            -webkit-transition: opacity 0.3s;
            transition: opacity 0.3s;
            padding: 4px;
            width: 28px;
            height: 28px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .banner-close:active {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 10px;
            color: white;
            background-color: #333;
            z-index: 1000;
            -webkit-box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            -webkit-animation: toast-in 0.3s ease-out;
            animation: toast-in 0.3s ease-out;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            max-width: 90%;
        }
        
        .toast-icon {
            margin-right: 10px;
        }
        
        @-webkit-keyframes toast-in {
            from { -webkit-transform: translate(-50%, 100px); transform: translate(-50%, 100px); opacity: 0; }
            to { -webkit-transform: translate(-50%, 0); transform: translate(-50%, 0); opacity: 1; }
        }
        
        @keyframes toast-in {
            from { -webkit-transform: translate(-50%, 100px); transform: translate(-50%, 100px); opacity: 0; }
            to { -webkit-transform: translate(-50%, 0); transform: translate(-50%, 0); opacity: 1; }
        }
        
        /* Image preview container - REDUCED SIZE */
        .image-preview-container {
            position: relative;
            margin-top: 8px;
            margin-bottom: 8px;
            max-width: 150px;
            max-height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 100px;
            -o-object-fit: contain;
            object-fit: contain;
            display: block;
        }
        
        .image-preview-close {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .image-preview-close:active {
            background: rgba(0, 0, 0, 0.7);
        }
        
        .image-preview-close svg {
            width: 14px;
            height: 14px;
        }
        
        /* Input file */
        .input-file {
            display: none;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-animation: fade-in 0.3s ease-out;
            animation: fade-in 0.3s ease-out;
        }
        
        .modal-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            -webkit-box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            -webkit-animation: scale-in 0.3s ease-out;
            animation: scale-in 0.3s ease-out;
        }
        
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 18px;
            color: var(--text-color);
        }
        
        .modal-body {
            padding: 16px;
            color: var(--text-color);
        }
        
        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            display: -webkit-box;
            display: flex;
            -webkit-box-pack: end;
            -webkit-justify-content: flex-end;
            justify-content: flex-end;
            gap: 8px;
        }
        
        .modal-button {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .modal-button-cancel {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--secondary-text);
        }
        
        .modal-button-cancel:active {
            background-color: var(--secondary-bg);
        }
        
        .modal-button-confirm {
            background: var(--accent-gradient);
            color: white;
            border: none;
        }
        
        .modal-button-confirm:active {
            background: -webkit-linear-gradient(315deg, var(--accent-color-dark), var(--accent-color));
        }
        
        .modal-button-danger {
            background: -webkit-linear-gradient(315deg, var(--error-color), var(--error-color-dark));
            color: white;
            border: none;
        }
        
        .modal-button-danger:active {
            background: -webkit-linear-gradient(315deg, var(--error-color-dark), var(--error-color));
        }
        
        /* Compose button */
        .compose-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-gradient);
            color: white;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-box-shadow: 0 4px 8px rgba(93, 92, 222, 0.3);
            box-shadow: 0 4px 8px rgba(93, 92, 222, 0.3);
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            z-index: 90;
        }
        
        .compose-button:active {
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
            -webkit-box-shadow: 0 2px 4px rgba(93, 92, 222, 0.3);
            box-shadow: 0 2px 4px rgba(93, 92, 222, 0.3);
        }
        
        /* AI feature section */
        .ai-feature-card {
            background: -webkit-linear-gradient(315deg, #7742DD, #4D31B4);
            border-radius: 16px;
            padding: 20px;
            margin: 16px;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
            -webkit-box-shadow: 0 10px 20px rgba(77, 49, 180, 0.3);
            box-shadow: 0 10px 20px rgba(77, 49, 180, 0.3);
        }
        
        .ai-feature-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }
        
        .ai-feature-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .ai-feature-description {
            font-size: 16px;
            margin-bottom: 20px;
            opacity: 0.9;
        }
        
        .ai-feature-coming-soon {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 6px 12px;
            display: inline-block;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .ai-feature-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.2'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* Profile screen */
        .profile-container {
            padding-bottom: 80px;
        }
        
        .profile-header {
            background: var(--accent-gradient);
            color: white;
            padding: 30px 20px;
            border-radius: 0 0 16px 16px;
            margin-bottom: 80px;
            position: relative;
            -webkit-box-shadow: 0 4px 10px rgba(93, 92, 222, 0.3);
            box-shadow: 0 4px 10px rgba(93, 92, 222, 0.3);
        }
        
        .profile-avatar-container {
            position: absolute;
            bottom: -40px;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            cursor: pointer;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--accent-gradient);
            color: white;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            font-weight: bold;
            font-size: 32px;
            border: 4px solid var(--card-bg);
            overflow: hidden;
            -webkit-box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .profile-avatar-edit {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 12px;
            padding: 4px 0;
            text-align: center;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            -o-object-fit: cover;
            object-fit: cover;
        }
        
        .profile-card {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin: 0 16px 20px;
            -webkit-box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .dark .profile-card {
            -webkit-box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .profile-card-title {
            font-weight: 600;
            margin-bottom: 16px;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .profile-card-title svg {
            margin-right: 10px;
            color: var(--accent-color);
        }
        
        .profile-field {
            display: -webkit-box;
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .profile-field:last-child {
            border-bottom: none;
        }
        
        .profile-field-label {
            width: 100px;
            color: var(--secondary-text);
            font-weight: 500;
        }
        
        .profile-field-value {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .editable-field {
            position: relative;
            cursor: pointer;
        }
        
        .editable-field:active::after {
            content: '✏️';
            font-size: 14px;
            margin-left: 8px;
            opacity: 0.7;
        }
        
        .color-options {
            display: -webkit-box;
            display: flex;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .color-option.active {
            border-color: var(--text-color);
            -webkit-transform: scale(1.1);
            transform: scale(1.1);
        }
        
        .theme-toggle {
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            padding: 12px 0;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background: var(--accent-gradient);
        }
        
        input:checked + .toggle-slider:before {
            -webkit-transform: translateX(26px);
            transform: translateX(26px);
        }
        
        .profile-actions {
            display: -webkit-box;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            gap: 12px;
            margin: 0 16px;
        }
        
        .action-button {
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            display: -webkit-box;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
        }
        
        .action-button svg {
            margin-right: 8px;
        }
        
        .logout-button {
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            background-color: transparent;
        }
        
        .logout-button:active {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .delete-button {
            background: -webkit-linear-gradient(315deg, var(--error-color), var(--error-color-dark));
            color: white;
            border: none;
        }
        
        .delete-button:active {
            background: -webkit-linear-gradient(315deg, var(--error-color-dark), var(--error-color));
        }
        
        /* iOS 12 specific fixes */
        @media only screen and (max-device-width: 812px) and (-webkit-device-pixel-ratio: 3) {
            .message-bubble {
                max-width: 70%; /* Réduire la largeur maximum pour iOS 12 */
            }
            
            /* Limiter les effets d'ombre */
            .header, .tab-bar, .auth-form, .profile-card {
                -webkit-box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            /* Simplifier les animations */
            @-webkit-keyframes pulse {
                from { opacity: 0.7; }
                to { opacity: 1; }
            }
            
            .conversation-status.online {
                -webkit-animation: pulse 1s alternate infinite;
                animation: pulse 1s alternate infinite;
            }
            
            /* Réduire les effets d'ombre lourds */
            .profile-header {
                -webkit-box-shadow: 0 2px 4px rgba(93, 92, 222, 0.3);
                box-shadow: 0 2px 4px rgba(93, 92, 222, 0.3);
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Firebase SDK 8.10.1 pour compatibilité avec iOS 12 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <script>
        // Polyfills pour iOS 12
        if (!Object.entries) {
            Object.entries = function(obj) {
                var ownProps = Object.keys(obj),
                i = ownProps.length,
                entries = new Array(i);
                while (i--) {
                    entries[i] = [ownProps[i], obj[ownProps[i]]];
                }
                return entries;
            };
        }
        
        if (!Array.prototype.find) {
            Object.defineProperty(Array.prototype, 'find', {
                value: function(predicate) {
                    if (this == null) {
                        throw new TypeError('"this" is null or not defined');
                    }
                    var o = Object(this);
                    var len = o.length >>> 0;
                    if (typeof predicate !== 'function') {
                        throw new TypeError('predicate must be a function');
                    }
                    var thisArg = arguments[1];
                    var k = 0;
                    while (k < len) {
                        var kValue = o[k];
                        if (predicate.call(thisArg, kValue, k, o)) {
                            return kValue;
                        }
                        k++;
                    }
                    return undefined;
                }
            });
        }
        
        // String.padStart polyfill
        if (!String.prototype.padStart) {
            String.prototype.padStart = function padStart(targetLength, padString) {
                targetLength = targetLength >> 0;
                padString = String(typeof padString !== 'undefined' ? padString : ' ');
                if (this.length > targetLength) {
                    return String(this);
                } else {
                    targetLength = targetLength - this.length;
                    if (targetLength > padString.length) {
                        padString += padString.repeat(targetLength / padString.length);
                    }
                    return padString.slice(0, targetLength) + String(this);
                }
            };
        }
        
        // String.repeat polyfill
        if (!String.prototype.repeat) {
            String.prototype.repeat = function(count) {
                'use strict';
                if (this == null) {
                    throw new TypeError('can\'t convert ' + this + ' to object');
                }
                var str = '' + this;
                count = +count;
                if (count != count) {
                    count = 0;
                }
                if (count < 0) {
                    throw new RangeError('repeat count must be non-negative');
                }
                if (count == Infinity) {
                    throw new RangeError('repeat count must be less than infinity');
                }
                count = Math.floor(count);
                if (str.length == 0 || count == 0) {
                    return '';
                }
                if (str.length * count >= 1 << 28) {
                    throw new RangeError('repeat count must not overflow maximum string size');
                }
                var rpt = '';
                for (;;) {
                    if ((count & 1) == 1) {
                        rpt += str;
                    }
                    count >>>= 1;
                    if (count == 0) {
                        break;
                    }
                    str += str;
                }
                return rpt;
            }
        }
        
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAHkI_ZfUX0jheLQyYy49iYLh1LUwxw26Y",
            authDomain: "nlp-9057d.firebaseapp.com",
            projectId: "nlp-9057d",
            storageBucket: "nlp-9057d.appspot.com",
            messagingSenderId: "713755293336",
            appId: "1:713755293336:web:89638ccb2839975f2802ed",
            measurementId: "G-4HVY16QT8M"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Check for dark mode
        function checkDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
                return true;
            }
            return false;
        }
        
        // Listen for dark mode changes
        if (window.matchMedia) {
            try {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(event) {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                        if (app && app.currentUser) {
                            app.isDarkMode = true;
                            app.saveThemePreference();
                        }
                    } else {
                        document.documentElement.classList.remove('dark');
                        if (app && app.currentUser) {
                            app.isDarkMode = false;
                            app.saveThemePreference();
                        }
                    }
                });
            } catch (error) {
                // Fallback pour iOS 12 qui ne supporte pas addEventListener sur matchMedia
                // On vérifie périodiquement le mode
                setInterval(function() {
                    const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (isDarkMode && !document.documentElement.classList.contains('dark')) {
                        document.documentElement.classList.add('dark');
                        if (app && app.currentUser) {
                            app.isDarkMode = true;
                            app.saveThemePreference();
                        }
                    } else if (!isDarkMode && document.documentElement.classList.contains('dark')) {
                        document.documentElement.classList.remove('dark');
                        if (app && app.currentUser) {
                            app.isDarkMode = false;
                            app.saveThemePreference();
                        }
                    }
                }, 5000);
            }
        }
        
        // Main application logic
        const app = {
            currentUser: null,
            currentScreen: 'loading', // loading, auth, main, chat
            currentTab: 'conversations', // conversations, users, profile, ai
            conversations: [],
            filteredConversations: [],
            users: [],
            filteredUsers: [],
            messages: [],
            currentChat: null,
            activeAuthTab: 'login',
            isDarkMode: checkDarkMode(),
            accentColor: '#5D5CDE',
            accentGradient: 'var(--accent-gradient)',
            notificationTimer: null,
            bannerNotificationTimer: null,
            selectedImage: null,
            imagePreview: null,
            selectionMode: false,
            isConversationSelectionMode: false,
            selectedMessages: new Set(),
            selectedConversations: new Set(),
            lastTouchStart: 0,
            longPressTimer: null,
            fullScreenImage: null,
            actionMenu: null,
            chatMenu: null,
            modal: null,
            isEditing: false,
            editingField: null,
            searchQuery: '',
            isRecording: false,
            mediaRecorder: null,
            audioChunks: [],
            recordingStartTime: null,
            messageModCounter: {},  // Track how many times each message was modified
            emojiPickerVisible: false, // Track emoji picker visibility
            selectedEmojis: {}, // Track selected emojis for messages
            customImagePreview: null,
            availableEmojis: ['👍', '❤️', '😂', '😮', '😢', '👏'],
            recentEmojis: [], // Track recently used emojis
            reactionPickerVisible: false,
            reactionPickerTargetId: null,
            totalUserCount: 0, // Track total user count
            maxUserLimit: 55, // Maximum number of users allowed
            sendingMessages: new Set(), // Track sending messages for UI feedback
            onlineStatusInterval: null, // Interval for updating online status
            
            // Initialize app
            init() {
                // Show loading state first
                this.renderLoadingScreen();
                
                // Then proceed with auth check
                this.setupAuthListener();
                this.setupCopyProtection();
                
                // Check total user count
                this.checkUserCount();
                
                // Setup document events
                document.addEventListener('click', function(e) {
                    // Close menus if clicking outside
                    if (app.actionMenu && !e.target.closest('.action-menu') && !e.target.closest('.message-bubble')) {
                        app.closeActionMenu();
                    }
                    
                    if (app.chatMenu && !e.target.closest('.chat-menu') && !e.target.closest('.chat-menu-button')) {
                        app.closeChatMenu();
                    }
                    
                    if (app.customImagePreview && !e.target.closest('.custom-image-preview-content') && !e.target.closest('.message-image')) {
                        app.closeCustomImagePreview();
                    }
                    
                    // Close emoji picker when clicking outside
                    if (app.emojiPickerVisible && !e.target.closest('.emoji-picker') && !e.target.closest('.emoji-button')) {
                        app.closeEmojiPicker();
                    }
                    
                    // Close reaction picker when clicking outside
                    if (app.reactionPickerVisible && !e.target.closest('.reaction-picker') && !e.target.closest('.message-bubble')) {
                        app.closeReactionPicker();
                    }
                });
                
                // Start online status ping
                this.startOnlineStatusInterval();
                
                // Listen for resize events to adjust layout for keyboard
                window.addEventListener('resize', function() {
                    if (app.currentScreen === 'chat') {
                        // Scroll messages to bottom on resize, especially when keyboard appears/disappears
                        setTimeout(function() {
                            app.scrollToBottom();
                        }, 100);
                    }
                });
                
                // Add input blur and focus handlers for iOS keyboard
                document.addEventListener('focusin', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        if (app.currentScreen === 'chat') {
                            // Add a class to the body when keyboard is likely visible
                            document.body.classList.add('keyboard-open');
                            
                            // Scroll messages to bottom after a brief delay
                            setTimeout(function() {
                                app.scrollToBottom();
                            }, 300);
                        }
                    }
                });
                
                document.addEventListener('focusout', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        // Remove the keyboard-open class
                        document.body.classList.remove('keyboard-open');
                    }
                });
                
                // Écouter les événements pour iOS PWA
                window.addEventListener('beforeinstallprompt', function(e) {
                    // Prévenir le comportement par défaut de Chrome en stockant l'événement
                    e.preventDefault();
                    // Stocker l'événement pour qu'il puisse être déclenché plus tard
                    app.deferredPrompt = e;
                });
                
                window.addEventListener('appinstalled', function() {
                    // L'application a été installée
                    app.showNotification("Application installée avec succès", "success");
                    app.deferredPrompt = null;
                });
            },
            
            // Start interval to update online status
            startOnlineStatusInterval() {
                if (this.onlineStatusInterval) {
                    clearInterval(this.onlineStatusInterval);
                }
                
                this.onlineStatusInterval = setInterval(function() {
                    if (app.currentUser && app.currentUser.uid) {
                        app.updateOnlineStatus();
                    }
                }, 60000); // Update every minute
            },
            
            // Update online status
            async updateOnlineStatus() {
                try {
                    if (!this.currentUser || !this.currentUser.uid) return;
                    
                    await db.collection('users').doc(this.currentUser.uid).update({
                        online: true,
                        lastSeen: firebase.firestore.Timestamp.now()
                    });
                } catch (error) {
                    console.error("Error updating online status:", error);
                }
            },
            
            // Check total user count
            async checkUserCount() {
                try {
                    const snapshot = await db.collection('users').get();
                    this.totalUserCount = snapshot.size;
                } catch (error) {
                    console.error("Error checking user count:", error);
                }
            },
            
            // Setup copy protection
            setupCopyProtection() {
                // Prevent context menu
                document.addEventListener('contextmenu', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return true;
                    }
                    return false;
                });
                
                // Prevent copy
                document.addEventListener('copy', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return true;
                    }
                    e.preventDefault();
                    return false;
                });
                
                // Prevent cut
                document.addEventListener('cut', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return true;
                    }
                    e.preventDefault();
                    return false;
                });
            },
            
            // Render loading screen
            renderLoadingScreen() {
                const appElement = document.getElementById('app');
                if (!appElement) return;
                
                appElement.innerHTML = `
                    <div class="loading" style="height: 100vh; display: -webkit-box; display: flex; -webkit-box-orient: vertical; -webkit-box-direction: normal; -webkit-flex-direction: column; flex-direction: column; -webkit-box-align: center; -webkit-align-items: center; align-items: center; -webkit-box-pack: center; -webkit-justify-content: center; justify-content: center; background-color: var(--bg-color);">
                        <div style="margin-bottom: 40px; text-align: center;">
                            <h1 style="font-size: 32px; margin-bottom: 10px; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ChatXchange</h1>
                            <p style="color: var(--secondary-text);">Chargement en cours...</p>
                        </div>
                        <div class="spinner"></div>
                    </div>
                `;
            },
            
            // Setup authentication listener
            setupAuthListener() {
                auth.onAuthStateChanged(async function(user) {
                    if (user) {
                        // User is signed in
                        try {
                            // Get user profile from Firestore
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                
                                // Update online status
                                await db.collection('users').doc(user.uid).update({
                                    online: true,
                                    lastSeen: firebase.firestore.Timestamp.now()
                                });
                                
                                // Set theme
                                if (userData.theme) {
                                    if (userData.theme.mode === 'dark') {
                                        app.toggleDarkMode(true, false);
                                    } else {
                                        app.toggleDarkMode(false, false);
                                    }
                                    
                                    if (userData.theme.color) {
                                        app.changeAccentColor(userData.theme.color, false);
                                    }
                                    
                                    if (userData.theme.gradient) {
                                        app.changeAccentGradient(userData.theme.gradient, false);
                                    }
                                }
                                
                                // Set user state
                                app.currentUser = {
                                    uid: user.uid,
                                    username: userData.username,
                                    email: userData.email,
                                    phone: userData.phone || "",
                                    bio: userData.bio || "",
                                    avatar: userData.avatar,
                                    blockedUsers: userData.blockedUsers || []
                                };
                                
                                // Set app screen
                                app.currentScreen = 'main';
                                
                                // Load conversations
                                app.loadConversations();
                                
                                // Load users
                                app.loadUsers();
                                
                                // Show welcome notification
                                app.showBannerNotification(`Bienvenue, ${userData.username}!`, 'success');
                                
                                // Start online status interval
                                app.startOnlineStatusInterval();
                                
                            } else {
                                // User document not found, sign out
                                await auth.signOut();
                                app.currentUser = null;
                                app.currentScreen = 'auth';
                                app.showBannerNotification('Session expirée', 'error');
                            }
                        } catch (error) {
                            console.error("Error getting user data:", error);
                            app.currentUser = null;
                            app.currentScreen = 'auth';
                            app.showBannerNotification('Erreur de connexion', 'error');
                        }
                    } else {
                        // User is signed out
                        app.currentUser = null;
                        app.currentScreen = 'auth';
                        
                        // Clear intervals
                        if (app.onlineStatusInterval) {
                            clearInterval(app.onlineStatusInterval);
                            app.onlineStatusInterval = null;
                        }
                    }
                    
                    app.render();
                });
            },
            
            // Apply accent color
            applyAccentColor() {
                document.documentElement.style.setProperty('--accent-color', this.accentColor);
                
                // Generate dark and light variants
                const darkColor = this.adjustColorBrightness(this.accentColor, -20);
                const lightColor = this.adjustColorBrightness(this.accentColor, 20);
                
                document.documentElement.style.setProperty('--accent-color-dark', darkColor);
                document.documentElement.style.setProperty('--accent-color-light', lightColor);
            },
            
            // Apply gradient
            applyAccentGradient(gradient) {
                document.documentElement.style.setProperty('--accent-gradient', gradient);
            },
            
            // Adjust color brightness
            adjustColorBrightness(hexColor, percent) {
                let r = parseInt(hexColor.slice(1, 3), 16);
                let g = parseInt(hexColor.slice(3, 5), 16);
                let b = parseInt(hexColor.slice(5, 7), 16);
                
                r = Math.max(0, Math.min(255, r + percent));
                g = Math.max(0, Math.min(255, g + percent));
                b = Math.max(0, Math.min(255, b + percent));
                
                // Polyfill version of toString(16).padStart(2, '0')
                const rHex = ('0' + r.toString(16)).slice(-2);
                const gHex = ('0' + g.toString(16)).slice(-2);
                const bHex = ('0' + b.toString(16)).slice(-2);
                
                return `#${rHex}${gHex}${bHex}`;
            },
            
            // Toggle dark mode
            toggleDarkMode(isDark, savePreference) {
                this.isDarkMode = isDark;
                
                if (isDark) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                // Save preference to user document if logged in
                if (savePreference && this.currentUser && this.currentUser.uid) {
                    this.saveThemePreference();
                }
                
                this.render();
            },
            
            // Change accent color
            changeAccentColor(color, savePreference) {
                this.accentColor = color;
                this.applyAccentColor();
                
                // Save preference to user document if logged in
                if (savePreference && this.currentUser && this.currentUser.uid) {
                    this.saveThemePreference();
                }
                
                this.render();
            },
            
            // Change accent gradient
            changeAccentGradient(gradient, savePreference) {
                this.accentGradient = gradient;
                this.applyAccentGradient(gradient);
                
                // Save preference to user document if logged in
                if (savePreference && this.currentUser && this.currentUser.uid) {
                    this.saveThemePreference();
                }
                
                this.render();
            },
            
            // Save theme preference
            saveThemePreference() {
                if (this.currentUser && this.currentUser.uid) {
                    db.collection('users').doc(this.currentUser.uid).update({
                        theme: { 
                            mode: this.isDarkMode ? 'dark' : 'light', 
                            color: this.accentColor,
                            gradient: this.accentGradient
                        }
                    }).catch(function(error) {
                        console.error("Error updating theme preference:", error);
                    });
                }
            },
            
            // Switch auth tab
            switchAuthTab(tab) {
                this.activeAuthTab = tab;
                this.render();
            },
            
            // Handle login
            async handleLogin(event) {
                event.preventDefault();
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                try {
                    this.showBannerNotification("Connexion en cours...", "info");
                    await auth.signInWithEmailAndPassword(email, password);
                    // Auth state change listener will handle the rest
                } catch (error) {
                    console.error("Login error:", error);
                    this.showBannerNotification("Email ou mot de passe incorrect", "error");
                }
            },
            
            // Handle registration
            async handleRegister(event) {
                event.preventDefault();
                
                const username = document.getElementById('register-username').value;
                const email = document.getElementById('register-email').value;
                const phone = document.getElementById('register-phone').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                // Check if user limit is reached
                if (this.totalUserCount >= this.maxUserLimit) {
                    this.showBannerNotification(`Limite de ${this.maxUserLimit} utilisateurs atteinte`, "error");
                    return;
                }
                
                // Basic validation
                if (password !== confirmPassword) {
                    this.showBannerNotification("Les mots de passe ne correspondent pas", "error");
                    return;
                }
                
                try {
                    this.showBannerNotification("Création du compte...", "info");
                    
                    // Check if username exists
                    const usernameCheck = await db.collection('users')
                        .where('username', '==', username)
                        .get();
                    
                    if (!usernameCheck.empty) {
                        this.showBannerNotification("Ce nom d'utilisateur est déjà pris", "error");
                        return;
                    }
                    
                    // Create user
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // Create user document
                    await db.collection('users').doc(user.uid).set({
                        username: username,
                        email: email,
                        phone: phone,
                        bio: "",
                        avatar: null,
                        online: true,
                        lastSeen: firebase.firestore.Timestamp.now(),
                        createdAt: firebase.firestore.Timestamp.now(),
                        theme: { 
                            mode: this.isDarkMode ? 'dark' : 'light', 
                            color: this.accentColor,
                            gradient: this.accentGradient
                        },
                        blockedUsers: []
                    });
                    
                    // Update profile
                    await user.updateProfile({
                        displayName: username
                    });
                    
                    this.showBannerNotification("Compte créé avec succès", "success");
                    this.totalUserCount++;
                    
                } catch (error) {
                    console.error("Registration error:", error);
                    this.showBannerNotification("Erreur lors de l'inscription", "error");
                }
            },
            
            // Handle logout
            async handleLogout() {
                // Show confirmation dialog
                this.showModal({
                    title: 'Déconnexion',
                    content: 'Êtes-vous sûr de vouloir vous déconnecter ?',
                    actions: [
                        {
                            label: 'Annuler',
                            action: function() { app.closeModal(); },
                            className: 'modal-button-cancel'
                        },
                        {
                            label: 'Déconnecter',
                            action: async function() {
                                try {
                                    app.showBannerNotification("Déconnexion en cours...", "info");
                                    
                                    if (app.currentUser) {
                                        // Update online status
                                        await db.collection('users').doc(app.currentUser.uid).update({
                                            online: false,
                                            lastSeen: firebase.firestore.Timestamp.now()
                                        });
                                    }
                                    
                                    // Sign out
                                    await auth.signOut();
                                    app.showBannerNotification("Déconnexion réussie", "success");
                                    app.closeModal();
                                    
                                    // Clear intervals
                                    if (app.onlineStatusInterval) {
                                        clearInterval(app.onlineStatusInterval);
                                        app.onlineStatusInterval = null;
                                    }
                                    
                                } catch (error) {
                                    console.error("Logout error:", error);
                                    app.showBannerNotification("Erreur lors de la déconnexion", "error");
                                    app.closeModal();
                                }
                            },
                            className: 'modal-button-confirm'
                        }
                    ]
                });
            },
            
            // Load conversations
            async loadConversations() {
                try {
                    // Get conversations where user is a participant
                    const query = db.collection('conversations')
                        .where('participants', 'array-contains', this.currentUser.uid);
                    
                    // Live listener
                    query.onSnapshot(async function(snapshot) {
                        const conversations = [];
                        
                        for (const doc of snapshot.docs) {
                            const conversationData = doc.data();
                            
                            // Find the other participant
                            const otherUserId = conversationData.participants.find(function(id) {
                                return id !== app.currentUser.uid;
                            });
                            
                            try {
                                // Get other user data
                                const userDoc = await db.collection('users').doc(otherUserId).get();
                                
                                if (userDoc.exists) {
                                    const userData = userDoc.data();
                                    
                                    // Check if user is blocked
                                    const isBlocked = app.currentUser.blockedUsers && 
                                                     app.currentUser.blockedUsers.includes(otherUserId);
                                    
                                    // Check if conversation is deleted for current user
                                    const isDeleted = conversationData.deleted && 
                                                    conversationData.deleted[app.currentUser.uid];
                                    
                                    // Only add non-deleted conversations
                                    if (!isDeleted) {
                                        // Calculate unread count
                                        let unreadCount = 0;
                                        
                                        // Only perform this check if there's a last message and it wasn't sent by the current user
                                        if (conversationData.lastMessageSenderId && 
                                            conversationData.lastMessageSenderId !== app.currentUser.uid) {
                                            
                                            // Get unread messages
                                            const unreadQuery = await db.collection('messages')
                                                .where('conversationId', '==', doc.id)
                                                .where('senderId', '==', otherUserId)
                                                .where('read', '==', false)
                                                .get();
                                            
                                            unreadCount = unreadQuery.size;
                                        }
                                        
                                        conversations.push({
                                            id: doc.id,
                                            otherUser: {
                                                uid: otherUserId,
                                                username: userData.username,
                                                avatar: userData.avatar,
                                                online: userData.online,
                                                lastSeen: userData.lastSeen?.toDate() || null,
                                                isBlocked
                                            },
                                            lastMessage: conversationData.lastMessage,
                                            lastMessageType: conversationData.lastMessageType || 'text',
                                            lastMessageTimestamp: conversationData.lastMessageTimestamp?.toDate() || new Date(),
                                            lastMessageSenderId: conversationData.lastMessageSenderId,
                                            unreadCount,
                                            isBlocked
                                        });
                                    }
                                }
                            } catch (error) {
                                console.error(`Error getting user ${otherUserId}:`, error);
                            }
                        }
                        
                        // Sort by last message time
                        conversations.sort(function(a, b) { 
                            return b.lastMessageTimestamp - a.lastMessageTimestamp;
                        });
                        
                        app.conversations = conversations;
                        app.filteredConversations = conversations;
                        app.render();
                    }, function(error) {
                        console.error("Error loading conversations:", error);
                        app.showBannerNotification("Erreur lors du chargement des conversations", "error");
                    });
                    
                } catch (error) {
                    console.error("Error loading conversations:", error);
                    this.showBannerNotification("Erreur lors du chargement des conversations", "error");
                }
            },
            
            // Load users
            async loadUsers() {
                try {
                    // Get all users
                    const snapshot = await db.collection('users').get();
                    
                    const users = [];
                    
                    snapshot.forEach(function(doc) {
                        // Don't include current user
                        if (doc.id !== app.currentUser.uid) {
                            const userData = doc.data();
                            
                            // Check if user is blocked
                            const isBlocked = app.currentUser.blockedUsers && 
                                             app.currentUser.blockedUsers.includes(doc.id);
                            
                            users.push({
                                uid: doc.id,
                                username: userData.username,
                                email: userData.email,
                                phone: userData.phone || "",
                                bio: userData.bio || "",
                                avatar: userData.avatar,
                                online: userData.online,
                                lastSeen: userData.lastSeen?.toDate() || null,
                                isBlocked
                            });
                        }
                    });
                    
                    this.users = users;
                    this.filteredUsers = users;
                    this.render();
                    
                    // Set up real-time listener for online status updates
                    this.setupOnlineStatusListener();
                    
                } catch (error) {
                    console.error("Error loading users:", error);
                    this.showBannerNotification("Erreur lors du chargement des utilisateurs", "error");
                }
            },
            
            // Setup online status listener
            setupOnlineStatusListener() {
                // Listen for changes to users' online status
                const usersRef = db.collection('users');
                
                // Create listener for online status changes
                usersRef.onSnapshot(function(snapshot) {
                    snapshot.docChanges().forEach(function(change) {
                        // Skip current user
                        if (change.doc.id === app.currentUser?.uid) return;
                        
                        const userData = change.doc.data();
                        
                        // Update users list
                        app.users = app.users.map(function(user) {
                            if (user.uid === change.doc.id) {
                                return Object.assign({}, user, {
                                    online: userData.online,
                                    lastSeen: userData.lastSeen?.toDate() || user.lastSeen
                                });
                            }
                            return user;
                        });
                        
                        // Update conversations list
                        app.conversations = app.conversations.map(function(conversation) {
                            if (conversation.otherUser.uid === change.doc.id) {
                                return Object.assign({}, conversation, {
                                    otherUser: Object.assign({}, conversation.otherUser, {
                                        online: userData.online,
                                        lastSeen: userData.lastSeen?.toDate() || conversation.otherUser.lastSeen
                                    })
                                });
                            }
                            return conversation;
                        });
                        
                        // Update current chat if needed
                        if (app.currentChat && app.currentChat.otherUser.uid === change.doc.id) {
                            app.currentChat = Object.assign({}, app.currentChat, {
                                otherUser: Object.assign({}, app.currentChat.otherUser, {
                                    online: userData.online,
                                    lastSeen: userData.lastSeen?.toDate() || app.currentChat.otherUser.lastSeen
                                })
                            });
                        }
                    });
                    
                    // Re-filter and render
                    app.filterUsers();
                    app.filterConversations();
                    app.render();
                }, function(error) {
                    console.error("Error listening to online status changes:", error);
                });
            },
            
            // Search handling
            handleSearch(query) {
                this.searchQuery = query;
                
                if (this.currentTab === 'conversations') {
                    this.filterConversations();
                } else if (this.currentTab === 'users') {
                    this.filterUsers();
                }
                
                this.render();
            },
            
            // Filter conversations based on search query
            filterConversations() {
                if (!this.searchQuery) {
                    this.filteredConversations = this.conversations;
                    return;
                }
                
                const query = this.searchQuery.toLowerCase();
                this.filteredConversations = this.conversations.filter(function(conversation) {
                    return conversation.otherUser.username.toLowerCase().includes(query) ||
                           (conversation.lastMessage && conversation.lastMessage.toLowerCase().includes(query));
                });
            },
            
            // Filter users based on search query
            filterUsers() {
                if (!this.searchQuery) {
                    this.filteredUsers = this.users;
                    return;
                }
                
                const query = this.searchQuery.toLowerCase();
                this.filteredUsers = this.users.filter(function(user) {
                    return user.username.toLowerCase().includes(query) ||
                           (user.phone && user.phone.includes(query)) ||
                           (user.bio && user.bio.toLowerCase().includes(query));
                });
            },
            
            // Clear search
            clearSearch() {
                this.searchQuery = '';
                this.filteredConversations = this.conversations;
                this.filteredUsers = this.users;
                this.render();
            },
            
            // Start chat with user
            async startChat(user) {
                if (user.isBlocked) {
                    this.showBannerNotification("Vous avez bloqué cet utilisateur", "warning");
                    return;
                }
                
                // Create conversation ID (sort UIDs to ensure consistent ID)
                const sortedIds = [this.currentUser.uid, user.uid].sort();
                const conversationId = sortedIds.join('_');
                
                try {
                    // Check if conversation exists
                    const conversationDoc = await db.collection('conversations').doc(conversationId).get();
                    
                    if (!conversationDoc.exists) {
                        // Create new conversation
                        await db.collection('conversations').doc(conversationId).set({
                            participants: sortedIds,
                            lastMessage: null,
                            lastMessageTimestamp: firebase.firestore.Timestamp.now(),
                            createdAt: firebase.firestore.Timestamp.now(),
                            deleted: {}
                        });
                    } else {
                        // If conversation exists but was deleted for current user, undelete it
                        if (conversationDoc.data().deleted && conversationDoc.data().deleted[this.currentUser.uid]) {
                            let deleted = conversationDoc.data().deleted;
                            deleted[this.currentUser.uid] = false;
                            await db.collection('conversations').doc(conversationId).update({ deleted });
                        }
                    }
                    
                    // Open chat screen
                    this.currentChat = {
                        id: conversationId,
                        otherUser: user
                    };
                    
                    this.currentScreen = 'chat';
                    
                    // Reset any selections
                    this.exitSelectionMode();
                    
                    // Load messages
                    this.loadMessages(conversationId);
                    
                    this.render();
                    
                } catch (error) {
                    console.error("Error starting chat:", error);
                    this.showBannerNotification("Erreur lors du démarrage de la conversation", "error");
                }
            },
            
            // Load messages for a conversation
            loadMessages(conversationId) {
                try {
                    // Clear previous messages
                    this.messages = [];
                    
                    // Query for messages
                    const query = db.collection('messages')
                        .where('conversationId', '==', conversationId)
                        .orderBy('timestamp', 'asc');
                    
                    // Live listener
                    query.onSnapshot(function(snapshot) {
                        const messages = [];
                        
                        snapshot.forEach(function(doc) {
                            const messageData = doc.data();
                            
                            // Skip messages hidden for current user
                            if (messageData.hidden && messageData.hidden[app.currentUser.uid]) {
                                return;
                            }
                            
                            messages.push({
                                id: doc.id,
                                senderId: messageData.senderId,
                                text: messageData.text,
                                image: messageData.image,
                                messageType: messageData.messageType || 'text',
                                timestamp: messageData.timestamp?.toDate() || new Date(),
                                read: messageData.read,
                                edited: messageData.edited || false,
                                reactions: messageData.reactions || {}
                            });
                        });
                        
                        app.messages = messages;
                        app.render();
                        
                        // Scroll to bottom
                        app.scrollToBottom();
                        
                        // Mark messages as read
                        app.markMessagesAsRead(conversationId);
                    }, function(error) {
                        console.error("Error loading messages:", error);
                        app.showBannerNotification("Erreur lors du chargement des messages", "error");
                    });
                    
                } catch (error) {
                    console.error("Error loading messages:", error);
                    this.showBannerNotification("Erreur lors du chargement des messages", "error");
                }
            },
            
            // Mark messages as read
            async markMessagesAsRead(conversationId) {
                try {
                    // Get unread messages not sent by current user
                    const query = db.collection('messages')
                        .where('conversationId', '==', conversationId)
                        .where('senderId', '!=', this.currentUser.uid)
                        .where('read', '==', false);
                    
                    const snapshot = await query.get();
                    
                    // Update each message
                    const batch = db.batch();
                    
                    snapshot.forEach(function(doc) {
                        batch.update(doc.ref, { read: true });
                    });
                    
                    if (snapshot.size > 0) {
                        await batch.commit();
                    }
                    
                } catch (error) {
                    console.error("Error marking messages as read:", error);
                }
            },
            
            // Switch tabs in main screen
            switchTab(tab) {
                this.currentTab = tab;
                this.searchQuery = '';
                this.exitSelectionMode();
                this.render();
            },
            
            // Select image for upload
            selectImage() {
                const fileInput = document.getElementById('image-upload');
                if (fileInput) {
                    fileInput.click();
                }
            },
            
            // Handle selected image
            handleImageSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Validate file type
                const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validImageTypes.includes(file.type)) {
                    this.showBannerNotification("Format d'image non supporté", "error");
                    return;
                }
                
                // Validate file size (max 6MB)
                if (file.size > 6 * 1024 * 1024) {
                    this.showBannerNotification("L'image ne doit pas dépasser 6 Mo", "error");
                    return;
                }
                
                // Compress and create preview
                this.compressImage(file, 1200, 0.8)
                    .then(function(compressedFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            app.selectedImage = compressedFile;
                            app.imagePreview = e.target.result;
                            app.render();
                            
                            // Update UI to show preview
                            const previewContainer = document.getElementById('image-preview-container');
                            if (previewContainer) {
                                previewContainer.style.display = 'block';
                            }
                        };
                        reader.readAsDataURL(compressedFile);
                    })
                    .catch(function(error) {
                        console.error("Error compressing image:", error);
                        app.showBannerNotification("Erreur lors du traitement de l'image", "error");
                    });
            },
            
            // Compress image before upload - Compatible iOS 12
            compressImage(file, maxWidth, quality) {
                return new Promise(function(resolve, reject) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = new Image();
                        img.onload = function() {
                            // Calculate new dimensions
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > maxWidth) {
                                height = Math.round(height * maxWidth / width);
                                width = maxWidth;
                            }
                            
                            // Create canvas for resizing
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            
                            // Draw and compress image
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Convert to Blob (with iOS compatibility)
                            try {
                                canvas.toBlob(
                                    function(blob) {
                                        if (!blob) {
                                            reject(new Error('Canvas to Blob failed'));
                                            return;
                                        }
                                        
                                        // Create new file
                                        try {
                                            // This will work on modern browsers
                                            const compressedFile = new File(
                                                [blob], 
                                                file.name, 
                                                {type: file.type, lastModified: Date.now()}
                                            );
                                            
                                            resolve(compressedFile);
                                        } catch (e) {
                                            // Fallback for older browsers
                                            // Add properties to the blob to make it more file-like
                                            blob.name = file.name;
                                            blob.lastModified = Date.now();
                                            resolve(blob);
                                        }
                                    }, 
                                    file.type, 
                                    quality
                                );
                            } catch (error) {
                                // Fallback for browsers that don't support toBlob
                                try {
                                    const dataURL = canvas.toDataURL(file.type, quality);
                                    const byteString = atob(dataURL.split(',')[1]);
                                    const ab = new ArrayBuffer(byteString.length);
                                    const ia = new Uint8Array(ab);
                                    
                                    for (let i = 0; i < byteString.length; i++) {
                                        ia[i] = byteString.charCodeAt(i);
                                    }
                                    
                                    const blob = new Blob([ab], {type: file.type});
                                    blob.name = file.name;
                                    blob.lastModified = Date.now();
                                    
                                    resolve(blob);
                                } catch (e) {
                                    reject(e);
                                }
                            }
                        };
                        img.onerror = reject;
                        img.src = event.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },
            
            // Handle avatar upload
            handleAvatarSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Validate file type
                const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validImageTypes.includes(file.type)) {
                    this.showBannerNotification("Format d'image non supporté", "error");
                    return;
                }
                
                // Validate file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    this.showBannerNotification("L'image ne doit pas dépasser 2 Mo", "error");
                    return;
                }
                
                // Compress and upload avatar
                this.compressImage(file, 300, 0.8)
                    .then(function(compressedFile) {
                        app.convertBlobToBase64(compressedFile)
                            .then(function(base64Avatar) {
                                app.uploadAvatar(base64Avatar);
                            })
                            .catch(function(error) {
                                console.error("Error converting avatar to base64:", error);
                                app.showBannerNotification("Erreur lors du traitement de l'image", "error");
                            });
                    })
                    .catch(function(error) {
                        console.error("Error compressing avatar:", error);
                        app.showBannerNotification("Erreur lors du traitement de l'image", "error");
                    });
            },
            
            // Upload avatar to Firestore (base64 encoded)
            async uploadAvatar(base64Avatar) {
                try {
                    if (!this.currentUser) return;
                    
                    // Show loading notification
                    this.showBannerNotification("Téléchargement en cours...", "info");
                    
                    // Update user document with base64 avatar
                    await db.collection('users').doc(this.currentUser.uid).update({
                        avatar: base64Avatar
                    });
                    
                    // Update local state
                    this.currentUser.avatar = base64Avatar;
                    
                    this.showBannerNotification("Photo de profil mise à jour", "success");
                    this.render();
                    
                } catch (error) {
                    console.error("Error uploading avatar:", error);
                    this.showBannerNotification("Erreur lors du téléchargement", "error");
                }
            },
            
            // Convert blob to base64
            convertBlobToBase64(blob) {
                return new Promise(function(resolve, reject) {
                    const reader = new FileReader();
                    reader.onloadend = function() { resolve(reader.result); };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            },
            
            // Cancel image upload
            cancelImageUpload() {
                this.selectedImage = null;
                this.imagePreview = null;
                this.render();
            },
            
            // Send a message
            async sendMessage() {
                if (!this.currentChat) return;
                
                const messageInput = document.getElementById('message-input');
                const text = messageInput ? messageInput.value.trim() : '';
                
                // Check if we have text or image
                if (!text && !this.selectedImage) return;
                
                try {
                    // Generate a random ID for this message to track in UI
                    const tempMessageId = 'temp_' + Date.now().toString();
                    
                    // Add to sending messages set
                    this.sendingMessages.add(tempMessageId);
                    
                    // Update UI immediately to show message sending state
                    // Create a temporary message object
                    const tempMessage = {
                        id: tempMessageId,
                        senderId: this.currentUser.uid,
                        text: text,
                        image: this.selectedImage ? this.imagePreview : null,
                        messageType: this.selectedImage ? 'image' : 'text',
                        timestamp: new Date(),
                        read: false,
                        edited: false,
                        reactions: {},
                        isSending: true
                    };
                    
                    // Add to messages array
                    this.messages.push(tempMessage);
                    
                    // Clear input and selected image
                    if (messageInput) {
                        messageInput.value = '';
                    }
                    
                    // Store selected image before clearing
                    const imageToSend = this.selectedImage;
                    
                    // Clear selected image from UI
                    this.selectedImage = null;
                    this.imagePreview = null;
                    
                    // Re-render to show sending state
                    this.render();
                    
                    // Scroll to bottom
                    this.scrollToBottom();
                    
                    // Prepare message data
                    let messageData = {
                        conversationId: this.currentChat.id,
                        senderId: this.currentUser.uid,
                        timestamp: firebase.firestore.Timestamp.now(),
                        read: false,
                        edited: false,
                        hidden: {},
                        reactions: {}
                    };
                    
                    let lastMessageText = '';
                    let messageType = 'text';
                    
                    // Handle text message
                    if (text) {
                        messageData.text = text;
                        lastMessageText = text;
                    }
                    
                    // Handle image message
                    if (imageToSend) {
                        // Convert image to base64
                        const base64Image = await this.fileToBase64(imageToSend);
                        messageData.image = base64Image;
                        messageData.messageType = 'image';
                        messageType = 'image';
                        
                        if (!text) {
                            lastMessageText = '📷 Image';
                        }
                    }
                    
                    // Send message to Firestore
                    const messageRef = await db.collection('messages').add(messageData);
                    
                    // Update conversation with last message info
                    await db.collection('conversations').doc(this.currentChat.id).update({
                        lastMessage: lastMessageText,
                        lastMessageType: messageType,
                        lastMessageTimestamp: firebase.firestore.Timestamp.now(),
                        lastMessageSenderId: this.currentUser.uid
                    });
                    
                    // Remove from sending messages set after confirmation
                    this.sendingMessages.delete(tempMessageId);
                    
                    // The message will be updated through the Firestore listener
                    
                } catch (error) {
                    console.error("Error sending message:", error);
                    this.showBannerNotification("Erreur lors de l'envoi du message", "error");
                    
                    // Remove from sending messages
                    const failedMessageId = Array.from(this.sendingMessages)[0]; // Just get the first one for simplicity
                    if (failedMessageId) {
                        this.sendingMessages.delete(failedMessageId);
                        
                        // Remove the failed message from the UI
                        this.messages = this.messages.filter(function(msg) {
                            return msg.id !== failedMessageId;
                        });
                        this.render();
                    }
                }
            },
            
            // Convert file to base64
            fileToBase64(file) {
                return new Promise(function(resolve, reject) {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = function() { resolve(reader.result); };
                    reader.onerror = function(error) { reject(error); };
                });
            },
            
            // Show chat menu
            showChatMenu() {
                // Close menu if already open
                if (this.chatMenu) {
                    this.closeChatMenu();
                    return;
                }
                
                const menuContainer = document.createElement('div');
                menuContainer.className = 'chat-menu';
                
                const menuItems = [
                    {
                        label: 'Effacer l\'historique',
                        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                        action: function() { app.confirmClearChatHistory(); }
                    },
                    {
                        label: this.currentChat?.otherUser.isBlocked ? 'Débloquer' : 'Bloquer',
                        icon: this.currentChat?.otherUser.isBlocked ? 
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 9L9 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 9L9 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                        action: function() { app.toggleBlockUser(app.currentChat.otherUser.uid, !app.currentChat.otherUser.isBlocked); }
                    },
                    {
                        label: 'Supprimer la conversation',
                        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                        action: function() { app.deleteConversation(app.currentChat.id); },
                        className: 'danger'
                    }
                ];
                
                let menuHTML = '';
                for (let i = 0; i < menuItems.length; i++) {
                    const item = menuItems[i];
                    menuHTML += `
                        <div class="chat-menu-item ${item.className || ''}" data-action="${i}">
                            ${item.icon}
                            ${item.label}
                        </div>
                    `;
                }
                
                menuContainer.innerHTML = menuHTML;
                document.body.appendChild(menuContainer);
                this.chatMenu = menuContainer;
                
                // Position the menu
                const menuButton = document.querySelector('.chat-menu-button');
                if (menuButton) {
                    const rect = menuButton.getBoundingClientRect();
                    menuContainer.style.top = rect.bottom + 'px';
                    menuContainer.style.right = (window.innerWidth - rect.right) + 'px';
                }
                
                // Add click handlers
                const menuItemElements = menuContainer.querySelectorAll('.chat-menu-item');
                for (let i = 0; i < menuItemElements.length; i++) {
                    const index = parseInt(menuItemElements[i].getAttribute('data-action'));
                    menuItemElements[i].addEventListener('click', function() {
                        menuItems[index].action();
                        app.closeChatMenu();
                    });
                }
            },
            
            // Close chat menu
            closeChatMenu() {
                if (this.chatMenu) {
                    this.chatMenu.remove();
                    this.chatMenu = null;
                }
            },
            
            // Block/unblock user
            async toggleBlockUser(userId, shouldBlock) {
                try {
                    if (!this.currentUser) return;
                    
                    const userRef = db.collection('users').doc(this.currentUser.uid);
                    const userDoc = await userRef.get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        let blockedUsers = userData.blockedUsers || [];
                        
                        if (shouldBlock) {
                            // Add to blocked list if not already there
                            if (!blockedUsers.includes(userId)) {
                                blockedUsers.push(userId);
                            }
                        } else {
                            // Remove from blocked list
                            blockedUsers = blockedUsers.filter(function(id) {
                                return id !== userId;
                            });
                        }
                        
                        // Update user document
                        await userRef.update({ blockedUsers });
                        
                        // Update local state
                        this.currentUser.blockedUsers = blockedUsers;
                        
                        // Update UI for any conversations or users that are now blocked/unblocked
                        this.users = this.users.map(function(user) {
                            if (user.uid === userId) {
                                return Object.assign({}, user, { isBlocked: shouldBlock });
                            }
                            return user;
                        });
                        
                        this.conversations = this.conversations.map(function(conversation) {
                            if (conversation.otherUser.uid === userId) {
                                return Object.assign({}, conversation, { 
                                    isBlocked: shouldBlock,
                                    otherUser: Object.assign({}, conversation.otherUser, { isBlocked: shouldBlock })
                                });
                            }
                            return conversation;
                        });
                        
                        // Filter conversations and users
                        this.filterConversations();
                        this.filterUsers();
                        
                        // Update current chat if needed
                        if (this.currentChat && this.currentChat.otherUser.uid === userId) {
                            this.currentChat = Object.assign({}, this.currentChat, {
                                otherUser: Object.assign({}, this.currentChat.otherUser, { isBlocked: shouldBlock })
                            });
                        }
                        
                        this.showBannerNotification(
                            shouldBlock ? "Utilisateur bloqué" : "Utilisateur débloqué", 
                            "success"
                        );
                        
                        this.render();
                    }
                } catch (error) {
                    console.error("Error blocking/unblocking user:", error);
                    this.showBannerNotification("Erreur lors de l'action", "error");
                }
            },
            
            // Confirm clear chat history
            confirmClearChatHistory() {
                if (!this.currentChat) return;
                
                this.showModal({
                    title: 'Effacer l\'historique',
                    content: 'Êtes-vous sûr de vouloir effacer l\'historique de cette conversation ? Cette action ne peut pas être annulée.',
                    actions: [
                        {
                            label: 'Annuler',
                            action: function() { app.closeModal(); },
                            className: 'modal-button-cancel'
                        },
                        {
                            label: 'Effacer',
                            action: function() {
                                app.clearChatHistory(app.currentChat.id);
                                app.closeModal();
                            },
                            className: 'modal-button-danger'
                        }
                    ]
                });
            },
            
            // Clear chat history (for current user only)
            async clearChatHistory(conversationId) {
                try {
                    // Get all messages in the conversation
                    const messagesQuery = await db.collection('messages')
                        .where('conversationId', '==', conversationId)
                        .get();
                    
                    if (!messagesQuery.empty) {
                        const batch = db.batch();
                        
                        // Mark all messages as hidden for current user
                        messagesQuery.forEach(function(doc) {
                            const messageData = doc.data();
                            let hidden = messageData.hidden || {};
                            hidden[app.currentUser.uid] = true;
                            batch.update(doc.ref, { hidden });
                        });
                        
                        await batch.commit();
                        
                        // Update conversation's last message
                        await db.collection('conversations').doc(conversationId).update({
                            lastMessage: "Historique effacé",
                            lastMessageType: 'text',
                            lastMessageTimestamp: firebase.firestore.Timestamp.now()
                        });
                        
                        this.showBannerNotification("Historique effacé", "success");
                        
                                                // Reload messages if in chat screen
                        if (this.currentScreen === 'chat' && this.currentChat && this.currentChat.id === conversationId) {
                            this.messages = [];
                            this.render();
                        }
                    }
                } catch (error) {
                    console.error("Error clearing chat history:", error);
                    this.showBannerNotification("Erreur lors de l'effacement de l'historique", "error");
                }
            },
            
            // Delete conversation (for current user only)
            async deleteConversation(conversationId) {
                try {
                    // Show confirmation dialog
                    this.showModal({
                        title: 'Supprimer la conversation',
                        content: 'Êtes-vous sûr de vouloir supprimer cette conversation ? Cette action ne peut pas être annulée.',
                        actions: [
                            {
                                label: 'Annuler',
                                action: function() { app.closeModal(); },
                                className: 'modal-button-cancel'
                            },
                            {
                                label: 'Supprimer',
                                action: async function() {
                                    try {
                                        // Mark conversation as deleted for current user
                                        const conversationRef = db.collection('conversations').doc(conversationId);
                                        const conversationDoc = await conversationRef.get();
                                        
                                        if (conversationDoc.exists) {
                                            const conversationData = conversationDoc.data();
                                            let deleted = conversationData.deleted || {};
                                            deleted[app.currentUser.uid] = true;
                                            
                                            await conversationRef.update({ deleted });
                                            
                                            // Return to main screen
                                            app.currentScreen = 'main';
                                            app.currentChat = null;
                                            
                                            app.showBannerNotification("Conversation supprimée", "success");
                                            app.closeModal();
                                            app.render();
                                        }
                                    } catch (error) {
                                        console.error("Error deleting conversation:", error);
                                        app.showBannerNotification("Erreur lors de la suppression", "error");
                                        app.closeModal();
                                    }
                                },
                                className: 'modal-button-danger'
                            }
                        ]
                    });
                } catch (error) {
                    console.error("Error in deleteConversation:", error);
                    this.showBannerNotification("Erreur lors de la suppression", "error");
                }
            },
            
            // Format timestamp
            formatTimestamp(timestamp) {
                if (!timestamp) return '';
                
                const now = new Date();
                const date = new Date(timestamp);
                
                // Same day
                if (date.toDateString() === now.toDateString()) {
                    return this.formatTime(date);
                }
                
                // Yesterday
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                if (date.toDateString() === yesterday.toDateString()) {
                    return 'Hier';
                }
                
                // Same week
                const startOfWeek = new Date(now);
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                if (date >= startOfWeek) {
                    const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                    return days[date.getDay()];
                }
                
                // Older
                return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
            },
            
            // Format time only
            formatTime(date) {
                if (!date) return '';
                
                const hours = date.getHours();
                const minutes = date.getMinutes();
                
                // Add leading zeros if needed
                const formattedHours = hours < 10 ? '0' + hours : hours;
                const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
                
                return `${formattedHours}:${formattedMinutes}`;
            },
            
            // Get initials from username
            getInitials(username) {
                if (!username) return '';
                
                const parts = username.split(' ');
                if (parts.length === 1) {
                    return username.charAt(0).toUpperCase();
                }
                
                return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
            },
            
            // Format last seen time
            formatLastSeen(lastSeen) {
                if (!lastSeen) return 'Jamais connecté';
                
                const now = new Date();
                const diff = Math.floor((now - lastSeen) / 1000);  // seconds
                
                if (diff < 60) return 'Connecté il y a quelques secondes';
                if (diff < 3600) return `Connecté il y a ${Math.floor(diff / 60)} min`;
                if (diff < 86400) return `Connecté il y a ${Math.floor(diff / 3600)} h`;
                
                // More than a day
                const days = Math.floor(diff / 86400);
                if (days === 1) return 'Connecté hier';
                if (days < 7) return `Connecté il y a ${days} jours`;
                
                // Just show the date
                const date = new Date(lastSeen);
                return `Connecté le ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
            },
            
            // Show notification toast
            showNotification(message, type) {
                // Clear any existing notification
                this.clearNotification();
                
                const toastContainer = document.createElement('div');
                toastContainer.className = `toast ${type || ''}`;
                
                let iconHTML = '';
                switch (type) {
                    case 'success':
                        iconHTML = '<svg class="toast-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 11.0857V12.0057C21.9988 14.1621 21.3005 16.2604 20.0093 17.9875C18.7182 19.7147 16.9033 20.9782 14.8354 21.5896C12.7674 22.201 10.5573 22.1276 8.53447 21.3803C6.51168 20.633 4.78465 19.2518 3.61096 17.4428C2.43727 15.6338 1.87979 13.4938 2.02168 11.342C2.16356 9.19029 2.99721 7.14205 4.39828 5.5028C5.79935 3.86354 7.69279 2.72111 9.79619 2.24587C11.8996 1.77063 14.1003 1.98806 16.07 2.86572" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 4L12 14.01L9 11.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        break;
                    case 'error':
                        iconHTML = '<svg class="toast-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 9L9 15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 9L15 15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        break;
                    case 'warning':
                        iconHTML = '<svg class="toast-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.29 3.86L1.82 18C1.64537 18.3024 1.55296 18.6453 1.55197 18.9945C1.55098 19.3437 1.64144 19.6871 1.81442 19.9905C1.98741 20.2939 2.23675 20.547 2.53773 20.7241C2.83871 20.9013 3.18058 20.9962 3.53 21H20.47C20.8194 20.9962 21.1613 20.9013 21.4623 20.7241C21.7633 20.547 22.0126 20.2939 22.1856 19.9905C22.3586 19.6871 22.449 19.3437 22.448 18.9945C22.447 18.6453 22.3546 18.3024 22.18 18L13.71 3.86C13.5317 3.56611 13.2807 3.32312 12.9812 3.15448C12.6817 2.98585 12.3437 2.89725 12 2.89725C11.6563 2.89725 11.3183 2.98585 11.0188 3.15448C10.7193 3.32312 10.4683 3.56611 10.29 3.86Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9V13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 17H12.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        break;
                    case 'info':
                        iconHTML = '<svg class="toast-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16V12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 8H12.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        break;
                }
                
                toastContainer.innerHTML = `${iconHTML} ${message}`;
                document.body.appendChild(toastContainer);
                
                // Set a timer to remove the notification
                this.notificationTimer = setTimeout(function() {
                    app.clearNotification();
                }, 3000);
            },
            
            // Clear notification toast
            clearNotification() {
                clearTimeout(this.notificationTimer);
                document.querySelectorAll('.toast').forEach(function(toast) {
                    toast.remove();
                });
            },
            
            // Show banner notification
            showBannerNotification(message, type) {
                // Clear any existing banner
                this.clearBannerNotification();
                
                const bannerContainer = document.createElement('div');
                bannerContainer.className = `banner-notification ${type || ''}`;
                
                let iconHTML = '';
                switch (type) {
                    case 'success':
                        iconHTML = '<div class="banner-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 11.0857V12.0057C21.9988 14.1621 21.3005 16.2604 20.0093 17.9875C18.7182 19.7147 16.9033 20.9782 14.8354 21.5896C12.7674 22.201 10.5573 22.1276 8.53447 21.3803C6.51168 20.633 4.78465 19.2518 3.61096 17.4428C2.43727 15.6338 1.87979 13.4938 2.02168 11.342C2.16356 9.19029 2.99721 7.14205 4.39828 5.5028C5.79935 3.86354 7.69279 2.72111 9.79619 2.24587C11.8996 1.77063 14.1003 1.98806 16.07 2.86572" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 4L12 14.01L9 11.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>';
                        break;
                    case 'error':
                        iconHTML = '<div class="banner-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 9L9 15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 9L15 15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>';
                        break;
                    case 'warning':
                        iconHTML = '<div class="banner-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.29 3.86L1.82 18C1.64537 18.3024 1.55296 18.6453 1.55197 18.9945C1.55098 19.3437 1.64144 19.6871 1.81442 19.9905C1.98741 20.2939 2.23675 20.547 2.53773 20.7241C2.83871 20.9013 3.18058 20.9962 3.53 21H20.47C20.8194 20.9962 21.1613 20.9013 21.4623 20.7241C21.7633 20.547 22.0126 20.2939 22.1856 19.9905C22.3586 19.6871 22.449 19.3437 22.448 18.9945C22.447 18.6453 22.3546 18.3024 22.18 18L13.71 3.86C13.5317 3.56611 13.2807 3.32312 12.9812 3.15448C12.6817 2.98585 12.3437 2.89725 12 2.89725C11.6563 2.89725 11.3183 2.98585 11.0188 3.15448C10.7193 3.32312 10.4683 3.56611 10.29 3.86Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9V13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 17H12.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>';
                        break;
                    case 'info':
                        iconHTML = '<div class="banner-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16V12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 8H12.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>';
                        break;
                }
                
                bannerContainer.innerHTML = `
                    <div class="banner-content">
                        ${iconHTML}
                        <div class="banner-message">${message}</div>
                    </div>
                    <button class="banner-close">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                `;
                
                document.body.appendChild(bannerContainer);
                
                // Add click handler for close button
                const closeButton = bannerContainer.querySelector('.banner-close');
                if (closeButton) {
                    closeButton.addEventListener('click', function() {
                        app.closeBannerNotification();
                    });
                }
                
                // Set a timer to remove the banner
                this.bannerNotificationTimer = setTimeout(function() {
                    app.closeBannerNotification();
                }, 5000);
            },
            
            // Close banner notification with animation
            closeBannerNotification() {
                clearTimeout(this.bannerNotificationTimer);
                
                const banner = document.querySelector('.banner-notification');
                if (banner) {
                    banner.classList.add('closing');
                    setTimeout(function() {
                        banner.remove();
                    }, 300);
                }
            },
            
            // Clear banner notification immediately
            clearBannerNotification() {
                clearTimeout(this.bannerNotificationTimer);
                document.querySelectorAll('.banner-notification').forEach(function(banner) {
                    banner.remove();
                });
            },
            
            // Show a modal dialog
            showModal(options) {
                // Remove any existing modal
                this.closeModal();
                
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                
                let actionsHTML = '';
                if (options.actions && options.actions.length) {
                    actionsHTML = `
                        <div class="modal-footer">
                            ${options.actions.map(function(action, index) {
                                return `<button class="modal-button ${action.className || ''}" data-action="${index}">${action.label}</button>`;
                            }).join('')}
                        </div>
                    `;
                }
                
                modalOverlay.innerHTML = `
                    <div class="modal-container">
                        <div class="modal-header">
                            ${options.title || 'Message'}
                        </div>
                        <div class="modal-body">
                            ${options.content || ''}
                        </div>
                        ${actionsHTML}
                    </div>
                `;
                
                document.body.appendChild(modalOverlay);
                this.modal = {
                    element: modalOverlay,
                    actions: options.actions || []
                };
                
                // Add click handlers
                if (options.actions && options.actions.length) {
                    const buttons = modalOverlay.querySelectorAll('.modal-button');
                    buttons.forEach(function(button) {
                        const actionIndex = parseInt(button.getAttribute('data-action'));
                        button.addEventListener('click', function() {
                            if (options.actions[actionIndex] && options.actions[actionIndex].action) {
                                options.actions[actionIndex].action();
                            }
                        });
                    });
                    
                    // Add click handler for overlay to close modal
                    modalOverlay.addEventListener('click', function(e) {
                        if (e.target === modalOverlay) {
                            app.closeModal();
                        }
                    });
                }
            },
            
            // Close modal dialog
            closeModal() {
                if (this.modal && this.modal.element) {
                    this.modal.element.remove();
                }
                this.modal = null;
            },
            
            // Edit profile field
            startEditing(field) {
                if (!this.currentUser) return;
                
                this.isEditing = true;
                this.editingField = field;
                
                // Determine current value
                let currentValue = '';
                switch (field) {
                    case 'username':
                        currentValue = this.currentUser.username;
                        break;
                    case 'phone':
                        currentValue = this.currentUser.phone;
                        break;
                    case 'bio':
                        currentValue = this.currentUser.bio;
                        break;
                }
                
                // Show modal with input
                const isTextarea = field === 'bio';
                const inputHTML = isTextarea ? 
                    `<textarea class="form-input" id="edit-field" style="min-height: 100px; resize: none;">${currentValue}</textarea>` :
                    `<input type="text" class="form-input" id="edit-field" value="${currentValue}">`;
                
                let fieldLabel = '';
                switch (field) {
                    case 'username': 
                        fieldLabel = "Nom d'utilisateur";
                        break;
                    case 'phone': 
                        fieldLabel = "Téléphone";
                        break;
                    case 'bio': 
                        fieldLabel = "Bio";
                        break;
                }
                
                this.showModal({
                    title: 'Modifier ' + fieldLabel.toLowerCase(),
                    content: `
                        <div class="form-group">
                            <label class="form-label">${fieldLabel}</label>
                            ${inputHTML}
                        </div>
                    `,
                    actions: [
                        {
                            label: 'Annuler',
                            action: function() { 
                                app.isEditing = false; 
                                app.editingField = null;
                                app.closeModal(); 
                            },
                            className: 'modal-button-cancel'
                        },
                        {
                            label: 'Enregistrer',
                            action: function() { app.saveEdit(); },
                            className: 'modal-button-confirm'
                        }
                    ]
                });
                
                // Focus the input after modal is shown
                setTimeout(function() {
                    const input = document.getElementById('edit-field');
                    if (input) {
                        input.focus();
                    }
                }, 100);
            },
            
            // Save edited field
            async saveEdit() {
                if (!this.currentUser || !this.editingField) return;
                
                const input = document.getElementById('edit-field');
                if (!input) return;
                
                const newValue = input.value.trim();
                
                // Validate input
                if (this.editingField === 'username' && !newValue) {
                    this.showBannerNotification("Le nom d'utilisateur ne peut pas être vide", "error");
                    return;
                }
                
                try {
                    // Extra validation for username to check for duplicates
                    if (this.editingField === 'username' && newValue !== this.currentUser.username) {
                        const usernameCheck = await db.collection('users')
                            .where('username', '==', newValue)
                            .get();
                        
                        if (!usernameCheck.empty) {
                            this.showBannerNotification("Ce nom d'utilisateur est déjà pris", "error");
                            return;
                        }
                    }
                    
                    // Prepare update object
                    const update = {};
                    update[this.editingField] = newValue;
                    
                    // Update user doc
                    await db.collection('users').doc(this.currentUser.uid).update(update);
                    
                    // Update local state
                    this.currentUser[this.editingField] = newValue;
                    
                    // Update auth profile if needed
                    if (this.editingField === 'username') {
                        await auth.currentUser.updateProfile({
                            displayName: newValue
                        });
                    }
                    
                    this.showBannerNotification("Profil mis à jour", "success");
                    
                } catch (error) {
                    console.error("Error updating profile:", error);
                    this.showBannerNotification("Erreur lors de la mise à jour", "error");
                }
                
                this.isEditing = false;
                this.editingField = null;
                this.closeModal();
                this.render();
            },
            
            // Scroll chat to bottom
            scrollToBottom() {
                const messagesContainer = document.querySelector('.chat-messages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            },
            
            // Back from chat to main screen
            backToMain() {
                this.currentScreen = 'main';
                this.currentChat = null;
                this.render();
            },
            
            // Handle logout from auth screen
            async handleAuthLogout() {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error("Auth logout error:", error);
                }
            },
            
            // Enter selection mode for messages or conversations
            enterSelectionMode(mode) {
                if (mode === 'messages') {
                    this.selectionMode = true;
                    this.selectedMessages = new Set();
                } else if (mode === 'conversations') {
                    this.isConversationSelectionMode = true;
                    this.selectedConversations = new Set();
                }
                this.render();
            },
            
            // Exit all selection modes
            exitSelectionMode() {
                this.selectionMode = false;
                this.isConversationSelectionMode = false;
                this.selectedMessages = new Set();
                this.selectedConversations = new Set();
                this.render();
            },
            
            // Toggle message selection
            toggleMessageSelection(messageId) {
                if (this.selectedMessages.has(messageId)) {
                    this.selectedMessages.delete(messageId);
                } else {
                    this.selectedMessages.add(messageId);
                }
                this.render();
            },
            
            // Toggle conversation selection
            toggleConversationSelection(conversationId) {
                if (this.selectedConversations.has(conversationId)) {
                    this.selectedConversations.delete(conversationId);
                } else {
                    this.selectedConversations.add(conversationId);
                }
                this.render();
            },
            
            // Delete selected messages
            async deleteSelectedMessages() {
                if (!this.selectedMessages.size) return;
                
                try {
                    const batch = db.batch();
                    const currentUserId = this.currentUser.uid;
                    
                    // Collect messages to delete
                    const messagesToDelete = this.messages.filter(function(message) {
                        return app.selectedMessages.has(message.id);
                    });
                    
                    // Process each message
                    for (const message of messagesToDelete) {
                        const messageRef = db.collection('messages').doc(message.id);
                        const messageDoc = await messageRef.get();
                        
                        if (messageDoc.exists) {
                            // Different handling based on whether user is the sender
                            if (message.senderId === currentUserId) {
                                // If current user is sender, can actually delete
                                batch.delete(messageRef);
                            } else {
                                // If not sender, just hide for current user
                                const messageData = messageDoc.data();
                                let hidden = messageData.hidden || {};
                                hidden[currentUserId] = true;
                                batch.update(messageRef, { hidden });
                            }
                        }
                    }
                    
                    // Commit batch
                    await batch.commit();
                    
                    // Update last message in conversation if needed
                    if (this.currentChat) {
                        const remainingMessages = await db.collection('messages')
                            .where('conversationId', '==', this.currentChat.id)
                            .orderBy('timestamp', 'desc')
                            .limit(1)
                            .get();
                        
                        if (!remainingMessages.empty) {
                            const lastMessage = remainingMessages.docs[0].data();
                            
                            await db.collection('conversations').doc(this.currentChat.id).update({
                                lastMessage: lastMessage.text || (lastMessage.messageType === 'image' ? '📷 Image' : ''),
                                lastMessageType: lastMessage.messageType || 'text',
                                lastMessageTimestamp: lastMessage.timestamp,
                                lastMessageSenderId: lastMessage.senderId
                            });
                        } else {
                            // No messages left
                            await db.collection('conversations').doc(this.currentChat.id).update({
                                lastMessage: '',
                                lastMessageTimestamp: firebase.firestore.Timestamp.now()
                            });
                        }
                    }
                    
                    this.showBannerNotification(`${this.selectedMessages.size} message(s) supprimé(s)`, "success");
                    
                    // Exit selection mode
                    this.exitSelectionMode();
                    
                } catch (error) {
                    console.error("Error deleting messages:", error);
                    this.showBannerNotification("Erreur lors de la suppression", "error");
                }
            },
            
            // Delete selected conversations
            async deleteSelectedConversations() {
                if (!this.selectedConversations.size) return;
                
                try {
                    const batch = db.batch();
                    
                    // For each selected conversation
                    for (const conversationId of this.selectedConversations) {
                        const conversationRef = db.collection('conversations').doc(conversationId);
                        const conversationDoc = await conversationRef.get();
                        
                        if (conversationDoc.exists) {
                            const conversationData = conversationDoc.data();
                            let deleted = conversationData.deleted || {};
                            deleted[this.currentUser.uid] = true;
                            
                            batch.update(conversationRef, { deleted });
                        }
                    }
                    
                    await batch.commit();
                    
                    this.showBannerNotification(`${this.selectedConversations.size} conversation(s) supprimée(s)`, "success");
                    
                    // Exit selection mode
                    this.exitSelectionMode();
                    
                } catch (error) {
                    console.error("Error deleting conversations:", error);
                    this.showBannerNotification("Erreur lors de la suppression", "error");
                }
            },
            
            // Show emoji picker
            showEmojiPicker() {
                this.emojiPickerVisible = true;
                this.render();
            },
            
            // Close emoji picker
            closeEmojiPicker() {
                this.emojiPickerVisible = false;
                this.render();
            },
            
            // Add emoji to input
            addEmoji(emoji) {
                const messageInput = document.getElementById('message-input');
                if (!messageInput) return;
                
                const start = messageInput.selectionStart;
                const end = messageInput.selectionEnd;
                const text = messageInput.value;
                
                messageInput.value = text.substring(0, start) + emoji + text.substring(end);
                
                // Set cursor position after the emoji
                messageInput.selectionStart = messageInput.selectionEnd = start + emoji.length;
                
                // Add to recent emojis
                if (!this.recentEmojis.includes(emoji)) {
                    this.recentEmojis.unshift(emoji);
                    
                    // Keep recent emojis limited to 10
                    if (this.recentEmojis.length > 10) {
                        this.recentEmojis.pop();
                    }
                }
                
                // Close emoji picker
                this.closeEmojiPicker();
                
                // Focus input
                messageInput.focus();
            },
            
            // Show reaction picker for message
            showReactionPicker(messageId) {
                this.reactionPickerVisible = true;
                this.reactionPickerTargetId = messageId;
                this.render();
                
                // Position the picker
                setTimeout(function() {
                    const messageBubble = document.querySelector(`.message-bubble[data-message-id="${messageId}"]`);
                    const reactionPicker = document.querySelector('.reaction-picker');
                    
                    if (messageBubble && reactionPicker) {
                        const rect = messageBubble.getBoundingClientRect();
                        const pickerRect = reactionPicker.getBoundingClientRect();
                        
                        // Position above the message
                        reactionPicker.style.left = (rect.left + rect.width/2 - pickerRect.width/2) + 'px';
                        reactionPicker.style.top = (rect.top - pickerRect.height - 10) + 'px';
                    }
                }, 10);
            },
            
            // Close reaction picker
            closeReactionPicker() {
                this.reactionPickerVisible = false;
                this.reactionPickerTargetId = null;
                this.render();
            },
            
            // Add reaction to message
            async addReaction(emoji) {
                if (!this.reactionPickerTargetId) return;
                
                try {
                    const messageRef = db.collection('messages').doc(this.reactionPickerTargetId);
                    const messageDoc = await messageRef.get();
                    
                    if (messageDoc.exists) {
                        const messageData = messageDoc.data();
                        let reactions = messageData.reactions || {};
                        
                        // Initialize emoji reactions if not exists
                        if (!reactions[emoji]) {
                            reactions[emoji] = [];
                        }
                        
                        // Add or remove user's reaction
                        if (reactions[emoji].includes(this.currentUser.uid)) {
                            // Remove reaction
                            reactions[emoji] = reactions[emoji].filter(function(uid) {
                                return uid !== app.currentUser.uid;
                            });
                            
                            // Remove emoji if no users left
                            if (reactions[emoji].length === 0) {
                                delete reactions[emoji];
                            }
                        } else {
                            // Add reaction
                            reactions[emoji].push(this.currentUser.uid);
                        }
                        
                        await messageRef.update({ reactions });
                    }
                    
                    this.closeReactionPicker();
                    
                } catch (error) {
                    console.error("Error adding reaction:", error);
                    this.showBannerNotification("Erreur lors de l'ajout de la réaction", "error");
                    this.closeReactionPicker();
                }
            },
            
            // Show image full screen
            previewImage(imageUrl) {
                this.customImagePreview = {
                    url: imageUrl
                };
                this.render();
            },
            
            // Close custom image preview
            closeCustomImagePreview() {
                this.customImagePreview = null;
                this.render();
            },
            
            // Open the main rendering function
            render() {
                const appElement = document.getElementById('app');
                if (!appElement) return;
                
                // Apply accent color and theme
                this.applyAccentColor();
                this.applyAccentGradient(this.accentGradient);
                
                switch (this.currentScreen) {
                    case 'loading':
                        this.renderLoadingScreen();
                        break;
                    case 'auth':
                        this.renderAuthScreen();
                        break;
                    case 'main':
                        this.renderMainScreen();
                        break;
                    case 'chat':
                        this.renderChatScreen();
                        break;
                }
                
                // Render custom image preview if active
                if (this.customImagePreview) {
                    this.renderCustomImagePreview();
                }
            },
            
            // Render authentication screen
            renderAuthScreen() {
                const appElement = document.getElementById('app');
                if (!appElement) return;
                
                // Login tab content
                const loginTabContent = `
                    <form id="login-form" class="auth-form">
                        <div class="form-group">
                            <label for="login-email" class="form-label">Email</label>
                            <input type="email" id="login-email" class="form-input" placeholder="Votre email" required autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label for="login-password" class="form-label">Mot de passe</label>
                            <input type="password" id="login-password" class="form-input" placeholder="Votre mot de passe" required autocomplete="current-password">
                        </div>
                        <button type="submit" class="btn btn-primary">Se connecter</button>
                    </form>
                `;
                
                // Register tab content
                const registerTabContent = `
                    <form id="register-form" class="auth-form">
                        <div class="form-group">
                            <label for="register-username" class="form-label">Nom d'utilisateur</label>
                            <input type="text" id="register-username" class="form-input" placeholder="Choisissez un nom d'utilisateur" required autocomplete="username">
                        </div>
                        <div class="form-group">
                            <label for="register-email" class="form-label">Email</label>
                            <input type="email" id="register-email" class="form-input" placeholder="Votre email" required autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label for="register-phone" class="form-label">Téléphone (optionnel)</label>
                            <input type="tel" id="register-phone" class="form-input" placeholder="Votre numéro de téléphone" autocomplete="tel">
                        </div>
                        <div class="form-group">
                            <label for="register-password" class="form-label">Mot de passe</label>
                            <input type="password" id="register-password" class="form-input" placeholder="Créez un mot de passe" required autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label for="register-confirm-password" class="form-label">Confirmer le mot de passe</label>
                            <input type="password" id="register-confirm-password" class="form-input" placeholder="Confirmez votre mot de passe" required autocomplete="new-password">
                        </div>
                        <button type="submit" class="btn btn-primary">S'inscrire</button>
                    </form>
                `;
                
                appElement.innerHTML = `
                    <div class="container">
                        <div class="auth-container">
                            <div class="auth-logo">
                                <h1>ChatXchange</h1>
                                <p style="color: var(--secondary-text);">Connectez-vous pour commencer à chatter</p>
                            </div>
                            
                            <div>
                                <div class="auth-tabs">
                                    <div class="auth-tab ${this.activeAuthTab === 'login' ? 'active' : ''}" id="login-tab">Se connecter</div>
                                    <div class="auth-tab ${this.activeAuthTab === 'register' ? 'active' : ''}" id="register-tab">S'inscrire</div>
                                </div>
                                
                                <div class="auth-tab-content">
                                    ${this.activeAuthTab === 'login' ? loginTabContent : registerTabContent}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners
                document.getElementById('login-tab').addEventListener('click', function() {
                    app.switchAuthTab('login');
                });
                
                document.getElementById('register-tab').addEventListener('click', function() {
                    app.switchAuthTab('register');
                });
                
                document.getElementById('login-form').addEventListener('submit', function(event) {
                    app.handleLogin(event);
                });
                
                document.getElementById('register-form')?.addEventListener('submit', function(event) {
                    app.handleRegister(event);
                });
            },
            
            // Render main screen
            renderMainScreen() {
                const appElement = document.getElementById('app');
                if (!appElement) return;
                
                // Header content based on current tab
                let headerContent = '';
                
                // Batch actions bar for conversations
                let batchActionsBar = '';
                if (this.isConversationSelectionMode && this.selectedConversations.size > 0) {
                    batchActionsBar = `
                        <div class="batch-actions-bar">
                            <div class="batch-actions-title">${this.selectedConversations.size} conversation(s) sélectionnée(s)</div>
                            <div style="display: flex;">
                                <button class="batch-action-button" id="delete-selected-conversations">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3 6H5H21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="batch-action-button" id="cancel-selection">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // Tab-specific header
                if (this.currentTab === 'conversations') {
                    if (this.isConversationSelectionMode) {
                        headerContent = `
                            <button class="back-button" id="cancel-conversation-selection">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <div class="header-title">Sélectionner des conversations</div>
                        `;
                    } else {
                        headerContent = `
                            <div class="header-title">Discussions</div>
                            <button class="more-button" id="start-conversation-selection">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M19 13C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11C18.4477 11 18 11.4477 18 12C18 12.5523 18.4477 13 19 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M5 13C5.55228 13 6 12.5523 6 12C6 11.4477 5.55228 11 5 11C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        `;
                    }
                } else {
                    headerContent = `<div class="header-title">${
                        this.currentTab === 'users' ? 'Contacts' : 
                        this.currentTab === 'profile' ? 'Profil' : 
                        this.currentTab === 'ai' ? 'IA' : 'ChatXchange'
                    }</div>`;
                }
                
                // Search bar for conversations and users
                let searchBar = '';
                if (this.currentTab === 'conversations' || this.currentTab === 'users') {
                    searchBar = `
                        <div class="search-container">
                            <div class="search-wrapper">
                                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <input type="search" id="search-input" class="message-input" placeholder="${
                                    this.currentTab === 'conversations' ? 'Rechercher une conversation...' : 'Rechercher un contact...'
                                }" value="${this.searchQuery}">
                                ${this.searchQuery ? `
                                    <button class="search-clear" id="clear-search">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Main content based on current tab
                let mainContent = '';
                
                if (this.currentTab === 'conversations') {
                    mainContent = this.renderConversations();
                } else if (this.currentTab === 'users') {
                    mainContent = this.renderUsers();
                } else if (this.currentTab === 'profile') {
                    mainContent = this.renderProfile();
                } else if (this.currentTab === 'ai') {
                    mainContent = this.renderAIFeatures();
                }
                
                // Compose button for conversations tab
                let composeButton = '';
                if (this.currentTab === 'conversations') {
                    composeButton = `
                        <button class="compose-button" id="switch-to-users-tab">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 5V19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M5 12H19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    `;
                }
                
                // Tab bar
                const tabBar = `
                    <div class="tab-bar">
                        <div class="tab-button ${this.currentTab === 'conversations' ? 'active' : ''}" id="tab-conversations">
                            <div class="tab-button-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="tab-button-label">Discussions</div>
                        </div>
                        <div class="tab-button ${this.currentTab === 'users' ? 'active' : ''}" id="tab-users">
                            <div class="tab-button-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M9 11C11.2091 11 13 9.20914 13 7C13 4.79086 11.2091 3 9 3C6.79086 3 5 4.79086 5 7C5 9.20914 6.79086 11 9 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89318 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="tab-button-label">Contacts</div>
                        </div>
                        <div class="tab-button ${this.currentTab === 'ai' ? 'active' : ''}" id="tab-ai">
                            <div class="tab-button-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2L6.5 11H17.5L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6.5 11L3 17L9.5 14L12 22L14.5 14L21 17L17.5 11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="tab-button-label">IA</div>
                        </div>
                        <div class="tab-button ${this.currentTab === 'profile' ? 'active' : ''}" id="tab-profile">
                            <div class="tab-button-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="tab-button-label">Profil</div>
                        </div>
                    </div>
                `;
                
                appElement.innerHTML = `
                    <div class="container">
                        <div class="header">
                            ${headerContent}
                        </div>
                        
                        ${batchActionsBar}
                        ${searchBar}
                        
                        <div class="main">
                            ${mainContent}
                        </div>
                        
                        ${tabBar}
                        ${composeButton}
                    </div>
                `;
                
                // Add event listeners for tabs
                document.getElementById('tab-conversations').addEventListener('click', function() {
                    app.switchTab('conversations');
                });
                
                document.getElementById('tab-users').addEventListener('click', function() {
                    app.switchTab('users');
                });
                
                document.getElementById('tab-ai').addEventListener('click', function() {
                    app.switchTab('ai');
                });
                
                document.getElementById('tab-profile').addEventListener('click', function() {
                    app.switchTab('profile');
                });
                
                // Add event listener for compose button
                if (this.currentTab === 'conversations') {
                    document.getElementById('switch-to-users-tab').addEventListener('click', function() {
                        app.switchTab('users');
                    });
                    
                    // Add event listener for selection mode
                    if (!this.isConversationSelectionMode) {
                        document.getElementById('start-conversation-selection').addEventListener('click', function() {
                            app.enterSelectionMode('conversations');
                        });
                    } else {
                        document.getElementById('cancel-conversation-selection').addEventListener('click', function() {
                            app.exitSelectionMode();
                        });
                        
                        if (this.selectedConversations.size > 0) {
                            document.getElementById('delete-selected-conversations').addEventListener('click', function() {
                                app.deleteSelectedConversations();
                            });
                            
                            document.getElementById('cancel-selection').addEventListener('click', function() {
                                app.exitSelectionMode();
                            });
                        }
                    }
                }
                
                // Add search functionality
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', function(e) {
                        app.handleSearch(e.target.value);
                    });
                    
                    // Focus search input if search is active
                    if (this.searchQuery) {
                        // Only focus on desktop, not mobile
                        if (window.innerWidth >= 768) {
                            searchInput.focus();
                        }
                        
                        // Add clear button functionality
                        const clearButton = document.getElementById('clear-search');
                        if (clearButton) {
                            clearButton.addEventListener('click', function() {
                                app.clearSearch();
                            });
                        }
                    }
                }
                
                // Set up profile field editing
                if (this.currentTab === 'profile') {
                    const editableFields = document.querySelectorAll('.editable-field');
                    editableFields.forEach(function(field) {
                        field.addEventListener('click', function() {
                            const fieldName = field.getAttribute('data-field');
                            app.startEditing(fieldName);
                        });
                    });
                    
                    // Set up color options
                    const colorOptions = document.querySelectorAll('.color-option');
                    colorOptions.forEach(function(option) {
                        option.addEventListener('click', function() {
                            const color = this.getAttribute('data-color');
                            app.changeAccentColor(color, true);
                        });
                    });
                    
                    // Set up gradient options
                    const gradientOptions = document.querySelectorAll('.gradient-option');
                    gradientOptions.forEach(function(option) {
                        option.addEventListener('click', function() {
                            const gradient = this.getAttribute('data-gradient');
                            app.changeAccentGradient(gradient, true);
                        });
                    });
                    
                    // Setup dark mode toggle
                    const themeToggle = document.getElementById('theme-toggle');
                    if (themeToggle) {
                        themeToggle.checked = this.isDarkMode;
                        themeToggle.addEventListener('change', function() {
                            app.toggleDarkMode(this.checked, true);
                        });
                    }
                    
                    // Setup avatar upload
                    const avatarContainer = document.querySelector('.profile-avatar-container');
                    if (avatarContainer) {
                        avatarContainer.addEventListener('click', function() {
                            document.getElementById('avatar-upload').click();
                        });
                    }
                    
                    const avatarUpload = document.getElementById('avatar-upload');
                    if (avatarUpload) {
                        avatarUpload.addEventListener('change', function(event) {
                            app.handleAvatarSelect(event);
                        });
                    }
                    
                    // Setup logout button
                    const logoutButton = document.getElementById('logout-button');
                    if (logoutButton) {
                        logoutButton.addEventListener('click', function() {
                            app.handleLogout();
                        });
                    }
                }
            },
            
            // Render conversation list
            renderConversations() {
                // If no conversations yet
                if (this.conversations.length === 0) {
                    return `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <h3 class="empty-state-title">Aucune conversation</h3>
                            <p class="empty-state-text">Commencez à discuter avec quelqu'un depuis l'onglet Contacts</p>
                        </div>
                    `;
                }
                
                // If search has no results
                if (this.filteredConversations.length === 0 && this.searchQuery) {
                    return `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <h3 class="empty-state-title">Aucun résultat</h3>
                            <p class="empty-state-text">Aucune conversation ne correspond à votre recherche</p>
                        </div>
                    `;
                }
                
                let conversationsHTML = '<div class="conversation-list">';
                
                // Format and group conversations
                this.filteredConversations.forEach(function(conversation) {
                    const isSelected = app.isConversationSelectionMode && app.selectedConversations.has(conversation.id);
                    
                    // Get initial from username
                    const initial = app.getInitials(conversation.otherUser.username);
                    
                    // Format time
                    const time = app.formatTimestamp(conversation.lastMessageTimestamp);
                    
                    // Message preview based on type
                    let messagePreview = conversation.lastMessage || '';
                    if (conversation.lastMessageType === 'image' && !conversation.lastMessage) {
                        messagePreview = '📷 Image';
                    }
                    
                    conversationsHTML += `
                        <div class="conversation-item ${isSelected ? 'selected' : ''}" 
                            data-id="${conversation.id}" 
                            data-user-id="${conversation.otherUser.uid}">
                            
                            ${app.isConversationSelectionMode ? `
                                <div class="conversation-checkbox">
                                    ${isSelected ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17L4 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' : ''}
                                </div>
                            ` : ''}
                            
                            <div class="conversation-avatar">
                                ${conversation.otherUser.avatar ? 
                                    `<img src="${conversation.otherUser.avatar}" alt="${conversation.otherUser.username}">` : 
                                    initial
                                }
                                <div class="conversation-status ${conversation.otherUser.online ? 'online' : ''}"></div>
                            </div>
                            <div class="conversation-content">
                                <div class="conversation-name">
                                    ${conversation.otherUser.username}
                                    ${conversation.isBlocked ? '<span class="conversation-blocked">Bloqué</span>' : ''}
                                </div>
                                <div class="conversation-message">
                                    ${conversation.lastMessageSenderId === app.currentUser.uid ? 'Vous: ' : ''}
                                    ${messagePreview}
                                </div>
                            </div>
                            <div class="conversation-meta">
                                <div class="conversation-time">${time}</div>
                                ${conversation.unreadCount > 0 ? 
                                    `<div class="conversation-badge">${conversation.unreadCount}</div>` : 
                                    ''
                                }
                            </div>
                        </div>
                    `;
                });
                
                conversationsHTML += '</div>';
                return conversationsHTML;
            },
            
            // Render user list
            renderUsers() {
                // If no users yet
                if (this.users.length === 0) {
                    return `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M9 11C11.2091 11 13 9.20914 13 7C13 4.79086 11.2091 3 9 3C6.79086 3 5 4.79086 5 7C5 9.20914 6.79086 11 9 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89318 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <h3 class="empty-state-title">Aucun contact</h3>
                            <p class="empty-state-text">Il n'y a pas encore d'autres utilisateurs inscrits</p>
                        </div>
                    `;
                }
                
                // If search has no results
                if (this.filteredUsers.length === 0 && this.searchQuery) {
                    return `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <h3 class="empty-state-title">Aucun résultat</h3>
                            <p class="empty-state-text">Aucun contact ne correspond à votre recherche</p>
                        </div>
                    `;
                }
                
                let usersHTML = '<div class="user-list">';
                
                // Format and group users
                this.filteredUsers.forEach(function(user) {
                    // Get initial from username
                    const initial = app.getInitials(user.username);
                    
                    usersHTML += `
                        <div class="user-item" data-id="${user.uid}">
                            <div class="user-avatar">
                                ${user.avatar ? 
                                    `<img src="${user.avatar}" alt="${user.username}">` : 
                                    initial
                                }
                            </div>
                            <div class="user-info">
                                <div class="user-name">
                                    ${user.username}
                                    ${user.isBlocked ? '<span class="user-blocked">Bloqué</span>' : ''}
                                </div>
                                <div class="user-status">
                                    <div class="status-dot ${user.online ? 'online' : ''}"></div>
                                    ${user.online ? 'En ligne' : user.lastSeen ? app.formatLastSeen(user.lastSeen) : 'Jamais connecté'}
                                </div>
                                ${user.bio ? `<div class="user-bio">${user.bio}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                usersHTML += '</div>';
                return usersHTML;
            },
            
            // Render profile screen
            renderProfile() {
                if (!this.currentUser) return '';
                
                // Get initial from username
                const initial = this.getInitials(this.currentUser.username);
                
                return `
                    <div class="profile-container">
                        <div class="profile-header">
                            <div class="profile-avatar-container">
                                <div class="profile-avatar">
                                    ${this.currentUser.avatar ? 
                                        `<img src="${this.currentUser.avatar}" alt="${this.currentUser.username}">` : 
                                        initial
                                    }
                                    <div class="profile-avatar-edit">Modifier</div>
                                </div>
                                <input type="file" id="avatar-upload" class="input-file" accept="image/*">
                            </div>
                        </div>
                        
                        <div class="profile-card">
                            <div class="profile-card-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Information personnelle
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Nom</div>
                                <div class="profile-field-value editable-field" data-field="username">${this.currentUser.username}</div>
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Email</div>
                                <div class="profile-field-value">${this.currentUser.email}</div>
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Téléphone</div>
                                <div class="profile-field-value editable-field" data-field="phone">${this.currentUser.phone || 'Non renseigné'}</div>
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Bio</div>
                                <div class="profile-field-value editable-field" data-field="bio">${this.currentUser.bio || 'Aucune bio'}</div>
                            </div>
                        </div>
                        
                        <div class="profile-card">
                            <div class="profile-card-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M19.4 15C19.2669 15.3016 19.2272 15.6362 19.286 15.9606C19.3448 16.285 19.4995 16.5843 19.73 16.82L19.79 16.88C19.976 17.0657 20.1235 17.2863 20.2241 17.5291C20.3248 17.7719 20.3766 18.0322 20.3766 18.295C20.3766 18.5578 20.3248 18.8181 20.2241 19.0609C20.1235 19.3037 19.976 19.5243 19.79 19.71C19.6043 19.896 19.3837 20.0435 19.1409 20.1441C18.8981 20.2448 18.6378 20.2966 18.375 20.2966C18.1122 20.2966 17.8519 20.2448 17.6091 20.1441C17.3663 20.0435 17.1457 19.896 16.96 19.71L16.9 19.65C16.6643 19.4195 16.365 19.2648 16.0406 19.206C15.7162 19.1472 15.3816 19.1869 15.08 19.32C14.7842 19.4468 14.532 19.6572 14.3543 19.9255C14.1766 20.1938 14.0813 20.5082 14.08 20.83V21C14.08 21.5304 13.8693 22.0391 13.4942 22.4142C13.1191 22.7893 12.6104 23 12.08 23C11.5496 23 11.0409 22.7893 10.6658 22.4142C10.2907 22.0391 10.08 21.5304 10.08 21V20.91C10.0723 20.579 9.96512 20.258 9.77251 19.9887C9.5799 19.7194 9.31074 19.5143 9 19.4C8.69838 19.2669 8.36381 19.2272 8.03941 19.286C7.71502 19.3448 7.41568 19.4995 7.18 19.73L7.12 19.79C6.93425 19.976 6.71368 20.1235 6.47088 20.2241C6.22808 20.3248 5.96783 20.3766 5.705 20.3766C5.44217 20.3766 5.18192 20.3248 4.93912 20.2241C4.69632 20.1235 4.47575 19.976 4.29 19.79C4.10405 19.6043 3.95653 19.3837 3.85588 19.1409C3.75523 18.8981 3.70343 18.6378 3.70343 18.375C3.70343 18.1122 3.75523 17.8519 3.85588 17.6091C3.95653 17.3663 4.10405 17.1457 4.29 16.96L4.35 16.9C4.58054 16.6643 4.73519 16.365 4.794 16.0406C4.85282 15.7162 4.81312 15.3816 4.68 15.08C4.55324 14.7842 4.34276 14.532 4.07447 14.3543C3.80618 14.1766 3.49179 14.0813 3.17 14.08H3C2.46957 14.08 1.96086 13.8693 1.58579 13.4942C1.21071 13.1191 1 12.6104 1 12.08C1 11.5496 1.21071 11.0409 1.58579 10.6658C1.96086 10.2907 2.46957 10.08 3 10.08H3.09C3.42099 10.0723 3.742 9.96512 4.0113 9.77251C4.28059 9.5799 4.48572 9.31074 4.6 9C4.73312 8.69838 4.77282 8.36381 4.714 8.03941C4.65519 7.71502 4.50054 7.41568 4.27 7.18L4.21 7.12C4.02405 6.93425 3.87653 6.71368 3.77588 6.47088C3.67523 6.22808 3.62343 5.96783 3.62343 5.705C3.62343 5.44217 3.67523 5.18192 3.77588 4.93912C3.87653 4.69632 4.02405 4.47575 4.21 4.29C4.39575 4.10405 4.61632 3.95653 4.85912 3.85588C5.10192 3.75523 5.36217 3.70343 5.625 3.70343C5.88783 3.70343 6.14808 3.75523 6.39088 3.85588C6.63368 3.95653 6.85425 4.10405 7.04 4.29L7.1 4.35C7.33568 4.58054 7.63502 4.73519 7.95941 4.794C8.28381 4.85282 8.61838 4.81312 8.92 4.68H9C9.29577 4.55324 9.54802 4.34276 9.72569 4.07447C9.90337 3.80618 9.99872 3.49179 10 3.17V3C10 2.46957 10.2107 1.96086 10.5858 1.58579C10.9609 1.21071 11.4696 1 12 1C12.5304 1 13.0391 1.21071 13.4142 1.58579C13.7893 1.96086 14 2.46957 14 3V3.09C14.0013 3.41179 14.0966 3.72618 14.2743 3.99447C14.452 4.26276 14.7042 4.47324 15 4.6C15.3016 4.73312 15.6362 4.77282 15.9606 4.714C16.285 4.65519 16.5843 4.50054 16.82 4.27L16.88 4.21C17.0657 4.02405 17.2863 3.87653 17.5291 3.77588C17.7719 3.67523 18.0322 3.62343 18.295 3.62343C18.5578 3.62343 18.8181 3.67523 19.0609 3.77588C19.3037 3.87653 19.5243 4.02405 19.71 4.21C19.896 4.39575 20.0435 4.61632 20.1441 4.85912C20.2448 5.10192 20.2966 5.36217 20.2966 5.625C20.2966 5.88783 20.2448 6.14808 20.1441 6.39088C20.0435 6.63368 19.896 6.85425 19.71 7.04L19.65 7.1C19.4195 7.33568 19.2648 7.63502 19.206 7.95941C19.1472 8.28381 19.1869 8.61838 19.32 8.92V9C19.4468 9.29577 19.6572 9.54802 19.9255 9.72569C20.1938 9.90337 20.5082 9.99872 20.83 10H21C21.5304 10 22.0391 10.2107 22.4142 10.5858C22.7893 10.9609 23 11.4696 23 12C23 12.5304 22.7893 13.0391 22.4142 13.4142C22.0391 13.7893 21.5304 14 21 14H20.91C20.5882 14.0013 20.2738 14.0966 20.0055 14.2743C19.7372 14.452 19.5268 14.7042 19.4 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Personnalisation
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Thème</div>
                                <div class="theme-toggle">
                                    Mode sombre
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="theme-toggle" ${this.isDarkMode ? 'checked' : ''}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Couleur</div>
                                <div class="color-options">
                                    <div class="color-option ${this.accentColor === '#5D5CDE' ? 'active' : ''}" style="background-color: #5D5CDE" data-color="#5D5CDE"></div>
                                    <div class="color-option ${this.accentColor === '#4CAF50' ? 'active' : ''}" style="background-color: #4CAF50" data-color="#4CAF50"></div>
                                    <div class="color-option ${this.accentColor === '#2196F3' ? 'active' : ''}" style="background-color: #2196F3" data-color="#2196F3"></div>
                                    <div class="color-option ${this.accentColor === '#FF9800' ? 'active' : ''}" style="background-color: #FF9800" data-color="#FF9800"></div>
                                    <div class="color-option ${this.accentColor === '#E91E63' ? 'active' : ''}" style="background-color: #E91E63" data-color="#E91E63"></div>
                                    <div class="color-option ${this.accentColor === '#9C27B0' ? 'active' : ''}" style="background-color: #9C27B0" data-color="#9C27B0"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="profile-actions">
                            <button class="action-button logout-button" id="logout-button">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 17L21 12L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Se déconnecter
                            </button>
                        </div>
                    </div>
                `;
            },
            
            // Render AI features screen
            renderAIFeatures() {
                return `
                    <div style="padding: 16px;">
                        <div class="ai-feature-card">
                            <div class="ai-feature-bg"></div>
                            <div class="ai-feature-icon">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2L6.5 11H17.5L12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6.5 11L3 17L9.5 14L12 22L14.5 14L21 17L17.5 11" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <h3 class="ai-feature-title">Assistant IA</h3>
                            <p class="ai-feature-description">Un assistant intelligent alimenté par l'IA pour vous aider dans vos discussions et vous suggérer des réponses intelligentes.</p>
                            <div class="ai-feature-coming-soon">Prochainement</div>
                        </div>
                        
                        <div class="ai-feature-card" style="background: -webkit-linear-gradient(315deg, #00C9FF, #0088FF);">
                            <div class="ai-feature-bg"></div>
                            <div class="ai-feature-icon">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <h3 class="ai-feature-title">ChatBot GPT</h3>
                            <p class="ai-feature-description">Discutez avec un assistant conversationnel basé sur GPT qui peut vous aider à rédiger des messages, traduire du texte et plus encore.</p>
                            <div class="ai-feature-coming-soon">Prochainement</div>
                        </div>
                        
                        <div class="ai-feature-card" style="background: -webkit-linear-gradient(315deg, #FF6B6B, #A34141);">
                            <div class="ai-feature-bg"></div>
                            <div class="ai-feature-icon">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M4.91 18.9C4.91 18.9 7.5 16 12 16C16.5 16 19.09 18.9 19.09 18.9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <h3 class="ai-feature-title">Avatar IA</h3>
                            <p class="ai-feature-description">Générez un avatar personnalisé à partir de votre photo ou laissez notre IA créer une image de profil unique pour vous.</p>
                            <div class="ai-feature-coming-soon">Prochainement</div>
                        </div>
                    </div>
                `;
            },
            
            // Render chat screen
            renderChatScreen() {
                if (!this.currentChat) return '';
                
                const appElement = document.getElementById('app');
                if (!appElement) return;
                
                // Get other user
                const otherUser = this.currentChat.otherUser;
                
                // Get initial from username
                const initial = this.getInitials(otherUser.username);
                
                // Format messages
                let messagesHTML = '';
                
                // Group messages by day
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                let currentDay = null;
                
                // Empty state for no messages
                if (this.messages.length === 0) {
                    messagesHTML = `
                        <div class="empty-state" style="height: 100%; padding-bottom: 80px;">
                            <div class="empty-state-icon">
                                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <h3 class="empty-state-title">Aucun message</h3>
                            <p class="empty-state-text">Envoyez un message pour commencer la conversation</p>
                        </div>
                    `;
                } else {
                    for (let i = 0; i < this.messages.length; i++) {
                        const message = this.messages[i];
                        const messageDay = new Date(message.timestamp);
                        messageDay.setHours(0, 0, 0, 0);
                        
                        // Add day separator if needed
                        if (!currentDay || currentDay.getTime() !== messageDay.getTime()) {
                            currentDay = messageDay;
                            
                            let dayText = '';
                            if (messageDay.getTime() === today.getTime()) {
                                dayText = "Aujourd'hui";
                            } else if (messageDay.getTime() === yesterday.getTime()) {
                                dayText = "Hier";
                            } else {
                                dayText = messageDay.toLocaleDateString();
                            }
                            
                            messagesHTML += `
                                <div class="message-day-separator">
                                    <span class="message-day-text">${dayText}</span>
                                </div>
                            `;
                        }
                        
                        // Determine if message is sent or received
                        const isSent = message.senderId === this.currentUser.uid;
                        
                        // Format time
                        const time = this.formatTime(new Date(message.timestamp));
                        
                        // Check if message is selected
                        const isSelected = this.selectionMode && this.selectedMessages.has(message.id);
                        
                        // Check if message is sending
                        const isSending = this.sendingMessages.has(message.id);
                        
                        // Reactions
                        let reactionsHTML = '';
                        if (message.reactions && Object.keys(message.reactions).length > 0) {
                            reactionsHTML = '<div class="message-reactions">';
                            
                            for (const emoji in message.reactions) {
                                if (message.reactions[emoji].length > 0) {
                                    reactionsHTML += `
                                        <div class="message-reaction">
                                            ${emoji} <span class="message-reaction-count">${message.reactions[emoji].length}</span>
                                        </div>
                                    `;
                                }
                            }
                            
                            reactionsHTML += '</div>';
                        }
                        
                        messagesHTML += `
                            <div class="message-group ${isSent ? 'sent' : 'received'}">
                                <div class="message-bubble ${isSelected ? 'selected' : ''} ${isSending ? 'message-sending' : ''}" 
                                    data-message-id="${message.id}">
                                    ${message.messageType === 'image' && message.image ? `
                                        <div class="message-image-container">
                                            <img class="message-image" src="${message.image}" alt="Image" loading="lazy">
                                        </div>
                                    ` : ''}
                                    ${message.text ? message.text : ''}
                                    ${reactionsHTML}
                                </div>
                                <div class="message-time">
                                    ${time}
                                    ${isSent ? `
                                        <span class="message-status">
                                            ${message.read ? `
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M18 7L9.42857 17L6 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            ` : `
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M5 12L10 17L20 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            `}
                                        </span>
                                    ` : ''}
                                    ${message.edited ? ' (modifié)' : ''}
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Batch actions bar for messages
                let batchActionsBar = '';
                if (this.selectionMode && this.selectedMessages.size > 0) {
                    batchActionsBar = `
                        <div class="batch-actions-bar">
                            <div class="batch-actions-title">${this.selectedMessages.size} message(s) sélectionné(s)</div>
                            <div style="display: flex;">
                                <button class="batch-action-button" id="delete-selected-messages">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3 6H5H21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="batch-action-button" id="cancel-selection">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // Reaction picker
                let reactionPickerHTML = '';
                if (this.reactionPickerVisible) {
                    reactionPickerHTML = `
                        <div class="reaction-picker">
                            ${this.availableEmojis.map(function(emoji) {
                                return `<div class="reaction-picker-item" data-emoji="${emoji}">${emoji}</div>`;
                            }).join('')}
                        </div>
                    `;
                }
                
                // Emoji picker
                let emojiPickerHTML = '';
                if (this.emojiPickerVisible) {
                    // Recent emojis section
                    let recentEmojisHTML = '';
                    if (this.recentEmojis.length > 0) {
                        recentEmojisHTML = `
                            <div class="emoji-category">
                                <div class="emoji-category-title">Récents</div>
                                <div class="emoji-grid">
                                    ${this.recentEmojis.map(function(emoji) {
                                        return `<div class="emoji-item" data-emoji="${emoji}">${emoji}</div>`;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Common emojis
                    const commonEmojis = [
                        '😊', '😂', '❤️', '👍', '😍', '😘', '🙏', '👌', '👏', '🔥',
                        '😁', '😎', '😉', '🤔', '🤗', '😋', '😒', '🙄', '😢', '😭',
                        '😩', '😠', '😡', '🤯', '🤢', '🤮', '😴', '😄', '😅', '😇',
                        '🙂', '🙃', '😌', '😏', '😣', '😫', '😪', '😱', '😳', '🤪',
                        '😵', '🥳', '😺', '😸', '😹', '😻', '😼', '😽', '🙀', '😿',
                        '👋', '🤚', '✋', '👐', '👇', '👈', '👉', '☝️', '🤟', '🤘',
                        '🤙', '👊', '✌️', '🤞', '🤝', '🙌', '💪', '🤳', '💅', '👂',
                        '👀', '👁️', '👅', '👄', '👶', '👦', '👧', '👨', '👩', '👴',
                        '👵', '👨‍⚕️', '👩‍⚕️', '👨‍🎓', '👩‍🎓', '👨‍⚖️', '👩‍⚖️', '👨‍🌾', '👩‍🌾', '👨‍🍳',
                        '👩‍🍳', '👨‍🔧', '👩‍🔧', '👨‍🏭', '👩‍🏭', '👨‍💼', '👩‍💼', '👨‍🔬', '👩‍🔬', '👨‍💻'
                    ];
                    
                    emojiPickerHTML = `
                        <div class="emoji-picker">
                            ${recentEmojisHTML}
                            <div class="emoji-category">
                                <div class="emoji-category-title">Populaires</div>
                                <div class="emoji-grid">
                                    ${commonEmojis.map(function(emoji) {
                                        return `<div class="emoji-item" data-emoji="${emoji}">${emoji}</div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Header with context menus
                let headerContent = `
                    <button class="back-button" id="back-to-main">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 12H5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 19L5 12L12 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="chat-title">
                        <span>${otherUser.username}</span>
                        <span class="chat-title-status">${otherUser.online ? 'En ligne' : ''}</span>
                    </div>
                    ${this.selectionMode ? `
                        <div class="message-action-buttons">
                            <button class="message-action-btn" id="cancel-selection">Annuler</button>
                        </div>
                    ` : `
                        <button class="chat-menu-button" id="chat-menu-button">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M19 13C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11C18.4477 11 18 11.4477 18 12C18 12.5523 18.4477 13 19 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M5 13C5.55228 13 6 12.5523 6 12C6 11.4477 5.55228 11 5 11C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    `}
                `;
                
                // Image preview for upload
                let imagePreviewHTML = '';
                if (this.imagePreview) {
                    imagePreviewHTML = `
                        <div class="image-preview-container" id="image-preview-container">
                            <img src="${this.imagePreview}" alt="Preview" class="image-preview">
                            <button class="image-preview-close" id="cancel-image-upload">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    `;
                }
                
                // Last seen indicator
                let lastSeenHTML = '';
                if (!otherUser.online && otherUser.lastSeen) {
                    lastSeenHTML = `
                        <div class="last-seen-indicator">
                            <span class="user-last-active">${this.formatLastSeen(otherUser.lastSeen)}</span>
                        </div>
                    `;
                }
                
                appElement.innerHTML = `
                    <div class="container">
                        <div class="chat-header">
                            ${headerContent}
                        </div>
                        
                        ${batchActionsBar}
                        
                        <div class="chat-container">
                            <div class="chat-messages">
                                ${messagesHTML}
                            </div>
                            
                            <div class="chat-input-container">
                                ${lastSeenHTML}
                                <div class="chat-input">
                                    <button class="media-button" id="select-image">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M23 19C23 19.5304 22.7893 20.0391 22.4142 20.4142C22.0391 20.7893 21.5304 21 21 21H3C2.46957 21 1.96086 20.7893 1.58579 20.4142C1.21071 20.0391 1 19.5304 1 19V8C1 7.46957 1.21071 6.96086 1.58579 6.58579C1.96086 6.21071 2.46957 6 3 6H7L9 3H15L17 6H21C21.5304 6 22.0391 6.21071 22.4142 6.58579C22.7893 6.96086 23 7.46957 23 8V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 17C14.2091 17 16 15.2091 16 13C16 10.7909 14.2091 9 12 9C9.79086 9 8 10.7909 8 13C8 15.2091 9.79086 17 12 17Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                    <input type="file" id="image-upload" class="input-file" accept="image/*">
                                    
                                    <button class="emoji-button" id="show-emoji-picker">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M8 14C8 14 9.5 16 12 16C14.5 16 16 14 16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M9 9H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M15 9H15.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                    
                                    <div class="message-input-container">
                                        ${imagePreviewHTML}
                                        <input type="text" id="message-input" class="message-input" placeholder="Écrivez un message..." ${otherUser.isBlocked ? 'disabled' : ''}>
                                    </div>
                                    
                                    <button class="send-button" id="send-message" ${otherUser.isBlocked ? 'disabled' : ''}>
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        ${emojiPickerHTML}
                        ${reactionPickerHTML}
                    </div>
                `;
                
                // Add event listeners
                document.getElementById('back-to-main').addEventListener('click', function() {
                    app.backToMain();
                });
                
                // Add event listeners for selection mode
                if (this.selectionMode) {
                    document.getElementById('cancel-selection').addEventListener('click', function() {
                        app.exitSelectionMode();
                    });
                    
                    if (this.selectedMessages.size > 0) {
                        document.getElementById('delete-selected-messages').addEventListener('click', function() {
                            app.deleteSelectedMessages();
                        });
                    }
                    
                    // Make all message bubbles selectable
                    const messageBubbles = document.querySelectorAll('.message-bubble');
                    messageBubbles.forEach(function(bubble) {
                        bubble.addEventListener('click', function() {
                            const messageId = this.getAttribute('data-message-id');
                            app.toggleMessageSelection(messageId);
                        });
                    });
                } else {
                    // Add event listener for chat menu
                    const chatMenuButton = document.getElementById('chat-menu-button');
                    if (chatMenuButton) {
                        chatMenuButton.addEventListener('click', function() {
                            app.showChatMenu();
                        });
                    }
                    
                    // Add event listener for long press on messages to enter selection mode
                    const messageBubbles = document.querySelectorAll('.message-bubble');
                    messageBubbles.forEach(function(bubble) {
                        bubble.addEventListener('contextmenu', function(e) {
                            e.preventDefault();
                            const messageId = this.getAttribute('data-message-id');
                            app.enterSelectionMode('messages');
                            app.toggleMessageSelection(messageId);
                            return false;
                        });
                        
                        // Make image clickable for full screen preview
                        const messageImage = bubble.querySelector('.message-image');
                        if (messageImage) {
                            messageImage.addEventListener('click', function(e) {
                                e.stopPropagation();
                                app.previewImage(this.src);
                            });
                        }
                        
                        // Add double tap for reactions
                        bubble.addEventListener('click', function() {
                            if (!app.selectionMode) {
                                const messageId = this.getAttribute('data-message-id');
                                app.showReactionPicker(messageId);
                            }
                        });
                    });
                    
                    // Add event listeners for emoji picker
                    const emojiButton = document.getElementById('show-emoji-picker');
                    if (emojiButton) {
                        emojiButton.addEventListener('click', function() {
                            app.showEmojiPicker();
                        });
                    }
                    
                    // Add event listeners for emoji selection
                    const emojiItems = document.querySelectorAll('.emoji-item');
                    emojiItems.forEach(function(item) {
                        item.addEventListener('click', function() {
                            const emoji = this.getAttribute('data-emoji');
                            app.addEmoji(emoji);
                        });
                    });
                    
                    // Add event listeners for reaction selection
                    const reactionItems = document.querySelectorAll('.reaction-picker-item');
                    reactionItems.forEach(function(item) {
                        item.addEventListener('click', function() {
                            const emoji = this.getAttribute('data-emoji');
                            app.addReaction(emoji);
                        });
                    });
                    
                    // Add event listener for message input
                    const messageInput = document.getElementById('message-input');
                    if (messageInput) {
                        messageInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault();
                                app.sendMessage();
                            }
                        });
                    }
                    
                    // Add event listener for send button
                    document.getElementById('send-message').addEventListener('click', function() {
                        app.sendMessage();
                    });
                    
                    // Add event listener for image selection
                    document.getElementById('select-image').addEventListener('click', function() {
                        app.selectImage();
                    });
                    
                    document.getElementById('image-upload').addEventListener('change', function(event) {
                        app.handleImageSelect(event);
                    });
                    
                    // Add event listener for cancel image upload
                    if (this.imagePreview) {
                        document.getElementById('cancel-image-upload').addEventListener('click', function() {
                            app.cancelImageUpload();
                        });
                    }
                }
                
                // Scroll to bottom after content is loaded
                setTimeout(function() {
                    app.scrollToBottom();
                }, 10);
            },
            
            // Render custom image preview
            renderCustomImagePreview() {
                if (!this.customImagePreview) return;
                
                const previewContainer = document.createElement('div');
                previewContainer.className = 'custom-image-preview';
                
                previewContainer.innerHTML = `
                    <button class="custom-image-preview-close" id="close-custom-preview">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="custom-image-preview-content">
                        <img src="${this.customImagePreview.url}" alt="Image Preview">
                    </div>
                    <div class="custom-image-preview-actions">
                        <button class="custom-image-preview-action">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="custom-image-preview-action">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 16V17C4 17.5304 4.21071 18.0391 4.58579 18.4142C4.96086 18.7893 5.46957 19 6 19H18C18.5304 19 19.0391 18.7893 19.4142 18.4142C19.7893 18.0391 20 17.5304 20 17V16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 3V15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8 7L12 3L16 7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                `;
                
                document.body.appendChild(previewContainer);
                
                // Add event listener for close button
                document.getElementById('close-custom-preview').addEventListener('click', function() {
                    app.closeCustomImagePreview();
                });
                
                // Add event listener for overlay click
                previewContainer.addEventListener('click', function(e) {
                    if (e.target === previewContainer) {
                        app.closeCustomImagePreview();
                    }
                });
            }
        };
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            app.init();
        });
    </script>
</body>
</html>
