<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Inscription avec Firestore (pas Auth)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      display: flex;
      justify-content: center;
      padding: 40px 0;
    }
    .container {
      background: white;
      padding: 30px 25px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      width: 350px;
    }
    h2 {
      margin-bottom: 25px;
      text-align: center;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #218838;
    }
    #log {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-weight: 600;
      display: none;
      white-space: pre-line;
      font-size: 14px;
    }
    #log.info {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    #log.success {
      background-color: #d4edda;
      color: #155724;
    }
    #log.error {
      background-color: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>Inscription (Firestore seulement)</h2>
    <input id="email" type="email" placeholder="Email" autocomplete="off" />
    <input id="password" type="password" placeholder="Mot de passe" autocomplete="off" />
    <button onclick="register()">Cr√©er un compte</button>

    <div id="log"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, setDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDTPLxUiA8lj82kqc6CyCPLQDITc0CtLUE",
      authDomain: "ichat-betai.firebaseapp.com",
      databaseURL: "https://ichat-betai-default-rtdb.firebaseio.com",
      projectId: "ichat-betai",
      storageBucket: "ichat-betai.appspot.com",
      messagingSenderId: "168337722600",
      appId: "1:168337722600:web:beb331f83cc4778c5b4d5d",
      measurementId: "G-STXPSZN7X8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const logDiv = document.getElementById("log");

    function showLog(text, type = "info") {
      logDiv.textContent = text;
      logDiv.className = type;
      logDiv.style.display = "block";
    }

    function validateEmail(email) {
      // simple regex email validation
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    async function register() {
      showLog("", "info"); // reset

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      let logText = "";

      if (!email) {
        showLog("Erreur : L'email est obligatoire.", "error");
        return;
      }
      if (!validateEmail(email)) {
        showLog("Erreur : L'email n'est pas valide.", "error");
        return;
      }
      if (!password) {
        showLog("Erreur : Le mot de passe est obligatoire.", "error");
        return;
      }
      if (password.length < 6) {
        showLog("Erreur : Le mot de passe doit contenir au moins 6 caract√®res.", "error");
        return;
      }

      try {
        logText += "‚úÖ Validation des donn√©es : OK\n";

        // V√©rifier si cet email existe d√©j√†
        const usersCol = collection(db, "Users");
        const q = query(usersCol);
        const usersSnapshot = await getDocs(q);
        let emailExists = false;
        usersSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.email.toLowerCase() === email.toLowerCase()) {
            emailExists = true;
          }
        });

        if (emailExists) {
          showLog("Erreur : Ce compte email existe d√©j√†.", "error");
          return;
        }
        logText += "‚úÖ Email unique confirm√©.\n";

        // V√©rifier si admin existe (premier utilisateur)
        const adminDocRef = doc(db, "Config", "admin");
        const adminDocSnap = await getDoc(adminDocRef);

        let statut = "simple";
        if (!adminDocSnap.exists()) {
          statut = "admin";
          logText += "‚ö° Aucun admin d√©tect√©. Ce compte deviendra admin.\n";
        } else {
          logText += "‚ÑπÔ∏è Admin d√©j√† existant. Ce compte sera simple utilisateur.\n";
        }

        // G√©n√©rer un nouvel ID auto Firestore (tu peux aussi utiliser email en doc id, ici on laisse auto)
        // Mais pour garder la logique avec uid en doc id, on peut faire √ßa :
        // const newUserRef = doc(usersCol); // auto ID
        // ou utiliser email comme ID s√©curis√©
        // Ici on prend l‚Äôemail comme ID simple, mais en minuscule + remplacement des caract√®res invalides
        const sanitizedEmailId = email.toLowerCase().replace(/[^a-z0-9]/g, "_");
        const userDocRef = doc(db, "Users", sanitizedEmailId);

        // Stockage du compte dans Firestore (mot de passe en clair ici)
        await setDoc(userDocRef, {
          email: email,
          password: password,
          statut: statut,
          createdAt: new Date().toISOString()
        });
        logText += "‚úÖ Donn√©es utilisateur stock√©es dans Firestore.\n";

        // Si admin, on sauvegarde son ID dans Config/admin
        if (statut === "admin") {
          await setDoc(adminDocRef, {
            email: email,
            userDocId: sanitizedEmailId,
            createdAt: new Date().toISOString()
          });
          logText += "‚úÖ Document admin cr√©√© dans Config/admin.\n";
        }

        showLog(logText + "\nüéâ Inscription r√©ussie !", "success");

        // R√©initialiser formulaire
        document.getElementById("email").value = "";
        document.getElementById("password").value = "";

      } catch (err) {
        showLog("‚ùå Erreur lors de l'inscription :\n" + err.message, "error");
      }
    }
  </script>
</body>
</html>
