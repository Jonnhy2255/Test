<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GroupChat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary-color: #5D5CDE;
            --text-color: #000000;
            --bg-color: #ffffff;
            --border-color: #dddfe2;
            --secondary-color: #f0f2f5;
            --chat-sent-bg: #5D5CDE;
            --chat-sent-text: #ffffff;
            --chat-received-bg: #f0f2f5;
            --selection-color: rgba(93, 92, 222, 0.3);
            --action-menu-bg: rgba(0, 0, 0, 0.9);
            --action-menu-text: #ffffff;
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(255, 255, 255, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.1);
            --group-icon-bg: #4CAF50;
            --danger-color: #ff4842;
            --success-color: #4caf50;
            --input-bg: #f0f2f5;
            --input-placeholder: #8e8e93;
            --button-text: #000000;
            --inactive-text: #8e8e93;
            --link-color: #007aff;
            --admin-badge-bg: #5D5CDE;
            --admin-badge-text: white;
            --log-bg: rgba(0, 0, 0, 0.8);
            --log-text: #ffffff;
            --log-info: #2196F3;
            --log-warning: #FFC107;
            --log-error: #FF5252;
            --log-success: #4CAF50;
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --event-bg: #f1f1f1;
            --event-border: #e0e0e0;
            --restricted-badge-bg: #FFC107;
            --restricted-badge-text: #000000;
            --side-menu-bg: #ffffff;
            --side-menu-active: #f0f2f5;
            --side-menu-hover: #f5f5f5;
            --log-panel-bg: #f8f9fa;
            --log-panel-border: #e0e0e0;
            --link-hover: #0056b3;
            --admin-notif-bg: #f8f9fa;
            --admin-notif-border: #e0e0e0;
            --forecast-win-bg: rgba(76, 175, 80, 0.2);
            --forecast-loss-bg: rgba(244, 67, 54, 0.2);
            --forecast-pending-bg: rgba(255, 193, 7, 0.2);
            --comment-bg: #f5f5f5;
            --comment-border: #ebebeb;
            --social-whatsapp: #25D366;
            --social-telegram: #0088cc;
            --social-youtube: #FF0000;
            --partner-google: #4285F4;
            --partner-firebase: #FFCA28;
            --partner-github: #333333;
            --partner-quora: #B92B27;
            --notification-dot: #FF4842;
            --warning-bg: rgba(255, 152, 0, 0.1);
            --warning-text: #FF9800;
            --image-message-bg: rgba(93, 92, 222, 0.1);
            --image-viewer-bg: rgba(0, 0, 0, 0.9);
            --selected-message-border: rgba(93, 92, 222, 0.7);
        }
        
        .dark {
            --bg-color: #181818;
            --text-color: #ffffff;
            --border-color: #3e4042;
            --secondary-color: #2c2c2c;
            --chat-received-bg: #2c2c2c;
            --chat-sent-bg: #5D5CDE;
            --chat-sent-text: #ffffff;
            --selection-color: rgba(93, 92, 222, 0.4);
            --action-menu-bg: rgba(60, 60, 60, 0.95);
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(40, 40, 40, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.3);
            --group-icon-bg: #388E3C;
            --danger-color: #ff6b6b;
            --success-color: #66bb6a;
            --input-bg: #2c2c2c;
            --input-placeholder: #6c6c6c;
            --link-color: #2196F3;
            --admin-badge-bg: #7571F9;
            --admin-badge-text: white;
            --log-bg: rgba(20, 20, 20, 0.9);
            --log-info: #64B5F6;
            --log-warning: #FFD54F;
            --log-error: #FF8A80;
            --log-success: #81C784;
            --overlay-bg: rgba(0, 0, 0, 0.8);
            --event-bg: #2a2a2a;
            --event-border: #3e3e3e;
            --restricted-badge-bg: #FFC107;
            --restricted-badge-text: #000000;
            --side-menu-bg: #222222;
            --side-menu-active: #333333;
            --side-menu-hover: #2a2a2a;
            --log-panel-bg: #222222;
            --log-panel-border: #3e3e3e;
            --link-hover: #64B5F6;
            --admin-notif-bg: #2a2a2a;
            --admin-notif-border: #333333;
            --forecast-win-bg: rgba(76, 175, 80, 0.15);
            --forecast-loss-bg: rgba(244, 67, 54, 0.15);
            --forecast-pending-bg: rgba(255, 193, 7, 0.15);
            --comment-bg: #2a2a2a;
            --comment-border: #333333;
            --notification-dot: #FF4842;
            --warning-bg: rgba(255, 152, 0, 0.15);
            --warning-text: #FFA726;
            --image-message-bg: rgba(93, 92, 222, 0.15);
            --image-viewer-bg: rgba(0, 0, 0, 0.95);
            --selected-message-border: rgba(93, 92, 222, 0.8);
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            overflow: hidden;
            font-weight: 500;
            letter-spacing: -0.2px;
        }
        
        .side-menu {
            position: fixed;
            top: 0;
            left: -250px;
            height: 100%;
            width: 250px;
            background-color: var(--side-menu-bg);
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        .side-menu.active {
            left: 0;
        }
        
        .side-menu-header {
            display: flex;
            align-items: center;
            padding: 20px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .side-menu-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 15px;
        }
        
        .side-menu-close {
            font-size: 20px;
            color: var(--text-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
        }
        
        .side-menu-content {
            flex: 1;
            overflow-y: auto;
        }
        
        .side-menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .side-menu-item.active {
            background-color: var(--side-menu-active);
        }
        
        .side-menu-item i {
            font-size: 20px;
            width: 30px;
            color: var(--primary-color);
        }
        
        .side-menu-text {
            margin-left: 15px;
            font-weight: 500;
        }
        
        .side-menu-footer {
            margin-top: auto;
        }
        
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .side-menu-overlay.active {
            display: block;
        }
        
        .header {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 10;
            transition: height 0.3s ease;
        }
        
        .header.search-active {
            height: 100px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .menu-button, .back-button, .search-button {
            padding: 10px;
            cursor: pointer;
            font-size: 18px;
            color: var(--primary-color);
            border-radius: 50%;
        }
        
        .header-title {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary-color);
            border-bottom: none;
            text-decoration: none;
        }
        
        .events-button {
            color: var(--primary-color);
            padding: 10px;
            cursor: pointer;
            font-size: 18px;
            position: relative;
            border-radius: 50%;
        }
        
        .notification-dot {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background-color: var(--notification-dot);
            border-radius: 50%;
            display: none;
        }
        
        .notification-dot.active {
            display: block;
        }
        
        .content {
            position: fixed;
            top: 50px;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background-color: var(--bg-color);
        }
        
        .bottom-nav {
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            z-index: 10;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: var(--inactive-text);
            font-size: 10px;
            cursor: pointer;
            height: 100%;
            padding: 8px 0;
            position: relative;
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }
        
        .section {
            padding: 10px 0;
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .profile-pic {
            width: 50px;
            height: 50px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .profile-pic-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
        }
        
        .profile-pic-edit:hover, .profile-pic-edit:active {
            transform: scale(1.1);
        }
        
        .group-pic {
            width: 50px;
            height: 50px;
            background-color: var(--group-icon-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .group-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .group-pic-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
            z-index: 2;
        }
        
        .group-pic-edit:hover, .group-pic-edit:active {
            transform: scale(1.1);
        }
        
        .chat-item, .user-item, .event-item {
            display: flex;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.3s ease, opacity 0.4s ease;
        }
        
        .chat-item.selected, .user-item.selected {
            background-color: var(--selection-color);
        }
        
        .item-content {
            flex: 1;
        }
        
        .item-title {
            font-weight: bold;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }
        
        .item-subtitle {
            color: #6b7280;
            font-size: 14px;
        }
        
        .item-time {
            color: #6b7280;
            font-size: 12px;
        }
        
        .admin-badge {
            display: inline-block;
            background-color: var(--admin-badge-bg);
            color: var(--admin-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .restricted-badge {
            display: inline-block;
            background-color: var(--restricted-badge-bg);
            color: var(--restricted-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .search-container {
            padding: 10px 15px;
            background-color: var(--bg-color);
            position: relative;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            display: flex;
            align-items: center;
        }
        
        .search-container.active {
            max-height: 50px;
            opacity: 1;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 16px;
            border-radius: 18px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            color: var(--text-color);
            outline: none;
        }
        
        .search-close {
            padding: 8px;
            margin-left: 8px;
            color: var(--primary-color);
            cursor: pointer;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        
        .loading-spinner {
            font-size: 60px;
            color: var(--primary-color);
            animation: pulse 2s infinite, bounce 1.5s infinite;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }
        
        .settings-container {
            padding: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .setting-icon {
            width: 36px;
            height: 36px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .setting-label {
            font-weight: 500;
        }
        
        .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            transition: transform 0.15s ease, opacity 0.2s ease, background-color 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .button:hover {
            background-color: #4a49c0;
        }

        .button:disabled {
            background-color: var(--border-color);
            color: var(--inactive-text);
            cursor: not-allowed;
        }
        
        .button.danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .button.danger:hover {
            background-color: #e53935;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        .chat-section {
            display: none;
            position: fixed;
            top: 50px;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            z-index: 5;
        }
        
        .chat-messages-container {
            position: absolute;
            top: 0;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow-y: auto;
            background-color: var(--secondary-color);
            -webkit-overflow-scrolling: touch;
            padding: 15px;
        }
        
        .chat-messages {
            width: 100%;
            display: flex;
            flex-direction: column;
            min-height: 100%;
            justify-content: flex-end;
        }
        
        .chat-input-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            padding: 10px;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            align-items: center;
            height: 60px;
        }
        
        .message-container {
            margin-bottom: 16px;
            clear: both;
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }
        
        .message-container.sent {
            float: right;
            margin-left: auto;
            align-items: flex-end;
        }
        
        .message-container.received {
            float: left;
            margin-right: auto;
            align-items: flex-start;
        }
        
        .message-sender {
            font-size: 12px;
            margin-bottom: 2px;
            font-weight: bold;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .message {
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            transition: background-color 0.2s ease, transform 0.3s ease;
            transform: translateX(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-weight: 500;
        }
        
        .message-received {
            background-color: var(--chat-received-bg);
            border-bottom-left-radius: 4px;
        }
        
        .message-sent {
            background-color: var(--chat-sent-bg);
            color: var(--chat-sent-text);
            border-bottom-right-radius: 4px;
        }

        /* Amélioration du marquage visuel des messages sélectionnés */
        .message.selected {
            box-shadow: 0 0 0 2px var(--selected-message-border);
        }
        
        .message-time {
            font-size: 10px;
            margin-top: 2px;
            opacity: 0.7;
        }
        
        .chat-input-wrapper {
            flex: 1;
            margin: 0 10px;
            height: 40px;
            position: relative;
        }
        
        .chat-input {
            width: 100%;
            height: 100%;
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            color: var(--text-color);
            font-weight: 500;
            outline: none;
        }
        
        .send-button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: transform 0.15s ease, background-color 0.2s ease;
        }
        
        .send-button:active {
            transform: scale(0.9);
        }
        
        .send-button:hover {
            background-color: #4a49c0;
        }

        .send-button:disabled {
            background-color: var(--border-color);
            color: var(--inactive-text);
            cursor: not-allowed;
        }
        
        .image-button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            transition: transform 0.15s ease, background-color 0.2s ease;
        }
        
        .image-button:active {
            transform: scale(0.9);
        }

        .image-button:disabled {
            color: var(--inactive-text);
            cursor: not-allowed;
        }
        
        .profile-header {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .profile-header .profile-pic {
            width: 80px;
            height: 80px;
            margin-right: 20px;
        }
        
        .profile-header .profile-pic i {
            font-size: 30px;
            color: var(--primary-color);
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .profile-email {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .profile-status {
            color: #6b7280;
        }
        
        .profile-edit {
            color: var(--primary-color);
            font-size: 14px;
            margin-top: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 8px;
            border-radius: 15px;
        }
        
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .auth-header {
            padding: 40px 0 20px;
            text-align: center;
        }
        
        .auth-logo {
            font-size: 50px;
            color: var(--primary-color);
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .auth-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .auth-subtitle {
            font-size: 16px;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 20px;
            padding: 0 20px;
            text-align: center;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            color: var(--inactive-text);
            transition: color 0.3s, background-color 0.2s ease;
            text-decoration: none;
            border-bottom: none;
        }
        
        .auth-tab.active {
            color: var(--primary-color);
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 25%;
            width: 50%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }
        
        .auth-form {
            padding: 20px;
            display: none;
            animation: fadeUp 0.5s ease;
        }
        
        @keyframes fadeUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            font-size: 16px;
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }
        
        .form-input::placeholder {
            color: var(--input-placeholder);
        }
        
        .form-error {
            color: var(--danger-color);
            font-size: 13px;
            margin-top: 6px;
            display: none;
            animation: shakeX 0.75s ease;
        }
        
        @keyframes shakeX {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        
        .form-footer {
            margin-top: 30px;
            text-align: center;
        }
        
        .form-footer-text {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .form-link {
            color: var(--link-color);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }
        
        .form-link:hover {
            text-decoration: underline;
        }

        .log-message {
            margin-top: 15px;
            padding: 12px;
            font-weight: bold;
            border-radius: 6px;
            white-space: pre-line;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
          
        .log-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }
          
        .log-message.success {
            background: #d4edda;
            color: #155724;
        }
          
        .log-message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--inactive-text);
        }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .btn-loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .button.loading {
            pointer-events: none;
            opacity: 0.8;
        }
        
        .button.loading .btn-text {
            visibility: hidden;
        }
        
        .button.loading .btn-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -10px;
            margin-left: -10px;
            visibility: visible;
        }
        
        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-width: 90%;
            text-align: center;
            line-height: 1.4;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .notification.success {
            background-color: var(--bg-color);
            color: var(--success-color);
        }

        .notification.error {
            background-color: var(--bg-color);
            color: var(--danger-color);
        }

        .notification.info {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }
        
        .verify-animation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .football-bounce {
            font-size: 80px;
            color: var(--primary-color);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-40px); }
            60% { transform: translateY(-20px); }
        }

        .verify-text {
            margin-top: 30px;
            font-size: 16px;
            color: var(--text-color);
            opacity: 0.8;
            text-align: center;
        }
        
        .message-context-menu {
            position: absolute;
            background-color: var(--bg-color);
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            overflow: hidden;
            width: 160px;
            animation: scaleIn 0.15s ease;
            transform-origin: top left;
        }
        
        @keyframes scaleIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .context-menu-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .context-menu-icon {
            margin-right: 10px;
            font-size: 14px;
            width: 20px;
            color: var(--primary-color);
        }
        
        .context-menu-text {
            font-size: 14px;
        }
        
        .context-menu-item.delete .context-menu-icon {
            color: var(--danger-color);
        }
        
        @keyframes deleteMessage {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            20% {
                opacity: 0.8;
                transform: scale(0.95);
            }
            100% {
                opacity: 0;
                transform: scale(0.5);
                height: 0;
                margin: 0;
                padding: 0;
            }
        }
        
        .message.deleting {
            animation: deleteMessage 0.3s ease forwards;
            pointer-events: none;
        }
        
        .create-group-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 100;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .create-group-dialog.active {
            display: flex;
        }
        
        .create-group-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .create-group-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .create-group-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .create-group-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .group-form {
            display: flex;
            flex-direction: column;
        }
        
        .edit-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .edit-dialog.active {
            display: flex;
        }
        
        .edit-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .edit-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .edit-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .edit-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .group-image-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--group-icon-bg);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .group-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .group-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
        }
        
        .group-image-preview:hover .group-image-overlay {
            opacity: 1;
        }
        
        .group-image-overlay i {
            color: white;
            font-size: 20px;
        }
        
        .image-upload-btn {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px dashed var(--border-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 50;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .fab:hover {
            background-color: #4a49c0;
        }

        .fab.disabled {
            background-color: var(--border-color);
            color: var(--inactive-text);
            cursor: not-allowed;
            box-shadow: none;
        }

        .fab.disabled:active {
            transform: none;
        }
        
        .fab i {
            font-size: 24px;
        }
        
        .confirmation-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 85%;
            max-width: 300px;
            padding: 20px;
            z-index: 150;
            display: none;
        }
        
        .confirmation-dialog.active {
            display: block;
        }
        
        .confirmation-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .confirmation-text {
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
        }
        
        .confirmation-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .confirmation-button {
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            min-width: 100px;
            text-align: center;
        }
        
        .confirmation-cancel {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        
        .confirmation-confirm {
            background-color: var(--primary-color);
            color: white;
        }
        
        .confirmation-delete {
            background-color: var(--danger-color);
            color: white;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 90;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }

        .event-icon {
            width: 50px;
            height: 50px;
            background-color: var(--event-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            border: 1px solid var(--event-border);
        }
        
        .event-icon i {
            font-size: 22px;
            color: var(--primary-color);
        }

        .event-item {
            transition: none;
            cursor: default;
            position: relative;
        }

        .event-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .event-content {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }

        .event-time {
            font-size: 12px;
            color: var(--inactive-text);
            margin-top: 5px;
        }
        
        .admin-count-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            margin-left: 6px;
        }

        .event-item.group-create .event-icon {
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        .event-item.group-create .event-icon i {
            color: var(--success-color);
        }
        
        .event-item.permission-change .event-icon {
            background-color: rgba(255, 193, 7, 0.2);
        }
        
        .event-item.permission-change .event-icon i {
            color: var(--restricted-badge-bg);
        }
        
        .event-item.user-join .event-icon {
            background-color: rgba(33, 150, 243, 0.2);
        }
        
        .event-item.user-join .event-icon i {
            color: var(--log-info);
        }

        .restricted-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background-color: rgba(255, 193, 7, 0.1);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-color);
        }
        
        .profile-edit-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .profile-edit-dialog.active {
            display: flex;
        }
        
        .profile-image-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .profile-image-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }
        
        .profile-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .profile-image-preview i {
            font-size: 50px;
            color: var(--primary-color);
        }
        
        .profile-upload-btn {
            position: absolute;
            bottom: 10px;
            right: calc(50% - 60px);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .profile-upload-btn:hover, .profile-upload-btn:active {
            transform: scale(1.1);
            background-color: #4a49c0;
        }

        input[type="file"] {
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .section-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            text-decoration: none;
            border-bottom: none;
            padding: 0 16px; 
            margin: 15px 0;
        }
        
        .field-error {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        .save-field-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-left: 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .save-field-btn:hover {
            background-color: #4a49c0;
        }
        
        .save-field-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        
        .editable-field {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .editable-field-input {
            flex: 1;
        }
        
        .forecasts-section {
            padding: 0 0 15px 0;
        }
        
        .forecasts-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
            background-color: var(--bg-color);
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        .forecast-tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            color: var(--inactive-text);
            transition: color 0.3s, background-color 0.2s ease;
        }
        
        .forecast-tab.active {
            color: var(--primary-color);
        }
        
        .forecast-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 20%;
            width: 60%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
            animation: slideIn 0.3s ease;
        }
        
        .forecasts-content {
            display: none;
            padding: 0 15px;
        }
        
        .forecasts-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .forecasts-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .forecast-item {
            background-color: var(--secondary-color);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .forecast-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .forecast-match {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .forecast-team {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            flex: 1;
        }
        
        .forecast-team-logo {
            width: 40px;
            height: 40px;
            background-color: var(--bg-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }
        
        .forecast-team-name {
            font-weight: 500;
            text-align: center;
            font-size: 14px;
        }
        
        .forecast-score {
            font-size: 22px;
            font-weight: bold;
            padding: 0 15px;
            display: flex;
            align-items: center;
        }
        
        .forecast-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .forecast-status.pending {
            background-color: var(--forecast-pending-bg);
            color: var(--text-color);
        }
        
        .forecast-status.win {
            background-color: var(--forecast-win-bg);
            color: var(--text-color);
        }
        
        .forecast-status.loss {
            background-color: var(--forecast-loss-bg);
            color: var(--text-color);
        }
        
        .forecast-date {
            font-size: 12px;
            color: var(--inactive-text);
        }
        
        .forecast-confidence {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-color);
        }
        
        .confidence-bar-container {
            flex: 1;
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            margin: 0 10px;
            overflow: hidden;
        }
        
        .confidence-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
        }
        
        .no-forecasts {
            text-align: center;
            padding: 30px 15px;
            color: var(--inactive-text);
        }
        
        .no-forecasts i {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--primary-color);
            opacity: 0.5;
        }

        .admin-notification {
            background-color: var(--bg-color);
            border-radius: 15px;
            margin: 10px 15px 20px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .admin-notification-header {
            color: var(--text-color);
            padding: 0 0 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        .admin-notification-title {
            display: flex;
            align-items: center;
        }
        
        .admin-notification-title i {
            margin-right: 8px;
            color: var(--primary-color);
        }
        
        .admin-notification-content {
            padding: 5px 0;
            line-height: 1.4;
        }
        
        .admin-notification-footer {
            padding: 5px 0 0;
            font-size: 12px;
            color: var(--inactive-text);
            text-align: right;
            border-top: 1px solid var(--border-color);
            margin-top: 10px;
            padding-top: 8px;
        }
        
        .event-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .event-close-btn:hover, .event-close-btn:active {
            transform: scale(1.1);
        }
        
        .event-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 5px;
        }
        
        .event-action-btn {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: transform 0.1s ease;
        }
        
        .event-action-btn:hover, .event-action-btn:active {
            transform: translateY(-1px);
        }
        
        .event-action-btn.delete {
            color: var(--danger-color);
        }
        
        .admin-notif-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .admin-notif-dialog.active {
            display: flex;
        }
        
        .score-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .score-option {
            padding: 5px 12px;
            border-radius: 15px;
            background-color: var(--bg-color);
            font-weight: bold;
            font-size: 14px;
            border: 1px solid var(--border-color);
            transition: transform 0.1s ease;
            cursor: pointer;
        }
        
        .score-option:hover, .score-option:active {
            transform: translateY(-1px);
        }

        .score-option.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        #delete-account-confirmation .confirmation-text {
            color: var(--danger-color);
            font-weight: bold;
        }

        .social-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 0 15px;
            gap: 10px;
        }
        
        .social-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 10px;
            border-radius: 10px;
            background-color: var(--secondary-color);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .social-button:active {
            transform: scale(0.98);
        }
        
        .social-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .social-button.whatsapp {
            color: var(--social-whatsapp);
        }
        
        .social-button.telegram {
            color: var(--social-telegram);
        }
        
        .social-button.youtube {
            color: var(--social-youtube);
        }

        .about-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .about-dialog.active {
            display: flex;
        }
        
        .about-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .about-logo {
            text-align: center;
            margin: 20px 0;
        }
        
        .about-logo i {
            font-size: 60px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .about-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .about-version {
            text-align: center;
            font-size: 14px;
            color: var(--inactive-text);
            margin-bottom: 30px;
        }
        
        .about-section {
            margin-bottom: 25px;
        }
        
        .about-section-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .about-section-content {
            line-height: 1.5;
            font-size: 14px;
        }
        
        .about-footer {
            text-align: center;
            padding: 20px 0;
            font-size: 12px;
            color: var(--inactive-text);
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }
        
        @media (max-height: 640px) {
            .fab {
                bottom: 70px;
            }
        }
        
        @media (max-width: 380px) {
            .confirmation-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .confirmation-button {
                width: 100%;
            }
        }
        
        .message-with-image {
            padding: 5px;
            border-radius: 18px;
            background-color: var(--image-message-bg);
            max-width: 100%;
        }
        
        .message-image {
            width: 100%;
            border-radius: 13px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
            pointer-events: none;
        }
        
        .message-image:hover {
            transform: scale(0.98);
        }
        
        .message-text {
            padding: 0 10px 5px;
            word-break: break-word;
        }
        
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--image-viewer-bg);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .image-viewer.active {
            display: flex;
        }
        
        .viewer-image-container {
            position: relative;
            max-width: 90%;
            max-height: 80vh;
            margin: 0 auto;
        }
        
        .viewer-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 5px;
            object-fit: contain;
            pointer-events: none;
        }
        
        .viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .viewer-close:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .terms-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .terms-dialog.active {
            display: flex;
        }
        
        .terms-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .terms-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .terms-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .terms-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .warning-box {
            background-color: var(--warning-bg);
            border-left: 4px solid var(--warning-text);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: 500;
        }
        
        .warning-box i {
            color: var(--warning-text);
            margin-right: 10px;
        }
    
#header-action {
    display: flex;
    align-items: center;
    gap: 8px;
}
.search-button {
    display: flex;
    align-items: center;
    justify-content: center;
}

</style>
</head>
<body>
    <div id="verify-animation" class="verify-animation">
        <div class="football-bounce">
            <i class="fas fa-futbol"></i>
        </div>
        <div class="verify-text">Vérification en cours...</div>
    </div>
    
    <div class="side-menu" id="side-menu">
        <div class="side-menu-header">
            <div class="side-menu-close" id="side-menu-close">
                <i class="fas fa-times"></i>
            </div>
            <div class="side-menu-title">GroupChat</div>
        </div>
        <div class="side-menu-content">
            <div class="side-menu-item" id="menu-profile">
                <i class="fas fa-user"></i>
                <div class="side-menu-text">Profil</div>
            </div>
        </div>
        <div class="side-menu-footer">
            <div class="side-menu-item" id="menu-terms">
                <i class="fas fa-file-alt"></i>
                <div class="side-menu-text">Conditions d'utilisation</div>
            </div>
            <div class="side-menu-item" id="menu-about">
                <i class="fas fa-info-circle"></i>
                <div class="side-menu-text">À propos</div>
            </div>
        </div>
    </div>
    
    <div class="side-menu-overlay" id="side-menu-overlay"></div>
    
    <div id="auth-screen" class="auth-screen" style="display: none;">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fas fa-futbol"></i>
            </div>
            <h1 class="auth-title">GroupChat</h1>
            <p class="auth-subtitle">Messagerie de groupe sécurisée</p>
        </div>
        
        <div class="auth-tabs">
            <div class="auth-tab active" id="login-tab">Connexion</div>
            <div class="auth-tab" id="register-tab">Inscription</div>
        </div>
        
        <div id="login-form" class="auth-form active">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="login-email" placeholder="Votre email">
                <div id="login-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="login-password" placeholder="Votre mot de passe">
                <div id="login-password-error" class="form-error">Le mot de passe est obligatoire</div>
            </div>
            
            <div id="login-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="loginBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Se connecter</span>
                </button>
                <p class="form-footer-text">
                    Vous n'avez pas de compte ? <a href="#" class="form-link" id="goto-register">S'inscrire</a>
                </p>
            </div>
        </div>
        
        <div id="register-form" class="auth-form">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="register-email" placeholder="Votre adresse email">
                <div id="register-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="register-password" placeholder="Créez un mot de passe sécurisé">
                <div id="register-password-error" class="form-error">Le mot de passe doit contenir au moins 6 caractères</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Confirmer le mot de passe</label>
                <input type="password" class="form-input" id="register-confirm-password" placeholder="Confirmez votre mot de passe">
                <div id="register-confirm-password-error" class="form-error">Les mots de passe ne correspondent pas</div>
            </div>
            
            <div id="register-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="registerBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">S'inscrire</span>
                </button>
                <p class="form-footer-text">
                    Vous avez déjà un compte ? <a href="#" class="form-link" id="goto-login">Se connecter</a>
                </p>
            </div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <i class="fas fa-futbol loading-spinner"></i>
        <div style="font-weight: bold; font-size: 24px; color: var(--primary-color);">GroupChat</div>
        <div style="margin-top: 10px; color: #6b7280;">Chargement...</div>
    </div>

    <div class="header">
        <div class="header-left">
            <div id="header-menu-button" class="menu-button">
                <i class="fas fa-bars"></i>
            </div>
<div id="header-action">
            <div class="search-button" id="search-button">
                <i class="fas fa-search"></i>
            </div>
            
            <div id="header-back-button" class="back-button" style="display:none;">
                <i class="fas fa-chevron-left"></i>
            </div>
        </div>
        <div id="header-title" class="header-title">Groupes</div>
        <div class="events-button" id="events-button">
                <i class="fas fa-bell"></i>
                <div class="notification-dot" id="events-notification-dot"></div>
            </div>
        </div>
        
        <div class="search-container" id="search-container">
            <input type="text" class="search-input" id="search-input" placeholder="Rechercher...">
            <div class="search-close" id="search-close">
                <i class="fas fa-times"></i>
            </div>
        </div>
    </div>

    <div class="content">
        <div id="groups-section" class="section active">
            <div class="chat-list" id="groups-list">
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <div class="empty-state-title">Aucun groupe</div>
                    <div class="empty-state-text">Vos groupes apparaîtront ici</div>
                </div>
            </div>
            
            <div class="fab" id="create-group-btn">
                <i class="fas fa-plus"></i>
            </div>
        </div>
        
        <div id="events-section" class="section">
            <div id="events-list">
                <div class="empty-state">
                    <i class="fas fa-bell"></i>
                    <div class="empty-state-title">Aucun événement</div>
                    <div class="empty-state-text">Les événements apparaîtront ici</div>
                </div>
            </div>
            
            <div class="fab" id="close-events-btn" style="background-color: #f44336;">
                <i class="fas fa-arrow-left"></i>
            </div>
            
            <div class="fab" id="create-notification-btn" style="display: none; bottom: 150px;">
                <i class="fas fa-bullhorn"></i>
            </div>
        </div>
        
        <div id="profile-section" class="section">
            <div class="profile-header">
                <div class="profile-pic">
                    <i class="fas fa-user"></i>
                    <div class="profile-pic-edit" id="edit-profile-pic">
                        <i class="fas fa-pencil-alt"></i>
                    </div>
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="profile-name">
                        <span id="profile-name-text">Utilisateur</span>
                        <span class="admin-badge" id="admin-badge" style="display: none;">Admin</span>
                    </div>
                    <div class="profile-email" id="profile-email">user@example.com</div>
                    <div class="profile-status">En ligne</div>
                    <div class="profile-edit" id="edit-profile-btn">
                        <i class="fas fa-edit"></i> Modifier le profil
                    </div>
                </div>
            </div>
            
            <div class="section-title">Paramètres</div>
            
            <div class="settings-container">
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-moon" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Mode sombre</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="dark-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="section-title">Nous rejoindre</div>
                
                <div class="social-buttons">
                    <div class="social-button whatsapp" id="whatsapp-btn">
                        WhatsApp
                    </div>
                    <div class="social-button telegram" id="telegram-btn">
                        Telegram
                    </div>
                    <div class="social-button youtube" id="youtube-btn">
                        YouTube
                    </div>
                </div>
                
                <button id="logout-btn" class="button">Se déconnecter</button>
                <button id="delete-account-btn" class="button danger" style="margin-top: 15px;">Supprimer mon compte</button>
            </div>
        </div>
        
        <div id="forecasts-section" class="section">
            <div class="forecasts-tabs">
                <div class="forecast-tab active" data-tab="safes">Safes du jour</div>
                <div class="forecast-tab" data-tab="exact">Scores exacts</div>
                <div class="forecast-tab" data-tab="ai">Prédictions IA</div>
            </div>
            
            <div class="forecasts-content active" id="safes-content">
                <div class="forecasts-list" id="safes-list">
                </div>
            </div>
            
            <div class="forecasts-content" id="exact-content">
                <div class="forecasts-list" id="exact-list">
                </div>
            </div>
            
            <div class="forecasts-content" id="ai-content">
                <div class="forecasts-list" id="ai-list">
                </div>
            </div>
        </div>
    </div>

    <div id="chat-interface" class="chat-section">
        <div class="chat-messages-container">
            <div class="chat-messages" id="chat-messages">
            </div>
        </div>
        <div class="chat-input-container" id="chat-input-container">
            <div class="image-button" id="image-button">
                <i class="fas fa-image"></i>
            </div>
            <div class="chat-input-wrapper">
                <input type="text" id="chat-input" class="chat-input" placeholder="Écrire un message..." autocomplete="off">
            </div>
            <div class="send-button" id="send-button">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>
        <input type="file" id="chat-image-input" accept="image/*">
    </div>
    
    <div id="message-context-menu" class="message-context-menu" style="display: none;">
        <div class="context-menu-item reply">
            <div class="context-menu-icon"><i class="fas fa-reply"></i></div>
            <div class="context-menu-text">Répondre</div>
        </div>
        <div class="context-menu-item copy">
            <div class="context-menu-icon"><i class="fas fa-copy"></i></div>
            <div class="context-menu-text">Copier</div>
        </div>
        <div class="context-menu-item delete">
            <div class="context-menu-icon"><i class="fas fa-trash"></i></div>
            <div class="context-menu-text">Supprimer</div>
        </div>
    </div>
    
    <div id="create-group-dialog" class="create-group-dialog">
        <div class="create-group-header">
            <div class="create-group-back" id="create-group-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="create-group-title">Nouveau groupe</div>
        </div>
        <div class="create-group-content">
            <div class="group-form">
                <div class="group-image-preview" id="new-group-image-preview">
                    <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                    <div class="group-image-overlay" id="new-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <input type="file" id="new-group-image-input" accept="image/*">
                
                <div class="form-group">
                    <label class="form-label">Nom du groupe</label>
                    <input type="text" class="form-input" id="group-name" placeholder="Entrez le nom du groupe">
                    <div id="group-name-error" class="form-error">Le nom du groupe est requis</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optionnelle)</label>
                    <input type="text" class="form-input" id="group-description" placeholder="Décrivez le groupe">
                </div>
                <div class="form-group">
                    <label class="form-label">Permissions de message</label>
                    <div style="display: flex; align-items: center; margin-top: 8px;">
                        <label class="switch">
                            <input type="checkbox" id="group-public-messages" checked>
                            <span class="slider"></span>
                        </label>
                        <span style="margin-left: 10px; font-size: 14px;">Permettre à tous les membres d'écrire</span>
                    </div>
                    <div style="font-size: 12px; color: var(--inactive-text); margin-top: 5px; margin-left: 60px;">
                        Si désactivé, seuls les administrateurs pourront écrire des messages
                    </div>
                </div>
                <button class="button" id="create-group-submit">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Créer le groupe</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="edit-group-dialog" class="edit-dialog">
        <div class="edit-header">
            <div class="edit-back" id="edit-group-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">Modifier le groupe</div>
        </div>
        <div class="edit-content">
            <div class="group-image-preview" id="edit-group-image-preview">
                <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                <div class="group-image-overlay" id="edit-group-image-upload">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
            <input type="file" id="edit-group-image-input" accept="image/*">
            
            <div class="form-group">
                <label class="form-label">Nom du groupe</label>
                <div class="editable-field">
                    <input type="text" class="form-input editable-field-input" id="edit-group-name" placeholder="Entrez le nom du groupe">
                    <button class="save-field-btn" id="save-group-name-btn">Enregistrer</button>
                </div>
                <div id="edit-group-name-error" class="field-error">Le nom du groupe est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <div class="editable-field">
                    <input type="text" class="form-input editable-field-input" id="edit-group-description" placeholder="Décrivez le groupe">
                    <button class="save-field-btn" id="save-group-description-btn">Enregistrer</button>
                </div>
                <div id="edit-group-description-error" class="field-error"></div>
            </div>
            
            <div class="form-group" id="edit-group-permissions-container">
                <label class="form-label">Permissions de message</label>
                <div style="display: flex; align-items: center; margin-top: 8px;">
                    <label class="switch">
                        <input type="checkbox" id="edit-group-public-messages">
                        <span class="slider"></span>
                    </label>
                    <span style="margin-left: 10px; font-size: 14px;">Permettre à tous les membres d'écrire</span>
                    <button class="save-field-btn" id="save-group-permissions-btn" style="margin-left: auto;">Enregistrer</button>
                </div>
                <div style="font-size: 12px; color: var(--inactive-text); margin-top: 5px; margin-left: 60px;">
                    Si désactivé, seuls les administrateurs pourront écrire des messages
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Image du groupe</label>
                <button class="button" id="save-group-image-btn" style="margin-top: 10px;">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Enregistrer l'image</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="admin-notif-dialog" class="admin-notif-dialog">
        <div class="edit-header">
            <div class="edit-back" id="admin-notif-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">Nouvelle notification</div>
        </div>
        <div class="edit-content">
            <div class="form-group">
                <label class="form-label">Titre de la notification</label>
                <input type="text" class="form-input" id="notif-title" placeholder="Titre de votre notification">
                <div id="notif-title-error" class="field-error">Le titre est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Contenu</label>
                <textarea class="form-input" id="notif-content" placeholder="Contenu de votre notification" rows="5" style="resize: none;"></textarea>
                <div id="notif-content-error" class="field-error">Le contenu est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Type de notification</label>
                <select class="form-input" id="notif-type">
                    <option value="info">Information</option>
                    <option value="alert">Alerte</option>
                    <option value="update">Mise à jour</option>
                </select>
            </div>
            
            <button class="button" id="send-notification-btn">
                <span class="btn-loader" style="display:none;"></span>
                <span class="btn-text">Envoyer la notification</span>
            </button>
        </div>
    </div>
    
    <div id="profile-edit-dialog" class="profile-edit-dialog">
        <div class="edit-header">
            <div class="edit-back" id="profile-edit-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">Modifier le profil</div>
        </div>
        <div class="edit-content">
            <div class="profile-image-upload">
                <div class="profile-image-preview" id="profile-image-preview">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-upload-btn" id="profile-upload-btn">
                    <i class="fas fa-camera"></i>
                </div>
                <input type="file" id="profile-image-input" accept="image/*">
            </div>
            
            <div class="form-group">
                <label class="form-label">Nom d'utilisateur</label>
                <div class="editable-field">
                    <input type="text" class="form-input editable-field-input" id="edit-display-name" placeholder="Entrez votre nom d'utilisateur">
                    <button class="save-field-btn" id="save-display-name-btn">Enregistrer</button>
                </div>
                <div id="edit-display-name-error" class="field-error">Le nom d'utilisateur est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Photo de profil</label>
                <button class="button" id="save-profile-image-btn" style="margin-top: 10px;">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Enregistrer la photo</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="about-dialog" class="about-dialog">
        <div class="edit-header">
            <div class="edit-back" id="about-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">À propos</div>
        </div>
        <div class="about-content">
            <div class="about-logo">
                <i class="fas fa-futbol"></i>
                <div class="about-title">GroupChat</div>
                <div class="about-version">Version 1.1.0</div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Description</div>
                <div class="about-section-content">
                    GroupChat est une application de messagerie sécurisée qui permet aux utilisateurs de créer et de participer à des discussions de groupe.
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Fonctionnalités</div>
                <div class="about-section-content">
                    • Messagerie de groupe en temps réel<br>
                    • Partage de pronostics sportifs<br>
                    • Mode sombre personnalisable<br>
                    • Gestion simple des groupes<br>
                    • Envoi de notifications pour les administrateurs
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">À propos de l'application</div>
                <div class="about-section-content">
                    Le logo de l'application est le ballon de football visible sur la page de chargement. L'application a été créée par Pronosoft AI.
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Confidentialité</div>
                <div class="about-section-content">
                    GroupChat respecte votre vie privée. Vos données personnelles ne sont utilisées que pour le fonctionnement de l'application et ne sont jamais partagées avec des tiers.
                </div>
            </div>
            
            <div class="about-footer">
                © 2023-2024 GroupChat. Tous droits réservés.
            </div>
        </div>
    </div>
    
    <div id="terms-dialog" class="terms-dialog">
        <div class="terms-header">
            <div class="terms-back" id="terms-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="terms-title">Conditions d'utilisation</div>
        </div>
        <div class="terms-content">
            <div class="about-section">
                <div class="about-section-title">Conditions générales</div>
                <div class="about-section-content">
                    En utilisant l'application GroupChat, vous acceptez de respecter les présentes conditions d'utilisation. L'accès et l'utilisation de cette application sont soumis à votre acceptation et au respect des présentes conditions.
                </div>
            </div>
            
            <div class="warning-box">
                <i class="fas fa-exclamation-triangle"></i> <strong>AVERTISSEMENT :</strong> Les pronostics sont fournis à titre informatif uniquement. La vente ou revente de ces pronostics est strictement interdite et passible de bannissement à vie et de poursuites judiciaires.
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Utilisation des pronostics</div>
                <div class="about-section-content">
                    Les pronostics sportifs fournis dans cette application sont destinés uniquement à des fins d'information et de divertissement. Ils peuvent être utilisés pour effectuer des paris réels, mais il est recommandé de le faire avec responsabilité.<br><br>
                    
                    Nous ne sommes pas responsables de leurs pertes éventuelles. Les pronostics ne constituent en aucun cas une incitation au jeu ou un conseil d'investissement.<br><br>
                    
                    Il est strictement interdit de:<br>
                    • Revendre ou commercialiser ces pronostics<br>
                    • Partager ces informations en dehors de la plateforme<br>
                    • Utiliser ces informations à des fins commerciales<br><br>
                    
                    Tout utilisateur enfreignant ces règles s'expose à une suspension immédiate de son compte et à d'éventuelles poursuites judiciaires.
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Utilisation de l'application</div>
                <div class="about-section-content">
                    Vous vous engagez à utiliser l'application de manière légale et responsable. Il est interdit de:<br>
                    • Publier du contenu illégal, diffamatoire, harcelant ou menaçant<br>
                    • Usurper l'identité d'une autre personne<br>
                    • Tenter d'accéder sans autorisation à des parties de l'application qui vous sont interdites<br>
                    • Perturber le fonctionnement normal de l'application<br>
                    • Publier des messages à caractère commercial non sollicités
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Responsabilité</div>
                <div class="about-section-content">
                    GroupChat n'est pas responsable des pertes financières ou autres dommages qui pourraient résulter de l'utilisation des pronostics ou des informations disponibles sur l'application. Les utilisateurs sont seuls responsables de leurs décisions et de leurs actions.
                </div>
            </div>
        </div>
    </div>
    
    <div id="delete-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer ce message ?</div>
        <div class="confirmation-text">Cette action est irréversible et le message sera supprimé pour tout le monde.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-cancel">Annuler</div>
            <div class="confirmation-button confirmation-delete" id="delete-confirm">Supprimer</div>
        </div>
    </div>
    
    <div id="delete-event-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer cet événement ?</div>
        <div class="confirmation-text">Cette action est irréversible et l'événement sera supprimé.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-event-cancel">Annuler</div>
            <div class="confirmation-button confirmation-delete" id="delete-event-confirm">Supprimer</div>
        </div>
    </div>
    
    <div id="delete-account-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer votre compte ?</div>
        <div class="confirmation-text">ATTENTION : Cette action est définitive et irréversible. Toutes vos données seront supprimées.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-account-cancel">Annuler</div>
            <div class="confirmation-button confirmation-delete" id="delete-account-confirm">Supprimer</div>
        </div>
    </div>

    <div id="logout-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Se déconnecter ?</div>
        <div class="confirmation-text">Voulez-vous vraiment vous déconnecter de GroupChat ?</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="logout-cancel">Annuler</div>
            <div class="confirmation-button confirmation-confirm" id="logout-confirm">Déconnecter</div>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>

    <div class="notification" id="notification"></div>
    
    <div id="image-viewer" class="image-viewer">
        <div class="viewer-image-container">
            <img src="" alt="Image" class="viewer-image" id="viewer-image">
        </div>
        <div class="viewer-close" id="viewer-close">
            <i class="fas fa-times"></i>
        </div>
    </div>

    <div class="bottom-nav" id="bottom-nav">
        <div class="nav-item active" data-section="groups" style="flex: 1;">
            <i class="nav-icon fas fa-users"></i>
            <span>Groupes</span>
        </div>
        <div class="nav-item" data-section="forecasts" style="flex: 1;">
            <i class="nav-icon fas fa-futbol"></i>
            <span>Pronostics</span>
            <div class="notification-dot" id="forecasts-notification-dot" style="display: none;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy, addDoc, onSnapshot, where, deleteDoc, serverTimestamp, updateDoc, arrayUnion, arrayRemove, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTPLxUiA8lj82kqc6CyCPLQDITc0CtLUE",
            authDomain: "ichat-betai.firebaseapp.com",
            databaseURL: "https://ichat-betai-default-rtdb.firebaseio.com",
            projectId: "ichat-betai",
            storageBucket: "ichat-betai.appspot.com",
            messagingSenderId: "168337722600",
            appId: "1:168337722600:web:beb331f83cc4778c5b4d5d",
            measurementId: "G-STXPSZN7X8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isLoggedIn = false;
        let currentUser = null;
        let currentUserData = null;
        let isAdmin = false;
        let currentGroup = '';
        let currentGroupId = null;
        let currentGroupData = null;
        let currentSection = 'groups';
        let isOnline = navigator.onLine;
        let messageQueue = [];
        let chatUnsubscribers = {};
        let longPressTimer = null;
        let longPressDuration = 500;
        let activeContextMenu = null;
        let currentMessageForAction = null;
        let eventsUnsubscribe = null;
        let forecastsUnsubscribe = null;
        let groupImageFile = null;
        let profileImageFile = null;
        let editingGroupId = null;
        let profileUpdating = false;
        let isLoadingGroups = false;
        let isLoadingEvents = false;
        let profileNameChanged = false;
        let groupNameChanged = false;
        let groupDescriptionChanged = false;
        let groupPermissionsChanged = false;
        let currentEventForDeletion = null;
        let currentForecastTab = 'safes';
        let lastViewedEventTimestamp = null;
        let hasNewEvents = false;
        let chatImageFile = null;
        let isSearchActive = false;
        let currentSearchContext = '';
        
        function setupDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
            
            document.getElementById('dark-toggle').checked = document.documentElement.classList.contains('dark');
        }
        
        function setupConnectionMonitoring() {
            function updateConnectionStatus() {
                if (navigator.onLine) {
                    isOnline = true;
                    processQueuedMessages();
                } else {
                    isOnline = false;
                    showNotification("Pas de connexion internet. Les messages seront envoyés lorsque vous serez connecté.", "error");
                }
            }
            
            window.addEventListener('online', () => {
                showNotification("Connexion rétablie", "success");
                isOnline = true;
                
                setTimeout(() => {
                    if (isLoggedIn && currentSection === 'groups') {
                        loadGroups();
                    }
                    processQueuedMessages();
                }, 1000);
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus();
            });
            
            updateConnectionStatus();
        }
        
        async function processQueuedMessages() {
            if (messageQueue.length === 0) return;
            
            const processedMessages = [...messageQueue];
            messageQueue = [];
            
            for (const message of processedMessages) {
                try {
                    await sendMessageToFirestore(
                        message.groupId, 
                        message.text,
                        message.imageData
                    );
                } catch (error) {
                    messageQueue.push(message);
                }
            }
            
            if (messageQueue.length > 0) {
                showNotification(`${messageQueue.length} message(s) n'ont pas pu être envoyés`, 'error');
            } else if (processedMessages.length > 0) {
                showNotification('Tous les messages ont été envoyés', 'success');
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.textContent = message;
            notification.className = 'notification ' + type;
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.className = 'notification';
                }, 300);
            }, 3000);
        }
        
        function setupUIEvents() {
            document.getElementById('header-menu-button').addEventListener('click', function() {
                document.getElementById('side-menu').classList.add('active');
                document.getElementById('side-menu-overlay').classList.add('active');
            });
            
            document.getElementById('side-menu-close').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
            });
            
            document.getElementById('side-menu-overlay').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
            });
            
            document.getElementById('menu-profile').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showProfileSection();
            });
            
            document.getElementById('menu-terms').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showTermsDialog();
            });
            
            document.getElementById('terms-back').addEventListener('click', hideTermsDialog);
            
            document.getElementById('menu-about').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showAboutDialog();
            });
            
            document.getElementById('about-back').addEventListener('click', hideAboutDialog);
            
            // Gestionnaire pour le bouton de recherche
            document.getElementById('search-button').addEventListener('click', function() {
                toggleSearchBar();
            });
            
            document.getElementById('search-close').addEventListener('click', function() {
                hideSearchBar();
            });
            
            // Gestionnaire pour le champ de recherche
            document.getElementById('search-input').addEventListener('input', function() {
                handleSearch(this.value);
            });
            
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                // Marquer les événements comme vus
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });
            
            document.getElementById('close-events-btn').addEventListener('click', function() {
                if (currentSection === 'events') {
                    showGroupsSection();
                }
            });
            
            document.getElementById('bottom-nav').addEventListener('click', function(e) {
                const navItems = this.querySelectorAll('.nav-item');
                
                for (let i = 0; i < navItems.length; i++) {
                    const item = navItems[i];
                    const rect = item.getBoundingClientRect();
                    
                    if (e.clientX >= rect.left && e.clientX <= rect.right &&
                        e.clientY >= rect.top && e.clientY <= rect.bottom) {
                        
                        const section = item.getAttribute('data-section');
                        if (section === 'groups') {
                            showGroupsSection();
                        } else if (section === 'forecasts') {
                            showForecastsSection();
                        }
                        
                        break;
                    }
                }
            });
            
            document.querySelectorAll('.forecast-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchForecastTab(tabId);
                });
            });
            
            document.getElementById('dark-toggle').addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                localStorage.setItem('groupChatDarkMode', this.checked ? 'true' : 'false');
            });
            
            document.getElementById('logout-btn').addEventListener('click', showLogoutConfirmation);
            document.getElementById('logout-cancel').addEventListener('click', hideLogoutConfirmation);
            document.getElementById('logout-confirm').addEventListener('click', logoutUser);
            
            document.getElementById('delete-account-btn').addEventListener('click', showDeleteAccountConfirmation);
            
            document.getElementById('delete-account-cancel').addEventListener('click', hideDeleteAccountConfirmation);
            document.getElementById('delete-account-confirm').addEventListener('click', deleteAccount);
            
            document.getElementById('edit-profile-btn').addEventListener('click', showProfileEditDialog);
            document.getElementById('edit-profile-pic').addEventListener('click', showProfileEditDialog);
            
            document.getElementById('profile-edit-back').addEventListener('click', hideProfileEditDialog);
            document.getElementById('profile-upload-btn').addEventListener('click', function() {
                document.getElementById('profile-image-input').click();
            });
            
            document.getElementById('profile-image-input').addEventListener('change', handleProfileImageSelect);
            
            document.getElementById('save-display-name-btn').addEventListener('click', updateDisplayName);
            document.getElementById('save-profile-image-btn').addEventListener('click', updateProfileImage);
            
            document.getElementById('edit-display-name').addEventListener('input', function() {
                profileNameChanged = true;
                document.getElementById('save-display-name-btn').disabled = this.value.trim() === '';
            });
            
            document.getElementById('chat-input').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            document.getElementById('send-button').addEventListener('click', sendMessage);
            
            // Ajout des gestionnaires pour l'envoi d'image
            document.getElementById('image-button').addEventListener('click', function() {
                document.getElementById('chat-image-input').click();
            });
            
            document.getElementById('chat-image-input').addEventListener('change', handleChatImageSelect);
            
            // Gestionnaire pour le visualiseur d'image
            document.getElementById('viewer-close').addEventListener('click', closeImageViewer);
            
            document.getElementById('header-back-button').addEventListener('click', closeChat);
            
            document.getElementById('create-group-btn').addEventListener('click', function() {
                if (isAdmin) {
                    showCreateGroupDialog();
                } else {
                    showNotification("Seuls les administrateurs peuvent créer des groupes", "error");
                }
            });
            
            document.getElementById('create-group-back').addEventListener('click', hideCreateGroupDialog);
            document.getElementById('create-group-submit').addEventListener('click', createNewGroup);
            
            document.getElementById('create-notification-btn').addEventListener('click', function() {
                if (isAdmin) {
                    showAdminNotificationDialog();
                } else {
                    showNotification("Seuls les administrateurs peuvent envoyer des notifications", "error");
                }
            });
            
            document.getElementById('admin-notif-back').addEventListener('click', hideAdminNotificationDialog);
            document.getElementById('send-notification-btn').addEventListener('click', sendAdminNotification);
            
            document.getElementById('new-group-image-upload').addEventListener('click', function() {
                document.getElementById('new-group-image-input').click();
            });
            
            document.getElementById('new-group-image-input').addEventListener('change', handleNewGroupImageSelect);
            
            document.getElementById('edit-group-back').addEventListener('click', hideEditGroupDialog);
            
            document.getElementById('edit-group-image-upload').addEventListener('click', function() {
                document.getElementById('edit-group-image-input').click();
            });
            
            document.getElementById('edit-group-image-input').addEventListener('change', handleEditGroupImageSelect);
            
            document.getElementById('save-group-name-btn').addEventListener('click', updateGroupName);
            document.getElementById('save-group-description-btn').addEventListener('click', updateGroupDescription);
            document.getElementById('save-group-permissions-btn').addEventListener('click', updateGroupPermissions);
            document.getElementById('save-group-image-btn').addEventListener('click', updateGroupImage);
            
            document.getElementById('edit-group-name').addEventListener('input', function() {
                groupNameChanged = true;
                document.getElementById('save-group-name-btn').disabled = this.value.trim() === '';
            });
            
            document.getElementById('edit-group-description').addEventListener('input', function() {
                groupDescriptionChanged = true;
                document.getElementById('save-group-description-btn').disabled = false;
            });
            
            document.getElementById('edit-group-public-messages').addEventListener('change', function() {
                groupPermissionsChanged = true;
                document.getElementById('save-group-permissions-btn').disabled = false;
            });
            
            document.getElementById('delete-cancel').addEventListener('click', hideDeleteConfirmation);
            document.getElementById('delete-confirm').addEventListener('click', confirmDeleteMessage);
            
            document.getElementById('delete-event-cancel').addEventListener('click', hideDeleteEventConfirmation);
            document.getElementById('delete-event-confirm').addEventListener('click', confirmDeleteEvent);
            
            document.addEventListener('click', function(e) {
                if (activeContextMenu) {
                    const menu = document.getElementById('message-context-menu');
                    if (menu && !menu.contains(e.target)) {
                        hideContextMenu();
                    }
                }
            });
            
            document.querySelector('.context-menu-item.delete').addEventListener('click', showDeleteConfirmation);
            document.querySelector('.context-menu-item.copy').addEventListener('click', copyMessageText);
            document.querySelector('.context-menu-item.reply').addEventListener('click', replyToMessage);
            
            document.addEventListener('touchstart', handleGlobalTouchStart, { passive: true });
            document.addEventListener('touchend', handleGlobalTouchEnd, { passive: true });
            document.addEventListener('touchmove', handleGlobalTouchMove, { passive: true });
            document.addEventListener('touchcancel', handleGlobalTouchCancel, { passive: true });
            
            // Gestionnaires d'événements pour les boutons de réseaux sociaux
            document.getElementById('whatsapp-btn').addEventListener('click', function() {
                openSocialLink('whatsapp');
            });
            
            document.getElementById('telegram-btn').addEventListener('click', function() {
                openSocialLink('telegram');
            });
            
            document.getElementById('youtube-btn').addEventListener('click', function() {
                openSocialLink('youtube');
            });
        }
        
        // Fonction pour gérer la barre de recherche
        function toggleSearchBar() {
            const searchContainer = document.getElementById('search-container');
            const searchInput = document.getElementById('search-input');
            const header = document.querySelector('.header');
            
            if (isSearchActive) {
                hideSearchBar();
            } else {
                searchContainer.classList.add('active');
                header.classList.add('search-active');
                searchInput.focus();
                isSearchActive = true;
                
                // Déterminer le contexte de recherche en fonction de la section active
                currentSearchContext = currentSection;
                
                // Adapter le placeholder selon le contexte
                if (currentSearchContext === 'groups') {
                    searchInput.placeholder = 'Rechercher un groupe...';
                } else if (currentSearchContext === 'events') {
                    searchInput.placeholder = 'Rechercher un événement...';
                } else if (currentSearchContext === 'forecasts') {
                    searchInput.placeholder = 'Rechercher un pronostic...';
                }
            }
        }
        
        function hideSearchBar() {
            const searchContainer = document.getElementById('search-container');
            const searchInput = document.getElementById('search-input');
            const header = document.querySelector('.header');
            
            searchContainer.classList.remove('active');
            header.classList.remove('search-active');
            searchInput.value = '';
            isSearchActive = false;
            
            // Réinitialiser les filtres
            handleSearch('');
        }
        
        // Fonction pour gérer les recherches selon le contexte
        function handleSearch(query) {
            if (currentSearchContext === 'groups') {
                filterGroups(query);
            } else if (currentSearchContext === 'events') {
                filterEvents(query);
            }
            // Ajouter d'autres contextes de recherche au besoin
        }
        
        // Fonction pour ouvrir les liens sociaux en toute sécurité
        function openSocialLink(platform) {
            let url = '';
            
            switch(platform) {
                case 'whatsapp':
                    url = 'https://wa.me/';
                    showNotification('Ouverture de WhatsApp', 'info');
                    break;
                case 'telegram':
                    url = 'https://t.me/';
                    showNotification('Ouverture de Telegram', 'info');
                    break;
                case 'youtube':
                    url = 'https://www.youtube.com/';
                    showNotification('Ouverture de YouTube', 'info');
                    break;
                default:
                    return;
            }
            
            // Ouvrir dans une nouvelle fenêtre/onglet avec les paramètres de sécurité appropriés
            window.open(url, '_blank', 'noopener,noreferrer');
        }
        
        function showTermsDialog() {
            document.getElementById('terms-dialog').classList.add('active');
        }
        
        function hideTermsDialog() {
            document.getElementById('terms-dialog').classList.remove('active');
        }
        
        function showAboutDialog() {
            document.getElementById('about-dialog').classList.add('active');
        }
        
        function hideAboutDialog() {
            document.getElementById('about-dialog').classList.remove('active');
        }
        
        // Fonctions pour le visualiseur d'images
        function showImageViewer(imageUrl) {
            const viewer = document.getElementById('image-viewer');
            const viewerImage = document.getElementById('viewer-image');
            viewerImage.src = imageUrl;
            viewer.classList.add('active');
        }
        
        function closeImageViewer() {
            const viewer = document.getElementById('image-viewer');
            viewer.classList.remove('active');
            setTimeout(() => {
                document.getElementById('viewer-image').src = '';
            }, 300);
        }
        
        // Fonction pour traiter les images du chat
        async function handleChatImageSelect(e) {
            const file = e.target.files[0];
            if (!file || !file.type.match('image.*')) {
                showNotification('Veuillez sélectionner une image valide', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) { // 5 MB max
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                showNotification('Préparation de l\'image...', 'info');
                
                const base64Image = await encodeImageToBase64(file);
                chatImageFile = base64Image;
                
                // Optionnel : afficher un aperçu
                const inputField = document.getElementById('chat-input');
                if (inputField) {
                    inputField.placeholder = 'Ajoutez un commentaire à l\'image (optionnel)';
                    inputField.focus();
                }
                
                const imageButton = document.getElementById('image-button');
                if (imageButton) {
                    imageButton.style.color = 'var(--success-color)';
                }
                
                showNotification('Image prête à être envoyée', 'success');
            } catch (error) {
                console.error('Erreur lors du traitement de l\'image:', error);
                showNotification('Erreur lors du traitement de l\'image', 'error');
                chatImageFile = null;
            }
            
            // Réinitialiser l'input pour permettre de sélectionner à nouveau la même image
            document.getElementById('chat-image-input').value = '';
        }
        
        function switchForecastTab(tabId) {
            currentForecastTab = tabId;
            
            document.querySelectorAll('.forecast-tab').forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.forecasts-content').forEach(content => {
                if (content.id === `${tabId}-content`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            loadForecastsData(tabId);
        }
        
        function showGroupsSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
                return;
            }
            
            hideSearchBar();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-section') === 'groups') {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            currentSection = 'groups';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('groups-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Groupes';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="events-button" id="events-button">
                    <i class="fas fa-bell"></i>
                    <div class="notification-dot" id="events-notification-dot"></div>
                </div>
            `;
            
            if (hasNewEvents) {
                document.getElementById('events-notification-dot').classList.add('active');
            }
            
            // Réattacher les gestionnaires d'événements
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });
            
            loadGroups();
        }
        
        function showForecastsSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-section') === 'forecasts') {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            currentSection = 'forecasts';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('forecasts-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Pronostics';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="events-button" id="events-button">
                    <i class="fas fa-bell"></i>
                    <div class="notification-dot" id="events-notification-dot"></div>
                </div>
            `;
            
            if (hasNewEvents) {
                document.getElementById('events-notification-dot').classList.add('active');
            }
            
            // Réattacher les gestionnaires d'événements
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });
            
            loadForecastsData(currentForecastTab);
        }

        // Fonction pour déterminer si une date est aujourd'hui ou demain
        function isDateTodayOrTomorrow(date) {
            if (!date) return false;

            let forecastDate;
            if (date.toDate) {
                forecastDate = date.toDate();
            } else if (date instanceof Date) {
                forecastDate = date;
            } else {
                return false;
            }

            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);

            // Comparer seulement année, mois, jour (pas l'heure)
            return (
                (forecastDate.getFullYear() === today.getFullYear() && 
                 forecastDate.getMonth() === today.getMonth() && 
                 forecastDate.getDate() === today.getDate()) ||
                (forecastDate.getFullYear() === tomorrow.getFullYear() && 
                 forecastDate.getMonth() === tomorrow.getMonth() && 
                 forecastDate.getDate() === tomorrow.getDate())
            );
        }
        
        async function loadForecastsData(tabType) {
            try {
                const forecastsRef = collection(db, "forecasts");
                const forecastsSnap = await getDocs(forecastsRef);
                
                if (forecastsSnap.empty) {
                    await initCollections();
                }
            } catch (error) {
                console.error("Erreur initiale:", error);
            }
            
            if (forecastsUnsubscribe) {
                forecastsUnsubscribe();
                forecastsUnsubscribe = null;
            }
            
            const listElement = document.getElementById(`${tabType}-list`);
            if (!listElement) return;
            
            listElement.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                    <div style="margin-top: 10px; font-weight: bold;">Chargement des pronostics...</div>
                </div>
            `;
            
            try {
                const forecastsRef = collection(db, "forecasts");
                const q = query(
                    forecastsRef, 
                    where("type", "==", tabType), 
                    orderBy("date", "desc"),
                    limit(50)
                );
                
                forecastsUnsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        listElement.innerHTML = `
                            <div class="no-forecasts">
                                <i class="fas fa-futbol"></i>
                                <div class="empty-state-title">Aucun pronostic</div>
                                <div class="empty-state-text">Aucun pronostic disponible actuellement</div>
                            </div>
                        `;
                        return;
                    }
                    
                    let hasMatchesToday = false;
                    listElement.innerHTML = '';
                    
                    const fragment = document.createDocumentFragment();
                    
                    snapshot.forEach((doc) => {
                        const forecastData = doc.data();
                        // Vérifier si la date du pronostic est aujourd'hui ou demain
                        if (isDateTodayOrTomorrow(forecastData.date)) {
                            hasMatchesToday = true;
                            const forecastElement = createForecastElement(forecastData, tabType);
                            fragment.appendChild(forecastElement);
                        }
                    });
                    
                    if (hasMatchesToday) {
                        listElement.appendChild(fragment);
                    } else {
                        listElement.innerHTML = `
                            <div class="no-forecasts">
                                <i class="fas fa-calendar-day"></i>
                                <div class="empty-state-title">Pas de matchs aujourd'hui</div>
                                <div class="empty-state-text">Aucun pronostic disponible pour aujourd'hui ou demain</div>
                            </div>
                        `;
                    }
                });
            } catch (error) {
                listElement.innerHTML = `
                    <div class="no-forecasts">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="empty-state-title">Erreur</div>
                        <div class="empty-state-text">Impossible de charger les pronostics</div>
                    </div>
                `;
            }
        }
        
        async function initCollections() {
            try {
                const forecastsRef = collection(db, "forecasts");
                const forecastsSnap = await getDocs(forecastsRef);
            } catch (error) {
            }
        }
        
        function createForecastElement(forecastData, type) {
            const forecastElement = document.createElement('div');
            forecastElement.className = 'forecast-item';
            
            let statusClass = 'pending';
            let statusText = 'À venir';
            
            if (forecastData.status === 'win') {
                statusClass = 'win';
                statusText = 'Gagné';
            } else if (forecastData.status === 'loss') {
                statusClass = 'loss';
                statusText = 'Perdu';
            }
            
            let formattedDate = 'Date inconnue';
            if (forecastData.date) {
                let date;
                if (forecastData.date.toDate) {
                    date = forecastData.date.toDate();
                } else {
                    date = new Date(forecastData.date);
                }
                
                formattedDate = date.toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            let mainContent = '';
            
            if (type === 'safes') {
                mainContent = `
                    <div class="forecast-header">
                        <div>${forecastData.league}</div>
                        <div class="forecast-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="forecast-match">
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.homeTeam}</div>
                        </div>
                        <div class="forecast-score">VS</div>
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.awayTeam}</div>
                        </div>
                    </div>
                    <div style="text-align: center; font-weight: bold; margin: 10px 0;">
                        Pronostic: ${forecastData.prediction}
                    </div>
                `;
            } else if (type === 'exact') {
                let resultDisplay = '';
                if (forecastData.status !== 'pending') {
                    resultDisplay = `
                        <div style="margin-top: 5px; text-align: center;">
                            Résultat final: ${forecastData.homeScoreResult || 0}-${forecastData.awayScoreResult || 0}
                        </div>
                    `;
                }
                
                const scoreOptions = forecastData.scoreOptions || [forecastData.primaryOption || `${forecastData.homeScore}-${forecastData.awayScore}`];
                const scoreOptionsHTML = `
                    <div class="score-options">
                        ${scoreOptions.map(score => `
                            <div class="score-option ${score === (forecastData.primaryOption || `${forecastData.homeScore}-${forecastData.awayScore}`) ? 'active' : ''}">
                                ${score}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                mainContent = `
                    <div class="forecast-header">
                        <div>${forecastData.league}</div>
                        <div class="forecast-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="forecast-match">
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.homeTeam}</div>
                        </div>
                        <div class="forecast-score">VS</div>
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.awayTeam}</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin: 10px 0;">
                        <div style="font-weight: bold; margin-bottom: 5px;">Options de score:</div>
                        ${scoreOptionsHTML}
                    </div>
                    ${resultDisplay}
                `;
            } else if (type === 'ai') {
                let resultDisplay = '';
                if (forecastData.status !== 'pending') {
                    resultDisplay = `
                        <div style="margin-top: 5px; text-align: center; font-weight: bold; color: ${forecastData.status === 'win' ? 'var(--success-color)' : 'var(--danger-color)'}">
                            Résultat final: ${forecastData.homeScoreResult || 0}-${forecastData.awayScoreResult || 0}
                        </div>
                    `;
                }
                
                mainContent = `
                    <div class="forecast-header">
                        <div>${forecastData.league}</div>
                        <div class="forecast-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="forecast-match">
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.homeTeam}</div>
                        </div>
                        <div class="forecast-score">VS</div>
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.awayTeam}</div>
                        </div>
                    </div>
                    <div style="text-align: center; font-weight: bold; margin: 10px 0;">
                        Prédiction: ${forecastData.prediction}
                    </div>
                    ${resultDisplay}
                    <div style="font-size: 13px; margin-top: 10px; font-style: italic;">
                        "${forecastData.analysis}"
                    </div>
                `;
            }
            
            const confidenceBar = `
                <div class="forecast-confidence">
                    <span>Confiance:</span>
                    <div class="confidence-bar-container">
                        <div class="confidence-bar" style="width: ${forecastData.confidence}%"></div>
                    </div>
                    <span>${forecastData.confidence}%</span>
                </div>
            `;
            
            const footer = `
                <div class="forecast-date">${formattedDate}</div>
            `;
            
            forecastElement.innerHTML = mainContent + confidenceBar + footer;
            return forecastElement;
        }
        
        function showEventsSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            
            currentSection = 'events';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('events-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Événements';
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
            `;
            
            // Réattacher le gestionnaire d'événement pour la recherche
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            
            const createNotifBtn = document.getElementById('create-notification-btn');
            if (createNotifBtn) {
                if (isAdmin) {
                    createNotifBtn.style.display = 'flex';
                } else {
                    createNotifBtn.style.display = 'none';
                }
            }
            
            listenToEvents();
        }
        
        function showProfileSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            
            currentSection = 'profile';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('profile-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Profil';
            
            document.getElementById('header-menu-button').style.display = 'none';
            document.getElementById('header-back-button').style.display = 'block';
            
            document.getElementById('header-action').innerHTML = '';
            
            document.getElementById('header-back-button').addEventListener('click', function() {
                showGroupsSection();
            });
        }
        
        async function updateDisplayName() {
            if (!profileNameChanged) return;
            
            const displayName = document.getElementById('edit-display-name').value.trim();
            
            if (!displayName) {
                document.getElementById('edit-display-name-error').style.display = 'block';
                return;
            } else {
                document.getElementById('edit-display-name-error').style.display = 'none';
            }
            
            document.getElementById('save-display-name-btn').disabled = true;
            
            try {
                const userRef = doc(db, "Users", currentUser.uid);
                await updateDoc(userRef, {
                    displayName: displayName
                });
                
                currentUserData.displayName = displayName;
                
                updateProfileInfo();
                
                showNotification('Nom d\'utilisateur mis à jour', 'success');
                profileNameChanged = false;
            } catch (error) {
                showNotification('Erreur lors de la mise à jour du nom d\'utilisateur', 'error');
            } finally {
                document.getElementById('save-display-name-btn').disabled = false;
            }
        }
        
        async function updateProfileImage() {
            if (!profileImageFile) {
                showNotification('Aucune nouvelle image sélectionnée', 'info');
                return;
            }
            
            setButtonLoading('save-profile-image-btn', true);
            
            try {
                const userRef = doc(db, "Users", currentUser.uid);
                await updateDoc(userRef, {
                    photoURL: profileImageFile
                });
                
                currentUserData.photoURL = profileImageFile;
                
                updateProfileInfo();
                
                showNotification('Photo de profil mise à jour', 'success');
                profileImageFile = null;
            } catch (error) {
                showNotification('Erreur lors de la mise à jour de la photo', 'error');
            } finally {
                setButtonLoading('save-profile-image-btn', false);
            }
        }
        
        async function updateGroupName() {
            if (!groupNameChanged || !editingGroupId) return;
            
            const groupName = document.getElementById('edit-group-name').value.trim();
            
            if (!groupName) {
                document.getElementById('edit-group-name-error').style.display = 'block';
                return;
            } else {
                document.getElementById('edit-group-name-error').style.display = 'none';
            }
            
            document.getElementById('save-group-name-btn').disabled = true;
            
            try {
                const groupRef = doc(db, "groups", editingGroupId);
                await updateDoc(groupRef, {
                    name: groupName,
                    lastUpdated: serverTimestamp()
                });
                
                if (currentGroupId === editingGroupId) {
                    currentGroup = groupName;
                    if (currentGroupData) {
                        currentGroupData.name = groupName;
                    }
                    
                    updateGroupHeader();
                }
                
                showNotification('Nom du groupe mis à jour', 'success');
                groupNameChanged = false;
                
                loadGroups();
            } catch (error) {
                showNotification('Erreur lors de la mise à jour du nom', 'error');
            } finally {
                document.getElementById('save-group-name-btn').disabled = false;
            }
        }
        
        function updateGroupHeader() {
            if (!currentGroupData) return;
            
            const headerTitle = document.getElementById('header-title');
            if (!headerTitle) return;
            
            if (currentGroupData.allowPublicMessages === false) {
                headerTitle.innerHTML = `${currentGroup} <span class="restricted-badge">Restreint</span>`;
            } else {
                headerTitle.innerText = currentGroup;
            }
        }
        
        async function updateGroupDescription() {
            if (!groupDescriptionChanged || !editingGroupId) return;
            
            const groupDescription = document.getElementById('edit-group-description').value.trim();
            
            document.getElementById('save-group-description-btn').disabled = true;
            
            try {
                const groupRef = doc(db, "groups", editingGroupId);
                await updateDoc(groupRef, {
                    description: groupDescription,
                    lastUpdated: serverTimestamp()
                });
                
                if (currentGroupId === editingGroupId && currentGroupData) {
                    currentGroupData.description = groupDescription;
                }
                
                showNotification('Description du groupe mise à jour', 'success');
                groupDescriptionChanged = false;
            } catch (error) {
                showNotification('Erreur lors de la mise à jour de la description', 'error');
            } finally {
                document.getElementById('save-group-description-btn').disabled = false;
            }
        }
        
        async function updateGroupPermissions() {
            if (!groupPermissionsChanged || !editingGroupId) return;
            
            const allowPublicMessages = document.getElementById('edit-group-public-messages').checked;
            
            document.getElementById('save-group-permissions-btn').disabled = true;
            
            try {
                const groupRef = doc(db, "groups", editingGroupId);
                
                const groupDoc = await getDoc(groupRef);
                if (!groupDoc.exists()) {
                    throw new Error("Groupe introuvable");
                }
                
                const groupData = groupDoc.data();
                const permissionsChanged = allowPublicMessages !== groupData.allowPublicMessages;
                
                await updateDoc(groupRef, {
                    allowPublicMessages: allowPublicMessages,
                    lastUpdated: serverTimestamp()
                });
                
                if (permissionsChanged) {
                    try {
                        await addEventLog({
                            type: 'permission-change',
                            groupId: editingGroupId,
                            groupName: groupData.name,
                            userId: currentUser.uid,
                            allowPublicMessages,
                            timestamp: new Date()
                        });
                    } catch (error) {
                    }
                }
                
                if (currentGroupId === editingGroupId) {
                    if (currentGroupData) {
                        currentGroupData.allowPublicMessages = allowPublicMessages;
                    }
                    
                    updateGroupHeader();
                    
                    checkSendPermissions();
                }
                
                showNotification('Permissions du groupe mises à jour', 'success');
                groupPermissionsChanged = false;
            } catch (error) {
                showNotification('Erreur lors de la mise à jour des permissions', 'error');
            } finally {
                document.getElementById('save-group-permissions-btn').disabled = false;
            }
        }
        
        async function updateGroupImage() {
            if (!groupImageFile || !editingGroupId) {
                showNotification('Aucune nouvelle image sélectionnée', 'info');
                return;
            }
            
            setButtonLoading('save-group-image-btn', true);
            
            try {
                const groupRef = doc(db, "groups", editingGroupId);
                await updateDoc(groupRef, {
                    imageURL: groupImageFile,
                    lastUpdated: serverTimestamp()
                });
                
                if (currentGroupId === editingGroupId && currentGroupData) {
                    currentGroupData.imageURL = groupImageFile;
                }
                
                showNotification('Image du groupe mise à jour', 'success');
                groupImageFile = null;
                
                loadGroups();
            } catch (error) {
                showNotification('Erreur lors de la mise à jour de l\'image', 'error');
            } finally {
                setButtonLoading('save-group-image-btn', false);
            }
        }
        
        function setupAuthEvents() {
            document.getElementById('login-tab').addEventListener('click', () => changeAuthTab('login'));
            document.getElementById('register-tab').addEventListener('click', () => changeAuthTab('register'));
            
            document.getElementById('goto-register').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('register');
            });
            
            document.getElementById('goto-login').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('login');
            });
            
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            document.getElementById('registerBtn').addEventListener('click', registerUser);
            
            document.getElementById('login-email').addEventListener('input', validateLoginEmail);
            document.getElementById('login-password').addEventListener('input', validateLoginPassword);
            document.getElementById('register-email').addEventListener('input', validateRegisterEmail);
            document.getElementById('register-password').addEventListener('input', validateRegisterPassword);
            document.getElementById('register-confirm-password').addEventListener('input', validateRegisterConfirmPassword);
            
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateLoginForm()) {
                    loginUser();
                }
            });
            
            document.getElementById('register-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateRegisterForm()) {
                    registerUser();
                }
            });
        }
        
        function encodeImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    resolve(event.target.result);
                };
                reader.onerror = function(error) {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function handleProfileImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Veuillez sélectionner une image', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                const base64Image = await encodeImageToBase64(file);
                profileImageFile = base64Image;
                
                const preview = document.getElementById('profile-image-preview');
                preview.innerHTML = `<img src="${base64Image}" alt="Profile Image">`;
                
                document.getElementById('save-profile-image-btn').disabled = false;
                
            } catch (error) {
                showNotification('Erreur lors du traitement de l\'image', 'error');
            }
        }
        
        async function handleNewGroupImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Veuillez sélectionner une image', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                const base64Image = await encodeImageToBase64(file);
                groupImageFile = base64Image;
                
                const preview = document.getElementById('new-group-image-preview');
                preview.innerHTML = `
                    <img src="${base64Image}" alt="Group Image">
                    <div class="group-image-overlay" id="new-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
                
                document.getElementById('new-group-image-upload').addEventListener('click', () => {
                    document.getElementById('new-group-image-input').click();
                });
                
            } catch (error) {
                showNotification('Erreur lors du traitement de l\'image', 'error');
            }
        }
        
        async function handleEditGroupImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Veuillez sélectionner une image', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                const base64Image = await encodeImageToBase64(file);
                groupImageFile = base64Image;
                
                const preview = document.getElementById('edit-group-image-preview');
                preview.innerHTML = `
                    <img src="${base64Image}" alt="Group Image">
                    <div class="group-image-overlay" id="edit-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
                
                document.getElementById('edit-group-image-upload').addEventListener('click', () => {
                    document.getElementById('edit-group-image-input').click();
                });
                
                document.getElementById('save-group-image-btn').disabled = false;
                
            } catch (error) {
                showNotification('Erreur lors du traitement de l\'image', 'error');
            }
        }
        
        function showProfileEditDialog() {
            document.getElementById('profile-edit-dialog').classList.add('active');
            
            document.getElementById('edit-display-name').value = currentUserData.displayName || '';
            
            document.getElementById('save-display-name-btn').disabled = true;
            document.getElementById('save-profile-image-btn').disabled = true;
            
            profileNameChanged = false;
            profileImageFile = null;
            
            const profileImagePreview = document.getElementById('profile-image-preview');
            if (currentUserData.photoURL) {
                profileImagePreview.innerHTML = `<img src="${currentUserData.photoURL}" alt="Profile">`;
            } else {
                profileImagePreview.innerHTML = `<i class="fas fa-user"></i>`;
            }
        }
        
        function hideProfileEditDialog() {
            document.getElementById('profile-edit-dialog').classList.remove('active');
            
            profileNameChanged = false;
            profileImageFile = null;
            document.getElementById('profile-image-input').value = '';
        }
        
        function filterGroups(searchText) {
            const groupItems = document.querySelectorAll('.chat-item');
            const lowerSearchText = searchText.toLowerCase();
            
            groupItems.forEach(item => {
                const groupName = item.getAttribute('data-group').toLowerCase();
                if (groupName.includes(lowerSearchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            let visibleGroups = 0;
            groupItems.forEach(item => {
                if (item.style.display !== 'none') {
                    visibleGroups++;
                }
            });
            
            const emptyState = document.querySelector('#groups-list .empty-state');
            if (visibleGroups === 0 && groupItems.length > 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('.empty-state-title').textContent = 'Aucun résultat';
                    emptyState.querySelector('.empty-state-text').textContent = `Aucun groupe ne correspond à "${searchText}"`;
                } else {
                    const newEmptyState = document.createElement('div');
                    newEmptyState.className = 'empty-state';
                    newEmptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <div class="empty-state-title">Aucun résultat</div>
                        <div class="empty-state-text">Aucun groupe ne correspond à "${searchText}"</div>
                    `;
                    document.getElementById('groups-list').appendChild(newEmptyState);
                }
            } else if (emptyState) {
                if (groupItems.length === 0) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('.empty-state-title').textContent = 'Aucun groupe';
                    emptyState.querySelector('.empty-state-text').textContent = isAdmin ? 
                        'Créez un nouveau groupe en appuyant sur le bouton +' : 
                        'Aucun groupe disponible pour le moment';
                } else {
                    emptyState.style.display = visibleGroups > 0 ? 'none' : 'block';
                }
            }
        }
        
        function filterEvents(searchText) {
            const eventItems = document.querySelectorAll('.event-item, .admin-notification');
            const lowerSearchText = searchText.toLowerCase();
            
            eventItems.forEach(item => {
                const eventContent = item.querySelector('.event-content, .admin-notification-content')?.textContent.toLowerCase() || '';
                const eventHeader = item.querySelector('.event-header, .admin-notification-title')?.textContent.toLowerCase() || '';
                
                if (eventContent.includes(lowerSearchText) || eventHeader.includes(lowerSearchText)) {
                    item.style.display = item.classList.contains('event-item') ? 'flex' : 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            
            let visibleEvents = 0;
            eventItems.forEach(item => {
                if (item.style.display !== 'none') {
                    visibleEvents++;
                }
            });
            
            const emptyState = document.querySelector('#events-list .empty-state');
            if (visibleEvents === 0 && eventItems.length > 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('.empty-state-title').textContent = 'Aucun résultat';
                    emptyState.querySelector('.empty-state-text').textContent = `Aucun événement ne correspond à "${searchText}"`;
                } else {
                    const newEmptyState = document.createElement('div');
                    newEmptyState.className = 'empty-state';
                    newEmptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <div class="empty-state-title">Aucun résultat</div>
                        <div class="empty-state-text">Aucun événement ne correspond à "${searchText}"</div>
                    `;
                    document.getElementById('events-list').appendChild(newEmptyState);
                }
            } else if (emptyState) {
                if (eventItems.length === 0) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('.empty-state-title').textContent = 'Aucun événement';
                    emptyState.querySelector('.empty-state-text').textContent = 'Les événements apparaîtront ici';
                } else {
                    emptyState.style.display = visibleEvents > 0 ? 'none' : 'block';
                }
            }
        }
        
        function handleGlobalTouchStart(e) {
            const messageElement = findParentMessage(e.target);
            if (messageElement) {
                const messageId = messageElement.getAttribute('data-id');
                const messageFrom = messageElement.getAttribute('data-from');
                
                // Autoriser l'action sur tous les messages, pas seulement les siens
                longPressTimer = setTimeout(() => {
                    try {
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                        
                        showContextMenu(messageElement, messageId, messageFrom);
                    } catch (error) {
                        console.error("Erreur au toucher long:", error);
                    }
                }, longPressDuration);
            }
        }
        
        function handleGlobalTouchEnd(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function handleGlobalTouchMove(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function handleGlobalTouchCancel(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function findParentMessage(element) {
            while (element && !element.classList.contains('message')) {
                element = element.parentElement;
            }
            return element;
        }
        
        function showContextMenu(messageElement, messageId, messageFrom) {
            if (!messageElement || !messageId) return;
            
            try {
                const rect = messageElement.getBoundingClientRect();
                const menu = document.getElementById('message-context-menu');
                
                // Ajuster l'affichage des options en fonction de qui a envoyé le message
                const deleteOption = menu.querySelector('.context-menu-item.delete');
                if (messageFrom !== currentUser.uid && !isAdmin) {
                    deleteOption.style.display = 'none';
                } else {
                    deleteOption.style.display = 'flex';
                }
                
                menu.style.top = `${rect.top}px`;
                
                if (messageElement.classList.contains('message-sent')) {
                    menu.style.right = `${window.innerWidth - rect.right}px`;
                    menu.style.left = 'auto';
                } else {
                    menu.style.left = `${rect.left}px`;
                    menu.style.right = 'auto';
                }
                
                menu.style.display = 'block';
                activeContextMenu = menu;
                
                // Appliquer la classe selected au message
                messageElement.classList.add('selected');
                
                currentMessageForAction = {
                    element: messageElement,
                    id: messageId,
                    from: messageFrom,
                    text: messageElement.textContent.trim()
                };
            } catch (error) {
                console.error("Erreur d'affichage du menu contextuel:", error);
            }
        }
        
        function replyToMessage() {
            if (!currentMessageForAction) {
                hideContextMenu();
                return;
            }
            
            try {
                const chatInput = document.getElementById('chat-input');
                const senderName = currentMessageForAction.from === currentUser.uid ? 'Vous' : 
                    document.querySelector(`.sender-${currentMessageForAction.from}`).textContent || 'Utilisateur';
                
                // Tronquer le texte si trop long
                let shortText = currentMessageForAction.text;
                if (shortText.length > 50) {
                    shortText = shortText.substring(0, 47) + '...';
                }
                
                chatInput.value = `[Réponse à ${senderName}: "${shortText}"] `;
                chatInput.focus();
                
                hideContextMenu();
            } catch (error) {
                console.error("Erreur de réponse:", error);
                hideContextMenu();
            }
        }
        
        function hideContextMenu() {
            try {
                const menu = document.getElementById('message-context-menu');
                if (menu) {
                    menu.style.display = 'none';
                }
                activeContextMenu = null;
                
                // Retirer la classe selected du message actuel
                if (currentMessageForAction && currentMessageForAction.element) {
                    currentMessageForAction.element.classList.remove('selected');
                }
            } catch (error) {
                console.error("Erreur en masquant le menu contextuel:", error);
            }
        }
        
        function showDeleteConfirmation() {
            hideContextMenu();
            document.getElementById('delete-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        function hideDeleteConfirmation() {
            document.getElementById('delete-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            currentMessageForAction = null;
        }
        
        async function confirmDeleteMessage() {
            if (!currentMessageForAction || !currentGroupId) {
                hideDeleteConfirmation();
                return;
            }
            
            const messageId = currentMessageForAction.id;
            const messageElement = currentMessageForAction.element;
            
            try {
                messageElement.classList.add('deleting');
                
                setTimeout(async () => {
                    try {
                        const messageRef = doc(db, "groups", currentGroupId, "messages", messageId);
                        await deleteDoc(messageRef);
                        
                        await addEventLog({
                            type: 'message-delete',
                            groupId: currentGroupId,
                            groupName: currentGroup,
                            userId: currentUser.uid,
                            timestamp: new Date()
                        });
                        
                        showNotification('Message supprimé', 'success');
                    } catch (error) {
                        messageElement.classList.remove('deleting');
                    }
                }, 100);
                
                hideDeleteConfirmation();
            } catch (error) {
                showNotification("Erreur lors de la suppression", "error");
                hideDeleteConfirmation();
            }
        }
        
        function copyMessageText() {
            if (!currentMessageForAction) {
                hideContextMenu();
                return;
            }
            
            try {
                const messageElement = currentMessageForAction.element;
                const messageText = messageElement.textContent;
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(messageText).then(() => {
                        showNotification('Texte copié dans le presse-papiers', 'success');
                    }).catch(err => {
                        showNotification('Erreur lors de la copie du texte', 'error');
                    });
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = messageText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            showNotification('Texte copié dans le presse-papiers', 'success');
                        } else {
                            showNotification('Impossible de copier le texte', 'error');
                        }
                    } catch (err) {
                        showNotification('Erreur lors de la copie du texte', 'error');
                    }
                    
                    document.body.removeChild(textArea);
                }
            } catch (error) {
                showNotification('Erreur lors de la copie du texte', 'error');
            } finally {
                hideContextMenu();
            }
        }
        
        function showCreateGroupDialog() {
            if (!isAdmin) {
                showNotification("Seuls les administrateurs peuvent créer des groupes", "error");
                return;
            }
            
            document.getElementById('group-name').value = '';
            document.getElementById('group-description').value = '';
            document.getElementById('group-public-messages').checked = true;
            document.getElementById('group-name-error').style.display = 'none';
            
            groupImageFile = null;
            document.getElementById('new-group-image-preview').innerHTML = `
                <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                <div class="group-image-overlay" id="new-group-image-upload">
                    <i class="fas fa-camera"></i>
                </div>
            `;
            document.getElementById('new-group-image-input').value = '';
            
            document.getElementById('new-group-image-upload').addEventListener('click', () => {
                document.getElementById('new-group-image-input').click();
            });
            
            document.getElementById('create-group-dialog').classList.add('active');
            document.getElementById('group-name').focus();
        }
        
        function hideCreateGroupDialog() {
            document.getElementById('create-group-dialog').classList.remove('active');
        }
        
        function showEditGroupDialog(groupId, groupData) {
            if (!isAdmin) {
                showNotification("Seuls les administrateurs peuvent modifier le groupe", "error");
                return;
            }
            
            editingGroupId = groupId;
            
            document.getElementById('edit-group-name').value = groupData.name || '';
            document.getElementById('edit-group-description').value = groupData.description || '';
            document.getElementById('edit-group-public-messages').checked = groupData.allowPublicMessages !== false;
            
            document.getElementById('save-group-name-btn').disabled = true;
            document.getElementById('save-group-description-btn').disabled = true;
            document.getElementById('save-group-permissions-btn').disabled = true;
            document.getElementById('save-group-image-btn').disabled = true;
            
            groupNameChanged = false;
            groupDescriptionChanged = false;
            groupPermissionsChanged = false;
            groupImageFile = null;
            
            const groupImagePreview = document.getElementById('edit-group-image-preview');
            if (groupData.imageURL) {
                groupImagePreview.innerHTML = `
                    <img src="${groupData.imageURL}" alt="Group Image">
                    <div class="group-image-overlay" id="edit-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
            } else {
                groupImagePreview.innerHTML = `
                    <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                    <div class="group-image-overlay" id="edit-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
            }
            
            document.getElementById('edit-group-image-upload').addEventListener('click', () => {
                document.getElementById('edit-group-image-input').click();
            });
            
            document.getElementById('edit-group-dialog').classList.add('active');
        }
        
        function hideEditGroupDialog() {
            document.getElementById('edit-group-dialog').classList.remove('active');
            editingGroupId = null;
            
            groupNameChanged = false;
            groupDescriptionChanged = false;
            groupPermissionsChanged = false;
            groupImageFile = null;
            document.getElementById('edit-group-image-input').value = '';
        }
        
        async function createNewGroup() {
            if (!isAdmin) {
                showNotification("Seuls les administrateurs peuvent créer des groupes", "error");
                return;
            }
            
            const groupName = document.getElementById('group-name').value.trim();
            const groupDescription = document.getElementById('group-description').value.trim();
            const allowPublicMessages = document.getElementById('group-public-messages').checked;
            
            if (!groupName) {
                document.getElementById('group-name-error').style.display = 'block';
                return;
            }
            
            setButtonLoading('create-group-submit', true);
            
            try {
                const groupRef = collection(db, "groups");
                const newGroup = {
                    name: groupName,
                    description: groupDescription || "Groupe de discussion",
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    members: [currentUser.uid],
                    lastMessageTime: serverTimestamp(),
                    allowPublicMessages: allowPublicMessages,
                    admins: [currentUser.uid],
                    imageURL: groupImageFile || null
                };
                
                const groupDocRef = await addDoc(groupRef, newGroup);
                
                const messagesRef = collection(db, "groups", groupDocRef.id, "messages");
                await addDoc(messagesRef, {
                    text: `Bienvenue dans le groupe "${groupName}" !${allowPublicMessages ? '' : '\n(Groupe avec messages restreints - seuls les admins peuvent écrire)'}`,
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                
                await addEventLog({
                    type: 'group-create',
                    groupId: groupDocRef.id,
                    groupName: groupName,
                    userId: currentUser.uid,
                    allowPublicMessages: allowPublicMessages,
                    timestamp: new Date()
                });
                
                setButtonLoading('create-group-submit', false);
                
                hideCreateGroupDialog();
                
                loadGroups();
                
                showNotification(`Groupe "${groupName}" créé avec succès`, 'success');
            } catch (error) {
                showNotification('Erreur lors de la création du groupe', 'error');
                setButtonLoading('create-group-submit', false);
            }
        }
        
        async function addEventLog(eventData) {
            try {
                if (!eventData.type || !eventData.timestamp) {
                    return;
                }
                
                const completeEventData = {
                    ...eventData,
                    timestamp: serverTimestamp(),
                    userId: eventData.userId || currentUser.uid
                };
                
                const eventsRef = collection(db, "events");
                await addDoc(eventsRef, completeEventData);
                
            } catch (error) {
                console.error("Erreur d'événement:", error);
            }
        }
        
        function changeAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                
                registerForm.style.animation = 'none';
                void registerForm.offsetWidth;
                registerForm.style.animation = '';
                
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                
                loginForm.style.animation = 'none';
                void loginForm.offsetWidth;
                loginForm.style.animation = '';
                
                loginForm.classList.remove('active');
                registerForm.classList.add('active');
            }
            
            hideLog('login-log');
            hideLog('register-log');
            
            const activeForm = tab === 'login' ? loginForm : registerForm;
            activeForm.style.animation = 'fadeUp 0.5s ease';
        }
        
        function validateLoginEmail() {
            const email = document.getElementById('login-email').value.trim();
            const errorElement = document.getElementById('login-email-error');
            
            if (!email) {
                errorElement.textContent = 'L\'email est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (!isValidEmail(email)) {
                errorElement.textContent = 'Format d\'email invalide';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateLoginPassword() {
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-password-error');
            
            if (!password) {
                errorElement.textContent = 'Le mot de passe est requis';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateRegisterEmail() {
            const email = document.getElementById('register-email').value.trim();
            const errorElement = document.getElementById('register-email-error');
            
            if (!email) {
                errorElement.textContent = 'L\'email est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (!isValidEmail(email)) {
                errorElement.textContent = 'Format d\'email invalide';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateRegisterPassword() {
            const password = document.getElementById('register-password').value;
            const errorElement = document.getElementById('register-password-error');
            
            if (!password) {
                errorElement.textContent = 'Le mot de passe est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (password.length < 6) {
                errorElement.textContent = 'Le mot de passe doit contenir au moins 6 caractères';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateRegisterConfirmPassword() {
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const errorElement = document.getElementById('register-confirm-password-error');
            
            if (!confirmPassword) {
                errorElement.textContent = 'La confirmation du mot de passe est requise';
                errorElement.style.display = 'block';
                return false;
            } else if (password !== confirmPassword) {
                errorElement.textContent = 'Les mots de passe ne correspondent pas';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateLoginForm() {
            return validateLoginEmail() && validateLoginPassword();
        }
        
        function validateRegisterForm() {
            return validateRegisterEmail() && validateRegisterPassword() && validateRegisterConfirmPassword();
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        function showLog(elementId, text, type="info") {
            const logDiv = document.getElementById(elementId);
            if (!logDiv) return;
            
            logDiv.textContent = text;
            logDiv.className = `log-message ${type}`;
            logDiv.style.display = "block";
            
            logDiv.style.animation = 'fadeIn 0.5s ease';
        }
        
        function hideLog(elementId) {
            const logDiv = document.getElementById(elementId);
            if (logDiv) {
                logDiv.style.display = "none";
            }
        }
        
        async function loginUser() {
            if (!validateLoginForm()) {
                return;
            }
            
            const email = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value;
            
            setButtonLoading('loginBtn', true);
            hideLog("login-log");
            
            try {
                showLog("login-log", "Connexion en cours...", "info");
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                currentUser = userCredential.user;
                
                showLog("login-log", "Connexion réussie ! Redirection...", "success");
                
                setTimeout(() => {
                    hideAuthScreen();
                }, 1000);
            } catch (error) {
                let errorMessage = "Erreur de connexion";
                
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = "Email ou mot de passe incorrect.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "L'adresse email n'est pas valide.";
                        break;
                    case 'auth/user-disabled':
                        errorMessage = "Ce compte a été désactivé.";
                        break;
                    default:
                        errorMessage = "Erreur de connexion: " + error.message;
                }
                
                showLog("login-log", errorMessage, "error");
                setButtonLoading('loginBtn', false);
            }
        }
        
        async function registerUser() {
            if (!validateRegisterForm()) {
                return;
            }
            
            const email = document.getElementById("register-email").value.trim();
            const password = document.getElementById("register-password").value;
            
            setButtonLoading('registerBtn', true);
            hideLog("register-log");
            
            try {
                showLog("register-log", "Inscription en cours...", "info");
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;
                const statut = await createUserProfile(uid, email);
                
                showLog("register-log", `Inscription réussie ! Compte créé avec succès.`, "success");
                
                currentUser = userCredential.user;
                
                setTimeout(() => {
                    hideAuthScreen();
                }, 1000);
            } catch (error) {
                let errorMessage = "Erreur d'inscription";
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = "Cette adresse email est déjà utilisée.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "L'adresse email n'est pas valide.";
                        break;
                    case 'auth/weak-password':
                        errorMessage = "Le mot de passe est trop faible.";
                        break;
                    default:
                        errorMessage = "Erreur d'inscription: " + error.message;
                }
                
                showLog("register-log", errorMessage, "error");
                setButtonLoading('registerBtn', false);
            }
        }
        
        async function createUserProfile(uid, email) {
            try {
                const usersRef = collection(db, "Users");
                const usersSnap = await getDocs(usersRef);
                
                const isNewUserAdmin = usersSnap.empty;
                
                if (isNewUserAdmin) {
                    const configAdminRef = doc(db, "Config", "admins");
                    const configAdminSnap = await getDoc(configAdminRef);
                    
                    if (configAdminSnap.exists()) {
                        await updateDoc(configAdminRef, {
                            adminUids: arrayUnion(uid)
                        });
                    } else {
                        await setDoc(configAdminRef, {
                            adminUids: [uid],
                            maxAdmins: 5
                        });
                    }
                }
                
                const userRef = doc(db, "Users", uid);
                await setDoc(userRef, {
                    email: email,
                    statut: isNewUserAdmin ? "admin" : "simple",
                    createdAt: new Date().toISOString(),
                    displayName: email.split('@')[0]
                });
                
                const groupsRef = collection(db, "groups");
                const groupsSnapshot = await getDocs(groupsRef);
                
                if (groupsSnapshot.empty && isNewUserAdmin) {
                    const generalGroup = {
                        name: "Général",
                        description: "Groupe général pour tous les utilisateurs",
                        createdBy: uid,
                        createdAt: serverTimestamp(),
                        members: [uid],
                        admins: [uid],
                        allowPublicMessages: true,
                        lastMessageTime: serverTimestamp()
                    };
                    
                    const generalGroupRef = await addDoc(groupsRef, generalGroup);
                    
                    const messagesRef = collection(db, "groups", generalGroupRef.id, "messages");
                    await addDoc(messagesRef, {
                        text: "Bienvenue dans le groupe général !",
                        senderId: uid,
                        createdAt: serverTimestamp()
                    });
                    
                    await addDoc(collection(db, "events"), {
                        type: 'group-create',
                        groupId: generalGroupRef.id,
                        groupName: "Général",
                        userId: uid,
                        allowPublicMessages: true,
                        timestamp: serverTimestamp()
                    });
                    
                } else {
                    for (const groupDoc of groupsSnapshot.docs) {
                        await updateDoc(doc(db, "groups", groupDoc.id), {
                            members: arrayUnion(uid)
                        });
                        
                        await addDoc(collection(db, "events"), {
                            type: 'user-join',
                            groupId: groupDoc.id,
                            groupName: groupDoc.data().name,
                            userId: uid,
                            timestamp: serverTimestamp()
                        });
                    }
                }
                
                await addDoc(collection(db, "events"), {
                    type: 'user-create',
                    userId: uid,
                    isAdmin: isNewUserAdmin,
                    timestamp: serverTimestamp()
                });
                
                return isNewUserAdmin ? "admin" : "simple";
            } catch (error) {
                return "simple";
            }
        }
        
        function setButtonLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            const loader = button.querySelector('.btn-loader');
            if (!loader) return;
            
            if (isLoading) {
                button.classList.add('loading');
                loader.style.display = 'inline-block';
            } else {
                button.classList.remove('loading');
                loader.style.display = 'none';
            }
        }
        
        function hideAuthScreen() {
            document.getElementById('auth-screen').style.opacity = '0';
            document.getElementById('auth-screen').style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                document.getElementById('auth-screen').style.display = 'none';
                completeLogin();
            }, 500);
        }
        
        async function completeLogin() {
            try {
                currentUserData = await getUserData(currentUser.uid);
                
                if (currentUserData && currentUserData.statut === 'admin') {
                    isAdmin = true;
                }
                
                document.getElementById('loading').style.display = 'flex';
                
                setTimeout(() => {
                    document.getElementById('bottom-nav').style.opacity = '0';
                    document.getElementById('bottom-nav').style.display = 'flex';
                    
                    document.querySelector('.header').style.opacity = '0';
                    document.querySelector('.header').style.display = 'flex';
                    
                    document.querySelector('.content').style.opacity = '0';
                    document.querySelector('.content').style.display = 'block';
                    
                    setTimeout(() => {
                        document.getElementById('bottom-nav').style.opacity = '1';
                        document.getElementById('bottom-nav').style.transition = 'opacity 0.5s ease';
                        
                        document.querySelector('.header').style.opacity = '1';
                        document.querySelector('.header').style.transition = 'opacity 0.5s ease';
                        
                        document.querySelector('.content').style.opacity = '1';
                        document.querySelector('.content').style.transition = 'opacity 0.5s ease';
                        
                        document.getElementById('loading').style.display = 'none';
                        
                        loadInitialData();
                    }, 10);
                }, 500);
                
                updateProfileInfo();
                
                isLoggedIn = true;
                
                // Charger la dernière date de vue des événements
                await loadLastViewedEventTimestamp();
                
            } catch (error) {
                showNotification("Erreur lors de la connexion à l'application", "error");
                
                document.getElementById('loading').style.display = 'none';
                
                document.getElementById('bottom-nav').style.display = 'flex';
                document.querySelector('.header').style.display = 'flex';
                document.querySelector('.content').style.display = 'block';
            }
        }

        async function loadLastViewedEventTimestamp() {
            try {
                const userRef = doc(db, "Users", currentUser.uid);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists() && userDoc.data().lastViewedEvent) {
                    lastViewedEventTimestamp = userDoc.data().lastViewedEvent.toDate();
                } else {
                    // Si aucune date n'existe, utiliser la date actuelle
                    lastViewedEventTimestamp = new Date();
                    await updateDoc(userRef, {
                        lastViewedEvent: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error("Erreur chargement date événements:", error);
                // En cas d'erreur, utiliser la date actuelle
                lastViewedEventTimestamp = new Date();
            }
        }

        async function updateLastViewedEventTimestamp() {
            try {
                const userRef = doc(db, "Users", currentUser.uid);
                await updateDoc(userRef, {
                    lastViewedEvent: serverTimestamp()
                });
                
                lastViewedEventTimestamp = new Date();
            } catch (error) {
                console.error("Erreur MAJ date événements:", error);
            }
        }
        
        function showEventNotificationDot() {
            const notificationDot = document.getElementById('events-notification-dot');
            if (notificationDot) {
                notificationDot.classList.add('active');
            }
            hasNewEvents = true;
        }
        
        function hideEventNotificationDot() {
            const notificationDot = document.getElementById('events-notification-dot');
            if (notificationDot) {
                notificationDot.classList.remove('active');
            }
            hasNewEvents = false;
        }

        async function loadInitialData() {
            try {
                await loadGroups();
                
                updateCreateButtonAppearance();
                
                await listenToEvents();
                
                await initCollections();
                
            } catch (error) {
                showNotification("Erreur lors du chargement des données", "error");
            }
        }
        
        function updateCreateButtonAppearance() {
            const createButton = document.getElementById('create-group-btn');
            if (!createButton) return;
            
            if (!isAdmin) {
                createButton.classList.add('disabled');
                createButton.title = "Seuls les administrateurs peuvent créer des groupes";
            } else {
                createButton.classList.remove('disabled');
                createButton.title = "Créer un nouveau groupe";
            }
        }
        
        // Correction du problème d'abonnement aux événements
        async function listenToEvents() {
            if (eventsUnsubscribe) {
                eventsUnsubscribe();
                eventsUnsubscribe = null;
            }
            
            if (isLoadingEvents) return;
            isLoadingEvents = true;
            
            try {
                const eventsRef = collection(db, "events");
                // On récupère tous les événements (pas seulement admin-notification)
                const q = query(
                    eventsRef, 
                    orderBy("timestamp", "desc"), 
                    limit(100)
                );
                
                eventsUnsubscribe = onSnapshot(q, async (snapshot) => {
                    const eventsList = document.getElementById('events-list');
                    if (!eventsList) return;
                    
                    eventsList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        eventsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-bell"></i>
                                <div class="empty-state-title">Aucun événement</div>
                                <div class="empty-state-text">Les événements apparaîtront ici</div>
                            </div>
                        `;
                        isLoadingEvents = false;
                        return;
                    }
                    
                    // Vérifier s'il y a de nouveaux événements
                    let hasNewerEvents = false;
                    if (lastViewedEventTimestamp) {
                        snapshot.forEach(doc => {
                            const eventData = doc.data();
                            if (eventData.timestamp && eventData.timestamp.toDate) {
                                const eventDate = eventData.timestamp.toDate();
                                if (eventDate > lastViewedEventTimestamp) {
                                    hasNewerEvents = true;
                                }
                            }
                        });
                    }
                    
                    if (hasNewerEvents && currentSection !== 'events') {
                        showEventNotificationDot();
                    }
                    
                    const fragment = document.createDocumentFragment();
                    
                    try {
                        // Filtrer pour n'afficher que les notifications admin
                        const adminNotifications = snapshot.docs.filter(doc => 
                            doc.data().type === 'admin-notification'
                        );
                        
                        if (adminNotifications.length === 0) {
                            eventsList.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-bell"></i>
                                    <div class="empty-state-title">Aucune notification</div>
                                    <div class="empty-state-text">Les notifications apparaîtront ici</div>
                                </div>
                            `;
                        } else {
                            for (const eventDoc of adminNotifications) {
                                const eventData = eventDoc.data();
                                const eventElement = await createEventElement(eventDoc.id, eventData);
                                fragment.appendChild(eventElement);
                            }
                            
                            eventsList.appendChild(fragment);
                        }
                    } catch (error) {
                        eventsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div class="empty-state-title">Erreur</div>
                                <div class="empty-state-text">Impossible de charger les événements</div>
                            </div>
                        `;
                    }
                    
                    isLoadingEvents = false;
                }, (error) => {
                    isLoadingEvents = false;
                    const eventsList = document.getElementById('events-list');
                    if (eventsList) {
                        eventsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div class="empty-state-title">Erreur</div>
                                <div class="empty-state-text">Impossible de se connecter aux événements</div>
                            </div>
                        `;
                    }
                });
                
            } catch (error) {
                isLoadingEvents = false;
                const eventsList = document.getElementById('events-list');
                if (eventsList) {
                    eventsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="empty-state-title">Erreur</div>
                            <div class="empty-state-text">Impossible de charger les événements</div>
                        </div>
                    `;
                }
            }
        }
        
        // Nouveau bouton de fermeture de notification
        async function createEventElement(eventId, eventData) {
            if (eventData.type === 'admin-notification') {
                return createAdminNotificationElement(eventId, eventData);
            }
            
            // Pour d'autres types d'événements (inutilisés actuellement)
            const eventItem = document.createElement('div');
            eventItem.className = `event-item ${eventData.type}`;
            eventItem.setAttribute('data-id', eventId);
            
            let formattedDate = '';
            if (eventData.timestamp) {
                if (eventData.timestamp.toDate) {
                    const date = eventData.timestamp.toDate();
                    formattedDate = formatDate(date);
                } else if (eventData.timestamp instanceof Date) {
                    formattedDate = formatDate(eventData.timestamp);
                }
            }
            
            let iconClass = 'fas fa-bell';
            let headerText = 'Événement';
            let contentText = 'Action effectuée dans l\'application';
            
            let userName = 'Utilisateur';
            if (eventData.userId) {
                try {
                    userName = await getDisplayNameFromId(eventData.userId);
                } catch (error) {
                    userName = 'Utilisateur';
                }
            }
            
            let actionButtons = '';
            if (isAdmin) {
                actionButtons = `
                    <div class="event-actions">
                        <button class="event-action-btn delete" data-id="${eventId}">
                            <i class="fas fa-trash-alt"></i> Supprimer
                        </button>
                    </div>
                `;
            }
            
            eventItem.innerHTML = `
                <div class="event-icon">
                    <i class="${iconClass}"></i>
                </div>
                <div class="item-content">
                    <div class="event-header">${headerText}</div>
                    <div class="event-content">${contentText}</div>
                    <div class="event-time">${formattedDate}</div>
                    ${actionButtons}
                </div>
            `;
            
            if (isAdmin) {
                const deleteBtn = eventItem.querySelector('.event-action-btn.delete');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();                        
                        showDeleteEventConfirmation(eventId);
                    });
                }
            }
            
            return eventItem;
        }
        
        function createAdminNotificationElement(eventId, eventData) {
            const notificationElement = document.createElement('div');
            notificationElement.className = 'admin-notification';
            notificationElement.setAttribute('data-id', eventId);
            
            const notificationType = eventData.notificationType || 'info';
            let iconClass = 'fas fa-info-circle';
            
            switch (notificationType) {
                case 'alert':
                    iconClass = 'fas fa-exclamation-triangle';
                    break;
                case 'update':
                    iconClass = 'fas fa-sync';
                    break;
                default:
                    iconClass = 'fas fa-info-circle';
            }
            
            let formattedDate = '';
            if (eventData.timestamp) {
                if (eventData.timestamp.toDate) {
                    const date = eventData.timestamp.toDate();
                    formattedDate = date.toLocaleString('fr-FR');
                } else if (eventData.timestamp instanceof Date) {
                    formattedDate = eventData.timestamp.toLocaleString('fr-FR');
                }
            }
            
            // Création de l'élément avec le nouveau bouton de fermeture
            notificationElement.innerHTML = `
                <div class="admin-notification-header">
                    <div class="admin-notification-title">
                        <i class="${iconClass}"></i> ${eventData.title || 'Notification'}
                    </div>
                </div>
                <div class="admin-notification-content">
                    ${eventData.content || 'Sans contenu'}
                </div>
                <div class="admin-notification-footer">
                    ${formattedDate}
                </div>
                <div class="event-close-btn" data-id="${eventId}">
                    <i class="fas fa-times"></i>
                </div>
            `;
            
            // Gestion du clic sur le bouton de fermeture
            const closeBtn = notificationElement.querySelector('.event-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (isAdmin) {
                        showDeleteEventConfirmation(eventId);
                    } else {
                        // Pour les utilisateurs non-admin, on cache simplement la notification dans l'UI
                        notificationElement.style.display = 'none';
                    }
                });
            }
            
            return notificationElement;
        }
        
        function formatDate(date) {
            if (!date) return '';
            
            try {
                const now = new Date();
                const diffMs = now - date;
                const diffSec = Math.floor(diffMs / 1000);
                const diffMin = Math.floor(diffSec / 60);
                const diffHour = Math.floor(diffMin / 60);
                const diffDay = Math.floor(diffHour / 24);
                
                if (diffSec < 60) {
                    return 'À l\'instant';
                } else if (diffMin < 60) {
                    return `Il y a ${diffMin} minute${diffMin > 1 ? 's' : ''}`;
                } else if (diffHour < 24) {
                    return `Il y a ${diffHour} heure${diffHour > 1 ? 's' : ''}`;
                } else if (diffDay < 30) {
                    return `Il y a ${diffDay} jour${diffDay > 1 ? 's' : ''}`;
                } else {
                    return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                }
            } catch (error) {
                return '';
            }
        }
        
        async function getUserData(uid) {
            try {
                const userRef = doc(db, "Users", uid);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    return { id: userSnap.id, ...userSnap.data() };
                } else {
                    return null;
                }
            } catch (error) {
                return null;
            }
        }
        
        function updateProfileInfo() {
            if (currentUserData) {
                const profileNameText = document.getElementById('profile-name-text');
                const profileEmail = document.getElementById('profile-email');
                
                if (profileNameText) {
                    profileNameText.textContent = currentUserData.displayName || currentUserData.email.split('@')[0];
                }
                
                if (profileEmail) {
                    profileEmail.textContent = currentUserData.email;
                }
                
                if (currentUserData.photoURL) {
                    const profilePic = document.querySelector('.profile-header .profile-pic');
                    if (profilePic) {
                        profilePic.innerHTML = `
                            <img src="${currentUserData.photoURL}" alt="Profile">
                            <div class="profile-pic-edit" id="edit-profile-pic">
                                <i class="fas fa-pencil-alt"></i>
                            </div>
                        `;
                        
                        const editProfilePic = document.getElementById('edit-profile-pic');
                        if (editProfilePic) {
                            editProfilePic.addEventListener('click', showProfileEditDialog);
                        }
                    }
                }
                
                const adminBadge = document.getElementById('admin-badge');
                if (adminBadge) {
                    if (currentUserData.statut === 'admin') {
                        adminBadge.style.display = 'inline-block';
                    } else {
                        adminBadge.style.display = 'none';
                    }
                }
            }
        }
        
        function showLogoutConfirmation() {
            document.getElementById('logout-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        function hideLogoutConfirmation() {
            document.getElementById('logout-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        async function logoutUser() {
            hideLogoutConfirmation();
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').querySelector('div:nth-child(3)').innerText = 'Déconnexion...';
            
            try {
                Object.keys(chatUnsubscribers).forEach(groupId => {
                    if (chatUnsubscribers[groupId]) {
                        chatUnsubscribers[groupId]();
                    }
                });
                chatUnsubscribers = {};
                
                if (eventsUnsubscribe) {
                    eventsUnsubscribe();
                    eventsUnsubscribe = null;
                }
                
                if (forecastsUnsubscribe) {
                    forecastsUnsubscribe();
                    forecastsUnsubscribe = null;
                }
                
                await signOut(auth);
                
                isLoggedIn = false;
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                currentGroup = '';
                currentGroupId = null;
                currentGroupData = null;
                chatImageFile = null;
                
                // Réinitialisation des champs de formulaire
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';
                document.getElementById('register-confirm-password').value = '';
                
                // Cacher les messages d'erreur
                document.getElementById('login-email-error').style.display = 'none';
                document.getElementById('login-password-error').style.display = 'none';
                document.getElementById('register-email-error').style.display = 'none';
                document.getElementById('register-password-error').style.display = 'none';
                document.getElementById('register-confirm-password-error').style.display = 'none';
                
                // Cacher les logs
                hideLog('login-log');
                hideLog('register-log');
                
                // S'assurer que les boutons de connexion et d'inscription sont réinitialisés
                const loginBtn = document.getElementById('loginBtn');
                const registerBtn = document.getElementById('registerBtn');
                if (loginBtn) {
                    loginBtn.classList.remove('loading');
                    loginBtn.querySelector('.btn-loader').style.display = 'none';
                    loginBtn.querySelector('.btn-text').style.visibility = 'visible';
                }
                if (registerBtn) {
                    registerBtn.classList.remove('loading');
                    registerBtn.querySelector('.btn-loader').style.display = 'none';
                    registerBtn.querySelector('.btn-text').style.visibility = 'visible';
                }
                
                showLoginScreen();
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showNotification("Erreur lors de la déconnexion", "error");
            }
        }
        
        async function openGroup(groupName, groupId) {
            if (!groupName || !groupId) return;
            
            hideSearchBar();
            
            unsubscribeFromCurrentChat();
            
            currentGroup = groupName;
            currentGroupId = groupId;
            
            try {
                const groupRef = doc(db, "groups", groupId);
                const groupSnap = await getDoc(groupRef);
                
                if (groupSnap.exists()) {
                    currentGroupData = groupSnap.data();
                } else {
                    showNotification("Groupe introuvable", "error");
                    return;
                }
            } catch (error) {
                showNotification("Erreur lors de l'ouverture du groupe", "error");
                return;
            }
            
            document.getElementById('bottom-nav').style.display = 'none';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            const isGroupAdmin = isAdmin || (currentGroupData && currentGroupData.admins && currentGroupData.admins.includes(currentUser.uid));
            
            document.getElementById('header-menu-button').style.display = 'none';
            document.getElementById('header-back-button').style.display = 'block';
            
            if (isGroupAdmin) {
                document.getElementById('header-action').innerHTML = `
                    <span class="notification-icon" id="edit-group-btn" style="padding: 8px; border-radius: 50%; cursor: pointer;">
                        <i class="fas fa-cog"></i>
                    </span>
                `;
                
                const editBtn = document.getElementById('edit-group-btn');
                editBtn.addEventListener('click', () => {
                    showEditGroupDialog(currentGroupId, currentGroupData);
                });
            } else {
                document.getElementById('header-action').innerHTML = '';
            }
            
            updateGroupHeader();
            
            document.getElementById('header-back-button').addEventListener('click', closeChat);
            
            document.getElementById('chat-interface').style.display = 'block';
            
            // Réinitialiser l'état de l'image
            chatImageFile = null;
            document.getElementById('image-button').style.color = 'var(--primary-color)';
            document.getElementById('chat-input').placeholder = 'Écrire un message...';
            
            checkSendPermissions();
            
            loadGroupMessages(groupId);
        }
        
        function checkSendPermissions() {
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const imageButton = document.getElementById('image-button');
            const chatInputContainer = document.getElementById('chat-input-container');
            
            if (!chatInput || !sendButton || !imageButton || !chatInputContainer) return;
            
            let canSend = true;
            let restrictionReason = '';
            
            if (currentGroupData && currentGroupData.allowPublicMessages === false) {
                if (!currentGroupData.admins || !currentGroupData.admins.includes(currentUser.uid)) {
                    canSend = false;
                    restrictionReason = 'Seuls les administrateurs peuvent envoyer des messages dans ce groupe.';
                }
            }
            
            if (!canSend) {
                chatInput.disabled = true;
                chatInput.placeholder = "Vous ne pouvez pas écrire dans ce groupe";
                sendButton.disabled = true;
                imageButton.disabled = true;
                imageButton.style.color = 'var(--inactive-text)';
                
                if (!document.querySelector('.restricted-message')) {
                    const restrictedMsg = document.createElement('div');
                    restrictedMsg.className = 'restricted-message';
                    restrictedMsg.textContent = restrictionReason;
                    chatInputContainer.insertAdjacentElement('beforebegin', restrictedMsg);
                }
            } else {
                chatInput.disabled = false;
                chatInput.placeholder = "Écrire un message...";
                sendButton.disabled = false;
                imageButton.disabled = false;
                imageButton.style.color = 'var(--primary-color)';
                
                const restrictedMsg = document.querySelector('.restricted-message');
                if (restrictedMsg) {
                    restrictedMsg.remove();
                }
            }
        }
        
        function closeChat() {
            unsubscribeFromCurrentChat();
            
            document.getElementById('bottom-nav').style.display = 'flex';
            
            document.getElementById('chat-interface').style.display = 'none';
            
            document.getElementById('header-title').innerText = 'Groupes';
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="events-button" id="events-button">
                    <i class="fas fa-bell"></i>
                    <div class="notification-dot" id="events-notification-dot"></div>
                </div>
            `;
            
            if (hasNewEvents) {
                document.getElementById('events-notification-dot').classList.add('active');
            }
            
            // Réattacher les gestionnaires d'événements
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });
            
            document.getElementById('groups-section').classList.add('active');
            currentSection = 'groups';
            
            currentGroup = '';
            currentGroupId = null;
            currentGroupData = null;
            chatImageFile = null;
        }
        
        function unsubscribeFromCurrentChat() {
            if (currentGroupId && chatUnsubscribers[currentGroupId]) {
                chatUnsubscribers[currentGroupId]();
                delete chatUnsubscribers[currentGroupId];
            }
        }
        
        function loadGroupMessages(groupId) {
            if (!groupId) return;
            
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = '';
            
            messagesContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--inactive-text);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                    <div style="margin-top: 10px;">Chargement des messages...</div>
                </div>
            `;
            
            try {
                const messagesRef = collection(db, "groups", groupId, "messages");
                const q = query(messagesRef, orderBy("createdAt", "asc"));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    messagesContainer.innerHTML = '';
                    
                    if (snapshot.empty) {
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--inactive-text);">
                                Aucun message. ${currentGroupData && currentGroupData.allowPublicMessages === false && 
                                    (!currentGroupData.admins || !currentGroupData.admins.includes(currentUser.uid)) ? 
                                    'Seuls les administrateurs peuvent écrire dans ce groupe.' : 
                                    'Soyez le premier à écrire dans ce groupe !'}
                            </div>
                        `;
                        return;
                    }
                    
                    const fragment = document.createDocumentFragment();
                    
                    try {
                        snapshot.forEach(doc => {
                            const messageData = doc.data();
                            const messageId = doc.id;
                            
                            const fromMe = messageData.senderId === currentUser.uid;
                            
                            const messageElement = createMessageElement(
                                messageId, 
                                messageData, 
                                fromMe
                            );
                            
                            fragment.appendChild(messageElement);
                        });
                        
                        messagesContainer.appendChild(fragment);
                        
                        scrollToBottom();
                    } catch (error) {
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                                <i class="fas fa-exclamation-circle" style="font-size: 24px;"></i>
                                <div style="margin-top: 10px;">Erreur lors de l'affichage des messages</div>
                            </div>
                        `;
                    }
                }, (error) => {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                            <i class="fas fa-exclamation-circle" style="font-size: 24px;"></i>
                            <div style="margin-top: 10px;">Erreur de chargement des messages</div>
                        </div>
                    `;
                });
                
                chatUnsubscribers[groupId] = unsubscribe;
                
            } catch (error) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                        <i class="fas fa-exclamation-circle" style="font-size: 24px;"></i>
                        <div style="margin-top: 10px;">Erreur lors du chargement des messages</div>
                    </div>
                `;
            }
        }
        
        function createMessageElement(messageId, messageData, fromMe) {
            try {
                // Créer le conteneur parent pour le message et les métadonnées
                const messageContainer = document.createElement('div');
                messageContainer.className = fromMe ? 'message-container sent' : 'message-container received';
                
                // Ajouter le nom de l'expéditeur au-dessus du message (pas dans la bulle)
                if (!fromMe) {
                    const senderName = document.createElement('div');
                    senderName.className = `message-sender sender-${messageData.senderId}`;
                    
                    getDisplayNameFromId(messageData.senderId).then(name => {
                        senderName.textContent = name;
                    }).catch(error => {
                        senderName.textContent = "Utilisateur";
                    });
                    
                    messageContainer.appendChild(senderName);
                }
                
                // Déterminer si c'est un message avec image
                const hasImage = messageData.imageData && typeof messageData.imageData === 'string';
                
                // Créer la bulle de message
                const messageDiv = document.createElement('div');
                
                if (hasImage) {
                    messageDiv.className = 'message message-with-image';
                    
                    const imageElement = document.createElement('img');
                    imageElement.className = 'message-image';
                    imageElement.src = messageData.imageData;
                    imageElement.alt = 'Image';
                    imageElement.loading = 'lazy';
                    
                    // Ajouter le gestionnaire pour ouvrir l'image en grand
                    imageElement.addEventListener('click', () => {
                        showImageViewer(messageData.imageData);
                    });
                    
                    messageDiv.appendChild(imageElement);
                    
                    if (messageData.text && messageData.text.trim() !== '') {
                        const textDiv = document.createElement('div');
                        textDiv.className = 'message-text';
                        textDiv.textContent = messageData.text;
                        messageDiv.appendChild(textDiv);
                    }
                } else {
                    // Message texte standard
                    messageDiv.className = fromMe ? 'message message-sent' : 'message message-received';
                    messageDiv.textContent = messageData.text || "";
                }
                
                messageDiv.setAttribute('data-id', messageId);
                messageDiv.setAttribute('data-from', messageData.senderId || 'unknown');
                
                messageContainer.appendChild(messageDiv);
                
                // Ajouter l'horodatage sous la bulle
                const messageTime = document.createElement('div');
                messageTime.className = 'message-time';
                
                if (messageData.createdAt) {
                    if (messageData.createdAt.toDate) {
                        const date = messageData.createdAt.toDate();
                        messageTime.textContent = `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                    } else if (messageData.createdAt instanceof Date) {
                        messageTime.textContent = `${messageData.createdAt.getHours()}:${messageData.createdAt.getMinutes().toString().padStart(2, '0')}`;
                    } else {
                        messageTime.textContent = messageData.createdAt;
                    }
                } else {
                    messageTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                
                messageContainer.appendChild(messageTime);
                
                return messageContainer;
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message-container';
                const errorMsg = document.createElement('div');
                errorMsg.className = fromMe ? 'message message-sent' : 'message message-received';
                errorMsg.textContent = "Erreur d'affichage du message";
                errorDiv.appendChild(errorMsg);
                return errorDiv;
            }
        }
        
        function scrollToBottom() {
            try {
                const chatMessagesContainer = document.querySelector('.chat-messages-container');
                if (chatMessagesContainer) {
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                }
            } catch (error) {
                console.error("Erreur défilement:", error);
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            if (!input) return;
            
            const message = input.value.trim();
            
            if ((!message || message === '') && !chatImageFile) {
                return; // Ne pas envoyer de message vide sans image
            }
            
            if (!currentGroupId) return;
            
            if (currentGroupData && currentGroupData.allowPublicMessages === false) {
                if (!currentGroupData.admins || !currentGroupData.admins.includes(currentUser.uid)) {
                    showNotification("Vous n'avez pas la permission d'envoyer des messages dans ce groupe", "error");
                    return;
                }
            }
            
            input.value = '';
            
            try {
                const hasImage = chatImageFile !== null;
                
                // Ajout d'un message avec image à l'UI
                if (hasImage) {
                    addPendingImageMessageToUI(chatImageFile, message);
                } else {
                    addPendingMessageToUI(message);
                }
                
                scrollToBottom();
                
                // Réinitialiser l'état de l'image
                const imageButton = document.getElementById('image-button');
                if (imageButton) {
                    imageButton.style.color = 'var(--primary-color)';
                }
                document.getElementById('chat-input').placeholder = 'Écrire un message...';
                
                if (isOnline) {
                    await sendMessageToFirestore(currentGroupId, message, chatImageFile);
                    chatImageFile = null; // Réinitialiser après l'envoi
                } else {
                    messageQueue.push({
                        groupId: currentGroupId,
                        text: message,
                        imageData: chatImageFile
                    });
                    
                    showNotification("Vous êtes hors ligne. Le message sera envoyé lorsque vous serez connecté.", "info");
                    chatImageFile = null;
                }
                
            } catch (error) {
                showNotification("Erreur lors de l'envoi du message", "error");
                chatImageFile = null;
            }
        }
        
        function addPendingMessageToUI(text) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            try {
                const messageContainer = document.createElement('div');
                messageContainer.className = 'message-container sent';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-sent';
                
                const messageText = document.createElement('div');
                messageText.textContent = text;
                messageDiv.appendChild(messageText);
                
                messageContainer.appendChild(messageDiv);
                
                const messageTime = document.createElement('div');
                messageTime.className = 'message-time';
                messageTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                messageContainer.appendChild(messageTime);
                
                messagesContainer.appendChild(messageContainer);
            } catch (error) {
                console.error("Erreur ajout message UI:", error);
            }
        }
        
        function addPendingImageMessageToUI(imageData, text) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            try {
                const messageContainer = document.createElement('div');
                messageContainer.className = 'message-container sent';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-with-image';
                
                const imageElement = document.createElement('img');
                imageElement.className = 'message-image';
                imageElement.src = imageData;
                imageElement.alt = 'Image';
                messageDiv.appendChild(imageElement);
                
                if (text && text.trim() !== '') {
                    const textDiv = document.createElement('div');
                    textDiv.className = 'message-text';
                    textDiv.textContent = text;
                    messageDiv.appendChild(textDiv);
                }
                
                messageContainer.appendChild(messageDiv);
                
                const messageTime = document.createElement('div');
                messageTime.className = 'message-time';
                messageTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                messageContainer.appendChild(messageTime);
                
                messagesContainer.appendChild(messageContainer);
                
                // Ajouter le gestionnaire d'événements pour ouvrir l'image
                imageElement.addEventListener('click', () => {
                    showImageViewer(imageData);
                });
            } catch (error) {
                console.error("Erreur ajout message image UI:", error);
            }
        }
        
        async function sendMessageToFirestore(groupId, text, imageData = null) {
            if (!groupId) return;
            
            try {
                const groupRef = doc(db, "groups", groupId);
                const messagesRef = collection(db, "groups", groupId, "messages");
                
                const messageData = {
                    text: text || "",
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp()
                };
                
                // Ajouter l'image si présente
                if (imageData) {
                    messageData.imageData = imageData;
                }
                
                const docRef = await addDoc(messagesRef, messageData);
                
                await updateDoc(groupRef, {
                    lastMessage: imageData ? (text ? "📷 " + text : "📷 Image") : text,
                    lastMessageTime: serverTimestamp(),
                    lastSenderId: currentUser.uid
                });
                
                return docRef.id;
            } catch (error) {
                throw error;
            }
        }
        
        function showLoginScreen() {
            document.getElementById('auth-screen').style.opacity = '0';
            document.getElementById('auth-screen').style.display = 'flex';
            
            setTimeout(() => {
                document.getElementById('auth-screen').style.opacity = '1';
                document.getElementById('auth-screen').style.transition = 'opacity 0.5s ease';
            }, 10);
            
            document.getElementById('bottom-nav').style.display = 'none';
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.content').style.display = 'none';
            
            document.getElementById('loading').style.display = 'none';
            
            document.body.style.overflow = 'auto';
            
        }
        
        function setupAuthObserver() {
            const verifyAnimation = document.getElementById('verify-animation');
            verifyAnimation.style.display = 'flex';
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    
                    setTimeout(() => {
                        verifyAnimation.style.display = 'none';
                        
                        document.getElementById('auth-screen').style.display = 'none';
                        
                        completeLogin();
                    }, 1500);
                } else {
                    setTimeout(() => {
                        verifyAnimation.style.display = 'none';
                        showLoginScreen();
                    }, 1500);
                }
            });
        }
        
        async function getDisplayNameFromId(userId) {
            if (!userId) return 'Utilisateur';
            
            if (userId === currentUser.uid) {
                return 'Vous';
            }
            
            try {
                const userRef = doc(db, "Users", userId);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    return userData.displayName || userData.email.split('@')[0];
                }
            } catch (error) {
                console.error("Erreur nom utilisateur:", error);
            }
            
            return 'Utilisateur';
        }
        
        // Correction du problème pour les utilisateurs non-admins qui cliquent sur l'icône de groupe
        async function loadGroups() {
            const groupsList = document.getElementById('groups-list');
            if (!groupsList) return;
            
            if (isLoadingGroups) return;
            isLoadingGroups = true;
            
            try {
                if (!currentUser) {
                    isLoadingGroups = false;
                    return;
                }
                
                groupsList.innerHTML = `
                    <div class="empty-state" style="padding: 20px; text-align: center;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                        <div class="empty-state-title">Chargement</div>
                        <div class="empty-state-text">Récupération des groupes...</div>
                    </div>
                `;
                
                const groupsRef = collection(db, "groups");
                const q = query(
                    groupsRef,
                    where("members", "array-contains", currentUser.uid),
                    orderBy("lastMessageTime", "desc")
                );
                
                const querySnapshot = await getDocs(q);
                
                groupsList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    groupsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <div class="empty-state-title">Aucun groupe</div>
                            <div class="empty-state-text">${isAdmin ? 
                                'Créez un nouveau groupe en appuyant sur le bouton +' : 
                                'Aucun groupe disponible pour le moment'}</div>
                        </div>
                    `;
                    isLoadingGroups = false;
                    return;
                }
                
                const fragment = document.createDocumentFragment();
                
                for (const groupDoc of querySnapshot.docs) {
                    const groupData = groupDoc.data();
                    
                    let lastMessage = "Aucun message";
                    let lastSenderId = null;
                    let lastMessageTime = null;
                    
                    try {
                        const messagesRef = collection(db, "groups", groupDoc.id, "messages");
                        const messagesQuery = query(messagesRef, orderBy("createdAt", "desc"), limit(1));
                        const messagesSnapshot = await getDocs(messagesQuery);
                        
                        if (!messagesSnapshot.empty) {
                            const lastMessageDoc = messagesSnapshot.docs[0];
                            const messageData = lastMessageDoc.data();
                            lastMessage = messageData.text || "Image";
                            
                            // Si le message a une image, ajouter une icône
                            if (messageData.imageData) {
                                lastMessage = messageData.text ? `📷 ${messageData.text}` : "📷 Image";
                            }
                            
                            lastSenderId = messageData.senderId;
                            lastMessageTime = messageData.createdAt;
                        }
                    } catch (error) {
                        console.error("Erreur derniers messages:", error);
                    }
                    
                    const groupItem = document.createElement('div');
                    groupItem.className = 'chat-item';
                    groupItem.setAttribute('data-group', groupData.name);
                    groupItem.setAttribute('data-id', groupDoc.id);
                    
                    const isRestricted = groupData.allowPublicMessages === false;
                    
                    const isGroupAdmin = isAdmin || (groupData.admins && groupData.admins.includes(currentUser.uid));
                    
                    let lastMessageText = lastMessage;
                    try {
                        if (lastSenderId) {
                            if (lastSenderId === currentUser.uid) {
                                lastMessageText = `Vous: ${lastMessage}`;
                            } else {
                                const senderName = await getDisplayNameFromId(lastSenderId);
                                lastMessageText = `${senderName}: ${lastMessage}`;
                            }
                        }
                    } catch (error) {
                        console.error("Erreur texte message:", error);
                    }
                    
                    let timeDisplay = '';
                    if (lastMessageTime) {
                        if (lastMessageTime.toDate) {
                            const date = lastMessageTime.toDate();
                            timeDisplay = `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                        } else if (lastMessageTime instanceof Date) {
                            timeDisplay = `${lastMessageTime.getHours()}:${lastMessageTime.getMinutes().toString().padStart(2, '0')}`;
                        } else {
                            timeDisplay = lastMessageTime;
                        }
                    }
                    
                    // Création des éléments DOM pour une structure plus propre
                    const groupPic = document.createElement('div');
                    groupPic.className = 'group-pic';
                    
                    if (groupData.imageURL) {
                        groupPic.innerHTML = `<img src="${groupData.imageURL}" alt="${groupData.name}">`;
                    } else {
                        groupPic.innerHTML = `<i class="fas fa-users" style="color: white;"></i>`;
                    }
                    
                    // Ajouter le bouton d'édition seulement pour les admins
                    if (isGroupAdmin) {
                        const editButton = document.createElement('div');
                        editButton.className = 'group-pic-edit';
                        editButton.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                        
                        // Gestion distincte du clic sur l'icône d'édition
                        editButton.addEventListener('click', (e) => {
                            e.stopPropagation(); // Crucial pour éviter la propagation du clic
                            showEditGroupDialog(groupDoc.id, groupData);
                        });
                        
                        groupPic.appendChild(editButton);
                    }
                    
                    const itemContent = document.createElement('div');
                    itemContent.className = 'item-content';
                    
                    itemContent.innerHTML = `
                        <div style="display: flex; justify-content: space-between;">
                            <div class="item-title">
                                ${groupData.name}
                                ${isRestricted ? '<span class="restricted-badge">Restreint</span>' : ''}
                            </div>
                            <div class="item-time">${timeDisplay || ''}</div>
                        </div>
                        <div class="item-subtitle">${lastMessageText}</div>
                    `;
                    
                    groupItem.appendChild(groupPic);
                    groupItem.appendChild(itemContent);
                    
                    // Gestion du clic sur l'élément de groupe (pas sur le bouton d'édition)
                    groupItem.addEventListener('click', () => {
                        // Simplement ouvrir le groupe, le handler spécifique pour le bouton d'édition
                        // interceptera ses propres clics
                        openGroup(groupData.name, groupDoc.id);
                    });
                    
                    fragment.appendChild(groupItem);
                }
                
                groupsList.appendChild(fragment);
                
            } catch (error) {
                groupsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="empty-state-title">Erreur de chargement</div>
                        <div class="empty-state-text">Impossible de charger les groupes. Veuillez réessayer.</div>
                    </div>
                `;
                showNotification("Erreur lors du chargement des groupes", "error");
            } finally {
                isLoadingGroups = false;
            }
        }

        function showDeleteEventConfirmation(eventId) {
            currentEventForDeletion = eventId;
            document.getElementById('delete-event-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
                function hideDeleteEventConfirmation() {
            document.getElementById('delete-event-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            currentEventForDeletion = null;
        }
        
        async function confirmDeleteEvent() {
            if (!currentEventForDeletion) {
                hideDeleteEventConfirmation();
                return;
            }
            
            try {
                await deleteDoc(doc(db, "events", currentEventForDeletion));
                showNotification('Événement supprimé', 'success');            
            } finally {
                hideDeleteEventConfirmation();
            }
        }
        
        function showDeleteAccountConfirmation() {
            document.getElementById('delete-account-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        function hideDeleteAccountConfirmation() {
            document.getElementById('delete-account-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        async function deleteAccount() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').querySelector('div:nth-child(3)').innerText = 'Suppression du compte...';
            
            try {
                Object.keys(chatUnsubscribers).forEach(groupId => {
                    if (chatUnsubscribers[groupId]) {
                        chatUnsubscribers[groupId]();
                    }
                });
                chatUnsubscribers = {};
                
                if (eventsUnsubscribe) {
                    eventsUnsubscribe();
                    eventsUnsubscribe = null;
                }
                
                if (forecastsUnsubscribe) {
                    forecastsUnsubscribe();
                    forecastsUnsubscribe = null;
                }
                
                const userRef = doc(db, "Users", currentUser.uid);
                await deleteDoc(userRef);
                
                const groupsRef = collection(db, "groups");
                const groupsQuery = query(groupsRef, where("members", "array-contains", currentUser.uid));
                const groupsSnapshot = await getDocs(groupsQuery);
                
                for (const groupDoc of groupsSnapshot.docs) {
                    const groupData = groupDoc.data();
                    
                    await updateDoc(doc(db, "groups", groupDoc.id), {
                        members: arrayRemove(currentUser.uid)
                    });
                    
                    if (groupData.admins && groupData.admins.includes(currentUser.uid)) {
                        await updateDoc(doc(db, "groups", groupDoc.id), {
                            admins: arrayRemove(currentUser.uid)
                        });
                    }
                }
                
                await deleteUser(currentUser);
                
                hideDeleteAccountConfirmation();
                
                isLoggedIn = false;
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                
                const loadingText = document.getElementById('loading').querySelector('div:nth-child(3)');
                loadingText.innerText = 'Compte supprimé avec succès';
                
                setTimeout(() => {
                    showLoginScreen();
                }, 2000);
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showNotification('Erreur lors de la suppression du compte', 'error');
                hideDeleteAccountConfirmation();
            }
        }

        function showAdminNotificationDialog() {
            document.getElementById('notif-title').value = '';
            document.getElementById('notif-content').value = '';
            document.getElementById('notif-type').value = 'info';
            
            document.getElementById('notif-title-error').style.display = 'none';
            document.getElementById('notif-content-error').style.display = 'none';
            
            document.getElementById('admin-notif-dialog').classList.add('active');
            document.getElementById('notif-title').focus();
        }
        
        function hideAdminNotificationDialog() {
            document.getElementById('admin-notif-dialog').classList.remove('active');
        }
        
        async function sendAdminNotification() {
            const title = document.getElementById('notif-title').value.trim();
            const content = document.getElementById('notif-content').value.trim();
            const type = document.getElementById('notif-type').value;
            
            let isValid = true;
            
            if (!title) {
                document.getElementById('notif-title-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('notif-title-error').style.display = 'none';
            }
            
            if (!content) {
                document.getElementById('notif-content-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('notif-content-error').style.display = 'none';
            }
            
            if (!isValid) return;
            
            setButtonLoading('send-notification-btn', true);
            
            try {
                await addDoc(collection(db, "events"), {
                    type: 'admin-notification',
                    title: title,
                    content: content,
                    notificationType: type,
                    userId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                
                setButtonLoading('send-notification-btn', false);
                
                hideAdminNotificationDialog();
                
                showNotification('Notification envoyée avec succès', 'success');
            } catch (error) {
                showNotification("Erreur lors de l'envoi de la notification", "error");
                setButtonLoading('send-notification-btn', false);
            }
        }

        // Enregistrement du service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker enregistré avec succès:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Échec de l\'enregistrement du Service Worker:', error);
                    });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            try {
                setupUIEvents();
                
                setupAuthEvents();
                
                setupDarkMode();
                
                setupConnectionMonitoring();
                
                setupAuthObserver();
                
                const savedDarkMode = localStorage.getItem('groupChatDarkMode');
                if (savedDarkMode !== null) {
                    const isDarkMode = savedDarkMode === 'true';
                    document.getElementById('dark-toggle').checked = isDarkMode;
                    if (isDarkMode) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                } else {
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        document.documentElement.classList.add('dark');
                        document.getElementById('dark-toggle').checked = true;
                    }
                }
                
            } catch (error) {
                console.error("Erreur initiale:", error);
            }
        });
    </script>
</body>
</html>

