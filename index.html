<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChatXchange</title>
    
    <!-- PWA Meta Tags pour iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChatXchange">
    <meta name="theme-color" content="#5D5CDE">
    
    <!-- Bootstrap 4.6 CSS (plus compatible avec iOS 12) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    
    <!-- FontAwesome 5 (bien supporté par iOS 12) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* Variables CSS pour iOS 12 (avec fallbacks) */
        :root {
            --primary-color: #5D5CDE;
            --primary-dark: #4a49b3;
            --primary-light: #7a79e8;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --white: #ffffff;
            --light-gray: #e9ecef;
            --dark-gray: #495057;
            --body-bg: #f4f6f9;
            --body-color: #212529;
        }
        
        /* Styles de base */
        html, body {
            height: 100%;
            -webkit-overflow-scrolling: touch;
            padding: 0;
            margin: 0;
            background-color: #f4f6f9;
            color: #212529;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Fix pour éviter le zoom sur les inputs dans iOS */
        input, textarea, select, button {
            font-size: 16px !important;
        }
        
        /* Conteneur principal */
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            height: 100%;
            position: relative;
            background-color: #ffffff;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Header */
        .app-header {
            background: linear-gradient(135deg, #5D5CDE, #4a49b3);
            color: white;
            padding: 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            z-index: 1030;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 0;
        }
        
        .back-button {
            background: none;
            border: none;
            color: white;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Contenu principal */
        .app-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-top: 60px;
            padding-bottom: 60px;
            height: 100%;
        }
        
        /* Nav bar bottom */
        .app-navbar {
            background-color: white;
            border-top: 1px solid #dee2e6;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            z-index: 1030;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            color: #6c757d;
            padding: 8px 0;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .nav-item.active {
            color: #5D5CDE;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        /* Authentication form */
        .auth-container {
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-logo h1 {
            color: #5D5CDE;
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .auth-card {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px 5px;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
        }
        
        .auth-tab.active {
            color: #5D5CDE;
            border-bottom: 2px solid #5D5CDE;
        }
        
        /* Styles pour les listes */
        .list-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            background-color: #ffffff;
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5D5CDE, #4a49b3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin-right: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .status-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
            border: 2px solid #fff;
        }
        
        .status-dot.online {
            background-color: #28a745;
        }
        
        .item-content {
            flex: 1;
            overflow: hidden;
        }
        
        .item-title {
            font-weight: 600;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
        }
        
        .item-subtitle {
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }
        
        .item-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-left: 10px;
        }
        
        .item-time {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .badge-counter {
            background-color: #5D5CDE;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            padding: 0 5px;
        }
        
        /* Chat styles */
        .chat-messages {
            padding: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .message-date {
            text-align: center;
            margin: 15px 0;
            position: relative;
        }
        
        .message-date:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background-color: #dee2e6;
            z-index: -1;
        }
        
        .message-date span {
            background-color: #f4f6f9;
            padding: 0 10px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .message-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .message-group.sent {
            align-items: flex-end;
        }
        
        .message-group.received {
            align-items: flex-start;
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 2px;
            position: relative;
            word-break: break-word;
        }
        
        .message-sent {
            background-color: #5D5CDE;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-received {
            background-color: #f1f1f1;
            color: #212529;
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 11px;
            text-align: right;
            margin-top: 2px;
            opacity: 0.7;
        }
        
        .message-status {
            display: inline-flex;
            margin-left: 4px;
        }
        
        .message-image {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .chat-input-container {
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            padding: 10px 15px;
            background-color: #ffffff;
            border-top: 1px solid #dee2e6;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .chat-input-wrapper {
            display: flex;
            align-items: center;
            background-color: #f1f1f1;
            border-radius: 24px;
            padding: 5px 10px;
        }
        
        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px;
            outline: none;
        }
        
        .chat-input:focus {
            outline: none;
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: #6c757d;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-send {
            color: #5D5CDE;
        }
        
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            margin: 10px 0;
            position: relative;
        }
        
        .btn-remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Profile styles */
        .profile-header {
            background: linear-gradient(135deg, #5D5CDE, #4a49b3);
            color: white;
            padding: 30px 15px;
            text-align: center;
            position: relative;
            margin-bottom: 60px;
        }
        
        .profile-avatar-container {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5D5CDE, #4a49b3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 30px;
            border: 4px solid white;
            position: relative;
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-card {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .profile-card-title {
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
        }
        
        .profile-card-title i {
            margin-right: 10px;
            color: #5D5CDE;
        }
        
        .profile-field {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .profile-field:last-child {
            border-bottom: none;
        }
        
        .profile-field-label {
            width: 100px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .profile-field-value {
            flex: 1;
        }
        
        .editable-field {
            cursor: pointer;
        }
        
        .editable-field:after {
            content: '\f044';
            font-family: 'Font Awesome 5 Free';
            font-weight: 400;
            margin-left: 5px;
            font-size: 12px;
            color: #6c757d;
            opacity: 0.5;
        }
        
        /* Utilitaires */
        .btn-primary-custom {
            background-color: #5D5CDE;
            border-color: #5D5CDE;
        }
        
        .btn-primary-custom:hover,
        .btn-primary-custom:focus,
        .btn-primary-custom:active {
            background-color: #4a49b3;
            border-color: #4a49b3;
        }
        
        .text-primary-custom {
            color: #5D5CDE;
        }
        
        .bg-primary-custom {
            background-color: #5D5CDE;
        }
        
        .floating-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #5D5CDE;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1020;
        }
        
        /* État vide */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        
        .empty-icon {
            font-size: 50px;
            color: #dee2e6;
            margin-bottom: 15px;
        }
        
        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .empty-text {
            color: #6c757d;
            max-width: 250px;
            margin: 0 auto;
        }
        
        /* Notifications */
        .toast-container {
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 1050;
        }
        
        .toast-notification {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            max-width: 80%;
            text-align: center;
            animation: fadeInOut 3s forwards;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
        
        /* Modal personnalisé */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1060;
        }
        
        .modal-dialog {
            width: 90%;
            max-width: 350px;
            margin: 0 auto;
        }
        
        /* Support compatibilité dark mode de manière simplifiée */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #212529;
                color: #f8f9fa;
            }
            
            .app-container {
                background-color: #343a40;
            }
            
            .app-navbar {
                background-color: #343a40;
                border-top-color: #495057;
            }
            
            .list-item {
                background-color: #343a40;
                border-bottom-color: #495057;
            }
            
            .item-subtitle {
                color: #adb5bd;
            }
            
            .auth-card {
                background-color: #343a40;
            }
            
            .chat-input-container {
                background-color: #343a40;
                border-top-color: #495057;
            }
            
            .chat-input-wrapper {
                background-color: #495057;
            }
            
            .message-received {
                background-color: #495057;
                color: #f8f9fa;
            }
            
            .profile-card {
                background-color: #343a40;
            }
            
            .empty-icon {
                color: #495057;
            }
            
            .message-date span {
                background-color: #212529;
            }
        }
        
        /* iOS fixes */
        @supports (-webkit-overflow-scrolling: touch) {
            input, textarea {
                -webkit-appearance: none;
                border-radius: 0;
            }
            
            html, body {
                height: 100%;
                overflow: hidden;
            }
            
            .app-content {
                overflow-y: scroll;
                -webkit-overflow-scrolling: touch;
            }
            
            .chat-messages {
                overflow-y: scroll;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Désactiver l'effet de highlight sur les clics */
            * {
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Fix pour les inputs sur iOS 12 */
            .chat-input {
                padding-top: 10px;
                padding-bottom: 10px;
                line-height: normal;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <!-- Polyfills pour navigateurs anciens -->
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/core-js-bundle@3.25.1/index.min.js"></script>
    
    <!-- Firebase SDK 8 (plus compatible avec iOS 12) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- jQuery (nécessaire pour Bootstrap) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    
    <!-- Popper.js et Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
    
    <script>
        // Polyfills supplémentaires pour iOS 12
        if (!Object.entries) {
            Object.entries = function(obj) {
                var ownProps = Object.keys(obj),
                    i = ownProps.length,
                    entries = new Array(i);
                while (i--) {
                    entries[i] = [ownProps[i], obj[ownProps[i]]];
                }
                return entries;
            };
        }
        
        if (!Array.prototype.find) {
            Object.defineProperty(Array.prototype, 'find', {
                value: function(predicate) {
                    if (this == null) {
                        throw new TypeError('"this" is null or not defined');
                    }
                    var o = Object(this);
                    var len = o.length >>> 0;
                    if (typeof predicate !== 'function') {
                        throw new TypeError('predicate must be a function');
                    }
                    var thisArg = arguments[1];
                    var k = 0;
                    while (k < len) {
                        var kValue = o[k];
                        if (predicate.call(thisArg, kValue, k, o)) {
                            return kValue;
                        }
                        k++;
                    }
                    return undefined;
                }
            });
        }
        
        // Config Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAHkI_ZfUX0jheLQyYy49iYLh1LUwxw26Y",
            authDomain: "nlp-9057d.firebaseapp.com",
            projectId: "nlp-9057d",
            storageBucket: "nlp-9057d.appspot.com",
            messagingSenderId: "713755293336",
            appId: "1:713755293336:web:89638ccb2839975f2802ed",
            measurementId: "G-4HVY16QT8M"
        };
        
        // Initialisation Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Application principale
        const app = {
            currentUser: null,
            currentScreen: 'loading', // loading, auth, main, chat
            currentTab: 'conversations', // conversations, users, profile, ai
            conversations: [],
            filteredConversations: [],
            users: [],
            filteredUsers: [],
            messages: [],
            currentChat: null,
            activeAuthTab: 'login',
            searchQuery: '',
            selectedImage: null,
            imagePreview: null,
            messageModCounter: {},
            sendingMessages: new Set(),
            
            // Initialisation
            init() {
                // Afficher l'écran de chargement
                this.renderLoadingScreen();
                
                // Mettre en place l'authentification
                this.setupAuthListener();
                
                // Support dark mode
                this.checkDarkMode();
                
                // Ajuster pour le clavier iOS
                this.setupIOSKeyboardFix();
                
                // Empêcher les rebonds sur iOS
                this.preventIOSBounce();
            },
            
            // Prévenir l'effet de rebond sur iOS
            preventIOSBounce() {
                document.body.addEventListener('touchmove', function(e) {
                    if(e.target.classList.contains('app-content') || 
                       e.target.classList.contains('chat-messages') ||
                       e.target.closest('.app-content') ||
                       e.target.closest('.chat-messages')) {
                        return;
                    }
                    e.preventDefault();
                }, { passive: false });
            },
            
            // Ajustement pour le clavier iOS
            setupIOSKeyboardFix() {
                // Détection visibilité du clavier (approche simplifiée pour iOS 12)
                document.addEventListener('focusin', (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        document.body.classList.add('keyboard-open');
                        setTimeout(() => this.scrollToBottom(), 300);
                    }
                });
                document.addEventListener('focusout', (e) => {
                    document.body.classList.remove('keyboard-open');
                });
            },
            
            // Support dark mode
            checkDarkMode() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-mode');
                }
                
                if (window.matchMedia) {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                        if (event.matches) {
                            document.body.classList.add('dark-mode');
                        } else {
                            document.body.classList.remove('dark-mode');
                        }
                    });
                }
            },
            
            // Écouteur d'authentification
            setupAuthListener() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // Utilisateur connecté
                        try {
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                
                                // Mettre à jour le statut en ligne
                                await db.collection('users').doc(user.uid).update({
                                    online: true,
                                    lastSeen: firebase.firestore.Timestamp.now()
                                });
                                
                                // Définir l'état de l'utilisateur
                                this.currentUser = {
                                    uid: user.uid,
                                    username: userData.username,
                                    email: userData.email,
                                    phone: userData.phone || "",
                                    bio: userData.bio || "",
                                    avatar: userData.avatar,
                                    blockedUsers: userData.blockedUsers || []
                                };
                                
                                // Définir l'écran de l'application
                                this.currentScreen = 'main';
                                
                                // Charger les conversations
                                this.loadConversations();
                                
                                // Charger les utilisateurs
                                this.loadUsers();
                                
                                // Afficher notification de bienvenue
                                this.showToast(`Bienvenue, ${userData.username}!`);
                                
                            } else {
                                // Document utilisateur non trouvé, déconnexion
                                await auth.signOut();
                                this.currentUser = null;
                                this.currentScreen = 'auth';
                                this.showToast('Session expirée');
                            }
                            
                        } catch (error) {
                            console.error("Erreur lors de la récupération des données utilisateur:", error);
                            this.currentUser = null;
                            this.currentScreen = 'auth';
                            this.showToast('Erreur de connexion');
                        }
                        
                    } else {
                        // Utilisateur déconnecté
                        this.currentUser = null;
                        this.currentScreen = 'auth';
                    }
                    
                    this.render();
                });
            },
            
            // Fonction de connexion
            async login(event) {
                event.preventDefault();
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                try {
                    this.showToast("Connexion en cours...");
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    console.error("Erreur de connexion:", error);
                    this.showToast("Email ou mot de passe incorrect");
                }
            },
            
            // Fonction d'inscription
            async register(event) {
                event.preventDefault();
                
                const username = document.getElementById('register-username').value;
                const email = document.getElementById('register-email').value;
                const phone = document.getElementById('register-phone').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                // Validation basique
                if (password !== confirmPassword) {
                    this.showToast("Les mots de passe ne correspondent pas");
                    return;
                }
                
                try {
                    this.showToast("Création du compte...");
                    
                    // Vérifier si le nom d'utilisateur existe
                    const usernameCheck = await db.collection('users')
                        .where('username', '==', username)
                        .get();
                    
                    if (!usernameCheck.empty) {
                        this.showToast("Ce nom d'utilisateur est déjà pris");
                        return;
                    }
                    
                    // Créer l'utilisateur
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // Créer le document utilisateur
                    await db.collection('users').doc(user.uid).set({
                        username: username,
                        email: email,
                        phone: phone,
                        bio: "",
                        avatar: null,
                        online: true,
                        lastSeen: firebase.firestore.Timestamp.now(),
                        createdAt: firebase.firestore.Timestamp.now(),
                        blockedUsers: []
                    });
                    
                    // Mettre à jour le profil
                    await user.updateProfile({
                        displayName: username
                    });
                    
                    this.showToast("Compte créé avec succès");
                    
                } catch (error) {
                    console.error("Erreur d'inscription:", error);
                    this.showToast("Erreur lors de l'inscription");
                }
            },
            
            // Fonction de déconnexion
            async logout() {
                if (confirm("Êtes-vous sûr de vouloir vous déconnecter ?")) {
                    try {
                        this.showToast("Déconnexion en cours...");
                        
                        if (this.currentUser) {
                            // Mettre à jour le statut en ligne
                            await db.collection('users').doc(this.currentUser.uid).update({
                                online: false,
                                lastSeen: firebase.firestore.Timestamp.now()
                            });
                        }
                        
                        // Déconnexion
                        await auth.signOut();
                        this.showToast("Déconnexion réussie");
                        
                    } catch (error) {
                        console.error("Erreur de déconnexion:", error);
                        this.showToast("Erreur lors de la déconnexion");
                    }
                }
            },
            
            // Charger les conversations
            async loadConversations() {
                try {
                    // Récupérer les conversations où l'utilisateur est un participant
                    const query = db.collection('conversations')
                        .where('participants', 'array-contains', this.currentUser.uid);
                    
                    // Écouteur en temps réel
                    query.onSnapshot(async (snapshot) => {
                        const conversations = [];
                        
                        for (const doc of snapshot.docs) {
                            const conversationData = doc.data();
                            
                            // Trouver l'autre participant
                            const otherUserId = conversationData.participants.find(id => id !== this.currentUser.uid);
                            
                            try {
                                // Récupérer les données de l'autre utilisateur
                                const userDoc = await db.collection('users').doc(otherUserId).get();
                                
                                if (userDoc.exists) {
                                    const userData = userDoc.data();
                                    
                                    // Vérifier si l'utilisateur est bloqué
                                    const isBlocked = this.currentUser.blockedUsers && 
                                                     this.currentUser.blockedUsers.includes(otherUserId);
                                    
                                    // Vérifier si la conversation est supprimée pour l'utilisateur actuel
                                    const isDeleted = conversationData.deleted && 
                                                    conversationData.deleted[this.currentUser.uid];
                                    
                                    // Ajouter uniquement les conversations non supprimées
                                    if (!isDeleted) {
                                        // Calculer le nombre de messages non lus
                                        let unreadCount = 0;
                                        
                                        if (conversationData.lastMessageSenderId && 
                                            conversationData.lastMessageSenderId !== this.currentUser.uid) {
                                            
                                            // Récupérer les messages non lus
                                            const unreadQuery = await db.collection('messages')
                                                .where('conversationId', '==', doc.id)
                                                .where('senderId', '==', otherUserId)
                                                .where('read', '==', false)
                                                .get();
                                            
                                            unreadCount = unreadQuery.size;
                                        }
                                        
                                        conversations.push({
                                            id: doc.id,
                                            otherUser: {
                                                uid: otherUserId,
                                                username: userData.username,
                                                avatar: userData.avatar,
                                                online: userData.online,
                                                lastSeen: userData.lastSeen?.toDate() || null,
                                                isBlocked
                                            },
                                            lastMessage: conversationData.lastMessage,
                                            lastMessageType: conversationData.lastMessageType || 'text',
                                            lastMessageTimestamp: conversationData.lastMessageTimestamp?.toDate() || new Date(),
                                            lastMessageSenderId: conversationData.lastMessageSenderId,
                                            unreadCount,
                                            isBlocked
                                        });
                                    }
                                }
                            } catch (error) {
                                console.error(`Erreur de récupération de l'utilisateur ${otherUserId}:`, error);
                            }
                        }
                        
                        // Trier par heure du dernier message
                        conversations.sort((a, b) => b.lastMessageTimestamp - a.lastMessageTimestamp);
                        
                        this.conversations = conversations;
                        this.filterConversations();
                        this.render();
                    });
                    
                } catch (error) {
                    console.error("Erreur lors du chargement des conversations:", error);
                    this.showToast("Erreur lors du chargement des conversations");
                }
            },
            
            // Charger les utilisateurs
            async loadUsers() {
                try {
                    // Récupérer tous les utilisateurs
                    const snapshot = await db.collection('users').get();
                    
                    const users = [];
                    
                    snapshot.forEach(doc => {
                        // Ne pas inclure l'utilisateur actuel
                        if (doc.id !== this.currentUser.uid) {
                            const userData = doc.data();
                            
                            // Vérifier si l'utilisateur est bloqué
                            const isBlocked = this.currentUser.blockedUsers && 
                                             this.currentUser.blockedUsers.includes(doc.id);
                            
                            users.push({
                                uid: doc.id,
                                username: userData.username,
                                email: userData.email,
                                phone: userData.phone || "",
                                bio: userData.bio || "",
                                avatar: userData.avatar,
                                online: userData.online,
                                lastSeen: userData.lastSeen?.toDate() || null,
                                isBlocked
                            });
                        }
                    });
                    
                    this.users = users;
                    this.filterUsers();
                    this.render();
                    
                    // Configurer l'écouteur de statut en ligne
                    this.setupOnlineStatusListener();
                    
                } catch (error) {
                    console.error("Erreur lors du chargement des utilisateurs:", error);
                    this.showToast("Erreur lors du chargement des utilisateurs");
                }
            },
            
            // Écouteur de statut en ligne
            setupOnlineStatusListener() {
                const usersRef = db.collection('users');
                
                usersRef.onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        // Ignorer l'utilisateur actuel
                        if (change.doc.id === this.currentUser?.uid) return;
                        
                        const userData = change.doc.data();
                        
                        // Mettre à jour la liste des utilisateurs
                        this.users = this.users.map(user => {
                            if (user.uid === change.doc.id) {
                                return {
                                    ...user,
                                    online: userData.online,
                                    lastSeen: userData.lastSeen?.toDate() || user.lastSeen
                                };
                            }
                            return user;
                        });
                        
                        // Mettre à jour la liste des conversations
                        this.conversations = this.conversations.map(conversation => {
                            if (conversation.otherUser.uid === change.doc.id) {
                                return {
                                    ...conversation,
                                    otherUser: {
                                        ...conversation.otherUser,
                                        online: userData.online,
                                        lastSeen: userData.lastSeen?.toDate() || conversation.otherUser.lastSeen
                                    }
                                };
                            }
                            return conversation;
                        });
                        
                        // Mettre à jour le chat actuel si nécessaire
                        if (this.currentChat && this.currentChat.otherUser.uid === change.doc.id) {
                            this.currentChat = {
                                ...this.currentChat,
                                otherUser: {
                                    ...this.currentChat.otherUser,
                                    online: userData.online,
                                    lastSeen: userData.lastSeen?.toDate() || this.currentChat.otherUser.lastSeen
                                }
                            };
                        }
                    });
                    
                    // Filtrer et rendre
                    this.filterUsers();
                    this.filterConversations();
                    this.render();
                });
            },
            
            // Fonction de recherche
            handleSearch(query) {
                this.searchQuery = query;
                
                if (this.currentTab === 'conversations') {
                    this.filterConversations();
                } else if (this.currentTab === 'users') {
                    this.filterUsers();
                }
                
                this.render();
            },
            
            // Filtrer les conversations
            filterConversations() {
                if (!this.searchQuery) {
                    this.filteredConversations = this.conversations;
                    return;
                }
                
                const query = this.searchQuery.toLowerCase();
                this.filteredConversations = this.conversations.filter(conversation => {
                    return conversation.otherUser.username.toLowerCase().includes(query) ||
                           (conversation.lastMessage && conversation.lastMessage.toLowerCase().includes(query));
                });
            },
            
            // Filtrer les utilisateurs
            filterUsers() {
                if (!this.searchQuery) {
                    this.filteredUsers = this.users;
                    return;
                }
                
                const query = this.searchQuery.toLowerCase();
                this.filteredUsers = this.users.filter(user => {
                    return user.username.toLowerCase().includes(query) ||
                           (user.phone && user.phone.includes(query)) ||
                           (user.bio && user.bio.toLowerCase().includes(query));
                });
            },
            
            // Démarrer un chat avec un utilisateur
            async startChat(user) {
                if (user.isBlocked) {
                    this.showToast("Vous avez bloqué cet utilisateur");
                    return;
                }
                
                // Créer l'ID de la conversation (trier les UIDs pour assurer un ID cohérent)
                const sortedIds = [this.currentUser.uid, user.uid].sort();
                const conversationId = sortedIds.join('_');
                
                try {
                    // Vérifier si la conversation existe
                    const conversationDoc = await db.collection('conversations').doc(conversationId).get();
                    
                    if (!conversationDoc.exists) {
                        // Créer une nouvelle conversation
                        await db.collection('conversations').doc(conversationId).set({
                            participants: sortedIds,
                            lastMessage: null,
                            lastMessageTimestamp: firebase.firestore.Timestamp.now(),
                            createdAt: firebase.firestore.Timestamp.now(),
                            deleted: {}
                        });
                    } else {
                        // Si la conversation existe mais a été supprimée pour l'utilisateur actuel, la restaurer
                        if (conversationDoc.data().deleted && conversationDoc.data().deleted[this.currentUser.uid]) {
                            let deleted = conversationDoc.data().deleted;
                            deleted[this.currentUser.uid] = false;
                            await db.collection('conversations').doc(conversationId).update({ deleted });
                        }
                    }
                    
                    // Ouvrir l'écran de chat
                    this.currentChat = {
                        id: conversationId,
                        otherUser: user
                    };
                    
                    this.currentScreen = 'chat';
                    
                    // Charger les messages
                    this.loadMessages(conversationId);
                    
                    this.render();
                    
                } catch (error) {
                    console.error("Erreur lors du démarrage du chat:", error);
                    this.showToast("Erreur lors du démarrage de la conversation");
                }
            },
            
            // Charger les messages d'une conversation
            loadMessages(conversationId) {
                try {
                    // Effacer les messages précédents
                    this.messages = [];
                    
                    // Requête pour les messages
                    const query = db.collection('messages')
                        .where('conversationId', '==', conversationId)
                        .orderBy('timestamp', 'asc');
                    
                    // Écouteur en temps réel
                    query.onSnapshot((snapshot) => {
                        const messages = [];
                        
                        snapshot.forEach(doc => {
                            const messageData = doc.data();
                            
                            // Ignorer les messages cachés pour l'utilisateur actuel
                            if (messageData.hidden && messageData.hidden[this.currentUser.uid]) {
                                return;
                            }
                            
                            messages.push({
                                id: doc.id,
                                senderId: messageData.senderId,
                                text: messageData.text,
                                image: messageData.image,
                                messageType: messageData.messageType || 'text',
                                timestamp: messageData.timestamp?.toDate() || new Date(),
                                read: messageData.read,
                                edited: messageData.edited || false,
                                reactions: messageData.reactions || {}
                            });
                        });
                        
                        this.messages = messages;
                        this.render();
                        
                        // Défiler vers le bas
                        this.scrollToBottom();
                        
                        // Marquer les messages comme lus
                        this.markMessagesAsRead(conversationId);
                    });
                    
                } catch (error) {
                    console.error("Erreur lors du chargement des messages:", error);
                    this.showToast("Erreur lors du chargement des messages");
                }
            },
            
            // Marquer les messages comme lus
            async markMessagesAsRead(conversationId) {
                try {
                    // Récupérer les messages non lus non envoyés par l'utilisateur actuel
                    const query = db.collection('messages')
                        .where('conversationId', '==', conversationId)
                        .where('senderId', '!=', this.currentUser.uid)
                        .where('read', '==', false);
                    
                    const snapshot = await query.get();
                    
                    // Mettre à jour chaque message
                    const batch = db.batch();
                    
                    snapshot.forEach(doc => {
                        batch.update(doc.ref, { read: true });
                    });
                    
                    if (snapshot.size > 0) {
                        await batch.commit();
                    }
                    
                } catch (error) {
                    console.error("Erreur lors du marquage des messages comme lus:", error);
                }
            },
            
            // Sélectionner une image
            selectImage() {
                const fileInput = document.getElementById('image-upload');
                fileInput.click();
            },
            
            // Gérer l'image sélectionnée
            handleImageSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Valider le type de fichier
                const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validImageTypes.includes(file.type)) {
                    this.showToast("Format d'image non supporté");
                    return;
                }
                
                // Valider la taille du fichier (max 6 Mo)
                if (file.size > 6 * 1024 * 1024) {
                    this.showToast("L'image ne doit pas dépasser 6 Mo");
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.selectedImage = file;
                    this.imagePreview = e.target.result;
                    this.render();
                };
                reader.readAsDataURL(file);
            },
            
            // Annuler l'upload d'image
            cancelImageUpload() {
                this.selectedImage = null;
                this.imagePreview = null;
                this.render();
            },
            
            // Envoyer un message
            async sendMessage() {
                if (!this.currentChat) return;
                
                const messageInput = document.getElementById('message-input');
                const text = messageInput ? messageInput.value.trim() : '';
                
                // Vérifier si nous avons du texte ou une image
                if (!text && !this.selectedImage) return;
                
                try {
                    // Générer un ID aléatoire pour ce message pour le suivi dans l'UI
                    const tempMessageId = 'temp_' + Date.now().toString();
                    
                    // Ajouter à l'ensemble des messages en cours d'envoi
                    this.sendingMessages.add(tempMessageId);
                    
                    // Mettre à jour l'UI immédiatement pour montrer l'état d'envoi
                    // Créer un objet message temporaire
                    const tempMessage = {
                        id: tempMessageId,
                        senderId: this.currentUser.uid,
                        text: text,
                        image: this.selectedImage ? this.imagePreview : null,
                        messageType: this.selectedImage ? 'image' : 'text',
                        timestamp: new Date(),
                        read: false,
                        edited: false,
                        reactions: {},
                        isSending: true
                    };
                    
                    // Ajouter au tableau de messages
                    this.messages.push(tempMessage);
                    
                    // Effacer l'entrée et l'image sélectionnée
                    if (messageInput) {
                        messageInput.value = '';
                    }
                    
                    // Stocker l'image sélectionnée avant de l'effacer
                    const imageToSend = this.selectedImage;
                    
                    // Effacer l'image sélectionnée de l'UI
                    this.selectedImage = null;
                    this.imagePreview = null;
                    
                    // Re-rendre pour montrer l'état d'envoi
                    this.render();
                    
                    // Défiler vers le bas
                    this.scrollToBottom();
                    
                    // Préparer les données du message
                    let messageData = {
                        conversationId: this.currentChat.id,
                        senderId: this.currentUser.uid,
                        timestamp: firebase.firestore.Timestamp.now(),
                        read: false,
                        edited: false,
                        hidden: {},
                        reactions: {}
                    };
                    
                    let lastMessageText = '';
                    let messageType = 'text';
                    
                    // Gérer le message texte
                    if (text) {
                        messageData.text = text;
                        lastMessageText = text;
                    }
                    
                    // Gérer le message image
                    if (imageToSend) {
                        // Convertir l'image en base64
                        const base64Image = await this.fileToBase64(imageToSend);
                        messageData.image = base64Image;
                        messageData.messageType = 'image';
                        messageType = 'image';
                        
                        if (!text) {
                            lastMessageText = '📷 Image';
                        }
                    }
                    
                    // Envoyer le message à Firestore
                    const messageRef = await db.collection('messages').add(messageData);
                    
                    // Mettre à jour la conversation avec les infos du dernier message
                    await db.collection('conversations').doc(this.currentChat.id).update({
                        lastMessage: lastMessageText,
                        lastMessageType: messageType,
                        lastMessageTimestamp: firebase.firestore.Timestamp.now(),
                        lastMessageSenderId: this.currentUser.uid
                    });
                    
                    // Retirer de l'ensemble des messages en cours d'envoi après confirmation
                    this.sendingMessages.delete(tempMessageId);
                    
                } catch (error) {
                    console.error("Erreur lors de l'envoi du message:", error);
                    this.showToast("Erreur lors de l'envoi du message");
                    
                    // Retirer des messages en cours d'envoi
                    const failedMessageId = Array.from(this.sendingMessages)[0]; // Just get the first one for simplicity
                    if (failedMessageId) {
                        this.sendingMessages.delete(failedMessageId);
                        
                        // Retirer le message échoué de l'UI
                        this.messages = this.messages.filter(msg => msg.id !== failedMessageId);
                        this.render();
                    }
                }
            },
            
            // Convertir un fichier en base64
            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            },
            
            // Formater le temps pour affichage
            formatTime(timestamp) {
                if (!timestamp) return '';
                
                const now = new Date();
                const date = timestamp instanceof Date ? timestamp : new Date(timestamp);
                
                // Si c'est aujourd'hui, afficher l'heure
                if (date.toDateString() === now.toDateString()) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                
                // Si c'est hier, afficher 'Hier'
                const yesterday = new Date(now);
                yesterday.setDate(now.getDate() - 1);
                if (date.toDateString() === yesterday.toDateString()) {
                    return 'Hier';
                }
                
                // Si c'est cette semaine, afficher le nom du jour
                if (now.getTime() - date.getTime() < 7 * 24 * 60 * 60 * 1000) {
                    return date.toLocaleDateString([], { weekday: 'short' });
                }
                
                // Sinon, afficher la date
                return date.toLocaleDateString([], { day: '2-digit', month: '2-digit' });
            },
            
            // Formater la date complète
            formatFullDate(timestamp) {
                if (!timestamp) return '';
                const date = timestamp instanceof Date ? timestamp : new Date(timestamp);
                
                const options = { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                };
                
                return date.toLocaleDateString('fr-FR', options);
            },
            
            // Formater le dernier vu
            formatLastSeen(lastSeen) {
                if (!lastSeen) return 'Jamais connecté';
                
                const date = lastSeen instanceof Date ? lastSeen : new Date(lastSeen);
                const now = new Date();
                const diff = now - date;
                
                // Moins d'une minute
                if (diff < 60000) {
                    return 'À l\'instant';
                }
                
                // Moins d'une heure
                if (diff < 3600000) {
                    const minutes = Math.floor(diff / 60000);
                    return `Il y a ${minutes} minute${minutes > 1 ? 's' : ''}`;
                }
                
                // Moins d'un jour
                if (diff < 86400000) {
                    const hours = Math.floor(diff / 3600000);
                    return `Il y a ${hours} heure${hours > 1 ? 's' : ''}`;
                }
                
                // Moins d'une semaine
                if (diff < 604800000) {
                    const days = Math.floor(diff / 86400000);
                    return `Il y a ${days} jour${days > 1 ? 's' : ''}`;
                }
                
                // Formater en date
                return date.toLocaleDateString();
            },
            
            // Obtenir les initiales pour l'avatar de secours
            getInitials(name) {
                return name ? name.charAt(0).toUpperCase() : '?';
            },
            
            // Afficher un toast de notification
            showToast(message) {
                const toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container';
                
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                toast.textContent = message;
                
                toastContainer.appendChild(toast);
                document.body.appendChild(toastContainer);
                
                // Auto-remove after animation completes
                setTimeout(() => {
                    toastContainer.remove();
                }, 3000);
            },
            
            // Faire défiler le chat vers le bas
            scrollToBottom() {
                const chatMessages = document.querySelector('.chat-messages');
                if (chatMessages) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            },
            
            // Changer d'onglet
            switchTab(tab) {
                this.currentTab = tab;
                this.searchQuery = '';
                this.render();
            },
            
            // Changer d'onglet d'authentification
            switchAuthTab(tab) {
                this.activeAuthTab = tab;
                this.render();
            },
            
            // Afficher l'écran de chargement
            renderLoadingScreen() {
                const appElement = document.getElementById('app');
                appElement.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center" style="height: 100vh;">
                        <div class="text-center">
                            <h1 class="mb-3 text-primary">ChatXchange</h1>
                            <p class="text-muted mb-4">Chargement en cours...</p>
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Chargement...</span>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            // Rendu de l'écran d'authentification
            renderAuthScreen() {
                return `
                    <div class="app-container">
                        <div class="auth-container">
                            <div class="auth-logo">
                                <h1>ChatXchange</h1>
                                <p>La plateforme d'échange sécurisée</p>
                            </div>
                            
                            <div class="auth-card">
                                <div class="auth-tabs">
                                    <div class="auth-tab ${this.activeAuthTab === 'login' ? 'active' : ''}" onclick="app.switchAuthTab('login')">Connexion</div>
                                    <div class="auth-tab ${this.activeAuthTab === 'register' ? 'active' : ''}" onclick="app.switchAuthTab('register')">Inscription</div>
                                </div>
                                
                                ${this.activeAuthTab === 'login' ? this.renderLoginForm() : this.renderRegisterForm()}
                            </div>
                        </div>
                    </div>
                `;
            },
            
            // Rendu du formulaire de connexion
            renderLoginForm() {
                return `
                    <form id="login-form" onsubmit="app.login(event)">
                        <div class="form-group">
                            <label for="login-email">Email</label>
                            <input type="email" class="form-control" id="login-email" required autocomplete="email">
                        </div>
                        
                        <div class="form-group">
                            <label for="login-password">Mot de passe</label>
                            <input type="password" class="form-control" id="login-password" required autocomplete="current-password">
                        </div>
                        
                        <div class="text-right mb-3">
                            <a href="#" class="text-primary">Mot de passe oublié ?</a>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-block">Se connecter</button>
                    </form>
                `;
            },
            
            // Rendu du formulaire d'inscription
            renderRegisterForm() {
                return `
                    <form id="register-form" onsubmit="app.register(event)">
                        <div class="form-group">
                            <label for="register-username">Nom d'utilisateur</label>
                            <input type="text" class="form-control" id="register-username" required autocomplete="username">
                        </div>
                        
                        <div class="form-group">
                            <label for="register-email">Email</label>
                            <input type="email" class="form-control" id="register-email" required autocomplete="email">
                        </div>
                        
                        <div class="form-group">
                            <label for="register-phone">Téléphone</label>
                            <input type="tel" class="form-control" id="register-phone" required autocomplete="tel">
                        </div>
                        
                        <div class="form-group">
                            <label for="register-password">Mot de passe</label>
                            <input type="password" class="form-control" id="register-password" required autocomplete="new-password">
                        </div>
                        
                        <div class="form-group">
                            <label for="register-confirm-password">Confirmer le mot de passe</label>
                            <input type="password" class="form-control" id="register-confirm-password" required autocomplete="new-password">
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-block">S'inscrire</button>
                    </form>
                `;
            },
            
            // Rendu de l'écran principal
            renderMainScreen() {
                return `
                    <div class="app-container">
                        <div class="app-header">
                            <h1 class="header-title">
                                ${this.currentTab === 'conversations' ? 'Discussions' : ''}
                                ${this.currentTab === 'users' ? 'Utilisateurs' : ''}
                                ${this.currentTab === 'profile' ? 'Profil' : ''}
                                ${this.currentTab === 'ai' ? 'Assistant IA' : ''}
                            </h1>
                            
                            ${(this.currentTab === 'conversations' || this.currentTab === 'users') ? `
                                <div class="ml-auto">
                                    <input type="text" class="form-control" 
                                           placeholder="Rechercher..." 
                                           value="${this.searchQuery}"
                                           oninput="app.handleSearch(this.value)"
                                           style="background-color: rgba(255,255,255,0.2); border: none; color: white; width: 150px;">
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="app-content">
                            ${this.currentTab === 'conversations' ? this.renderConversationsTab() : ''}
                            ${this.currentTab === 'users' ? this.renderUsersTab() : ''}
                            ${this.currentTab === 'profile' ? this.renderProfileTab() : ''}
                            ${this.currentTab === 'ai' ? this.renderAITab() : ''}
                        </div>
                        
                        ${this.currentTab === 'conversations' ? `
                            <div class="floating-button" onclick="app.switchTab('users')">
                                <i class="fas fa-plus"></i>
                            </div>
                        ` : ''}
                        
                        <div class="app-navbar">
                            <div class="nav-item ${this.currentTab === 'conversations' ? 'active' : ''}" onclick="app.switchTab('conversations')">
                                <i class="nav-icon fas fa-comment"></i>
                                <span>Discussions</span>
                            </div>
                            <div class="nav-item ${this.currentTab === 'users' ? 'active' : ''}" onclick="app.switchTab('users')">
                                <i class="nav-icon fas fa-users"></i>
                                <span>Utilisateurs</span>
                            </div>
                            <div class="nav-item ${this.currentTab === 'ai' ? 'active' : ''}" onclick="app.switchTab('ai')">
                                <i class="nav-icon fas fa-robot"></i>
                                <span>IA</span>
                            </div>
                            <div class="nav-item ${this.currentTab === 'profile' ? 'active' : ''}" onclick="app.switchTab('profile')">
                                <i class="nav-icon fas fa-user"></i>
                                <span>Profil</span>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            // Rendu de l'onglet conversations
            renderConversationsTab() {
                if (this.filteredConversations.length === 0) {
                    return `
                        <div class="empty-state">
                            <i class="empty-icon fas fa-comment"></i>
                            <h3 class="empty-title">Aucune conversation</h3>
                            <p class="empty-text">Commencez à discuter en visitant l'onglet Utilisateurs</p>
                        </div>
                    `;
                }
                
                return `
                    <div class="conversations-list">
                        ${this.filteredConversations.map(conversation => this.renderConversationItem(conversation)).join('')}
                    </div>
                `;
            },
            
            // Rendu d'un élément de conversation
            renderConversationItem(conversation) {
                const { id, otherUser, lastMessage, lastMessageType, lastMessageTimestamp, lastMessageSenderId, unreadCount, isBlocked } = conversation;
                const isLastMessageMine = lastMessageSenderId === this.currentUser?.uid;
                const timeString = this.formatTime(lastMessageTimestamp);
                
                // Limiter la longueur du message
                const truncateMessage = (message, type) => {
                    if (!message) return 'Aucun message';
                    if (type === 'image') return '📷 Image';
                    if (type === 'audio') return '🎤 Message vocal';
                    return message.length > 30 ? message.substring(0, 30) + '...' : message;
                };
                
                return `
                    <div class="list-item" onclick="app.startChat(${JSON.stringify(otherUser).replace(/"/g, '&quot;')})">
                        <div class="avatar">
                            ${otherUser.avatar 
                                ? `<img src="${otherUser.avatar}" alt="${otherUser.username}">`
                                : this.getInitials(otherUser.username)
                            }
                            <div class="status-dot ${otherUser.online ? 'online' : ''}"></div>
                        </div>
                        <div class="item-content">
                            <div class="item-title">
                                ${otherUser.username}
                                ${isBlocked ? '<span class="badge badge-danger ml-1">Bloqué</span>' : ''}
                            </div>
                            <div class="item-subtitle">
                                ${isLastMessageMine ? 'Vous: ' : ''}${truncateMessage(lastMessage, lastMessageType)}
                            </div>
                            ${!otherUser.online && otherUser.lastSeen ? `
                                <small class="text-muted">Vu ${this.formatLastSeen(otherUser.lastSeen)}</small>
                            ` : ''}
                        </div>
                        <div class="item-meta">
                            <div class="item-time">${timeString}</div>
                            ${unreadCount > 0 ? `<div class="badge-counter">${unreadCount}</div>` : ''}
                        </div>
                    </div>
                `;
            },
            
            // Rendu de l'onglet utilisateurs
            renderUsersTab() {
                if (this.filteredUsers.length === 0) {
                    return `
                        <div class="empty-state">
                            <i class="empty-icon fas fa-users"></i>
                            <h3 class="empty-title">Aucun utilisateur</h3>
                            <p class="empty-text">Aucun utilisateur n'est disponible actuellement</p>
                        </div>
                    `;
                }
                
                return `
                    <div class="users-list">
                        ${this.filteredUsers.map(user => this.renderUserItem(user)).join('')}
                    </div>
                `;
            },
            
            // Rendu d'un élément utilisateur
            renderUserItem(user) {
                return `
                    <div class="list-item" onclick="app.startChat(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                        <div class="avatar">
                            ${user.avatar 
                                ? `<img src="${user.avatar}" alt="${user.username}">`
                                : this.getInitials(user.username)
                            }
                            <div class="status-dot ${user.online ? 'online' : ''}"></div>
                        </div>
                        <div class="item-content">
                            <div class="item-title">
                                ${user.username}
                                ${user.isBlocked ? '<span class="badge badge-danger ml-1">Bloqué</span>' : ''}
                            </div>
                            <div class="item-subtitle">
                                ${user.online 
                                    ? '<i class="fas fa-circle text-success mr-1" style="font-size: 8px;"></i> En ligne' 
                                    : (user.lastSeen ? `Vu ${this.formatLastSeen(user.lastSeen)}` : 'Hors ligne')
                                }
                            </div>
                            ${user.bio ? `<small class="text-muted">${user.bio}</small>` : ''}
                        </div>
                    </div>
                `;
            },
            
            // Rendu de l'onglet profil
            renderProfileTab() {
                if (!this.currentUser) {
                    return `
                        <div class="d-flex justify-content-center align-items-center h-100">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Chargement...</span>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="profile-container">
                        <div class="profile-header">
                            <h2 class="mb-2">Mon Profil</h2>
                            <p class="mb-0">Gérez vos informations personnelles</p>
                            
                            <div class="profile-avatar-container">
                                <input type="file" id="avatar-upload" class="d-none" accept="image/*" onchange="app.handleAvatarSelect(event)">
                                <div class="profile-avatar" onclick="document.getElementById('avatar-upload').click()">
                                    ${this.currentUser.avatar 
                                        ? `<img src="${this.currentUser.avatar}" alt="${this.currentUser.username}">`
                                        : this.getInitials(this.currentUser.username)
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mb-4">
                            <h3>${this.currentUser.username}</h3>
                            <p class="text-muted">${this.currentUser.email}</p>
                        </div>
                        
                        <div class="profile-card">
                            <div class="profile-card-title">
                                <i class="fas fa-user"></i>
                                Informations personnelles
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Téléphone</div>
                                <div class="profile-field-value editable-field">
                                    ${this.currentUser.phone || 'Non renseigné'}
                                </div>
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Bio</div>
                                <div class="profile-field-value editable-field">
                                    ${this.currentUser.bio || 'Aucune bio'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="profile-card">
                            <div class="profile-card-title">
                                <i class="fas fa-cog"></i>
                                Paramètres
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Thème</div>
                                <div class="profile-field-value">
                                    <div class="custom-control custom-switch">
                                        <input type="checkbox" class="custom-control-input" id="darkModeSwitch" ${document.body.classList.contains('dark-mode') ? 'checked' : ''}>
                                        <label class="custom-control-label" for="darkModeSwitch">Mode sombre</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="profile-field">
                                <div class="profile-field-label">Version</div>
                                <div class="profile-field-value">
                                    ChatXchange 1.0.0
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-3">
                            <button class="btn btn-outline-primary btn-block mb-3" onclick="app.logout()">
                                <i class="fas fa-sign-out-alt mr-2"></i>
                                Se déconnecter
                            </button>
                            
                            <button class="btn btn-outline-danger btn-block">
                                <i class="fas fa-trash mr-2"></i>
                                Supprimer mon compte
                            </button>
                        </div>
                    </div>
                `;
            },
            
            // Rendu de l'onglet IA
            renderAITab() {
                return `
                    <div class="text-center p-4">
                        <div class="bg-primary text-white rounded p-4 mb-4" style="background: linear-gradient(135deg, #5D5CDE, #4a49b3) !important;">
                            <i class="fas fa-robot mb-3" style="font-size: 48px;"></i>
                            <h3>Assistant IA</h3>
                            <p>Notre IA analysera les données sportives pour vous fournir des prédictions précises.</p>
                            <div class="badge badge-light">Bientôt disponible</div>
                        </div>
                        
                        <h4 class="mb-3">Fonctionnalités à venir</h4>
                        
                        <div class="list-group text-left">
                            <div class="list-group-item d-flex align-items-center">
                                <div class="rounded-circle bg-primary text-white p-2 mr-3">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Analyse de matchs</h5>
                                    <p class="mb-0 text-muted small">Statistiques détaillées et recommandations</p>
                                </div>
                            </div>
                            
                            <div class="list-group-item d-flex align-items-center">
                                <div class="rounded-circle bg-info text-white p-2 mr-3">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Tendances et performances</h5>
                                    <p class="mb-0 text-muted small">Suivi des équipes en temps réel</p>
                                </div>
                            </div>
                            
                            <div class="list-group-item d-flex align-items-center">
                                <div class="rounded-circle bg-success text-white p-2 mr-3">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Conseils stratégiques</h5>
                                    <p class="mb-0 text-muted small">Recommandations basées sur l'analyse</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            // Rendu de l'écran de chat
            renderChatScreen() {
                if (!this.currentChat) {
                    return `
                        <div class="app-container">
                            <div class="app-header">
                                <button class="back-button" onclick="app.currentScreen = 'main'; app.render();">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <h1 class="header-title">Chat</h1>
                            </div>
                            <div class="app-content d-flex align-items-center justify-content-center">
                                <p>Aucune conversation sélectionnée</p>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="app-container">
                        <div class="app-header">
                            <button class="back-button" onclick="app.currentScreen = 'main'; app.render();">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            
                            <div class="d-flex align-items-center">
                                <div class="avatar mr-2" style="width: 38px; height: 38px;">
                                    ${this.currentChat.otherUser.avatar 
                                        ? `<img src="${this.currentChat.otherUser.avatar}" alt="${this.currentChat.otherUser.username}">`
                                        : this.getInitials(this.currentChat.otherUser.username)
                                    }
                                    <div class="status-dot ${this.currentChat.otherUser.online ? 'online' : ''}"></div>
                                </div>
                                <div>
                                    <h1 class="header-title mb-0">${this.currentChat.otherUser.username}</h1>
                                    <small class="text-white-50">
                                        ${this.currentChat.otherUser.online 
                                            ? 'En ligne' 
                                            : (this.currentChat.otherUser.lastSeen ? `Vu ${this.formatLastSeen(this.currentChat.otherUser.lastSeen)}` : 'Hors ligne')
                                        }
                                    </small>
                                </div>
                            </div>
                            
                            <button class="btn-icon text-white ml-auto">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                        
                        <div class="app-content">
                            <div class="chat-messages">
                                ${this.renderMessages()}
                            </div>
                        </div>
                        
                        <div class="chat-input-container">
                            ${this.imagePreview ? `
                                <div class="position-relative d-inline-block">
                                    <img src="${this.imagePreview}" class="image-preview" alt="Preview">
                                    <button class="btn-remove-image" onclick="app.cancelImageUpload()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            ` : ''}
                            
                            <input type="file" id="image-upload" class="d-none" accept="image/*" onchange="app.handleImageSelect(event)">
                            
                            <div class="chat-input-wrapper">
                                <button class="btn-icon" onclick="app.selectImage()">
                                    <i class="fas fa-image"></i>
                                </button>
                                
                                <input type="text" id="message-input" class="chat-input" placeholder="Écrire un message..." onkeypress="if(event.keyCode === 13) app.sendMessage()">
                                
                                <button class="btn-icon btn-send" onclick="app.sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="app-navbar">
                            <div class="nav-item active">
                                <i class="nav-icon fas fa-comment"></i>
                                <span>Messages</span>
                            </div>
                            <div class="nav-item">
                                <i class="nav-icon fas fa-phone"></i>
                                <span>Appels</span>
                            </div>
                            <div class="nav-item">
                                <i class="nav-icon fas fa-image"></i>
                                <span>Médias</span>
                            </div>
                            <div class="nav-item">
                                <i class="nav-icon fas fa-info-circle"></i>
                                <span>Infos</span>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            // Rendu des messages
            renderMessages() {
                if (this.messages.length === 0) {
                    return `
                        <div class="empty-state">
                            <i class="empty-icon fas fa-comment"></i>
                            <h3 class="empty-title">Aucun message</h3>
                            <p class="empty-text">Démarrez la conversation !</p>
                        </div>
                    `;
                }
                
                // Grouper les messages par date
                let messagesByDate = {};
                
                this.messages.forEach(message => {
                    const messageDate = new Date(message.timestamp).toDateString();
                    
                    if (!messagesByDate[messageDate]) {
                        messagesByDate[messageDate] = [];
                    }
                    
                    messagesByDate[messageDate].push(message);
                });
                
                // Rendre les messages par date
                let html = '';
                
                Object.keys(messagesByDate).forEach(date => {
                    html += `
                        <div class="message-date">
                            <span>${this.formatFullDate(new Date(date))}</span>
                        </div>
                    `;
                    
                    // Grouper les messages par expéditeur
                    let currentSenderId = null;
                    let messageGroup = [];
                    
                    messagesByDate[date].forEach((message, index, array) => {
                        if (currentSenderId !== message.senderId || 
                            (index > 0 && message.timestamp - array[index-1].timestamp > 5 * 60 * 1000)) {
                            // Rendre le groupe précédent
                            if (messageGroup.length > 0) {
                                html += this.renderMessageGroup(messageGroup, currentSenderId === this.currentUser.uid);
                                messageGroup = [];
                            }
                            currentSenderId = message.senderId;
                        }
                        
                        messageGroup.push(message);
                        
                        // Rendre le dernier groupe
                        if (index === array.length - 1 && messageGroup.length > 0) {
                            html += this.renderMessageGroup(messageGroup, currentSenderId === this.currentUser.uid);
                        }
                    });
                });
                
                return html;
            },
            
            // Rendu d'un groupe de messages
            renderMessageGroup(messages, isSent) {
                const groupClass = isSent ? 'sent' : 'received';
                
                let html = `<div class="message-group ${groupClass}">`;
                
                messages.forEach(message => {
                    const isSending = this.sendingMessages.has(message.id);
                    const time = new Date(message.timestamp).toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit'
                    });
                    
                    html += `
                        <div class="message-bubble message-${groupClass} ${isSending ? 'opacity-75' : ''}">
                    `;
                    
                    // Rendre l'image si présente
                    if (message.messageType === 'image' && message.image) {
                        html += `
                            <img src="${message.image}" class="message-image" alt="Image envoyée">
                        `;
                    }
                    
                    // Rendre le texte si présent
                    if (message.text) {
                        html += `<div>${message.text}</div>`;
                    }
                    
                    // Rendre l'heure et le statut de lecture
                    html += `
                            <div class="message-time">
                                ${time}
                                ${message.edited ? ' (modifié)' : ''}
                                ${isSent && !isSending ? `
                                <span class="message-status">
                                    ${message.read ? `
                                        <i class="fas fa-check-double"></i>
                                    ` : `
                                        <i class="fas fa-check"></i>
                                    `}
                                </span>
                                ` : ''}
                                ${isSending ? `
                                <span class="message-status">
                                    <i class="fas fa-circle-notch fa-spin"></i>
                                </span>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                return html;
            },
            
            // Fonction principale de rendu
            render() {
                const appElement = document.getElementById('app');
                
                let content = '';
                
                switch (this.currentScreen) {
                    case 'loading':
                        // Ne rien faire, déjà géré par renderLoadingScreen()
                        return;
                    case 'auth':
                        content = this.renderAuthScreen();
                        break;
                    case 'main':
                        content = this.renderMainScreen();
                        break;
                    case 'chat':
                        content = this.renderChatScreen();
                        break;
                    default:
                        content = '<div>Écran non trouvé</div>';
                }
                
                appElement.innerHTML = content;
                
                // Configurer les écouteurs d'événements après le rendu
                if (this.currentScreen === 'chat') {
                    setTimeout(() => {
                        this.scrollToBottom();
                    }, 0);
                }
                
                // Écouteur pour le mode sombre
                const darkModeSwitch = document.getElementById('darkModeSwitch');
                if (darkModeSwitch) {
                    darkModeSwitch.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            document.body.classList.add('dark-mode');
                        } else {
                            document.body.classList.remove('dark-mode');
                        }
                    });
                }
            }
        };
        
        // Initialiser l'application
        app.init();
    </script>
</body>
</html>
