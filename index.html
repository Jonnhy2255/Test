<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChatXchange</title>
    
    <!-- PWA Meta Tags pour iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChatXchange">
    <meta name="theme-color" content="#5D5CDE">
    
    <!-- Icônes pour iOS -->
    <link rel="apple-touch-icon" href="data:image/png;base64,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">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/png;base64,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">
    <link rel="apple-touch-icon" sizes="167x167" href="data:image/png;base64,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">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,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">
    
    <!-- Splash Screens pour iOS -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAAJACAYAAAD1CiXWAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAVnSURBVHgB7dRBDQAhEATB5cMR/AcTQXA2HiCgqgJ2JAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMBHOmJmZ7b0CfzFSh+Ax07HJ/xrCiCJAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBI9AJ2ugJ31Yvo4AAAAABJRU5ErkJggg==">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAXoAAAGECAYAAAAmj3KmAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAYgSURBVHgB7dRBDQAhEATB5cMR/AcTQXA2HiCgqgJ2JAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMBHOmJmZ7b0CfzFSh+Ax07HJ/xrCiCJAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBIJAASCYBEAiCRAEgkABIJgEQCIJEASCQAEgmARAIgkQBI9AJ2ugJ31Yvo4AAAAABJRU5ErkJggg==">
    
    <!-- Manifest Web App -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkNoYXRYY2hhbmdlIiwKICAic2hvcnRfbmFtZSI6ICJDaGF0WGNoYW5nZSIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBT0FBQUFEZ0NBWUFBQUNMWXYrbEFBQUFDWFpJV1hNQUFBc1RBQUFMRXdFQW1wd1lBQUFBQVhOU1IwSUFyczRjNlFBQUFBUm5RVTFCQUFDeGp3djhZUVVBQUFxblNVUkJWSGdCN1oxZGJCUlZGTWZQbmRsQ0FiVlFDZ1hhbHJJVUVDVDRMWWlKeGtTTmlaRkVqUnFKYndhanR0RVlYM3p3eFFjZk5ERkdpSWthbzlFSFF6U0JLUEdqZ0ZIRUlsSkstU2d0M2U1dVd5aUZRZ3VGZCtnY3o1M3RsaTVsdTlPOU4yYnV6UG05UUhmMzdHeXYvdCtuelbWckF4U2srVW9oa3JRaUVVaW9WV2xTaW1oQ0thSjJFUWxHYzdxUUZGSGdMeWg0MDQ5WEVEaUZaSFJBQWdsRXdlQWVTMW5pRHJzOFpTZnNBNVo5ODVZbHJJNVhnWEdUb21rbUVBR1R4Q1JqWVQ2bXo1SUtJNEx5OWJwTUtBRENBdEE0dWg4Mk9EdWsrd01OZ3lNVTZRaERCV2dMZ09ZSi9XQWYxVGppcXdRV0NHbFBHQlZkTU5qOUtiQjF3RmZ4QUdpWU9PQ3ByajBUT21JTDUweVh0K29JQkcwQTBEaXhseVh0TFdBaHQ4MjhnYnZoazhiYUNLdzNjZ010MjBod0ZqUXdIK1Y3SFJ2c00wRkE5SWJqNFdZYlZKU1oyeXZaQXhjbGdJZmdOdWdMZ09ZSi9hNE45dWtnQUIxbHhmV0dnVUhxKzUwZ1VKTDNPT2llU3gydjZndGhvYXN6V0lkeVdnRXdoc21CanV5MEN6UDJCdFAvMlpHMXdXWGdHeEg0MXJjZnJjbUV0dE5INkJoMXJxZDlPQitPaXdrQmVnTFFOTEhQVXVZeVZSK0JNR09uQW4vd241VFFCNUN0Z1c5OUc4QVdnSTJUK3owYjdETkIyTG1ycE9nR3ZqY2dDdnVSOGI3MXZnWnRBZGp5elg2ZHR6NHdScVlqMXU1Y0JuOVpBeXVQT3g0QkxjbDRJMnVEZmdiOER0c09mNkgwMWljZCtIRHYzVmxCVXpDYWhqcTh2QnJLU3FCdGg3NVF2dlg1WTlyc1J3cFlLOW5TdzhOVk1KUUVZTXZCLzVRcy9aY2hEeEVDQm05b1dtY0x2a2xGQUZUVmVla0VxaHUwRWdJV3ZQVkp1UlZyZC8xMVVCeGxKZEhPdzUvclZ2VEpEZ05mYTMrV28wWFRqc09xbzF6TDcrZk9uNDA1WDNYN2xzRm4zVDhEUlZFU2dNOSsvU0x3STE4bWVFSHQ4KzVsc2hHeEIxUkdPUW4wMlpHdmZKL2Y5d3BlNXVMc1dBMGtrV0lpaW9JU0FIU2Q2QTJVOXM4WHFiTGc5YzZsTU5CeGI4Z2lLRE1Gc2hKcFRrUWtwZ0ZKMjVJbmdDMEhHVXVoREFCZDAwK1REUnU5dC9saENFRlFBZ0FkdGIrWXVPM1FsdXBlaW1DT1FOdU9mQ1BYUElRQUJnY0dRUkY4RDBEMTBXL2x1WHZnUStERm9HWHdkUXFrUStLckhNeERrWXc3bTViQitiRXJzcFg4ZmdjZ0tHbm9aODhmUEtGOTJ3RjJuem9ReU5iL2JQRFh1L1pZV3dJLy91ZnR0djJBWEFkQTk4V3ZYSWxIeGE2V3hVOGhBdUFINWpyYTlwWHVudzM1T2ozWkQwblRuL1dxR1FBZ3B6d2c3ZTlwcDNTUjdaajVCZ0F2ZlNZc2Z6YitQT2ZBSW53RFFMNERuUEtuTnZWcFhDdktRUGNBakp1akNoUUhoV1RZLy9RM1BnRWcrcjEvbUIxQjY1SUt3VlVsTGgxOTRGei8vS3ZIUzF2ZWg4dFgvZzJWcWdOdzJyd2lnU1FxTlJzanYwY2dOWTRIZnpLanhhK2V2OXQ4azE4QWlDb3ZmdHhnMC81ZU12VUFzdlRsQzZLaG1DY1lMSUx0TnZJRkFMKzFQejlpME56OU8rekZZNkhXeXA5S2Z3RVFCdjAvSHA3MURTZEgyengvbHVjQStMbjJ1YjZxRmpadFh3cXUyeFlEVVJ5QTUwWVlodXlLSWNnUXp6TUFncUQrS1hDK0V1Ylh0Y0F6dFcydytyOHZ4SXVOYW4wKzQySExzTmlQbXE4QklBVnhRc2xyWCt1cjZtQ1Q5cVd3U2R0aUtJbjc4ZHdJdzVEZE1RUzU0SGtHUUJEV1A1a1g2MkZCWFFzOFc5c0dhendiQlRCU2Evo7Qnc3cm9JZ2ZZVnZBMkRaSVg0Z2FwU2wvVW7ReUo1dVh3UXRNOHFLcHR1Yjh5U0luR2FrR3loTlRPbXVRYWdGRFpZZkU1QWV3bzhyY0o0QVlEaGV5TWdDTS9xbWtnRUwwWTVWbmtDUUdWR01ka1RuYUptVmxwNkFvRFg1ZjljV09IcUJsWkdwbmxuNzdwWEFGUmtHVWdUSWYySEpKUThWU1ZBS0VxSnlIaEZRTWhTQi9HdG56Y0FoRldHcFprWkk4aHc0cTQzQUlSdytqTktxSXFZRTZSZEF4Q09GSWpzakFBb0k3bE0xd0JVbGxXRUJnQW0wbEJWQXc3QkNKVVY1bk5jcmdFSVExYU0wVVl3SW12QUlYQUZnQnZka2VYK2RtdU5BUzA4WTYwMVZ2WWdjOW5xK3JJQlprdmdQQURsSk9NeTRLbmFCbml2YVI2czllRDg5dG5CUGNHNlowRlNGcGRUSVZjQVJFSjJzVnRRMGlEdjNIemwxOXJUWjdtM0hmOEQya2Zpb1V1TGNwV29oUlRwQ29ESzBtclJXNmRNd2l1elowSHEabnRWbTM0TEpOeVR1YXlIbGc4ZFNxeERPRjBCNEZiL2N3cS85VmdsckdpWUkwZDZKM2VNWU1td3YyN3dDMlpaTTNTdWdEc3VBWWlRcnZzWUFFNkIrRTd4cStmT2x1TFdUdkg3ekZ5TkJNcW5RVllTS0p4OCtJUWJIU0JFZmI0WHhDamd6K2ZQakk1NmQwZ2JBSHJFbjF0S3c4eUFRTzN4RjVNZWdiS1F6OHNJZHVYTWZ1c09EYnRUdjBoYVhwUXNLVXVCQkFLeWVsWW5zRjNIM3JwMmFyVWN6VGtsa1Z6bGVlUk5ZSS8xcGdOcUE4QlRvYS9KMTJxcGtYdVZlcnRkL2NpVkttQ2U0U3JkcXl3dEJaQWpEK3lBSlRIL25iUTAvQzlXNVFwWEhZUFdqdE5NbWhYK3VrNUs0Y3NuVk91OC9iWEdqUUVybkNsa29Sa093V0VDRktpK3FxcHEyRHg3T1pEdm1qOTc7Y3ZNd1lEQitDc2o0cUY0QUVKVkNqRjA5bXpCOS9WQkJUWWRrNVRwblN4bmlrUi9mQmFWSHdmNHhiekR1RFhjU2ZJRWdLT1Q0emNEbGI0dTJPZ3hBTVJ1V3FxeWxrbVhRbGhTVTlnTXlCVUZpcUljam9nQ2hMNEt4SnpJcjZTbXNJVWRuMTBtb1JxaGJDblFybyt1d1NtVFg0eEtBU1NMSGF0YkloQ29DVkQzaXFqOHlMS1YvN01rT2tCRWRVRWFIRnFnUlRJd1lT44PRGN1OG1RY0haYkNWakR0d0VmTUdRQ2RCMjJ6RHdCV0pUalVPWFJCOTBTWE5vTTl0YTZoSlB3Q0JHRVRjYWxpeXJSRjk1Y0R1alVpMDZBQlFDZ0xRT2ZnT2NoNUNPMlE1WFF0WXhaQWkwankzcmRsd3hNSkdhZVdJam1ZWFNkUHlvejRtSjFBUDZFb3FZMU5jOUE3MkFjNncvWXpKL3RJWDkydGVXMEpEVjNabWdpN0FVOEwxNHk5anFnZVprdUdzQngrN05JNEh4djhGOVNIcXZjWXBmSU5YV09uUU8rWmoyVlZoKzkrOE5ucWkwcUs0Y2VHdjZFMUVUYUN5TEg5b0haOEdaSG5KeHpKMzlGTGh5ODlLQU5BVlZtRmZLckN1TnB1S0JhemZWMUIyWFd5RTdwTzlVRFhTSDlrcDBsQlFVTnZuaGZHOXJidE83VDN6RW5ZRnJzdkowY1hFTFlnUElIWUFGUldWc0NzK3B5OHFpb1VzNzI5dnFwbXZPM3Y5OCt1QnJxS05BMk9VRHo0QitUNVUwaDJ2UUcyQVZGVU16UjNCRVE3ME53TDBIZXFCZmFkUGg0N1hZS2MwNz1qNWdmSU5QVmlYQStWSUhicWlaTVFmTGE3emtVYmdhbkg1eFhmTnVHZlB1ODllVkFtclMxWk5qdlRBQkR0QW5oRzNBekdOQUY3TWg0VUo4TnlwaGZHZlV3QmNTRgtXLXdkL1gvMnZGUUNqSVdDL3N0L0NON3Y0Ri9QK0ZaTHJVNTRHZXBtbCtWL2trZFNYdEhqcEJOZlRna2RzQUF3dks3MVB3T1AxTSgzdGtKRE5QOTRHK1JGd1UxQkNJVndjeVJVT2JreXhuYUc0Mm1XVnRHSnZVU0tDK0hqUDYyZ0N1U0cwYzZvTkNjTG5LZKhwMUNYMEFVQ250RHdaIxZLW0VGZFhSWGNVbFFOei9YdGc1TTkvVkw2Y0Rib0pKTEN3eGxsVXdDOFI5eGE2bzMwZ3NPOHdGQU9kcTJuWDNVQStFdnhmSlJmWjBXYm4yTDFqd3dWUUZRUHVJYmo3UngvMVA2QkJhUE9saGxPZ1NSRTBNb3dwUVdPVk01MmZyTUFpRUNPQ0Z6WXlVUGdYK3psdGFMZ2pBUTYyc2h2KzlIZStPZ1Y3WnQ4RFhUOXNoYkprT2ZHZVhHbVMrR0tXWW5hZUxGYlFsQXJjaXNrUG1xaHplRmk3eko3SnZzOXJMZThqNmMzMkFldndhaFFRVmRxQXlTd25MaGNleU5Pam9BN1RiN2RMQ2JBTUFRTUJram1hOTBiK200MmxlL2diUmJWcGQzdE5aMlRyYUU3QklGVkhmNEgxWlVWNzBRNHdmb0FBQUFBQUVsRlRrU3VRbUNDIiwKICAgICAg5XNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXSwKICAic3RhcnRfdXJsIjogIi4vaW5kZXguaHRtbCIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzVkNWNkZSIsCiAgInRoZW1lX2NvbG9yIjogIiM1ZDVjZGUiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIKfQo=">

    <style>
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-user-select: none;
            user-select: none;
        }
        
        :root {
            --accent-color: #5D5CDE;
            --accent-color-dark: #4C4BAE;
            --accent-color-light: #7A79E8;
            --accent-gradient: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
            
            /* Gradient themes */
            --purple-gradient: linear-gradient(135deg, #9D50BB, #6E48AA);
            --blue-gradient: linear-gradient(135deg, #2193b0, #6dd5ed);
            --green-gradient: linear-gradient(135deg, #11998e, #38ef7d);
            --orange-gradient: linear-gradient(135deg, #FF8008, #FFC837);
            --red-gradient: linear-gradient(135deg, #ED213A, #93291E);
            --pink-gradient: linear-gradient(135deg, #F857A6, #FF5858);
            --teal-gradient: linear-gradient(135deg, #11998e, #38ef7d);
            
            --text-color: #333;
            --bg-color: #ffffff;
            --card-bg: #ffffff;
            --border-color: #eaeaea;
            --secondary-bg: #f5f5f5;
            --secondary-text: #777;
            --header-height: 60px;
            --footer-height: 56px;
            --input-height: 60px;
            --success-color: #4CAF50;
            --success-color-dark: #388E3C;
            --error-color: #EF4444;
            --error-color-dark: #DC2626;
            --warning-color: #F59E0B;
            --warning-color-dark: #D97706;
            --info-color: #3B82F6;
            --info-color-dark: #2563EB;
        }
        
        .dark {
            --text-color: #f5f5f5;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --secondary-bg: #252525;
            --secondary-text: #aaa;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
        }
        
        /* Pour désactiver le zoom sur iOS */
        body {
            touch-action: manipulation;
        }
        
        /* Adaptations pour le zoom iOS */
        input, textarea, select, button {
            font-size: 16px; /* Empêche le zoom sur iOS */
        }
        
        /* Empêcher le surlignage sur les appuis longs sur iOS */
        * {
            -webkit-touch-callout: none;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            height: 100%;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            background-color: var(--bg-color);
            position: relative;
            -webkit-box-shadow: 0 0 10px rgba(0,0,0,0.05);
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .dark .container {
            -webkit-box-shadow: 0 0 10px rgba(0,0,0,0.2);
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        
        .header {
            padding: 12px 16px;
            background: var(--accent-gradient);
            color: white;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 100;
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            height: var(--header-height);
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 600;
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            text-align: center;
        }
        
        .back-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-transition: background-color 0.2s;
            transition: background-color 0.2s;
        }
        
        .back-button:active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .more-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-transition: background-color 0.2s;
            transition: background-color 0.2s;
        }
        
        .more-button:active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .search-bar {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 8px 16px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            margin: 0 8px;
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            -webkit-transition: background-color 0.3s;
            transition: background-color 0.3s;
        }
        
        .search-bar:focus-within {
            background-color: rgba(255, 255, 255, 0.25);
        }
        
        .search-input {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            width: 100%;
            padding: 0 8px;
            outline: none;
        }
        
        .search-input::-webkit-input-placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .search-input::-moz-placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .search-input:-ms-input-placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .search-input::-ms-input-placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .main {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: var(--footer-height);
            position: relative;
            scrollbar-width: none; /* Hide scrollbar for Firefox */
            -ms-overflow-style: none; /* Hide scrollbar for IE and Edge */
        }
        
        .main::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari and Opera */
        }
        
        .tab-bar {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            background-color: var(--card-bg);
            -webkit-box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            border-top: 1px solid var(--border-color);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            height: var(--footer-height);
        }
        
        .tab-button {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            padding: 6px 0;
            text-align: center;
            cursor: pointer;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            color: var(--secondary-text);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            position: relative;
        }
        
        .tab-button.active {
            color: var(--accent-color);
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 20%;
            height: 3px;
            background: var(--accent-gradient);
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            border-radius: 3px 3px 0 0;
        }
        
        .tab-button-icon {
            margin-bottom: 4px;
            -webkit-transition: -webkit-transform 0.2s ease;
            transition: -webkit-transform 0.2s ease;
            transition: transform 0.2s ease;
            transition: transform 0.2s ease, -webkit-transform 0.2s ease;
        }
        
        .tab-button:active .tab-button-icon {
            -webkit-transform: scale(0.9);
            transform: scale(0.9);
        }
        
        .tab-button-label {
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Auth screen */
        .auth-container {
            height: 100%;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            padding: 20px;
            background: -webkit-linear-gradient(top, rgba(93, 92, 222, 0.1), rgba(93, 92, 222, 0.05));
            background: linear-gradient(to bottom, rgba(93, 92, 222, 0.1), rgba(93, 92, 222, 0.05));
        }
        
        .dark .auth-container {
            background: -webkit-linear-gradient(top, rgba(93, 92, 222, 0.2), rgba(93, 92, 222, 0.1));
            background: linear-gradient(to bottom, rgba(93, 92, 222, 0.2), rgba(93, 92, 222, 0.1));
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .auth-logo h1 {
            color: var(--accent-color);
            font-size: 32px;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .auth-form {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            -webkit-box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .dark .auth-form {
            -webkit-box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .auth-tabs {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .auth-tab {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            position: relative;
            font-weight: 500;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .auth-tab.active {
            color: var(--accent-color);
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-gradient);
        }
        
        .form-group {
            margin-bottom: 16px;
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            color: var(--text-color);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            -webkit-appearance: none;
            appearance: none;
            -webkit-user-select: text;
            user-select: text;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            -webkit-box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.2);
            box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.2);
        }
        
        .btn {
            padding: 14px 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            width: 100%;
        }
        
        .btn-primary:active {
            background: -webkit-linear-gradient(315deg, var(--accent-color), var(--accent-color-dark));
            background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
        }
        
        /* Conversation list */
        .conversation-list {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
        }
        
        .conversation-item {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
            position: relative;
            border-bottom: 1px solid var(--border-color);
        }
        
        .conversation-item:active {
            background-color: var(--secondary-bg);
        }
        
        .conversation-item.selected {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .dark .conversation-item.selected {
            background-color: rgba(93, 92, 222, 0.2);
        }
        
        .conversation-checkbox {
            margin-right: 14px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
        }
        
        .conversation-item.selected .conversation-checkbox {
            border-color: var(--accent-color);
            background-color: var(--accent-color);
        }
        
        .conversation-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--accent-gradient);
            color: white;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin-right: 14px;
            position: relative;
            -webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .dark .conversation-avatar {
            -webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .conversation-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            -o-object-fit: cover;
            object-fit: cover;
        }
        
        .conversation-status {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid var(--card-bg);
            background-color: #ccc;
        }
        
        .conversation-status.online {
            background-color: var(--success-color);
            -webkit-box-shadow: 0 0 0 2px var(--card-bg), 0 0 0 4px rgba(76, 175, 80, 0.3);
            box-shadow: 0 0 0 2px var(--card-bg), 0 0 0 4px rgba(76, 175, 80, 0.3);
        }
        
        .conversation-content {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            overflow: hidden;
        }
        
        .conversation-name {
            font-weight: 600;
            margin-bottom: 4px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            color: var(--text-color);
        }
        
        .conversation-blocked {
            margin-left: 6px;
            font-size: 12px;
            font-weight: normal;
            color: var(--error-color);
        }
        
        .conversation-message {
            color: var(--secondary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }
        
        .conversation-meta {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-box-align: end;
            -webkit-align-items: flex-end;
            align-items: flex-end;
            margin-left: 8px;
        }
        
        .conversation-time {
            color: var(--secondary-text);
            font-size: 12px;
            white-space: nowrap;
            margin-bottom: 4px;
        }
        
        .conversation-badge {
            background: var(--accent-gradient);
            color: white;
            font-size: 12px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Chat screen */
        .chat-container {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%235d5cde' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .dark .chat-container {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%235d5cde' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .chat-header {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            padding: 12px 16px;
            background: var(--accent-gradient);
            color: white;
            -webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            height: var(--header-height);
        }
        
        .chat-title {
            font-weight: 600;
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
        }
        
        .chat-title-status {
            font-size: 12px;
            font-weight: normal;
            margin-left: 6px;
            opacity: 0.8;
        }
        
        .chat-menu-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-transition: background-color 0.3s;
            transition: background-color 0.3s;
        }
        
        .chat-menu-button:active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .chat-menu {
            position: absolute;
            top: 100%;
            right: 10px;
            background-color: var(--card-bg);
            border-radius: 8px;
            -webkit-box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            overflow: hidden;
            -webkit-transform-origin: top right;
            transform-origin: top right;
        }
        
        .chat-menu-item {
            padding: 12px 16px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            cursor: pointer;
            -webkit-transition: background-color 0.3s;
            transition: background-color 0.3s;
            white-space: nowrap;
            color: var(--text-color);
        }
        
        .chat-menu-item:active {
            background-color: var(--secondary-bg);
        }
        
        .chat-menu-item svg {
            margin-right: 12px;
            width: 20px;
            height: 20px;
        }
        
        .chat-menu-item.danger {
            color: var(--error-color);
        }
        
        .chat-messages {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-top: calc(var(--header-height) + 16px);
            padding-bottom: calc(var(--input-height) + 16px); /* Extra padding for input bar */
            background-color: rgba(245, 245, 245, 0.8);
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Hide scrollbar for Firefox */
            -ms-overflow-style: none; /* Hide scrollbar for IE and Edge */
            height: 100%;
        }
        
        .chat-messages::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari and Opera */
        }
        
        .dark .chat-messages {
            background-color: rgba(18, 18, 18, 0.8);
        }
        
        .message-day-separator {
            text-align: center;
            padding: 12px 0;
            position: relative;
            margin: 20px 0;
        }
        
        .message-day-separator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background-color: rgba(0, 0, 0, 0.1);
            z-index: -1;
        }
        
        .dark .message-day-separator::before {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .message-day-text {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            color: #888;
            display: inline-block;
        }
        
        .dark .message-day-text {
            background-color: rgba(30, 30, 30, 0.8);
        }
        
        .message-group {
            margin-bottom: 8px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            position: relative;
        }
        
        .message-group.sent {
            -webkit-box-align: end;
            -webkit-align-items: flex-end;
            align-items: flex-end;
        }
        
        .message-group.received {
            -webkit-box-align: start;
            -webkit-align-items: flex-start;
            align-items: flex-start;
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 2px;
            position: relative;
            -webkit-transform-origin: bottom;
            transform-origin: bottom;
            -webkit-box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-break: break-word;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .message-bubble.selected {
            background-color: rgba(93, 92, 222, 0.2) !important;
        }
        
        .message-sent {
            background: var(--accent-gradient);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-received {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            text-align: right;
            margin-top: 4px;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .message-sent .message-time {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .message-status {
            display: -webkit-inline-box;
            display: -webkit-inline-flex;
            display: inline-flex;
            margin-left: 4px;
        }
        
        .message-status svg {
            width: 14px;
            height: 14px;
        }
        
        .message-image-container {
            position: relative;
            margin-bottom: 4px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .message-image {
            max-width: 250px;
            max-height: 200px;
            display: block;
            border-radius: 8px;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .message-image:active {
            opacity: 0.9;
        }

        /* Message reactions */
        .message-reactions {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }
        
        .message-reaction {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        
        .message-received .message-reaction {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .message-reaction-count {
            font-size: 10px;
            font-weight: bold;
        }
        
        .reaction-picker {
            position: absolute;
            background-color: var(--card-bg);
            border-radius: 24px;
            -webkit-box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 6px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            gap: 4px;
            z-index: 100;
            -webkit-transform-origin: center;
            transform-origin: center;
        }
        
        .reaction-picker-item {
            font-size: 18px;
            padding: 6px;
            cursor: pointer;
            border-radius: 50%;
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
        }
        
        .reaction-picker-item:active {
            background-color: var(--secondary-bg);
            -webkit-transform: scale(1.1);
            transform: scale(1.1);
        }
        
        /* Top message action buttons */
        .message-action-buttons {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            gap: 10px;
            margin-right: 10px;
        }
        
        .message-action-btn {
            background: none;
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 14px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            cursor: pointer;
            -webkit-transition: background-color 0.2s;
            transition: background-color 0.2s;
        }
        
        .message-action-btn:active {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .message-action-btn svg {
            margin-right: 4px;
            width: 18px;
            height: 18px;
        }
        
        .chat-input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            z-index: 100;
            padding: 8px 16px;
            height: var(--input-height);
        }
        
        .chat-input {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            background-color: var(--secondary-bg);
            padding: 4px 8px;
            border-radius: 24px;
        }
        
        .dark .chat-input {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .media-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: none;
            border: none;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            color: var(--secondary-text);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .media-button:active {
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
            color: var(--accent-color);
        }

        /* Emoji button */
        .emoji-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: none;
            border: none;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            color: var(--secondary-text);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .emoji-button:active {
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
            color: var(--accent-color);
        }
        
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 16px 16px 0 0;
            -webkit-box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            padding: 16px;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .emoji-category {
            margin-bottom: 16px;
        }
        
        .emoji-category-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--secondary-text);
        }
        
        .emoji-grid {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .emoji-item {
            font-size: 20px;
            height: 36px;
            width: 36px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
        }
        
        .emoji-item:active {
            background-color: var(--secondary-bg);
            -webkit-transform: scale(1.1);
            transform: scale(1.1);
        }
        
        .message-input-container {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            position: relative;
            margin: 0 8px;
        }
        
        .message-input {
            width: 100%;
            padding: 10px 0;
            border: none;
            border-radius: 0;
            font-size: 16px;
            background: none;
            color: var(--text-color);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            -webkit-user-select: text;
            user-select: text;
        }
        
        .message-input:focus {
            outline: none;
        }
        
        .send-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: none;
            border: none;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            color: var(--accent-color);
        }
        
        .send-button:active {
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
        }

        /* Custom image preview */
        .custom-image-preview {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .custom-image-preview-content {
            position: relative;
            max-width: 90%;
            max-height: 80vh;
        }
        
        .custom-image-preview img {
            max-width: 100%;
            max-height: 80vh;
            -o-object-fit: contain;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .custom-image-preview-actions {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            gap: 20px;
            padding: 10px;
        }
        
        .custom-image-preview-action {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
        }
        
        .custom-image-preview-action:active {
            background-color: rgba(255, 255, 255, 0.4);
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
        }
        
        .custom-image-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* Image preview container - REDUCED SIZE */
        .image-preview-container {
            position: relative;
            margin-top: 8px;
            margin-bottom: 8px;
            max-width: 150px;
            max-height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 100px;
            -o-object-fit: contain;
            object-fit: contain;
            display: block;
        }
        
        .image-preview-close {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .image-preview-close:active {
            background: rgba(0, 0, 0, 0.7);
        }
        
        .image-preview-close svg {
            width: 14px;
            height: 14px;
        }
                
        .input-file {
            display: none;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
        }
        
        .modal-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            -webkit-box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 18px;
            color: var(--text-color);
        }
        
        .modal-body {
            padding: 16px;
            color: var(--text-color);
        }
        
        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-pack: end;
            -webkit-justify-content: flex-end;
            justify-content: flex-end;
            gap: 8px;
        }
        
        .modal-button {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
        
        .modal-button-cancel {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--secondary-text);
        }
        
        .modal-button-cancel:active {
            background-color: var(--secondary-bg);
        }
        
        .modal-button-confirm {
            background: var(--accent-gradient);
            color: white;
            border: none;
        }
        
        .modal-button-confirm:active {
            background: -webkit-linear-gradient(315deg, var(--accent-color-dark), var(--accent-color));
            background: linear-gradient(135deg, var(--accent-color-dark), var(--accent-color));
        }
        
        .modal-button-danger {
            background: -webkit-linear-gradient(315deg, var(--error-color), var(--error-color-dark));
            background: linear-gradient(135deg, var(--error-color), var(--error-color-dark));
            color: white;
            border: none;
        }
        
        .modal-button-danger:active {
            background: -webkit-linear-gradient(315deg, var(--error-color-dark), var(--error-color));
            background: linear-gradient(135deg, var(--error-color-dark), var(--error-color));
        }
        
        /* Compose button */
        .compose-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-gradient);
            color: white;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-box-shadow: 0 4px 8px rgba(93, 92, 222, 0.3);
            box-shadow: 0 4px 8px rgba(93, 92, 222, 0.3);
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            z-index: 90;
        }
        
        .compose-button:active {
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
            -webkit-box-shadow: 0 2px 4px rgba(93, 92, 222, 0.3);
            box-shadow: 0 2px 4px rgba(93, 92, 222, 0.3);
        }
        
        /* Batch actions bar */
        .batch-actions-bar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            padding: 12px 16px;
            background-color: var(--accent-color);
            color: white;
            z-index: 95;
            -webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .batch-actions-title {
            font-weight: 600;
        }

        .batch-action-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            margin-left: 8px;
            cursor: pointer;
        }

        .batch-action-button:active {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Message sending animation */
        .message-sending {
            opacity: 0.7;
            position: relative;
        }
        
        .message-sending::after {
            content: '';
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: transparent;
            border-radius: 50%;
        }
                
        /* Last seen indicator - enhanced */
        .last-seen-indicator {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 4px;
        }
        
        .user-last-active {
            font-style: italic;
            opacity: 0.9;
        }
        
        /* Fix for mobile keyboard */
        @media screen and (max-height: 600px) {
            .chat-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
            }
            
            .chat-input-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 1000;
            }
            
            .chat-messages {
                margin-top: var(--header-height);
                margin-bottom: var(--input-height);
                height: calc(100vh - var(--header-height) - var(--input-height));
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
            }
        }
        
        /* Loading spinner */
        .loading {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            height: 100%;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(93, 92, 222, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-color);
        }
        
        /* Banner notifications */
        .banner-notification {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            padding: 16px;
            color: white;
            z-index: 2000;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border-radius: 0 0 12px 12px;
        }
        
        .banner-notification.success {
            background: -webkit-linear-gradient(315deg, var(--success-color), var(--success-color-dark));
            background: linear-gradient(135deg, var(--success-color), var(--success-color-dark));
        }
        
        .banner-notification.error {
            background: -webkit-linear-gradient(315deg, var(--error-color), var(--error-color-dark));
            background: linear-gradient(135deg, var(--error-color), var(--error-color-dark));
        }
        
        .banner-notification.warning {
            background: -webkit-linear-gradient(315deg, var(--warning-color), var(--warning-color-dark));
            background: linear-gradient(135deg, var(--warning-color), var(--warning-color-dark));
        }
        
        .banner-notification.info {
            background: -webkit-linear-gradient(315deg, var(--info-color), var(--info-color-dark));
            background: linear-gradient(135deg, var(--info-color), var(--info-color-dark));
        }
        
        .banner-content {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
        }
        
        .banner-icon {
            margin-right: 12px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            min-width: 28px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }
        
        .banner-message {
            font-weight: 500;
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
        }
        
        .banner-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            opacity: 0.8;
            -webkit-transition: opacity 0.3s;
            transition: opacity 0.3s;
            padding: 4px;
            width: 28px;
            height: 28px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .banner-close:active {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 10px;
            color: white;
            background-color: #333;
            z-index: 1000;
            -webkit-box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            max-width: 90%;
        }
        
        .toast-icon {
            margin-right: 10px;
        }
                
        .toast.success {
            background: -webkit-linear-gradient(315deg, var(--success-color), var(--success-color-dark));
            background: linear-gradient(135deg, var(--success-color), var(--success-color-dark));
        }
        
        .toast.error {
            background: -webkit-linear-gradient(315deg, var(--error-color), var(--error-color-dark));
            background: linear-gradient(135deg, var(--error-color), var(--error-color-dark));
        }
        
        .toast.warning {
            background: -webkit-linear-gradient(315deg, var(--warning-color), var(--warning-color-dark));
            background: linear-gradient(135deg, var(--warning-color), var(--warning-color-dark));
        }
        
        .toast.info {
            background: -webkit-linear-gradient(315deg, var(--info-color), var(--info-color-dark));
            background: linear-gradient(135deg, var(--info-color), var(--info-color-dark));
        }

        /* Empty states */
        .empty-state {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            height: 80%;
        }
        
        .empty-state-icon {
            width: 80px;
            height: 80px;
            color: #ccc;
            margin-bottom: 20px;
        }
        
        .dark .empty-state-icon {
            color: #444;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        
        .empty-state-text {
            color: var(--secondary-text);
            max-width: 250px;
        }
        
        /* Search styles */
        .search-container {
            padding: 8px 16px;
            position: -webkit-sticky;
            position: sticky;
            top: var(--header-height);
            z-index: 90;
            background-color: var(--bg-color);
        }
        
        .search-wrapper {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            background-color: var(--secondary-bg);
            border-radius: 10px;
            padding: 8px 12px;
            -webkit-transition: all 0.2s;
            transition: all 0.2s;
        }
        
        .search-wrapper:focus-within {
            -webkit-box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.2);
            box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.2);
        }
        
        .dark .search-wrapper:focus-within {
            -webkit-box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.4);
            box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.4);
        }
        
        .search-icon {
            color: var(--secondary-text);
            margin-right: 8px;
        }
        
        .search-clear {
            background: none;
            border: none;
            color: var(--secondary-text);
            cursor: pointer;
            padding: 4px;
            margin-left: 4px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .search-clear:active {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .dark .search-clear:active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Modifications pour iOS 12 */
        @supports (-webkit-overflow-scrolling: touch) {
            /* Correction pour le débordement sur iOS */
            .chat-messages, .main, .emoji-picker {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Éviter les problèmes de sélection sur iOS */
            * {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
            }
            
            /* Permettre la sélection dans les entrées */
            input, textarea {
                -webkit-user-select: text;
            }
            
            /* Éviter le zoom sur les entrées */
            input, textarea, select, button {
                font-size: 16px;
            }
        }
        
        /* Fixes for iOS Keyboard */
        @supports (-webkit-touch-callout: none) {
            .keyboard-open .chat-input-container {
                position: absolute;
                bottom: 0;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Fallback content - will show if JS fails -->
        <div class="loading">
            <h1 style="margin-bottom: 20px; color: #5D5CDE; font-size: 24px;">ChatXchange</h1>
            <div class="spinner"></div>
            <p style="margin-top: 20px;">Chargement en cours...</p>
            <noscript>
                <p style="margin-top: 20px; color: #ff4747; text-align: center;">
                    Cette application nécessite JavaScript.<br>
                    Veuillez l'activer pour continuer.
                </p>
            </noscript>
        </div>
    </div>

    <!-- Polyfills pour iOS 12 -->
    <script>
        // Polyfill for Object.entries
        if (!Object.entries) {
            Object.entries = function(obj) {
                var ownProps = Object.keys(obj),
                i = ownProps.length,
                entries = new Array(i);
                while (i--) {
                    entries[i] = [ownProps[i], obj[ownProps[i]]];
                }
                return entries;
            };
        }
        
        // Polyfill for Array.find
        if (!Array.prototype.find) {
            Object.defineProperty(Array.prototype, 'find', {
                value: function(predicate) {
                    if (this == null) {
                        throw new TypeError('"this" is null or not defined');
                    }
                    var o = Object(this);
                    var len = o.length >>> 0;
                    if (typeof predicate !== 'function') {
                        throw new TypeError('predicate must be a function');
                    }
                    var thisArg = arguments[1];
                    var k = 0;
                    while (k < len) {
                        var kValue = o[k];
                        if (predicate.call(thisArg, kValue, k, o)) {
                            return kValue;
                        }
                        k++;
                    }
                    return undefined;
                },
                configurable: true,
                writable: true
            });
        }

        // Polyfill for includes
        if (!Array.prototype.includes) {
            Object.defineProperty(Array.prototype, 'includes', {
                value: function(searchElement, fromIndex) {
                    if (this == null) {
                        throw new TypeError('"this" is null or not defined');
                    }
                    var o = Object(this);
                    var len = o.length >>> 0;
                    if (len === 0) {
                        return false;
                    }
                    var n = fromIndex | 0;
                    var k = Math.max(n >= 0 ? n : len + n, 0);
                    function sameValueZero(x, y) {
                        return x === y || (typeof x === 'number' && typeof y === 'number' && isNaN(x) && isNaN(y));
                    }
                    while (k < len) {
                        if (sameValueZero(o[k], searchElement)) {
                            return true;
                        }
                        k++;
                    }
                    return false;
                }
            });
        }

        // Polyfill for String.prototype.includes
        if (!String.prototype.includes) {
            String.prototype.includes = function(search, start) {
                'use strict';
                if (search instanceof RegExp) {
                    throw TypeError('first argument must not be a RegExp');
                } 
                if (start === undefined) { start = 0; }
                return this.indexOf(search, start) !== -1;
            };
        }

        // Polyfill for Set
        if (typeof Set !== 'function') {
            window.Set = function() {
                this.items = [];
                
                this.has = function(value) {
                    return this.items.indexOf(value) !== -1;
                };
                
                this.add = function(value) {
                    if (!this.has(value)) {
                        this.items.push(value);
                    }
                    return this;
                };
                
                this.delete = function(value) {
                    var index = this.items.indexOf(value);
                    if (index !== -1) {
                        this.items.splice(index, 1);
                        return true;
                    }
                    return false;
                };
                
                this.clear = function() {
                    this.items = [];
                };
                
                this.size = 0;
                Object.defineProperty(this, 'size', {
                    get: function() {
                        return this.items.length;
                    }
                });
            };
        }

        // Polyfill for Element.remove
        if (!('remove' in Element.prototype)) {
            Element.prototype.remove = function() {
                if (this.parentNode) {
                    this.parentNode.removeChild(this);
                }
            };
        }
    </script>

    <!-- Firebase SDK avec versions compatibles pour iOS 12 -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-storage.js"></script>
    
    <script>
        // Check for dark mode
        function checkDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
                return true;
            }
            return false;
        }
        
        // Listen for dark mode changes
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(event) {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                    if (app && app.currentUser) {
                        app.isDarkMode = true;
                        app.saveThemePreference();
                    }
                } else {
                    document.documentElement.classList.remove('dark');
                    if (app && app.currentUser) {
                        app.isDarkMode = false;
                        app.saveThemePreference();
                    }
                }
            });
        }
        
        // Initialize Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyAHkI_ZfUX0jheLQyYy49iYLh1LUwxw26Y",
            authDomain: "nlp-9057d.firebaseapp.com",
            projectId: "nlp-9057d",
            storageBucket: "nlp-9057d.appspot.com",
            messagingSenderId: "713755293336",
            appId: "1:713755293336:web:89638ccb2839975f2802ed",
            measurementId: "G-4HVY16QT8M"
        };
        
        firebase.initializeApp(firebaseConfig);
        var auth = firebase.auth();
        var db = firebase.firestore();
        var storage = firebase.storage();
        
        // Main application logic
        var app = {
            currentUser: null,
            currentScreen: 'loading', // loading, auth, main, chat
            currentTab: 'conversations', // conversations, users, profile, ai
            conversations: [],
            filteredConversations: [],
            users: [],
            filteredUsers: [],
            messages: [],
            currentChat: null,
            activeAuthTab: 'login',
            isDarkMode: checkDarkMode(),
            accentColor: '#5D5CDE',
            accentGradient: 'var(--accent-gradient)',
            notificationTimer: null,
            bannerNotificationTimer: null,
            selectedImage: null,
            imagePreview: null,
            selectionMode: false,
            isConversationSelectionMode: false,
            selectedMessages: new Set(),
            selectedConversations: new Set(),
            lastTouchStart: 0,
            longPressTimer: null,
            fullScreenImage: null,
            actionMenu: null,
            chatMenu: null,
            modal: null,
            isEditing: false,
            editingField: null,
            searchQuery: '',
            isRecording: false,
            mediaRecorder: null,
            audioChunks: [],
            recordingStartTime: null,
            messageModCounter: {},  // Track how many times each message was modified
            emojiPickerVisible: false, // Track emoji picker visibility
            selectedEmojis: {}, // Track selected emojis for messages
            customImagePreview: null,
            availableEmojis: ['👍', '❤️', '😂', '😮', '😢', '👏'],
            recentEmojis: [], // Track recently used emojis
            reactionPickerVisible: false,
            reactionPickerTargetId: null,
            totalUserCount: 0, // Track total user count
            maxUserLimit: 55, // Maximum number of users allowed
            sendingMessages: [], // Track sending messages for UI feedback
            onlineStatusInterval: null, // Interval for updating online status
            
            // Initialize app
            init: function() {
                // Show loading state first
                this.renderLoadingScreen();
                
                // Then proceed with auth check
                this.setupAuthListener();
                this.setupCopyProtection();
                
                // Check total user count
                this.checkUserCount();
                
                // Setup document events
                document.addEventListener('click', function(e) {
                    // Close menus if clicking outside
                    if (app.actionMenu && !e.target.closest('.action-menu') && !e.target.closest('.message-bubble')) {
                        app.closeActionMenu();
                    }
                    
                    if (app.chatMenu && !e.target.closest('.chat-menu') && !e.target.closest('.chat-menu-button')) {
                        app.closeChatMenu();
                    }
                    
                    if (app.customImagePreview && !e.target.closest('.custom-image-preview-content') && !e.target.closest('.message-image')) {
                        app.closeCustomImagePreview();
                    }
                    
                    // Close emoji picker when clicking outside
                    if (app.emojiPickerVisible && !e.target.closest('.emoji-picker') && !e.target.closest('.emoji-button')) {
                        app.closeEmojiPicker();
                    }
                    
                    // Close reaction picker when clicking outside
                    if (app.reactionPickerVisible && !e.target.closest('.reaction-picker') && !e.target.closest('.message-bubble')) {
                        app.closeReactionPicker();
                    }
                });
                
                // Start online status ping
                this.startOnlineStatusInterval();
                
                // Listen for resize events to adjust layout for keyboard
                window.addEventListener('resize', this.handleResize.bind(this));
                
                // Add input blur and focus handlers for iOS keyboard
                document.addEventListener('focusin', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        app.handleInputFocus();
                    }
                });
                
                document.addEventListener('focusout', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        app.handleInputBlur();
                    }
                });
                
                // Écouter les événements pour iOS PWA
                window.addEventListener('beforeinstallprompt', function(e) {
                    // Prévenir le comportement par défaut de Chrome en stockant l'événement
                    e.preventDefault();
                    // Stocker l'événement pour qu'il puisse être déclenché plus tard
                    app.deferredPrompt = e;
                });
                
                window.addEventListener('appinstalled', function() {
                    // L'application a été installée
                    app.showNotification("Application installée avec succès", "success");
                    app.deferredPrompt = null;
                });
            },
            
            // Handle window resize
            handleResize: function() {
                if (this.currentScreen === 'chat') {
                    // Scroll messages to bottom on resize, especially when keyboard appears/disappears
                    setTimeout(function() {
                        app.scrollToBottom();
                    }, 100);
                }
            },
            
            // Handle input focus - adjust for keyboard appearance
            handleInputFocus: function() {
                if (this.currentScreen === 'chat') {
                    // Add a class to the body when keyboard is likely visible
                    document.body.classList.add('keyboard-open');
                    
                    // Scroll messages to bottom after a brief delay
                    setTimeout(function() {
                        app.scrollToBottom();
                    }, 300);
                }
            },
            
            // Handle input blur - adjust for keyboard disappearance
            handleInputBlur: function() {
                // Remove the keyboard-open class
                document.body.classList.remove('keyboard-open');
            },
            
            // Start interval to update online status
            startOnlineStatusInterval: function() {
                if (this.onlineStatusInterval) {
                    clearInterval(this.onlineStatusInterval);
                }
                
                this.onlineStatusInterval = setInterval(function() {
                    if (app.currentUser && app.currentUser.uid) {
                        app.updateOnlineStatus();
                    }
                }, 60000); // Update every minute
            },
            
            // Update online status
            updateOnlineStatus: function() {
                try {
                    if (!this.currentUser || !this.currentUser.uid) return;
                    
                    db.collection('users').doc(this.currentUser.uid).update({
                        online: true,
                        lastSeen: firebase.firestore.Timestamp.now()
                    });
                } catch (error) {
                    console.log("Error updating online status:", error);
                }
            },
            
            // Check total user count
            checkUserCount: function() {
                try {
                    db.collection('users').get().then(function(snapshot) {
                        app.totalUserCount = snapshot.size;
                    }).catch(function(error) {
                        console.log("Error checking user count:", error);
                    });
                } catch (error) {
                    console.log("Error checking user count:", error);
                }
            },
            
            // Setup copy protection
            setupCopyProtection: function() {
                // Prevent context menu
                document.addEventListener('contextmenu', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return true;
                    }
                    return false;
                });
                
                // Prevent copy
                document.addEventListener('copy', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return true;
                    }
                    e.preventDefault();
                    return false;
                });
                
                // Prevent cut
                document.addEventListener('cut', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return true;
                    }
                    e.preventDefault();
                    return false;
                });
            },
            
            // Render loading screen
            renderLoadingScreen: function() {
                var appElement = document.getElementById('app');
                if (!appElement) return;
                
                appElement.innerHTML = 
                    '<div class="loading" style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: var(--bg-color);">' +
                        '<div style="margin-bottom: 40px; text-align: center;">' +
                            '<h1 style="font-size: 32px; margin-bottom: 10px; color: #5D5CDE;">ChatXchange</h1>' +
                            '<p style="color: var(--secondary-text);">Chargement en cours...</p>' +
                        '</div>' +
                        '<div class="spinner"></div>' +
                    '</div>';
            },
            
            // Setup authentication listener
            setupAuthListener: function() {
                auth.onAuthStateChanged(function(user) {
                    if (user) {
                        // User is signed in
                        try {
                            // Get user profile from Firestore
                            db.collection('users').doc(user.uid).get().then(function(userDoc) {
                                if (userDoc.exists) {
                                    var userData = userDoc.data();
                                    
                                    // Update online status
                                    db.collection('users').doc(user.uid).update({
                                        online: true,
                                        lastSeen: firebase.firestore.Timestamp.now()
                                    });
                                    
                                    // Set theme
                                    if (userData.theme) {
                                        if (userData.theme.mode === 'dark') {
                                            app.toggleDarkMode(true, false);
                                        } else {
                                            app.toggleDarkMode(false, false);
                                        }
                                        
                                        if (userData.theme.color) {
                                            app.changeAccentColor(userData.theme.color, false);
                                        }
                                        
                                        if (userData.theme.gradient) {
                                            app.changeAccentGradient(userData.theme.gradient, false);
                                        }
                                    }
                                    
                                    // Set user state
                                    app.currentUser = {
                                        uid: user.uid,
                                        username: userData.username,
                                        email: userData.email,
                                        phone: userData.phone || "",
                                        bio: userData.bio || "",
                                        avatar: userData.avatar,
                                        blockedUsers: userData.blockedUsers || []
                                    };
                                    
                                    // Set app screen
                                    app.currentScreen = 'main';
                                    
                                    // Load conversations
                                    app.loadConversations();
                                    
                                    // Load users
                                    app.loadUsers();
                                    
                                    // Show welcome notification
                                    app.showBannerNotification("Bienvenue, " + userData.username + "!", 'success');
                                    
                                    // Start online status interval
                                    app.startOnlineStatusInterval();
                                    
                                    // Render UI
                                    app.render();
                                } else {
                                    // User document not found, sign out
                                    auth.signOut().then(function() {
                                        app.currentUser = null;
                                        app.currentScreen = 'auth';
                                        app.showBannerNotification('Session expirée', 'error');
                                        app.render();
                                    });
                                }
                            }).catch(function(error) {
                                console.log("Error getting user data:", error);
                                app.currentUser = null;
                                app.currentScreen = 'auth';
                                app.showBannerNotification('Erreur de connexion', 'error');
                                app.render();
                            });
                        } catch (error) {
                            console.log("Error getting user data:", error);
                            app.currentUser = null;
                            app.currentScreen = 'auth';
                            app.showBannerNotification('Erreur de connexion', 'error');
                            app.render();
                        }
                    } else {
                        // User is signed out
                        app.currentUser = null;
                        app.currentScreen = 'auth';
                        
                        // Clear intervals
                        if (app.onlineStatusInterval) {
                            clearInterval(app.onlineStatusInterval);
                            app.onlineStatusInterval = null;
                        }
                        
                        app.render();
                    }
                });
            },
            
            // Apply accent color
            applyAccentColor: function() {
                document.documentElement.style.setProperty('--accent-color', this.accentColor);
                
                // Generate dark and light variants
                var darkColor = this.adjustColorBrightness(this.accentColor, -20);
                var lightColor = this.adjustColorBrightness(this.accentColor, 20);
                
                document.documentElement.style.setProperty('--accent-color-dark', darkColor);
                document.documentElement.style.setProperty('--accent-color-light', lightColor);
            },
            
            // Apply gradient
            applyAccentGradient: function(gradient) {
                document.documentElement.style.setProperty('--accent-gradient', gradient);
            },
            
            // Adjust color brightness
            adjustColorBrightness: function(hexColor, percent) {
                var r = parseInt(hexColor.slice(1, 3), 16);
                var g = parseInt(hexColor.slice(3, 5), 16);
                var b = parseInt(hexColor.slice(5, 7), 16);
                
                r = Math.max(0, Math.min(255, r + percent));
                g = Math.max(0, Math.min(255, g + percent));
                b = Math.max(0, Math.min(255, b + percent));
                
                return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            },
            
            // Toggle dark mode
            toggleDarkMode: function(isDark, savePreference) {
                this.isDarkMode = isDark;
                
                if (isDark) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                // Save preference to user document if logged in
                if (savePreference && this.currentUser && this.currentUser.uid) {
                    this.saveThemePreference();
                }
                
                this.render();
            },
            
            // Change accent color
            changeAccentColor: function(color, savePreference) {
                this.accentColor = color;
                this.applyAccentColor();
                
                // Save preference to user document if logged in
                if (savePreference && this.currentUser && this.currentUser.uid) {
                    this.saveThemePreference();
                }
                
                this.render();
            },
            
            // Change accent gradient
            changeAccentGradient: function(gradient, savePreference) {
                this.accentGradient = gradient;
                this.applyAccentGradient(gradient);
                
                // Save preference to user document if logged in
                if (savePreference && this.currentUser && this.currentUser.uid) {
                    this.saveThemePreference();
                }
                
                this.render();
            },
            
            // Save theme preference
            saveThemePreference: function() {
                if (this.currentUser && this.currentUser.uid) {
                    db.collection('users').doc(this.currentUser.uid).update({
                        theme: { 
                            mode: this.isDarkMode ? 'dark' : 'light', 
                            color: this.accentColor,
                            gradient: this.accentGradient
                        }
                    }).catch(function(error) {
                        console.log("Error updating theme preference:", error);
                    });
                }
            },
            
            // Switch auth tab
            switchAuthTab: function(tab) {
                this.activeAuthTab = tab;
                this.render();
            },
            
            // Handle login
            handleLogin: function(event) {
                event.preventDefault();
                
                var email = document.getElementById('login-email').value;
                var password = document.getElementById('login-password').value;
                
                try {
                    app.showBannerNotification("Connexion en cours...", "info");
                    auth.signInWithEmailAndPassword(email, password).catch(function(error) {
                        console.log("Login error:", error);
                        app.showBannerNotification("Email ou mot de passe incorrect", "error");
                    });
                    // Auth state change listener will handle the rest
                } catch (error) {
                    console.log("Login error:", error);
                    app.showBannerNotification("Email ou mot de passe incorrect", "error");
                }
            },
            
            // Handle registration
            handleRegister: function(event) {
                event.preventDefault();
                
                var username = document.getElementById('register-username').value;
                var email = document.getElementById('register-email').value;
                var phone = document.getElementById('register-phone').value;
                var password = document.getElementById('register-password').value;
                var confirmPassword = document.getElementById('register-confirm-password').value;
                
                // Check if user limit is reached
                if (app.totalUserCount >= app.maxUserLimit) {
                    app.showBannerNotification("Limite de " + app.maxUserLimit + " utilisateurs atteinte", "error");
                    return;
                }
                
                // Basic validation
                if (password !== confirmPassword) {
                    app.showBannerNotification("Les mots de passe ne correspondent pas", "error");
                    return;
                }
                
                try {
                    app.showBannerNotification("Création du compte...", "info");
                    
                    // Check if username exists
                    db.collection('users').where('username', '==', username).get().then(function(usernameCheck) {
                        if (!usernameCheck.empty) {
                            app.showBannerNotification("Ce nom d'utilisateur est déjà pris", "error");
                            return;
                        }
                        
                        // Create user
                        auth.createUserWithEmailAndPassword(email, password).then(function(userCredential) {
                            var user = userCredential.user;
                            
                            // Create user document
                            db.collection('users').doc(user.uid).set({
                                username: username,
                                email: email,
                                phone: phone,
                                bio: "",
                                avatar: null,
                                online: true,
                                lastSeen: firebase.firestore.Timestamp.now(),
                                createdAt: firebase.firestore.Timestamp.now(),
                                theme: { 
                                    mode: app.isDarkMode ? 'dark' : 'light', 
                                    color: app.accentColor,
                                    gradient: app.accentGradient
                                },
                                blockedUsers: []
                            }).then(function() {
                                // Update profile
                                user.updateProfile({
                                    displayName: username
                                }).then(function() {
                                    app.showBannerNotification("Compte créé avec succès", "success");
                                    app.totalUserCount++;
                                }).catch(function(error) {
                                    console.log("Error updating profile:", error);
                                });
                            }).catch(function(error) {
                                console.log("Error creating user document:", error);
                                app.showBannerNotification("Erreur lors de l'inscription", "error");
                            });
                        }).catch(function(error) {
                            console.log("Registration error:", error);
                            app.showBannerNotification("Erreur lors de l'inscription", "error");
                        });
                    }).catch(function(error) {
                        console.log("Error checking username:", error);
                        app.showBannerNotification("Erreur lors de l'inscription", "error");
                    });
                } catch (error) {
                    console.log("Registration error:", error);
                    app.showBannerNotification("Erreur lors de l'inscription", "error");
                }
            },
            
            // Handle logout
            handleLogout: function() {
                // Show confirmation dialog
                app.showModal({
                    title: 'Déconnexion',
                    content: 'Êtes-vous sûr de vouloir vous déconnecter ?',
                    actions: [
                        {
                            label: 'Annuler',
                            action: function() { app.closeModal(); },
                            className: 'modal-button-cancel'
                        },
                        {
                            label: 'Déconnecter',
                            action: function() {
                                try {
                                    app.showBannerNotification("Déconnexion en cours...", "info");
                                    
                                    if (app.currentUser) {
                                        // Update online status
                                        db.collection('users').doc(app.currentUser.uid).update({
                                            online: false,
                                            lastSeen: firebase.firestore.Timestamp.now()
                                        }).then(function() {
                                            // Sign out
                                            auth.signOut().then(function() {
                                                app.showBannerNotification("Déconnexion réussie", "success");
                                                app.closeModal();
                                                
                                                // Clear intervals
                                                if (app.onlineStatusInterval) {
                                                    clearInterval(app.onlineStatusInterval);
                                                    app.onlineStatusInterval = null;
                                                }
                                            }).catch(function(error) {
                                                console.log("Logout error:", error);
                                                app.showBannerNotification("Erreur lors de la déconnexion", "error");
                                                app.closeModal();
                                            });
                                        }).catch(function(error) {
                                            console.log("Update status error:", error);
                                            // Continue with logout anyway
                                            auth.signOut();
                                            app.closeModal();
                                        });
                                    } else {
                                        auth.signOut();
                                        app.closeModal();
                                    }
                                } catch (error) {
                                    console.log("Logout error:", error);
                                    app.showBannerNotification("Erreur lors de la déconnexion", "error");
                                    app.closeModal();
                                }
                            },
                            className: 'modal-button-confirm'
                        }
                    ]
                });
            },
            
            // Handle account deletion
            handleDeleteAccount: function() {
                // Show confirmation dialog
                app.showModal({
                    title: 'Supprimer le compte',
                    content: 'Êtes-vous sûr de vouloir supprimer définitivement votre compte ? Cette action est irréversible.',
                    actions: [
                        {
                            label: 'Annuler',
                            action: function() { app.closeModal(); },
                            className: 'modal-button-cancel'
                        },
                        {
                            label: 'Supprimer',
                            action: function() {
                                try {
                                    app.showBannerNotification("Suppression du compte...", "info");
                                    
                                    // Delete user document
                                    db.collection('users').doc(app.currentUser.uid).delete().then(function() {
                                        // Delete user auth
                                        var user = auth.currentUser;
                                        if (user) {
                                            user.delete().then(function() {
                                                app.showBannerNotification("Compte supprimé avec succès", "success");
                                                app.closeModal();
                                                app.totalUserCount--;
                                                
                                                // Clear intervals
                                                if (app.onlineStatusInterval) {
                                                    clearInterval(app.onlineStatusInterval);
                                                    app.onlineStatusInterval = null;
                                                }
                                            }).catch(function(error) {
                                                console.log("Account deletion error:", error);
                                                app.showBannerNotification("Erreur lors de la suppression du compte", "error");
                                                app.closeModal();
                                            });
                                        }
                                    }).catch(function(error) {
                                        console.log("Document deletion error:", error);
                                        app.showBannerNotification("Erreur lors de la suppression du compte", "error");
                                        app.closeModal();
                                    });
                                } catch (error) {
                                    console.log("Account deletion error:", error);
                                    app.showBannerNotification("Erreur lors de la suppression du compte", "error");
                                    app.closeModal();
                                }
                            },
                            className: 'modal-button-danger'
                        }
                    ]
                });
            },
            
            // Switch tabs in main screen
            switchTab: function(tab) {
                this.currentTab = tab;
                this.searchQuery = '';
                this.exitSelectionMode();
                this.render();
            },
            
            // Search handling
            handleSearch: function(query) {
                this.searchQuery = query;
                
                if (this.currentTab === 'conversations') {
                    this.filterConversations();
                } else if (this.currentTab === 'users') {
                    this.filterUsers();
                }
                
                this.render();
            },
            
            // Filter conversations based on search query
            filterConversations: function() {
                if (!this.searchQuery) {
                    this.filteredConversations = this.conversations;
                    return;
                }
                
                var query = this.searchQuery.toLowerCase();
                var filtered = [];
                
                for (var i = 0; i < this.conversations.length; i++) {
                    var conversation = this.conversations[i];
                    if (conversation.otherUser.username.toLowerCase().indexOf(query) !== -1 ||
                       (conversation.lastMessage && conversation.lastMessage.toLowerCase().indexOf(query) !== -1)) {
                        filtered.push(conversation);
                    }
                }
                
                this.filteredConversations = filtered;
            },
            
            // Filter users based on search query
            filterUsers: function() {
                if (!this.searchQuery) {
                    this.filteredUsers = this.users;
                    return;
                }
                
                var query = this.searchQuery.toLowerCase();
                var filtered = [];
                
                for (var i = 0; i < this.users.length; i++) {
                    var user = this.users[i];
                    if (user.username.toLowerCase().indexOf(query) !== -1 ||
                       (user.phone && user.phone.indexOf(query) !== -1) ||
                       (user.bio && user.bio.toLowerCase().indexOf(query) !== -1)) {
                        filtered.push(user);
                    }
                }
                
                this.filteredUsers = filtered;
            },
            
            // Clear search
            clearSearch: function() {
                this.searchQuery = '';
                this.filteredConversations = this.conversations;
                this.filteredUsers = this.users;
                this.render();
            },
            
            // Load conversations
            loadConversations: function() {
                try {
                    // Get conversations where user is a participant
                    var query = db.collection('conversations')
                        .where('participants', 'array-contains', this.currentUser.uid);
                    
                    // Live listener
                    query.onSnapshot(function(snapshot) {
                        var conversations = [];
                        
                        snapshot.forEach(function(doc) {
                            var conversationData = doc.data();
                            
                            // Find the other participant
                            var otherUserId = null;
                            for (var i = 0; i < conversationData.participants.length; i++) {
                                if (conversationData.participants[i] !== app.currentUser.uid) {
                                    otherUserId = conversationData.participants[i];
                                    break;
                                }
                            }
                            
                            if (otherUserId) {
                                try {
                                    // Get other user data
                                    db.collection('users').doc(otherUserId).get().then(function(userDoc) {
                                        if (userDoc.exists) {
                                            var userData = userDoc.data();
                                            
                                            // Check if user is blocked
                                            var isBlocked = app.currentUser.blockedUsers && 
                                                           app.currentUser.blockedUsers.indexOf(otherUserId) !== -1;
                                            
                                            // Check if conversation is deleted for current user
                                            var isDeleted = conversationData.deleted && 
                                                           conversationData.deleted[app.currentUser.uid];
                                            
                                            // Only add non-deleted conversations
                                            if (!isDeleted) {
                                                // Calculate unread count
                                                var unreadCount = 0;
                                                
                                                // Only perform this check if there's a last message and it wasn't sent by the current user
                                                if (conversationData.lastMessageSenderId && 
                                                    conversationData.lastMessageSenderId !== app.currentUser.uid) {
                                                    
                                                    // Get unread messages
                                                    db.collection('messages')
                                                        .where('conversationId', '==', doc.id)
                                                        .where('senderId', '==', otherUserId)
                                                        .where('read', '==', false)
                                                        .get().then(function(unreadQuery) {
                                                            unreadCount = unreadQuery.size;
                                                            
                                                            // Update conversation object
                                                            for (var i = 0; i < app.conversations.length; i++) {
                                                                if (app.conversations[i].id === doc.id) {
                                                                    app.conversations[i].unreadCount = unreadCount;
                                                                    app.render();
                                                                    break;
                                                                }
                                                            }
                                                        });
                                                }
                                                
                                                // Convert Firestore timestamp to JavaScript Date
                                                var lastMessageTimestamp = conversationData.lastMessageTimestamp ? 
                                                                        conversationData.lastMessageTimestamp.toDate() : 
                                                                        new Date();
                                                
                                                var lastSeen = userData.lastSeen ? 
                                                             userData.lastSeen.toDate() : 
                                                             null;
                                                
                                                conversations.push({
                                                    id: doc.id,
                                                    otherUser: {
                                                        uid: otherUserId,
                                                        username: userData.username,
                                                        avatar: userData.avatar,
                                                        online: userData.online,
                                                        lastSeen: lastSeen,
                                                        isBlocked: isBlocked
                                                    },
                                                    lastMessage: conversationData.lastMessage,
                                                    lastMessageType: conversationData.lastMessageType || 'text',
                                                    lastMessageTimestamp: lastMessageTimestamp,
                                                    lastMessageSenderId: conversationData.lastMessageSenderId,
                                                    unreadCount: unreadCount,
                                                    isBlocked: isBlocked
                                                });
                                                
                                                // Sort by last message time
                                                conversations.sort(function(a, b) {
                                                    return b.lastMessageTimestamp - a.lastMessageTimestamp;
                                                });
                                                
                                                app.conversations = conversations;
                                                app.filterConversations();
                                                app.render();
                                            }
                                        }
                                    }).catch(function(error) {
                                        console.log("Error getting user:", error);
                                    });
                                } catch (error) {
                                    console.log("Error getting user:", error);
                                }
                            }
                        });
                    }, function(error) {
                        console.log("Error loading conversations:", error);
                        app.showBannerNotification("Erreur lors du chargement des conversations", "error");
                    });
                    
                } catch (error) {
                    console.log("Error loading conversations:", error);
                    app.showBannerNotification("Erreur lors du chargement des conversations", "error");
                }
            },
            
            // Delete conversation (for current user only)
            deleteConversation: function(conversationId) {
                // Show confirmation modal
                app.showModal({
                    title: 'Supprimer la conversation',
                    content: 'Êtes-vous sûr de vouloir supprimer cette conversation ? Cette action ne peut pas être annulée.',
                    actions: [
                        {
                            label: 'Annuler',
                            action: function() { app.closeModal(); },
                            className: 'modal-button-cancel'
                        },
                        {
                            label: 'Supprimer',
                            action: function() {
                                try {
                                    var conversationRef = db.collection('conversations').doc(conversationId);
                                    conversationRef.get().then(function(conversationDoc) {
                                        if (conversationDoc.exists) {
                                            // Mark conversation as deleted for current user
                                            var deleted = conversationDoc.data().deleted || {};
                                            deleted[app.currentUser.uid] = true;
                                            
                                            conversationRef.update({ deleted: deleted }).then(function() {
                                                app.showBannerNotification("Conversation supprimée", "success");
                                                
                                                // If in chat screen, go back to main
                                                if (app.currentScreen === 'chat' && app.currentChat && app.currentChat.id === conversationId) {
                                                    app.currentScreen = 'main';
                                                    app.currentChat = null;
                                                    app.render();
                                                }
                                            });
                                        }
                                        
                                        app.closeModal();
                                    }).catch(function(error) {
                                        console.log("Error getting conversation:", error);
                                        app.showBannerNotification("Erreur lors de la suppression", "error");
                                        app.closeModal();
                                    });
                                } catch (error) {
                                    console.log("Error deleting conversation:", error);
                                    app.showBannerNotification("Erreur lors de la suppression", "error");
                                    app.closeModal();
                                }
                            },
                            className: 'modal-button-danger'
                        }
                    ]
                });
            },
            
            // Delete multiple conversations
            deleteSelectedConversations: function() {
                if (!this.selectedConversations || this.selectedConversations.length === 0) return;
                
                // Show confirmation modal
                app.showModal({
                    title: 'Supprimer les conversations',
                    content: 'Êtes-vous sûr de vouloir supprimer ' + this.selectedConversations.length + ' conversation(s) ? Cette action ne peut pas être annulée.',
                    actions: [
                        {
                            label: 'Annuler',
                            action: function() { app.closeModal(); },
                            className: 'modal-button-cancel'
                        },
                        {
                            label: 'Supprimer',
                            action: function() {
                                try {
                                    var batch = db.batch();
                                    
                                    app.selectedConversations.forEach(function(conversationId) {
                                        var conversationRef = db.collection('conversations').doc(conversationId);
                                        conversationRef.get().then(function(conversationDoc) {
                                            if (conversationDoc.exists) {
                                                // Mark conversation as deleted for current user
                                                var deleted = conversationDoc.data().deleted || {};
                                                deleted[app.currentUser.uid] = true;
                                                
                                                batch.update(conversationRef, { deleted: deleted });
                                            }
                                        });
                                    });
                                    
                                    batch.commit().then(function() {
                                        app.showBannerNotification(app.selectedConversations.length + " conversation(s) supprimée(s)", "success");
                                        
                                        // Exit selection mode
                                        app.exitConversationSelectionMode();
                                        app.closeModal();
                                    });
                                } catch (error) {
                                    console.log("Error deleting conversations:", error);
                                    app.showBannerNotification("Erreur lors de la suppression", "error");
                                    app.closeModal();
                                }
                            },
                            className: 'modal-button-danger'
                        }
                    ]
                });
            },
            
            // Load users
            loadUsers: function() {
                try {
                    // Get all users
                    db.collection('users').get().then(function(snapshot) {
                        var users = [];
                        
                        snapshot.forEach(function(doc) {
                            // Don't include current user
                            if (doc.id !== app.currentUser.uid) {
                                var userData = doc.data();
                                
                                // Check if user is blocked
                                var isBlocked = app.currentUser.blockedUsers && 
                                               app.currentUser.blockedUsers.indexOf(doc.id) !== -1;
                                
                                // Convert Firestore timestamp to JavaScript Date
                                var lastSeen = userData.lastSeen ? 
                                             userData.lastSeen.toDate() : 
                                             null;
                                
                                users.push({
                                    uid: doc.id,
                                    username: userData.username,
                                    email: userData.email,
                                    phone: userData.phone || "",
                                    bio: userData.bio || "",
                                    avatar: userData.avatar,
                                    online: userData.online,
                                    lastSeen: lastSeen,
                                    isBlocked: isBlocked
                                });
                            }
                        });
                        
                        app.users = users;
                        app.filterUsers();
                        app.render();
                        
                        // Set up real-time listener for online status updates
                        app.setupOnlineStatusListener();
                    }).catch(function(error) {
                        console.log("Error loading users:", error);
                        app.showBannerNotification("Erreur lors du chargement des utilisateurs", "error");
                    });
                } catch (error) {
                    console.log("Error loading users:", error);
                    app.showBannerNotification("Erreur lors du chargement des utilisateurs", "error");
                }
            },
            
            // Setup online status listener
            setupOnlineStatusListener: function() {
                // Listen for changes to users' online status
                var usersRef = db.collection('users');
                
                // Create listener for online status changes
                usersRef.onSnapshot(function(snapshot) {
                    snapshot.docChanges().forEach(function(change) {
                        // Skip current user
                        if (change.doc.id === app.currentUser.uid) return;
                        
                        var userData = change.doc.data();
                        
                        // Update users list
                        for (var i = 0; i < app.users.length; i++) {
                            if (app.users[i].uid === change.doc.id) {
                                app.users[i].online = userData.online;
                                app.users[i].lastSeen = userData.lastSeen ? userData.lastSeen.toDate() : app.users[i].lastSeen;
                                break;
                            }
                        }
                        
                        // Update conversations list
                        for (var j = 0; j < app.conversations.length; j++) {
                            if (app.conversations[j].otherUser.uid === change.doc.id) {
                                app.conversations[j].otherUser.online = userData.online;
                                app.conversations[j].otherUser.lastSeen = userData.lastSeen ? userData.lastSeen.toDate() : app.conversations[j].otherUser.lastSeen;
                                break;
                            }
                        }
                        
                        // Update current chat if needed
                        if (app.currentChat && app.currentChat.otherUser.uid === change.doc.id) {
                            app.currentChat.otherUser.online = userData.online;
                            app.currentChat.otherUser.lastSeen = userData.lastSeen ? userData.lastSeen.toDate() : app.currentChat.otherUser.lastSeen;
                        }
                    });
                    
                    // Re-filter and render
                    app.filterUsers();
                    app.filterConversations();
                    app.render();
                }, function(error) {
                    console.log("Error listening to online status changes:", error);
                });
            },
            
            // Start chat with user
            startChat: function(user) {
                if (user.isBlocked) {
                    app.showBannerNotification("Vous avez bloqué cet utilisateur", "warning");
                    return;
                }
                
                // Create conversation ID (sort UIDs to ensure consistent ID)
                var sortedIds = [app.currentUser.uid, user.uid].sort();
                var conversationId = sortedIds.join('_');
                
                try {
                    // Check if conversation exists
                    db.collection('conversations').doc(conversationId).get().then(function(conversationDoc) {
                        if (!conversationDoc.exists) {
                            // Create new conversation
                            db.collection('conversations').doc(conversationId).set({
                                participants: sortedIds,
                                lastMessage: null,
                                lastMessageTimestamp: firebase.firestore.Timestamp.now(),
                                createdAt: firebase.firestore.Timestamp.now(),
                                deleted: {}
                            }).then(function() {
                                openChat();
                            }).catch(function(error) {
                                console.log("Error creating conversation:", error);
                                app.showBannerNotification("Erreur lors du démarrage de la conversation", "error");
                            });
                        } else {
                            // If conversation exists but was deleted for current user, undelete it
                            if (conversationDoc.data().deleted && conversationDoc.data().deleted[app.currentUser.uid]) {
                                var deleted = conversationDoc.data().deleted;
                                deleted[app.currentUser.uid] = false;
                                db.collection('conversations').doc(conversationId).update({ deleted: deleted }).then(function() {
                                    openChat();
                                }).catch(function(error) {
                                    console.log("Error undeleting conversation:", error);
                                    app.showBannerNotification("Erreur lors du démarrage de la conversation", "error");
                                });
                            } else {
                                openChat();
                            }
                        }
                    }).catch(function(error) {
                        console.log("Error checking conversation:", error);
                        app.showBannerNotification("Erreur lors du démarrage de la conversation", "error");
                    });
                    
                    function openChat() {
                        // Open chat screen
                        app.currentChat = {
                            id: conversationId,
                            otherUser: user
                        };
                        
                        app.currentScreen = 'chat';
                        
                        // Reset any selections
                        app.exitSelectionMode();
                        
                        // Load messages
                        app.loadMessages(conversationId);
                        
                        app.render();
                    }
                } catch (error) {
                    console.log("Error starting chat:", error);
                    app.showBannerNotification("Erreur lors du démarrage de la conversation", "error");
                }
            },
            
            // Load messages for a conversation
            loadMessages: function(conversationId) {
                try {
                    // Clear previous messages
                    app.messages = [];
                    
                    // Query for messages
                    var query = db.collection('messages')
                        .where('conversationId', '==', conversationId)
                        .orderBy('timestamp', 'asc');
                    
                    // Live listener
                    query.onSnapshot(function(snapshot) {
                        var messages = [];
                        
                        snapshot.forEach(function(doc) {
                            var messageData = doc.data();
                            
                            // Skip messages hidden for current user
                            if (messageData.hidden && messageData.hidden[app.currentUser.uid]) {
                                return;
                            }
                            
                            // Convert Firestore timestamp to JavaScript Date
                            var timestamp = messageData.timestamp ? 
                                         messageData.timestamp.toDate() : 
                                         new Date();
                            
                            messages.push({
                                id: doc.id,
                                senderId: messageData.senderId,
                                text: messageData.text,
                                image: messageData.image,
                                messageType: messageData.messageType || 'text',
                                timestamp: timestamp,
                                read: messageData.read,
                                edited: messageData.edited || false,
                                reactions: messageData.reactions || {}
                            });
                        });
                        
                        app.messages = messages;
                        app.render();
                        
                        // Scroll to bottom
                        app.scrollToBottom();
                        
                        // Mark messages as read
                        app.markMessagesAsRead(conversationId);
                    }, function(error) {
                        console.log("Error loading messages:", error);
                        app.showBannerNotification("Erreur lors du chargement des messages", "error");
                    });
                    
                } catch (error) {
                    console.log("Error loading messages:", error);
                    app.showBannerNotification("Erreur lors du chargement des messages", "error");
                }
            },
            
            // Mark messages as read
            markMessagesAsRead: function(conversationId) {
                try {
                    // Get unread messages not sent by current user
                    var query = db.collection('messages')
                        .where('conversationId', '==', conversationId)
                        .where('senderId', '!=', app.currentUser.uid)
                        .where('read', '==', false);
                    
                    query.get().then(function(snapshot) {
                        // Update each message
                        var batch = db.batch();
                        
                        snapshot.forEach(function(doc) {
                            batch.update(doc.ref, { read: true });
                        });
                        
                        if (snapshot.size > 0) {
                            batch.commit();
                        }
                    }).catch(function(error) {
                        console.log("Error getting unread messages:", error);
                    });
                } catch (error) {
                    console.log("Error marking messages as read:", error);
                }
            },
            
            // Select image for upload
            selectImage: function() {
                var fileInput = document.getElementById('image-upload');
                fileInput.click();
            },
            
            // Handle selected image
            handleImageSelect: function(event) {
                var file = event.target.files[0];
                if (!file) return;
                
                // Validate file type
                var validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (validImageTypes.indexOf(file.type) === -1) {
                    app.showBannerNotification("Format d'image non supporté", "error");
                    return;
                }
                
                // Validate file size (max 6MB)
                if (file.size > 6 * 1024 * 1024) {
                    app.showBannerNotification("L'image ne doit pas dépasser 6 Mo", "error");
                    return;
                }
                
                // Compress and create preview
                app.compressImage(file, 1200, 0.8, function(compressedFile) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        app.selectedImage = compressedFile;
                        app.imagePreview = e.target.result;
                        app.render();
                        
                        // Update UI to show preview
                        var previewContainer = document.getElementById('image-preview-container');
                        if (previewContainer) {
                            previewContainer.style.display = 'block';
                        }
                    };
                    reader.readAsDataURL(compressedFile);
                }, function(error) {
                    console.log("Error compressing image:", error);
                    app.showBannerNotification("Erreur lors du traitement de l'image", "error");
                });
            },
            
            // Compress image before upload - compatible with iOS 12
            compressImage: function(file, maxWidth, quality, onSuccess, onError) {
                var reader = new FileReader();
                reader.onload = function(event) {
                    var img = new Image();
                    img.onload = function() {
                        // Calculate new dimensions
                        var width = img.width;
                        var height = img.height;
                        
                        if (width > maxWidth) {
                            height = Math.round(height * maxWidth / width);
                            width = maxWidth;
                        }
                        
                        // Create canvas for resizing
                        var canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw and compress image
                        var ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to Blob (with iOS compatibility)
                        if (canvas.toBlob) {
                            canvas.toBlob(
                                function(blob) {
                                    if (!blob) {
                                        onError(new Error('Canvas to Blob failed'));
                                        return;
                                    }
                                    
                                    // For iOS 12 compatibility, we'll just use the blob directly
                                    // Instead of trying to create a File object which may not be supported
                                    // Add properties to blob to mimic File interface
                                    blob.name = file.name;
                                    blob.lastModified = Date.now();
                                    
                                    onSuccess(blob);
                                }, 
                                file.type, 
                                quality
                            );
                        } else {
                            // Fallback for browsers that don't support canvas.toBlob
                            try {
                                var dataURL = canvas.toDataURL(file.type, quality);
                                var binary = atob(dataURL.split(',')[1]);
                                var array = [];
                                for (var i = 0; i < binary.length; i++) {
                                    array.push(binary.charCodeAt(i));
                                }
                                var blob = new Blob([new Uint8Array(array)], {type: file.type});
                                blob.name = file.name;
                                blob.lastModified = Date.now();
                                
                                onSuccess(blob);
                            } catch (e) {
                                onError(e);
                            }
                        }
                    };
                    img.onerror = function() {
                        onError(new Error('Image loading error'));
                    };
                    img.src = event.target.result;
                };
                reader.onerror = function() {
                    onError(new Error('File reading error'));
                };
                reader.readAsDataURL(file);
            },
            
            // Handle avatar upload
            handleAvatarSelect: function(event) {
                var file = event.target.files[0];
                if (!file) return;
                
                // Validate file type
                var validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (validImageTypes.indexOf(file.type) === -1) {
                    app.showBannerNotification("Format d'image non supporté", "error");
                    return;
                }
                
                // Validate file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    app.showBannerNotification("L'image ne doit pas dépasser 2 Mo", "error");
                    return;
                }
                
                // Compress and upload avatar
                app.compressImage(file, 300, 0.8, function(compressedFile) {
                    app.convertBlobToBase64(compressedFile, function(base64Avatar) {
                        app.uploadAvatar(base64Avatar);
                    }, function(error) {
                        console.log("Error converting avatar to base64:", error);
                        app.showBannerNotification("Erreur lors du traitement de l'image", "error");
                    });
                }, function(error) {
                    console.log("Error compressing avatar:", error);
                    app.showBannerNotification("Erreur lors du traitement de l'image", "error");
                });
            },
            
            // Convert blob to base64
            convertBlobToBase64: function(blob, onSuccess, onError) {
                var reader = new FileReader();
                reader.onloadend = function() {
                    onSuccess(reader.result);
                };
                reader.onerror = function() {
                    onError(new Error('File reading error'));
                };
                reader.readAsDataURL(blob);
            },
            
            // Upload avatar to Firestore (base64 encoded)
            uploadAvatar: function(base64Avatar) {
                try {
                    if (!app.currentUser) return;
                    
                    // Show loading notification
                    app.showBannerNotification("Téléchargement en cours...", "info");
                    
                    // Update user document with base64 avatar
                    db.collection('users').doc(app.currentUser.uid).update({
                        avatar: base64Avatar
                    }).then(function() {
                        // Update local state
                        app.currentUser.avatar = base64Avatar;
                        
                        app.showBannerNotification("Photo de profil mise à jour", "success");
                        app.render();
                    }).catch(function(error) {
                        console.log("Error uploading avatar:", error);
                        app.showBannerNotification("Erreur lors du téléchargement", "error");
                    });
                } catch (error) {
                    console.log("Error uploading avatar:", error);
                    app.showBannerNotification("Erreur lors du téléchargement", "error");
                }
            },
            
            // Cancel image upload
            cancelImageUpload: function() {
                app.selectedImage = null;
                app.imagePreview = null;
                app.render();
            },
            
            // Show chat menu
            showChatMenu: function() {
                // Close menu if already open
                if (app.chatMenu) {
                    app.closeChatMenu();
                    return;
                }
                
                var menuContainer = document.createElement('div');
                menuContainer.className = 'chat-menu';
                
                var isBlocked = app.currentChat.otherUser.isBlocked;
                
                var menuItems = [
                    {
                        label: 'Effacer l\'historique',
                        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                        action: function() { app.confirmClearChatHistory(); }
                    },
                    {
                        label: isBlocked ? 'Débloquer' : 'Bloquer',
                        icon: isBlocked ? 
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 9L9 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 9L9 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                        action: function() { app.toggleBlockUser(app.currentChat.otherUser.uid, !isBlocked); }
                    },
                    {
                        label: 'Supprimer la conversation',
                        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                        action: function() { app.deleteConversation(app.currentChat.id); },
                        className: 'danger'
                    }
                ];
                
                var menuHTML = '';
                for (var i = 0; i < menuItems.length; i++) {
                    var item = menuItems[i];
                    menuHTML += 
                        '<div class="chat-menu-item ' + (item.className || '') + '" data-action="' + i + '">' +
                            item.icon +
                            item.label +
                        '</div>';
                }
                
                menuContainer.innerHTML = menuHTML;
                
                document.body.appendChild(menuContainer);
                app.chatMenu = menuContainer;
                
                // Position the menu
                var menuButton = document.querySelector('.chat-menu-button');
                if (menuButton) {
                    var rect = menuButton.getBoundingClientRect();
                    menuContainer.style.top = rect.bottom + 'px';
                    menuContainer.style.right = (window.innerWidth - rect.right) + 'px';
                }
                
                // Add click handlers
                var menuItemElements = menuContainer.querySelectorAll('.chat-menu-item');
                for (var j = 0; j < menuItemElements.length; j++) {
                    (function(index) {
                        menuItemElements[j].addEventListener('click', function() {
                            menuItems[index].action();
                            app.closeChatMenu();
                        });
                    })(j);
                }
            },
            
            // Close chat menu
            closeChatMenu: function() {
                if (app.chatMenu) {
                    app.chatMenu.parentNode.removeChild(app.chatMenu);
                    app.chatMenu = null;
                }
            },
            
            // Confirm clear chat history
            confirmClearChatHistory: function() {
                if (!app.currentChat) return;
                
                app.showModal({
                    title: 'Effacer l\'historique',
                    content: 'Êtes-vous sûr de vouloir effacer l\'historique de cette conversation ? Cette action ne peut pas être annulée.',
                    actions: [
                        {
                            label: 'Annuler',
                            action: function() { app.closeModal(); },
                            className: 'modal-button-cancel'
                        },
                        {
                            label: 'Effacer',
                            action: function() {
                                app.clearChatHistory(app.currentChat.id);
                                app.closeModal();
                            },
                            className: 'modal-button-danger'
                        }
                    ]
                });
            },
            
            // Clear chat history
            clearChatHistory: function(conversationId) {
                try {
                    // Get all messages in the conversation
                    db.collection('messages')
                        .where('conversationId', '==', conversationId)
                        .get().then(function(messagesQuery) {
                            if (!messagesQuery.empty) {
                                var batch = db.batch();
                                
                                // Mark all messages as hidden for current user
                                messagesQuery.forEach(function(doc) {
                                    var messageData = doc.data();
                                    var hidden = messageData.hidden || {};
                                    hidden[app.currentUser.uid] = true;
                                    batch.update(doc.ref, { hidden: hidden });
                                });
                                
                                batch.commit().then(function() {
                                    // Update conversation's last message
                                    db.collection('conversations').doc(conversationId).update({
                                        lastMessage: "Historique effacé",
                                        lastMessageType: 'text',
                                        lastMessageTimestamp: firebase.firestore.Timestamp.now()
                                    }).then(function() {
                                        app.showBannerNotification("Historique effacé", "success");
                                        
                                        // Reload messages if in chat screen
                                        if (app.currentScreen === 'chat' && app.currentChat && app.currentChat.id === conversationId) {
                                            app.loadMessages(conversationId);
                                        }
                                    });
                                });
                            }
                        });
                } catch (error) {
                    console.log("Error clearing chat history:", error);
                    app.showBannerNotification("Erreur lors de l'effacement", "error");
                }
            },
            
            // Send a message
            sendMessage: function() {
                if (!app.currentChat) return;
                
                var messageInput = document.getElementById('message-input');
                var text = messageInput ? messageInput.value.trim() : '';
                
                // Check if we have text or image
                if (!text && !app.selectedImage) return;
                
                try {
                    // Generate a random ID for this message to track in UI
                    var tempMessageId = 'temp_' + Date.now().toString();
                    
                    // Add to sending messages array
                    app.sendingMessages.push(tempMessageId);
                    
                    // Update UI immediately to show message sending state
                    // Create a temporary message object
                    var tempMessage = {
                        id: tempMessageId,
                        senderId: app.currentUser.uid,
                        text: text,
                        image: app.selectedImage ? app.imagePreview : null,
                        messageType: app.selectedImage ? 'image' : 'text',
                        timestamp: new Date(),
                        read: false,
                        edited: false,
                        reactions: {},
                        isSending: true
                    };
                    
                    // Add to messages array
                    app.messages.push(tempMessage);
                    
                    // Clear input and selected image
                    if (messageInput) {
                        messageInput.value = '';
                    }
                    
                    // Store selected image before clearing
                    var imageToSend = app.selectedImage;
                    
                    // Clear selected image from UI
                    app.selectedImage = null;
                    app.imagePreview = null;
                    
                    // Re-render to show sending state
                    app.render();
                    
                    // Scroll to bottom
                    app.scrollToBottom();
                    
                    // Prepare message data
                    var messageData = {
                        conversationId: app.currentChat.id,
                        senderId: app.currentUser.uid,
                        timestamp: firebase.firestore.Timestamp.now(),
                        read: false,
                        edited: false,
                        hidden: {},
                        reactions: {}
                    };
                    
                    var lastMessageText = '';
                    var messageType = 'text';
                    
                    // Handle text message
                    if (text) {
                        messageData.text = text;
                        lastMessageText = text;
                    }
                    
                    // Handle image message
                    if (imageToSend) {
                        // Convert image to base64
                        app.convertBlobToBase64(imageToSend, function(base64Image) {
                            messageData.image = base64Image;
                            messageData.messageType = 'image';
                            messageType = 'image';
                            
                            if (!text) {
                                lastMessageText = '📷 Image';
                            }
                            
                            // Send message to Firestore
                            sendToFirestore();
                            
                        }, function(error) {
                            console.log("Error converting image to base64:", error);
                            
                            // Remove from sending messages
                            var tempIndex = app.sendingMessages.indexOf(tempMessageId);
                            if (tempIndex !== -1) {
                                app.sendingMessages.splice(tempIndex, 1);
                            }
                            
                            // Remove the failed message from the UI
                            for (var i = 0; i < app.messages.length; i++) {
                                if (app.messages[i].id === tempMessageId) {
                                    app.messages.splice(i, 1);
                                    break;
                                }
                            }
                            
                            app.showBannerNotification("Erreur lors de l'envoi du message", "error");
                            app.render();
                        });
                    } else {
                        // Text-only message
                        sendToFirestore();
                    }
                    
                    function sendToFirestore() {
                        // Send message to Firestore
                        db.collection('messages').add(messageData).then(function(messageRef) {
                            // Update conversation with last message info
                            db.collection('conversations').doc(app.currentChat.id).update({
                                lastMessage: lastMessageText,
                                lastMessageType: messageType,
                                lastMessageTimestamp: firebase.firestore.Timestamp.now(),
                                lastMessageSenderId: app.currentUser.uid
                            }).catch(function(error) {
                                console.log("Error updating conversation:", error);
                            });
                            
                            // Remove from sending messages
                            var tempIndex = app.sendingMessages.indexOf(tempMessageId);
                            if (tempIndex !== -1) {
                                app.sendingMessages.splice(tempIndex, 1);
                            }
                            
                            // The message will be updated through the Firestore listener
                            
                        }).catch(function(error) {
                            console.log("Error sending message:", error);
                            
                            // Remove from sending messages
                            var tempIndex = app.sendingMessages.indexOf(tempMessageId);
                            if (tempIndex !== -1) {
                                app.sendingMessages.splice(tempIndex, 1);
                            }
                            
                            // Remove the failed message from the UI
                            for (var i = 0; i < app.messages.length; i++) {
                                if (app.messages[i].id === tempMessageId) {
                                    app.messages.splice(i, 1);
                                    break;
                                }
                            }
                            
                            app.showBannerNotification("Erreur lors de l'envoi du message", "error");
                            app.render();
                        });
                    }
                } catch (error) {
                    console.log("Error sending message:", error);
                    app.showBannerNotification("Erreur lors de l'envoi du message", "error");
                }
            },
            
            // Add reaction to message
            addReaction: function(messageId, emoji) {
                try {
                    db.collection('messages').doc(messageId).get().then(function(messageDoc) {
                        if (!messageDoc.exists) {
                            console.log("Message not found");
                            return;
                        }
                        
                        var messageData = messageDoc.data();
                        var reactions = messageData.reactions || {};
                        
                        // Check if user already reacted with this emoji
                        var existingReaction = false;
                        if (reactions[emoji]) {
                            existingReaction = reactions[emoji].indexOf(app.currentUser.uid) !== -1;
                        }
                        
                        if (existingReaction) {
                            // Remove reaction
                            var updatedUsers = [];
                            for (var i = 0; i < reactions[emoji].length; i++) {
                                if (reactions[emoji][i] !== app.currentUser.uid) {
                                    updatedUsers.push(reactions[emoji][i]);
                                }
                            }
                            
                            if (updatedUsers.length === 0) {
                                // Remove emoji key if no users left
                                delete reactions[emoji];
                            } else {
                                reactions[emoji] = updatedUsers;
                            }
                        } else {
                            // Add reaction
                            if (!reactions[emoji]) {
                                reactions[emoji] = [];
                            }
                            reactions[emoji].push(app.currentUser.uid);
                        }
                        
                        // Update message with new reactions
                        db.collection('messages').doc(messageId).update({
                            reactions: reactions
                        }).then(function() {
                            // Add to recently used emojis list if not already there
                            if (!existingReaction) {
                                app.addToRecentEmojis(emoji);
                            }
                            
                            // Close reaction picker
                            app.closeReactionPicker();
                        }).catch(function(error) {
                            console.log("Error updating reactions:", error);
                        });
                    }).catch(function(error) {
                        console.log("Error getting message:", error);
                    });
                } catch (error) {
                    console.log("Error adding reaction:", error);
                    app.showNotification("Erreur lors de l'ajout de la réaction", "error");
                }
            },
            
            // Add to recent emojis list
            addToRecentEmojis: function(emoji) {
                // Remove the emoji if it's already in the list
                var existingIndex = app.recentEmojis.indexOf(emoji);
                if (existingIndex !== -1) {
                    app.recentEmojis.splice(existingIndex, 1);
                }
                
                // Add emoji to the beginning of the list
                app.recentEmojis.unshift(emoji);
                
                // Keep only the most recent 8 emojis
                if (app.recentEmojis.length > 8) {
                    app.recentEmojis = app.recentEmojis.slice(0, 8);
                }
            },
            
            // Show reaction picker
            showReactionPicker: function(messageId, event) {
                // Close if already open for same message
                if (app.reactionPickerVisible && app.reactionPickerTargetId === messageId) {
                    app.closeReactionPicker();
                    return;
                }
                
                // Close if open for different message
                if (app.reactionPickerVisible) {
                    app.closeReactionPicker();
                }
                
                var messageBubble = event.currentTarget;
                var rect = messageBubble.getBoundingClientRect();
                
                var pickerContainer = document.createElement('div');
                pickerContainer.className = 'reaction-picker';
                pickerContainer.style.top = (rect.top - 50) + 'px';
                
                // Position horizontally based on message position
                if (messageBubble.classList.contains('message-sent')) {
                    pickerContainer.style.right = (window.innerWidth - rect.right) + 'px';
                } else {
                    pickerContainer.style.left = rect.left + 'px';
                }
                
                // Add emojis
                var html = '';
                for (var i = 0; i < app.availableEmojis.length; i++) {
                    html += '<div class="reaction-picker-item" data-emoji="' + app.availableEmojis[i] + '">' + app.availableEmojis[i] + '</div>';
                }
                pickerContainer.innerHTML = html;
                
                document.body.appendChild(pickerContainer);
                
                // Add event listeners
                var emojiItems = pickerContainer.querySelectorAll('.reaction-picker-item');
                for (var j = 0; j < emojiItems.length; j++) {
                    (function(emoji) {
                        emojiItems[j].addEventListener('click', function(e) {
                            app.addReaction(messageId, emoji);
                            e.stopPropagation();
                        });
                    })(emojiItems[j].getAttribute('data-emoji'));
                }
                
                app.reactionPickerVisible = true;
                app.reactionPickerTargetId = messageId;
            },
            
            // Close reaction picker
            closeReactionPicker: function() {
                var picker = document.querySelector('.reaction-picker');
                if (picker) {
                    picker.parentNode.removeChild(picker);
                }
                app.reactionPickerVisible = false;
                app.reactionPickerTargetId = null;
            },
            
            // Show emoji picker
            showEmojiPicker: function() {
                if (app.emojiPickerVisible) {
                    app.closeEmojiPicker();
                    return;
                }
                
                var pickerContainer = document.createElement('div');
                pickerContainer.className = 'emoji-picker';
                
                var html = '';
                
                // Add recently used emojis if available
                if (app.recentEmojis.length > 0) {
                    html += '<div class="emoji-category">' +
                        '<div class="emoji-category-title">Récents</div>' +
                        '<div class="emoji-grid">';
                    
                    for (var i = 0; i < app.recentEmojis.length; i++) {
                        html += '<div class="emoji-item" data-emoji="' + app.recentEmojis[i] + '">' + app.recentEmojis[i] + '</div>';
                    }
                    
                    html += '</div></div>';
                }
                
                // Add emoji categories
                var emojiCategories = {
                    "Smileys & Émotions": ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇', '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚', '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩'],
                    "Gestes & Personnes": ['👍', '👎', '👌', '✌️', '🤞', '👊', '✊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '💪'],
                    "Animaux & Nature": ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐸', '🐵', '🙈', '🙉', '🙊'],
                    "Nourriture & Boisson": ['🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝'],
                    "Activités": ['⚽', '🏀', '🏈', '⚾', '🥎', '🎾', '🏐', '🏉', '🥏', '🎱', '🏓', '🏸', '🏒', '🏑'],
                    "Objets": ['⌚', '📱', '💻', '⌨️', '🖥️', '🖨️', '🖱️', '📀', '💿', '💾', '💽', '📼', '📷', '📸'],
                                        "Symboles": ['❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝']
                };
                
                for (var category in emojiCategories) {
                    html += '<div class="emoji-category">' +
                        '<div class="emoji-category-title">' + category + '</div>' +
                        '<div class="emoji-grid">';
                    
                    for (var j = 0; j < emojiCategories[category].length; j++) {
                        html += '<div class="emoji-item" data-emoji="' + emojiCategories[category][j] + '">' + emojiCategories[category][j] + '</div>';
                    }
                    
                    html += '</div></div>';
                }
                
                pickerContainer.innerHTML = html;
                document.body.appendChild(pickerContainer);
                
                // Add event listeners
                var emojiItems = pickerContainer.querySelectorAll('.emoji-item');
                for (var k = 0; k < emojiItems.length; k++) {
                    (function(emoji) {
                        emojiItems[k].addEventListener('click', function() {
                            app.insertEmoji(emoji);
                        });
                    })(emojiItems[k].getAttribute('data-emoji'));
                }
                
                app.emojiPickerVisible = true;
            },
            
            // Close emoji picker
            closeEmojiPicker: function() {
                var picker = document.querySelector('.emoji-picker');
                if (picker) {
                    picker.parentNode.removeChild(picker);
                }
                app.emojiPickerVisible = false;
            },
            
            // Insert emoji into message input
            insertEmoji: function(emoji) {
                var messageInput = document.getElementById('message-input');
                if (messageInput) {
                    // Get cursor position
                    var selectionStart = messageInput.selectionStart || 0;
                    var selectionEnd = messageInput.selectionEnd || 0;
                    
                    // Insert emoji at cursor position
                    var before = messageInput.value.substring(0, selectionStart);
                    var after = messageInput.value.substring(selectionEnd);
                    messageInput.value = before + emoji + after;
                    
                    // Reset cursor position
                    messageInput.focus();
                    messageInput.selectionStart = selectionStart + emoji.length;
                    messageInput.selectionEnd = selectionStart + emoji.length;
                }
                
                // Add to recently used emojis
                app.addToRecentEmojis(emoji);
                
                // Close picker
                app.closeEmojiPicker();
            },
            
            // Toggle block user
            toggleBlockUser: function(userId, block) {
                try {
                    // Get current user
                    db.collection('users').doc(app.currentUser.uid).get().then(function(userDoc) {
                        if (userDoc.exists) {
                            var userData = userDoc.data();
                            var blockedUsers = userData.blockedUsers || [];
                            
                            if (block) {
                                // Add to blocked users if not already there
                                if (blockedUsers.indexOf(userId) === -1) {
                                    blockedUsers.push(userId);
                                    
                                    app.showModal({
                                        title: 'Bloquer l\'utilisateur',
                                        content: 'Êtes-vous sûr de vouloir bloquer cet utilisateur ? Il ne pourra plus vous envoyer de messages.',
                                        actions: [
                                            {
                                                label: 'Annuler',
                                                action: function() { app.closeModal(); },
                                                className: 'modal-button-cancel'
                                            },
                                            {
                                                label: 'Bloquer',
                                                action: function() {
                                                    updateBlockedUsers(blockedUsers);
                                                    app.closeModal();
                                                },
                                                className: 'modal-button-danger'
                                            }
                                        ]
                                    });
                                }
                            } else {
                                // Remove from blocked users
                                var index = blockedUsers.indexOf(userId);
                                if (index !== -1) {
                                    blockedUsers.splice(index, 1);
                                    updateBlockedUsers(blockedUsers);
                                }
                            }
                            
                            function updateBlockedUsers(blockedUsers) {
                                db.collection('users').doc(app.currentUser.uid).update({
                                    blockedUsers: blockedUsers
                                }).then(function() {
                                    // Update local state
                                    app.currentUser.blockedUsers = blockedUsers;
                                    
                                    // Update current chat if needed
                                    if (app.currentChat && app.currentChat.otherUser.uid === userId) {
                                        app.currentChat.otherUser.isBlocked = block;
                                        
                                        // Re-fetch messages if unblocking
                                        if (!block) {
                                            app.loadMessages(app.currentChat.id);
                                        }
                                    }
                                    
                                    // Update users list
                                    for (var i = 0; i < app.users.length; i++) {
                                        if (app.users[i].uid === userId) {
                                            app.users[i].isBlocked = block;
                                            break;
                                        }
                                    }
                                    
                                    // Update conversations list
                                    for (var j = 0; j < app.conversations.length; j++) {
                                        if (app.conversations[j].otherUser.uid === userId) {
                                            app.conversations[j].otherUser.isBlocked = block;
                                            app.conversations[j].isBlocked = block;
                                            break;
                                        }
                                    }
                                    
                                    app.showBannerNotification(block ? "Utilisateur bloqué" : "Utilisateur débloqué", "success");
                                    app.render();
                                }).catch(function(error) {
                                    console.log("Error updating blocked users:", error);
                                    app.showBannerNotification("Erreur lors de la mise à jour", "error");
                                });
                            }
                        }
                    }).catch(function(error) {
                        console.log("Error getting user:", error);
                        app.showBannerNotification("Erreur lors de la mise à jour", "error");
                    });
                } catch (error) {
                    console.log("Error toggling block user:", error);
                    app.showBannerNotification("Erreur lors de la mise à jour", "error");
                }
            },
            
            // Edit profile
            editProfile: function(field) {
                app.isEditing = true;
                app.editingField = field;
                
                var currentValue = app.currentUser[field] || '';
                
                app.showModal({
                    title: 'Modifier ' + (field === 'username' ? 'nom d\'utilisateur' : field === 'phone' ? 'téléphone' : 'bio'),
                    content: '<div class="form-group">' +
                        '<input type="' + (field === 'phone' ? 'tel' : 'text') + '" id="edit-' + field + '" class="form-input" ' +
                        'value="' + currentValue + '" ' +
                        (field === 'bio' ? 'style="height: 100px"' : '') + '>' +
                        '</div>',
                    actions: [
                        {
                            label: 'Annuler',
                            action: function() { 
                                app.isEditing = false;
                                app.editingField = null;
                                app.closeModal(); 
                            },
                            className: 'modal-button-cancel'
                        },
                        {
                            label: 'Enregistrer',
                            action: function() {
                                var newValue = document.getElementById('edit-' + field).value.trim();
                                app.updateProfile(field, newValue);
                                app.isEditing = false;
                                app.editingField = null;
                                app.closeModal();
                            },
                            className: 'modal-button-confirm'
                        }
                    ]
                });
                
                // Focus input after modal is shown
                setTimeout(function() {
                    var input = document.getElementById('edit-' + field);
                    if (input) {
                        input.focus();
                    }
                }, 100);
            },
            
            // Update profile
            updateProfile: function(field, value) {
                if (!app.currentUser) return;
                
                try {
                    var updateData = {};
                    updateData[field] = value;
                    
                    db.collection('users').doc(app.currentUser.uid).update(updateData).then(function() {
                        // Update local state
                        app.currentUser[field] = value;
                        
                        app.showBannerNotification("Profil mis à jour", "success");
                        app.render();
                    }).catch(function(error) {
                        console.log("Error updating profile:", error);
                        app.showBannerNotification("Erreur lors de la mise à jour", "error");
                    });
                } catch (error) {
                    console.log("Error updating profile:", error);
                    app.showBannerNotification("Erreur lors de la mise à jour", "error");
                }
            },
            
            // Scroll messages to bottom
            scrollToBottom: function() {
                var messagesContainer = document.querySelector('.chat-messages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            },
            
            // Format message timestamp
            formatTimestamp: function(timestamp) {
                try {
                    if (!timestamp) return '';
                    
                    var now = new Date();
                    var messageDate = new Date(timestamp);
                    
                    // Same day
                    if (now.getDate() === messageDate.getDate() && 
                        now.getMonth() === messageDate.getMonth() && 
                        now.getFullYear() === messageDate.getFullYear()) {
                        return this.formatTime(messageDate);
                    }
                    
                    // Yesterday
                    var yesterday = new Date(now);
                    yesterday.setDate(now.getDate() - 1);
                    if (yesterday.getDate() === messageDate.getDate() && 
                        yesterday.getMonth() === messageDate.getMonth() && 
                        yesterday.getFullYear() === messageDate.getFullYear()) {
                        return 'hier ' + this.formatTime(messageDate);
                    }
                    
                    // This week (within 7 days)
                    var weekAgo = new Date(now);
                    weekAgo.setDate(now.getDate() - 6);
                    if (messageDate >= weekAgo) {
                        var days = ['dim.', 'lun.', 'mar.', 'mer.', 'jeu.', 'ven.', 'sam.'];
                        return days[messageDate.getDay()] + ' ' + this.formatTime(messageDate);
                    }
                    
                    // This year
                    if (now.getFullYear() === messageDate.getFullYear()) {
                        var day = messageDate.getDate();
                        var month = messageDate.getMonth() + 1;
                        return (day < 10 ? '0' + day : day) + '/' + (month < 10 ? '0' + month : month);
                    }
                    
                    // Different year
                    var day = messageDate.getDate();
                    var month = messageDate.getMonth() + 1;
                    var year = messageDate.getFullYear();
                    return (day < 10 ? '0' + day : day) + '/' + (month < 10 ? '0' + month : month) + '/' + year;
                } catch (error) {
                    console.log("Error formatting timestamp:", error);
                    return '';
                }
            },
            
            // Format time
            formatTime: function(date) {
                try {
                    var hours = date.getHours();
                    var minutes = date.getMinutes();
                    return (hours < 10 ? '0' + hours : hours) + ':' + (minutes < 10 ? '0' + minutes : minutes);
                } catch (error) {
                    console.log("Error formatting time:", error);
                    return '';
                }
            },
            
            // Format last seen time
            formatLastSeen: function(lastSeen) {
                try {
                    if (!lastSeen) return 'il y a longtemps';
                    
                    var now = new Date();
                    var diff = now - lastSeen;
                    
                    // Less than a minute
                    if (diff < 60 * 1000) {
                        return 'à l\'instant';
                    }
                    
                    // Less than an hour
                    if (diff < 60 * 60 * 1000) {
                        var minutes = Math.floor(diff / (60 * 1000));
                        return 'il y a ' + minutes + ' min';
                    }
                    
                    // Less than a day
                    if (diff < 24 * 60 * 60 * 1000) {
                        var hours = Math.floor(diff / (60 * 60 * 1000));
                        return 'il y a ' + hours + ' h';
                    }
                    
                    // Less than a week
                    if (diff < 7 * 24 * 60 * 60 * 1000) {
                        var days = Math.floor(diff / (24 * 60 * 60 * 1000));
                        return 'il y a ' + days + ' j';
                    }
                    
                    // Format as date
                    var day = lastSeen.getDate();
                    var month = lastSeen.getMonth() + 1;
                    return 'le ' + (day < 10 ? '0' + day : day) + '/' + (month < 10 ? '0' + month : month);
                } catch (error) {
                    console.log("Error formatting last seen:", error);
                    return '';
                }
            },
            
            // Get day from timestamp
            getDay: function(timestamp) {
                try {
                    if (!timestamp) return '';
                    
                    var date = new Date(timestamp);
                    var now = new Date();
                    
                    // Today
                    if (now.getDate() === date.getDate() && 
                        now.getMonth() === date.getMonth() && 
                        now.getFullYear() === date.getFullYear()) {
                        return 'Aujourd\'hui';
                    }
                    
                    // Yesterday
                    var yesterday = new Date(now);
                    yesterday.setDate(now.getDate() - 1);
                    if (yesterday.getDate() === date.getDate() && 
                        yesterday.getMonth() === date.getMonth() && 
                        yesterday.getFullYear() === date.getFullYear()) {
                        return 'Hier';
                    }
                    
                    // Format as date
                    var day = date.getDate();
                    var month = date.getMonth() + 1;
                    var year = date.getFullYear();
                    
                    // This year
                    if (now.getFullYear() === year) {
                        return (day < 10 ? '0' + day : day) + '/' + (month < 10 ? '0' + month : month);
                    }
                    
                    // Different year
                    return (day < 10 ? '0' + day : day) + '/' + (month < 10 ? '0' + month : month) + '/' + year;
                } catch (error) {
                    console.log("Error getting day:", error);
                    return '';
                }
            },
            
            // Get initials from username
            getInitials: function(username) {
                try {
                    if (!username) return '';
                    
                    var parts = username.split(' ');
                    var initials = '';
                    
                    for (var i = 0; i < Math.min(parts.length, 2); i++) {
                        if (parts[i].length > 0) {
                            initials += parts[i][0].toUpperCase();
                        }
                    }
                    
                    return initials;
                } catch (error) {
                    console.log("Error getting initials:", error);
                    return '';
                }
            },
            
            // Get avatar background color based on username
            getAvatarColor: function(username) {
                try {
                    if (!username) return '';
                    
                    // Generate a simple hash from username
                    var hash = 0;
                    for (var i = 0; i < username.length; i++) {
                        hash = username.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    
                    // Generate a hue value between 0 and 360
                    var hue = hash % 360;
                    
                    // Use predefined colors based on hue range
                    var gradients = [
                        'var(--purple-gradient)',  // 0-60
                        'var(--blue-gradient)',    // 60-120
                        'var(--teal-gradient)',    // 120-180
                        'var(--green-gradient)',   // 180-240
                        'var(--orange-gradient)',  // 240-300
                        'var(--pink-gradient)'     // 300-360
                    ];
                    
                    var index = Math.floor(hue / 60) % gradients.length;
                    return gradients[index];
                } catch (error) {
                    console.log("Error getting avatar color:", error);
                    return 'var(--accent-gradient)';
                }
            },
            
            // Show custom image preview
            showCustomImagePreview: function(imageUrl) {
                var previewContainer = document.createElement('div');
                previewContainer.className = 'custom-image-preview';
                
                var previewContent = document.createElement('div');
                previewContent.className = 'custom-image-preview-content';
                
                var image = document.createElement('img');
                image.src = imageUrl;
                previewContent.appendChild(image);
                
                var closeButton = document.createElement('button');
                closeButton.className = 'custom-image-preview-close';
                closeButton.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                closeButton.addEventListener('click', function() {
                    app.closeCustomImagePreview();
                });
                
                previewContainer.appendChild(previewContent);
                previewContainer.appendChild(closeButton);
                
                document.body.appendChild(previewContainer);
                app.customImagePreview = previewContainer;
            },
            
            // Close custom image preview
            closeCustomImagePreview: function() {
                if (app.customImagePreview) {
                    app.customImagePreview.parentNode.removeChild(app.customImagePreview);
                    app.customImagePreview = null;
                }
            },
            
            // Show modal
            showModal: function(options) {
                // Close existing modal if any
                app.closeModal();
                
                var modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                
                var modalContainer = document.createElement('div');
                modalContainer.className = 'modal-container';
                
                var header = document.createElement('div');
                header.className = 'modal-header';
                header.textContent = options.title || '';
                
                var body = document.createElement('div');
                body.className = 'modal-body';
                
                if (typeof options.content === 'string') {
                    body.innerHTML = options.content;
                } else if (options.content instanceof Node) {
                    body.appendChild(options.content);
                }
                
                var footer = document.createElement('div');
                footer.className = 'modal-footer';
                
                if (options.actions && options.actions.length > 0) {
                    for (var i = 0; i < options.actions.length; i++) {
                        (function(action) {
                            var button = document.createElement('button');
                            button.className = 'modal-button ' + (action.className || '');
                            button.textContent = action.label || '';
                            button.addEventListener('click', function() {
                                if (typeof action.action === 'function') {
                                    action.action();
                                }
                            });
                            footer.appendChild(button);
                        })(options.actions[i]);
                    }
                }
                
                modalContainer.appendChild(header);
                modalContainer.appendChild(body);
                modalContainer.appendChild(footer);
                
                modalOverlay.appendChild(modalContainer);
                document.body.appendChild(modalOverlay);
                
                app.modal = modalOverlay;
            },
            
            // Close modal
            closeModal: function() {
                if (app.modal) {
                    app.modal.parentNode.removeChild(app.modal);
                    app.modal = null;
                }
            },
            
            // Show a notification toast
            showNotification: function(message, type) {
                // Remove any existing notification
                var existingToast = document.querySelector('.toast');
                if (existingToast) {
                    existingToast.parentNode.removeChild(existingToast);
                }
                
                // Clear timeout if any
                if (app.notificationTimer) {
                    clearTimeout(app.notificationTimer);
                }
                
                // Create toast
                var toast = document.createElement('div');
                toast.className = 'toast ' + (type || 'info');
                
                // Add icon based on type
                var icon = '';
                switch (type) {
                    case 'success':
                        icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 11.0857V12.0057C21.9988 14.1621 21.3005 16.2604 20.0093 17.9875C18.7182 19.7147 16.9033 20.9782 14.8354 21.5896C12.7674 22.201 10.5573 22.1276 8.53447 21.3803C6.51168 20.633 4.78465 19.2518 3.61096 17.4428C2.43727 15.6338 1.87979 13.4938 2.02168 11.342C2.16356 9.19029 2.99721 7.14205 4.39828 5.5028C5.79935 3.86354 7.69279 2.72111 9.79619 2.24587C11.8996 1.77063 14.1003 1.98806 16.07 2.86572" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 4L12 14.01L9 11.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        break;
                    case 'error':
                        icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 9L9 15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 9L15 15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        break;
                    case 'warning':
                        icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.29 3.86L1.82 18C1.64537 18.3024 1.55296 18.6453 1.55199 18.9945C1.55101 19.3437 1.6415 19.6871 1.81442 19.9905C1.98734 20.2939 2.23672 20.5467 2.53771 20.7238C2.83869 20.9009 3.1808 20.9961 3.53 21H20.47C20.8192 20.9961 21.1613 20.9009 21.4623 20.7238C21.7633 20.5467 22.0127 20.2939 22.1856 19.9905C22.3585 19.6871 22.449 19.3437 22.448 18.9945C22.447 18.6453 22.3546 18.3024 22.18 18L13.71 3.86C13.5317 3.56611 13.2807 3.32312 12.9812 3.15448C12.6817 2.98585 12.3437 2.89725 12 2.89725C11.6563 2.89725 11.3183 2.98585 11.0188 3.15448C10.7193 3.32312 10.4683 3.56611 10.29 3.86Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9V13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 17H12.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        break;
                    default:
                        icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16V12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 8H12.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        break;
                }
                
                toast.innerHTML = '<span class="toast-icon">' + icon + '</span>' + message;
                
                document.body.appendChild(toast);
                
                // Auto remove after 3 seconds
                app.notificationTimer = setTimeout(function() {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 3000);
            },
            
            // Show a banner notification at the top
            showBannerNotification: function(message, type) {
                // Remove any existing notification
                var existingBanner = document.querySelector('.banner-notification');
                if (existingBanner) {
                    existingBanner.parentNode.removeChild(existingBanner);
                }
                
                // Clear timeout if any
                if (app.bannerNotificationTimer) {
                    clearTimeout(app.bannerNotificationTimer);
                }
                
                // Create banner
                var banner = document.createElement('div');
                banner.className = 'banner-notification ' + (type || 'info');
                
                // Add icon based on type
                var icon = '';
                switch (type) {
                    case 'success':
                        icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 11.0857V12.0057C21.9988 14.1621 21.3005 16.2604 20.0093 17.9875C18.7182 19.7147 16.9033 20.9782 14.8354 21.5896C12.7674 22.201 10.5573 22.1276 8.53447 21.3803C6.51168 20.633 4.78465 19.2518 3.61096 17.4428C2.43727 15.6338 1.87979 13.4938 2.02168 11.342C2.16356 9.19029 2.99721 7.14205 4.39828 5.5028C5.79935 3.86354 7.69279 2.72111 9.79619 2.24587C11.8996 1.77063 14.1003 1.98806 16.07 2.86572" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 4L12 14.01L9 11.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        break;
                    case 'error':
                        icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 9L9 15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 9L15 15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        break;
                    case 'warning':
                        icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.29 3.86L1.82 18C1.64537 18.3024 1.55296 18.6453 1.55199 18.9945C1.55101 19.3437 1.6415 19.6871 1.81442 19.9905C1.98734 20.2939 2.23672 20.5467 2.53771 20.7238C2.83869 20.9009 3.1808 20.9961 3.53 21H20.47C20.8192 20.9961 21.1613 20.9009 21.4623 20.7238C21.7633 20.5467 22.0127 20.2939 22.1856 19.9905C22.3585 19.6871 22.449 19.3437 22.448 18.9945C22.447 18.6453 22.3546 18.3024 22.18 18L13.71 3.86C13.5317 3.56611 13.2807 3.32312 12.9812 3.15448C12.6817 2.98585 12.3437 2.89725 12 2.89725C11.6563 2.89725 11.3183 2.98585 11.0188 3.15448C10.7193 3.32312 10.4683 3.56611 10.29 3.86Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9V13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 17H12.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        break;
                    default:
                        icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16V12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 8H12.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        break;
                }
                
                banner.innerHTML = 
                    '<div class="banner-content">' +
                        '<div class="banner-icon">' + icon + '</div>' +
                        '<div class="banner-message">' + message + '</div>' +
                    '</div>' +
                    '<button class="banner-close">' +
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' +
                    '</button>';
                
                document.body.appendChild(banner);
                
                // Add click event to close button
                var closeButton = banner.querySelector('.banner-close');
                if (closeButton) {
                    closeButton.addEventListener('click', function() {
                        if (banner.parentNode) {
                            banner.classList.add('closing');
                            setTimeout(function() {
                                if (banner.parentNode) {
                                    banner.parentNode.removeChild(banner);
                                }
                            }, 300);
                        }
                    });
                }
                
                // Auto remove after 5 seconds
                app.bannerNotificationTimer = setTimeout(function() {
                    if (banner.parentNode) {
                        banner.classList.add('closing');
                        setTimeout(function() {
                            if (banner.parentNode) {
                                banner.parentNode.removeChild(banner);
                            }
                        }, 300);
                    }
                }, 5000);
            },
            
            // Group messages by day
            groupMessagesByDay: function(messages) {
                try {
                    var groups = [];
                    var currentDay = null;
                    var currentMessages = [];
                    
                    for (var i = 0; i < messages.length; i++) {
                        var message = messages[i];
                        var day = this.getDay(message.timestamp);
                        
                        if (day !== currentDay) {
                            if (currentMessages.length > 0) {
                                groups.push({
                                    day: currentDay,
                                    messages: currentMessages
                                });
                            }
                            
                            currentDay = day;
                            currentMessages = [message];
                        } else {
                            currentMessages.push(message);
                        }
                    }
                    
                    if (currentMessages.length > 0) {
                        groups.push({
                            day: currentDay,
                            messages: currentMessages
                        });
                    }
                    
                    return groups;
                } catch (error) {
                    console.log("Error grouping messages:", error);
                    return [];
                }
            },
            
            // Render function
            render: function() {
                var appElement = document.getElementById('app');
                if (!appElement) return;
                
                // Apply accent color
                this.applyAccentColor();
                this.applyAccentGradient(this.accentGradient);
                
                // Change content based on current screen
                switch (this.currentScreen) {
                    case 'loading':
                        this.renderLoadingScreen();
                        break;
                    case 'auth':
                        this.renderAuthScreen();
                        break;
                    case 'main':
                        this.renderMainScreen();
                        break;
                    case 'chat':
                        this.renderChatScreen();
                        break;
                    default:
                        this.renderLoadingScreen();
                        break;
                }
            },
            
            // Render auth screen
            renderAuthScreen: function() {
                var appElement = document.getElementById('app');
                if (!appElement) return;
                
                var html = 
                    '<div class="container">' +
                        '<div class="auth-container">' +
                            '<div class="auth-logo">' +
                                '<h1>ChatXchange</h1>' +
                                '<p>La messagerie rapide et sécurisée</p>' +
                            '</div>' +
                            '<div class="auth-form">' +
                                '<div class="auth-tabs">' +
                                    '<div class="auth-tab ' + (this.activeAuthTab === 'login' ? 'active' : '') + '" onclick="app.switchAuthTab(\'login\')">Connexion</div>' +
                                    '<div class="auth-tab ' + (this.activeAuthTab === 'register' ? 'active' : '') + '" onclick="app.switchAuthTab(\'register\')">Inscription</div>' +
                                '</div>';
                
                if (this.activeAuthTab === 'login') {
                    html += 
                        '<form onsubmit="app.handleLogin(event)">' +
                            '<div class="form-group">' +
                                '<label class="form-label">Email</label>' +
                                '<input type="email" id="login-email" class="form-input" placeholder="Votre email" required>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label class="form-label">Mot de passe</label>' +
                                '<input type="password" id="login-password" class="form-input" placeholder="Votre mot de passe" required>' +
                            '</div>' +
                            '<button type="submit" class="btn btn-primary">Se connecter</button>' +
                        '</form>';
                } else {
                    html += 
                        '<form onsubmit="app.handleRegister(event)">' +
                            '<div class="form-group">' +
                                '<label class="form-label">Nom d\'utilisateur</label>' +
                                '<input type="text" id="register-username" class="form-input" placeholder="Choisissez un nom d\'utilisateur" required>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label class="form-label">Email</label>' +
                                '<input type="email" id="register-email" class="form-input" placeholder="Votre email" required>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label class="form-label">Téléphone (optionnel)</label>' +
                                '<input type="tel" id="register-phone" class="form-input" placeholder="Votre numéro de téléphone">' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label class="form-label">Mot de passe</label>' +
                                '<input type="password" id="register-password" class="form-input" placeholder="Choisissez un mot de passe" required>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label class="form-label">Confirmer le mot de passe</label>' +
                                '<input type="password" id="register-confirm-password" class="form-input" placeholder="Confirmez votre mot de passe" required>' +
                            '</div>' +
                            '<button type="submit" class="btn btn-primary">S\'inscrire</button>' +
                        '</form>';
                }
                
                html += 
                            '</div>' +
                        '</div>' +
                    '</div>';
                
                appElement.innerHTML = html;
            },
            
            // Render main screen
            renderMainScreen: function() {
                var appElement = document.getElementById('app');
                if (!appElement) return;
                
                var html = 
                    '<div class="container">' +
                        '<div class="header">' +
                            '<div class="header-title">ChatXchange</div>';
                
                if (this.currentTab === 'conversations') {
                    html += 
                            '<button class="more-button" onclick="app.showModal({' +
                                'title: \'Options\', ' +
                                'content: \'<div class=\\\'modal-option\\\' onclick=\\\'app.toggleConversationSelectionMode(); app.closeModal();\\\'>' +
                                    '<span class=\\\'modal-option-icon\\\'>' +
                                        '<svg width=\\\'20\\\' height=\\\'20\\\' viewBox=\\\'0 0 24 24\\\' fill=\\\'none\\\' xmlns=\\\'http://www.w3.org/2000/svg\\\'>' +
                                            '<path d=\\\'M9 11L12 14L22 4\\\' stroke=\\\'currentColor\\\' stroke-width=\\\'2\\\' stroke-linecap=\\\'round\\\' stroke-linejoin=\\\'round\\\'/>' +
                                            '<path d=\\\'M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16\\\' stroke=\\\'currentColor\\\' stroke-width=\\\'2\\\' stroke-linecap=\\\'round\\\' stroke-linejoin=\\\'round\\\'/>' +
                                        '</svg>' +
                                    '</span>' +
                                    'Sélectionner des discussions' +
                                '</div>\''+
                            '})">' +
                                '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M19 13C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11C18.4477 11 18 11.4477 18 12C18 12.5523 18.4477 13 19 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M5 13C5.55228 13 6 12.5523 6 12C6 11.4477 5.55228 11 5 11C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                            '</button>';
                }
                
                html += 
                        '</div>';
                
                // Batch actions bar for selection mode
                if (this.isConversationSelectionMode) {
                    html += 
                        '<div class="batch-actions-bar">' +
                            '<div class="batch-actions-title">' + this.selectedConversations.size + ' sélectionné(s)</div>' +
                            '<div style="display: flex;">' +
                                '<button class="batch-action-button" onclick="app.deleteSelectedConversations()">' +
                                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                        '<path d="M3 6H5H21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                        '<path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '</svg>' +
                                '</button>' +
                                '<button class="batch-action-button" onclick="app.exitConversationSelectionMode()">' +
                                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                        '<path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                        '<path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '</svg>' +
                                '</button>' +
                            '</div>' +
                        '</div>';
                }
                
                // Search bar for conversations and users
                if ((this.currentTab === 'conversations' && this.conversations.length > 0) || 
                    (this.currentTab === 'users' && this.users.length > 0)) {
                    html += 
                        '<div class="search-container">' +
                            '<div class="search-wrapper">' +
                                '<div class="search-icon">' +
                                    '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                        '<path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                        '<path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '</svg>' +
                                '</div>' +
                                '<input type="search" class="form-input" placeholder="Rechercher..." value="' + this.searchQuery + '" oninput="app.handleSearch(this.value)">' +
                                (this.searchQuery ? 
                                    '<button class="search-clear" onclick="app.clearSearch()">' +
                                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                            '<path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                            '<path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                        '</svg>' +
                                    '</button>' : '') +
                            '</div>' +
                        '</div>';
                }
                
                html += '<div class="main">';
                
                // Content based on tab
                switch (this.currentTab) {
                    case 'conversations':
                        html += this.renderConversationsTab();
                        break;
                    case 'users':
                        html += this.renderUsersTab();
                        break;
                    case 'profile':
                        html += this.renderProfileTab();
                        break;
                    default:
                        html += this.renderConversationsTab();
                        break;
                }
                
                html += '</div>';
                
                // Tab bar
                html += 
                    '<div class="tab-bar">' +
                        '<div class="tab-button ' + (this.currentTab === 'conversations' ? 'active' : '') + '" onclick="app.switchTab(\'conversations\')">' +
                            '<div class="tab-button-icon">' +
                                '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M21 11.5C21.0034 12.8199 20.6951 14.1219 20.1 15.3C19.3944 16.7118 18.3098 17.8992 16.9674 18.7293C15.6251 19.5594 14.0782 19.9994 12.5 20C11.1801 20.0035 9.87812 19.6951 8.7 19.1L3 21L4.9 15.3C4.30493 14.1219 3.99656 12.8199 4 11.5C4.00061 9.92179 4.44061 8.37488 5.27072 7.03258C6.10083 5.69028 7.28825 4.6056 8.7 3.90003C9.87812 3.30496 11.1801 2.99659 12.5 3.00003H13C15.0843 3.11502 17.053 3.99479 18.5291 5.47089C20.0052 6.94699 20.885 8.91568 21 11V11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                            '</div>' +
                            '<div class="tab-button-label">Messages</div>' +
                        '</div>' +
                        '<div class="tab-button ' + (this.currentTab === 'users' ? 'active' : '') + '" onclick="app.switchTab(\'users\')">' +
                            '<div class="tab-button-icon">' +
                                '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M9 11C11.2091 11 13 9.20914 13 7C13 4.79086 11.2091 3 9 3C6.79086 3 5 4.79086 5 7C5 9.20914 6.79086 11 9 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89318 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                            '</div>' +
                            '<div class="tab-button-label">Contacts</div>' +
                        '</div>' +
                        '<div class="tab-button ' + (this.currentTab === 'profile' ? 'active' : '') + '" onclick="app.switchTab(\'profile\')">' +
                            '<div class="tab-button-icon">' +
                                '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                            '</div>' +
                            '<div class="tab-button-label">Profil</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
                
                appElement.innerHTML = html;
            },
            
            // Enter conversation selection mode
            toggleConversationSelectionMode: function() {
                this.isConversationSelectionMode = !this.isConversationSelectionMode;
                this.selectedConversations = new Set();
                this.render();
            },
            
            // Exit conversation selection mode
            exitConversationSelectionMode: function() {
                this.isConversationSelectionMode = false;
                this.selectedConversations = new Set();
                this.render();
            },
            
            // Select/unselect conversation
            toggleConversationSelection: function(conversationId) {
                if (this.selectedConversations.has(conversationId)) {
                    this.selectedConversations.delete(conversationId);
                } else {
                    this.selectedConversations.add(conversationId);
                }
                this.render();
            },
            
            // Render conversations tab
            renderConversationsTab: function() {
                var html = '';
                
                // If there are no conversations
                if (!this.conversations || this.conversations.length === 0) {
                    html += 
                        '<div class="empty-state">' +
                            '<div class="empty-state-icon">' +
                                '<svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M21 11.5C21.0034 12.8199 20.6951 14.1219 20.1 15.3C19.3944 16.7118 18.3098 17.8992 16.9674 18.7293C15.6251 19.5594 14.0782 19.9994 12.5 20C11.1801 20.0035 9.87812 19.6951 8.7 19.1L3 21L4.9 15.3C4.30493 14.1219 3.99656 12.8199 4 11.5C4.00061 9.92179 4.44061 8.37488 5.27072 7.03258C6.10083 5.69028 7.28825 4.6056 8.7 3.90003C9.87812 3.30496 11.1801 2.99659 12.5 3.00003H13C15.0843 3.11502 17.053 3.99479 18.5291 5.47089C20.0052 6.94699 20.885 8.91568 21 11V11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                            '</div>' +
                            '<h2 class="empty-state-title">Aucune conversation</h2>' +
                            '<p class="empty-state-text">Commencez à discuter avec vos contacts en accédant à l\'onglet Contacts.</p>' +
                        '</div>';
                    
                    html += 
                        '<div style="position:fixed; bottom: 80px; right: 20px;">' +
                            '<button class="compose-button" onclick="app.switchTab(\'users\')">' +
                                '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M12 5V19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M5 12H19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                            '</button>' +
                        '</div>';
                    
                    return html;
                }
                
                // If search returns no results
                if (this.searchQuery && (!this.filteredConversations || this.filteredConversations.length === 0)) {
                    html += 
                        '<div class="empty-state">' +
                            '<div class="empty-state-icon">' +
                                '<svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                            '</div>' +
                            '<h2 class="empty-state-title">Aucun résultat</h2>' +
                            '<p class="empty-state-text">Aucune conversation ne correspond à votre recherche.</p>' +
                        '</div>';
                    
                    return html;
                }
                
                html += '<div class="conversation-list">';
                
                var conversations = this.filteredConversations || this.conversations;
                
                for (var i = 0; i < conversations.length; i++) {
                    var conversation = conversations[i];
                    var isSelected = this.isConversationSelectionMode && this.selectedConversations.has(conversation.id);
                    
                    html += 
                        '<div class="conversation-item ' + (isSelected ? 'selected' : '') + '" ' + 
                             'onclick="' + (this.isConversationSelectionMode ? 
                                          'app.toggleConversationSelection(\'' + conversation.id + '\')' : 
                                          'app.openConversation(\'' + conversation.id + '\')') + '">';
                    
                    if (this.isConversationSelectionMode) {
                        html += 
                            '<div class="conversation-checkbox">' +
                                (isSelected ? 
                                    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                        '<path d="M20 6L9 17L4 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '</svg>' : '') +
                            '</div>';
                    }
                    
                    html += 
                            '<div class="conversation-avatar" style="background: ' + this.getAvatarColor(conversation.otherUser.username) + '">';
                    
                    if (conversation.otherUser.avatar) {
                        html += '<img src="' + conversation.otherUser.avatar + '" alt="' + conversation.otherUser.username + '">';
                    } else {
                        html += this.getInitials(conversation.otherUser.username);
                    }
                    
                    html += 
                                '<div class="conversation-status ' + (conversation.otherUser.online ? 'online' : '') + '"></div>' +
                            '</div>' +
                            '<div class="conversation-content">' +
                                '<div class="conversation-name">' +
                                    conversation.otherUser.username;
                    
                    if (conversation.otherUser.isBlocked) {
                        html += '<span class="conversation-blocked">(Bloqué)</span>';
                    }
                    
                    html += 
                                '</div>';
                    
                    if (conversation.lastMessage) {
                        var lastMessageText = conversation.lastMessage;
                        
                        // If message is from current user, prepend "Vous: "
                        if (conversation.lastMessageSenderId === this.currentUser.uid) {
                            lastMessageText = 'Vous: ' + lastMessageText;
                        }
                        
                        html += 
                                '<div class="conversation-message">' + lastMessageText + '</div>';
                    }
                    
                    html += 
                            '</div>' +
                            '<div class="conversation-meta">' +
                                '<div class="conversation-time">' + this.formatTimestamp(conversation.lastMessageTimestamp) + '</div>';
                    
                    if (conversation.unreadCount > 0) {
                        html += 
                                '<div class="conversation-badge">' + conversation.unreadCount + '</div>';
                    }
                    
                    html += 
                            '</div>' +
                        '</div>';
                }
                
                html += '</div>';
                
                html += 
                    '<div style="position:fixed; bottom: 80px; right: 20px;">' +
                        '<button class="compose-button" onclick="app.switchTab(\'users\')">' +
                            '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                '<path d="M12 5V19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '<path d="M5 12H19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                            '</svg>' +
                        '</button>' +
                    '</div>';
                
                return html;
            },
            
            // Render users tab
            renderUsersTab: function() {
                var html = '';
                
                // If there are no users
                if (!this.users || this.users.length === 0) {
                    html += 
                        '<div class="empty-state">' +
                            '<div class="empty-state-icon">' +
                                '<svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M9 11C11.2091 11 13 9.20914 13 7C13 4.79086 11.2091 3 9 3C6.79086 3 5 4.79086 5 7C5 9.20914 6.79086 11 9 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89318 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                            '</div>' +
                            '<h2 class="empty-state-title">Aucun utilisateur</h2>' +
                            '<p class="empty-state-text">Aucun autre utilisateur n\'est inscrit pour le moment.</p>' +
                        '</div>';
                    
                    return html;
                }
                
                // If search returns no results
                if (this.searchQuery && (!this.filteredUsers || this.filteredUsers.length === 0)) {
                    html += 
                        '<div class="empty-state">' +
                            '<div class="empty-state-icon">' +
                                '<svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                            '</div>' +
                            '<h2 class="empty-state-title">Aucun résultat</h2>' +
                            '<p class="empty-state-text">Aucun utilisateur ne correspond à votre recherche.</p>' +
                        '</div>';
                    
                    return html;
                }
                
                html += '<div class="user-list">';
                
                var users = this.filteredUsers || this.users;
                
                for (var i = 0; i < users.length; i++) {
                    var user = users[i];
                    
                    html += 
                        '<div class="user-item" onclick="app.startChat(' + JSON.stringify(user).replace(/"/g, '&quot;') + ')">' +
                            '<div class="user-avatar" style="background: ' + this.getAvatarColor(user.username) + '">';
                    
                    if (user.avatar) {
                        html += '<img src="' + user.avatar + '" alt="' + user.username + '">';
                    } else {
                        html += this.getInitials(user.username);
                    }
                    
                    html += 
                                '<div class="conversation-status ' + (user.online ? 'online' : '') + '"></div>' +
                            '</div>' +
                            '<div class="user-info">' +
                                '<div class="user-name">' +
                                    user.username;
                    
                    if (user.isBlocked) {
                        html += '<span class="user-blocked">(Bloqué)</span>';
                    }
                    
                    html += 
                                '</div>' +
                                '<div class="user-status">' +
                                    '<div class="status-dot ' + (user.online ? 'online' : '') + '"></div>' +
                                    (user.online ? 'En ligne' : (user.lastSeen ? 'Vu ' + this.formatLastSeen(user.lastSeen) : 'Hors ligne')) +
                                '</div>';
                    
                    if (user.bio) {
                        html += '<div class="user-bio">' + user.bio + '</div>';
                    }
                    
                    html += 
                            '</div>' +
                        '</div>';
                }
                
                html += '</div>';
                
                return html;
            },
            
            // Render profile tab
            renderProfileTab: function() {
                if (!this.currentUser) return '';
                
                var html = 
                    '<div class="profile-container">' +
                        '<div class="profile-header">' +
                            '<div class="profile-avatar-container" onclick="document.getElementById(\'avatar-upload\').click()">' +
                                '<div class="profile-avatar">';
                
                if (this.currentUser.avatar) {
                    html += '<img src="' + this.currentUser.avatar + '" alt="' + this.currentUser.username + '">';
                } else {
                    html += this.getInitials(this.currentUser.username);
                }
                
                html += 
                                    '<div class="profile-avatar-edit">Modifier</div>' +
                                '</div>' +
                            '</div>' +
                            '<input type="file" id="avatar-upload" class="input-file" accept="image/*" onchange="app.handleAvatarSelect(event)">' +
                        '</div>' +
                        
                        '<div class="profile-card">' +
                            '<div class="profile-card-title">' +
                                '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                                'Informations personnelles' +
                            '</div>' +
                            '<div class="profile-field">' +
                                '<div class="profile-field-label">Nom</div>' +
                                '<div class="profile-field-value editable-field" onclick="app.editProfile(\'username\')">' + 
                                    this.currentUser.username + 
                                '</div>' +
                            '</div>' +
                            '<div class="profile-field">' +
                                '<div class="profile-field-label">Email</div>' +
                                '<div class="profile-field-value">' + this.currentUser.email + '</div>' +
                            '</div>' +
                            '<div class="profile-field">' +
                                '<div class="profile-field-label">Téléphone</div>' +
                                '<div class="profile-field-value editable-field" onclick="app.editProfile(\'phone\')">' + 
                                    (this.currentUser.phone || 'Non défini') + 
                                '</div>' +
                            '</div>' +
                            '<div class="profile-field">' +
                                '<div class="profile-field-label">Bio</div>' +
                                '<div class="profile-field-value editable-field" onclick="app.editProfile(\'bio\')">' + 
                                    (this.currentUser.bio || 'Ajouter une bio...') + 
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        
                        '<div class="profile-card">' +
                            '<div class="profile-card-title">' +
                                '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M19.4 15C19.2669 15.3016 19.2272 15.6362 19.286 15.9606C19.3448 16.285 19.4995 16.5843 19.73 16.82L19.79 16.88C19.976 17.0657 20.1235 17.2863 20.2241 17.5291C20.3248 17.7719 20.3766 18.0322 20.3766 18.295C20.3766 18.5578 20.3248 18.8181 20.2241 19.0609C20.1235 19.3037 19.976 19.5243 19.79 19.71C19.6043 19.896 19.3837 20.0435 19.1409 20.1441C18.8981 20.2448 18.6378 20.2966 18.375 20.2966C18.1122 20.2966 17.8519 20.2448 17.6091 20.1441C17.3663 20.0435 17.1457 19.896 16.96 19.71L16.9 19.65C16.6643 19.4195 16.365 19.2648 16.0406 19.206C15.7162 19.1472 15.3816 19.1869 15.08 19.32C14.7842 19.4468 14.532 19.6572 14.3543 19.9255C14.1766 20.1938 14.0813 20.5082 14.08 20.83V21C14.08 21.5304 13.8693 22.0391 13.4942 22.4142C13.1191 22.7893 12.6104 23 12.08 23C11.5496 23 11.0409 22.7893 10.6658 22.4142C10.2907 22.0391 10.08 21.5304 10.08 21V20.91C10.0723 20.579 9.96512 20.258 9.77251 19.9887C9.5799 19.7194 9.31074 19.5143 9 19.4C8.69838 19.2669 8.36381 19.2272 8.03941 19.286C7.71502 19.3448 7.41568 19.4995 7.18 19.73L7.12 19.79C6.93425 19.976 6.71368 20.1235 6.47088 20.2241C6.22808 20.3248 5.96783 20.3766 5.705 20.3766C5.44217 20.3766 5.18192 20.3248 4.93912 20.2241C4.69632 20.1235 4.47575 19.976 4.29 19.79C4.10405 19.6043 3.95653 19.3837 3.85588 19.1409C3.75523 18.8981 3.70343 18.6378 3.70343 18.375C3.70343 18.1122 3.75523 17.8519 3.85588 17.6091C3.95653 17.3663 4.10405 17.1457 4.29 16.96L4.35 16.9C4.58054 16.6643 4.73519 16.365 4.794 16.0406C4.85282 15.7162 4.81312 15.3816 4.68 15.08C4.55324 14.7842 4.34276 14.532 4.07447 14.3543C3.80618 14.1766 3.49179 14.0813 3.17 14.08H3C2.46957 14.08 1.96086 13.8693 1.58579 13.4942C1.21071 13.1191 1 12.6104 1 12.08C1 11.5496 1.21071 11.0409 1.58579 10.6658C1.96086 10.2907 2.46957 10.08 3 10.08H3.09C3.42099 10.0723 3.742 9.96512 4.0113 9.77251C4.28059 9.5799 4.48572 9.31074 4.6 9C4.73312 8.69838 4.77282 8.36381 4.714 8.03941C4.65519 7.71502 4.50054 7.41568 4.27 7.18L4.21 7.12C4.02405 6.93425 3.87653 6.71368 3.77588 6.47088C3.67523 6.22808 3.62343 5.96783 3.62343 5.705C3.62343 5.44217 3.67523 5.18192 3.77588 4.93912C3.87653 4.69632 4.02405 4.47575 4.21 4.29C4.39575 4.10405 4.61632 3.95653 4.85912 3.85588C5.10192 3.75523 5.36217 3.70343 5.625 3.70343C5.88783 3.70343 6.14808 3.75523 6.39088 3.85588C6.63368 3.95653 6.85425 4.10405 7.04 4.29L7.1 4.35C7.33568 4.58054 7.63502 4.73519 7.95941 4.794C8.28381 4.85282 8.61838 4.81312 8.92 4.68H9C9.29577 4.55324 9.54802 4.34276 9.72569 4.07447C9.90337 3.80618 9.99872 3.49179 10 3.17V3C10 2.46957 10.2107 1.96086 10.5858 1.58579C10.9609 1.21071 11.4696 1 12 1C12.5304 1 13.0391 1.21071 13.4142 1.58579C13.7893 1.96086 14 2.46957 14 3V3.09C14.0013 3.41179 14.0966 3.72618 14.2743 3.99447C14.452 4.26276 14.7042 4.47324 15 4.6C15.3016 4.73312 15.6362 4.77282 15.9606 4.714C16.285 4.65519 16.5843 4.50054 16.82 4.27L16.88 4.21C17.0657 4.02405 17.2863 3.87653 17.5291 3.77588C17.7719 3.67523 18.0322 3.62343 18.295 3.62343C18.5578 3.62343 18.8181 3.67523 19.0609 3.77588C19.3037 3.87653 19.5243 4.02405 19.71 4.21C19.896 4.39575 20.0435 4.61632 20.1441 4.85912C20.2448 5.10192 20.2966 5.36217 20.2966 5.625C20.2966 5.88783 20.2448 6.14808 20.1441 6.39088C20.0435 6.63368 19.896 6.85425 19.71 7.04L19.65 7.1C19.4195 7.33568 19.2648 7.63502 19.206 7.95941C19.1472 8.28381 19.1869 8.61838 19.32 8.92V9C19.4468 9.29577 19.6572 9.54802 19.9255 9.72569C20.1938 9.90337 20.5082 9.99872 20.83 10H21C21.5304 10 22.0391 10.2107 22.4142 10.5858C22.7893 10.9609 23 11.4696 23 12C23 12.5304 22.7893 13.0391 22.4142 13.4142C22.0391 13.7893 21.5304 14 21 14H20.91C20.5882 14.0013 20.2738 14.0966 20.0055 14.2743C19.7372 14.452 19.5268 14.7042 19.4 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                                'Personnalisation' +
                            '</div>' +
                            '<div class="profile-field">' +
                                '<div class="profile-field-label">Thème</div>' +
                                '<div class="profile-field-value">' +
                                    '<div class="theme-toggle">' +
                                        '<span>Mode sombre</span>' +
                                        '<label class="toggle-switch">' +
                                            '<input type="checkbox" ' + (this.isDarkMode ? 'checked' : '') + ' onchange="app.toggleDarkMode(this.checked, true)">' +
                                            '<span class="toggle-slider"></span>' +
                                        '</label>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div class="profile-field">' +
                                '<div class="profile-field-label">Couleur</div>' +
                                '<div class="profile-field-value">' +
                                    '<div class="color-options">' +
                                        '<div class="color-option ' + (this.accentColor === '#5D5CDE' ? 'active' : '') + '" style="background-color: #5D5CDE" onclick="app.changeAccentColor(\'#5D5CDE\', true)"></div>' +
                                        '<div class="color-option ' + (this.accentColor === '#3498db' ? 'active' : '') + '" style="background-color: #3498db" onclick="app.changeAccentColor(\'#3498db\', true)"></div>' +
                                        '<div class="color-option ' + (this.accentColor === '#2ecc71' ? 'active' : '') + '" style="background-color: #2ecc71" onclick="app.changeAccentColor(\'#2ecc71\', true)"></div>' +
                                        '<div class="color-option ' + (this.accentColor === '#e74c3c' ? 'active' : '') + '" style="background-color: #e74c3c" onclick="app.changeAccentColor(\'#e74c3c\', true)"></div>' +
                                        '<div class="color-option ' + (this.accentColor === '#f39c12' ? 'active' : '') + '" style="background-color: #f39c12" onclick="app.changeAccentColor(\'#f39c12\', true)"></div>' +
                                        '<div class="color-option ' + (this.accentColor === '#9b59b6' ? 'active' : '') + '" style="background-color: #9b59b6" onclick="app.changeAccentColor(\'#9b59b6\', true)"></div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        
                        '<div class="profile-actions">' +
                            '<button class="action-button logout-button" onclick="app.handleLogout()">' +
                                '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M16 17L21 12L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                                'Se déconnecter' +
                            '</button>' +
                            '<button class="action-button delete-button" onclick="app.handleDeleteAccount()">' +
                                '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M3 6H5H21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                                'Supprimer mon compte' +
                            '</button>' +
                        '</div>' +
                    '</div>';
                
                return html;
            },
            
            // Open conversation
            openConversation: function(conversationId) {
                try {
                    // Find conversation
                    var conversation = null;
                    
                    for (var i = 0; i < this.conversations.length; i++) {
                        if (this.conversations[i].id === conversationId) {
                            conversation = this.conversations[i];
                            break;
                        }
                    }
                    
                    if (!conversation) return;
                    
                    // Set current chat
                    this.currentChat = conversation;
                    this.currentScreen = 'chat';
                    
                    // Load messages
                    this.loadMessages(conversationId);
                    
                    // Reset selections
                    this.exitSelectionMode();
                    
                    this.render();
                } catch (error) {
                    console.log("Error opening conversation:", error);
                    this.showBannerNotification("Erreur lors de l'ouverture de la conversation", "error");
                }
            },
            
            // Exit selection mode
            exitSelectionMode: function() {
                this.selectionMode = false;
                this.selectedMessages = new Set();
                this.render();
            },
            
            // Render chat screen
            renderChatScreen: function() {
                if (!this.currentChat) return;
                
                var appElement = document.getElementById('app');
                if (!appElement) return;
                
                // Prepare and group messages by day
                var messageGroups = this.groupMessagesByDay(this.messages);
                
                var html = 
                    '<div class="container">' +
                        '<div class="chat-header">' +
                            '<button class="back-button" onclick="app.currentScreen = \'main\'; app.render();">' +
                                '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M19 12H5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M12 19L5 12L12 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                            '</button>' +
                            
                            '<div class="chat-title">' +
                                this.currentChat.otherUser.username +
                                
                                (this.currentChat.otherUser.online ? 
                                    '<span class="chat-title-status">En ligne</span>' : 
                                    (this.currentChat.otherUser.lastSeen ? 
                                        '<span class="chat-title-status">Vu ' + this.formatLastSeen(this.currentChat.otherUser.lastSeen) + '</span>' : '')) +
                            '</div>' +
                            
                            '<button class="chat-menu-button" onclick="app.showChatMenu()">' +
                                '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M19 13C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11C18.4477 11 18 11.4477 18 12C18 12.5523 18.4477 13 19 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '<path d="M5 13C5.55228 13 6 12.5523 6 12C6 11.4477 5.55228 11 5 11C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '</svg>' +
                            '</button>' +
                        '</div>' +
                        
                        '<div class="chat-container">' +
                            '<div class="chat-messages">';
                
                // If conversation is blocked
                if (this.currentChat.otherUser.isBlocked) {
                    html += 
                        '<div style="text-align: center; padding: 20px; background-color: rgba(239, 68, 68, 0.1); border-radius: 10px; margin: 10px 0; color: var(--error-color);">' +
                            '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin: 0 auto 10px; display: block;">' +
                                '<path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '<path d="M15 9L9 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                '<path d="M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                            '</svg>' +
                            '<p><strong>Utilisateur bloqué</strong></p>' +
                            '<p>Vous avez bloqué cet utilisateur. Vous ne pouvez pas envoyer ou recevoir de messages.</p>' +
                            '<button class="btn btn-primary" style="margin-top: 10px; background-color: var(--error-color);" ' +
                                'onclick="app.toggleBlockUser(\'' + this.currentChat.otherUser.uid + '\', false)">' +
                                'Débloquer ' + this.currentChat.otherUser.username +
                            '</button>' +
                        '</div>';
                }
                
                // If there are no messages
                if (messageGroups.length === 0 && !this.currentChat.otherUser.isBlocked) {
                    html += 
                        '<div style="text-align: center; padding: 20px; color: var(--secondary-text); margin-top: 50px;">' +
                            '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin: 0 auto 10px; display: block; opacity: 0.5;">' +
                                '<path d="M21 11.5C21.0034 12.8199 20.6951 14.1219 20.1 15.3C19.3944 16.7118 18.3098 17.8992 16.9674 18.7293C15.6251 19.5594 14.0782 19.9994 12.5 20C11.1801 20.0035 9.87812 19.6951 8.7 19.1L3 21L4.9 15.3C4.30493 14.1219 3.99656 12.8199 4 11.5C4.00061 9.92179 4.44061 8.37488 5.27072 7.03258C6.10083 5.69028 7.28825 4.6056 8.7 3.90003C9.87812 3.30496 11.1801 2.99659 12.5 3.00003H13C15.0843 3.11502 17.053 3.99479 18.5291 5.47089C20.0052 6.94699 20.885 8.91568 21 11V11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                            '</svg>' +
                            '<p>Aucun message pour le moment</p>' +
                            '<p>Envoyez un message pour commencer la conversation</p>' +
                        '</div>';
                }
                
                // Render message groups
                for (var i = 0; i < messageGroups.length; i++) {
                    var group = messageGroups[i];
                    
                    // Day separator
                    html += 
                        '<div class="message-day-separator">' +
                            '<span class="message-day-text">' + group.day + '</span>' +
                        '</div>';
                    
                    // Messages for this day
                    for (var j = 0; j < group.messages.length; j++) {
                        var message = group.messages[j];
                        var isCurrentUser = message.senderId === this.currentUser.uid;
                        var isSending = app.sendingMessages.indexOf(message.id) !== -1;
                        
                        html += 
                            '<div class="message-group ' + (isCurrentUser ? 'sent' : 'received') + '">';
                        
                        var messageClass = isCurrentUser ? 'message-sent' : 'message-received';
                        if (isSending) messageClass += ' message-sending';
                        
                        html += '<div class="message-bubble ' + messageClass + '" onclick="app.showReactionPicker(\'' + message.id + '\', event)">';
                        
                        // Message content
                        if (message.messageType === 'image' && message.image) {
                            html += 
                                '<div class="message-image-container">' +
                                    '<img class="message-image" src="' + message.image + '" alt="Image" onclick="app.showCustomImagePreview(\'' + message.image + '\'); event.stopPropagation();">' +
                                '</div>';
                            
                            if (message.text) {
                                html += '<div>' + message.text + '</div>';
                            }
                        } else {
                            html += message.text;
                        }
                        
                        html += '</div>';
                        
                        // Message reactions
                        if (message.reactions && Object.keys(message.reactions).length > 0) {
                            html += '<div class="message-reactions">';
                            
                            for (var emoji in message.reactions) {
                                if (message.reactions[emoji] && message.reactions[emoji].length > 0) {
                                    var count = message.reactions[emoji].length;
                                    var isCurrentUserReaction = message.reactions[emoji].indexOf(app.currentUser.uid) !== -1;
                                    
                                    html += 
                                        '<div class="message-reaction ' + (isCurrentUserReaction ? 'user-reaction' : '') + '" ' +
                                             'onclick="app.addReaction(\'' + message.id + '\', \'' + emoji + '\'); event.stopPropagation();">' +
                                            emoji +
                                            '<span class="message-reaction-count">' + count + '</span>' +
                                        '</div>';
                                }
                            }
                            
                            html += '</div>';
                        }
                        
                        // Message time and status
                        html += 
                            '<div class="message-time">' +
                                this.formatTime(message.timestamp);
                        
                        if (isCurrentUser) {
                            if (isSending) {
                                html += ' • Envoi...';
                            } else if (message.read) {
                                html += ' • Vu';
                            } else {
                                html += ' • Envoyé';
                            }
                            
                            if (message.edited) {
                                html += ' • Modifié';
                            }
                        }
                        
                        html += '</div>';
                        
                        html += '</div>';
                    }
                }
                
                html += 
                            '</div>';
                
                if (!this.currentChat.otherUser.isBlocked) {
                    html += 
                            '<div class="chat-input-container">' +
                                '<div class="chat-input">' +
                                    '<button class="media-button" onclick="app.selectImage()">' +
                                        '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                            '<path d="M23 19C23 19.5304 22.7893 20.0391 22.4142 20.4142C22.0391 20.7893 21.5304 21 21 21H3C2.46957 21 1.96086 20.7893 1.58579 20.4142C1.21071 20.0391 1 19.5304 1 19V8C1 7.46957 1.21071 6.96086 1.58579 6.58579C1.96086 6.21071 2.46957 6 3 6H7L9 3H15L17 6H21C21.5304 6 22.0391 6.21071 22.4142 6.58579C22.7893 6.96086 23 7.46957 23 8V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                            '<path d="M12 17C14.2091 17 16 15.2091 16 13C16 10.7909 14.2091 9 12 9C9.79086 9 8 10.7909 8 13C8 15.2091 9.79086 17 12 17Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                        '</svg>' +
                                    '</button>' +
                                    '<input type="file" id="image-upload" class="input-file" accept="image/*" onchange="app.handleImageSelect(event)">' +
                                    
                                    '<button class="emoji-button" onclick="app.showEmojiPicker()">' +
                                        '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                            '<path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                            '<path d="M8 14C8 14 9.5 16 12 16C14.5 16 16 14 16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                            '<path d="M9 9H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                            '<path d="M15 9H15.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                        '</svg>' +
                                    '</button>' +
                                    
                                    '<div class="message-input-container">' +
                                        '<input type="text" id="message-input" class="message-input" placeholder="Tapez un message..." ' +
                                               'onkeydown="if(event.key === \'Enter\' && !event.shiftKey) { app.sendMessage(); return false; }">' +
                                    '</div>';
                
                    // Image preview
                    if (this.selectedImage && this.imagePreview) {
                        html += 
                            '<div id="image-preview-container" class="image-preview-container">' +
                                '<img src="' + this.imagePreview + '" class="image-preview">' +
                                '<button class="image-preview-close" onclick="app.cancelImageUpload()">' +
                                    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                        '<path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                        '<path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                    '</svg>' +
                                '</button>' +
                            '</div>';
                    }
                    
                    html += 
                                    '<button class="send-button" onclick="app.sendMessage()">' +
                                        '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                            '<path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                            '<path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
                                        '</svg>' +
                                    '</button>' +
                                '</div>' +
                            '</div>';
                }
                
                html += 
                        '</div>' +
                    '</div>';
                
                appElement.innerHTML = html;
            }
        };
        
        // Initialize app
        app.init();
    </script>
</body>
</html>
