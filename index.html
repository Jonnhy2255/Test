<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iChat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <style>
        /* Variables de couleurs */
        :root {
            --primary-color: #F7DC6F; /* Jaune comme couleur principale de l'interface */
            --text-color: #000000;
            --bg-color: #ffffff;
            --border-color: #dddfe2;
            --secondary-color: #f0f2f5;
            --chat-sent-bg: #5D5CDE; /* Violet pour les bulles de messages envoyés */
            --chat-sent-text: #ffffff;
            --chat-received-bg: #f0f2f5;
            --selection-color: rgba(247, 220, 111, 0.2);
            --action-menu-bg: rgba(0, 0, 0, 0.9);
            --action-menu-text: #ffffff;
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(255, 255, 255, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.1);
            --group-icon-bg: #4CAF50;
            --danger-color: #ff4842;
            --success-color: #4caf50;
            --input-bg: #f0f2f5;
            --input-placeholder: #8e8e93;
            --button-text: #000000;
            --inactive-text: #8e8e93;
            --link-color: #007aff;
            --admin-badge-bg: #5D5CDE;
            --admin-badge-text: white;
            --news-group-bg: #f5a623;
            --log-bg: rgba(0, 0, 0, 0.8);
            --log-text: #ffffff;
            --log-info: #2196F3;
            --log-warning: #FFC107;
            --log-error: #FF5252;
            --log-success: #4CAF50;
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --image-viewer-bg: rgba(0, 0, 0, 0.9);
            --loading-spinner: rgba(255, 255, 255, 0.8);
        }
        
        /* Mode sombre par défaut */
        .dark {
            --bg-color: #181818;
            --text-color: #ffffff;
            --border-color: #3e4042;
            --secondary-color: #2c2c2c;
            --chat-received-bg: #2c2c2c;
            --chat-sent-bg: #F7DC6F; /* Jaune plus visible en mode sombre */
            --chat-sent-text: #000000; /* Texte noir pour contraste avec fond jaune */
            --selection-color: rgba(247, 220, 111, 0.3);
            --action-menu-bg: rgba(60, 60, 60, 0.95);
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(40, 40, 40, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.3);
            --group-icon-bg: #388E3C;
            --danger-color: #ff6b6b;
            --success-color: #66bb6a;
            --input-bg: #2c2c2c;
            --input-placeholder: #6c6c6c;
            --link-color: #2196F3;
            --admin-badge-bg: #7571F9;
            --admin-badge-text: white;
            --news-group-bg: #d48a1c;
            --log-bg: rgba(20, 20, 20, 0.9);
            --log-info: #64B5F6;
            --log-warning: #FFD54F;
            --log-error: #FF8A80;
            --log-success: #81C784;
            --overlay-bg: rgba(0, 0, 0, 0.8);
            --image-viewer-bg: rgba(10, 10, 10, 0.95);
        }
        
        /* Reset de base */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            user-select: none; /* Rendre aucune écriture sélectionnable */
            -webkit-user-select: none; /* Pour Safari */
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            overflow: hidden;
            font-weight: 500; /* Police légèrement plus grasse style iOS */
            letter-spacing: -0.2px; /* Espacement légèrement réduit style iOS */
        }
        
        /* En-tête fixe */
        .header {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 10;
        }
        
        .header-title {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary-color);
        }
        
        .back-button {
            color: var(--primary-color);
            padding: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* Contenu principal */
        .content {
            position: fixed;
            top: 50px; /* Hauteur de l'en-tête */
            bottom: 60px; /* Hauteur de la barre d'onglets */
            left: 0;
            right: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background-color: var(--bg-color);
        }
        
        /* Barre d'onglets fixe */
        .tabbar {
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            z-index: 10;
        }
        
        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #8e8e93;
            font-size: 10px;
            text-decoration: none;
            padding: 8px 0;
            transition: transform 0.15s ease, color 0.2s ease;
        }
        
        .tab:active {
            transform: scale(0.95);
        }
        
        .tab.active {
            color: var(--primary-color);
        }
        
        .tab-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }
        
        /* Sections de contenu */
        .section {
            padding: 10px 0;
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* Profil et éléments utilisateur */
        .profile-pic {
            width: 50px;
            height: 50px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        
        .group-pic {
            width: 50px;
            height: 50px;
            background-color: var(--group-icon-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }

        .news-group-pic {
            width: 50px;
            height: 50px;
            background-color: var(--news-group-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px; 
        }
        
        .chat-item, .user-item {
            display: flex;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s ease, transform 0.3s ease, opacity 0.4s ease;
        }
        
        .chat-item:active, .user-item:active {
            background-color: var(--selection-color);
        }
        
        .chat-item.selected, .user-item.selected {
            background-color: var(--selection-color);
        }
        
        .chat-item.blocked {
            background-color: rgba(255, 107, 107, 0.1);
        }
        
        .chat-item.blocked .item-subtitle {
            color: var(--blocked-color);
            font-style: italic;
        }
        
        .item-content {
            flex: 1;
        }
        
        .item-title {
            font-weight: bold;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }
        
        .item-subtitle {
            color: #6b7280;
            font-size: 14px;
        }
        
        .item-time {
            color: #6b7280;
            font-size: 12px;
        }
        
        /* Badge Admin */
        .admin-badge {
            display: inline-block;
            background-color: var(--admin-badge-bg);
            color: var(--admin-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        /* Formulaires et entrées */
        .search-container {
            padding: 10px 16px;
            position: sticky;
            top: 0;
            background-color: var(--bg-color);
            z-index: 5;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 16px;
            border-radius: 18px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            color: var(--text-color);
        }
        
        /* Écran de chargement */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        
        /* Animation ballon de football avec Font Awesome */
        .football-spinner {
            font-size: 60px;
            color: var(--primary-color);
            animation: bounce 2s infinite, spin 3s linear infinite;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Paramètres */
        .settings-container {
            padding: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .setting-icon {
            width: 36px;
            height: 36px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .setting-label {
            font-weight: 500;
        }
        
        .button {
            background-color: var(--primary-color);
            color: black;
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            transition: transform 0.15s ease, opacity 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .button.danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .button:after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            20% {
                transform: scale(25, 25);
                opacity: 0.3;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }
        
        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        /* Interface de chat */
        .chat-section {
            display: none;
            position: fixed;
            top: 50px;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            z-index: 5;
        }
        
        .chat-messages-container {
            position: absolute;
            top: 0;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow-y: auto;
            background-color: var(--secondary-color);
            -webkit-overflow-scrolling: touch;
            padding: 15px;
        }
        
        .chat-messages {
            width: 100%;
            display: flex;
            flex-direction: column;
            min-height: 100%;
            justify-content: flex-end;
        }
        
        .chat-input-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            padding: 10px;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            align-items: center;
            height: 60px;
        }
        
        .message {
            max-width: 75%;
            padding: 10px 14px;
            margin-bottom: 10px;
            border-radius: 20px; /* Bulles de chat totalement rondes */
            position: relative;
            word-wrap: break-word;
            clear: both;
            transition: background-color 0.2s ease, transform 0.3s ease;
            transform: translateX(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Légère ombre pour effet 3D */
            font-weight: 500; /* Style iOS */
        }
        
        .message-received {
            background-color: var(--chat-received-bg);
            float: left;
            margin-right: auto;
            border-bottom-left-radius: 4px; /* Style iOS/WhatsApp */
        }
        
        .message-sent {
            background-color: var(--chat-sent-bg);
            color: var(--chat-sent-text);
            float: right;
            margin-left: auto;
            border-bottom-right-radius: 4px; /* Style iOS/WhatsApp */
        }
        
        .message.selected {
            background-color: var(--highlight-color);
            border: 2px solid var(--primary-color);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(247, 220, 111, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(247, 220, 111, 0); }
            100% { box-shadow: 0 0 0 0 rgba(247, 220, 111, 0); }
        }
        
        .message-time {
            font-size: 10px;
            margin-top: 4px;
            text-align: right;
            clear: both;
            opacity: 0.7;
        }
        
        .chat-input-wrapper {
            flex: 1;
            margin: 0 10px;
            height: 40px;
            position: relative;
        }
        
        .chat-input {
            width: 100%;
            height: 100%;
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            color: var(--text-color);
            font-weight: 500; /* Style iOS */
        }
        
        .chat-input:focus {
            outline: none;
        }
        
        .input-icon {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--primary-color);
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s ease, transform 0.15s ease;
        }
        
        .input-icon:active {
            transform: scale(0.9);
            background-color: var(--selection-color);
        }
        
        .send-button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: transform 0.15s ease;
        }
        
        .send-button:active {
            transform: scale(0.9);
        }
        
        /* Message action menu */
        .message-actions {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--action-menu-bg);
            color: var(--action-menu-text);
            z-index: 20;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        .message-actions.active {
            transform: translateY(0);
        }
        
        .message-actions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .selected-count {
            font-weight: bold;
        }
        
        .close-actions {
            color: var(--primary-color);
            padding: 8px;
            cursor: pointer;
        }
        
        .action-buttons {
            display: flex;
            padding: 20px;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        
        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.15s ease;
            margin: 5px 10px;
        }
        
        .action-button:active {
            transform: scale(0.9);
        }
        
        .action-icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .action-label {
            font-size: 12px;
        }
        
        /* Selection mode indicator */
        .selection-mode-indicator {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            color: black;
            padding: 8px 15px;
            font-weight: bold;
            display: none;
            z-index: 15;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        /* Section Pronostics - Mis à jour depuis IA */
        .coming-soon-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 30px;
            text-align: center;
        }
        
        .coming-soon-icon {
            font-size: 60px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .coming-soon-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .coming-soon-text {
            color: #6b7280;
            line-height: 1.5;
            max-width: 300px;
            margin: 0 auto 30px auto;
        }
        
        /* Menu options */
        .options-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 40;
            overflow: hidden;
            width: 80%;
            max-width: 300px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .options-menu.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            visibility: visible;
        }
        
        .option-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .option-item:last-child {
            border-bottom: none;
        }
        
        .option-item:active {
            background-color: var(--selection-color);
        }
        
        .option-icon {
            width: 24px;
            text-align: center;
            margin-right: 15px;
            color: var(--primary-color);
        }
        
        .option-label {
            flex: 1;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 35;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Conversations action menu */
        .conversations-actions {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--action-menu-bg);
            color: var(--action-menu-text);
            z-index: 20;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        .conversations-actions.active {
            transform: translateY(0);
        }
        
        .check-circle {
            position: absolute;
            top: 10px;
            right: 15px;
            color: var(--primary-color);
            font-size: 20px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .chat-item.selected .check-circle,
        .user-item.selected .check-circle {
            opacity: 1;
        }
        
        /* Image preview */
        .image-preview {
            padding: 10px;
            display: none;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            position: absolute;
            bottom: 60px;
            left: 0;
            right: 0;
        }
        
        .image-preview.active {
            display: block;
        }
        
        .preview-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .preview-close {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Message with image */
        .message-image {
            max-width: 200px;
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .message-image:active {
            transform: scale(0.98);
        }
        
        /* Block banner */
        .block-banner {
            text-align: center;
            background-color: rgba(255, 107, 107, 0.1);
            color: var(--blocked-color);
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            display: none;
        }
        
        .block-banner.active {
            display: block;
        }
        
        .unblock-btn {
            background-color: var(--blocked-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-top: 5px;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* Style pour la sélection Telegram-like */
        .chat-list {
            position: relative;
        }
        
        .chat-select-checkbox {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-50%) scale(0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        
        .chat-select-checkbox.visible {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .chat-select-checkbox.checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .chat-select-checkbox.checked::after {
            content: "✓";
            color: black;
            font-size: 14px;
            font-weight: bold;
        }
        
        .chat-item.selecting {
            padding-left: 40px;
        }
        
        .telegram-selection-mode .chat-select-checkbox {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .telegram-selection-mode .chat-item {
            padding-left: 40px;
        }
        
        /* Menu de chat supplémentaire */
        .chat-extra-buttons {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 60px;
            background-color: var(--bg-color);
            display: none;
            padding: 10px;
            border-top: 1px solid var(--border-color);
            transition: transform 0.3s ease;
            transform: translateY(100%);
        }
        
        .chat-extra-buttons.active {
            display: flex;
            transform: translateY(0);
        }
        
        .extra-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            color: var(--text-color);
            text-decoration: none;
        }
        
        .extra-button i {
            font-size: 20px;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .extra-button-label {
            font-size: 12px;
        }
        
        /* Style iOS pour les messages de réponse intégrés */
        .quoted-message {
            padding: 8px 10px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 2px solid;
            font-size: 14px;
            position: relative;
        }
        
        .quoted-message.from-me {
            border-left-color: var(--chat-sent-bg);
        }
        
        .quoted-message.from-them {
            border-left-color: var(--chat-received-bg);
        }
        
        .quoted-sender {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .quoted-sender.from-me {
            color: var(--chat-sent-bg);
        }
        
        .quoted-sender.from-them {
            color: var(--primary-color);
        }
        
        .quoted-content {
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Réactions emoji */
        .reaction-panel {
            position: absolute;
            display: flex;
            background-color: var(--reaction-bg);
            border-radius: 24px;
            padding: 5px;
            box-shadow: 0 2px 10px var(--reaction-shadow);
            z-index: 25;
            animation: scaleIn 0.2s ease;
            transform-origin: center;
        }
        
        @keyframes scaleIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .reaction-emoji {
            font-size: 20px;
            padding: 5px 8px;
            cursor: pointer;
            transition: transform 0.15s ease;
            border-radius: 20px;
        }
        
        .reaction-emoji:hover, .reaction-emoji:active {
            transform: scale(1.2);
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .message-reactions {
            display: flex;
            flex-wrap: wrap;
            margin-top: 5px;
            gap: 4px;
        }
        
        .message-reaction {
            display: inline-flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 3px 6px;
            font-size: 14px;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        
        .reaction-count {
            margin-left: 4px;
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Animation de sélection de message pour réponse */
        @keyframes messageSelected {
            0% { transform: translateX(0); }
            25% { transform: translateX(10px); }
            50% { transform: translateX(0); }
            75% { transform: translateX(10px); }
            100% { transform: translateX(0); }
        }
        
        .message.replying {
            animation: messageSelected 0.5s ease;
            background-color: var(--selection-color);
        }
        
        /* Indicateur de frappe (style iOS) */
        .typing-indicator {
            display: none;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
        }
        
        .typing-indicator.active {
            display: block;
        }
        
        .typing-dots {
            display: inline-flex;
            margin-left: 5px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #6b7280;
            border-radius: 50%;
            margin: 0 2px;
            animation: typingDot 1.4s infinite;
            opacity: 0.6;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingDot {
            0% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
            50% { transform: translateY(0); }
            100% { transform: translateY(0); }
        }
        
        /* Style pour le groupe */
        .message-sender {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
            opacity: 0.8;
        }
        
        /* Style pour la section profil modifiée */
        .profile-header {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .profile-header .profile-pic {
            width: 80px;
            height: 80px;
            margin-right: 20px;
        }
        
        .profile-header .profile-pic i {
            font-size: 30px;
            color: var(--primary-color);
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .profile-email {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .profile-status {
            color: #6b7280;
        }
        
        /* Styles pour le dialogue de sélection de contact pour le transfert */
        .forward-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 50;
            display: none;
            flex-direction: column;
        }
        
        .forward-dialog.active {
            display: flex;
        }
        
        .forward-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .forward-title {
            flex: 1;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }
        
        .forward-cancel {
            color: var(--primary-color);
            cursor: pointer;
        }
        
        .forward-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .forward-badge {
            background-color: var(--primary-color);
            color: black;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .confirmation-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 300px;
            padding: 20px;
            z-index: 60;
            display: none;
        }
        
        .confirmation-dialog.active {
            display: block;
        }
        
        .confirmation-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .confirmation-text {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .confirmation-buttons {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        
        .confirmation-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            flex-basis: 45%;
            text-align: center;
        }
        
        .confirmation-cancel {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        
        .confirmation-confirm {
            background-color: var(--primary-color);
            color: black;
        }
        
        .confirmation-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Sélection d'item pour toutes les sections */
        .selectable-item {
            position: relative;
        }
        
        .item-select-checkbox {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-50%) scale(0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        
        .item-select-checkbox.visible {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .item-select-checkbox.checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .item-select-checkbox.checked::after {
            content: "✓";
            color: black;
            font-size: 14px;
            font-weight: bold;
        }
        
        .selection-mode .selectable-item {
            padding-left: 40px;
        }
        
        .selection-mode .item-select-checkbox {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        /* Interface de recherche dans les messages */
        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 50;
            display: none;
            flex-direction: column;
        }
        
        .search-overlay.active {
            display: flex;
        }
        
        .search-header {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-back {
            color: var(--primary-color);
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .search-input-container {
            flex: 1;
            margin: 0 10px;
        }
        
        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .search-result-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            background-color: var(--secondary-color);
        }
        
        .search-result-text {
            margin-bottom: 5px;
        }
        
        .search-result-info {
            font-size: 12px;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
        }
        
        .search-highlight {
            background-color: var(--highlight-color);
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        
        /* Sections "À propos" */
        .about-container {
            padding: 20px;
            margin-top: 10px;
            background-color: var(--secondary-color);
            border-radius: 10px;
        }
        
        .about-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .about-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 15px;
        }
        
        .about-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 15px 0;
        }
        
        .about-version {
            text-align: center;
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.6;
            margin-top: 20px;
        }
        
        /* ============= NOUVELLES FONCTIONNALITÉS =============== */
        
        /* Animation de désintégration pour la suppression de messages */
        @keyframes disintegrate {
            0% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
            }
            30% {
                opacity: 0.9;
                transform: scale(0.98);
                filter: blur(1px);
            }
            60% {
                opacity: 0.6;
                transform: scale(0.9) translate(5px, 0);
                filter: blur(4px);
            }
            100% {
                opacity: 0;
                transform: scale(0.5) translate(20px, 10px);
                filter: blur(10px);
            }
        }
        
        .message.disintegrating {
            animation: disintegrate 0.8s ease-in forwards;
            pointer-events: none;
        }
        
        /* Animation de suppression pour les discussions */
        @keyframes fadeOutRight {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            60% {
                transform: translateX(30px);
                opacity: 0.2;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .chat-item.deleting {
            animation: fadeOutRight 0.5s ease-out forwards;
            pointer-events: none;
        }
        
        /* Nouveau mode de sélection amélioré */
        .new-selection-mode-indicator {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            padding: 10px 15px;
            display: none;
            z-index: 15;
            animation: slideInDown 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes slideInDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        .new-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .new-selection-title {
            font-weight: bold;
            color: black;
        }
        
        .new-selection-actions {
            display: flex;
            align-items: center;
        }
        
        .new-selection-action {
            padding: 5px 10px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            margin-left: 8px;
            font-size: 13px;
            font-weight: 500;
            color: black;
        }
        
        .new-selection-cancel {
            background: none;
        }
        
        /* Styles pour les discussions sélectionnables */
        .chat-item.swipe-selecting {
            transform: translateX(40px);
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .chat-item .select-indicator {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateX(-40px);
            transition: transform 0.3s ease;
        }
        
        .chat-item.swipe-selecting .select-indicator {
            transform: translateX(0);
        }
        
        .select-indicator-inner {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-item.selected .select-indicator-inner {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .chat-item.selected .select-indicator-inner::after {
            content: "✓";
            color: black;
            font-weight: bold;
        }

        /* Installation guide dialog */
        .install-guide {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 50;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .install-guide.active {
            display: flex;
        }
        
        .install-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .install-title {
            flex: 1;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }
        
        .install-close {
            color: var(--primary-color);
            padding: 8px;
            cursor: pointer;
        }
        
        .install-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .install-step {
            margin-bottom: 25px;
        }
        
        .install-step-title {
            font-weight: bold;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .install-step-number {
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            color: black;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .install-step-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
            opacity: 0.9;
        }
        
        .install-image {
            width: 100%;
            max-width: 280px;
            margin: 10px auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: block;
        }
        
        /* Dialogue de suppression amélioré */
        .delete-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 85%;
            max-width: 320px;
            padding: 20px;
            z-index: 60;
            display: none;
            animation: scaleInDialog 0.3s ease;
        }
        
        @keyframes scaleInDialog {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .delete-dialog.active {
            display: block;
        }
        
        .delete-icon {
            font-size: 40px;
            color: var(--danger-color);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .delete-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .delete-text {
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
            opacity: 0.8;
        }
        
        .delete-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .delete-option {
            padding: 12px;
            border-radius: 8px;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .delete-option:active, .delete-option.selected {
            background-color: var(--selection-color);
        }
        
        .delete-option.selected {
            border: 1px solid var(--primary-color);
        }
        
        .delete-option-icon {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .delete-option-label {
            font-weight: 500;
        }
        
        .delete-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .delete-button {
            flex-basis: 48%;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
        }
        
        .delete-cancel {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        
        .delete-confirm {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Bouton de suppression dans le mode sélection */
        .conversation-delete-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--danger-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 15;
            transform: scale(0);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .conversation-delete-btn.active {
            transform: scale(1);
        }
        
        .conversation-delete-btn:active {
            transform: scale(0.95);
        }

        /* ============= NOUVELLES FONCTIONNALITÉS AJOUTÉES =============== */
        
        /* Écran d'authentification */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .auth-header {
            padding: 40px 0 20px;
            text-align: center;
        }
        
        .auth-logo {
            font-size: 50px;
            color: var(--primary-color);
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .auth-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .auth-subtitle {
            font-size: 16px;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 20px;
            padding: 0 20px;
            text-align: center;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            color: var(--inactive-text);
            transition: color 0.3s;
        }
        
        .auth-tab.active {
            color: var(--primary-color);
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 25%;
            width: 50%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }
        
        .auth-form {
            padding: 20px;
            display: none;
            animation: fadeUp 0.5s ease;
        }
        
        @keyframes fadeUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            transform-origin: left;
            transition: transform 0.3s, color 0.3s;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            font-size: 16px;
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(247, 220, 111, 0.25);
        }
        
        .form-input::placeholder {
            color: var(--input-placeholder);
        }
        
        .form-error {
            color: var(--danger-color);
            font-size: 13px;
            margin-top: 6px;
            display: none;
            animation: shakeX 0.75s ease;
        }
        
        @keyframes shakeX {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        
        .form-footer {
            margin-top: 30px;
            text-align: center;
        }
        
        .form-footer-text {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .form-link {
            color: var(--link-color);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }
        
        .form-link:hover {
            text-decoration: underline;
        }

        /* Message log */
        .log-message {
            margin-top: 15px;
            padding: 12px;
            font-weight: bold;
            border-radius: 6px;
            white-space: pre-line;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
          
        .log-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }
          
        .log-message.success {
            background: #d4edda;
            color: #155724;
        }
          
        .log-message.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Empty state message */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--inactive-text);
        }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        /* ANIMATIONS POUR LES FORMULAIRES */
        .form-input:focus + .form-label {
            color: var(--primary-color);
            transform: translateY(-25px) scale(0.8);
        }
        
        .form-input.has-value + .form-label {
            transform: translateY(-25px) scale(0.8);
        }
        
        /* AMÉLIORATIONS DE L'ACCESSIBILITÉ */
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(247, 220, 111, 0.25);
        }
        
        /* TRANSITION ENTRE LES FORMULAIRES */
        .slide-left-enter {
            opacity: 0;
            transform: translateX(30px);
        }
        
        .slide-left-enter-active {
            opacity: 1;
            transform: translateX(0);
            transition: all 0.3s ease;
        }
        
        .slide-left-exit {
            opacity: 1;
            transform: translateX(0);
        }
        
        .slide-left-exit-active {
            opacity: 0;
            transform: translateX(-30px);
            transition: all 0.3s ease;
        }
        
        /* LOADER POUR LES REQUÊTES */
        .btn-loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--bg-color);
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .button.loading {
            pointer-events: none;
            opacity: 0.8;
        }
        
        .button.loading .btn-text {
            visibility: hidden;
        }
        
        .button.loading .btn-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -10px;
            margin-left: -10px;
            visibility: visible;
        }

        /* Bouton X pour la sélection (nouveau) */
        .select-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            opacity: 0.7;
            transition: opacity 0.2s ease, background-color 0.2s ease;
        }

        .chat-item:hover .select-btn {
            opacity: 1;
        }

        .select-btn:hover {
            background-color: var(--primary-color);
            color: black;
        }

        /* Style pour groupe "BetNews" où seul l'admin peut écrire */
        .admin-only-message {
            text-align: center;
            color: var(--inactive-text);
            padding: 10px;
            font-style: italic;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        /* Popup de succès */
        .success-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            padding: 30px;
            width: 90%;
            max-width: 320px;
            z-index: 1001;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .success-popup.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            visibility: visible;
        }
        
        .success-icon {
            font-size: 60px;
            color: var(--success-color);
            margin-bottom: 20px;
        }
        
        .success-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .success-message {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 25px;
            color: var(--text-color);
            opacity: 0.9;
        }
        
        /* Animation d'erreur pour les entrées */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.6s ease;
        }

        /* Nouveau style pour la barre d'action en sélection */
        .selection-action-bar {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--primary-color);
            color: black;
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 30;
            animation: slideInDown 0.3s ease;
        }

        .selection-action-bar.active {
            display: flex;
        }

        .selection-count {
            font-weight: bold;
            font-size: 16px;
        }

        .selection-actions {
            display: flex;
            gap: 20px;
        }

        .selection-action {
            padding: 5px 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .selection-action.delete {
            color: var(--danger-color);
        }

        /* Style pour longpress visual feedback */
        @keyframes pulse-selection {
            0% { transform: scale(1); }
            50% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }

        .chat-item.longpressing {
            animation: pulse-selection 0.6s ease infinite;
            background-color: var(--selection-color);
        }

        /* ============= FENÊTRE DE LOGS =============== */
        .logs-window {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            max-height: 50%;
            background-color: var(--log-bg);
            color: var(--log-text);
            z-index: 100;
            border-top: 2px solid var(--primary-color);
            display: none;
            flex-direction: column;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .logs-window.active {
            display: flex;
            transform: translateY(0);
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.3);
        }

        .logs-title {
            font-weight: bold;
            font-size: 14px;
        }

        .logs-actions {
            display: flex;
            gap: 10px;
        }

        .logs-action {
            padding: 4px 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--primary-color);
        }

        .logs-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
        }

        .log-entry {
            margin-bottom: 4px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            word-break: break-all;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.info {
            color: var(--log-info);
        }

        .log-entry.warning {
            color: var(--log-warning);
        }

        .log-entry.error {
            color: var(--log-error);
        }

        .log-entry.success {
            color: var(--log-success);
        }

        .log-time {
            font-size: 10px;
            opacity: 0.7;
            margin-right: 6px;
        }

        .logs-toggle {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--log-bg);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 99;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .logs-toggle:active {
            transform: scale(0.95);
        }

        /* Style pour les informations de groupe */
        .group-info-badge {
            display: inline-flex;
            align-items: center;
            background-color: rgba(93, 92, 222, 0.2);
            color: var(--primary-color);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }

        .group-info-badge i {
            margin-right: 4px;
            font-size: 10px;
        }

        /* ============= VISIONNEUSE D'IMAGES PERSONNALISÉE =============== */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--image-viewer-bg);
            z-index: 1000;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }

        .image-viewer.active {
            display: flex;
        }

        .image-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            color: white;
            z-index: 1010;
        }

        .image-viewer-close {
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease;
        }

        .image-viewer-close:active {
            background-color: rgba(0, 0, 0, 0.4);
        }

        .image-viewer-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .image-viewer-img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            user-select: none;
            touch-action: none;
            transform-origin: center;
            transition: transform 0.2s ease;
        }

        .image-viewer-img.zoomed {
            cursor: grab;
        }

        .image-viewer-img.zoomed:active {
            cursor: grabbing;
        }

        .image-viewer-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1010;
        }

        .image-viewer-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .image-viewer-button:active {
            background-color: rgba(0, 0, 0, 0.7);
            transform: scale(0.95);
        }

        .image-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 3px solid var(--loading-spinner);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        /* ============= STYLE DE NOTIFICATION =============== */
        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-width: 80%;
            text-align: center;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--danger-color);
        }

        .notification.info {
            border-left: 4px solid var(--primary-color);
        }

        /* État de livraison des messages */
        .message-status {
            font-size: 10px;
            margin-top: 2px;
            text-align: right;
            color: rgba(255, 255, 255, 0.7);
        }

        .message-status.pending {
            color: rgba(255, 255, 255, 0.5);
        }

        .message-status.error {
            color: var(--danger-color);
        }

        .message-status i {
            margin-left: 3px;
        }

        /* Indicateur de connexion */
        .connection-status {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            padding: 5px;
            background-color: var(--danger-color);
            color: white;
            text-align: center;
            font-size: 12px;
            z-index: 100;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .connection-status.offline {
            transform: translateY(0);
        }

        .connection-status.reconnecting {
            background-color: var(--warning-color);
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- Écran d'authentification -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fas fa-futbol"></i>
            </div>
            <h1 class="auth-title">iChat</h1>
            <p class="auth-subtitle">La messagerie moderne et sécurisée</p>
        </div>
        
        <div class="auth-tabs">
            <div class="auth-tab active" id="login-tab">Connexion</div>
            <div class="auth-tab" id="register-tab">Inscription</div>
        </div>
        
        <!-- Formulaire de Connexion -->
        <div id="login-form" class="auth-form active">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="login-email" placeholder="Votre email">
                <div id="login-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="login-password" placeholder="Votre mot de passe">
                <div id="login-password-error" class="form-error">Le mot de passe est obligatoire</div>
            </div>
            
            <div id="login-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="loginBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Se connecter</span>
                </button>
                <p class="form-footer-text">
                    Vous n'avez pas de compte ? <a href="#" class="form-link" id="goto-register">S'inscrire</a>
                </p>
            </div>
        </div>
        
        <!-- Formulaire d'Inscription -->
        <div id="register-form" class="auth-form">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="register-email" placeholder="Votre adresse email">
                <div id="register-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="register-password" placeholder="Créez un mot de passe sécurisé">
                <div id="register-password-error" class="form-error">Le mot de passe doit contenir au moins 6 caractères</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Confirmer le mot de passe</label>
                <input type="password" class="form-input" id="register-confirm-password" placeholder="Confirmez votre mot de passe">
                <div id="register-confirm-password-error" class="form-error">Les mots de passe ne correspondent pas</div>
            </div>
            
            <div id="register-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="registerBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">S'inscrire</span>
                </button>
                <p class="form-footer-text">
                    Vous avez déjà un compte ? <a href="#" class="form-link" id="goto-login">Se connecter</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Écran de chargement -->
    <div id="loading" class="loading">
        <i class="fas fa-futbol football-spinner"></i>
        <div style="font-weight: bold; font-size: 24px; color: var(--primary-color);">iChat</div>
        <div style="margin-top: 10px; color: #6b7280;">Chargement...</div>
    </div>

    <!-- Indicateur de connexion -->
    <div class="connection-status" id="connection-status"></div>

    <!-- En-tête -->
    <div class="header">
        <div id="header-left">
            <span id="header-button" style="display:none;">
                <i class="fas fa-chevron-left"></i>
            </span>
        </div>
        <div id="header-title" class="header-title">Betforce</div>
        <div id="header-action">
            <span class="notification-icon" id="options-button">
                <i class="fas fa-ellipsis-v"></i>
            </span>
        </div>
    </div>

    <!-- Barre d'action en mode sélection -->
    <div id="selection-action-bar" class="selection-action-bar">
        <div class="selection-count" id="selection-action-count">1 sélectionné</div>
        <div class="selection-actions">
            <div class="selection-action delete" id="selection-delete">Supprimer</div>
            <div class="selection-action" id="selection-cancel">Annuler</div>
        </div>
    </div>

    <!-- Overlay pour le menu d'options -->
    <div id="overlay" class="overlay"></div>

    <!-- Menu d'options simplifié pour les sections hors messages -->
    <div id="simple-options-menu" class="options-menu">
        <div class="option-item" id="change-theme-option">
            <div class="option-icon"><i class="fas fa-palette"></i></div>
            <div class="option-label">Changer de thème</div>
        </div>
        <div class="option-item" id="show-install-guide-option">
            <div class="option-icon"><i class="fas fa-download"></i></div>
            <div class="option-label">Installer l'application</div>
        </div>
    </div>
    
    <!-- Menu d'options pour la section messages -->
    <div id="messages-options-menu" class="options-menu">
        <div class="option-item" id="change-theme-messages-option">
            <div class="option-icon"><i class="fas fa-palette"></i></div>
            <div class="option-label">Changer de thème</div>
        </div>
        <div class="option-item" id="show-install-guide-messages-option">
            <div class="option-icon"><i class="fas fa-download"></i></div>
            <div class="option-label">Installer l'application</div>
        </div>
    </div>

    <!-- Menu d'options de chat (avec recherche de messages) -->
    <div id="chat-options-menu" class="options-menu">
        <div class="option-item" id="select-messages-option">
            <div class="option-icon"><i class="fas fa-check-square"></i></div>
            <div class="option-label">Sélectionner des messages</div>
        </div>
        <div id="block-option" class="option-item">
            <div class="option-icon"><i class="fas fa-ban"></i></div>
            <div class="option-label">Bloquer cette personne</div>
        </div>
        <div class="option-item" id="search-conversation-option">
            <div class="option-icon"><i class="fas fa-search"></i></div>
            <div class="option-label">Rechercher dans la conversation</div>
        </div>
        <div class="option-item" id="clear-conversation-option">
            <div class="option-icon"><i class="fas fa-trash-alt"></i></div>
            <div class="option-label">Effacer la conversation</div>
        </div>
        <div class="option-item" id="show-install-guide-chat-option">
            <div class="option-icon"><i class="fas fa-download"></i></div>
            <div class="option-label">Installer l'application</div>
        </div>
    </div>

    <!-- Contenu principal de l'application -->
    <div class="content">
        <!-- Section Messages -->
        <div id="messages-section" class="section active">
            <div class="search-container">
                <input type="text" class="search-input" id="messages-search" placeholder="Rechercher">
            </div>
            
            <div class="chat-list" id="chat-list">
                <!-- Contenu dynamique - uniquement groupe Betforce -->
                <div class="chat-item selectable-item" data-contact="Betforce" data-id="Betforce" data-type="group">
                    <div class="group-pic">
                        <i class="fas fa-users" style="color: white;"></i>
                    </div>
                    <div class="item-content">
                        <div style="display: flex; justify-content: space-between;">
                            <div class="item-title">Betforce<span class="group-info-badge"><i class="fas fa-users"></i> Groupe</span></div>
                            <div class="item-time"></div>
                        </div>
                        <div class="item-subtitle">Chargement des messages...</div>
                    </div>
                    <i class="fas fa-check-circle check-circle"></i>
                </div>
            </div>
        </div>
        
        <!-- Section utilisateurs -->
        <div id="users-section" class="section">
            <div class="search-container">
                <input type="text" class="search-input" id="users-search" placeholder="Rechercher un utilisateur">
            </div>
            
            <div id="users-list">
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <div class="empty-state-title">Connexion en cours</div>
                    <div class="empty-state-text">La liste des utilisateurs apparaîtra ici une fois connecté</div>
                </div>
            </div>
        </div>
        
        <!-- Section Pronostics -->
        <div id="pronostics-section" class="section">
            <div class="coming-soon-container">
                <i class="fas fa-futbol coming-soon-icon"></i>
                <div class="coming-soon-title">Pronostics sportifs</div>
                <p class="coming-soon-text">
                    Retrouvez bientôt les meilleurs pronostics sportifs pour vos paris. Soyez alerté des opportunités de gains!
                </p>
                <button class="button" id="notify-launch-button">Être notifié(e) au lancement</button>
            </div>
        </div>
        
        <!-- Section Profil -->
        <div id="profile-section" class="section">
            <div class="profile-header">
                <div class="profile-pic">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="profile-name">
                        <span id="profile-name-text">Utilisateur</span>
                        <span class="admin-badge" id="admin-badge" style="display: none;">Admin</span>
                    </div>
                    <div class="profile-email" id="profile-email">user@example.com</div>
                    <div class="profile-status">En ligne</div>
                </div>
            </div>
            
            <div style="padding: 0 16px; margin: 15px 0; font-weight: bold; font-size: 18px;">Paramètres</div>
            
            <div class="settings-container">
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-palette" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Couleur de l'interface</div>
                    </div>
                    <input type="color" id="color-picker" value="#F7DC6F" style="width: 30px; height: 30px; border: none;">
                </div>
                
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-moon" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Mode sombre</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="dark-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <!-- Section "À propos" -->
                <div style="padding: 0; margin: 20px 0 15px 0; font-weight: bold; font-size: 18px;">À propos</div>
                
                <div class="about-container">
                    <div class="about-title">iChat</div>
                    <div class="about-text">Une application de messagerie sécurisée et facile à utiliser qui vous permet de rester en contact avec vos amis et votre famille.</div>
                    
                    <div class="about-divider"></div>
                    
                    <div class="about-text">
                        <strong>Fonctionnalités :</strong>
                        <ul style="padding-left: 20px; margin-top: 5px;">
                            <li>Messagerie instantanée</li>
                            <li>Partage de photos</li>
                            <li>Groupes de discussion</li>
                            <li>Mode sombre</li>
                        </ul>
                    </div>
                    
                    <div class="about-version">Version 2.5.0</div>
                </div>
                
                <button id="logout-btn" class="button">Se déconnecter</button>
                
                <!-- Bouton pour supprimer le compte -->
                <button id="delete-account-btn" class="button danger">Supprimer mon compte</button>
            </div>
        </div>
    </div>

    <!-- Interface de Chat -->
    <div id="chat-interface" class="chat-section">
        <div id="block-banner" class="block-banner">
            Vous avez bloqué cette personne
            <button class="unblock-btn" id="unblock-btn">Débloquer</button>
        </div>
        <div class="chat-messages-container">
            <div class="chat-messages" id="chat-messages">
                <!-- Les messages seront ajoutés dynamiquement ici -->
            </div>
            <div id="typing-indicator" class="typing-indicator">
                <span id="typing-name"></span> est en train d'écrire
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
        <div id="image-preview" class="image-preview">
            <div style="position: relative; display: inline-block;">
                <img id="preview-img" class="preview-image" src="" alt="Aperçu">
                <div class="preview-close" id="preview-close">
                    <i class="fas fa-times"></i>
                </div>
            </div>
        </div>
        <div class="chat-input-container" id="chat-input-container">
            <div class="input-icon" id="emoji-button">
                <i class="far fa-smile"></i>
            </div>
            <div class="input-icon" id="attachment-button">
                <i class="fas fa-paperclip"></i>
            </div>
            <div class="chat-input-wrapper">
                <input type="text" id="chat-input" class="chat-input" placeholder="Écrire un message..." autocomplete="off">
            </div>
            <div class="send-button" id="send-button">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>
        <div id="chat-extra-buttons" class="chat-extra-buttons">
            <div class="extra-button" id="image-button">
                <i class="fas fa-image"></i>
                <span class="extra-button-label">Image</span>
            </div>
            <div class="extra-button" id="file-button">
                <i class="fas fa-file"></i>
                <span class="extra-button-label">Document</span>
            </div>
            <div class="extra-button" id="camera-button">
                <i class="fas fa-camera"></i>
                <span class="extra-button-label">Appareil photo</span>
            </div>
            <div class="extra-button" id="location-button">
                <i class="fas fa-map-marker-alt"></i>
                <span class="extra-button-label">Localisation</span>
            </div>
        </div>
        <input type="file" id="image-input" accept="image/*" style="display: none;">
    </div>

    <!-- Interface de recherche dans les messages -->
    <div id="search-overlay" class="search-overlay">
        <div class="search-header">
            <div class="search-back" id="search-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="search-input-container">
                <input type="text" id="message-search-input" class="search-input" placeholder="Rechercher dans les messages...">
            </div>
        </div>
        <div id="search-results" class="search-results">
            <div class="no-results">Saisissez un terme à rechercher</div>
        </div>
    </div>

    <!-- Menu d'actions pour les messages sélectionnés -->
    <div id="message-actions" class="message-actions">
        <div class="message-actions-header">
            <div class="selected-count" id="selected-count">1 sélectionné</div>
            <div class="close-actions" id="close-message-actions">Annuler</div>
        </div>
        <div class="action-buttons">
            <div class="action-button" id="delete-messages-btn">
                <div class="action-icon"><i class="fas fa-trash-alt"></i></div>
                <div class="action-label">Supprimer</div>
            </div>
            <div class="action-button" id="forward-messages-btn">
                <div class="action-icon"><i class="fas fa-share"></i></div>
                <div class="action-label">Transférer</div>
            </div>
            <div class="action-button" id="copy-messages-btn">
                <div class="action-icon"><i class="fas fa-copy"></i></div>
                <div class="action-label">Copier</div>
            </div>
            <div class="action-button" id="reply-message-btn">
                <div class="action-icon"><i class="fas fa-reply"></i></div>
                <div class="action-label">Répondre</div>
            </div>
        </div>
    </div>

    <!-- Menu de réactions emoji rapides -->
    <div id="reaction-panel" class="reaction-panel" style="display: none;">
        <div class="reaction-emoji" data-emoji="👍">👍</div>
        <div class="reaction-emoji" data-emoji="😂">😂</div>
        <div class="reaction-emoji" data-emoji="😡">😡</div>
        <div class="reaction-emoji" data-emoji="👎">👎</div>
        <div class="reaction-emoji" data-emoji="🤯">🤯</div>
        <div class="reaction-emoji" data-emoji="🎉">🎉</div>
    </div>

    <!-- Interface de transfert de messages -->
    <div id="forward-dialog" class="forward-dialog">
        <div class="forward-header">
            <div class="forward-cancel" id="forward-cancel">Annuler</div>
            <div class="forward-title">Transférer à <span id="forward-count-badge" class="forward-badge">1</span></div>
        </div>
        <div class="forward-list" id="forward-contacts-list">
            <!-- Les contacts seront ajoutés dynamiquement ici -->
        </div>
    </div>

    <!-- Boîte de dialogue de confirmation -->
    <div id="confirmation-dialog" class="confirmation-dialog">
        <div class="confirmation-title">Confirmation</div>
        <div class="confirmation-text" id="confirmation-text">Êtes-vous sûr de vouloir effectuer cette action?</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="confirmation-cancel">Annuler</div>
            <div class="confirmation-button confirmation-confirm" id="confirmation-confirm">Confirmer</div>
        </div>
    </div>

    <!-- Boîte de dialogue de suppression de compte -->
    <div id="delete-account-dialog" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer le compte</div>
        <div class="confirmation-text">Êtes-vous sûr de vouloir supprimer votre compte ? Cette action est irréversible et toutes vos données seront perdues.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-account-cancel">Annuler</div>
            <div class="confirmation-button confirmation-danger" id="delete-account-confirm">Supprimer</div>
        </div>
    </div>

    <!-- Dialogue de suppression des messages avec options -->
    <div id="delete-message-dialog" class="delete-dialog">
        <div class="delete-icon">
            <i class="fas fa-trash-alt"></i>
        </div>
        <div class="delete-title">Supprimer les messages</div>
        <div class="delete-text">Comment souhaitez-vous supprimer ces messages ?</div>
        
        <div class="delete-options">
            <div class="delete-option" id="delete-for-me">
                <div class="delete-option-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="delete-option-label">Supprimer pour moi seulement</div>
            </div>
            <div class="delete-option" id="delete-for-all">
                <div class="delete-option-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="delete-option-label">Supprimer pour tout le monde</div>
            </div>
        </div>
        
        <div class="delete-buttons">
            <div class="delete-button delete-cancel" id="delete-messages-cancel">Annuler</div>
            <div class="delete-button delete-confirm" id="delete-messages-confirm">Supprimer</div>
        </div>
    </div>

    <!-- Guide d'installation -->
    <div id="install-guide" class="install-guide">
        <div class="install-header">
            <div class="install-close" id="close-install-guide">
                <i class="fas fa-times"></i>
            </div>
            <div class="install-title">Installer l'application</div>
        </div>
        <div class="install-content">
            <div class="install-step">
                <div class="install-step-title">
                    <div class="install-step-number">1</div>
                    <div>Sur iPhone & iPad (Safari)</div>
                </div>
                <div class="install-step-text">
                    Appuyez sur l'icône de partage dans la barre de navigation (rectangle avec une flèche pointant vers le haut).
                </div>
                <div class="install-step-text" style="margin-top: 10px;">
                    Faites défiler les options et appuyez sur "Sur l'écran d'accueil".
                </div>
            </div>
            
            <div class="install-step">
                <div class="install-step-title">
                    <div class="install-step-number">2</div>
                    <div>Sur Android (Chrome)</div>
                </div>
                <div class="install-step-text">
                    Appuyez sur les trois points dans le coin supérieur droit puis sur "Ajouter à l'écran d'accueil".
                </div>
            </div>
            
            <div class="install-step">
                <div class="install-step-title">
                    <div class="install-step-number">3</div>
                    <div>Sur ordinateur (Chrome)</div>
                </div>
                <div class="install-step-text">
                    Cliquez sur les trois points dans le coin supérieur droit puis sur "Installer iChat".
                </div>
            </div>
            
            <div class="install-step">
                <div class="install-step-text" style="text-align: center; margin-top: 30px;">
                    Une fois installée, l'application fonctionnera en mode plein écran et hors-ligne comme une application native !
                </div>
            </div>
        </div>
    </div>

    <!-- Popup de succès -->
    <div id="success-popup" class="success-popup">
        <div class="success-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h3 class="success-title" id="success-title">Succès !</h3>
        <p class="success-message" id="success-message">Opération réussie avec succès !</p>
        <button class="button" id="success-button">Continuer</button>
    </div>

    <!-- Visionneuse d'images personnalisée -->
    <div id="image-viewer" class="image-viewer">
        <div class="image-viewer-header">
            <div class="image-viewer-close" id="image-viewer-close">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="image-viewer-content">
            <div class="image-loader" id="image-loader"></div>
            <img src="" alt="Image agrandie" id="image-viewer-img" class="image-viewer-img">
        </div>
        <div class="image-viewer-controls">
            <div class="image-viewer-button" id="image-viewer-zoom-out">
                <i class="fas fa-search-minus"></i>
            </div>
            <div class="image-viewer-button" id="image-viewer-zoom-in">
                <i class="fas fa-search-plus"></i>
            </div>
            <div class="image-viewer-button" id="image-viewer-download">
                <i class="fas fa-download"></i>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Barre d'onglets -->
    <div class="tabbar" id="tabbar">
        <a href="#" class="tab active" data-section="messages">
            <i class="tab-icon fas fa-comments"></i>
            <span>Messages</span>
        </a>
        <a href="#" class="tab" data-section="users">
            <i class="tab-icon fas fa-users"></i>
            <span>Utilisateurs</span>
        </a>
        <a href="#" class="tab" data-section="pronostics">
            <i class="tab-icon fas fa-futbol"></i>
            <span>Pronostics</span>
        </a>
        <a href="#" class="tab" data-section="profile">
            <i class="tab-icon fas fa-user"></i>
            <span>Profil</span>
        </a>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy, addDoc, onSnapshot, where, deleteDoc, serverTimestamp, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDTPLxUiA8lj82kqc6CyCPLQDITc0CtLUE",
            authDomain: "ichat-betai.firebaseapp.com",
            databaseURL: "https://ichat-betai-default-rtdb.firebaseio.com",
            projectId: "ichat-betai",
            storageBucket: "ichat-betai.appspot.com",
            messagingSenderId: "168337722600",
            appId: "1:168337722600:web:beb331f83cc4778c5b4d5d",
            measurementId: "G-STXPSZN7X8"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables globales
        let isLoggedIn = false;
        let currentUser = null;
        let currentUserData = null;
        let isAdmin = false;
        
        // Variables pour l'interface de chat
        let currentContact = '';
        let currentDiscussionId = null;
        let currentDiscussionType = null;
        let isSelectionMode = false;
        let selectionModeType = '';
        let selectedMessages = new Set();
        let selectedItems = new Set();
        let messagesForForward = [];
        let targetContactForForward = '';
        let messageReactions = {};
        let blockedUsers = new Set();
        let replyToMessage = null;
        let selectedImage = null;
        let isAttachmentsOpen = false;
        let isOptionsMenuOpen = false;
        let lastTap = 0;
        let currentTappedMessage = null;
        let currentSection = 'messages';
        let selectedDeleteOption = 'for-me';
        let pendingMessages = {};
        let longPressTimer = null;
        let longPressDuration = 500; // Durée en ms pour considérer un appui long
        let chatUnsubscribers = {}; // Pour stocker les fonctions d'unsubscribe des écouteurs de chat
        let isOnline = navigator.onLine;
        let messageQueue = []; // Pour stocker les messages à envoyer lorsque hors ligne
        let currentImageScale = 1;
        let currentImagePosition = { x: 0, y: 0 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        
        // ================ FONCTIONS POUR LA VÉRIFICATION DE CONNEXION ================
        
        // Surveiller la connexion internet
        function setupConnectionMonitoring() {
            const connectionStatus = document.getElementById('connection-status');
            
            function updateConnectionStatus() {
                if (navigator.onLine) {
                    connectionStatus.textContent = '';
                    connectionStatus.classList.remove('offline');
                    connectionStatus.classList.remove('reconnecting');
                    isOnline = true;
                    
                    // Traiter les messages en attente d'envoi
                    processQueuedMessages();
                } else {
                    connectionStatus.textContent = 'Pas de connexion internet';
                    connectionStatus.classList.add('offline');
                    isOnline = false;
                }
            }
            
            window.addEventListener('online', () => {
                connectionStatus.textContent = 'Reconnexion en cours...';
                connectionStatus.classList.remove('offline');
                connectionStatus.classList.add('reconnecting');
                
                // Attendre un peu pour s'assurer que la connexion est stable
                setTimeout(() => {
                    updateConnectionStatus();
                    // Recharger les discussions si on est connecté
                    if (isLoggedIn && currentSection === 'messages') {
                        loadConversations();
                    }
                }, 1500);
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus();
                showNotification('Pas de connexion internet. Les messages seront envoyés lorsque vous serez connecté.', 'error');
            });
            
            // Vérifier l'état initial
            updateConnectionStatus();
        }
        
        // Traiter les messages en attente d'envoi
        async function processQueuedMessages() {
            if (messageQueue.length === 0) return;
            
            const processedMessages = [...messageQueue];
            messageQueue = []; // Vider la file d'attente
            
            for (const message of processedMessages) {
                try {
                    await sendMessageToFirestore(
                        message.discussionId, 
                        message.text, 
                        message.image, 
                        message.replyTo
                    );
                } catch (error) {
                    // Remettre le message dans la file d'attente
                    messageQueue.push(message);
                }
            }
            
            if (messageQueue.length > 0) {
                showNotification(`${messageQueue.length} message(s) n'ont pas pu être envoyés`, 'error');
            } else if (processedMessages.length > 0) {
                showNotification('Tous les messages ont été envoyés', 'success');
            }
        }
        
        // Afficher une notification dans l'interface
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            
            // Afficher la notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Masquer la notification après un délai
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.className = 'notification';
                }, 300);
            }, 3000);
        }
        
        // ================ FONCTIONS POUR LES ÉVÉNEMENTS D'INTERFACE ================
        
        // Fonction pour détecter le mode sombre du système
        function setupDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
            
            // Initialiser l'état du toggle
            document.getElementById('dark-toggle').checked = document.documentElement.classList.contains('dark');
        }
        
        // Fonction pour configurer les événements de l'interface
        function setupUIEvents() {
            // Onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionName = tab.getAttribute('data-section');
                    changeTab(sectionName);
                });
            });
            
            // Boutons d'options
            document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            document.getElementById('overlay').addEventListener('click', closeAllDialogs);
            
            // Options menus
            document.getElementById('change-theme-option').addEventListener('click', changeTheme);
            document.getElementById('change-theme-messages-option').addEventListener('click', changeTheme);
            document.getElementById('show-install-guide-option').addEventListener('click', showInstallGuide);
            document.getElementById('show-install-guide-messages-option').addEventListener('click', showInstallGuide);
            document.getElementById('show-install-guide-chat-option').addEventListener('click', showInstallGuide);
            document.getElementById('select-messages-option').addEventListener('click', startMessagesSelectionMode);
            document.getElementById('block-option').addEventListener('click', blockUnblockUser);
            document.getElementById('search-conversation-option').addEventListener('click', searchInConversation);
            document.getElementById('clear-conversation-option').addEventListener('click', clearConversation);
            
            // Actions en mode sélection
            document.getElementById('selection-delete').addEventListener('click', deleteSelectedItems);
            document.getElementById('selection-cancel').addEventListener('click', exitSelectionMode);
            
            // Fermer guides
            document.getElementById('close-install-guide').addEventListener('click', closeInstallGuide);
            
            // Actions de messages
            document.getElementById('delete-messages-btn').addEventListener('click', showDeleteMessageOptions);
            document.getElementById('forward-messages-btn').addEventListener('click', forwardSelectedMessages);
            document.getElementById('copy-messages-btn').addEventListener('click', copySelectedMessages);
            document.getElementById('reply-message-btn').addEventListener('click', replyToSelectedMessage);
            document.getElementById('close-message-actions').addEventListener('click', () => exitSelectionMode('messages'));
            
            // Options de suppression
            document.getElementById('delete-for-me').addEventListener('click', () => selectDeleteOption('for-me'));
            document.getElementById('delete-for-all').addEventListener('click', () => selectDeleteOption('for-all'));
            document.getElementById('delete-messages-cancel').addEventListener('click', closeDeleteMessageDialog);
            document.getElementById('delete-messages-confirm').addEventListener('click', confirmDeleteMessages);
            
            // Interface de transfert
            document.getElementById('forward-cancel').addEventListener('click', closeForwardDialog);
            
            // Interface de chat
            document.getElementById('chat-input').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('emoji-button').addEventListener('click', openEmojiKeyboard);
            document.getElementById('attachment-button').addEventListener('click', toggleAttachments);
            document.getElementById('preview-close').addEventListener('click', clearImagePreview);
            document.getElementById('unblock-btn').addEventListener('click', unblockUser);
            
            // Interface de recherche
            document.getElementById('search-back').addEventListener('click', closeSearchInterface);
            document.getElementById('message-search-input').addEventListener('input', searchMessages);
            
            // Boutons d'attachement
            document.getElementById('image-button').addEventListener('click', selectImage);
            document.getElementById('file-button').addEventListener('click', selectFile);
            document.getElementById('camera-button').addEventListener('click', selectCamera);
            document.getElementById('location-button').addEventListener('click', selectLocation);
            
            // Sélection d'image
            document.getElementById('image-input').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    selectedImage = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('preview-img').src = event.target.result;
                        document.getElementById('image-preview').classList.add('active');
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // Événements pour les paramètres
            document.getElementById('color-picker').addEventListener('input', function(e) {
                changeAppColor(e.target.value);
            });
            
            document.getElementById('dark-toggle').addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.classList.add('dark');
                    // En mode sombre, la couleur du message est la même que la couleur primaire
                    document.documentElement.style.setProperty('--chat-sent-bg', document.documentElement.style.getPropertyValue('--primary-color') || '#F7DC6F');
                } else {
                    document.documentElement.classList.remove('dark');
                    // En mode clair, la couleur du message est violette
                    document.documentElement.style.setProperty('--chat-sent-bg', '#5D5CDE');
                }
                
                // Sauvegarder la préférence
                localStorage.setItem('ichatDarkMode', this.checked ? 'true' : 'false');
            });
            
            // Événements du profil
            document.getElementById('logout-btn').addEventListener('click', logoutUser);
            document.getElementById('delete-account-btn').addEventListener('click', showDeleteAccountConfirmation);
            document.getElementById('delete-account-cancel').addEventListener('click', closeDeleteAccountDialog);
            document.getElementById('delete-account-confirm').addEventListener('click', deleteAccount);
            
            // Événements de confirmation
            document.getElementById('confirmation-cancel').addEventListener('click', closeConfirmationDialog);
            
            // Pronostics
            document.getElementById('notify-launch-button').addEventListener('click', notifyLaunch);
            
            // Visionneuse d'images
            document.getElementById('image-viewer-close').addEventListener('click', closeImageViewer);
            document.getElementById('image-viewer-zoom-in').addEventListener('click', zoomInImage);
            document.getElementById('image-viewer-zoom-out').addEventListener('click', zoomOutImage);
            document.getElementById('image-viewer-download').addEventListener('click', downloadViewerImage);
            
            setupImageViewerGestures();
            
            // Ouvrir le chat Betforce au démarrage
            document.querySelector('.chat-item[data-id="Betforce"]').addEventListener('click', function() {
                openChat("Betforce", null, "Betforce", "group");
            });
        }
        
        // Configuration des gestes pour la visionneuse d'images
        function setupImageViewerGestures() {
            const imageElement = document.getElementById('image-viewer-img');
            
            // Zoom avec la molette de la souris
            imageElement.addEventListener('wheel', function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                
                // Limiter le zoom entre 0.5 et 5
                const newScale = Math.max(0.5, Math.min(5, currentImageScale + delta));
                zoomImage(newScale);
            });
            
            // Gestion du glisser-déposer
            imageElement.addEventListener('mousedown', function(e) {
                if (currentImageScale > 1) {
                    isDragging = true;
                    dragStart.x = e.clientX - currentImagePosition.x;
                    dragStart.y = e.clientY - currentImagePosition.y;
                    imageElement.style.cursor = 'grabbing';
                }
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    // Calculer la nouvelle position
                    const newX = e.clientX - dragStart.x;
                    const newY = e.clientY - dragStart.y;
                    
                    // Mettre à jour la position
                    currentImagePosition.x = newX;
                    currentImagePosition.y = newY;
                    
                    // Appliquer la transformation
                    imageElement.style.transform = `translate(${newX}px, ${newY}px) scale(${currentImageScale})`;
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    imageElement.style.cursor = 'grab';
                }
            });
            
            // Gestion des gestes tactiles
            imageElement.addEventListener('touchstart', function(e) {
                if (e.touches.length === 1 && currentImageScale > 1) {
                    isDragging = true;
                    dragStart.x = e.touches[0].clientX - currentImagePosition.x;
                    dragStart.y = e.touches[0].clientY - currentImagePosition.y;
                }
            });
            
            imageElement.addEventListener('touchmove', function(e) {
                if (isDragging && e.touches.length === 1) {
                    // Calculer la nouvelle position
                    const newX = e.touches[0].clientX - dragStart.x;
                    const newY = e.touches[0].clientY - dragStart.y;
                    
                    // Mettre à jour la position
                    currentImagePosition.x = newX;
                    currentImagePosition.y = newY;
                    
                    // Appliquer la transformation
                    imageElement.style.transform = `translate(${newX}px, ${newY}px) scale(${currentImageScale})`;
                }
            });
            
            imageElement.addEventListener('touchend', function() {
                isDragging = false;
            });
            
            // Double-clic pour réinitialiser le zoom
            imageElement.addEventListener('dblclick', function() {
                if (currentImageScale !== 1) {
                    resetImageViewer();
                } else {
                    zoomInImage();
                }
            });
        }
        
        // Changer la couleur de l'application et la sauvegarder
        function changeAppColor(color) {
            document.documentElement.style.setProperty('--primary-color', color);
            
            // Mettre à jour l'icône de loading
            const footballSpinner = document.querySelector('.football-spinner');
            if (footballSpinner) {
                footballSpinner.style.color = color;
            }
            
            // En mode sombre, mettre à jour la couleur des messages envoyés
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.style.setProperty('--chat-sent-bg', color);
            }
            
            // Sauvegarder la préférence
            localStorage.setItem('ichatColor', color);
        }
        
        // ================ CONFIGURATION DES ÉVÉNEMENTS D'AUTHENTIFICATION ================
        
        function setupAuthEvents() {
            // Tabs d'authentification
            document.getElementById('login-tab').addEventListener('click', () => changeAuthTab('login'));
            document.getElementById('register-tab').addEventListener('click', () => changeAuthTab('register'));
            
            // Navigation entre les formulaires
            document.getElementById('goto-register').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('register');
            });
            
            document.getElementById('goto-login').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('login');
            });
            
            // Boutons d'action
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            document.getElementById('registerBtn').addEventListener('click', registerUser);
            
            // Validation en temps réel
            document.getElementById('login-email').addEventListener('input', validateLoginEmail);
            document.getElementById('login-password').addEventListener('input', validateLoginPassword);
            document.getElementById('register-email').addEventListener('input', validateRegisterEmail);
            document.getElementById('register-password').addEventListener('input', validateRegisterPassword);
            document.getElementById('register-confirm-password').addEventListener('input', validateRegisterConfirmPassword);
            
            // Validation à la soumission
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateLoginForm()) {
                    loginUser();
                }
            });
            
            document.getElementById('register-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateRegisterForm()) {
                    registerUser();
                }
            });
        }
        
        // ================ FONCTIONS DE NAVIGATION ================
        
        // Fonction pour changer d'onglet
        function changeTab(tabName) {
            // Si le menu d'options est ouvert, le fermer
            if (isOptionsMenuOpen) {
                closeOptionsMenu();
            }
            
            // Si le menu d'attachements est ouvert, le fermer
            if (isAttachmentsOpen) {
                document.getElementById('chat-extra-buttons').classList.remove('active');
                isAttachmentsOpen = false;
            }
            
            // Si on est dans l'interface de chat, retourner à la liste des messages
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
                if (tabName === 'messages') return;
            }
            
            // Si on est en mode sélection, quitter ce mode
            if (isSelectionMode) {
                exitSelectionMode();
            }
            
            // Masquer le panel de réactions s'il est visible
            document.getElementById('reaction-panel').style.display = 'none';
            
            // Mettre à jour la section active
            currentSection = tabName;
            
            // Mettre à jour les onglets actifs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`.tab[data-section="${tabName}"]`).classList.add('active');
            
            // Mettre à jour le titre dans l'en-tête
            document.getElementById('header-title').textContent = tabName === 'messages' ? 'Betforce' : tabName.charAt(0).toUpperCase() + tabName.slice(1);
            
            // Réinitialiser l'en-tête
            document.getElementById('header-left').innerHTML = '';
            document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
            
            // Réattacher les événements
            document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            
            // Masquer toutes les sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Afficher la section active
            document.getElementById(`${tabName}-section`).classList.add('active');
            
            // Charger le contenu approprié selon la section
            if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'messages') {
                // Si on est sur la section messages, ouvrir automatiquement Betforce
                if (isLoggedIn) {
                    openChat("Betforce", null, "Betforce", "group");
                }
            }
        }
        
        // Fonction pour ouvrir une conversation
        function openChat(contact, contactId, discussionId, discussionType = 'private') {
            if (!contact) return;
            
            // Si le menu d'options est ouvert, le fermer
            if (isOptionsMenuOpen) {
                closeOptionsMenu();
            }
            
            // Si on est en mode sélection, ne pas ouvrir le chat
            if (isSelectionMode) {
                return;
            }
            
            // Désabonner des anciens listeners si présents
            unsubscribeFromCurrentChat();
            
            currentContact = contact;
            currentDiscussionId = discussionId;
            currentDiscussionType = discussionType;
            
            // Cacher la barre d'onglets
            document.getElementById('tabbar').style.display = 'none';
            
            // Cacher les sections normales
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mettre à jour l'en-tête
            document.getElementById('header-title').innerText = contact;
            document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
            document.getElementById('header-left').innerHTML = '<div class="back-button" id="header-button"><i class="fas fa-chevron-left"></i></div>';
            
            // Réattacher l'événement d'options
            document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            document.getElementById('header-button').addEventListener('click', closeChat);
            
            // Afficher l'interface de chat
            document.getElementById('chat-interface').style.display = 'block';
            
            // Vérifier si l'utilisateur est bloqué
            if (blockedUsers.has(contactId)) {
                document.getElementById('block-banner').classList.add('active');
            } else {
                document.getElementById('block-banner').classList.remove('active');
            }
            
            // Pour Betforce, tous les utilisateurs peuvent écrire
            document.getElementById('chat-input-container').style.display = 'flex';
            
            // Charger les messages
            loadChatMessages(discussionId, discussionType);
        }
        
        // Fonction pour fermer une conversation
        function closeChat() {
            // Désabonner des écouteurs de chat
            unsubscribeFromCurrentChat();
            
            // Si on est en mode sélection des messages, le quitter d'abord
            if (isSelectionMode && selectionModeType === 'messages') {
                exitSelectionMode();
            }
            
            // Si l'interface de recherche est ouverte, la fermer
            if (document.getElementById('search-overlay').classList.contains('active')) {
                closeSearchInterface();
            }
            
            // Si le menu d'attachements est ouvert, le fermer
            if (isAttachmentsOpen) {
                document.getElementById('chat-extra-buttons').classList.remove('active');
                isAttachmentsOpen = false;
            }
            
            // Masquer l'indicateur de frappe
            document.getElementById('typing-indicator').classList.remove('active');
            
            // Masquer le panel de réactions s'il est visible
            document.getElementById('reaction-panel').style.display = 'none';
            
            // Afficher la barre d'onglets
            document.getElementById('tabbar').style.display = 'flex';
            
            // Cacher l'interface de chat
            document.getElementById('chat-interface').style.display = 'none';
            
            // Réinitialiser l'en-tête pour revenir à la liste des messages
            document.getElementById('header-title').innerText = 'Betforce';
            document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
            document.getElementById('header-left').innerHTML = '';
            
            // Réattacher les événements
            document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            
            // Afficher la section messages
            document.getElementById('messages-section').classList.add('active');
            currentSection = 'messages';
            
            // Réinitialiser les variables de la conversation active
            currentContact = '';
            currentDiscussionId = null;
            currentDiscussionType = null;
            replyToMessage = null;
        }
        
        // Désabonner des écouteurs de chat
        function unsubscribeFromCurrentChat() {
            if (currentDiscussionId && chatUnsubscribers[currentDiscussionId]) {
                chatUnsubscribers[currentDiscussionId]();
                delete chatUnsubscribers[currentDiscussionId];
            }
        }
        
        // ================ FONCTIONS D'AUTHENTIFICATION ================
        
        // Changer l'onglet dans l'écran d'authentification
        function changeAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                
                // Transition animée
                registerForm.style.animation = 'none';
                void registerForm.offsetWidth; // Forcer le reflow pour redémarrer l'animation
                registerForm.style.animation = '';
                
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                
                // Transition animée
                loginForm.style.animation = 'none';
                void loginForm.offsetWidth; // Forcer le reflow pour redémarrer l'animation
                loginForm.style.animation = '';
                
                loginForm.classList.remove('active');
                registerForm.classList.add('active');
            }
            
            // Masquer les messages d'erreur
            hideLog('login-log');
            hideLog('register-log');
            
            // Activer l'animation du formulaire qui apparaît
            const activeForm = tab === 'login' ? loginForm : registerForm;
            activeForm.style.animation = 'fadeUp 0.5s ease';
        }
        
        // Valider l'email de connexion
        function validateLoginEmail() {
            const email = document.getElementById('login-email').value.trim();
            const errorElement = document.getElementById('login-email-error');
            
            if (!email) {
                errorElement.textContent = 'L\'email est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (!isValidEmail(email)) {
                errorElement.textContent = 'Format d\'email invalide';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider le mot de passe de connexion
        function validateLoginPassword() {
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-password-error');
            
            if (!password) {
                errorElement.textContent = 'Le mot de passe est requis';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider l'email d'inscription
        function validateRegisterEmail() {
            const email = document.getElementById('register-email').value.trim();
            const errorElement = document.getElementById('register-email-error');
            
            if (!email) {
                errorElement.textContent = 'L\'email est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (!isValidEmail(email)) {
                errorElement.textContent = 'Format d\'email invalide';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider le mot de passe d'inscription
        function validateRegisterPassword() {
            const password = document.getElementById('register-password').value;
            const errorElement = document.getElementById('register-password-error');
            
            if (!password) {
                errorElement.textContent = 'Le mot de passe est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (password.length < 6) {
                errorElement.textContent = 'Le mot de passe doit contenir au moins 6 caractères';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider la confirmation du mot de passe
        function validateRegisterConfirmPassword() {
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const errorElement = document.getElementById('register-confirm-password-error');
            
            if (!confirmPassword) {
                errorElement.textContent = 'La confirmation du mot de passe est requise';
                errorElement.style.display = 'block';
                return false;
            } else if (password !== confirmPassword) {
                errorElement.textContent = 'Les mots de passe ne correspondent pas';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider le formulaire de connexion complet
        function validateLoginForm() {
            return validateLoginEmail() && validateLoginPassword();
        }
        
        // Valider le formulaire d'inscription complet
        function validateRegisterForm() {
            return validateRegisterEmail() && validateRegisterPassword() && validateRegisterConfirmPassword();
        }
        
        // Vérifier si un email est valide
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Afficher un message de log
        function showLog(elementId, text, type="info") {
            const logDiv = document.getElementById(elementId);
            logDiv.textContent = text;
            logDiv.className = `log-message ${type}`;
            logDiv.style.display = "block";
            
            // Ajouter une animation d'apparition
            logDiv.style.animation = 'fadeIn 0.5s ease';
        }
        
        // Masquer un message de log
        function hideLog(elementId) {
            const logDiv = document.getElementById(elementId);
            if (logDiv) {
                logDiv.style.display = "none";
            }
        }
        
        // Connexion d'un utilisateur
        async function loginUser() {
            // Validation finale avant de soumettre
            if (!validateLoginForm()) {
                return;
            }
            
            const email = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value;
            
            // Afficher le loader sur le bouton
            setButtonLoading('loginBtn', true);
            hideLog("login-log");
            
            try {
                showLog("login-log", "Connexion en cours...", "info");
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // Stocker les informations dans les variables globales
                currentUser = userCredential.user;
                
                showLog("login-log", "Connexion réussie ! Redirection...", "success");
                
                // Rediriger vers l'application après un court délai
                setTimeout(() => {
                    completeLogin();
                }, 1000);
            } catch (error) {
                let errorMessage = "Erreur de connexion";
                
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = "Email ou mot de passe incorrect.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "L'adresse email n'est pas valide.";
                        break;
                    case 'auth/user-disabled':
                        errorMessage = "Ce compte a été désactivé.";
                        break;
                    default:
                        errorMessage = "Erreur de connexion: " + error.message;
                }
                
                showLog("login-log", errorMessage, "error");
                setButtonLoading('loginBtn', false);
                
                // Animation de secousse sur le formulaire
                const loginForm = document.getElementById('login-form');
                loginForm.classList.add('shake');
                setTimeout(() => {
                    loginForm.classList.remove('shake');
                }, 600);
            }
        }
        
        // Inscription d'un utilisateur
        async function registerUser() {
            // Validation finale avant de soumettre
            if (!validateRegisterForm()) {
                return;
            }
            
            const email = document.getElementById("register-email").value.trim();
            const password = document.getElementById("register-password").value;
            
            // Afficher le loader sur le bouton
            setButtonLoading('registerBtn', true);
            hideLog("register-log");
            
            try {
                showLog("register-log", "Inscription en cours...", "info");
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;
                const statut = await createUserProfile(uid, email);
                
                showLog("register-log", `Inscription réussie ! Compte créé avec succès.`, "success");
                
                // Stocker les informations dans les variables globales
                currentUser = userCredential.user;
                
                // Une fois inscrit, ajouter l'utilisateur aux groupes Betforce
                await addUserToGroups(uid);
                
                setTimeout(() => {
                    completeLogin();
                }, 1000);
            } catch (error) {
                let errorMessage = "Erreur d'inscription";
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = "Cette adresse email est déjà utilisée.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "L'adresse email n'est pas valide.";
                        break;
                    case 'auth/weak-password':
                        errorMessage = "Le mot de passe est trop faible.";
                        break;
                    default:
                        errorMessage = "Erreur d'inscription: " + error.message;
                }
                
                showLog("register-log", errorMessage, "error");
                setButtonLoading('registerBtn', false);
                
                // Animation de secousse sur le formulaire
                const registerForm = document.getElementById('register-form');
                registerForm.classList.add('shake');
                setTimeout(() => {
                    registerForm.classList.remove('shake');
                }, 600);
            }
        }
        
        // Afficher/masquer le loader sur un bouton
        function setButtonLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            const loader = button.querySelector('.btn-loader');
            
            if (isLoading) {
                button.classList.add('loading');
                loader.style.display = 'inline-block';
            } else {
                button.classList.remove('loading');
                loader.style.display = 'none';
            }
        }
        
        // Création d'un profil utilisateur dans Firestore
        async function createUserProfile(uid, email) {
            try {
                // Vérifie si admin déjà défini
                const adminRef = doc(db, "Config", "admin");
                const adminSnap = await getDoc(adminRef);

                let statut = "simple";
                if (!adminSnap.exists()) {
                    statut = "admin";
                    // Crée l'admin dans Config
                    await setDoc(adminRef, {
                        uid: uid,
                        email: email,
                        createdAt: new Date().toISOString()
                    });
                }

                // Crée le profil utilisateur dans Users
                const userRef = doc(db, "Users", uid);
                await setDoc(userRef, {
                    email: email,
                    statut: statut,
                    createdAt: new Date().toISOString(),
                    displayName: email.split('@')[0] // Utilisez la partie avant @ comme nom d'affichage
                });
                
                return statut;
            } catch (error) {
                return "simple";
            }
        }
        
        // Ajouter un utilisateur au groupe Betforce
        async function addUserToGroups(userId) {
            try {
                // Récupérer tous les utilisateurs existants pour les ajouter au groupe
                const usersRef = collection(db, "Users");
                const userSnap = await getDocs(usersRef);
                let allUserIds = userSnap.docs.map(doc => doc.id);
                
                // Vérifier si le groupe existe déjà
                const betforceRef = doc(db, "groups", "Betforce");
                const betforceSnap = await getDoc(betforceRef);
                
                // Créer ou mettre à jour Betforce avec tous les utilisateurs
                if (!betforceSnap.exists()) {
                    // Créer le groupe Betforce avec tous les utilisateurs
                    await setDoc(betforceRef, {
                        name: "Betforce",
                        description: "Groupe de discussion pour les paris sportifs",
                        members: allUserIds,
                        createdAt: serverTimestamp(),
                        isSpecial: true
                    });
                    
                    // Créer la collection de messages pour ce groupe
                    const messagesRef = collection(db, "groups", "Betforce", "messages");
                    await addDoc(messagesRef, {
                        text: "Bienvenue à tous dans le groupe !",
                        senderId: "admin",
                        createdAt: serverTimestamp(),
                        type: "text"
                    });
                    
                    await addDoc(messagesRef, {
                        text: "Ce groupe est dédié aux discussions sur les paris sportifs.",
                        senderId: "admin",
                        createdAt: serverTimestamp(),
                        type: "text"
                    });
                } else {
                    // Ajouter l'utilisateur au groupe existant
                    await updateDoc(betforceRef, {
                        members: allUserIds
                    });
                }
            } catch (error) {
                console.error("Erreur lors de l'ajout aux groupes:", error);
            }
        }
        
        // Déconnexion de l'utilisateur
        async function logoutUser() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').querySelector('div:nth-child(3)').innerText = 'Déconnexion...';
            
            try {
                // Désabonner de tous les écouteurs
                Object.keys(chatUnsubscribers).forEach(discussionId => {
                    if (chatUnsubscribers[discussionId]) {
                        chatUnsubscribers[discussionId]();
                    }
                });
                chatUnsubscribers = {};
                
                await signOut(auth);
                
                // Réinitialiser les variables globales
                isLoggedIn = false;
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                currentContact = '';
                currentDiscussionId = null;
                currentDiscussionType = null;
                pendingMessages = {};
                
                // Rediriger vers l'écran de connexion
                showLoginScreen();
            } catch (error) {
                // Masquer l'écran de chargement
                hideLoading();
            }
        }
        
        // Suppression du compte utilisateur
        async function deleteAccount() {
            closeDeleteAccountDialog();
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').querySelector('div:nth-child(3)').innerText = 'Suppression du compte...';
            
            try {
                // Si l'utilisateur est connecté, supprimer son compte
                if (currentUser) {
                    // Désabonner de tous les écouteurs
                    Object.keys(chatUnsubscribers).forEach(discussionId => {
                        if (chatUnsubscribers[discussionId]) {
                            chatUnsubscribers[discussionId]();
                        }
                    });
                    chatUnsubscribers = {};
                    
                    // Supprimer les données de l'utilisateur de Firestore
                    await deleteDoc(doc(db, "Users", currentUser.uid));
                    
                    // Supprimer l'utilisateur du groupe
                    const betforceRef = doc(db, "groups", "Betforce");
                    const betforceSnap = await getDoc(betforceRef);
                    
                    if (betforceSnap.exists()) {
                        await updateDoc(betforceRef, {
                            members: arrayRemove(currentUser.uid)
                        });
                    }
                    
                    // Supprimer le compte Firebase Auth
                    await currentUser.delete();
                }
                
                // Effacer toutes les données locales
                localStorage.clear();
                
                // Réinitialiser les variables globales
                isLoggedIn = false;
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                
                // Afficher l'écran de connexion
                showLoginScreen();
            } catch (error) {
                // Masquer l'écran de chargement
                hideLoading();
                
                // Afficher une erreur
                document.getElementById('success-popup').classList.add('active');
            }
        }
        
        // Récupérer les données utilisateur de Firestore
        async function getUserData(uid) {
            try {
                const userRef = doc(db, "Users", uid);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    return { id: userSnap.id, ...userSnap.data() };
                } else {
                    return null;
                }
            } catch (error) {
                return null;
            }
        }
        
        // ================ FONCTIONS POUR LES MESSAGES ================
        
        // Charger les conversations dans la liste depuis Firestore
        async function loadConversations() {
            // Pour cet exemple, nous n'avons qu'une seule discussion: Betforce
            // Le code est simplifié, pas besoin de charger d'autres discussions
            const chatItem = document.querySelector('.chat-item[data-id="Betforce"]');
            
            // Si on est connecté, ouvrir automatiquement Betforce
            if (isLoggedIn) {
                openChat("Betforce", null, "Betforce", "group");
            }
        }
        
        // Charger la liste des utilisateurs depuis Firestore
        async function loadUsers() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            
            try {
                // Si aucun utilisateur
                if (!currentUser) {
                    usersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <div class="empty-state-title">Connexion requise</div>
                            <div class="empty-state-text">Connectez-vous pour voir les utilisateurs</div>
                        </div>
                    `;
                    return;
                }
                
                // Récupérer tous les utilisateurs
                const usersRef = collection(db, "Users");
                const querySnapshot = await getDocs(usersRef);
                
                if (querySnapshot.empty) {
                    usersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <div class="empty-state-title">Aucun utilisateur</div>
                            <div class="empty-state-text">Les utilisateurs apparaîtront ici quand ils seront connectés</div>
                        </div>
                    `;
                    return;
                }
                
                // Ajouter chaque utilisateur à la liste, sauf l'utilisateur actuel
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (doc.id !== currentUser.uid) {
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        userItem.setAttribute('data-user-id', doc.id);
                        userItem.setAttribute('data-user-email', userData.email);
                        
                        const displayName = userData.displayName || userData.email.split('@')[0];
                        
                        userItem.innerHTML = `
                            <div class="profile-pic">
                                <i class="fas fa-user" style="color: var(--primary-color);"></i>
                            </div>
                            <div class="item-content">
                                <div class="item-title">
                                    ${displayName}
                                    ${userData.statut === 'admin' ? '<span class="admin-badge">Admin</span>' : ''}
                                </div>
                                <div class="item-subtitle">${userData.email}</div>
                            </div>
                        `;
                        
                        usersList.appendChild(userItem);
                    }
                });
                
            } catch (error) {
                usersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="empty-state-title">Erreur de chargement</div>
                        <div class="empty-state-text">Impossible de charger les utilisateurs. Veuillez réessayer.</div>
                    </div>
                `;
            }
        }
        
        // Charger les messages d'une conversation avec écouteur en temps réel
        function loadChatMessages(discussionId, discussionType) {
            if (!discussionId) return;
            
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            // Montrer un indicateur de chargement
            messagesContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--inactive-text);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                    <div style="margin-top: 10px;">Chargement des messages...</div>
                </div>
            `;
            
            try {
                let messagesRef;
                
                if (discussionType === 'group') {
                    messagesRef = collection(db, "groups", discussionId, "messages");
                } else {
                    messagesRef = collection(db, "discussions", discussionId, "messages");
                }
                
                const q = query(messagesRef, orderBy("createdAt", "asc"));
                
                // S'abonner aux mises à jour des messages
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    // Initialiser ou vider le conteneur de messages
                    messagesContainer.innerHTML = '';
                    
                    if (snapshot.empty) {
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--inactive-text);">
                                Aucun message. Commencez la conversation !
                            </div>
                        `;
                        return;
                    }
                    
                    // Créer un fragment pour améliorer les performances
                    const fragment = document.createDocumentFragment();
                    
                    // Ajouter les messages dans l'ordre chronologique
                    snapshot.forEach(doc => {
                        const messageData = doc.data();
                        const messageId = doc.id;
                        
                        const fromMe = messageData.senderId === currentUser.uid;
                        
                        const messageElement = createMessageElement(
                            messageId, 
                            messageData, 
                            fromMe, 
                            discussionType === 'group'
                        );
                        
                        fragment.appendChild(messageElement);
                        
                        // Supprimer ce message des messages en attente s'il était présent
                        if (pendingMessages[messageId]) {
                            delete pendingMessages[messageId];
                        }
                    });
                    
                    // Ajouter tous les messages au conteneur
                    messagesContainer.appendChild(fragment);
                    
                    // Défiler vers le bas pour voir les messages les plus récents
                    scrollToBottom();
                }, (error) => {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                            <i class="fas fa-exclamation-circle" style="font-size: 24px;"></i>
                            <div style="margin-top: 10px;">Erreur de chargement des messages</div>
                        </div>
                    `;
                });
                
                // Stocker la fonction d'unsubscribe pour pouvoir la désactiver plus tard
                chatUnsubscribers[discussionId] = unsubscribe;
                
            } catch (error) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                        <i class="fas fa-exclamation-circle" style="font-size: 24px;"></i>
                        <div style="margin-top: 10px;">Erreur lors du chargement des messages</div>
                    </div>
                `;
            }
        }
        
        // Créer un élément de message
        function createMessageElement(messageId, messageData, fromMe, isGroup) {
            const messageDiv = document.createElement('div');
            
            if (fromMe) {
                messageDiv.className = 'message message-sent';
            } else {
                messageDiv.className = 'message message-received';
                
                // Ajouter le nom de l'expéditeur pour les messages de groupe
                if (isGroup) {
                    const senderName = document.createElement('div');
                    senderName.className = `message-sender sender-${messageData.senderId}`;
                    
                    // Récupérer le nom de l'expéditeur
                    if (messageData.senderId === 'admin') {
                        senderName.textContent = 'Admin';
                    } else {
                        getDisplayNameFromId(messageData.senderId).then(name => {
                            senderName.textContent = name;
                        });
                    }
                    
                    messageDiv.appendChild(senderName);
                }
            }
            
            messageDiv.setAttribute('data-id', messageId);
            messageDiv.setAttribute('data-from', messageData.senderId || 'unknown');
            
            // Si c'est une réponse à un autre message
            if (messageData.replyTo) {
                const quotedDiv = document.createElement('div');
                // Ajouter des classes différentes selon l'expéditeur du message cité
                const fromClass = messageData.replyTo.senderId === currentUser.uid ? 'from-me' : 'from-them';
                quotedDiv.className = 'quoted-message ' + fromClass;
                
                const quotedSender = document.createElement('div');
                quotedSender.className = 'quoted-sender ' + fromClass;
                
                // Dans un groupe ou si l'expéditeur est connu, utiliser le nom approprié
                if (isGroup || messageData.replyTo.senderName) {
                    quotedSender.textContent = messageData.replyTo.senderName || getDisplayName(messageData.replyTo.senderId);
                } else {
                    quotedSender.textContent = fromClass === 'from-me' ? 'Vous' : currentContact;
                }
                
                const quotedContent = document.createElement('div');
                quotedContent.className = 'quoted-content';
                quotedContent.textContent = messageData.replyTo.text || "Image";
                
                quotedDiv.appendChild(quotedSender);
                quotedDiv.appendChild(quotedContent);
                messageDiv.appendChild(quotedDiv);
            }
            
            // Ajouter le contenu du message
            if (messageData.type === 'text' || !messageData.type) {
                const messageText = document.createElement('div');
                messageText.textContent = messageData.text;
                messageDiv.appendChild(messageText);
            }
            
            // Si le message contient une image
            if (messageData.type === 'image' || messageData.image) {
                const messageImage = document.createElement('img');
                messageImage.className = 'message-image';
                messageImage.src = messageData.image || messageData.imageUrl;
                messageImage.alt = 'Image';
                messageImage.loading = 'lazy';
                
                // Ajouter un événement pour ouvrir l'image en plein écran
                messageImage.addEventListener('click', function() {
                    openImageViewer(this.src);
                });
                
                messageDiv.appendChild(messageImage);
            }
            
            // Ajouter l'heure du message
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            
            // Formater l'heure du message
            if (messageData.createdAt) {
                messageTime.textContent = formatTimestamp(messageData.createdAt);
            } else {
                messageTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            messageDiv.appendChild(messageTime);
            
            // Ajouter l'indicateur de statut du message pour les messages envoyés
            if (fromMe) {
                const messageStatus = document.createElement('div');
                messageStatus.className = 'message-status';
                
                // Déterminer le statut du message
                if (messageData.status === 'error') {
                    messageStatus.innerHTML = 'Erreur <i class="fas fa-exclamation-circle"></i>';
                    messageStatus.classList.add('error');
                } else if (messageData.status === 'pending') {
                    messageStatus.innerHTML = 'Envoi... <i class="fas fa-circle-notch fa-spin"></i>';
                    messageStatus.classList.add('pending');
                } else if (messageData.status === 'sent') {
                    messageStatus.innerHTML = 'Envoyé <i class="fas fa-check"></i>';
                } else if (messageData.status === 'delivered') {
                    messageStatus.innerHTML = 'Livré <i class="fas fa-check-double"></i>';
                } else if (messageData.status === 'read') {
                    messageStatus.innerHTML = 'Lu <i class="fas fa-check-double" style="color: var(--primary-color);"></i>';
                } else {
                    // Par défaut pour les messages déjà dans la base de données
                    messageStatus.innerHTML = 'Envoyé <i class="fas fa-check"></i>';
                }
                
                messageDiv.appendChild(messageStatus);
            }
            
            // Ajouter les réactions si elles existent
            if (messageData.reactions && Object.keys(messageData.reactions).length > 0) {
                const reactionsContainer = document.createElement('div');
                reactionsContainer.className = 'message-reactions';
                
                Object.entries(messageData.reactions).forEach(([emoji, users]) => {
                    const reaction = document.createElement('div');
                    reaction.className = 'message-reaction';
                    reaction.innerHTML = `${emoji} <span class="reaction-count">${Object.keys(users).length}</span>`;
                    reactionsContainer.appendChild(reaction);
                });
                
                messageDiv.appendChild(reactionsContainer);
            }
            
            // Ajouter les gestionnaires d'événements
            addMessageEventListeners(messageDiv);
            
            return messageDiv;
        }
        
        // Formater un timestamp Firestore
        function formatTimestamp(timestamp) {
            if (!timestamp) return "";
            
            // Si c'est un timestamp Firestore
            if (timestamp.toDate) {
                const date = timestamp.toDate();
                return `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
            }
            
            // Si c'est une date standard
            if (timestamp instanceof Date) {
                return `${timestamp.getHours()}:${timestamp.getMinutes().toString().padStart(2, '0')}`;
            }
            
            // Si c'est déjà une chaîne formatée
            return timestamp;
        }
        
        // Défiler vers le bas de la conversation
        function scrollToBottom() {
            const chatMessagesContainer = document.querySelector('.chat-messages-container');
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
        
        // Ajouter des gestionnaires d'événements aux messages
        function addMessageEventListeners(messageElement) {
            // Gestion du double tap pour les réactions
            messageElement.addEventListener('click', function(e) {
                if (isSelectionMode && selectionModeType === 'messages') {
                    toggleMessageSelection(this);
                    e.preventDefault();
                    return;
                }
                
                const now = new Date().getTime();
                const timeSince = now - lastTap;
                
                // Pour le double tap, il doit être le même élément
                if (timeSince < 300 && timeSince > 0 && currentTappedMessage === this) {
                    // Double tap détecté
                    e.preventDefault();
                    
                    // Afficher le panneau de réactions
                    const messageId = this.getAttribute('data-id');
                    const messageRect = this.getBoundingClientRect();
                    const messageCenter = messageRect.left + messageRect.width / 2;
                    const windowWidth = window.innerWidth;
                    
                    // Positionner le panneau au-dessus du message
                    const panelLeft = Math.min(
                        Math.max(messageCenter - 150, 10), // Ne pas dépasser à gauche
                        windowWidth - 300 - 10 // Ne pas dépasser à droite
                    );
                    
                    showReactionPanel(messageId, panelLeft, messageRect.top - 60);
                    
                    // Vibration pour feedback tactile
                    if (navigator.vibrate) {
                        navigator.vibrate(30);
                    }
                    
                    // Réinitialiser pour éviter des doubles détections
                    lastTap = 0;
                } else {
                    // Premier tap
                    lastTap = now;
                    currentTappedMessage = this;
                }
            });
            
            // Gestion des événements tactiles pour le glissement
            let swipeStartX, swipeStartY;
            
            messageElement.addEventListener('touchstart', function(e) {
                if (isSelectionMode) return;
                
                const touch = e.touches[0];
                swipeStartX = touch.clientX;
                swipeStartY = touch.clientY;
            });
            
            messageElement.addEventListener('touchmove', function(e) {
                if (isSelectionMode) return;
                
                if (!e.touches[0]) return;
                
                const touch = e.touches[0];
                const deltaX = touch.clientX - swipeStartX;
                const deltaY = Math.abs(touch.clientY - swipeStartY);
                
                // Si le déplacement est plus horizontal que vertical
                if (Math.abs(deltaX) > deltaY && Math.abs(deltaX) > 10) {
                    this.style.transform = `translateX(${deltaX / 2}px)`;
                }
            });
            
            messageElement.addEventListener('touchend', function(e) {
                if (isSelectionMode) return;
                
                const touch = e.changedTouches[0];
                const deltaX = touch.clientX - swipeStartX;
                
                // Réponse automatique au swipe
                handleSwipe(this, deltaX > 0 ? 'right' : 'left', Math.abs(deltaX));
                
                // Réinitialiser la position
                this.style.transform = 'translateX(0)';
            });
            
            // Gestion du clic droit (pour les ordinateurs)
            messageElement.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                
                // Utiliser le clic droit pour la sélection directe
                if (!isSelectionMode) {
                    startMessagesSelectionMode();
                }
                toggleMessageSelection(this);
                
                return false;
            });
        }
        
        // Gérer le glissement de message - automatiquement sélectionner pour répondre
        function handleSwipe(messageElement, direction, distance) {
            if (isSelectionMode) return;
            
            // Réinitialiser tous les autres messages
            document.querySelectorAll('.message').forEach(msg => {
                if (msg !== messageElement) {
                    msg.style.transform = 'translateX(0)';
                }
            });
            
            if (Math.abs(distance) > 30) {
                // Déclencher l'animation de sélection
                messageElement.classList.add('replying');
                
                // Après l'animation, préparer la réponse
                setTimeout(() => {
                    const messageId = messageElement.getAttribute('data-id');
                    replyToMessageAction(messageId);
                    messageElement.classList.remove('replying');
                }, 500);
            }
        }
        
        // Préparer une réponse à un message
        async function replyToMessageAction(messageId) {
            if (!currentDiscussionId) return;
            
            try {
                // Récupérer les informations du message
                let messageRef;
                if (currentDiscussionType === 'group') {
                    messageRef = doc(db, "groups", currentDiscussionId, "messages", messageId);
                } else {
                    messageRef = doc(db, "discussions", currentDiscussionId, "messages", messageId);
                }
                
                const messageSnap = await getDoc(messageRef);
                
                if (messageSnap.exists()) {
                    const messageData = messageSnap.data();
                    
                    // Stocker la référence pour l'envoi
                    replyToMessage = {
                        id: messageId,
                        text: messageData.text,
                        senderId: messageData.senderId,
                        senderName: messageData.senderId === currentUser.uid ? 'Vous' : await getDisplayNameFromId(messageData.senderId)
                    };
                    
                    // Focus sur l'input
                    document.getElementById('chat-input').focus();
                    
                    // Vibration pour feedback tactile
                    if (navigator.vibrate) {
                        navigator.vibrate([30, 50, 30]);
                    }
                    
                    // Montrer une notification
                    showNotification('Répondre au message...', 'info');
                }
            } catch (error) {
                showNotification("Erreur lors de la préparation de la réponse", "error");
            }
        }
        
        // Récupérer le nom d'affichage d'un utilisateur à partir de son ID
        async function getDisplayNameFromId(userId) {
            // Si c'est l'utilisateur actuel
            if (userId === currentUser.uid) {
                return 'Vous';
            }
            
            // Si c'est l'admin
            if (userId === 'admin') {
                return 'Admin';
            }
            
            try {
                const userRef = doc(db, "Users", userId);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    return userData.displayName || userData.email.split('@')[0];
                }
            } catch (error) {
                // En cas d'erreur, retourner un nom générique
            }
            
            return 'Utilisateur';
        }
        
        // Afficher le panneau de réactions
        function showReactionPanel(messageId, x, y) {
            const reactionPanel = document.getElementById('reaction-panel');
            
            // Positionner le panel près du message
            reactionPanel.style.left = `${x}px`;
            reactionPanel.style.top = `${y}px`;
            reactionPanel.style.display = 'flex';
            
            // Stocker le message ID pour la réaction
            reactionPanel.setAttribute('data-message-id', messageId);
            
            // Gestionnaire pour masquer le panel quand on clique ailleurs
            document.addEventListener('click', hideReactionPanel);
            
            // Ajouter les gestionnaires pour chaque émoji
            document.querySelectorAll('.reaction-emoji').forEach(emoji => {
                emoji.onclick = function(e) {
                    e.stopPropagation();
                    const emojiValue = this.getAttribute('data-emoji');
                    addReaction(messageId, emojiValue);
                    hideReactionPanel();
                };
            });
        }
        
        // Masquer le panel de réactions
        function hideReactionPanel() {
            document.getElementById('reaction-panel').style.display = 'none';
            document.removeEventListener('click', hideReactionPanel);
        }
        
        // Ajouter une réaction à un message
        async function addReaction(messageId, emoji) {
            if (!currentDiscussionId || !currentUser) return;
            
            try {
                let messageRef;
                if (currentDiscussionType === 'group') {
                    messageRef = doc(db, "groups", currentDiscussionId, "messages", messageId);
                } else {
                    messageRef = doc(db, "discussions", currentDiscussionId, "messages", messageId);
                }
                
                // Créer le chemin pour les réactions
                const reactionPath = `reactions.${emoji}.${currentUser.uid.replace(/\./g, '_')}`;
                
                // Mettre à jour le document
                await updateDoc(messageRef, {
                    [reactionPath]: true
                });
                
                // Effet de vibration pour feedback
                if (navigator.vibrate) {
                    navigator.vibrate(20);
                }
                
            } catch (error) {
                showNotification("Impossible d'ajouter la réaction", "error");
            }
        }
        
        // Envoyer un message
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if ((message === '' && !selectedImage) || !currentDiscussionId) return;
            
            // Générer un ID temporaire pour ce message
            const tempMessageId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
            
            try {
                // Préparer l'image si elle existe
                let imageBase64 = null;
                if (selectedImage) {
                    imageBase64 = document.getElementById('preview-img').src;
                }
                
                // Vider l'entrée immédiatement
                input.value = '';
                clearImagePreview();
                
                // Créer un élément de message "en attente"
                addPendingMessageToUI(tempMessageId, message, imageBase64);
                
                // Défiler vers le bas pour voir le nouveau message
                scrollToBottom();
                
                // Si on est en ligne, envoyer immédiatement le message
                if (isOnline) {
                    await sendMessageToFirestore(currentDiscussionId, message, imageBase64, replyToMessage, tempMessageId);
                } else {
                    // Si hors ligne, ajouter à la file d'attente
                    messageQueue.push({
                        discussionId: currentDiscussionId,
                        text: message,
                        image: imageBase64,
                        replyTo: replyToMessage
                    });
                    
                    showNotification("Vous êtes hors ligne. Le message sera envoyé lorsque vous serez connecté.", "info");
                }
                
                // Réinitialiser le message de réponse
                replyToMessage = null;
                
            } catch (error) {
                // Mettre à jour l'état du message en attente pour indiquer l'erreur
                updatePendingMessageStatus(tempMessageId, 'error');
                
                showNotification("Erreur lors de l'envoi du message", "error");
            }
        }
        
        // Ajouter un message en attente à l'interface
        function addPendingMessageToUI(messageId, text, imageBase64) {
            const messagesContainer = document.getElementById('chat-messages');
            
            // Créer l'élément de message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-sent';
            messageDiv.setAttribute('data-id', messageId);
            messageDiv.setAttribute('data-from', currentUser.uid);
            
            // Si c'est une réponse à un autre message
            if (replyToMessage) {
                const quotedDiv = document.createElement('div');
                quotedDiv.className = 'quoted-message from-them';
                
                const quotedSender = document.createElement('div');
                quotedSender.className = 'quoted-sender from-them';
                quotedSender.textContent = replyToMessage.senderName || 'Utilisateur';
                
                const quotedContent = document.createElement('div');
                quotedContent.className = 'quoted-content';
                quotedContent.textContent = replyToMessage.text || "Image";
                
                quotedDiv.appendChild(quotedSender);
                quotedDiv.appendChild(quotedContent);
                messageDiv.appendChild(quotedDiv);
            }
            
            // Ajouter le texte s'il existe
            if (text && text.trim() !== '') {
                const messageText = document.createElement('div');
                messageText.textContent = text;
                messageDiv.appendChild(messageText);
            }
            
            // Ajouter l'image si elle existe
            if (imageBase64) {
                const messageImage = document.createElement('img');
                messageImage.className = 'message-image';
                messageImage.src = imageBase64;
                messageImage.alt = 'Image';
                
                // Ajouter un événement pour ouvrir l'image en plein écran
                messageImage.addEventListener('click', function() {
                    openImageViewer(this.src);
                });
                
                messageDiv.appendChild(messageImage);
            }
            
            // Ajouter l'heure du message
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            messageDiv.appendChild(messageTime);
            
            // Ajouter l'indicateur de statut
            const messageStatus = document.createElement('div');
            messageStatus.className = 'message-status pending';
            messageStatus.innerHTML = 'Envoi... <i class="fas fa-circle-notch fa-spin"></i>';
            messageDiv.appendChild(messageStatus);
            
            // Ajouter le message à l'interface
            messagesContainer.appendChild(messageDiv);
            
            // Stocker le message en attente
            pendingMessages[messageId] = {
                id: messageId,
                text: text,
                image: imageBase64,
                replyTo: replyToMessage,
                status: 'pending'
            };
        }
        
        // Mettre à jour le statut d'un message en attente
        function updatePendingMessageStatus(messageId, status) {
            const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
            if (!messageElement) return;
            
            const statusElement = messageElement.querySelector('.message-status');
            if (!statusElement) return;
            
            statusElement.classList.remove('pending', 'error');
            
            if (status === 'error') {
                statusElement.innerHTML = 'Erreur <i class="fas fa-exclamation-circle"></i>';
                statusElement.classList.add('error');
                
                // Mettre à jour le statut dans l'objet pendingMessages
                if (pendingMessages[messageId]) {
                    pendingMessages[messageId].status = 'error';
                }
            } else if (status === 'sent') {
                statusElement.innerHTML = 'Envoyé <i class="fas fa-check"></i>';
                
                // Supprimer de la liste des messages en attente
                if (pendingMessages[messageId]) {
                    delete pendingMessages[messageId];
                }
            }
        }
        
        // Envoyer un message à Firestore
        async function sendMessageToFirestore(discussionId, text, imageBase64, replyToMsg, tempMessageId) {
            if (!discussionId || (!text && !imageBase64)) return;
            
            try {
                // Déterminer le chemin de la collection de messages
                let messagesRef;
                let discussionRef;
                
                if (currentDiscussionType === 'group') {
                    messagesRef = collection(db, "groups", discussionId, "messages");
                    discussionRef = doc(db, "groups", discussionId);
                } else {
                    messagesRef = collection(db, "discussions", discussionId, "messages");
                    discussionRef = doc(db, "discussions", discussionId);
                }
                
                // Préparer les données du message
                const messageData = {
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    status: 'sent'
                };
                
                // Ajouter le texte s'il existe
                if (text && text.trim() !== '') {
                    messageData.text = text;
                    messageData.type = 'text';
                }
                
                // Ajouter l'image s'il en existe une
                if (imageBase64) {
                    messageData.image = imageBase64;
                    messageData.type = 'image';
                }
                
                // Ajouter la référence au message répondu si existant
                if (replyToMsg) {
                    messageData.replyTo = {
                        id: replyToMsg.id,
                        text: replyToMsg.text,
                        senderId: replyToMsg.senderId,
                        senderName: replyToMsg.senderName
                    };
                }
                
                // Ajouter le message à la collection
                const docRef = await addDoc(messagesRef, messageData);
                
                // Mettre à jour le statut du message en attente s'il existe
                if (tempMessageId) {
                    updatePendingMessageStatus(tempMessageId, 'sent');
                }
                
                // Mettre à jour les informations de la discussion
                await updateDoc(discussionRef, {
                    lastMessage: text || "Image",
                    lastMessageTime: serverTimestamp(),
                    lastSenderId: currentUser.uid
                });
                
                return docRef.id;
            } catch (error) {
                // Mettre à jour le statut du message en attente s'il existe
                if (tempMessageId) {
                    updatePendingMessageStatus(tempMessageId, 'error');
                }
                
                throw error; // Re-throw l'erreur pour la gestion plus haut
            }
        }
        
        // Obtenir le nom d'affichage à partir de l'identifiant utilisateur
        function getDisplayName(userId) {
            switch(userId) {
                case 'user': return 'Utilisateur';
                case 'admin': return 'Admin';
                case currentUser?.uid: return 'Vous';
                default: return userId;
            }
        }
        
        // ================ FONCTIONS POUR LA VISIONNEUSE D'IMAGES ===============
        
        // Ouvrir la visionneuse d'images
        function openImageViewer(imageUrl) {
            const imageViewer = document.getElementById('image-viewer');
            const img = document.getElementById('image-viewer-img');
            const loader = document.getElementById('image-loader');
            
            // Réinitialiser le zoom et la position
            resetImageViewer();
            
            // Afficher le loader
            loader.style.display = 'block';
            img.style.display = 'none';
            
            // Charger l'image
            img.onload = function() {
                loader.style.display = 'none';
                img.style.display = 'block';
            };
            
            img.onerror = function() {
                loader.style.display = 'none';
                showNotification("Erreur lors du chargement de l'image", "error");
                closeImageViewer();
            };
            
            // Définir la source de l'image
            img.src = imageUrl;
            
            // Afficher la visionneuse
            imageViewer.classList.add('active');
            
            // Vibration pour feedback tactile
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }
        }
        
        // Fermer la visionneuse d'images
        function closeImageViewer() {
            const imageViewer = document.getElementById('image-viewer');
            imageViewer.classList.remove('active');
            resetImageViewer();
        }
        
        // Réinitialiser le zoom et la position de l'image
        function resetImageViewer() {
            currentImageScale = 1;
            currentImagePosition = { x: 0, y: 0 };
            
            const img = document.getElementById('image-viewer-img');
            img.style.transform = 'scale(1)';
            img.classList.remove('zoomed');
        }
        
        // Zoomer sur l'image
        function zoomInImage() {
            zoomImage(currentImageScale + 0.5);
        }
        
        // Dézoomer l'image
        function zoomOutImage() {
            zoomImage(Math.max(0.5, currentImageScale - 0.5));
        }
        
        // Appliquer un niveau de zoom spécifique
        function zoomImage(scale) {
            const img = document.getElementById('image-viewer-img');
            
            // Limiter le zoom entre 0.5 et 5
            currentImageScale = Math.max(0.5, Math.min(5, scale));
            
            // Appliquer le zoom
            img.style.transform = `translate(${currentImagePosition.x}px, ${currentImagePosition.y}px) scale(${currentImageScale})`;
            
            // Ajouter/supprimer la classe zoomed
            if (currentImageScale > 1) {
                img.classList.add('zoomed');
            } else {
                img.classList.remove('zoomed');
                // Réinitialiser la position si on revient à l'échelle 1
                if (currentImageScale === 1) {
                    currentImagePosition = { x: 0, y: 0 };
                    img.style.transform = 'scale(1)';
                }
            }
        }
        
        // Télécharger l'image actuellement affichée
        function downloadViewerImage() {
            const img = document.getElementById('image-viewer-img');
            const imageUrl = img.src;
            
            // Créer un lien de téléchargement
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = 'image_' + Date.now() + '.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification("Téléchargement démarré", "success");
        }
        
        // ================ FONCTIONS POUR LA SÉLECTION ================
        
        // Fonction pour démarrer le mode de sélection des messages
        function startMessagesSelectionMode() {
            closeOptionsMenu();
            
            if (isSelectionMode) return;
            
            isSelectionMode = true;
            selectionModeType = 'messages';
            selectedMessages.clear();
            
            // Mettre à jour l'en-tête
            document.getElementById('header-action').innerHTML = '<div class="select-all-btn" style="color: var(--primary-color);">Tout</div>';
            document.getElementById('header-action').querySelector('.select-all-btn').addEventListener('click', selectAllMessages);
            
            // Activer le menu d'actions
            document.getElementById('message-actions').classList.add('active');
            
            // Désactiver la saisie de message pour le mode sélection de messages
            document.getElementById('chat-input').disabled = true;
            document.getElementById('send-button').disabled = true;
        }
        
        // Fonction pour basculer la sélection d'un élément
        function toggleItemSelection(item, itemId) {
            if (!isSelectionMode) return;
            
            // Obtenir l'ID de l'élément s'il n'est pas fourni
            if (!itemId) {
                itemId = item.getAttribute('data-id');
            }
            
            if (selectedItems.has(itemId)) {
                selectedItems.delete(itemId);
                item.classList.remove('selected');
            } else {
                selectedItems.add(itemId);
                item.classList.add('selected');
            }
            
            updateSelectionCount();
        }
        
        // Fonction pour sélectionner/désélectionner un message
        function toggleMessageSelection(message) {
            var messageId = message.getAttribute('data-id');
            
            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId);
                message.classList.remove('selected');
            } else {
                selectedMessages.add(messageId);
                message.classList.add('selected');
            }
            
            updateSelectionCount();
        }
        
        // Fonction pour mettre à jour le compteur de sélection
        function updateSelectionCount() {
            var count = selectionModeType === 'messages' ? selectedMessages.size : selectedItems.size;
            
            // Mise à jour du compteur dans la barre d'action
            if (selectionModeType === 'conversations') {
                document.getElementById('selection-action-count').textContent = 
                    count === 0 ? 'Aucune sélection' : 
                    count === 1 ? '1 sélectionné' : 
                    count + ' sélectionnés';
            } else {
                document.getElementById('selected-count').textContent = 
                    count === 0 ? 'Aucune sélection' : 
                    count === 1 ? '1 sélectionné' : 
                    count + ' sélectionnés';
            }
            
            // Sortir du mode sélection si aucun élément n'est sélectionné et après un délai
            if (count === 0 && isSelectionMode) {
                setTimeout(() => {
                    if ((selectionModeType === 'messages' && selectedMessages.size === 0) ||
                        (selectionModeType === 'conversations' && selectedItems.size === 0)) {
                        exitSelectionMode();
                    }
                }, 200);
            }
        }
        
        // Fonction pour quitter le mode de sélection
        function exitSelectionMode(type) {
            if (!isSelectionMode) return;
            
            if (!type) type = selectionModeType;
            
            isSelectionMode = false;
            
            // Masquer la barre d'action
            document.getElementById('selection-action-bar').classList.remove('active');
            
            if (type === 'messages') {
                // Réinitialiser les sélections de messages
                selectedMessages.clear();
                document.querySelectorAll('.message.selected').forEach(msg => {
                    msg.classList.remove('selected');
                });
                
                // Fermer le menu des actions de messages
                document.getElementById('message-actions').classList.remove('active');
                
                // Réactiver la saisie
                document.getElementById('chat-input').disabled = false;
                document.getElementById('send-button').disabled = false;
                
                // Restaurer l'en-tête de chat
                document.getElementById('header-title').innerText = currentContact;
                document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
                
                // Réattacher l'événement d'options
                document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            } else {
                // Réinitialiser les sélections de conversations
                selectedItems.clear();
                document.querySelectorAll('.chat-item.selected, .user-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Restaurer l'en-tête
                document.getElementById('header-title').innerText = currentSection.charAt(0).toUpperCase() + currentSection.slice(1);
                document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
                
                // Réattacher l'événement d'options
                document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            }
            
            selectionModeType = '';
        }
        
        // Fonction pour sélectionner tous les messages
        function selectAllMessages() {
            var messages = document.querySelectorAll('.message');
            
            // Si tous les messages sont déjà sélectionnés, désélectionner tous
            const allSelected = selectedMessages.size === messages.length;
            
            if (allSelected) {
                // Désélectionner tous les messages
                selectedMessages.clear();
                messages.forEach(msg => {
                    msg.classList.remove('selected');
                });
            } else {
                // Sélectionner tous les messages
                messages.forEach(msg => {
                    const messageId = msg.getAttribute('data-id');
                    selectedMessages.add(messageId);
                    msg.classList.add('selected');
                });
            }
            
            updateSelectionCount();
        }
        
        // ================ FONCTIONS POUR LES ACTIONS ================
        
        // Basculer entre bloquer/débloquer un utilisateur
        function blockUnblockUser() {
            const userId = document.querySelector('.chat-item[data-id="' + currentDiscussionId + '"]')?.getAttribute('data-user-id');
            
            if (!userId) return;
            
            if (blockedUsers.has(userId)) {
                unblockUser();
            } else {
                blockUser(userId);
            }
        }
        
        // Bloquer un utilisateur
        function blockUser(userId) {
            if (!userId) return;
            
            blockedUsers.add(userId);
            closeOptionsMenu();
            
            // Mettre à jour l'interface
            document.getElementById('block-banner').classList.add('active');
            
            // Mettre à jour l'option dans le menu
            updateBlockUnblockOption();
            
            // Mettre à jour l'aperçu de la conversation
            updateChatUI("Utilisateur bloqué");
            
            // Ajouter la classe blocked à la conversation
            var chatItems = document.querySelectorAll('.chat-item');
            for (var i = 0; i < chatItems.length; i++) {
                if (chatItems[i].getAttribute('data-user-id') === userId) {
                    chatItems[i].classList.add('blocked');
                    chatItems[i].querySelector('.item-subtitle').textContent = "Utilisateur bloqué";
                    break;
                }
            }
            
            // Sauvegarder les utilisateurs bloqués dans le localStorage
            saveBlockedUsers();
        }
        
        // Débloquer un utilisateur
        function unblockUser() {
            const userId = document.querySelector('.chat-item[data-id="' + currentDiscussionId + '"]')?.getAttribute('data-user-id');
            
            if (!userId || !blockedUsers.has(userId)) return;
            
            blockedUsers.delete(userId);
            
            // Mettre à jour l'interface
            document.getElementById('block-banner').classList.remove('active');
            
            // Mettre à jour l'option dans le menu
            updateBlockUnblockOption();
            
            // Mettre à jour l'aperçu de la conversation
            updateChatUI("Utilisateur débloqué");
            
            // Retirer la classe blocked de la conversation
            var chatItems = document.querySelectorAll('.chat-item');
            for (var i = 0; i < chatItems.length; i++) {
                if (chatItems[i].getAttribute('data-user-id') === userId) {
                    chatItems[i].classList.remove('blocked');
                    
                    // Recharger le dernier message
                    const lastMessageElement = chatItems[i].querySelector('.item-subtitle');
                    if (lastMessageElement) {
                        lastMessageElement.textContent = "Chargement...";
                        
                        // Récupérer le dernier message
                        getLastMessage(currentDiscussionId).then(lastMessage => {
                            if (lastMessage) {
                                lastMessageElement.textContent = lastMessage.text || "Image";
                            } else {
                                lastMessageElement.textContent = "Aucun message";
                            }
                        });
                    }
                    break;
                }
            }
            
            // Sauvegarder les utilisateurs bloqués dans le localStorage
            saveBlockedUsers();
        }
        
        // Sauvegarder les utilisateurs bloqués dans le localStorage
        function saveBlockedUsers() {
            localStorage.setItem('ichatBlockedUsers', JSON.stringify(Array.from(blockedUsers)));
        }
        
        // Récupérer le dernier message d'une discussion
        async function getLastMessage(discussionId) {
            if (!discussionId) return null;
            
            try {
                // Déterminer le type de discussion
                const discussionType = document.querySelector(`.chat-item[data-id="${discussionId}"]`)?.getAttribute('data-type') || 'private';
                
                // Récupérer les messages de la discussion
                let messagesRef;
                if (discussionType === 'group') {
                    messagesRef = collection(db, "groups", discussionId, "messages");
                } else {
                    messagesRef = collection(db, "discussions", discussionId, "messages");
                }
                
                const q = query(messagesRef, orderBy("createdAt", "desc"), limit(1));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    return null;
                }
                
                return querySnapshot.docs[0].data();
            } catch (error) {
                return null;
            }
        }
        
        // Mettre à jour l'option de blocage/déblocage dans le menu
        function updateBlockUnblockOption() {
            const userId = document.querySelector('.chat-item[data-id="' + currentDiscussionId + '"]')?.getAttribute('data-user-id');
            
            if (!userId) return;
            
            var blockOption = document.getElementById('block-option');
            var blockIcon = blockOption.querySelector('.option-icon i');
            var blockLabel = blockOption.querySelector('.option-label');
            
            if (blockedUsers.has(userId)) {
                blockIcon.className = 'fas fa-unlock';
                blockLabel.textContent = 'Débloquer cette personne';
            } else {
                blockIcon.className = 'fas fa-ban';
                blockLabel.textContent = 'Bloquer cette personne';
            }
        }
        
        // Effacer une conversation
        async function clearConversation() {
            if (!currentDiscussionId) return;
            
            try {
                // Afficher une boite de dialogue de confirmation
                document.getElementById('confirmation-text').textContent = 
                    'Êtes-vous sûr de vouloir effacer tous les messages de cette conversation ?';
                
                document.getElementById('confirmation-confirm').onclick = async function() {
                    closeConfirmationDialog();
                    
                    // Afficher un indicateur de chargement
                    const messagesContainer = document.getElementById('chat-messages');
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--inactive-text);">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                            <div style="margin-top: 10px;">Suppression des messages...</div>
                        </div>
                    `;
                    
                    try {
                        // Déterminer le chemin de la collection de messages
                        let messagesRef;
                        
                        if (currentDiscussionType === 'group') {
                            messagesRef = collection(db, "groups", currentDiscussionId, "messages");
                        } else {
                            messagesRef = collection(db, "discussions", currentDiscussionId, "messages");
                        }
                        
                        // Récupérer tous les messages
                        const messagesSnapshot = await getDocs(messagesRef);
                        
                        // Supprimer chaque message
                        for (const doc of messagesSnapshot.docs) {
                            await deleteDoc(doc.ref);
                        }
                        
                        // Mettre à jour l'aperçu de la conversation
                        updateChatUI("Conversation effacée");
                        
                        showNotification("Conversation effacée avec succès", "success");
                        
                        // Les messages seront automatiquement mis à jour grâce à l'écouteur onSnapshot
                    } catch (error) {
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                                <i class="fas fa-exclamation-circle" style="font-size: 24px;"></i>
                                <div style="margin-top: 10px;">Erreur lors de la suppression des messages</div>
                            </div>
                        `;
                        showNotification("Erreur lors de l'effacement de la conversation", "error");
                    }
                };
                
                // Afficher la boite de dialogue
                document.getElementById('confirmation-dialog').classList.add('active');
                document.getElementById('overlay').classList.add('active');
                
                // Fermer le menu d'options
                closeOptionsMenu();
            } catch (error) {
                showNotification("Erreur lors de la préparation de l'effacement", "error");
                closeOptionsMenu();
            }
        }
        
        // Mettre à jour l'interface après une action sur une discussion
        function updateChatUI(statusMessage) {
            if (!currentDiscussionId) return;
            
            try {
                // Mettre à jour l'aperçu dans la liste des conversations
                const chatItems = document.querySelectorAll('.chat-item');
                for (let i = 0; i < chatItems.length; i++) {
                    if (chatItems[i].getAttribute('data-id') === currentDiscussionId) {
                        const subtitle = chatItems[i].querySelector('.item-subtitle');
                        if (subtitle) {
                            subtitle.innerHTML = statusMessage;
                        }
                        
                        // Mettre à jour l'heure
                        const time = chatItems[i].querySelector('.item-time');
                        if (time) {
                            time.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        }
                        
                        break;
                    }
                }
            } catch (error) {
                showNotification("Erreur lors de la mise à jour de l'interface", "error");
            }
        }
        
        // Supprimer les éléments sélectionnés (discussions ou messages)
        function deleteSelectedItems() {
            if (selectionModeType === 'conversations') {
                showDeleteConversationsConfirmation();
            } else if (selectionModeType === 'messages') {
                showDeleteMessageOptions();
            }
        }
        
        // Afficher la confirmation pour supprimer les conversations sélectionnées
        function showDeleteConversationsConfirmation() {
            if (selectedItems.size === 0) return;
            
            document.getElementById('confirmation-text').textContent = 
                `Êtes-vous sûr de vouloir supprimer ${selectedItems.size === 1 ? 'cette conversation' : 'ces ' + selectedItems.size + ' conversations'} ?`;
            
            document.getElementById('confirmation-confirm').onclick = function() {
                deleteSelectedConversations();
                closeConfirmationDialog();
            };
            
            document.getElementById('confirmation-dialog').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // Supprimer les conversations sélectionnées
        async function deleteSelectedConversations() {
            if (selectedItems.size === 0) return;
            
            try {
                const itemsToDelete = Array.from(selectedItems);
                let successCount = 0;
                let errorCount = 0;
                
                // Pour chaque conversation sélectionnée
                for (const discussionId of itemsToDelete) {
                    try {
                        // Récupérer le type de discussion
                        const chatItem = document.querySelector(`.chat-item[data-id="${discussionId}"]`);
                        const discussionType = chatItem?.getAttribute('data-type') || 'private';
                        
                        // Ajouter l'animation de suppression
                        if (chatItem) {
                            chatItem.classList.add('deleting');
                        }
                        
                        // Déterminer la référence à la collection de messages
                        let messagesRef;
                        let discussionRef;
                        
                        if (discussionType === 'group') {
                            messagesRef = collection(db, "groups", discussionId, "messages");
                            
                            // Récupérer tous les messages
                            const messagesSnapshot = await getDocs(messagesRef);
                            
                            // Supprimer chaque message
                            for (const doc of messagesSnapshot.docs) {
                                await deleteDoc(doc.ref);
                            }
                            
                            successCount++;
                        } else {
                            // Pour les discussions privées
                            messagesRef = collection(db, "discussions", discussionId, "messages");
                            discussionRef = doc(db, "discussions", discussionId);
                            
                            // Récupérer tous les messages
                            const messagesSnapshot = await getDocs(messagesRef);
                            
                            // Supprimer chaque message
                            for (const doc of messagesSnapshot.docs) {
                                await deleteDoc(doc.ref);
                            }
                            
                            // Supprimer la discussion elle-même
                            await deleteDoc(discussionRef);
                            
                            successCount++;
                        }
                    } catch (error) {
                        errorCount++;
                    }
                }
                
                // Rafraîchir la liste des conversations après un court délai pour l'animation
                setTimeout(() => {
                    loadConversations();
                    
                    // Sortir du mode sélection
                    exitSelectionMode();
                    
                    // Afficher un message de succès/erreur
                    if (errorCount === 0) {
                        showNotification(`${successCount} conversation(s) supprimée(s) avec succès`, "success");
                    } else if (successCount === 0) {
                        showNotification(`Erreur: impossible de supprimer les conversations`, "error");
                    } else {
                        showNotification(`${successCount} conversation(s) supprimée(s), ${errorCount} échec(s)`, "info");
                    }
                }, 500);
                
            } catch (error) {
                showNotification("Erreur lors de la suppression des conversations", "error");
                exitSelectionMode();
            }
        }
        
        // Afficher le dialogue de suppression des messages avec options
        function showDeleteMessageOptions() {
            if (selectedMessages.size === 0) return;
            
            // Réinitialiser les options
            selectedDeleteOption = 'for-me';
            document.getElementById('delete-for-me').classList.add('selected');
            document.getElementById('delete-for-all').classList.remove('selected');
            
            // Afficher le dialogue
            document.getElementById('delete-message-dialog').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // Sélectionner une option de suppression
        function selectDeleteOption(option) {
            // Réinitialiser les options
            document.getElementById('delete-for-me').classList.remove('selected');
            document.getElementById('delete-for-all').classList.remove('selected');
            
            // Sélectionner l'option cliquée
            if (option === 'for-me') {
                document.getElementById('delete-for-me').classList.add('selected');
            } else {
                document.getElementById('delete-for-all').classList.add('selected');
            }
            
            selectedDeleteOption = option;
        }
        
        // Fermer le dialogue de suppression des messages
        function closeDeleteMessageDialog() {
            document.getElementById('delete-message-dialog').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Confirmer la suppression des messages
        async function confirmDeleteMessages() {
            if (selectedMessages.size === 0 || !currentDiscussionId) return;
            
            // Fermer le dialogue avant l'animation
            closeDeleteMessageDialog();
            
            // Tableau pour stocker les IDs des messages à supprimer
            const messagesToDelete = Array.from(selectedMessages);
            
            try {
                // Déterminer la collection de messages
                let messagesCollection;
                if (currentDiscussionType === 'group') {
                    messagesCollection = collection(db, "groups", currentDiscussionId, "messages");
                } else {
                    messagesCollection = collection(db, "discussions", currentDiscussionId, "messages");
                }
                
                // Animation de désintégration pour les messages
                const messageElements = [];
                for (const messageId of messagesToDelete) {
                    const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
                    if (messageElement) {
                        messageElements.push(messageElement);
                        messageElement.classList.add('disintegrating');
                    }
                }
                
                // Attendre la fin de l'animation avant de supprimer les messages
                setTimeout(async () => {
                    try {
                        // Pour chaque message à supprimer
                        for (const messageId of messagesToDelete) {
                            // Si c'est juste "pour moi", on n'a pas besoin de faire de requête Firestore
                            // car les messages seront rechargés automatiquement via l'écouteur onSnapshot
                            if (selectedDeleteOption === 'for-all') {
                                const messageRef = doc(messagesCollection, messageId);
                                await deleteDoc(messageRef);
                            }
                        }
                        
                        // Sortir du mode sélection
                        exitSelectionMode();
                        
                        // Afficher une notification de succès
                        showNotification(
                            selectedDeleteOption === 'for-me' ? 
                            `${messagesToDelete.length} message(s) supprimé(s) pour vous` : 
                            `${messagesToDelete.length} message(s) supprimé(s) pour tout le monde`,
                            "success"
                        );
                    } catch (error) {
                        showNotification("Erreur lors de la suppression des messages", "error");
                    }
                }, 800); // Attendre la fin de l'animation
            } catch (error) {
                showNotification("Erreur lors de la suppression des messages", "error");
                exitSelectionMode();
            }
        }
        
        // Ouvrir le dialogue de transfert de messages
        async function forwardSelectedMessages() {
            if (selectedMessages.size === 0 || !currentDiscussionId) return;
            
            try {
                // Déterminer la collection de messages
                let messagesCollection;
                if (currentDiscussionType === 'group') {
                    messagesCollection = collection(db, "groups", currentDiscussionId, "messages");
                } else {
                    messagesCollection = collection(db, "discussions", currentDiscussionId, "messages");
                }
                
                // Collecter les messages sélectionnés
                messagesForForward = [];
                for (const messageId of selectedMessages) {
                    try {
                        const messageDoc = await getDoc(doc(messagesCollection, messageId));
                        if (messageDoc.exists()) {
                            messagesForForward.push({
                                id: messageId,
                                ...messageDoc.data()
                            });
                        }
                    } catch (error) {
                        // Ignorer les erreurs individuelles
                    }
                }
                
                if (messagesForForward.length === 0) {
                    showNotification("Aucun message à transférer", "error");
                    return;
                }
                
                // Mettre à jour le badge du compteur
                document.getElementById('forward-count-badge').textContent = messagesForForward.length;
                
                // Remplir la liste des contacts
                const contactsList = document.getElementById('forward-contacts-list');
                contactsList.innerHTML = '';
                
                // Dans cette version simplifiée, nous n'avons que Betforce
                const contactItem = document.createElement('div');
                contactItem.className = 'chat-item';
                contactItem.onclick = function() { forwardMessagesTo("Betforce", "Betforce", "group"); };
                
                contactItem.innerHTML = `
                    <div class="group-pic">
                        <i class="fas fa-users" style="color: white;"></i>
                    </div>
                    <div class="item-content">
                        <div class="item-title">Betforce</div>
                    </div>
                `;
                
                contactsList.appendChild(contactItem);
                
                // Afficher le dialogue
                document.getElementById('forward-dialog').classList.add('active');
            } catch (error) {
                showNotification("Erreur lors de la préparation du transfert", "error");
            }
        }
        
        // Fermer le dialogue de transfert
        function closeForwardDialog() {
            document.getElementById('forward-dialog').classList.remove('active');
            messagesForForward = [];
        }
        
        // Transférer les messages à un contact spécifique
        function forwardMessagesTo(contactId, contactName, contactType) {
            if (messagesForForward.length === 0) return;
            
            targetContactForForward = {
                id: contactId,
                name: contactName,
                type: contactType
            };
            
            // Configurer la boîte de dialogue de confirmation
            document.getElementById('confirmation-text').textContent = 
                `Transférer ${messagesForForward.length === 1 ? 'ce message' : 'ces ' + messagesForForward.length + ' messages'} à ${contactName} ?`;
            
            document.getElementById('confirmation-confirm').onclick = function() {
                executeForwardMessages();
                closeConfirmationDialog();
            };
            
            // Afficher la boîte de dialogue de confirmation
            document.getElementById('confirmation-dialog').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // Fermer la boîte de dialogue de confirmation
        function closeConfirmationDialog() {
            document.getElementById('confirmation-dialog').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Fermer la boîte de dialogue de suppression de compte
        function closeDeleteAccountDialog() {
            document.getElementById('delete-account-dialog').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Exécuter l'action de transfert
        async function executeForwardMessages() {
            // S'assurer que les paramètres nécessaires sont définis
            if (!targetContactForForward || messagesForForward.length === 0) return;
            
            try {
                // Déterminer la collection de messages cible
                let targetMessagesCollection;
                if (targetContactForForward.type === 'group') {
                    targetMessagesCollection = collection(db, "groups", targetContactForForward.id, "messages");
                } else {
                    targetMessagesCollection = collection(db, "discussions", targetContactForForward.id, "messages");
                }
                
                // Transférer chaque message
                for (const msg of messagesForForward) {
                    const newMessageData = {
                        senderId: currentUser.uid,
                        createdAt: serverTimestamp(),
                        status: 'sent',
                        type: msg.type || 'text',
                        forwarded: true,
                        originalFrom: msg.senderId === currentUser.uid ? 'moi' : await getDisplayNameFromId(msg.senderId)
                    };
                    
                    // Transférer le texte ou l'image selon le type
                    if (msg.text) {
                        newMessageData.text = msg.text;
                    }
                    
                    if (msg.image) {
                        newMessageData.image = msg.image;
                    }
                    
                    // Ajouter le message transféré
                    await addDoc(targetMessagesCollection, newMessageData);
                }
                
                // Mettre à jour la conversation cible (dernier message, heure, etc.)
                let targetConversationRef;
                if (targetContactForForward.type === 'group') {
                    targetConversationRef = doc(db, "groups", targetContactForForward.id);
                } else {
                    targetConversationRef = doc(db, "discussions", targetContactForForward.id);
                }
                
                // Mettre à jour avec le dernier message transféré
                const lastMsg = messagesForForward[messagesForForward.length - 1];
                await updateDoc(targetConversationRef, {
                    lastMessage: lastMsg.text || "Image",
                    lastMessageTime: serverTimestamp(),
                    lastSenderId: currentUser.uid
                });
                
                // Fermer le dialogue de transfert
                closeForwardDialog();
                
                // Quitter le mode sélection
                exitSelectionMode();
                
                // Afficher une notification de succès
                showNotification(
                    `${messagesForForward.length} message(s) transféré(s) à ${targetContactForForward.name}`,
                    "success"
                );
                
            } catch (error) {
                showNotification("Erreur lors du transfert des messages", "error");
                
                // Fermer le dialogue de transfert
                closeForwardDialog();
                
                // Sortir du mode sélection
                exitSelectionMode();
            }
        }
        
        // Copier les messages sélectionnés dans le presse-papiers
        async function copySelectedMessages() {
            if (selectedMessages.size === 0 || !currentDiscussionId) return;
            
            try {
                // Déterminer la collection de messages
                let messagesCollection;
                if (currentDiscussionType === 'group') {
                    messagesCollection = collection(db, "groups", currentDiscussionId, "messages");
                } else {
                    messagesCollection = collection(db, "discussions", currentDiscussionId, "messages");
                }
                
                // Collecter les textes des messages sélectionnés
                let textToCopy = '';
                
                // Pour chaque message dans l'ordre d'affichage
                const messageElements = document.querySelectorAll('.message');
                for (const element of messageElements) {
                    const messageId = element.getAttribute('data-id');
                    if (selectedMessages.has(messageId)) {
                        try {
                            const messageDoc = await getDoc(doc(messagesCollection, messageId));
                            if (messageDoc.exists()) {
                                const messageData = messageDoc.data();
                                const sender = messageData.senderId === currentUser.uid ? 'Vous' : 
                                    currentDiscussionType === 'group' ? await getDisplayNameFromId(messageData.senderId) : currentContact;
                                
                                if (messageData.text) {
                                    textToCopy += `[${sender}]: ${messageData.text}\n`;
                                } else if (messageData.type === 'image') {
                                    textToCopy += `[${sender}]: [Image]\n`;
                                }
                            }
                        } catch (error) {
                            // Ignorer les erreurs individuelles
                        }
                    }
                }
                
                if (textToCopy === '') {
                    showNotification("Aucun texte à copier", "error");
                    return;
                }
                
                // Tentative de copie dans le presse-papiers
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(textToCopy);
                    showNotification("Texte copié dans le presse-papiers", "success");
                    exitSelectionMode();
                } else {
                    // Méthode alternative pour les contextes non sécurisés
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-999999px";
                    textArea.style.top = "-999999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            showNotification("Texte copié dans le presse-papiers", "success");
                        } else {
                            showNotification("Échec de la copie dans le presse-papiers", "error");
                        }
                        exitSelectionMode();
                    } catch (err) {
                        showNotification("Erreur lors de la copie", "error");
                    }
                    
                    document.body.removeChild(textArea);
                }
            } catch (error) {
                showNotification("Erreur lors de la copie des messages", "error");
            }
        }
        
        // Répondre au message sélectionné
        async function replyToSelectedMessage() {
            if (selectedMessages.size !== 1 || !currentDiscussionId) {
                showNotification("Sélectionnez un seul message pour répondre", "error");
                return;
            }
            
            try {
                // Récupérer l'ID du message sélectionné
                const messageId = Array.from(selectedMessages)[0];
                
                // Déterminer la collection de messages
                let messagesCollection;
                if (currentDiscussionType === 'group') {
                    messagesCollection = collection(db, "groups", currentDiscussionId, "messages");
                } else {
                    messagesCollection = collection(db, "discussions", currentDiscussionId, "messages");
                }
                
                // Récupérer les informations du message
                const messageDoc = await getDoc(doc(messagesCollection, messageId));
                if (messageDoc.exists()) {
                    const messageData = messageDoc.data();
                    
                    // Stocker la référence pour l'envoi
                    replyToMessage = {
                        id: messageId,
                        text: messageData.text,
                        senderId: messageData.senderId,
                        senderName: messageData.senderId === currentUser.uid ? 'Vous' : await getDisplayNameFromId(messageData.senderId)
                    };
                    
                    // Quitter le mode sélection
                    exitSelectionMode();
                    
                    // Focus sur l'input
                    document.getElementById('chat-input').focus();
                    
                    // Vibration pour feedback tactile
                    if (navigator.vibrate) {
                        navigator.vibrate([30, 50, 30]);
                    }
                    
                    // Montrer une notification
                    showNotification('Répondre au message...', 'info');
                }
            } catch (error) {
                showNotification("Erreur lors de la préparation de la réponse", "error");
            }
        }
        
        // Ouvrir l'interface de recherche dans les messages
        function searchInConversation() {
            if (!currentDiscussionId) return;
            closeOptionsMenu();
            
            // Afficher l'interface de recherche
            document.getElementById('search-overlay').classList.add('active');
            document.getElementById('message-search-input').focus();
        }
        
        // Fermer l'interface de recherche
        function closeSearchInterface() {
            document.getElementById('search-overlay').classList.remove('active');
            document.getElementById('message-search-input').value = '';
            document.getElementById('search-results').innerHTML = '<div class="no-results">Saisissez un terme à rechercher</div>';
        }
        
        // Rechercher dans les messages
        async function searchMessages() {
            const searchTerm = document.getElementById('message-search-input').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            
            if (searchTerm === '') {
                resultsContainer.innerHTML = '<div class="no-results">Saisissez un terme à rechercher</div>';
                return;
            }
            
            // Indiquer que la recherche est en cours
            resultsContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--inactive-text);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                    <div style="margin-top: 10px;">Recherche en cours...</div>
                </div>
            `;
            
            try {
                // Déterminer la collection de messages
                let messagesCollection;
                if (currentDiscussionType === 'group') {
                    messagesCollection = collection(db, "groups", currentDiscussionId, "messages");
                } else {
                    messagesCollection = collection(db, "discussions", currentDiscussionId, "messages");
                }
                
                // Récupérer tous les messages de la conversation
                const querySnapshot = await getDocs(query(messagesCollection, orderBy("createdAt", "desc")));
                
                if (querySnapshot.empty) {
                    resultsContainer.innerHTML = '<div class="no-results">Aucun message dans cette conversation</div>';
                    return;
                }
                
                // Rechercher le terme dans les messages
                const matchingMessages = [];
                
                for (const doc of querySnapshot.docs) {
                    const messageData = doc.data();
                    if (messageData.text && messageData.text.toLowerCase().includes(searchTerm)) {
                        matchingMessages.push({
                            id: doc.id,
                            ...messageData
                        });
                    }
                }
                
                if (matchingMessages.length === 0) {
                    resultsContainer.innerHTML = '<div class="no-results">Aucun résultat trouvé</div>';
                    return;
                }
                
                // Afficher les résultats
                resultsContainer.innerHTML = '';
                
                for (const msg of matchingMessages) {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    
                    // Mettre en surbrillance le terme recherché
                    let highlightedText = '';
                    if (msg.text) {
                        highlightedText = msg.text.replace(
                            new RegExp(searchTerm, 'gi'),
                            match => `<span class="search-highlight">${match}</span>`
                        );
                    }
                    
                    // Récupérer le nom de l'expéditeur
                    let senderName = 'Inconnu';
                    if (msg.senderId === currentUser.uid) {
                        senderName = 'Vous';
                    } else if (currentDiscussionType === 'group') {
                        senderName = await getDisplayNameFromId(msg.senderId);
                    } else {
                        senderName = currentContact;
                    }
                    
                    resultItem.innerHTML = `
                        <div class="search-result-text">${highlightedText}</div>
                        <div class="search-result-info">
                            <span>${senderName}</span>
                            <span>${formatTimestamp(msg.createdAt)}</span>
                        </div>
                    `;
                    
                    // Ajouter un gestionnaire de clic pour naviguer vers le message
                    resultItem.addEventListener('click', () => {
                        closeSearchInterface();
                        highlightMessage(msg.id);
                    });
                    
                    resultsContainer.appendChild(resultItem);
                }
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                        <i class="fas fa-exclamation-circle"></i>
                        <div style="margin-top: 10px;">Erreur lors de la recherche</div>
                    </div>
                `;
            }
        }
        
        // Mettre en évidence un message spécifique
        function highlightMessage(messageId) {
            setTimeout(() => {
                const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
                if (messageElement) {
                    // Faire défiler jusqu'au message
                    messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Mettre en évidence le message
                    messageElement.classList.add('selected');
                    
                    // Vibration pour feedback tactile
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                    
                    // Retirer la mise en évidence après quelques secondes
                    setTimeout(() => {
                        messageElement.classList.remove('selected');
                    }, 3000);
                } else {
                    showNotification("Message non trouvé", "error");
                }
            }, 300);
        }
        
        // ================ FONCTIONS POUR LES ATTACHEMENTS ================
        
        // Ouvrir le clavier emoji
        function openEmojiKeyboard() {
            var input = document.getElementById('chat-input');
            input.focus();
            // Simuler l'ouverture du clavier emoji natif
        }
        
        // Basculer le panneau d'attachements
        function toggleAttachments() {
            var extraButtons = document.getElementById('chat-extra-buttons');
            if (isAttachmentsOpen) {
                extraButtons.classList.remove('active');
            } else {
                extraButtons.classList.add('active');
            }
            isAttachmentsOpen = !isAttachmentsOpen;
        }
        
        // Sélectionner une image
        function selectImage() {
            document.getElementById('image-input').click();
            toggleAttachments();
        }
        
        // Sélectionner un fichier
        function selectFile() {
            // Simulation
            toggleAttachments();
            showNotification("La sélection de fichiers n'est pas disponible dans cette version.", "info");
        }
        
        // Sélectionner l'appareil photo
        function selectCamera() {
            // Simulation
            toggleAttachments();
            showNotification("L'accès à l'appareil photo n'est pas disponible dans cette version.", "info");
        }
        
        // Sélectionner la localisation
        function selectLocation() {
            // Simulation
            toggleAttachments();
            showNotification("Le partage de localisation n'est pas disponible dans cette version.", "info");
        }
        
        // Effacer l'aperçu d'image
        function clearImagePreview() {
            document.getElementById('image-preview').classList.remove('active');
            selectedImage = null;
            document.getElementById('preview-img').src = '';
        }
        
        // ================ FONCTIONS UI ================
        
        // Basculer le menu d'options selon la section active
        function toggleOptionsMenu() {
            var menuId;
            
            // Déterminer quel menu afficher selon le contexte
            if (currentContact && currentDiscussionId) {
                menuId = 'chat-options-menu';
            } else if (currentSection === 'messages') {
                menuId = 'messages-options-menu';
            } else {
                menuId = 'simple-options-menu';
            }
            
            var menu = document.getElementById(menuId);
            var overlay = document.getElementById('overlay');
            
            if (isOptionsMenuOpen) {
                menu.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                menu.classList.add('active');
                overlay.classList.add('active');
                
                // Mettre à jour l'option de blocage si on est dans un chat
                if (currentContact && currentDiscussionType === 'private') {
                    updateBlockUnblockOption();
                    document.getElementById('block-option').style.display = 'flex';
                } else {
                    // Masquer l'option de blocage pour les groupes
                    document.getElementById('block-option').style.display = 'none';
                }
            }
            
            isOptionsMenuOpen = !isOptionsMenuOpen;
        }
        
        // Fermer le menu d'options
        function closeOptionsMenu() {
            document.getElementById('simple-options-menu').classList.remove('active');
            document.getElementById('messages-options-menu').classList.remove('active');
            document.getElementById('chat-options-menu').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            isOptionsMenuOpen = false;
        }
        
        // Fermer tous les dialogues
        function closeAllDialogs() {
            closeOptionsMenu();
            closeDeleteMessageDialog();
            closeConfirmationDialog();
            closeDeleteAccountDialog();
            closeInstallGuide();
            closeForwardDialog();
            
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Changer le thème
        function changeTheme() {
            var randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);
            
            // Mettre à jour la couleur de l'interface
            changeAppColor(randomColor);
            
            closeOptionsMenu();
            showNotification("Thème modifié", "success");
        }
        
        // Montrer le guide d'installation
        function showInstallGuide() {
            closeOptionsMenu();
            document.getElementById('install-guide').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // Fermer le guide d'installation
        function closeInstallGuide() {
            document.getElementById('install-guide').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Montrer le dialogue de suppression de compte
        function showDeleteAccountConfirmation() {
            document.getElementById('delete-account-dialog').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // Notifier du lancement des pronostics (fonction simulée)
        function notifyLaunch() {
            showNotification("Vous serez alerté(e) du lancement des pronostics sportifs", "success");
            
            // Changer le texte du bouton
            document.getElementById('notify-launch-button').textContent = "Inscription confirmée";
            document.getElementById('notify-launch-button').disabled = true;
            
            // Vibration pour feedback tactile
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }
        }
        
        // ================ FONCTIONS POUR L'AFFICHAGE ================
        
        // Masquer l'écran de chargement
        function hideLoading() {
            const loadingScreen = document.getElementById('loading');
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }
        
        // Afficher l'écran de connexion
        function showLoginScreen() {
            hideLoading();
            
            // Animation d'apparition
            document.getElementById('auth-screen').style.opacity = '0';
            document.getElementById('auth-screen').style.display = 'flex';
            
            setTimeout(() => {
                document.getElementById('auth-screen').style.opacity = '1';
                document.getElementById('auth-screen').style.transition = 'opacity 0.5s ease';
            }, 10);
            
            // Pour permettre le défilement lors de l'inscription/connexion
            document.body.style.overflow = 'auto';
        }
        
        // Compléter le processus de connexion
        async function completeLogin() {
            hideLoading();
            
            // Récupérer les données utilisateur
            currentUserData = await getUserData(currentUser.uid);
            
            // Vérifier si l'utilisateur est administrateur
            if (currentUserData && currentUserData.statut === 'admin') {
                isAdmin = true;
            }
            
            // Charger les utilisateurs bloqués
            loadBlockedUsers();
            
            // Animer la transition
            document.getElementById('auth-screen').style.opacity = '0';
            document.getElementById('auth-screen').style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                document.getElementById('auth-screen').style.display = 'none';
            }, 500);
            
            // Animation d'apparition pour l'application principale
            setTimeout(() => {
                document.getElementById('tabbar').style.opacity = '0';
                document.getElementById('tabbar').style.display = 'flex';
                
                document.querySelector('.header').style.opacity = '0';
                document.querySelector('.header').style.display = 'flex';
                
                document.querySelector('.content').style.opacity = '0';
                document.querySelector('.content').style.display = 'block';
                
                setTimeout(() => {
                    document.getElementById('tabbar').style.opacity = '1';
                    document.getElementById('tabbar').style.transition = 'opacity 0.5s ease';
                    
                    document.querySelector('.header').style.opacity = '1';
                    document.querySelector('.header').style.transition = 'opacity 0.5s ease';
                    
                    document.querySelector('.content').style.opacity = '1';
                                        document.querySelector('.content').style.transition = 'opacity 0.5s ease';
                }, 10);
                
                // Remplir les données du profil
                document.getElementById('profile-name-text').textContent = currentUserData?.displayName || currentUser.email.split('@')[0];
                document.getElementById('profile-email').textContent = currentUser.email;
                
                // Afficher le badge admin si nécessaire
                if (isAdmin) {
                    document.getElementById('admin-badge').style.display = 'inline-block';
                } else {
                    document.getElementById('admin-badge').style.display = 'none';
                }
                
                // Forcer le défilement pour s'assurer que le contenu est correctement positionné
                document.body.style.overflow = 'hidden';
                
                // Charger les conversations
                isLoggedIn = true;
                loadConversations();
                
                // Auto-ouvrir Betforce
                setTimeout(() => {
                    openChat("Betforce", null, "Betforce", "group");
                }, 300);
            }, 500);
        }
        
        // Charger les utilisateurs bloqués
        function loadBlockedUsers() {
            try {
                const blockedListString = localStorage.getItem('ichatBlockedUsers');
                if (blockedListString) {
                    const blockedList = JSON.parse(blockedListString);
                    blockedUsers = new Set(blockedList);
                }
            } catch (error) {
                blockedUsers = new Set();
            }
        }
        
        // ================ INITIALISATION DE L'APPLICATION ================
        
        // Fonction d'initialisation principale
        function initApp() {
            // Vérifier les préférences utilisateur stockées localement
            loadSavedPreferences();
            
            // Configurer la détection du mode sombre
            setupDarkMode();
            
            // Configurer les événements d'interface
            setupUIEvents();
            
            // Configurer les événements d'authentification
            setupAuthEvents();
            
            // Configurer la surveillance de la connexion internet
            setupConnectionMonitoring();
            
            // Vérifier l'état d'authentification de l'utilisateur
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // L'utilisateur est connecté
                    currentUser = user;
                    
                    // Afficher l'écran de chargement si nécessaire
                    document.getElementById('loading').style.display = 'flex';
                    
                    try {
                        // Récupérer les données utilisateur
                        await completeLogin();
                    } catch (error) {
                        hideLoading();
                        showLoginScreen();
                    }
                } else {
                    // L'utilisateur n'est pas connecté
                    hideLoading();
                    showLoginScreen();
                }
            });
        }
        
        // Charger les préférences sauvegardées
        function loadSavedPreferences() {
            try {
                // Charger la couleur personnalisée
                const savedColor = localStorage.getItem('ichatColor');
                if (savedColor) {
                    document.getElementById('color-picker').value = savedColor;
                    changeAppColor(savedColor);
                }
                
                // Charger la préférence de mode sombre
                const darkMode = localStorage.getItem('ichatDarkMode');
                if (darkMode === 'false') {
                    document.documentElement.classList.remove('dark');
                    document.getElementById('dark-toggle').checked = false;
                    document.documentElement.style.setProperty('--chat-sent-bg', '#5D5CDE');
                } else if (darkMode === 'true') {
                    document.documentElement.classList.add('dark');
                    document.getElementById('dark-toggle').checked = true;
                    document.documentElement.style.setProperty('--chat-sent-bg', document.documentElement.style.getPropertyValue('--primary-color') || '#F7DC6F');
                }
            } catch (error) {
                // Ignorer les erreurs de chargement des préférences
            }
        }
        
        // Démarrer l'application
        initApp();
    </script>
</body>
</html>
