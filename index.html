<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iChat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <style>
        /* Variables de couleurs */
        :root {
            --primary-color: #F7DC6F; /* Jaune comme couleur principale de l'interface */
            --text-color: #000000;
            --bg-color: #ffffff;
            --border-color: #dddfe2;
            --secondary-color: #f0f2f5;
            --chat-sent-bg: #5D5CDE; /* Violet pour les bulles de messages envoyés */
            --chat-sent-text: #ffffff;
            --chat-received-bg: #f0f2f5;
            --selection-color: rgba(247, 220, 111, 0.2);
            --action-menu-bg: rgba(0, 0, 0, 0.9);
            --action-menu-text: #ffffff;
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(255, 255, 255, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.1);
            --group-icon-bg: #4CAF50;
            --danger-color: #ff4842;
            --success-color: #4caf50;
            --input-bg: #f0f2f5;
            --input-placeholder: #8e8e93;
            --button-text: #000000;
            --inactive-text: #8e8e93;
            --link-color: #007aff;
            --admin-badge-bg: #5D5CDE;
            --admin-badge-text: white;
        }
        
        /* Mode sombre par défaut */
        .dark {
            --bg-color: #181818;
            --text-color: #ffffff;
            --border-color: #3e4042;
            --secondary-color: #2c2c2c;
            --chat-received-bg: #2c2c2c;
            --chat-sent-bg: #F7DC6F; /* Jaune plus visible en mode sombre */
            --chat-sent-text: #000000; /* Texte noir pour contraste avec fond jaune */
            --selection-color: rgba(247, 220, 111, 0.3);
            --action-menu-bg: rgba(60, 60, 60, 0.95);
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(40, 40, 40, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.3);
            --group-icon-bg: #388E3C;
            --danger-color: #ff6b6b;
            --success-color: #66bb6a;
            --input-bg: #2c2c2c;
            --input-placeholder: #6c6c6c;
            --link-color: #2196F3;
            --admin-badge-bg: #7571F9;
            --admin-badge-text: white;
        }
        
        /* Reset de base */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            user-select: none; /* Rendre aucune écriture sélectionnable */
            -webkit-user-select: none; /* Pour Safari */
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            overflow: hidden;
            font-weight: 500; /* Police légèrement plus grasse style iOS */
            letter-spacing: -0.2px; /* Espacement légèrement réduit style iOS */
        }
        
        /* En-tête fixe */
        .header {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 10;
        }
        
        .header-title {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary-color);
        }
        
        .back-button {
            color: var(--primary-color);
            padding: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* Contenu principal */
        .content {
            position: fixed;
            top: 50px; /* Hauteur de l'en-tête */
            bottom: 60px; /* Hauteur de la barre d'onglets */
            left: 0;
            right: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background-color: var(--bg-color);
        }
        
        /* Barre d'onglets fixe */
        .tabbar {
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            z-index: 10;
        }
        
        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #8e8e93;
            font-size: 10px;
            text-decoration: none;
            padding: 8px 0;
            transition: transform 0.15s ease, color 0.2s ease;
        }
        
        .tab:active {
            transform: scale(0.95);
        }
        
        .tab.active {
            color: var(--primary-color);
        }
        
        .tab-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }
        
        /* Sections de contenu */
        .section {
            padding: 10px 0;
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* Profil et éléments utilisateur */
        .profile-pic {
            width: 50px;
            height: 50px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        
        .group-pic {
            width: 50px;
            height: 50px;
            background-color: var(--group-icon-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        
        .chat-item, .user-item {
            display: flex;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s ease, transform 0.3s ease, opacity 0.4s ease;
        }
        
        .chat-item:active, .user-item:active {
            background-color: var(--selection-color);
        }
        
        .chat-item.selected, .user-item.selected {
            background-color: var(--selection-color);
        }
        
        .chat-item.blocked {
            background-color: rgba(255, 107, 107, 0.1);
        }
        
        .chat-item.blocked .item-subtitle {
            color: var(--blocked-color);
            font-style: italic;
        }
        
        .item-content {
            flex: 1;
        }
        
        .item-title {
            font-weight: bold;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }
        
        .item-subtitle {
            color: #6b7280;
            font-size: 14px;
        }
        
        .item-time {
            color: #6b7280;
            font-size: 12px;
        }
        
        /* Badge Admin */
        .admin-badge {
            display: inline-block;
            background-color: var(--admin-badge-bg);
            color: var(--admin-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        /* Formulaires et entrées */
        .search-container {
            padding: 10px 16px;
            position: sticky;
            top: 0;
            background-color: var(--bg-color);
            z-index: 5;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 16px;
            border-radius: 18px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            color: var(--text-color);
        }
        
        /* Écran de chargement */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        
        /* Animation ballon de football avec Font Awesome */
        .football-spinner {
            font-size: 60px;
            color: var(--primary-color);
            animation: bounce 2s infinite, spin 3s linear infinite;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Paramètres */
        .settings-container {
            padding: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .setting-icon {
            width: 36px;
            height: 36px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .setting-label {
            font-weight: 500;
        }
        
        .button {
            background-color: var(--primary-color);
            color: black;
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            transition: transform 0.15s ease, opacity 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .button.danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .button:after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            20% {
                transform: scale(25, 25);
                opacity: 0.3;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }
        
        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        /* Notification dot */
        .badge {
            position: relative;
            display: inline-block;
        }
        
        .dot {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background-color: #f03d25;
            border-radius: 50%;
        }

        /* Notification icône */
        .notification-icon {
            color: var(--primary-color);
            font-size: 18px;
            cursor: pointer;
        }
        
        /* Interface de chat */
        .chat-section {
            display: none;
            position: fixed;
            top: 50px;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            z-index: 5;
        }
        
        .chat-messages-container {
            position: absolute;
            top: 0;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow-y: auto;
            background-color: var(--secondary-color);
            -webkit-overflow-scrolling: touch;
            padding: 15px;
        }
        
        .chat-messages {
            width: 100%;
            display: flex;
            flex-direction: column;
            min-height: 100%;
            justify-content: flex-end;
        }
        
        .chat-input-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            padding: 10px;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            align-items: center;
            height: 60px;
        }
        
        .message {
            max-width: 75%;
            padding: 10px 14px;
            margin-bottom: 10px;
            border-radius: 20px; /* Bulles de chat totalement rondes */
            position: relative;
            word-wrap: break-word;
            clear: both;
            transition: background-color 0.2s ease, transform 0.3s ease;
            transform: translateX(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Légère ombre pour effet 3D */
            font-weight: 500; /* Style iOS */
        }
        
        .message-received {
            background-color: var(--chat-received-bg);
            float: left;
            margin-right: auto;
            border-bottom-left-radius: 4px; /* Style iOS/WhatsApp */
        }
        
        .message-sent {
            background-color: var(--chat-sent-bg);
            color: var(--chat-sent-text);
            float: right;
            margin-left: auto;
            border-bottom-right-radius: 4px; /* Style iOS/WhatsApp */
        }
        
        .message.selected {
            background-color: var(--highlight-color);
            border: 2px solid var(--primary-color);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(247, 220, 111, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(247, 220, 111, 0); }
            100% { box-shadow: 0 0 0 0 rgba(247, 220, 111, 0); }
        }
        
        .message-time {
            font-size: 10px;
            margin-top: 4px;
            text-align: right;
            clear: both;
            opacity: 0.7;
        }
        
        .chat-input-wrapper {
            flex: 1;
            margin: 0 10px;
            height: 40px;
            position: relative;
        }
        
        .chat-input {
            width: 100%;
            height: 100%;
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            color: var(--text-color);
            font-weight: 500; /* Style iOS */
        }
        
        .chat-input:focus {
            outline: none;
        }
        
        .input-icon {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--primary-color);
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s ease, transform 0.15s ease;
        }
        
        .input-icon:active {
            transform: scale(0.9);
            background-color: var(--selection-color);
        }
        
        .send-button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: transform 0.15s ease;
        }
        
        .send-button:active {
            transform: scale(0.9);
        }
        
        /* Message action menu */
        .message-actions {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--action-menu-bg);
            color: var(--action-menu-text);
            z-index: 20;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        .message-actions.active {
            transform: translateY(0);
        }
        
        .message-actions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .selected-count {
            font-weight: bold;
        }
        
        .close-actions {
            color: var(--primary-color);
            padding: 8px;
            cursor: pointer;
        }
        
        .action-buttons {
            display: flex;
            padding: 20px;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        
        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.15s ease;
            margin: 5px 10px;
        }
        
        .action-button:active {
            transform: scale(0.9);
        }
        
        .action-icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .action-label {
            font-size: 12px;
        }
        
        /* Selection mode indicator */
        .selection-mode-indicator {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            color: black;
            padding: 8px 15px;
            font-weight: bold;
            display: none;
            z-index: 15;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        /* Section Pronostics - Mis à jour depuis IA */
        .coming-soon-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 30px;
            text-align: center;
        }
        
        .coming-soon-icon {
            font-size: 60px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .coming-soon-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .coming-soon-text {
            color: #6b7280;
            line-height: 1.5;
            max-width: 300px;
            margin: 0 auto 30px auto;
        }
        
        /* Panneau de notifications */
        .notifications-panel {
            position: fixed;
            top: 50px;
            right: 0;
            width: 100%;
            max-width: 400px;
            background-color: var(--bg-color);
            border-left: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            z-index: 30;
            box-shadow: -2px 2px 10px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-height: 80%;
            overflow-y: auto;
            border-bottom-left-radius: 10px;
        }
        
        .notifications-panel.active {
            transform: translateX(0);
        }
        
        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .notifications-title {
            font-weight: bold;
            font-size: 16px;
        }
        
        .close-notifications {
            color: var(--primary-color);
            cursor: pointer;
        }
        
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
        }
        
        .notification-item.unread {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .notification-icon-container {
            width: 36px;
            height: 36px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .notification-text {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .notification-time {
            font-size: 12px;
            color: #6b7280;
        }
        
        .no-notifications {
            padding: 30px 15px;
            text-align: center;
            color: #6b7280;
        }

        /* Menu options */
        .options-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 40;
            overflow: hidden;
            width: 80%;
            max-width: 300px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .options-menu.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            visibility: visible;
        }
        
        .option-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .option-item:last-child {
            border-bottom: none;
        }
        
        .option-item:active {
            background-color: var(--selection-color);
        }
        
        .option-icon {
            width: 24px;
            text-align: center;
            margin-right: 15px;
            color: var(--primary-color);
        }
        
        .option-label {
            flex: 1;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 35;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Conversations action menu */
        .conversations-actions {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--action-menu-bg);
            color: var(--action-menu-text);
            z-index: 20;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        .conversations-actions.active {
            transform: translateY(0);
        }
        
        .check-circle {
            position: absolute;
            top: 10px;
            right: 15px;
            color: var(--primary-color);
            font-size: 20px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .chat-item.selected .check-circle,
        .user-item.selected .check-circle {
            opacity: 1;
        }
        
        /* Image preview */
        .image-preview {
            padding: 10px;
            display: none;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            position: absolute;
            bottom: 60px;
            left: 0;
            right: 0;
        }
        
        .image-preview.active {
            display: block;
        }
        
        .preview-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .preview-close {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Message with image */
        .message-image {
            max-width: 200px;
            border-radius: 10px;
            margin-top: 5px;
        }
        
        /* Block banner */
        .block-banner {
            text-align: center;
            background-color: rgba(255, 107, 107, 0.1);
            color: var(--blocked-color);
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            display: none;
        }
        
        .block-banner.active {
            display: block;
        }
        
        .unblock-btn {
            background-color: var(--blocked-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-top: 5px;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* Style pour la sélection Telegram-like */
        .chat-list {
            position: relative;
        }
        
        .chat-select-checkbox {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-50%) scale(0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        
        .chat-select-checkbox.visible {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .chat-select-checkbox.checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .chat-select-checkbox.checked::after {
            content: "✓";
            color: black;
            font-size: 14px;
            font-weight: bold;
        }
        
        .chat-item.selecting {
            padding-left: 40px;
        }
        
        .telegram-selection-mode .chat-select-checkbox {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .telegram-selection-mode .chat-item {
            padding-left: 40px;
        }
        
        /* Menu de chat supplémentaire */
        .chat-extra-buttons {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 60px;
            background-color: var(--bg-color);
            display: none;
            padding: 10px;
            border-top: 1px solid var(--border-color);
            transition: transform 0.3s ease;
            transform: translateY(100%);
        }
        
        .chat-extra-buttons.active {
            display: flex;
            transform: translateY(0);
        }
        
        .extra-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            color: var(--text-color);
            text-decoration: none;
        }
        
        .extra-button i {
            font-size: 20px;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .extra-button-label {
            font-size: 12px;
        }
        
        /* Style iOS pour les messages de réponse intégrés */
        .quoted-message {
            padding: 8px 10px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 2px solid;
            font-size: 14px;
            position: relative;
        }
        
        .quoted-message.from-me {
            border-left-color: var(--chat-sent-bg);
        }
        
        .quoted-message.from-them {
            border-left-color: var(--chat-received-bg);
        }
        
        .quoted-sender {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .quoted-sender.from-me {
            color: var(--chat-sent-bg);
        }
        
        .quoted-sender.from-them {
            color: var(--primary-color);
        }
        
        .quoted-content {
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Réactions emoji */
        .reaction-panel {
            position: absolute;
            display: flex;
            background-color: var(--reaction-bg);
            border-radius: 24px;
            padding: 5px;
            box-shadow: 0 2px 10px var(--reaction-shadow);
            z-index: 25;
            animation: scaleIn 0.2s ease;
            transform-origin: center;
        }
        
        @keyframes scaleIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .reaction-emoji {
            font-size: 20px;
            padding: 5px 8px;
            cursor: pointer;
            transition: transform 0.15s ease;
            border-radius: 20px;
        }
        
        .reaction-emoji:hover, .reaction-emoji:active {
            transform: scale(1.2);
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .message-reactions {
            display: flex;
            flex-wrap: wrap;
            margin-top: 5px;
            gap: 4px;
        }
        
        .message-reaction {
            display: inline-flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 3px 6px;
            font-size: 14px;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        
        .reaction-count {
            margin-left: 4px;
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Animation de sélection de message pour réponse */
        @keyframes messageSelected {
            0% { transform: translateX(0); }
            25% { transform: translateX(10px); }
            50% { transform: translateX(0); }
            75% { transform: translateX(10px); }
            100% { transform: translateX(0); }
        }
        
        .message.replying {
            animation: messageSelected 0.5s ease;
            background-color: var(--selection-color);
        }
        
        /* Indicateur de frappe (style iOS) */
        .typing-indicator {
            display: none;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
        }
        
        .typing-indicator.active {
            display: block;
        }
        
        .typing-dots {
            display: inline-flex;
            margin-left: 5px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #6b7280;
            border-radius: 50%;
            margin: 0 2px;
            animation: typingDot 1.4s infinite;
            opacity: 0.6;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingDot {
            0% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
            50% { transform: translateY(0); }
            100% { transform: translateY(0); }
        }
        
        /* Style pour le groupe */
        .message-sender {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
            opacity: 0.8;
        }
        
        /* Style pour la section profil modifiée */
        .profile-header {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .profile-header .profile-pic {
            width: 80px;
            height: 80px;
            margin-right: 20px;
        }
        
        .profile-header .profile-pic i {
            font-size: 30px;
            color: var(--primary-color);
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .profile-email {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .profile-status {
            color: #6b7280;
        }
        
        /* Styles pour le dialogue de sélection de contact pour le transfert */
        .forward-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 50;
            display: none;
            flex-direction: column;
        }
        
        .forward-dialog.active {
            display: flex;
        }
        
        .forward-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .forward-title {
            flex: 1;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }
        
        .forward-cancel {
            color: var(--primary-color);
            cursor: pointer;
        }
        
        .forward-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .forward-badge {
            background-color: var(--primary-color);
            color: black;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .confirmation-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 300px;
            padding: 20px;
            z-index: 60;
            display: none;
        }
        
        .confirmation-dialog.active {
            display: block;
        }
        
        .confirmation-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .confirmation-text {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .confirmation-buttons {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        
        .confirmation-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            flex-basis: 45%;
            text-align: center;
        }
        
        .confirmation-cancel {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        
        .confirmation-confirm {
            background-color: var(--primary-color);
            color: black;
        }
        
        .confirmation-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Sélection d'item pour toutes les sections */
        .selectable-item {
            position: relative;
        }
        
        .item-select-checkbox {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-50%) scale(0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        
        .item-select-checkbox.visible {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .item-select-checkbox.checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .item-select-checkbox.checked::after {
            content: "✓";
            color: black;
            font-size: 14px;
            font-weight: bold;
        }
        
        .selection-mode .selectable-item {
            padding-left: 40px;
        }
        
        .selection-mode .item-select-checkbox {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        /* Interface de recherche dans les messages */
        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 50;
            display: none;
            flex-direction: column;
        }
        
        .search-overlay.active {
            display: flex;
        }
        
        .search-header {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-back {
            color: var(--primary-color);
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .search-input-container {
            flex: 1;
            margin: 0 10px;
        }
        
        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .search-result-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            background-color: var(--secondary-color);
        }
        
        .search-result-text {
            margin-bottom: 5px;
        }
        
        .search-result-info {
            font-size: 12px;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
        }
        
        .search-highlight {
            background-color: var(--highlight-color);
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        
        /* Sections "À propos" */
        .about-container {
            padding: 20px;
            margin-top: 10px;
            background-color: var(--secondary-color);
            border-radius: 10px;
        }
        
        .about-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .about-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 15px;
        }
        
        .about-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 15px 0;
        }
        
        .about-version {
            text-align: center;
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.6;
            margin-top: 20px;
        }
        
        /* ============= NOUVELLES FONCTIONNALITÉS =============== */
        
        /* Animation de désintégration pour la suppression de messages */
        @keyframes disintegrate {
            0% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
            }
            30% {
                opacity: 0.9;
                transform: scale(0.98);
                filter: blur(1px);
            }
            60% {
                opacity: 0.6;
                transform: scale(0.9) translate(5px, 0);
                filter: blur(4px);
            }
            100% {
                opacity: 0;
                transform: scale(0.5) translate(20px, 10px);
                filter: blur(10px);
            }
        }
        
        .message.disintegrating {
            animation: disintegrate 0.8s ease-in forwards;
            pointer-events: none;
        }
        
        /* Animation de suppression pour les discussions */
        @keyframes fadeOutRight {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            60% {
                transform: translateX(30px);
                opacity: 0.2;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .chat-item.deleting {
            animation: fadeOutRight 0.5s ease-out forwards;
            pointer-events: none;
        }
        
        /* Nouveau mode de sélection amélioré */
        .new-selection-mode-indicator {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            padding: 10px 15px;
            display: none;
            z-index: 15;
            animation: slideInDown 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes slideInDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        .new-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .new-selection-title {
            font-weight: bold;
            color: black;
        }
        
        .new-selection-actions {
            display: flex;
            align-items: center;
        }
        
        .new-selection-action {
            padding: 5px 10px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            margin-left: 8px;
            font-size: 13px;
            font-weight: 500;
            color: black;
        }
        
        .new-selection-cancel {
            background: none;
        }
        
        /* Styles pour les discussions sélectionnables */
        .chat-item.swipe-selecting {
            transform: translateX(40px);
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .chat-item .select-indicator {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateX(-40px);
            transition: transform 0.3s ease;
        }
        
        .chat-item.swipe-selecting .select-indicator {
            transform: translateX(0);
        }
        
        .select-indicator-inner {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-item.selected .select-indicator-inner {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .chat-item.selected .select-indicator-inner::after {
            content: "✓";
            color: black;
            font-weight: bold;
        }
        
        /* Installation guide dialog */
        .install-guide {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 50;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .install-guide.active {
            display: flex;
        }
        
        .install-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .install-title {
            flex: 1;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }
        
        .install-close {
            color: var(--primary-color);
            padding: 8px;
            cursor: pointer;
        }
        
        .install-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .install-step {
            margin-bottom: 25px;
        }
        
        .install-step-title {
            font-weight: bold;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .install-step-number {
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            color: black;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .install-step-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
            opacity: 0.9;
        }
        
        .install-image {
            width: 100%;
            max-width: 280px;
            margin: 10px auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: block;
        }
        
        /* Dialogue de suppression amélioré */
        .delete-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 85%;
            max-width: 320px;
            padding: 20px;
            z-index: 60;
            display: none;
            animation: scaleInDialog 0.3s ease;
        }
        
        @keyframes scaleInDialog {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .delete-dialog.active {
            display: block;
        }
        
        .delete-icon {
            font-size: 40px;
            color: var(--danger-color);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .delete-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .delete-text {
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
            opacity: 0.8;
        }
        
        .delete-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .delete-option {
            padding: 12px;
            border-radius: 8px;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .delete-option:active, .delete-option.selected {
            background-color: var(--selection-color);
        }
        
        .delete-option.selected {
            border: 1px solid var(--primary-color);
        }
        
        .delete-option-icon {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .delete-option-label {
            font-weight: 500;
        }
        
        .delete-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .delete-button {
            flex-basis: 48%;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
        }
        
        .delete-cancel {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        
        .delete-confirm {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Bouton de suppression dans le mode sélection */
        .conversation-delete-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--danger-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 15;
            transform: scale(0);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .conversation-delete-btn.active {
            transform: scale(1);
        }
        
        .conversation-delete-btn:active {
            transform: scale(0.95);
        }

        /* ============= NOUVELLES FONCTIONNALITÉS AJOUTÉES =============== */
        
        /* Écran d'authentification */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .auth-header {
            padding: 40px 0 20px;
            text-align: center;
        }
        
        .auth-logo {
            font-size: 50px;
            color: var(--primary-color);
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .auth-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .auth-subtitle {
            font-size: 16px;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 20px;
            padding: 0 20px;
            text-align: center;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            color: var(--inactive-text);
            transition: color 0.3s;
        }
        
        .auth-tab.active {
            color: var(--primary-color);
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 25%;
            width: 50%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }
        
        .auth-form {
            padding: 20px;
            display: none;
            animation: fadeUp 0.5s ease;
        }
        
        @keyframes fadeUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            transform-origin: left;
            transition: transform 0.3s, color 0.3s;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            font-size: 16px;
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(247, 220, 111, 0.25);
        }
        
        .form-input::placeholder {
            color: var(--input-placeholder);
        }
        
        .form-error {
            color: var(--danger-color);
            font-size: 13px;
            margin-top: 6px;
            display: none;
            animation: shakeX 0.75s ease;
        }
        
        @keyframes shakeX {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        
        .form-footer {
            margin-top: 30px;
            text-align: center;
        }
        
        .form-footer-text {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .form-link {
            color: var(--link-color);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }
        
        .form-link:hover {
            text-decoration: underline;
        }
        
        /* Pin Lock */
        .pin-lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .pin-lock-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
            color: var(--primary-color);
        }
        
        .pin-subtitle {
            font-size: 16px;
            margin-bottom: 40px;
            text-align: center;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .pin-dots {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
        }
        
        .pin-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            margin: 0 8px;
            transition: background-color 0.3s;
        }
        
        .pin-dot.filled {
            background-color: var(--primary-color);
        }
        
        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .pin-key {
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            background-color: var(--secondary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.15s, transform 0.15s;
        }
        
        .pin-key:active {
            background-color: var(--selection-color);
            transform: scale(0.95);
        }
        
        .pin-actions {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 300px;
            margin-top: 20px;
        }
        
        .pin-action {
            font-size: 16px;
            color: var(--link-color);
            text-align: center;
            padding: 15px;
            cursor: pointer;
        }
        
        /* Pin Setup */
        .pin-setup-screen {
            display: none;
        }
        
        .pin-setup-screen.active {
            display: flex;
        }
        
        .pin-error {
            color: var(--danger-color);
            font-size: 14px;
            text-align: center;
            margin-top: 10px;
            margin-bottom: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .pin-error.visible {
            opacity: 1;
        }
        
        /* Popup de succès */
        .success-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            padding: 30px;
            width: 90%;
            max-width: 320px;
            z-index: 1001;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .success-popup.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            visibility: visible;
        }
        
        .success-icon {
            font-size: 60px;
            color: var(--success-color);
            margin-bottom: 20px;
        }
        
        .success-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .success-message {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 25px;
            color: var(--text-color);
            opacity: 0.9;
        }
        
        /* Animation d'erreur pour les entrées */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.6s ease;
        }

        /* Message log */
        .log-message {
            margin-top: 15px;
            padding: 12px;
            font-weight: bold;
            border-radius: 6px;
            white-space: pre-line;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
          
        .log-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }
          
        .log-message.success {
            background: #d4edda;
            color: #155724;
        }
          
        .log-message.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Empty state message */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--inactive-text);
        }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        /* ANIMATIONS POUR LES FORMULAIRES */
        .form-input:focus + .form-label {
            color: var(--primary-color);
            transform: translateY(-25px) scale(0.8);
        }
        
        .form-input.has-value + .form-label {
            transform: translateY(-25px) scale(0.8);
        }
        
        /* AMÉLIORATIONS DE L'ACCESSIBILITÉ */
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(247, 220, 111, 0.25);
        }
        
        /* TRANSITION ENTRE LES FORMULAIRES */
        .slide-left-enter {
            opacity: 0;
            transform: translateX(30px);
        }
        
        .slide-left-enter-active {
            opacity: 1;
            transform: translateX(0);
            transition: all 0.3s ease;
        }
        
        .slide-left-exit {
            opacity: 1;
            transform: translateX(0);
        }
        
        .slide-left-exit-active {
            opacity: 0;
            transform: translateX(-30px);
            transition: all 0.3s ease;
        }
        
        /* LOADER POUR LES REQUÊTES */
        .btn-loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--bg-color);
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .button.loading {
            pointer-events: none;
            opacity: 0.8;
        }
        
        .button.loading .btn-text {
            visibility: hidden;
        }
        
        .button.loading .btn-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -10px;
            margin-left: -10px;
            visibility: visible;
        }
    </style>
</head>
<body>
    <!-- Écran d'authentification -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fas fa-futbol"></i>
            </div>
            <h1 class="auth-title">iChat</h1>
            <p class="auth-subtitle">La messagerie moderne et sécurisée</p>
        </div>
        
        <div class="auth-tabs">
            <div class="auth-tab active" id="login-tab">Connexion</div>
            <div class="auth-tab" id="register-tab">Inscription</div>
        </div>
        
        <!-- Formulaire de Connexion -->
        <div id="login-form" class="auth-form active">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="login-email" placeholder="Votre email">
                <div id="login-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="login-password" placeholder="Votre mot de passe">
                <div id="login-password-error" class="form-error">Le mot de passe est obligatoire</div>
            </div>
            
            <div id="login-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="loginBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Se connecter</span>
                </button>
                <p class="form-footer-text">
                    Vous n'avez pas de compte ? <a href="#" class="form-link" id="goto-register">S'inscrire</a>
                </p>
            </div>
        </div>
        
        <!-- Formulaire d'Inscription -->
        <div id="register-form" class="auth-form">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="register-email" placeholder="Votre adresse email">
                <div id="register-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="register-password" placeholder="Créez un mot de passe sécurisé">
                <div id="register-password-error" class="form-error">Le mot de passe doit contenir au moins 6 caractères</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Confirmer le mot de passe</label>
                <input type="password" class="form-input" id="register-confirm-password" placeholder="Confirmez votre mot de passe">
                <div id="register-confirm-password-error" class="form-error">Les mots de passe ne correspondent pas</div>
            </div>
            
            <div id="register-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="registerBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">S'inscrire</span>
                </button>
                <p class="form-footer-text">
                    Vous avez déjà un compte ? <a href="#" class="form-link" id="goto-login">Se connecter</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Écran de verrouillage par PIN -->
    <div id="pin-lock-screen" class="pin-lock-screen" style="display: none;">
        <h2 class="pin-lock-title">Verrouillage de sécurité</h2>
        <p class="pin-subtitle" id="pin-instruction">Veuillez entrer votre code PIN pour accéder à iChat</p>
        
        <div class="pin-dots" id="pin-dots">
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
        </div>
        
        <div class="pin-error" id="pin-error">Code PIN incorrect. Veuillez réessayer.</div>
        
        <div class="pin-keypad">
            <div class="pin-key" data-value="1">1</div>
            <div class="pin-key" data-value="2">2</div>
            <div class="pin-key" data-value="3">3</div>
            <div class="pin-key" data-value="4">4</div>
            <div class="pin-key" data-value="5">5</div>
            <div class="pin-key" data-value="6">6</div>
            <div class="pin-key" data-value="7">7</div>
            <div class="pin-key" data-value="8">8</div>
            <div class="pin-key" data-value="9">9</div>
            <div class="pin-key" data-action="cancel">
                <i class="fas fa-times"></i>
            </div>
            <div class="pin-key" data-value="0">0</div>
            <div class="pin-key" data-action="delete">
                <i class="fas fa-backspace"></i>
            </div>
        </div>
        
        <div class="pin-actions">
            <div class="pin-action" id="forgot-pin">Mot de passe oublié ?</div>
            <div class="pin-action" id="logout-pin">Se déconnecter</div>
        </div>
    </div>

    <!-- Écran de configuration du PIN -->
    <div id="pin-setup-screen" class="pin-lock-screen pin-setup-screen">
        <h2 class="pin-lock-title">Configuration du code PIN</h2>
        <p class="pin-subtitle" id="pin-setup-instruction">Créez un code PIN à 4 chiffres pour sécuriser votre application</p>
        
        <div class="pin-dots" id="pin-setup-dots">
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
        </div>
        
        <div class="pin-error" id="pin-setup-error"></div>
        
        <div class="pin-keypad">
            <div class="pin-key setup-key" data-value="1">1</div>
            <div class="pin-key setup-key" data-value="2">2</div>
            <div class="pin-key setup-key" data-value="3">3</div>
            <div class="pin-key setup-key" data-value="4">4</div>
            <div class="pin-key setup-key" data-value="5">5</div>
            <div class="pin-key setup-key" data-value="6">6</div>
            <div class="pin-key setup-key" data-value="7">7</div>
            <div class="pin-key setup-key" data-value="8">8</div>
            <div class="pin-key setup-key" data-value="9">9</div>
            <div class="pin-key setup-key" data-action="cancel">
                <i class="fas fa-times"></i>
            </div>
            <div class="pin-key setup-key" data-value="0">0</div>
            <div class="pin-key setup-key" data-action="delete">
                <i class="fas fa-backspace"></i>
            </div>
        </div>
    </div>

    <!-- Popup de succès -->
    <div id="success-popup" class="success-popup">
        <div class="success-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h3 class="success-title" id="success-title">Succès !</h3>
        <p class="success-message" id="success-message">Opération réussie avec succès !</p>
        <button class="button" id="success-button">Continuer</button>
    </div>

    <!-- Écran de chargement -->
    <div id="loading" class="loading">
        <i class="fas fa-futbol football-spinner"></i>
        <div style="font-weight: bold; font-size: 24px; color: var(--primary-color);">iChat</div>
        <div style="margin-top: 10px; color: #6b7280;">Chargement...</div>
    </div>

    <!-- En-tête -->
    <div class="header">
        <div id="header-left">
            <span class="notification-icon badge" id="notification-bell">
                <i class="fas fa-bell"></i>
                <span class="dot"></span>
            </span>
        </div>
        <div id="header-title" class="header-title">Messages</div>
        <div id="header-action">
            <span class="notification-icon" id="options-button">
                <i class="fas fa-ellipsis-v"></i>
            </span>
        </div>
    </div>

    <!-- Overlay pour le menu d'options -->
    <div id="overlay" class="overlay"></div>

    <!-- Menu d'options simplifié pour les sections hors messages -->
    <div id="simple-options-menu" class="options-menu">
        <div class="option-item" id="change-theme-option">
            <div class="option-icon"><i class="fas fa-palette"></i></div>
            <div class="option-label">Changer de thème</div>
        </div>
        <div class="option-item" id="show-install-guide-option">
            <div class="option-icon"><i class="fas fa-download"></i></div>
            <div class="option-label">Installer l'application</div>
        </div>
    </div>
    
    <!-- Menu d'options pour la section messages -->
    <div id="messages-options-menu" class="options-menu">
        <div class="option-item" id="select-conversations-option">
            <div class="option-icon"><i class="fas fa-check-square"></i></div>
            <div class="option-label">Sélectionner des discussions</div>
        </div>
        <div class="option-item" id="change-theme-messages-option">
            <div class="option-icon"><i class="fas fa-palette"></i></div>
            <div class="option-label">Changer de thème</div>
        </div>
        <div class="option-item" id="show-install-guide-messages-option">
            <div class="option-icon"><i class="fas fa-download"></i></div>
            <div class="option-label">Installer l'application</div>
        </div>
    </div>

    <!-- Menu d'options de chat (avec recherche de messages) -->
    <div id="chat-options-menu" class="options-menu">
        <div class="option-item" id="select-messages-option">
            <div class="option-icon"><i class="fas fa-check-square"></i></div>
            <div class="option-label">Sélectionner des messages</div>
        </div>
        <div id="block-option" class="option-item">
            <div class="option-icon"><i class="fas fa-ban"></i></div>
            <div class="option-label">Bloquer cette personne</div>
        </div>
        <div class="option-item" id="search-conversation-option">
            <div class="option-icon"><i class="fas fa-search"></i></div>
            <div class="option-label">Rechercher dans la conversation</div>
        </div>
        <div class="option-item" id="clear-conversation-option">
            <div class="option-icon"><i class="fas fa-trash-alt"></i></div>
            <div class="option-label">Effacer la conversation</div>
        </div>
        <div class="option-item" id="show-install-guide-chat-option">
            <div class="option-icon"><i class="fas fa-download"></i></div>
            <div class="option-label">Installer l'application</div>
        </div>
    </div>

    <!-- Panneau de notifications -->
    <div id="notifications-panel" class="notifications-panel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <div class="close-notifications" id="close-notifications">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div id="notifications-container">
            <div class="notification-item unread">
                <div class="notification-icon-container">
                    <i class="fas fa-user" style="color: var(--primary-color);"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">Nouvelle mise à jour</div>
                    <div class="notification-text">Une nouvelle version de l'application est disponible avec des fonctionnalités améliorées.</div>
                    <div class="notification-time">Il y a 10 minutes</div>
                </div>
            </div>
            <div class="notification-item">
                <div class="notification-icon-container">
                    <i class="fas fa-envelope" style="color: var(--primary-color);"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">Marie Dupont</div>
                    <div class="notification-text">Vous a envoyé un nouveau message.</div>
                    <div class="notification-time">Il y a 2 heures</div>
                </div>
            </div>
            <div class="notification-item">
                <div class="notification-icon-container">
                    <i class="fas fa-birthday-cake" style="color: var(--primary-color);"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">Anniversaire</div>
                    <div class="notification-text">C'est l'anniversaire de Pierre Martin aujourd'hui!</div>
                    <div class="notification-time">Il y a 5 heures</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bouton de suppression flottant pour le mode sélection -->
    <div id="conversation-delete-btn" class="conversation-delete-btn">
        <i class="fas fa-trash-alt" style="font-size: 20px;"></i>
    </div>

    <!-- Indicateur mode sélection -->
    <div id="selection-indicator" class="selection-mode-indicator">
        Sélection en cours (0)
    </div>

    <!-- Nouvel indicateur de mode sélection -->
    <div id="new-selection-indicator" class="new-selection-mode-indicator">
        <div class="new-selection-header">
            <div class="new-selection-title">0 sélectionné</div>
            <div class="new-selection-actions">
                <div class="new-selection-action" id="selection-all">Tout</div>
                <div class="new-selection-action new-selection-cancel" id="cancel-selection">Annuler</div>
            </div>
        </div>
    </div>

    <!-- Le reste du contenu de l'application reste inchangé -->
    
    <!-- Contenu principal de l'application -->
    <div class="content">
        <!-- Section Messages -->
        <div id="messages-section" class="section active">
            <div class="search-container">
                <input type="text" class="search-input" id="messages-search" placeholder="Rechercher">
            </div>
            
            <div class="chat-list" id="chat-list">
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <div class="empty-state-title">Aucune conversation</div>
                    <div class="empty-state-text">Vos conversations apparaîtront ici</div>
                </div>
            </div>
        </div>
        
        <!-- Section utilisateurs -->
        <div id="users-section" class="section">
            <div class="search-container">
                <input type="text" class="search-input" id="users-search" placeholder="Rechercher un utilisateur">
            </div>
            
            <div id="users-list">
                <!-- Les utilisateurs seront chargés dynamiquement -->
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <div class="empty-state-title">Aucun utilisateur</div>
                    <div class="empty-state-text">Les utilisateurs apparaîtront ici</div>
                </div>
            </div>
        </div>
        
        <!-- Section Pronostics -->
        <div id="pronostics-section" class="section">
            <div class="coming-soon-container">
                <i class="fas fa-futbol coming-soon-icon"></i>
                <div class="coming-soon-title">Pronostics sportifs</div>
                <p class="coming-soon-text">
                    Retrouvez bientôt les meilleurs pronostics sportifs pour vos paris. Soyez alerté des opportunités de gains!
                </p>
                <button class="button" id="notify-launch-button">Être notifié(e) au lancement</button>
            </div>
        </div>
        
        <!-- Section Profil -->
        <div id="profile-section" class="section">
            <div class="profile-header">
                <div class="profile-pic">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="profile-name">
                        <span id="profile-name-text">Utilisateur</span>
                        <span class="admin-badge" id="admin-badge" style="display: none;">Admin</span>
                    </div>
                    <div class="profile-email" id="profile-email">user@example.com</div>
                    <div class="profile-status">En ligne</div>
                </div>
            </div>
            
            <div style="padding: 0 16px; margin: 15px 0; font-weight: bold; font-size: 18px;">Paramètres</div>
            
            <div class="settings-container">
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-palette" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Couleur de l'interface</div>
                    </div>
                    <input type="color" id="color-picker" value="#F7DC6F" style="width: 30px; height: 30px; border: none;">
                </div>
                
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-moon" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Mode sombre</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="dark-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <!-- Paramètre de verrouillage par code PIN -->
                <div class="setting-item" id="pin-setting">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-lock" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Verrouillage par code PIN</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="pin-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <!-- Section "À propos" -->
                <div style="padding: 0; margin: 20px 0 15px 0; font-weight: bold; font-size: 18px;">À propos</div>
                
                <div class="about-container">
                    <div class="about-title">iChat</div>
                    <div class="about-text">Une application de messagerie sécurisée et facile à utiliser qui vous permet de rester en contact avec vos amis et votre famille.</div>
                    
                    <div class="about-divider"></div>
                    
                    <div class="about-text">
                        <strong>Fonctionnalités :</strong>
                        <ul style="padding-left: 20px; margin-top: 5px;">
                            <li>Messagerie instantanée</li>
                            <li>Partage de photos</li>
                            <li>Groupes de discussion</li>
                            <li>Notifications en temps réel</li>
                            <li>Mode sombre</li>
                            <li>Verrouillage par code PIN</li>
                        </ul>
                    </div>
                    
                    <div class="about-version">Version 2.1.0</div>
                </div>
                
                <button id="logout-btn" class="button">Se déconnecter</button>
                
                <!-- Bouton pour supprimer le compte -->
                <button id="delete-account-btn" class="button danger">Supprimer mon compte</button>
            </div>
        </div>
    </div>

    <!-- Interface de Chat -->
    <div id="chat-interface" class="chat-section">
        <div id="block-banner" class="block-banner">
            Vous avez bloqué cette personne
            <button class="unblock-btn" id="unblock-btn">Débloquer</button>
        </div>
        <div class="chat-messages-container">
            <div class="chat-messages" id="chat-messages">
                <!-- Les messages seront ajoutés dynamiquement ici -->
            </div>
            <div id="typing-indicator" class="typing-indicator">
                <span id="typing-name"></span> est en train d'écrire
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
        <div id="image-preview" class="image-preview">
            <div style="position: relative; display: inline-block;">
                <img id="preview-img" class="preview-image" src="" alt="Aperçu">
                <div class="preview-close" id="preview-close">
                    <i class="fas fa-times"></i>
                </div>
            </div>
        </div>
        <div class="chat-input-container">
            <div class="input-icon" id="emoji-button">
                <i class="far fa-smile"></i>
            </div>
            <div class="input-icon" id="attachment-button">
                <i class="fas fa-paperclip"></i>
            </div>
            <div class="chat-input-wrapper">
                <input type="text" id="chat-input" class="chat-input" placeholder="Écrire un message..." autocomplete="off">
            </div>
            <div class="send-button" id="send-button">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>
        <div id="chat-extra-buttons" class="chat-extra-buttons">
            <div class="extra-button" id="image-button">
                <i class="fas fa-image"></i>
                <span class="extra-button-label">Image</span>
            </div>
            <div class="extra-button" id="file-button">
                <i class="fas fa-file"></i>
                <span class="extra-button-label">Document</span>
            </div>
            <div class="extra-button" id="camera-button">
                <i class="fas fa-camera"></i>
                <span class="extra-button-label">Appareil photo</span>
            </div>
            <div class="extra-button" id="location-button">
                <i class="fas fa-map-marker-alt"></i>
                <span class="extra-button-label">Localisation</span>
            </div>
        </div>
        <input type="file" id="image-input" accept="image/*" style="display: none;">
    </div>

    <!-- Interface de recherche dans les messages -->
    <div id="search-overlay" class="search-overlay">
        <div class="search-header">
            <div class="search-back" id="search-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="search-input-container">
                <input type="text" id="message-search-input" class="search-input" placeholder="Rechercher dans les messages...">
            </div>
        </div>
        <div id="search-results" class="search-results">
            <div class="no-results">Saisissez un terme à rechercher</div>
        </div>
    </div>

    <!-- Menu d'actions pour les messages sélectionnés -->
    <div id="message-actions" class="message-actions">
        <div class="message-actions-header">
            <div class="selected-count" id="selected-count">1 sélectionné</div>
            <div class="close-actions" id="close-message-actions">Annuler</div>
        </div>
        <div class="action-buttons">
            <div class="action-button" id="delete-messages-btn">
                <div class="action-icon"><i class="fas fa-trash-alt"></i></div>
                <div class="action-label">Supprimer</div>
            </div>
            <div class="action-button" id="forward-messages-btn">
                <div class="action-icon"><i class="fas fa-share"></i></div>
                <div class="action-label">Transférer</div>
            </div>
            <div class="action-button" id="copy-messages-btn">
                <div class="action-icon"><i class="fas fa-copy"></i></div>
                <div class="action-label">Copier</div>
            </div>
            <div class="action-button" id="reply-message-btn">
                <div class="action-icon"><i class="fas fa-reply"></i></div>
                <div class="action-label">Répondre</div>
            </div>
        </div>
    </div>

    <!-- Menu de réactions emoji rapides -->
    <div id="reaction-panel" class="reaction-panel" style="display: none;">
        <div class="reaction-emoji" data-emoji="👍">👍</div>
        <div class="reaction-emoji" data-emoji="😂">😂</div>
        <div class="reaction-emoji" data-emoji="😡">😡</div>
        <div class="reaction-emoji" data-emoji="👎">👎</div>
        <div class="reaction-emoji" data-emoji="🤯">🤯</div>
        <div class="reaction-emoji" data-emoji="🎉">🎉</div>
    </div>

    <!-- Menu d'actions pour les conversations sélectionnées -->
    <div id="conversations-actions" class="conversations-actions">
        <div class="message-actions-header">
            <div class="selected-count" id="conversations-selected-count">1 sélectionné</div>
            <div class="close-actions" id="close-conversations-actions">Annuler</div>
        </div>
        <div class="action-buttons">
            <div class="action-button" id="delete-conversations-btn">
                <div class="action-icon"><i class="fas fa-trash-alt"></i></div>
                <div class="action-label">Supprimer</div>
            </div>
            <div class="action-button" id="block-users-btn">
                <div class="action-icon"><i class="fas fa-ban"></i></div>
                <div class="action-label">Bloquer</div>
            </div>
            <div class="action-button" id="mark-read-btn">
                <div class="action-icon"><i class="fas fa-check-double"></i></div>
                <div class="action-label">Marquer comme lu</div>
            </div>
            <div class="action-button" id="archive-conversations-btn">
                <div class="action-icon"><i class="fas fa-archive"></i></div>
                <div class="action-label">Archiver</div>
            </div>
        </div>
    </div>

    <!-- Interface de transfert de messages -->
    <div id="forward-dialog" class="forward-dialog">
        <div class="forward-header">
            <div class="forward-cancel" id="forward-cancel">Annuler</div>
            <div class="forward-title">Transférer à <span id="forward-count-badge" class="forward-badge">1</span></div>
        </div>
        <div class="forward-list" id="forward-contacts-list">
            <!-- Les contacts seront ajoutés dynamiquement ici -->
        </div>
    </div>

    <!-- Boîte de dialogue de confirmation -->
    <div id="confirmation-dialog" class="confirmation-dialog">
        <div class="confirmation-title">Confirmation</div>
        <div class="confirmation-text" id="confirmation-text">Êtes-vous sûr de vouloir effectuer cette action?</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="confirmation-cancel">Annuler</div>
            <div class="confirmation-button confirmation-confirm" id="confirmation-confirm">Confirmer</div>
        </div>
    </div>

    <!-- Boîte de dialogue de suppression de compte -->
    <div id="delete-account-dialog" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer le compte</div>
        <div class="confirmation-text">Êtes-vous sûr de vouloir supprimer votre compte ? Cette action est irréversible et toutes vos données seront perdues.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-account-cancel">Annuler</div>
            <div class="confirmation-button confirmation-danger" id="delete-account-confirm">Supprimer</div>
        </div>
    </div>

    <!-- Dialogue de suppression des messages avec options -->
    <div id="delete-message-dialog" class="delete-dialog">
        <div class="delete-icon">
            <i class="fas fa-trash-alt"></i>
        </div>
        <div class="delete-title">Supprimer les messages</div>
        <div class="delete-text">Comment souhaitez-vous supprimer ces messages ?</div>
        
        <div class="delete-options">
            <div class="delete-option" id="delete-for-me">
                <div class="delete-option-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="delete-option-label">Supprimer pour moi seulement</div>
            </div>
            <div class="delete-option" id="delete-for-all">
                <div class="delete-option-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="delete-option-label">Supprimer pour tout le monde</div>
            </div>
        </div>
        
        <div class="delete-buttons">
            <div class="delete-button delete-cancel" id="delete-messages-cancel">Annuler</div>
            <div class="delete-button delete-confirm" id="delete-messages-confirm">Supprimer</div>
        </div>
    </div>

    <!-- Guide d'installation -->
    <div id="install-guide" class="install-guide">
        <div class="install-header">
            <div class="install-close" id="close-install-guide">
                <i class="fas fa-times"></i>
            </div>
            <div class="install-title">Installer l'application</div>
        </div>
        <div class="install-content">
            <div class="install-step">
                <div class="install-step-title">
                    <div class="install-step-number">1</div>
                    <div>Sur iPhone & iPad (Safari)</div>
                </div>
                <div class="install-step-text">
                    Appuyez sur l'icône de partage dans la barre de navigation (rectangle avec une flèche pointant vers le haut).
                </div>
                <div class="install-step-text" style="margin-top: 10px;">
                    Faites défiler les options et appuyez sur "Sur l'écran d'accueil".
                </div>
            </div>
            
            <div class="install-step">
                <div class="install-step-title">
                    <div class="install-step-number">2</div>
                    <div>Sur Android (Chrome)</div>
                </div>
                <div class="install-step-text">
                    Appuyez sur les trois points dans le coin supérieur droit puis sur "Ajouter à l'écran d'accueil".
                </div>
            </div>
            
            <div class="install-step">
                <div class="install-step-title">
                    <div class="install-step-number">3</div>
                    <div>Sur ordinateur (Chrome)</div>
                </div>
                <div class="install-step-text">
                    Cliquez sur les trois points dans le coin supérieur droit puis sur "Installer iChat".
                </div>
            </div>
            
            <div class="install-step">
                <div class="install-step-text" style="text-align: center; margin-top: 30px;">
                    Une fois installée, l'application fonctionnera en mode plein écran et hors-ligne comme une application native !
                </div>
            </div>
        </div>
    </div>

    <!-- Barre d'onglets -->
    <div class="tabbar" id="tabbar">
        <a href="#" class="tab active" data-section="messages">
            <div class="badge">
                <i class="tab-icon fas fa-comments"></i>
                <span class="dot"></span>
            </div>
            <span>Messages</span>
        </a>
        <a href="#" class="tab" data-section="users">
            <i class="tab-icon fas fa-users"></i>
            <span>Utilisateurs</span>
        </a>
        <a href="#" class="tab" data-section="pronostics">
            <i class="tab-icon fas fa-futbol"></i>
            <span>Pronostics</span>
        </a>
        <a href="#" class="tab" data-section="profile">
            <i class="tab-icon fas fa-user"></i>
            <span>Profil</span>
        </a>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy, addDoc, onSnapshot, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDTPLxUiA8lj82kqc6CyCPLQDITc0CtLUE",
            authDomain: "ichat-betai.firebaseapp.com",
            databaseURL: "https://ichat-betai-default-rtdb.firebaseio.com",
            projectId: "ichat-betai",
            storageBucket: "ichat-betai.appspot.com",
            messagingSenderId: "168337722600",
            appId: "1:168337722600:web:beb331f83cc4778c5b4d5d",
            measurementId: "G-STXPSZN7X8"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables globales
        let isLoggedIn = false;
        let currentUser = null;
        let currentUserData = null;
        let isAdmin = false;
        let userPin = null;
        let isPinEnabled = false;
        let isPinSetupMode = false;
        let tempPin = '';
        let confirmPin = '';
        
        // Variables pour l'interface de chat
        let currentContact = '';
        let isSelectionMode = false;
        let selectionModeType = '';
        let selectedMessages = new Set();
        let selectedItems = new Set();
        let messagesForForward = [];
        let targetContactForForward = '';
        let messageReactions = {};
        let blockedUsers = new Set();
        let replyToMessage = null;
        let selectedImage = null;
        let isAttachmentsOpen = false;
        let isNotificationsOpen = false;
        let isOptionsMenuOpen = false;
        let lastTap = 0;
        let currentTappedMessage = null;
        let currentSection = 'messages';
        let selectedDeleteOption = 'for-me';
        
        // ================ FONCTIONS POUR LES ÉVÉNEMENTS D'INTERFACE ================
        
        // Fonction pour détecter le mode sombre du système
        function setupDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
            
            // Initialiser l'état du toggle
            document.getElementById('dark-toggle').checked = document.documentElement.classList.contains('dark');
        }
        
        // Fonction pour configurer les événements de l'interface
        function setupUIEvents() {
            // Onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionName = tab.getAttribute('data-section');
                    changeTab(sectionName);
                });
            });
            
            // Bouton de notification
            document.getElementById('notification-bell').addEventListener('click', toggleNotifications);
            document.getElementById('close-notifications').addEventListener('click', toggleNotifications);
            
            // Boutons d'options
            document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            document.getElementById('overlay').addEventListener('click', closeAllDialogs);
            
            // Options menus
            document.getElementById('change-theme-option').addEventListener('click', changeTheme);
            document.getElementById('change-theme-messages-option').addEventListener('click', changeTheme);
            document.getElementById('show-install-guide-option').addEventListener('click', showInstallGuide);
            document.getElementById('show-install-guide-messages-option').addEventListener('click', showInstallGuide);
            document.getElementById('show-install-guide-chat-option').addEventListener('click', showInstallGuide);
            document.getElementById('select-conversations-option').addEventListener('click', startConversationsSelectionMode);
            document.getElementById('select-messages-option').addEventListener('click', startMessagesSelectionMode);
            document.getElementById('block-option').addEventListener('click', blockUnblockUser);
            document.getElementById('search-conversation-option').addEventListener('click', searchInConversation);
            document.getElementById('clear-conversation-option').addEventListener('click', clearConversation);
            
            // Fermer guides
            document.getElementById('close-install-guide').addEventListener('click', closeInstallGuide);
            
            // Sélection de conversations
            document.getElementById('selection-all').addEventListener('click', selectAllItems);
            document.getElementById('cancel-selection').addEventListener('click', exitSelectionMode);
            document.getElementById('conversation-delete-btn').addEventListener('click', deleteSelectedConversations);
            
            // Actions de messages
            document.getElementById('delete-messages-btn').addEventListener('click', showDeleteMessageOptions);
            document.getElementById('forward-messages-btn').addEventListener('click', forwardSelectedMessages);
            document.getElementById('copy-messages-btn').addEventListener('click', copySelectedMessages);
            document.getElementById('reply-message-btn').addEventListener('click', replyToSelectedMessage);
            document.getElementById('close-message-actions').addEventListener('click', () => exitSelectionMode('messages'));
            
            // Options de suppression
            document.getElementById('delete-for-me').addEventListener('click', () => selectDeleteOption('for-me'));
            document.getElementById('delete-for-all').addEventListener('click', () => selectDeleteOption('for-all'));
            document.getElementById('delete-messages-cancel').addEventListener('click', closeDeleteMessageDialog);
            document.getElementById('delete-messages-confirm').addEventListener('click', confirmDeleteMessages);
            
            // Actions de conversations
            document.getElementById('delete-conversations-btn').addEventListener('click', deleteSelectedConversations);
            document.getElementById('block-users-btn').addEventListener('click', blockSelectedUsers);
            document.getElementById('mark-read-btn').addEventListener('click', markSelectedAsRead);
            document.getElementById('archive-conversations-btn').addEventListener('click', archiveSelectedConversations);
            document.getElementById('close-conversations-actions').addEventListener('click', () => exitSelectionMode('conversations'));
            
            // Interface de transfert
            document.getElementById('forward-cancel').addEventListener('click', closeForwardDialog);
            
            // Interface de chat
            document.getElementById('chat-input').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('emoji-button').addEventListener('click', openEmojiKeyboard);
            document.getElementById('attachment-button').addEventListener('click', toggleAttachments);
            document.getElementById('preview-close').addEventListener('click', clearImagePreview);
            document.getElementById('unblock-btn').addEventListener('click', unblockUser);
            
            // Interface de recherche
            document.getElementById('search-back').addEventListener('click', closeSearchInterface);
            document.getElementById('message-search-input').addEventListener('input', searchMessages);
            
            // Boutons d'attachement
            document.getElementById('image-button').addEventListener('click', selectImage);
            document.getElementById('file-button').addEventListener('click', selectFile);
            document.getElementById('camera-button').addEventListener('click', selectCamera);
            document.getElementById('location-button').addEventListener('click', selectLocation);
            
            // Sélection d'image
            document.getElementById('image-input').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    selectedImage = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('preview-img').src = event.target.result;
                        document.getElementById('image-preview').classList.add('active');
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // Événements pour les paramètres
            document.getElementById('color-picker').addEventListener('input', function(e) {
                document.documentElement.style.setProperty('--primary-color', e.target.value);
                
                // En mode sombre, mettre à jour la couleur des messages envoyés
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.style.setProperty('--chat-sent-bg', e.target.value);
                }
            });
            
            document.getElementById('dark-toggle').addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.classList.add('dark');
                    // En mode sombre, la couleur du message est la même que la couleur primaire
                    document.documentElement.style.setProperty('--chat-sent-bg', document.documentElement.style.getPropertyValue('--primary-color') || '#F7DC6F');
                } else {
                    document.documentElement.classList.remove('dark');
                    // En mode clair, la couleur du message est violette
                    document.documentElement.style.setProperty('--chat-sent-bg', '#5D5CDE');
                }
            });
            
            document.getElementById('pin-toggle').addEventListener('change', setupPinCode);
            
            // Événements du profil
            document.getElementById('logout-btn').addEventListener('click', logoutUser);
            document.getElementById('delete-account-btn').addEventListener('click', showDeleteAccountConfirmation);
            document.getElementById('delete-account-cancel').addEventListener('click', closeDeleteAccountDialog);
            document.getElementById('delete-account-confirm').addEventListener('click', deleteAccount);
            
            // Événements de confirmation
            document.getElementById('confirmation-cancel').addEventListener('click', closeConfirmationDialog);
            
            // Pronostics
            document.getElementById('notify-launch-button').addEventListener('click', notifyLaunch);
        }
        
        // ================ CONFIGURATION DES ÉVÉNEMENTS D'AUTHENTIFICATION ================
        
        function setupAuthEvents() {
            // Tabs d'authentification
            document.getElementById('login-tab').addEventListener('click', () => changeAuthTab('login'));
            document.getElementById('register-tab').addEventListener('click', () => changeAuthTab('register'));
            
            // Navigation entre les formulaires
            document.getElementById('goto-register').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('register');
            });
            
            document.getElementById('goto-login').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('login');
            });
            
            // Boutons d'action
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            document.getElementById('registerBtn').addEventListener('click', registerUser);
            
            // Validation en temps réel
            document.getElementById('login-email').addEventListener('input', validateLoginEmail);
            document.getElementById('login-password').addEventListener('input', validateLoginPassword);
            document.getElementById('register-email').addEventListener('input', validateRegisterEmail);
            document.getElementById('register-password').addEventListener('input', validateRegisterPassword);
            document.getElementById('register-confirm-password').addEventListener('input', validateRegisterConfirmPassword);
            
            // Validation à la soumission
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateLoginForm()) {
                    loginUser();
                }
            });
            
            document.getElementById('register-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateRegisterForm()) {
                    registerUser();
                }
            });
        }
        
        // ================ CONFIGURATION DES ÉVÉNEMENTS DU PIN ================
        
        function setupPinEvents() {
            // PIN de déverrouillage
            document.querySelectorAll('.pin-key:not(.setup-key)').forEach(key => {
                key.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const action = this.getAttribute('data-action');
                    
                    if (value) {
                        enterPinDigit(value);
                    } else if (action === 'delete') {
                        deleteLastPinDigit();
                    } else if (action === 'cancel') {
                        cancelPin();
                    }
                });
            });
            
            // PIN de configuration
            document.querySelectorAll('.setup-key').forEach(key => {
                key.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const action = this.getAttribute('data-action');
                    
                    if (value) {
                        enterSetupPinDigit(value);
                    } else if (action === 'delete') {
                        deleteLastSetupPinDigit();
                    } else if (action === 'cancel') {
                        cancelPinSetup();
                    }
                });
            });
            
            // Actions supplémentaires du PIN
            document.getElementById('forgot-pin').addEventListener('click', forgotPin);
            document.getElementById('logout-pin').addEventListener('click', logoutFromPinScreen);
        }
        
        // ================ FONCTIONS DE NAVIGATION ================
        
        // Fonction pour changer d'onglet
        function changeTab(tabName) {
            // Si le panneau de notifications est ouvert, le fermer
            if (isNotificationsOpen) {
                toggleNotifications();
            }
            
            // Si le menu d'options est ouvert, le fermer
            if (isOptionsMenuOpen) {
                closeOptionsMenu();
            }
            
            // Si le menu d'attachements est ouvert, le fermer
            if (isAttachmentsOpen) {
                document.getElementById('chat-extra-buttons').classList.remove('active');
                isAttachmentsOpen = false;
            }
            
            // Si on est dans l'interface de chat, retourner à la liste des messages
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
                if (tabName === 'messages') return;
            }
            
            // Si on est en mode sélection, quitter ce mode
            if (isSelectionMode) {
                exitSelectionMode();
            }
            
            // Masquer le panel de réactions s'il est visible
            document.getElementById('reaction-panel').style.display = 'none';
            
            // Mettre à jour la section active
            currentSection = tabName;
            
            // Mettre à jour les onglets actifs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`.tab[data-section="${tabName}"]`).classList.add('active');
            
            // Mettre à jour le titre dans l'en-tête
            document.getElementById('header-title').textContent = tabName.charAt(0).toUpperCase() + tabName.slice(1);
            
            // Réinitialiser l'en-tête
            document.getElementById('header-left').innerHTML = '<span class="notification-icon badge" id="notification-bell"><i class="fas fa-bell"></i><span class="dot"></span></span>';
            document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
            
            // Réattacher les événements
            document.getElementById('notification-bell').addEventListener('click', toggleNotifications);
            document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            
            // Masquer toutes les sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Afficher la section active
            document.getElementById(`${tabName}-section`).classList.add('active');
            
            // Charger le contenu approprié selon la section
            if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'messages') {
                loadConversations();
            }
        }
        
        // Fonction pour ouvrir une conversation
        function openChat(contact) {
            if (!contact) return;
            
            // Si le panneau de notifications est ouvert, le fermer
            if (isNotificationsOpen) {
                toggleNotifications();
            }
            
            // Si le menu d'options est ouvert, le fermer
            if (isOptionsMenuOpen) {
                closeOptionsMenu();
            }
            
            // Si on est en mode sélection, ne pas ouvrir le chat
            if (isSelectionMode) {
                return;
            }
            
            currentContact = contact;
            
            // Cacher la barre d'onglets
            document.getElementById('tabbar').style.display = 'none';
            
            // Cacher les sections normales
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mettre à jour l'en-tête
            document.getElementById('header-title').innerText = contact;
            document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
            document.getElementById('header-left').innerHTML = '<div class="back-button" onclick="closeChat()"><i class="fas fa-chevron-left"></i></div>';
            
            // Réattacher l'événement d'options
            document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            document.getElementById('header-left').querySelector('.back-button').addEventListener('click', closeChat);
            
            // Afficher l'interface de chat
            document.getElementById('chat-interface').style.display = 'block';
            
            // Vérifier si l'utilisateur est bloqué
            if (blockedUsers.has(contact)) {
                document.getElementById('block-banner').classList.add('active');
            } else {
                document.getElementById('block-banner').classList.remove('active');
            }
            
            // Charger les messages
            loadChatMessages(contact);
        }
        
        // Fonction pour fermer une conversation
        function closeChat() {
            // Si on est en mode sélection des messages, le quitter d'abord
            if (isSelectionMode && selectionModeType === 'messages') {
                exitSelectionMode();
            }
            
            // Si l'interface de recherche est ouverte, la fermer
            if (document.getElementById('search-overlay').classList.contains('active')) {
                closeSearchInterface();
            }
            
            // Si le menu d'attachements est ouvert, le fermer
            if (isAttachmentsOpen) {
                document.getElementById('chat-extra-buttons').classList.remove('active');
                isAttachmentsOpen = false;
            }
            
            // Masquer l'indicateur de frappe
            document.getElementById('typing-indicator').classList.remove('active');
            
            // Masquer le panel de réactions s'il est visible
            document.getElementById('reaction-panel').style.display = 'none';
            
            // Afficher la barre d'onglets
            document.getElementById('tabbar').style.display = 'flex';
            
            // Cacher l'interface de chat
            document.getElementById('chat-interface').style.display = 'none';
            
            // Réinitialiser l'en-tête pour revenir à la liste des messages
            document.getElementById('header-title').innerText = 'Messages';
            document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
            document.getElementById('header-left').innerHTML = '<span class="notification-icon badge" id="notification-bell"><i class="fas fa-bell"></i><span class="dot"></span></span>';
            
            // Réattacher les événements
            document.getElementById('notification-bell').addEventListener('click', toggleNotifications);
            document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            
            // Afficher la section messages
            document.getElementById('messages-section').classList.add('active');
            currentSection = 'messages';
            
            // Réinitialiser le contact actuel et message à répondre
            currentContact = '';
            replyToMessage = null;
        }
        
        // ================ FONCTIONS D'AUTHENTIFICATION ================
        
        // Changer l'onglet dans l'écran d'authentification
        function changeAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                
                // Transition animée
                registerForm.style.animation = 'none';
                void registerForm.offsetWidth; // Forcer le reflow pour redémarrer l'animation
                registerForm.style.animation = '';
                
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                
                // Transition animée
                loginForm.style.animation = 'none';
                void loginForm.offsetWidth; // Forcer le reflow pour redémarrer l'animation
                loginForm.style.animation = '';
                
                loginForm.classList.remove('active');
                registerForm.classList.add('active');
            }
            
            // Masquer les messages d'erreur
            hideLog('login-log');
            hideLog('register-log');
            
            // Activer l'animation du formulaire qui apparaît
            const activeForm = tab === 'login' ? loginForm : registerForm;
            activeForm.style.animation = 'fadeUp 0.5s ease';
        }
        
        // Valider l'email de connexion
        function validateLoginEmail() {
            const email = document.getElementById('login-email').value.trim();
            const errorElement = document.getElementById('login-email-error');
            
            if (!email) {
                errorElement.textContent = 'L\'email est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (!isValidEmail(email)) {
                errorElement.textContent = 'Format d\'email invalide';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider le mot de passe de connexion
        function validateLoginPassword() {
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-password-error');
            
            if (!password) {
                errorElement.textContent = 'Le mot de passe est requis';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider l'email d'inscription
        function validateRegisterEmail() {
            const email = document.getElementById('register-email').value.trim();
            const errorElement = document.getElementById('register-email-error');
            
            if (!email) {
                errorElement.textContent = 'L\'email est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (!isValidEmail(email)) {
                errorElement.textContent = 'Format d\'email invalide';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider le mot de passe d'inscription
        function validateRegisterPassword() {
            const password = document.getElementById('register-password').value;
            const errorElement = document.getElementById('register-password-error');
            
            if (!password) {
                errorElement.textContent = 'Le mot de passe est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (password.length < 6) {
                errorElement.textContent = 'Le mot de passe doit contenir au moins 6 caractères';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider la confirmation du mot de passe
        function validateRegisterConfirmPassword() {
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const errorElement = document.getElementById('register-confirm-password-error');
            
            if (!confirmPassword) {
                errorElement.textContent = 'La confirmation du mot de passe est requise';
                errorElement.style.display = 'block';
                return false;
            } else if (password !== confirmPassword) {
                errorElement.textContent = 'Les mots de passe ne correspondent pas';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider le formulaire de connexion complet
        function validateLoginForm() {
            return validateLoginEmail() && validateLoginPassword();
        }
        
        // Valider le formulaire d'inscription complet
        function validateRegisterForm() {
            return validateRegisterEmail() && validateRegisterPassword() && validateRegisterConfirmPassword();
        }
        
        // Vérifier si un email est valide
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Afficher un message de log
        function showLog(elementId, text, type="info") {
            const logDiv = document.getElementById(elementId);
            logDiv.textContent = text;
            logDiv.className = `log-message ${type}`;
            logDiv.style.display = "block";
            
            // Ajouter une animation d'apparition
            logDiv.style.animation = 'fadeIn 0.5s ease';
        }
        
        // Masquer un message de log
        function hideLog(elementId) {
            const logDiv = document.getElementById(elementId);
            if (logDiv) {
                logDiv.style.display = "none";
            }
        }
        
        // Connexion d'un utilisateur
        async function loginUser() {
            // Validation finale avant de soumettre
            if (!validateLoginForm()) {
                return;
            }
            
            const email = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value;
            
            // Afficher le loader sur le bouton
            setButtonLoading('loginBtn', true);
            hideLog("login-log");
            
            try {
                showLog("login-log", "Connexion en cours...", "info");
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // Stocker les informations dans les variables globales
                currentUser = userCredential.user;
                
                showLog("login-log", "Connexion réussie ! Redirection...", "success");
                
                // Rediriger vers l'application après un court délai
                setTimeout(() => {
                    completeLogin();
                }, 1000);
            } catch (error) {
                let errorMessage = "Erreur de connexion";
                
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = "Email ou mot de passe incorrect.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "L'adresse email n'est pas valide.";
                        break;
                    case 'auth/user-disabled':
                        errorMessage = "Ce compte a été désactivé.";
                        break;
                    default:
                        errorMessage = "Erreur de connexion: " + error.message;
                }
                
                showLog("login-log", errorMessage, "error");
                setButtonLoading('loginBtn', false);
                
                // Animation de secousse sur le formulaire
                const loginForm = document.getElementById('login-form');
                loginForm.classList.add('shake');
                setTimeout(() => {
                    loginForm.classList.remove('shake');
                }, 600);
            }
        }
        
        // Inscription d'un utilisateur
        async function registerUser() {
            // Validation finale avant de soumettre
            if (!validateRegisterForm()) {
                return;
            }
            
            const email = document.getElementById("register-email").value.trim();
            const password = document.getElementById("register-password").value;
            
            // Afficher le loader sur le bouton
            setButtonLoading('registerBtn', true);
            hideLog("register-log");
            
            try {
                showLog("register-log", "Inscription en cours...", "info");
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;
                const statut = await createUserProfile(uid, email);
                
                showLog("register-log", `Inscription réussie ! Compte créé avec succès.`, "success");
                
                // Stocker les informations dans les variables globales
                currentUser = userCredential.user;
                
                // Rediriger vers l'application après un court délai
                setTimeout(() => {
                    completeLogin();
                }, 1500);
            } catch (error) {
                let errorMessage = "Erreur d'inscription";
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = "Cette adresse email est déjà utilisée.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "L'adresse email n'est pas valide.";
                        break;
                    case 'auth/weak-password':
                        errorMessage = "Le mot de passe est trop faible.";
                        break;
                    default:
                        errorMessage = "Erreur d'inscription: " + error.message;
                }
                
                showLog("register-log", errorMessage, "error");
                setButtonLoading('registerBtn', false);
                
                // Animation de secousse sur le formulaire
                const registerForm = document.getElementById('register-form');
                registerForm.classList.add('shake');
                setTimeout(() => {
                    registerForm.classList.remove('shake');
                }, 600);
            }
        }
        
        // Afficher/masquer le loader sur un bouton
        function setButtonLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            const loader = button.querySelector('.btn-loader');
            
            if (isLoading) {
                button.classList.add('loading');
                loader.style.display = 'inline-block';
            } else {
                button.classList.remove('loading');
                loader.style.display = 'none';
            }
        }
        
        // Création d'un profil utilisateur dans Firestore
        async function createUserProfile(uid, email) {
            try {
                // Vérifie si admin déjà défini
                const adminRef = doc(db, "Config", "admin");
                const adminSnap = await getDoc(adminRef);

                let statut = "simple";
                if (!adminSnap.exists()) {
                    statut = "admin";
                    // Crée l'admin dans Config
                    await setDoc(adminRef, {
                        uid: uid,
                        email: email,
                        createdAt: new Date().toISOString()
                    });
                }

                // Crée le profil utilisateur dans Users
                const userRef = doc(db, "Users", uid);
                await setDoc(userRef, {
                    email: email,
                    statut: statut,
                    createdAt: new Date().toISOString()
                });
                
                return statut;
            } catch (error) {
                console.error("Erreur lors de la création du profil:", error);
                return "simple";
            }
        }
        
        // Déconnexion de l'utilisateur
        async function logoutUser() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').querySelector('div:nth-child(3)').innerText = 'Déconnexion...';
            
            try {
                await signOut(auth);
                
                // Conserver le PIN si l'utilisateur l'a configuré
                const savedPin = localStorage.getItem('ichatUserPin');
                const pinEnabled = localStorage.getItem('ichatPinEnabled');
                
                // Réinitialiser les variables globales
                isLoggedIn = false;
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                
                // Rediriger vers l'écran de connexion
                showLoginScreen();
            } catch (error) {
                console.error("Erreur lors de la déconnexion:", error);
                // Masquer l'écran de chargement
                hideLoading();
            }
        }
        
        // Déconnexion depuis l'écran PIN
        function logoutFromPinScreen() {
            logoutUser();
        }
        
        // Suppression du compte utilisateur
        async function deleteAccount() {
            closeDeleteAccountDialog();
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').querySelector('div:nth-child(3)').innerText = 'Suppression du compte...';
            
            try {
                // Si l'utilisateur est connecté, supprimer son compte
                if (currentUser) {
                    // Supprimer les données de l'utilisateur de Firestore
                    await deleteDoc(doc(db, "Users", currentUser.uid));
                    
                    // Supprimer le compte Firebase Auth
                    await currentUser.delete();
                }
                
                // Effacer toutes les données locales
                localStorage.clear();
                
                // Réinitialiser les variables globales
                isLoggedIn = false;
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                
                // Afficher l'écran de connexion
                showLoginScreen();
            } catch (error) {
                console.error("Erreur lors de la suppression du compte:", error);
                
                // Masquer l'écran de chargement
                hideLoading();
                
                // Afficher une erreur
                showSuccessPopup(
                    'Erreur',
                    'Une erreur est survenue lors de la suppression du compte. Veuillez vous reconnecter et réessayer.',
                    () => {
                        document.getElementById('success-popup').classList.remove('active');
                    }
                );
            }
        }
        
        // Récupérer les données utilisateur de Firestore
        async function getUserData(uid) {
            try {
                const userRef = doc(db, "Users", uid);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    return { id: userSnap.id, ...userSnap.data() };
                } else {
                    console.error("Utilisateur non trouvé dans Firestore");
                    return null;
                }
            } catch (error) {
                console.error("Erreur lors de la récupération des données utilisateur:", error);
                return null;
            }
        }
        
        // ================ FONCTIONS POUR LE CODE PIN ================
        
        // Configurer le code PIN
        function setupPinCode() {
            const toggle = document.getElementById('pin-toggle');
            
            if (toggle.checked) {
                // Activer le PIN
                showPinSetupScreen();
            } else {
                // Désactiver le PIN
                isPinEnabled = false;
                localStorage.setItem('ichatPinEnabled', 'false');
                
                // Confirmation de désactivation
                showSuccessPopup(
                    'PIN désactivé',
                    'Le verrouillage par code PIN a été désactivé avec succès.',
                    () => {
                        document.getElementById('success-popup').classList.remove('active');
                    }
                );
            }
        }
        
        // Saisir un chiffre dans le PIN
        function enterPinDigit(digit) {
            if (tempPin.length < 4) {
                tempPin += digit;
                
                // Mettre à jour l'affichage des points
                const dots = document.querySelectorAll('#pin-dots .pin-dot');
                dots[tempPin.length - 1].classList.add('filled');
                
                // Effet de vibration pour feedback
                if (navigator.vibrate) {
                    navigator.vibrate(20);
                }
                
                // Si le PIN est complet, vérifier
                if (tempPin.length === 4) {
                    setTimeout(() => verifyPin(), 300);
                }
            }
        }
        
        // Vérifier le PIN saisi
        function verifyPin() {
            if (tempPin === userPin) {
                // PIN correct - cacher l'erreur
                document.getElementById('pin-error').classList.remove('visible');
                
                // Animation de succès
                document.querySelectorAll('#pin-dots .pin-dot').forEach(dot => {
                    dot.style.backgroundColor = 'var(--success-color)';
                    dot.style.borderColor = 'var(--success-color)';
                });
                
                // Si vibration disponible, faire un pattern de succès
                if (navigator.vibrate) {
                    navigator.vibrate([30, 50, 30]);
                }
                
                // Transition vers l'application
                setTimeout(() => {
                    tempPin = '';
                    completeLogin();
                }, 800);
                
            } else {
                // PIN incorrect - montrer l'erreur
                document.getElementById('pin-error').classList.add('visible');
                
                // Animation d'échec
                document.querySelectorAll('#pin-dots .pin-dot').forEach(dot => {
                    dot.style.backgroundColor = 'var(--danger-color)';
                    dot.style.borderColor = 'var(--danger-color)';
                    dot.classList.add('shake');
                });
                
                // Vibration d'erreur
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                // Réinitialiser après l'animation
                setTimeout(() => {
                    document.querySelectorAll('#pin-dots .pin-dot').forEach(dot => {
                        dot.classList.remove('filled');
                        dot.classList.remove('shake');
                        dot.style.backgroundColor = '';
                        dot.style.borderColor = '';
                    });
                    tempPin = '';
                }, 800);
            }
        }
        
        // Supprimer le dernier chiffre du PIN
        function deleteLastPinDigit() {
            if (tempPin.length > 0) {
                tempPin = tempPin.slice(0, -1);
                
                // Mettre à jour l'affichage des points
                const dots = document.querySelectorAll('#pin-dots .pin-dot');
                dots[tempPin.length].classList.remove('filled');
                
                // Effet de vibration pour feedback
                if (navigator.vibrate) {
                    navigator.vibrate(15);
                }
            }
        }
        
        // Annuler la saisie du PIN
        function cancelPin() {
            tempPin = '';
            
            // Réinitialiser l'affichage des points
            document.querySelectorAll('#pin-dots .pin-dot').forEach(dot => {
                dot.classList.remove('filled');
            });
            
            document.getElementById('pin-error').classList.remove('visible');
            
            // Effet de vibration pour feedback
            if (navigator.vibrate) {
                navigator.vibrate(15);
            }
        }
        
        // Mot de passe PIN oublié
        function forgotPin() {
            // En situation réelle, on enverrait un email ou SMS de récupération
            // Pour la démo, on désactive simplement le PIN
            localStorage.setItem('ichatPinEnabled', 'false');
            isPinEnabled = false;
            
            showSuccessPopup(
                'PIN réinitialisé',
                'Votre code PIN a été réinitialisé. Vous pouvez en configurer un nouveau dans les paramètres.',
                () => {
                    document.getElementById('success-popup').classList.remove('active');
                    completeLogin();
                }
            );
        }
        
        // Fonctions pour la configuration du PIN
        function enterSetupPinDigit(digit) {
            // Si nous sommes en mode configuration initiale
            if (!confirmPin) {
                if (tempPin.length < 4) {
                    tempPin += digit;
                    
                    // Mettre à jour l'affichage des points
                    document.querySelectorAll('#pin-setup-dots .pin-dot')[tempPin.length - 1].classList.add('filled');
                    
                    // Vibration pour feedback
                    if (navigator.vibrate) {
                        navigator.vibrate(20);
                    }
                    
                    // Si le PIN est complet, passer à la confirmation
                    if (tempPin.length === 4) {
                        setTimeout(() => {
                            // Animation de transition
                            document.getElementById('pin-setup-instruction').style.animation = 'fadeIn 0.5s ease';
                            document.getElementById('pin-setup-instruction').textContent = 'Confirmez votre code PIN';
                            
                            // Réinitialiser les points avec animation
                            document.querySelectorAll('#pin-setup-dots .pin-dot').forEach(dot => {
                                dot.classList.add('shake');
                                setTimeout(() => {
                                    dot.classList.remove('filled');
                                    dot.classList.remove('shake');
                                }, 300);
                            });
                            
                            confirmPin = '';
                        }, 500);
                    }
                }
            } 
            // Si nous sommes en mode confirmation
            else {
                if (confirmPin.length < 4) {
                    confirmPin += digit;
                    
                    // Mettre à jour l'affichage des points
                    document.querySelectorAll('#pin-setup-dots .pin-dot')[confirmPin.length - 1].classList.add('filled');
                    
                    // Vibration pour feedback
                    if (navigator.vibrate) {
                        navigator.vibrate(20);
                    }
                    
                    // Si la confirmation est complète, vérifier
                    if (confirmPin.length === 4) {
                        setTimeout(() => verifySetupPin(), 300);
                    }
                }
            }
        }
        
        // Vérifier le PIN de configuration
        function verifySetupPin() {
            if (tempPin === confirmPin) {
                // PINs correspondent
                userPin = tempPin;
                localStorage.setItem('ichatUserPin', userPin);
                localStorage.setItem('ichatPinEnabled', 'true');
                isPinEnabled = true;
                
                // Mettre à jour le toggle dans les paramètres
                document.getElementById('pin-toggle').checked = true;
                
                // Animation de succès
                document.querySelectorAll('#pin-setup-dots .pin-dot').forEach(dot => {
                    dot.style.backgroundColor = 'var(--success-color)';
                    dot.style.borderColor = 'var(--success-color)';
                });
                
                // Vibration pattern pour succès
                if (navigator.vibrate) {
                    navigator.vibrate([30, 50, 30, 50, 30]);
                }
                
                // Fermer l'écran de configuration avec transition
                setTimeout(() => {
                    document.getElementById('pin-setup-screen').classList.remove('active');
                    
                    // Réinitialiser les styles
                    document.querySelectorAll('#pin-setup-dots .pin-dot').forEach(dot => {
                        dot.style.backgroundColor = '';
                        dot.style.borderColor = '';
                        dot.classList.remove('filled');
                    });
                    
                    // Montrer une confirmation
                    showSuccessPopup(
                        'PIN configuré',
                        'Votre code PIN a été configuré avec succès. L\'application sera désormais protégée par ce code.',
                        () => {
                            document.getElementById('success-popup').classList.remove('active');
                        }
                    );
                }, 800);
            } else {
                // PINs ne correspondent pas
                document.getElementById('pin-setup-error').textContent = 'Les codes PIN ne correspondent pas. Veuillez réessayer.';
                document.getElementById('pin-setup-error').classList.add('visible');
                
                // Animation d'erreur
                document.querySelectorAll('#pin-setup-dots .pin-dot').forEach(dot => {
                    dot.style.backgroundColor = 'var(--danger-color)';
                    dot.style.borderColor = 'var(--danger-color)';
                    dot.classList.add('shake');
                });
                
                // Vibration d'erreur
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                // Réinitialiser pour une nouvelle tentative
                setTimeout(() => {
                    document.querySelectorAll('#pin-setup-dots .pin-dot').forEach(dot => {
                        dot.classList.remove('filled');
                        dot.classList.remove('shake');
                        dot.style.backgroundColor = '';
                        dot.style.borderColor = '';
                    });
                    
                    // Retour à la saisie initiale avec animation
                    document.getElementById('pin-setup-instruction').style.animation = 'fadeIn 0.5s ease';
                    document.getElementById('pin-setup-instruction').textContent = 'Créez un code PIN à 4 chiffres pour sécuriser votre application';
                    document.getElementById('pin-setup-error').classList.remove('visible');
                    
                    tempPin = '';
                    confirmPin = '';
                }, 800);
            }
        }
        
        // Supprimer le dernier chiffre du PIN de configuration
        function deleteLastSetupPinDigit() {
            if (!confirmPin && tempPin.length > 0) {
                tempPin = tempPin.slice(0, -1);
                document.querySelectorAll('#pin-setup-dots .pin-dot')[tempPin.length].classList.remove('filled');
            } else if (confirmPin && confirmPin.length > 0) {
                confirmPin = confirmPin.slice(0, -1);
                document.querySelectorAll('#pin-setup-dots .pin-dot')[confirmPin.length].classList.remove('filled');
            }
            
            // Effet de vibration pour feedback
            if (navigator.vibrate) {
                navigator.vibrate(15);
            }
        }
        
        // Annuler la configuration du PIN
        function cancelPinSetup() {
            // Animation de fermeture
            document.getElementById('pin-setup-screen').classList.add('fadeOut');
            
            setTimeout(() => {
                document.getElementById('pin-setup-screen').classList.remove('active');
                document.getElementById('pin-setup-screen').classList.remove('fadeOut');
                
                // Réinitialiser l'état
                document.querySelectorAll('#pin-setup-dots .pin-dot').forEach(dot => {
                    dot.classList.remove('filled');
                });
                
                // Réinitialiser le toggle dans les paramètres
                document.getElementById('pin-toggle').checked = isPinEnabled;
                
                tempPin = '';
                confirmPin = '';
            }, 300);
        }
        
        // ================ FONCTIONS POUR L'AFFICHAGE ================
        
        // Masquer l'écran de chargement
        function hideLoading() {
            const loadingScreen = document.getElementById('loading');
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }
        
        // Afficher l'écran de connexion
        function showLoginScreen() {
            hideLoading();
            
            // Animation d'apparition
            document.getElementById('auth-screen').style.opacity = '0';
            document.getElementById('auth-screen').style.display = 'flex';
            
            setTimeout(() => {
                document.getElementById('auth-screen').style.opacity = '1';
                document.getElementById('auth-screen').style.transition = 'opacity 0.5s ease';
            }, 10);
            
            document.getElementById('pin-lock-screen').style.display = 'none';
            document.getElementById('pin-setup-screen').style.display = 'none';
            
            // Pour permettre le défilement lors de l'inscription/connexion
            document.body.style.overflow = 'auto';
        }
        
        // Afficher l'écran de verrouillage par PIN
        function showPinLockScreen() {
            hideLoading();
            
            // Animation d'apparition
            document.getElementById('pin-lock-screen').style.opacity = '0';
            document.getElementById('pin-lock-screen').style.display = 'flex';
            
            setTimeout(() => {
                document.getElementById('pin-lock-screen').style.opacity = '1';
                document.getElementById('pin-lock-screen').style.transition = 'opacity 0.5s ease';
            }, 10);
            
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('pin-setup-screen').style.display = 'none';
            
            // Réinitialiser les points de PIN
            document.querySelectorAll('#pin-dots .pin-dot').forEach(dot => {
                dot.classList.remove('filled');
            });
            
            document.getElementById('pin-error').classList.remove('visible');
            document.body.style.overflow = 'hidden';
        }
        
        // Afficher l'écran de configuration de PIN
        function showPinSetupScreen() {
            isPinSetupMode = true;
            tempPin = '';
            confirmPin = '';
            
            document.getElementById('pin-setup-screen').classList.add('active');
            document.getElementById('pin-setup-instruction').textContent = 'Créez un code PIN à 4 chiffres pour sécuriser votre application';
            
            // Réinitialiser les points de PIN
            document.querySelectorAll('#pin-setup-dots .pin-dot').forEach(dot => {
                dot.classList.remove('filled');
            });
            
            document.getElementById('pin-setup-error').classList.remove('visible');
            document.getElementById('pin-setup-error').textContent = '';
        }
        
        // Compléter le processus de connexion
        function completeLogin() {
            hideLoading();
            
            // Animer la transition
            const elements = [
                document.getElementById('auth-screen'),
                document.getElementById('pin-lock-screen'),
                document.getElementById('pin-setup-screen')
            ];
            
            elements.forEach(el => {
                if (el.style.display !== 'none') {
                    el.style.opacity = '0';
                    el.style.transition = 'opacity 0.5s ease';
                    
                    setTimeout(() => {
                        el.style.display = 'none';
                    }, 500);
                }
            });
            
            // Animation d'apparition pour l'application principale
            setTimeout(() => {
                document.getElementById('tabbar').style.opacity = '0';
                document.getElementById('tabbar').style.display = 'flex';
                
                document.querySelector('.header').style.opacity = '0';
                document.querySelector('.header').style.display = 'flex';
                
                document.querySelector('.content').style.opacity = '0';
                document.querySelector('.content').style.display = 'block';
                
                setTimeout(() => {
                    document.getElementById('tabbar').style.opacity = '1';
                    document.getElementById('tabbar').style.transition = 'opacity 0.5s ease';
                    
                    document.querySelector('.header').style.opacity = '1';
                    document.querySelector('.header').style.transition = 'opacity 0.5s ease';
                    
                    document.querySelector('.content').style.opacity = '1';
                    document.querySelector('.content').style.transition = 'opacity 0.5s ease';
                    
                    // Chargement des données initiales
                    loadInitialData();
                }, 10);
            }, 500);
            
            // Mettre à jour les informations du profil
            updateProfileInfo();
            
            // Mettre à jour le toggle de PIN
            document.getElementById('pin-toggle').checked = isPinEnabled;
            
            // Mettre à jour l'interface
            document.body.style.overflow = 'hidden';
        }
        
        // Charger les données initiales de l'application
        async function loadInitialData() {
            // Charger les conversations
            loadConversations();
            
            // Charger les utilisateurs
            loadUsers();
        }
        
        // Mettre à jour les informations du profil
        function updateProfileInfo() {
            if (currentUserData) {
                // Mettre à jour le nom et l'email
                document.getElementById('profile-name-text').textContent = currentUserData.email.split('@')[0];
                document.getElementById('profile-email').textContent = currentUserData.email;
                
                // Afficher le badge admin si nécessaire
                if (currentUserData.statut === 'admin') {
                    document.getElementById('admin-badge').style.display = 'inline-block';
                } else {
                    document.getElementById('admin-badge').style.display = 'none';
                }
            }
        }
        
        // Afficher une popup de succès
        function showSuccessPopup(title, message, callback) {
            document.getElementById('success-title').textContent = title;
            document.getElementById('success-message').textContent = message;
            document.getElementById('success-button').onclick = callback || (() => {
                document.getElementById('success-popup').classList.remove('active');
            });
            
            // Animation d'apparition
            document.getElementById('success-popup').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // ================ FONCTIONS POUR LES MESSAGES ================
        
        // Données pour simuler les conversations
        const chatMessages = {
            'Marie Dupont': [
                { id: 'md1', text: 'Bonjour, comment vas-tu aujourd\'hui?', from: 'them', time: '14:00' },
                { id: 'md2', text: 'Je vais bien, merci ! Et toi ?', from: 'me', time: '14:05' },
                { id: 'md3', text: 'Très bien ! Tu fais quoi ce weekend ?', from: 'them', time: '14:10' },
                { id: 'md4', text: 'Rien de spécial, pourquoi ?', from: 'me', time: '14:15' },
                { id: 'md5', text: 'On pourrait aller au cinéma ?', from: 'them', time: '14:23' }
            ],
            'Pierre Martin': [
                { id: 'pm1', text: 'Salut, tu as reçu mon email ?', from: 'them', time: '13:30' },
                { id: 'pm2', text: 'Oui, je l\'ai lu ce matin', from: 'me', time: '13:45' },
                { id: 'pm3', text: 'Super ! Alors on se voit demain pour le déjeuner?', from: 'them', time: '14:00' }
            ],
            'Sophie Leroy': [
                { id: 'sl1', text: 'J\'ai besoin de ton aide pour un projet', from: 'them', time: 'Lun 10:15' },
                { id: 'sl2', text: 'Bien sûr, comment je peux t\'aider ?', from: 'me', time: 'Lun 10:30' },
                { id: 'sl3', text: 'Je t\'envoie les détails par email', from: 'them', time: 'Lun 11:00' },
                { id: 'sl4', text: 'Pas de problème, je vais regarder ça', from: 'me', time: 'Lun 11:15' },
                { id: 'sl5', text: 'Merci pour ton aide!', from: 'them', time: 'Lun 15:45' }
            ],
            'Thomas Bernard': [
                { id: 'tb1', text: 'As-tu reçu les documents que je t\'ai envoyés ?', from: 'them', time: 'Dim 09:20' },
                { id: 'tb2', text: 'Non, pas encore. Tu les as envoyés quand ?', from: 'me', time: 'Dim 10:45' },
                { id: 'tb3', text: 'Ce matin. Je te les renvoie', from: 'them', time: 'Dim 11:30' },
                { id: 'tb4', text: 'D\'accord, merci', from: 'me', time: 'Dim 11:45' },
                { id: 'tb5', text: 'J\'ai envoyé les documents par email.', from: 'them', time: 'Dim 14:00' }
            ],
            'Betforce': [
                { id: 'bg1', text: 'Bienvenue à tous dans le groupe !', from: 'pierre', time: '14:30' },
                { id: 'bg2', text: 'Merci Pierre pour la création du groupe !', from: 'sophie', time: '14:31' },
                { id: 'bg3', text: 'Bonjour tout le monde, content de vous retrouver ici', from: 'me', time: '14:32' },
                { id: 'bg4', text: 'Super initiative ! On va pouvoir échanger facilement', from: 'marie', time: '14:33' },
                { id: 'bg5', text: 'Est-ce que tout le monde est disponible ce week-end ?', from: 'thomas', time: '14:35' }
            ]
        };
        
        // Charger les conversations dans la liste
        function loadConversations() {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';
            
            // Si aucune conversation
            if (Object.keys(chatMessages).length === 0) {
                chatList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <div class="empty-state-title">Aucune conversation</div>
                        <div class="empty-state-text">Vos conversations apparaîtront ici</div>
                    </div>
                `;
                return;
            }
            
            // Créer les éléments pour chaque conversation
            const conversations = [
                {
                    name: 'Betforce',
                    isGroup: true,
                    lastMessage: 'Est-ce que tout le monde est disponible ce week-end ?',
                    lastSender: 'thomas',
                    time: '14:35'
                },
                {
                    name: 'Marie Dupont',
                    lastMessage: 'On pourrait aller au cinéma ?',
                    time: '14:23'
                },
                {
                    name: 'Pierre Martin',
                    lastMessage: 'Super ! Alors on se voit demain pour le déjeuner?',
                    time: '14:00'
                },
                {
                    name: 'Sophie Leroy',
                    lastMessage: 'Merci pour ton aide!',
                    time: 'Lun'
                },
                {
                    name: 'Thomas Bernard',
                    lastMessage: 'J\'ai envoyé les documents par email.',
                    time: 'Dim'
                }
            ];
            
            conversations.forEach(conv => {
                const isBlocked = blockedUsers.has(conv.name);
                
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item selectable-item ${isBlocked ? 'blocked' : ''}`;
                chatItem.setAttribute('data-contact', conv.name);
                if (conv.isGroup) {
                    chatItem.setAttribute('data-is-group', 'true');
                }
                
                chatItem.innerHTML = `
                    <div class="select-indicator">
                        <div class="select-indicator-inner"></div>
                    </div>
                    <div class="item-select-checkbox"></div>
                    <div class="${conv.isGroup ? 'group-pic' : 'profile-pic'}">
                        <i class="fas fa-${conv.isGroup ? 'users' : 'user'}" style="color: ${conv.isGroup ? 'white' : 'var(--primary-color)'};"></i>
                    </div>
                    <div class="item-content">
                        <div style="display: flex; justify-content: space-between;">
                            <div class="item-title">${conv.name}</div>
                            <div class="item-time">${conv.time}</div>
                        </div>
                        <div class="item-subtitle">
                            ${isBlocked ? 'Utilisateur bloqué' : 
                              (conv.isGroup && conv.lastSender !== 'me' ? 
                                `<strong>${getDisplayName(conv.lastSender)}:</strong> ${conv.lastMessage}` : 
                                conv.lastMessage)}
                        </div>
                    </div>
                    <i class="fas fa-check-circle check-circle"></i>
                `;
                
                // Ajouter les événements
                chatItem.addEventListener('click', function(event) {
                    handleChatItemClick(event, this, conv.name);
                });
                
                // Gestion du glissement horizontal pour la sélection
                setupSwipeSelection(chatItem);
                
                chatList.appendChild(chatItem);
            });
        }
        
        // Configurer le glissement pour la sélection des conversations
        function setupSwipeSelection(item) {
            let startX, moveX;
            let selecting = false;
            
            item.addEventListener('touchstart', function(e) {
                if (isSelectionMode) return;
                startX = e.touches[0].clientX;
            });
            
            item.addEventListener('touchmove', function(e) {
                if (isSelectionMode) return;
                moveX = e.touches[0].clientX;
                let deltaX = moveX - startX;
                
                // Ignorer les groupes dans la sélection par swipe
                if (this.getAttribute('data-is-group') === 'true') {
                    return;
                }
                
                // Si l'utilisateur glisse vers la droite de manière significative
                if (deltaX > 30 && !selecting) {
                    item.classList.add('swipe-selecting');
                    selecting = true;
                    
                    // Vibration pour feedback tactile
                    if (navigator.vibrate) {
                        navigator.vibrate(30);
                    }
                } else if (deltaX < 10 && selecting) {
                    item.classList.remove('swipe-selecting');
                    selecting = false;
                }
            });
            
            item.addEventListener('touchend', function(e) {
                if (isSelectionMode) return;
                
                // Ignorer les groupes dans la sélection par swipe
                if (this.getAttribute('data-is-group') === 'true') {
                    this.classList.remove('swipe-selecting');
                    selecting = false;
                    return;
                }
                
                // Si l'élément est en mode "swipe selecting"
                if (selecting) {
                    // Démarrer le mode de sélection si ce n'est pas déjà fait
                    if (!isSelectionMode) {
                        startConversationsSelectionMode();
                    }
                    
                    // Sélectionner cet élément
                    const contactName = this.getAttribute('data-contact');
                    toggleItemSelection(this, contactName, true);
                    
                    this.classList.remove('swipe-selecting');
                    selecting = false;
                }
            });
            
            // Pour le maintien long (longpress)
            let longPressTimer;
            
            item.addEventListener('touchstart', function(e) {
                if (isSelectionMode) return;
                
                // Ignorer les groupes dans la sélection par longpress
                if (this.getAttribute('data-is-group') === 'true') {
                    return;
                }
                
                const contactName = this.getAttribute('data-contact');
                
                longPressTimer = setTimeout(() => {
                    startConversationsSelectionMode();
                    toggleItemSelection(this, contactName, true);
                    
                    // Vibration pour feedback tactile
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }, 500); // longPressDuration
            });
            
            item.addEventListener('touchmove', function() {
                clearTimeout(longPressTimer);
            });
            
            item.addEventListener('touchend', function() {
                clearTimeout(longPressTimer);
            });
        }
        
        // Gestion des clics sur les éléments sélectionnables
        function handleChatItemClick(event, item, contactName) {
            // Si en mode sélection, cette fonction gère les sélections
            if (isSelectionMode) {
                event.preventDefault();
                event.stopPropagation();
                
                // Ignorer les groupes dans la sélection
                if (item.getAttribute('data-is-group') === 'true') {
                    return;
                }
                
                // Si c'est déjà sélectionné, on désélectionne
                if (selectedItems.has(contactName)) {
                    toggleItemSelection(item, contactName, false);
                } else {
                    // Sinon on sélectionne
                    toggleItemSelection(item, contactName, true);
                }
                return;
            }
            
            // Vérifier si l'élément est sélectionné avant d'ouvrir le chat
            const isSelected = item.classList.contains('selected');
            if (isSelected) {
                // Si sélectionné, on ne fait rien - l'utilisateur doit d'abord désélectionner
                return;
            }
            
            // Si ce n'est pas en mode sélection et pas sélectionné, ouvrir la conversation
            openChat(contactName);
        }
        
        // Charger la liste des utilisateurs
        function loadUsers() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            
            // Liste des utilisateurs simulée
            const users = [
                { name: 'Marie Dupont', status: 'En ligne' },
                { name: 'Pierre Martin', status: 'Dernière connexion à 13:42' },
                { name: 'Sophie Leroy', status: 'En ligne' },
                { name: 'Thomas Bernard', status: 'Hors ligne' }
            ];
            
            // Si aucun utilisateur
            if (users.length === 0) {
                usersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <div class="empty-state-title">Aucun utilisateur</div>
                        <div class="empty-state-text">Les utilisateurs apparaîtront ici</div>
                    </div>
                `;
                return;
            }
            
            // Créer les éléments pour chaque utilisateur
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item selectable-item';
                
                userItem.innerHTML = `
                    <div class="item-select-checkbox"></div>
                    <div class="profile-pic">
                        <i class="fas fa-user" style="color: var(--primary-color);"></i>
                    </div>
                    <div class="item-content">
                        <div class="item-title">${user.name}</div>
                        <div class="item-subtitle">${user.status}</div>
                    </div>
                `;
                
                // Ajouter les événements
                userItem.addEventListener('click', () => openChat(user.name));
                
                usersList.appendChild(userItem);
            });
        }
        
        // Charger les messages d'une conversation
        function loadChatMessages(contact) {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            // S'assurer que le bouton retour reste correct
            document.getElementById('header-left').innerHTML = '<div class="back-button"><i class="fas fa-chevron-left"></i></div>';
            document.getElementById('header-left').querySelector('.back-button').addEventListener('click', closeChat);
            
            // Déterminer si c'est une conversation de groupe ou individuelle
            const isGroup = (contact === 'Betforce');
            const messageList = isGroup ? chatMessages['Betforce'] : chatMessages[contact];
            
            if (messageList && messageList.length > 0) {
                // Créer un fragment pour améliorer les performances
                const fragment = document.createDocumentFragment();
                
                // Ajouter les messages dans l'ordre chronologique
                messageList.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    
                    // Pour un groupe, le style des messages dépend de l'expéditeur
                    if (isGroup) {
                        if (msg.from === 'me') {
                            messageDiv.className = 'message message-sent';
                        } else {
                            messageDiv.className = 'message message-received';
                            
                            // Ajouter le nom de l'expéditeur pour les messages de groupe
                            const senderName = document.createElement('div');
                            senderName.className = `message-sender sender-${msg.from}`;
                            senderName.textContent = getDisplayName(msg.from);
                            messageDiv.appendChild(senderName);
                        }
                    } else {
                        messageDiv.className = 'message ' + (msg.from === 'me' ? 'message-sent' : 'message-received');
                    }
                    
                    messageDiv.setAttribute('data-id', msg.id);
                    messageDiv.setAttribute('data-from', msg.from);
                    
                    // Si c'est une réponse à un autre message
                    if (msg.replyTo) {
                        const quotedDiv = document.createElement('div');
                        // Ajouter des classes différentes selon l'expéditeur du message cité
                        const fromClass = msg.replyTo.from === 'me' ? 'from-me' : 'from-them';
                        quotedDiv.className = 'quoted-message ' + fromClass;
                        
                        const quotedSender = document.createElement('div');
                        quotedSender.className = 'quoted-sender ' + fromClass;
                        
                        // Dans un groupe, utiliser le nom approprié
                        if (isGroup) {
                            quotedSender.textContent = getDisplayName(msg.replyTo.from);
                            quotedSender.className += ' sender-' + msg.replyTo.from;
                        } else {
                            quotedSender.textContent = msg.replyTo.from === 'me' ? 'Vous' : contact;
                        }
                        
                        const quotedContent = document.createElement('div');
                        quotedContent.className = 'quoted-content';
                        quotedContent.textContent = msg.replyTo.text;
                        
                        quotedDiv.appendChild(quotedSender);
                        quotedDiv.appendChild(quotedContent);
                        messageDiv.appendChild(quotedDiv);
                    }
                    
                    const messageText = document.createElement('div');
                    messageText.textContent = msg.text;
                    
                    messageDiv.appendChild(messageText);
                    
                    if (msg.image) {
                        const messageImage = document.createElement('img');
                        messageImage.className = 'message-image';
                        messageImage.src = msg.image;
                        messageImage.alt = 'Image';
                        messageDiv.appendChild(messageImage);
                    }
                    
                    const messageTime = document.createElement('div');
                    messageTime.className = 'message-time';
                    messageTime.textContent = msg.time;
                    messageDiv.appendChild(messageTime);
                    
                    // Ajouter les réactions si elles existent
                    if (messageReactions[msg.id] && Object.keys(messageReactions[msg.id]).length > 0) {
                        const reactionsContainer = document.createElement('div');
                        reactionsContainer.className = 'message-reactions';
                        
                        Object.entries(messageReactions[msg.id]).forEach(([emoji, count]) => {
                            const reaction = document.createElement('div');
                            reaction.className = 'message-reaction';
                            reaction.innerHTML = `${emoji} <span class="reaction-count">${count}</span>`;
                            reactionsContainer.appendChild(reaction);
                        });
                        
                        messageDiv.appendChild(reactionsContainer);
                    }
                    
                    // Ajouter les gestionnaires d'événements
                    addMessageEventListeners(messageDiv);
                    
                    fragment.appendChild(messageDiv);
                });
                
                // Après l'ajout de tous les messages, créer un élément div pour le clearfix
                const clearfix = document.createElement('div');
                clearfix.style.clear = 'both';
                fragment.appendChild(clearfix);
                
                messagesContainer.appendChild(fragment);
            } else {
                // Aucun message
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                        Aucun message. Commencez la conversation !
                    </div>
                `;
            }
            
            // Faire défiler vers le bas pour voir les messages les plus récents
            const chatMessagesContainer = document.querySelector('.chat-messages-container');
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
        
        // Ajouter des gestionnaires d'événements aux messages
        function addMessageEventListeners(messageElement) {
            // Gestion du double tap pour les réactions
            messageElement.addEventListener('click', function(e) {
                if (isSelectionMode && selectionModeType === 'messages') {
                    toggleMessageSelection(this);
                    e.preventDefault();
                    return;
                }
                
                const now = new Date().getTime();
                const timeSince = now - lastTap;
                
                // Pour le double tap, il doit être le même élément
                if (timeSince < 300 && timeSince > 0 && currentTappedMessage === this) {
                    // Double tap détecté
                    e.preventDefault();
                    
                    // Afficher le panneau de réactions
                    const messageId = this.getAttribute('data-id');
                    const messageRect = this.getBoundingClientRect();
                    const messageCenter = messageRect.left + messageRect.width / 2;
                    const windowWidth = window.innerWidth;
                    
                    // Positionner le panneau au-dessus du message
                    const panelLeft = Math.min(
                        Math.max(messageCenter - 150, 10), // Ne pas dépasser à gauche
                        windowWidth - 300 - 10 // Ne pas dépasser à droite
                    );
                    
                    showReactionPanel(messageId, panelLeft, messageRect.top - 60);
                    
                    // Vibration pour feedback tactile
                    if (navigator.vibrate) {
                        navigator.vibrate(30);
                    }
                    
                    // Réinitialiser pour éviter des doubles détections
                    lastTap = 0;
                } else {
                    // Premier tap
                    lastTap = now;
                    currentTappedMessage = this;
                }
            });
            
            // Gestion des événements tactiles pour le glissement
            let swipeStartX, swipeStartY;
            
            messageElement.addEventListener('touchstart', function(e) {
                if (isSelectionMode) return;
                
                const touch = e.touches[0];
                swipeStartX = touch.clientX;
                swipeStartY = touch.clientY;
            });
            
            messageElement.addEventListener('touchmove', function(e) {
                if (isSelectionMode) return;
                
                if (!e.touches[0]) return;
                
                const touch = e.touches[0];
                const deltaX = touch.clientX - swipeStartX;
                const deltaY = Math.abs(touch.clientY - swipeStartY);
                
                // Si le déplacement est plus horizontal que vertical
                if (Math.abs(deltaX) > deltaY && Math.abs(deltaX) > 10) {
                    this.style.transform = `translateX(${deltaX / 2}px)`;
                }
            });
            
            messageElement.addEventListener('touchend', function(e) {
                if (isSelectionMode) return;
                
                const touch = e.changedTouches[0];
                const deltaX = touch.clientX - swipeStartX;
                
                // Réponse automatique au swipe
                handleSwipe(this, deltaX > 0 ? 'right' : 'left', Math.abs(deltaX));
                
                // Réinitialiser la position
                this.style.transform = 'translateX(0)';
            });
            
            // Gestion du clic droit (pour les ordinateurs)
            messageElement.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                
                // Utiliser le clic droit pour la sélection directe
                if (!isSelectionMode) {
                    startMessagesSelectionMode();
                }
                toggleMessageSelection(this);
                
                return false;
            });
        }
        
        // Gérer le glissement de message - automatiquement sélectionner pour répondre
        function handleSwipe(messageElement, direction, distance) {
            if (isSelectionMode) return;
            
            // Réinitialiser tous les autres messages
            document.querySelectorAll('.message').forEach(msg => {
                if (msg !== messageElement) {
                    msg.style.transform = 'translateX(0)';
                }
            });
            
            if (Math.abs(distance) > 30) {
                // Déclencher l'animation de sélection
                messageElement.classList.add('replying');
                
                // Après l'animation, préparer la réponse
                setTimeout(() => {
                    const messageId = messageElement.getAttribute('data-id');
                    replyToMessageAction(messageId);
                    messageElement.classList.remove('replying');
                }, 500);
            }
        }
        
        // Préparer une réponse à un message
        function replyToMessageAction(messageId) {
            // Trouver le message
            let message = null;
            const messageList = currentContact === 'Betforce' ? 
                chatMessages['Betforce'] : chatMessages[currentContact];
            
            for (let i = 0; i < messageList.length; i++) {
                if (messageList[i].id === messageId) {
                    message = messageList[i];
                    break;
                }
            }
            
            if (!message) return;
            
            // Stocker la référence pour l'envoi
            replyToMessage = message;
            
            // Focus sur l'input
            document.getElementById('chat-input').focus();
            
            // Vibration pour feedback tactile
            if (navigator.vibrate) {
                navigator.vibrate([30, 50, 30]);
            }
        }
        
        // Afficher le panneau de réactions
        function showReactionPanel(messageId, x, y) {
            const reactionPanel = document.getElementById('reaction-panel');
            
            // Positionner le panel près du message
            reactionPanel.style.left = `${x}px`;
            reactionPanel.style.top = `${y}px`;
            reactionPanel.style.display = 'flex';
            
            // Stocker le message ID pour la réaction
            reactionPanel.setAttribute('data-message-id', messageId);
            
            // Gestionnaire pour masquer le panel quand on clique ailleurs
            document.addEventListener('click', hideReactionPanel);
            
            // Ajouter les gestionnaires pour chaque émoji
            document.querySelectorAll('.reaction-emoji').forEach(emoji => {
                emoji.onclick = function(e) {
                    e.stopPropagation();
                    const emojiValue = this.getAttribute('data-emoji');
                    addReaction(messageId, emojiValue);
                    hideReactionPanel();
                };
            });
        }
        
        // Masquer le panel de réactions
        function hideReactionPanel() {
            document.getElementById('reaction-panel').style.display = 'none';
            document.removeEventListener('click', hideReactionPanel);
        }
        
        // Ajouter une réaction à un message
        function addReaction(messageId, emoji) {
            if (!messageReactions[messageId]) {
                messageReactions[messageId] = {};
            }
            
            if (!messageReactions[messageId][emoji]) {
                messageReactions[messageId][emoji] = 0;
            }
            
            messageReactions[messageId][emoji]++;
            
            // Mettre à jour l'affichage des réactions
            updateMessageReactions(messageId);
            
            // Effet de vibration pour feedback
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
        }
        
        // Mettre à jour l'affichage des réactions
        function updateMessageReactions(messageId) {
            const message = document.querySelector(`.message[data-id="${messageId}"]`);
            if (!message) return;
            
            // Supprimer les réactions existantes
            let reactionsContainer = message.querySelector('.message-reactions');
            if (reactionsContainer) {
                reactionsContainer.remove();
            }
            
            // S'il n'y a pas de réactions, ne rien faire
            if (!messageReactions[messageId] || Object.keys(messageReactions[messageId]).length === 0) {
                return;
            }
            
            // Créer un nouveau conteneur pour les réactions
            reactionsContainer = document.createElement('div');
            reactionsContainer.className = 'message-reactions';
            
            // Ajouter chaque réaction
            Object.entries(messageReactions[messageId]).forEach(([emoji, count]) => {
                const reaction = document.createElement('div');
                reaction.className = 'message-reaction';
                reaction.innerHTML = `${emoji} <span class="reaction-count">${count}</span>`;
                reactionsContainer.appendChild(reaction);
            });
            
            // Ajouter le conteneur au message
            message.appendChild(reactionsContainer);
        }
        
        // Envoyer un message
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if ((message === '' && !selectedImage) || blockedUsers.has(currentContact)) return;
            
            const now = new Date();
            const time = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
            const messageId = 'msg_' + Date.now(); // Id unique basé sur le timestamp
            
            // Préparer le nouvel objet message
            const newMessage = {
                id: messageId,
                text: message,
                from: 'me',
                time: time
            };
            
            // Ajouter la référence au message répondu si existant
            if (replyToMessage) {
                newMessage.replyTo = replyToMessage;
                replyToMessage = null;
            }
            
            // Ajouter l'image si disponible
            if (selectedImage) {
                newMessage.image = document.getElementById('preview-img').src;
                clearImagePreview();
            }
            
            // Ajouter le message à la liste des messages appropriée
            if (currentContact === 'Betforce') {
                if (!chatMessages['Betforce']) {
                    chatMessages['Betforce'] = [];
                }
                chatMessages['Betforce'].push(newMessage);
            } else {
                if (!chatMessages[currentContact]) {
                    chatMessages[currentContact] = [];
                }
                chatMessages[currentContact].push(newMessage);
            }
            
            // Recharger les messages
            loadChatMessages(currentContact);
            
            // Mettre à jour l'aperçu de la conversation
            updateChatPreview(currentContact, "me", message || "Image envoyée");
            
            // Vider l'entrée
            input.value = '';
            
            // Simuler une réponse après 1-3 secondes (sauf si utilisateur bloqué)
            if (!blockedUsers.has(currentContact)) {
                // Montrer l'indicateur de frappe
                await showTypingIndicator();
                
                // Générer la réponse
                const responses = [
                    "D'accord, je vois.",
                    "Je comprends !",
                    "Intéressant...",
                    "Merci pour cette information.",
                    "Très bien !",
                    "Je suis d'accord avec toi."
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                const responseTime = (parseInt(time.split(':')[0]) + (Math.random() > 0.5 ? 0 : 1)) + ':' + 
                    Math.floor(Math.random() * 60).toString().padStart(2, '0');
                const responseId = 'msg_' + (Date.now() + 1);
                
                // Déterminer qui répond dans le groupe
                let responderId = 'them';
                if (currentContact === 'Betforce') {
                    // Choisir un membre aléatoire du groupe pour répondre
                    const members = ['marie', 'pierre', 'sophie', 'thomas'];
                    responderId = members[Math.floor(Math.random() * members.length)];
                }
                
                // Ajouter la réponse
                if (currentContact === 'Betforce') {
                    chatMessages['Betforce'].push({
                        id: responseId,
                        text: randomResponse,
                        from: responderId,
                        time: responseTime
                    });
                } else {
                    chatMessages[currentContact].push({
                        id: responseId,
                        text: randomResponse,
                        from: 'them',
                        time: responseTime
                    });
                }
                
                loadChatMessages(currentContact);
                
                // Mise à jour de l'aperçu de la conversation 
                updateChatPreview(currentContact, responderId, randomResponse);
            }
        }
        
        // Simuler le statut "en train d'écrire"
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            document.getElementById('typing-name').textContent = currentContact;
            typingIndicator.classList.add('active');
            
            // Faire défiler vers le bas pour voir l'indicateur
            const chatMessagesContainer = document.querySelector('.chat-messages-container');
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            
            return new Promise(resolve => {
                setTimeout(() => {
                    typingIndicator.classList.remove('active');
                    resolve();
                }, 1500 + Math.random() * 1000); // Durée aléatoire entre 1.5 et 2.5 secondes
            });
        }
        
        // Mettre à jour l'aperçu d'une conversation dans la liste
        function updateChatPreview(contact, sender, text) {
            if (!contact || contact === '') return;
            
            const chatItems = document.querySelectorAll('.chat-item');
            for (let i = 0; i < chatItems.length; i++) {
                if (chatItems[i].getAttribute('data-contact') === contact) {
                    const subtitle = chatItems[i].querySelector('.item-subtitle');
                    const time = chatItems[i].querySelector('.item-time');
                    
                    if (sender === "Système") {
                        subtitle.innerHTML = '<i class="fas fa-info-circle" style="margin-right: 5px; color: var(--primary-color);"></i> ' + text;
                    } else if (contact === "Betforce" && sender !== "me") {
                        // Pour le groupe, afficher le nom de l'expéditeur
                        subtitle.innerHTML = '<strong>' + getDisplayName(sender) + ':</strong> ' + text;
                    } else {
                        subtitle.textContent = text;
                    }
                    
                    // Mettre à jour l'heure
                    const now = new Date();
                    time.textContent = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
                    
                    break;
                }
            }
        }
        
        // Obtenir le nom d'affichage à partir de l'identifiant utilisateur
        function getDisplayName(userId) {
            switch(userId) {
                case 'marie': return 'Marie';
                case 'pierre': return 'Pierre';
                case 'sophie': return 'Sophie';
                case 'thomas': return 'Thomas';
                case 'me': return 'Jean';
                default: return userId;
            }
        }
        
        // ================ FONCTIONS POUR LA SÉLECTION ================
        
        // Fonction pour basculer la sélection d'un élément
        function toggleItemSelection(item, itemId, select) {
            var checkbox = item.querySelector('.item-select-checkbox');
            var selectIndicator = item.querySelector('.select-indicator-inner');
            
            if (select === undefined) {
                // Si select n'est pas fourni, basculer selon l'état actuel
                select = !selectedItems.has(itemId);
            }
            
            if (select) {
                selectedItems.add(itemId);
                checkbox?.classList.add('checked');
                item.classList.add('selected');
                if (selectIndicator) { // Pour le nouveau mode de sélection
                    item.classList.add('selected');
                }
            } else {
                selectedItems.delete(itemId);
                checkbox?.classList.remove('checked');
                item.classList.remove('selected');
                if (selectIndicator) { // Pour le nouveau mode de sélection
                    item.classList.remove('selected');
                }
            }
            
            updateSelectionCount();
            
            // Afficher/masquer le bouton de suppression
            const deleteBtn = document.getElementById('conversation-delete-btn');
            if (selectedItems.size > 0) {
                deleteBtn.classList.add('active');
            } else {
                deleteBtn.classList.remove('active');
            }
        }
        
        // Fonction pour sélectionner/désélectionner un message
        function toggleMessageSelection(message) {
            var messageId = message.getAttribute('data-id');
            
            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId);
                message.classList.remove('selected');
            } else {
                selectedMessages.add(messageId);
                message.classList.add('selected');
            }
            
            updateSelectionCount();
        }
        
        // Fonction pour sélectionner tous les éléments
        function selectAllItems() {
            if (selectionModeType === 'messages') {
                selectAllMessages();
            } else {
                // Ne pas sélectionner les groupes
                var items = document.querySelectorAll('.chat-item:not([data-is-group="true"])');
                
                for (var i = 0; i < items.length; i++) {
                    var itemId = items[i].getAttribute('data-contact');
                    var checkbox = items[i].querySelector('.item-select-checkbox');
                    
                    selectedItems.add(itemId);
                    checkbox?.classList.add('checked');
                    items[i].classList.add('selected');
                }
                
                updateSelectionCount();
                
                // Afficher le bouton de suppression
                if (selectedItems.size > 0) {
                    document.getElementById('conversation-delete-btn').classList.add('active');
                }
            }
        }
        
        // Fonction pour sélectionner tous les messages
        function selectAllMessages() {
            var messages = document.querySelectorAll('.message');
            
            for (var i = 0; i < messages.length; i++) {
                var messageId = messages[i].getAttribute('data-id');
                selectedMessages.add(messageId);
                messages[i].classList.add('selected');
            }
            
            updateSelectionCount();
        }
        
        // Fonction pour mettre à jour le compteur de sélection
        function updateSelectionCount() {
            var count = selectionModeType === 'messages' ? selectedMessages.size : selectedItems.size;
            
            // Mettre à jour l'ancien indicateur de sélection
            document.getElementById('selection-indicator').innerText = `Sélection de ${selectionModeType} (${count})`;
            
            // Mettre à jour le nouvel indicateur de sélection
            document.getElementById('new-selection-indicator').querySelector('.new-selection-title').innerText = 
                count + (count === 1 ? ' sélectionné' : ' sélectionnés');
            
            // Mettre à jour le compteur du menu d'actions approprié
            if (selectionModeType === 'messages') {
                document.getElementById('selected-count').innerText = count + (count === 1 ? ' sélectionné' : ' sélectionnés');
            } else if (selectionModeType === 'conversations' || selectionModeType === 'contacts') {
                document.getElementById('conversations-selected-count').innerText = count + (count === 1 ? ' sélectionné' : ' sélectionnés');
            }
            
            // Sortir du mode sélection si aucun élément n'est sélectionné
            if (count === 0 && isSelectionMode) {
                exitSelectionMode();
            }
        }
        
        // Fonction pour démarrer le mode de sélection des conversations
        function startConversationsSelectionMode() {
            closeOptionsMenu();
            
            if (isSelectionMode) return;
            
            isSelectionMode = true;
            selectionModeType = 'conversations';
            selectedItems.clear();
            
            // Afficher le nouvel indicateur de sélection
            document.getElementById('new-selection-indicator').style.display = 'block';
            document.getElementById('new-selection-indicator').querySelector('.new-selection-title').innerText = '0 sélectionné';
            
            // Mettre à jour l'en-tête
            document.getElementById('header-title').innerText = 'Sélection';
            document.getElementById('header-left').innerHTML = '<div class="back-button"><i class="fas fa-times"></i></div>';
            document.getElementById('header-action').innerHTML = '';
            
            // Ajouter l'événement sur le bouton retour
            document.getElementById('header-left').querySelector('.back-button').addEventListener('click', exitSelectionMode);
            
            // Activer le bouton de suppression flottant
            document.getElementById('conversation-delete-btn').classList.remove('active');
            
            // Ajouter la classe pour activer la visualisation du mode sélection
            document.querySelector('.section.active').classList.add('selection-mode');
            
            // Faire apparaître les cases à cocher
            document.querySelectorAll('.chat-item:not([data-is-group="true"]) .item-select-checkbox').forEach(checkbox => {
                checkbox.classList.add('visible');
            });
            
            updateSelectionCount();
        }
        
        // Fonction pour démarrer le mode de sélection des messages
        function startMessagesSelectionMode() {
            closeOptionsMenu();
            
            if (isSelectionMode) return;
            
            isSelectionMode = true;
            selectionModeType = 'messages';
            selectedMessages.clear();
            
            // Afficher l'indicateur de sélection
            document.getElementById('selection-indicator').style.display = 'block';
            document.getElementById('selection-indicator').innerText = 'Sélection de messages (0)';
            
            // Mettre à jour l'en-tête
            document.getElementById('header-action').innerHTML = '<div class="select-all-btn" style="color: var(--primary-color);">Tout</div>';
            document.getElementById('header-action').querySelector('.select-all-btn').addEventListener('click', selectAllMessages);
            
            // Activer le menu d'actions
            document.getElementById('message-actions').classList.add('active');
            
            // Désactiver la saisie de message pour le mode sélection de messages
            document.getElementById('chat-input').disabled = true;
            document.getElementById('send-button').disabled = true;
        }
        
        // Fonction pour quitter le mode de sélection
        function exitSelectionMode(type) {
            if (!type) type = selectionModeType;
            
            isSelectionMode = false;
            selectionModeType = '';
            selectedItems.clear();
            selectedMessages.clear();
            
            // Masquer les indicateurs de sélection
            document.getElementById('selection-indicator').style.display = 'none';
            document.getElementById('new-selection-indicator').style.display = 'none';
            
            // Masquer le bouton de suppression flottant
            document.getElementById('conversation-delete-btn').classList.remove('active');
            
            if (currentContact) {
                // Si nous sommes dans un chat, restaurer l'en-tête de chat
                document.getElementById('header-title').innerText = currentContact;
                document.getElementById('header-left').innerHTML = '<div class="back-button"><i class="fas fa-chevron-left"></i></div>';
                document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
                
                // Réattacher les événements
                document.getElementById('header-left').querySelector('.back-button').addEventListener('click', closeChat);
                document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            } else {
                // Sinon, restaurer l'en-tête normal
                document.getElementById('header-title').innerText = currentSection.charAt(0).toUpperCase() + currentSection.slice(1);
                document.getElementById('header-left').innerHTML = '<span class="notification-icon badge" id="notification-bell"><i class="fas fa-bell"></i><span class="dot"></span></span>';
                document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
                
                // Réattacher les événements
                document.getElementById('notification-bell').addEventListener('click', toggleNotifications);
                document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            }
            
            // Désactiver tous les menus d'actions
            document.getElementById('conversations-actions').classList.remove('active');
            document.getElementById('message-actions').classList.remove('active');
            
            // Réactiver la saisie de message si on était en mode sélection de messages
            if (type === 'messages') {
                document.getElementById('chat-input').disabled = false;
                document.getElementById('send-button').disabled = false;
            }
            
            // Retirer la classe mode sélection
            document.querySelector('.selection-mode')?.classList.remove('selection-mode');
            
            // Masquer les cases à cocher et réinitialiser leur état
            document.querySelectorAll('.item-select-checkbox').forEach(checkbox => {
                checkbox.classList.remove('visible');
                checkbox.classList.remove('checked');
            });
            
            // Retirer la classe selected de tous les messages et items
            document.querySelectorAll('.message.selected, .chat-item.selected, .user-item.selected').forEach(element => {
                element.classList.remove('selected');
            });
        }
        
        // ================ FONCTIONS POUR LES ACTIONS ================
        
        // Basculer entre bloquer/débloquer un utilisateur
        function blockUnblockUser() {
            if (!currentContact) return;
            
            if (blockedUsers.has(currentContact)) {
                unblockUser();
            } else {
                blockUser();
            }
        }
        
        // Bloquer un utilisateur
        function blockUser() {
            if (currentContact && !blockedUsers.has(currentContact)) {
                blockedUsers.add(currentContact);
                closeOptionsMenu();
                
                // Mettre à jour l'interface
                document.getElementById('block-banner').classList.add('active');
                
                // Mettre à jour l'option dans le menu
                updateBlockUnblockOption();
                
                // Mettre à jour l'aperçu de la conversation
                updateChatPreview(currentContact, "Système", "Utilisateur bloqué");
                
                // Ajouter la classe blocked à la conversation
                var chatItems = document.querySelectorAll('.chat-item');
                for (var i = 0; i < chatItems.length; i++) {
                    if (chatItems[i].getAttribute('data-contact') === currentContact) {
                        chatItems[i].classList.add('blocked');
                        chatItems[i].querySelector('.item-subtitle').textContent = "Utilisateur bloqué";
                        break;
                    }
                }
                
                // Notification
                addNotification("Utilisateur bloqué", `Vous avez bloqué ${currentContact}`, "ban");
            } else {
                closeOptionsMenu();
            }
        }
        
        // Débloquer un utilisateur
        function unblockUser() {
            if (currentContact && blockedUsers.has(currentContact)) {
                blockedUsers.delete(currentContact);
                
                // Mettre à jour l'interface
                document.getElementById('block-banner').classList.remove('active');
                
                // Mettre à jour l'option dans le menu
                updateBlockUnblockOption();
                
                // Mettre à jour l'aperçu de la conversation
                updateChatPreview(currentContact, "Système", "Utilisateur débloqué");
                
                // Retirer la classe blocked de la conversation
                var chatItems = document.querySelectorAll('.chat-item');
                for (var i = 0; i < chatItems.length; i++) {
                    if (chatItems[i].getAttribute('data-contact') === currentContact) {
                        chatItems[i].classList.remove('blocked');
                        if (chatMessages[currentContact] && chatMessages[currentContact].length > 0) {
                            var lastMsg = chatMessages[currentContact][chatMessages[currentContact].length - 1];
                            chatItems[i].querySelector('.item-subtitle').textContent = lastMsg.text;
                        } else {
                            chatItems[i].querySelector('.item-subtitle').textContent = "Aucun message";
                        }
                        break;
                    }
                }
                
                // Notification
                addNotification("Utilisateur débloqué", `Vous avez débloqué ${currentContact}`, "unlock");
            }
        }
        
        // Mettre à jour l'option de blocage/déblocage dans le menu
        function updateBlockUnblockOption() {
            var blockOption = document.getElementById('block-option');
            var blockIcon = blockOption.querySelector('.option-icon i');
            var blockLabel = blockOption.querySelector('.option-label');
            
            if (blockedUsers.has(currentContact)) {
                blockIcon.className = 'fas fa-unlock';
                blockLabel.textContent = 'Débloquer cette personne';
            } else {
                blockIcon.className = 'fas fa-ban';
                blockLabel.textContent = 'Bloquer cette personne';
            }
        }
        
        // Bloquer les utilisateurs sélectionnés
        function blockSelectedUsers() {
            if (selectedItems.size === 0) return;
            
            selectedItems.forEach(contact => {
                blockedUsers.add(contact);
                
                // Mettre à jour l'interface
                var chatItems = document.querySelectorAll('.chat-item');
                for (var i = 0; i < chatItems.length; i++) {
                    if (chatItems[i].getAttribute('data-contact') === contact) {
                        chatItems[i].classList.add('blocked');
                        chatItems[i].querySelector('.item-subtitle').textContent = "Utilisateur bloqué";
                        break;
                    }
                }
            });
            
            // Notification
            addNotification("Utilisateurs bloqués", `${selectedItems.size} contact(s) bloqué(s)`, "ban");
            
            // Quitter le mode sélection
            exitSelectionMode();
        }
        
        // Effacer une conversation
        function clearConversation() {
            if (!currentContact) return;
            
            // Vider les messages
            chatMessages[currentContact] = [];
            
            // Recharger la conversation
            loadChatMessages(currentContact);
            
            // Mettre à jour l'aperçu
            updateChatPreview(currentContact, "Système", "Conversation effacée");
            
            // Fermer le menu
            closeOptionsMenu();
            
            // Notification
            addNotification("Conversation effacée", `La conversation avec ${currentContact} a été effacée`, "trash-alt");
        }
        
        // Supprimer les conversations sélectionnées avec animation
        function deleteSelectedConversations() {
            if (selectedItems.size === 0) return;
            
            // Pour chaque conversation sélectionnée
            const deletedItemsCount = selectedItems.size;
            let chatItems = document.querySelectorAll('.chat-item');
            let animationsCompleted = 0;
            
            // Fonction pour gérer la fin des animations
            const handleAnimationEnd = () => {
                animationsCompleted++;
                if (animationsCompleted === deletedItemsCount) {
                    // Notification une fois toutes les animations terminées
                    setTimeout(() => {
                        addNotification("Conversations supprimées", 
                            `${deletedItemsCount} conversation(s) supprimée(s)`, "trash-alt");
                        
                        // Sortir du mode sélection
                        exitSelectionMode();
                    }, 200);
                }
            };
            
            for (let i = 0; i < chatItems.length; i++) {
                const contactName = chatItems[i].getAttribute('data-contact');
                if (selectedItems.has(contactName)) {
                    // Ajouter la classe d'animation
                    chatItems[i].classList.add('deleting');
                    
                    // Gérer la fin de l'animation
                    chatItems[i].addEventListener('animationend', function() {
                        this.style.display = 'none';
                        handleAnimationEnd();
                    }, { once: true });
                }
            }
        }
        
        // Marquer les conversations sélectionnées comme lues
        function markSelectedAsRead() {
            if (selectedItems.size === 0) return;
            
            exitSelectionMode();
            addNotification("Conversations lues", 
                `${selectedItems.size} conversation(s) marquée(s) comme lue(s)`, "check-double");
        }
        
        // Archiver les conversations sélectionnées
        function archiveSelectedConversations() {
            if (selectedItems.size === 0) return;
            
            exitSelectionMode();
            addNotification("Conversations archivées", 
                `${selectedItems.size} conversation(s) archivée(s)`, "archive");
        }
        
        // Afficher le dialogue de suppression des messages avec options
        function showDeleteMessageOptions() {
            if (selectedMessages.size === 0) return;
            
            // Réinitialiser les options
            selectedDeleteOption = 'for-me';
            document.getElementById('delete-for-me').classList.add('selected');
            document.getElementById('delete-for-all').classList.remove('selected');
            
            // Afficher le dialogue
            document.getElementById('delete-message-dialog').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // Sélectionner une option de suppression
        function selectDeleteOption(option) {
            // Réinitialiser les options
            document.getElementById('delete-for-me').classList.remove('selected');
            document.getElementById('delete-for-all').classList.remove('selected');
            
            // Sélectionner l'option cliquée
            if (option === 'for-me') {
                document.getElementById('delete-for-me').classList.add('selected');
            } else {
                document.getElementById('delete-for-all').classList.add('selected');
            }
            
            selectedDeleteOption = option;
        }
        
        // Fermer le dialogue de suppression des messages
        function closeDeleteMessageDialog() {
            document.getElementById('delete-message-dialog').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Confirmer la suppression des messages
        function confirmDeleteMessages() {
            if (selectedMessages.size === 0) return;
            
            // Fermer le dialogue avant l'animation
            closeDeleteMessageDialog();
            
            // Animation de désintégration pour les messages
            const messagesToDelete = [];
            const messageElements = [];
            
            for (const messageId of selectedMessages) {
                const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
                if (messageElement) {
                    messagesToDelete.push(messageId);
                    messageElements.push(messageElement);
                    messageElement.classList.add('disintegrating');
                }
            }
            
            // Attendre la fin de l'animation avant de retirer les messages
            setTimeout(() => {
                // Créer une copie des messages à conserver
                var messagesForContact = [];
                var messageList = currentContact === 'Betforce' ? 
                    chatMessages['Betforce'] : chatMessages[currentContact];
                
                for (var i = 0; i < messageList.length; i++) {
                    var msg = messageList[i];
                    if (!selectedMessages.has(msg.id)) {
                        messagesForContact.push(msg);
                    }
                }
                
                // Mettre à jour les messages selon l'option sélectionnée
                if (selectedDeleteOption === 'for-me' || currentContact === 'Betforce') {
                    // En mode "pour moi seulement" ou pour les groupes
                    if (currentContact === 'Betforce') {
                        chatMessages['Betforce'] = messagesForContact;
                    } else {
                        chatMessages[currentContact] = messagesForContact;
                    }
                } else {
                    // En mode "pour tout le monde", on peut simplement faire la même chose
                    // car c'est une simulation, mais en réalité cela enverrait une requête au serveur
                    chatMessages[currentContact] = messagesForContact;
                }
                
                // Mettre à jour l'aperçu de la conversation
                updateChatPreview(currentContact, "Système", 
                    selectedDeleteOption === 'for-me' ? 
                    selectedMessages.size + " message(s) supprimé(s) pour vous" : 
                    selectedMessages.size + " message(s) supprimé(s) pour tout le monde"
                );
                
                // Recharger la conversation
                loadChatMessages(currentContact);
                
                // Quitter le mode sélection
                exitSelectionMode();
                
                // Ajouter une notification
                addNotification("Messages supprimés", 
                    selectedDeleteOption === 'for-me' ? 
                    `${selectedMessages.size} message(s) supprimé(s) pour vous` : 
                    `${selectedMessages.size} message(s) supprimé(s) pour tout le monde`, 
                    "trash-alt"
                );
            }, 800); // Attendre la fin de l'animation
        }
        
        // Ouvrir le dialogue de transfert de messages
        function forwardSelectedMessages() {
            if (selectedMessages.size === 0) return;
            
            // Collecter les messages sélectionnés
            messagesForForward = [];
            const messageList = currentContact === 'Betforce' ? 
                chatMessages['Betforce'] : chatMessages[currentContact];
            
            for (let i = 0; i < messageList.length; i++) {
                const msg = messageList[i];
                if (selectedMessages.has(msg.id)) {
                    messagesForForward.push(msg);
                }
            }
            
            // Mettre à jour le badge du compteur
            document.getElementById('forward-count-badge').textContent = messagesForForward.length;
            
            // Remplir la liste des contacts
            const contactsList = document.getElementById('forward-contacts-list');
            contactsList.innerHTML = '';
            
            const contacts = ['Marie Dupont', 'Pierre Martin', 'Sophie Leroy', 'Thomas Bernard', 'Betforce'];
            contacts.forEach(contact => {
                if (contact !== currentContact) {
                    const contactItem = document.createElement('div');
                    contactItem.className = 'chat-item';
                    contactItem.onclick = function() { forwardMessagesTo(contact); };
                    
                    const profilePic = document.createElement('div');
                    if (contact === 'Betforce') {
                        profilePic.className = 'group-pic';
                        profilePic.innerHTML = '<i class="fas fa-users" style="color: white;"></i>';
                    } else {
                        profilePic.className = 'profile-pic';
                        profilePic.innerHTML = '<i class="fas fa-user" style="color: var(--primary-color);"></i>';
                    }
                    
                    const content = document.createElement('div');
                    content.className = 'item-content';
                    content.innerHTML = `<div class="item-title">${contact}</div>`;
                    
                    contactItem.appendChild(profilePic);
                    contactItem.appendChild(content);
                    contactsList.appendChild(contactItem);
                }
            });
            
            // Afficher le dialogue
            document.getElementById('forward-dialog').classList.add('active');
        }
        
        // Fermer le dialogue de transfert
        function closeForwardDialog() {
            document.getElementById('forward-dialog').classList.remove('active');
            messagesForForward = [];
        }
        
        // Transférer les messages à un contact spécifique
        function forwardMessagesTo(contact) {
            if (messagesForForward.length === 0) return;
            
            targetContactForForward = contact;
            
            // Configurer la boîte de dialogue de confirmation
            document.getElementById('confirmation-text').textContent = 
                `Transférer ${messagesForForward.length} message(s) à ${contact} ?`;
            
            document.getElementById('confirmation-confirm').onclick = function() {
                executeForwardMessages();
                closeConfirmationDialog();
            };
            
            // Afficher la boîte de dialogue de confirmation
            document.getElementById('confirmation-dialog').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // Fermer la boîte de dialogue de confirmation
        function closeConfirmationDialog() {
            document.getElementById('confirmation-dialog').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Fermer la boîte de dialogue de suppression de compte
        function closeDeleteAccountDialog() {
            document.getElementById('delete-account-dialog').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Exécuter l'action de transfert
        function executeForwardMessages() {
            // S'assurer que les paramètres nécessaires sont définis
            if (!targetContactForForward || messagesForForward.length === 0) return;
            
            // Ajouter chaque message à la conversation cible
            const now = new Date();
            const time = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
            
            messagesForForward.forEach(msg => {
                const newMessage = {
                    id: 'fw_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    text: msg.text,
                    from: 'me',
                    time: time,
                    forwarded: true,
                    originalFrom: msg.from === 'me' ? 'moi' : currentContact
                };
                
                // Copier l'image si elle existe
                if (msg.image) {
                    newMessage.image = msg.image;
                }
                
                // Ajouter à la conversation cible
                if (!chatMessages[targetContactForForward]) {
                    chatMessages[targetContactForForward] = [];
                }
                chatMessages[targetContactForForward].push(newMessage);
            });
            
            // Mettre à jour l'aperçu de la conversation
            updateChatPreview(
                targetContactForForward, 
                "me", 
                messagesForForward.length > 1 ? 
                    `${messagesForForward.length} messages transférés` : 
                    messagesForForward[0].text
            );
            
            // Fermer le dialogue de transfert
            closeForwardDialog();
            
            // Quitter le mode sélection
            exitSelectionMode();
            
            // Montrer une notification
            addNotification(
                "Messages transférés", 
                `${messagesForForward.length} message(s) transféré(s) à ${targetContactForForward}`,
                "share"
            );
        }
        
        // Copier les messages sélectionnés dans le presse-papiers
        function copySelectedMessages() {
            if (selectedMessages.size === 0) return;
            
            // Collecter les textes des messages sélectionnés
            let textToCopy = '';
            const messageList = currentContact === 'Betforce' ? 
                chatMessages['Betforce'] : chatMessages[currentContact];
            
            for (let i = 0; i < messageList.length; i++) {
                const msg = messageList[i];
                if (selectedMessages.has(msg.id)) {
                    // Formater différemment selon qu'il s'agit d'un groupe ou non
                    if (currentContact === 'Betforce') {
                        textToCopy += `[${getDisplayName(msg.from)}]: ${msg.text}\n`;
                    } else {
                        textToCopy += `[${msg.from === 'me' ? 'Moi' : currentContact}]: ${msg.text}\n`;
                    }
                }
            }
            
            // Tentative de copie dans le presse-papiers
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    addNotification("Copié", "Le texte a été copié dans le presse-papiers", "copy");
                    exitSelectionMode();
                }).catch(err => {
                    console.error('Erreur lors de la copie: ', err);
                    addNotification("Erreur", "Impossible de copier dans le presse-papiers", "exclamation-circle");
                });
            } else {
                // Méthode alternative pour les contextes non sécurisés
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        addNotification("Copié", "Le texte a été copié dans le presse-papiers", "copy");
                    } else {
                        addNotification("Erreur", "Impossible de copier dans le presse-papiers", "exclamation-circle");
                    }
                } catch (err) {
                    console.error('Erreur lors de la copie: ', err);
                    addNotification("Erreur", "Impossible de copier dans le presse-papiers", "exclamation-circle");
                }
                
                document.body.removeChild(textArea);
                exitSelectionMode();
            }
        }
        
        // Répondre au message sélectionné
        function replyToSelectedMessage() {
            if (selectedMessages.size !== 1) {
                addNotification("Information", "Veuillez sélectionner un seul message pour répondre", "info-circle");
                return;
            }
            
            // Trouver le message sélectionné
            const messageId = [...selectedMessages][0];
            
            // Quitter le mode sélection
            exitSelectionMode();
            
            // Préparer la réponse
            replyToMessageAction(messageId);
        }
        
        // Ouvrir l'interface de recherche dans les messages
        function searchInConversation() {
            if (!currentContact) return;
            closeOptionsMenu();
            
            // Afficher l'interface de recherche
            document.getElementById('search-overlay').classList.add('active');
            document.getElementById('message-search-input').focus();
        }
        
        // Fermer l'interface de recherche
        function closeSearchInterface() {
            document.getElementById('search-overlay').classList.remove('active');
            document.getElementById('message-search-input').value = '';
            document.getElementById('search-results').innerHTML = '<div class="no-results">Saisissez un terme à rechercher</div>';
        }
        
        // Rechercher dans les messages
        function searchMessages() {
            const searchTerm = document.getElementById('message-search-input').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            
            if (searchTerm === '') {
                resultsContainer.innerHTML = '<div class="no-results">Saisissez un terme à rechercher</div>';
                return;
            }
            
            const messageList = currentContact === 'Betforce' ? 
                chatMessages['Betforce'] : chatMessages[currentContact];
            
            if (!messageList || messageList.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">Aucun message dans cette conversation</div>';
                return;
            }
            
            // Rechercher le terme dans les messages
            const matchingMessages = messageList.filter(msg => 
                msg.text.toLowerCase().includes(searchTerm)
            );
            
            if (matchingMessages.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">Aucun résultat trouvé</div>';
                return;
            }
            
            // Afficher les résultats
            resultsContainer.innerHTML = '';
            matchingMessages.forEach(msg => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                
                // Mettre en surbrillance le terme recherché
                const highlightedText = msg.text.replace(
                    new RegExp(searchTerm, 'gi'),
                    match => `<span class="search-highlight">${match}</span>`
                );
                
                const sender = msg.from === 'me' ? 'Vous' : 
                    (currentContact === 'Betforce' ? getDisplayName(msg.from) : currentContact);
                
                resultItem.innerHTML = `
                    <div class="search-result-text">${highlightedText}</div>
                    <div class="search-result-info">
                        <span>${sender}</span>
                        <span>${msg.time}</span>
                    </div>
                `;
                
                // Ajouter un gestionnaire de clic pour naviguer vers le message
                resultItem.addEventListener('click', () => {
                    closeSearchInterface();
                    highlightMessage(msg.id);
                });
                
                resultsContainer.appendChild(resultItem);
            });
        }
        
        // Mettre en évidence un message spécifique
        function highlightMessage(messageId) {
            loadChatMessages(currentContact);
            
            setTimeout(() => {
                const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    messageElement.classList.add('selected');
                    
                    // Vibration pour feedback tactile
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                    
                    // Retirer la mise en évidence après quelques secondes
                    setTimeout(() => {
                        messageElement.classList.remove('selected');
                    }, 3000);
                }
            }, 300);
        }
        
        // ================ FONCTIONS POUR LES ATTACHEMENTS ================
        
        // Ouvrir le clavier emoji
        function openEmojiKeyboard() {
            var input = document.getElementById('chat-input');
            input.focus();
            // Simuler l'ouverture du clavier emoji natif
            // (En réalité, c'est le système d'exploitation qui le gère)
        }
        
        // Basculer le panneau d'attachements
        function toggleAttachments() {
            var extraButtons = document.getElementById('chat-extra-buttons');
            if (isAttachmentsOpen) {
                extraButtons.classList.remove('active');
            } else {
                extraButtons.classList.add('active');
            }
            isAttachmentsOpen = !isAttachmentsOpen;
        }
        
        // Sélectionner une image
        function selectImage() {
            document.getElementById('image-input').click();
            toggleAttachments();
        }
        
        // Sélectionner un fichier
        function selectFile() {
            // Simulation
            toggleAttachments();
            addNotification("Fonctionnalité limitée", "La sélection de fichiers n'est pas disponible pour le moment", "file");
        }
        
        // Sélectionner l'appareil photo
        function selectCamera() {
            // Simulation
            toggleAttachments();
            addNotification("Accès refusé", "L'accès à l'appareil photo n'est pas disponible dans cette version", "camera");
        }
        
        // Sélectionner la localisation
        function selectLocation() {
            // Simulation
            toggleAttachments();
            addNotification("Localisation", "Le partage de localisation n'est pas disponible pour le moment", "map-marker-alt");
        }
        
        // Effacer l'aperçu d'image
        function clearImagePreview() {
            document.getElementById('image-preview').classList.remove('active');
            selectedImage = null;
        }
        
        // ================ FONCTIONS UI ================
        
        // Basculer l'affichage des notifications
        function toggleNotifications() {
            var panel = document.getElementById('notifications-panel');
            if (isNotificationsOpen) {
                panel.classList.remove('active');
            } else {
                panel.classList.add('active');
                // Marquer toutes les notifications comme lues (retirer la classe unread)
                var unreadNotifications = document.querySelectorAll('.notification-item.unread');
                for (var i = 0; i < unreadNotifications.length; i++) {
                    unreadNotifications[i].classList.remove('unread');
                }
                // Cacher le point de notification
                document.querySelector('.notification-icon .dot').style.display = 'none';
            }
            isNotificationsOpen = !isNotificationsOpen;
        }
        
        // Basculer le menu d'options selon la section active
        function toggleOptionsMenu() {
            var menuId;
            
            // Déterminer quel menu afficher selon le contexte
            if (currentContact) {
                menuId = 'chat-options-menu';
            } else if (currentSection === 'messages') {
                menuId = 'messages-options-menu';
            } else {
                menuId = 'simple-options-menu';
            }
            
            var menu = document.getElementById(menuId);
            var overlay = document.getElementById('overlay');
            
            if (isOptionsMenuOpen) {
                menu.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                menu.classList.add('active');
                overlay.classList.add('active');
                
                // Mettre à jour l'option de blocage si on est dans un chat
                if (currentContact) {
                    updateBlockUnblockOption();
                }
            }
            
            isOptionsMenuOpen = !isOptionsMenuOpen;
        }
        
        // Fermer le menu d'options
        function closeOptionsMenu() {
            document.getElementById('simple-options-menu').classList.remove('active');
            document.getElementById('messages-options-menu').classList.remove('active');
            document.getElementById('chat-options-menu').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            isOptionsMenuOpen = false;
        }
        
        // Fermer tous les dialogues
        function closeAllDialogs() {
            closeOptionsMenu();
            closeDeleteMessageDialog();
            closeConfirmationDialog();
            closeDeleteAccountDialog();
            closeInstallGuide();
            
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Changer le thème
        function changeTheme() {
            var colorPicker = document.getElementById('color-picker');
            var randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);
            colorPicker.value = randomColor;
            
            document.documentElement.style.setProperty('--primary-color', randomColor);
            
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.style.setProperty('--chat-sent-bg', randomColor);
            }
            
            closeOptionsMenu();
            addNotification("Thème modifié", "La couleur de l'interface a été changée", "palette");
        }
        
        // Montrer le guide d'installation
        function showInstallGuide() {
            closeOptionsMenu();
            document.getElementById('install-guide').classList.add('active');
        }
        
        // Fermer le guide d'installation
        function closeInstallGuide() {
            document.getElementById('install-guide').classList.remove('active');
        }
        
        // Montrer le dialogue de suppression de compte
        function showDeleteAccountConfirmation() {
            document.getElementById('delete-account-dialog').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // Notifier du lancement des pronostics (fonction simulée)
        function notifyLaunch() {
            addNotification("Inscription confirmée", "Vous serez alerté(e) du lancement des pronostics sportifs", "bell");
            
            // Changer le texte du bouton
            document.getElementById('notify-launch-button').textContent = "Inscription confirmée";
            document.getElementById('notify-launch-button').disabled = true;
            
            // Vibration pour feedback tactile
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }
        }
        
        // Ajouter une nouvelle notification
        function addNotification(title, text, icon) {
            var container = document.getElementById('notifications-container');
            var now = new Date();
            
            var notificationDiv = document.createElement('div');
            notificationDiv.className = 'notification-item unread';
            
            notificationDiv.innerHTML = `
                <div class="notification-icon-container">
                    <i class="fas fa-${icon || 'bell'}" style="color: var(--primary-color);"></i>
                </div>
                <div class="notification-content">
                                        <div class="notification-title">${title}</div>
                    <div class="notification-text">${text}</div>
                    <div class="notification-time">À l'instant</div>
                </div>
            `;
            
            // Ajouter la notification au début du conteneur
            if (container.firstChild) {
                container.insertBefore(notificationDiv, container.firstChild);
            } else {
                container.appendChild(notificationDiv);
            }
            
            // Afficher le point de notification
            document.querySelector('.notification-icon .dot').style.display = 'block';
            
            // Animation d'apparition
            notificationDiv.style.opacity = '0';
            notificationDiv.style.transform = 'translateX(20px)';
            
            setTimeout(() => {
                notificationDiv.style.opacity = '1';
                notificationDiv.style.transform = 'translateX(0)';
                notificationDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            }, 10);
            
            // Vibration pour feedback tactile
            if (navigator.vibrate) {
                navigator.vibrate([20, 30, 20]);
            }
        }
        
        // ================ INITIALISATION DE L'APPLICATION ================
        
        // Observer les changements d'authentification
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Utilisateur connecté
                currentUser = user;
                isLoggedIn = true;
                
                // Récupérer les données utilisateur
                currentUserData = await getUserData(user.uid);
                
                // Vérifier si l'utilisateur est administrateur
                if (currentUserData && currentUserData.statut === 'admin') {
                    isAdmin = true;
                }
                
                // Vérifier si le PIN est activé
                isPinEnabled = localStorage.getItem('ichatPinEnabled') === 'true';
                userPin = localStorage.getItem('ichatUserPin');
                
                // Si le PIN est activé, montrer l'écran de verrouillage
                if (isPinEnabled && userPin) {
                    showPinLockScreen();
                } else {
                    completeLogin();
                }
            } else {
                // Utilisateur déconnecté
                showLoginScreen();
            }
        });
        
        // Initialiser l'application
        document.addEventListener('DOMContentLoaded', function() {
            // Configurer les événements UI
            setupUIEvents();
            
            // Configurer les événements d'authentification
            setupAuthEvents();
            
            // Configurer les événements du PIN
            setupPinEvents();
            
            // Configurer le mode sombre
            setupDarkMode();
            
            // Gérer les préférences de thème
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        });
        
        // Exposer certaines fonctions globalement pour être appelées depuis le HTML
        window.closeChat = closeChat;
        window.openChat = openChat;
        window.changeTab = changeTab;
    </script>
</body>
</html>

