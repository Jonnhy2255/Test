<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iChat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <style>
        /* Variables de couleurs */
        :root {
            --primary-color: #F7DC6F; /* Jaune comme couleur principale de l'interface */
            --text-color: #000000;
            --bg-color: #ffffff;
            --border-color: #dddfe2;
            --secondary-color: #f0f2f5;
            --chat-sent-bg: #5D5CDE; /* Violet pour les bulles de messages envoyés */
            --chat-sent-text: #ffffff;
            --chat-received-bg: #f0f2f5;
            --selection-color: rgba(247, 220, 111, 0.2);
            --action-menu-bg: rgba(0, 0, 0, 0.9);
            --action-menu-text: #ffffff;
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(255, 255, 255, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.1);
            --group-icon-bg: #4CAF50;
            --danger-color: #ff4842;
            --success-color: #4caf50;
            --input-bg: #f0f2f5;
            --input-placeholder: #8e8e93;
            --button-text: #000000;
            --inactive-text: #8e8e93;
            --link-color: #007aff;
            --admin-badge-bg: #5D5CDE;
            --admin-badge-text: white;
            --news-group-bg: #f5a623;
            --log-bg: rgba(0, 0, 0, 0.8);
            --log-text: #ffffff;
            --log-info: #2196F3;
            --log-warning: #FFC107;
            --log-error: #FF5252;
            --log-success: #4CAF50;
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --image-viewer-bg: rgba(0, 0, 0, 0.9);
            --loading-spinner: rgba(255, 255, 255, 0.8);
        }
        
        /* Mode sombre par défaut */
        .dark {
            --bg-color: #181818;
            --text-color: #ffffff;
            --border-color: #3e4042;
            --secondary-color: #2c2c2c;
            --chat-received-bg: #2c2c2c;
            --chat-sent-bg: #F7DC6F; /* Jaune plus visible en mode sombre */
            --chat-sent-text: #000000; /* Texte noir pour contraste avec fond jaune */
            --selection-color: rgba(247, 220, 111, 0.3);
            --action-menu-bg: rgba(60, 60, 60, 0.95);
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(40, 40, 40, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.3);
            --group-icon-bg: #388E3C;
            --danger-color: #ff6b6b;
            --success-color: #66bb6a;
            --input-bg: #2c2c2c;
            --input-placeholder: #6c6c6c;
            --link-color: #2196F3;
            --admin-badge-bg: #7571F9;
            --admin-badge-text: white;
            --news-group-bg: #d48a1c;
            --log-bg: rgba(20, 20, 20, 0.9);
            --log-info: #64B5F6;
            --log-warning: #FFD54F;
            --log-error: #FF8A80;
            --log-success: #81C784;
            --overlay-bg: rgba(0, 0, 0, 0.8);
            --image-viewer-bg: rgba(10, 10, 10, 0.95);
        }
        
        /* Reset de base */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            user-select: none; /* Rendre aucune écriture sélectionnable */
            -webkit-user-select: none; /* Pour Safari */
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            overflow: hidden;
            font-weight: 500; /* Police légèrement plus grasse style iOS */
            letter-spacing: -0.2px; /* Espacement légèrement réduit style iOS */
        }
        
        /* En-tête fixe */
        .header {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 10;
        }
        
        .header-title {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary-color);
        }
        
        .back-button {
            color: var(--primary-color);
            padding: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* Contenu principal */
        .content {
            position: fixed;
            top: 50px; /* Hauteur de l'en-tête */
            bottom: 60px; /* Hauteur de la barre d'onglets */
            left: 0;
            right: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background-color: var(--bg-color);
        }
        
        /* Barre d'onglets fixe */
        .tabbar {
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            z-index: 10;
        }
        
        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #8e8e93;
            font-size: 10px;
            text-decoration: none;
            padding: 8px 0;
            transition: transform 0.15s ease, color 0.2s ease;
        }
        
        .tab:active {
            transform: scale(0.95);
        }
        
        .tab.active {
            color: var(--primary-color);
        }
        
        .tab-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }
        
        /* Sections de contenu */
        .section {
            padding: 10px 0;
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* Profil et éléments utilisateur */
        .profile-pic {
            width: 50px;
            height: 50px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        
        .group-pic {
            width: 50px;
            height: 50px;
            background-color: var(--group-icon-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }

        .news-group-pic {
            width: 50px;
            height: 50px;
            background-color: var(--news-group-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px; 
        }
        
        .chat-item, .user-item {
            display: flex;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s ease, transform 0.3s ease, opacity 0.4s ease;
        }
        
        .chat-item:active, .user-item:active {
            background-color: var(--selection-color);
        }
        
        .chat-item.selected, .user-item.selected {
            background-color: var(--selection-color);
        }
        
        .chat-item.blocked {
            background-color: rgba(255, 107, 107, 0.1);
        }
        
        .chat-item.blocked .item-subtitle {
            color: var(--blocked-color);
            font-style: italic;
        }
        
        .item-content {
            flex: 1;
        }
        
        .item-title {
            font-weight: bold;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }
        
        .item-subtitle {
            color: #6b7280;
            font-size: 14px;
        }
        
        .item-time {
            color: #6b7280;
            font-size: 12px;
        }
        
        /* Badge Admin */
        .admin-badge {
            display: inline-block;
            background-color: var(--admin-badge-bg);
            color: var(--admin-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        /* Formulaires et entrées */
        .search-container {
            padding: 10px 16px;
            position: sticky;
            top: 0;
            background-color: var(--bg-color);
            z-index: 5;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 16px;
            border-radius: 18px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            color: var(--text-color);
        }
        
        /* Écran de chargement */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        
        /* Animation ballon de football avec Font Awesome */
        .football-spinner {
            font-size: 60px;
            color: var(--primary-color);
            animation: bounce 2s infinite, spin 3s linear infinite;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Paramètres */
        .settings-container {
            padding: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .setting-icon {
            width: 36px;
            height: 36px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .setting-label {
            font-weight: 500;
        }
        
        .button {
            background-color: var(--primary-color);
            color: black;
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            transition: transform 0.15s ease, opacity 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .button.danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .button:after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            20% {
                transform: scale(25, 25);
                opacity: 0.3;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }
        
        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        /* Interface de chat */
        .chat-section {
            display: none;
            position: fixed;
            top: 50px;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            z-index: 5;
        }
        
        .chat-messages-container {
            position: absolute;
            top: 0;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow-y: auto;
            background-color: var(--secondary-color);
            -webkit-overflow-scrolling: touch;
            padding: 15px;
        }
        
        .chat-messages {
            width: 100%;
            display: flex;
            flex-direction: column;
            min-height: 100%;
            justify-content: flex-end;
        }
        
        .chat-input-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            padding: 10px;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            align-items: center;
            height: 60px;
        }
        
        .message {
            max-width: 75%;
            padding: 10px 14px;
            margin-bottom: 10px;
            border-radius: 20px; /* Bulles de chat totalement rondes */
            position: relative;
            word-wrap: break-word;
            clear: both;
            transition: background-color 0.2s ease, transform 0.3s ease;
            transform: translateX(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Légère ombre pour effet 3D */
            font-weight: 500; /* Style iOS */
        }
        
        .message-received {
            background-color: var(--chat-received-bg);
            float: left;
            margin-right: auto;
            border-bottom-left-radius: 4px; /* Style iOS/WhatsApp */
        }
        
        .message-sent {
            background-color: var(--chat-sent-bg);
            color: var(--chat-sent-text);
            float: right;
            margin-left: auto;
            border-bottom-right-radius: 4px; /* Style iOS/WhatsApp */
        }
        
        .message.selected {
            background-color: var(--highlight-color);
            border: 2px solid var(--primary-color);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(247, 220, 111, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(247, 220, 111, 0); }
            100% { box-shadow: 0 0 0 0 rgba(247, 220, 111, 0); }
        }
        
        .message-time {
            font-size: 10px;
            margin-top: 4px;
            text-align: right;
            clear: both;
            opacity: 0.7;
        }
        
        .chat-input-wrapper {
            flex: 1;
            margin: 0 10px;
            position: relative;
            display: flex;
            align-items: center;
            background-color: var(--secondary-color);
            border-radius: 20px;
            overflow: hidden;
            height: 40px;
            padding: 0 5px;
        }
        
        .chat-input {
            width: 100%;
            height: 100%;
            padding: 8px 10px;
            border: none;
            background-color: transparent;
            font-size: 16px;
            color: var(--text-color);
            font-weight: 500; /* Style iOS */
        }
        
        .chat-input:focus {
            outline: none;
        }
        
        .input-icon {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--primary-color);
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s ease, transform 0.15s ease;
        }
        
        .input-icon:active {
            transform: scale(0.9);
            background-color: var(--selection-color);
        }
        
        .send-button {
            width: 35px;
            height: 35px;
            min-width: 35px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: transform 0.15s ease;
        }
        
        .send-button:active {
            transform: scale(0.9);
        }
        
        /* Message action menu */
        .message-actions {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--action-menu-bg);
            color: var(--action-menu-text);
            z-index: 20;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        .message-actions.active {
            transform: translateY(0);
        }
        
        .message-actions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .selected-count {
            font-weight: bold;
        }
        
        .close-actions {
            color: var(--primary-color);
            padding: 8px;
            cursor: pointer;
        }
        
        .action-buttons {
            display: flex;
            padding: 20px;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        
        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.15s ease;
            margin: 5px 10px;
        }
        
        .action-button:active {
            transform: scale(0.9);
        }
        
        .action-icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .action-label {
            font-size: 12px;
        }
        
        /* Selection mode indicator */
        .selection-mode-indicator {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            color: black;
            padding: 8px 15px;
            font-weight: bold;
            display: none;
            z-index: 15;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        /* Menu options */
        .options-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 40;
            overflow: hidden;
            width: 80%;
            max-width: 300px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .options-menu.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            visibility: visible;
        }
        
        .option-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .option-item:last-child {
            border-bottom: none;
        }
        
        .option-item:active {
            background-color: var(--selection-color);
        }
        
        .option-icon {
            width: 24px;
            text-align: center;
            margin-right: 15px;
            color: var(--primary-color);
        }
        
        .option-label {
            flex: 1;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 35;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Conversations action menu */
        .conversations-actions {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--action-menu-bg);
            color: var(--action-menu-text);
            z-index: 20;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        .conversations-actions.active {
            transform: translateY(0);
        }
        
        .check-circle {
            position: absolute;
            top: 10px;
            right: 15px;
            color: var(--primary-color);
            font-size: 20px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .chat-item.selected .check-circle,
        .user-item.selected .check-circle {
            opacity: 1;
        }
        
        /* Image preview */
        .image-preview {
            padding: 10px;
            display: none;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            position: absolute;
            bottom: 60px;
            left: 0;
            right: 0;
        }
        
        .image-preview.active {
            display: block;
        }
        
        .preview-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .preview-close {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Message with image */
        .message-image {
            max-width: 200px;
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .message-image:active {
            transform: scale(0.98);
        }
        
        /* Style pour la sélection Telegram-like */
        .chat-list {
            position: relative;
        }
        
        .chat-select-checkbox {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-50%) scale(0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        
        .chat-select-checkbox.visible {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .chat-select-checkbox.checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .chat-select-checkbox.checked::after {
            content: "✓";
            color: black;
            font-size: 14px;
            font-weight: bold;
        }
        
        .chat-item.selecting {
            padding-left: 40px;
        }
        
        .telegram-selection-mode .chat-select-checkbox {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .telegram-selection-mode .chat-item {
            padding-left: 40px;
        }
        
        /* Style pour le groupe */
        .message-sender {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
            opacity: 0.8;
        }
        
        /* Style pour la section profil modifiée */
        .profile-header {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .profile-header .profile-pic {
            width: 80px;
            height: 80px;
            margin-right: 20px;
        }
        
        .profile-header .profile-pic i {
            font-size: 30px;
            color: var(--primary-color);
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .profile-email {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .profile-status {
            color: #6b7280;
        }
        
        /* Styles pour le dialogue de sélection de contact pour le transfert */
        .forward-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 50;
            display: none;
            flex-direction: column;
        }
        
        .forward-dialog.active {
            display: flex;
        }
        
        .forward-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .forward-title {
            flex: 1;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }
        
        .forward-cancel {
            color: var(--primary-color);
            cursor: pointer;
        }
        
        .forward-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .forward-badge {
            background-color: var(--primary-color);
            color: black;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .confirmation-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 300px;
            padding: 20px;
            z-index: 60;
            display: none;
        }
        
        .confirmation-dialog.active {
            display: block;
        }
        
        .confirmation-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .confirmation-text {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .confirmation-buttons {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        
        .confirmation-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            flex-basis: 45%;
            text-align: center;
        }
        
        .confirmation-cancel {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        
        .confirmation-confirm {
            background-color: var(--primary-color);
            color: black;
        }
        
        .confirmation-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Sélection d'item pour toutes les sections */
        .selectable-item {
            position: relative;
        }
        
        .item-select-checkbox {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-50%) scale(0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        
        .item-select-checkbox.visible {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .item-select-checkbox.checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .item-select-checkbox.checked::after {
            content: "✓";
            color: black;
            font-size: 14px;
            font-weight: bold;
        }
        
        .selection-mode .selectable-item {
            padding-left: 40px;
        }
        
        .selection-mode .item-select-checkbox {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        /* Interface de recherche dans les messages */
        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 50;
            display: none;
            flex-direction: column;
        }
        
        .search-overlay.active {
            display: flex;
        }
        
        .search-header {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-back {
            color: var(--primary-color);
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .search-input-container {
            flex: 1;
            margin: 0 10px;
        }
        
        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .search-result-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            background-color: var(--secondary-color);
        }
        
        .search-result-text {
            margin-bottom: 5px;
        }
        
        .search-result-info {
            font-size: 12px;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
        }
        
        .search-highlight {
            background-color: var(--highlight-color);
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        
        /* Sections "À propos" */
        .about-container {
            padding: 20px;
            margin-top: 10px;
            background-color: var(--secondary-color);
            border-radius: 10px;
        }
        
        .about-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .about-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 15px;
        }
        
        .about-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 15px 0;
        }
        
        .about-version {
            text-align: center;
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.6;
            margin-top: 20px;
        }
        
        /* Animation de désintégration pour la suppression de messages */
        @keyframes disintegrate {
            0% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
            }
            30% {
                opacity: 0.9;
                transform: scale(0.98);
                filter: blur(1px);
            }
            60% {
                opacity: 0.6;
                transform: scale(0.9) translate(5px, 0);
                filter: blur(4px);
            }
            100% {
                opacity: 0;
                transform: scale(0.5) translate(20px, 10px);
                filter: blur(10px);
            }
        }
        
        .message.disintegrating {
            animation: disintegrate 0.8s ease-in forwards;
            pointer-events: none;
        }
        
        /* Animation de suppression pour les discussions */
        @keyframes fadeOutRight {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            60% {
                transform: translateX(30px);
                opacity: 0.2;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .chat-item.deleting {
            animation: fadeOutRight 0.5s ease-out forwards;
            pointer-events: none;
        }
        
        /* Nouveau mode de sélection amélioré */
        .new-selection-mode-indicator {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            padding: 10px 15px;
            display: none;
            z-index: 15;
            animation: slideInDown 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes slideInDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        .new-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .new-selection-title {
            font-weight: bold;
            color: black;
        }
        
        .new-selection-actions {
            display: flex;
            align-items: center;
        }
        
        .new-selection-action {
            padding: 5px 10px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            margin-left: 8px;
            font-size: 13px;
            font-weight: 500;
            color: black;
        }
        
        .new-selection-cancel {
            background: none;
        }
        
        /* Styles pour les discussions sélectionnables */
        .chat-item.swipe-selecting {
            transform: translateX(40px);
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .chat-item .select-indicator {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateX(-40px);
            transition: transform 0.3s ease;
        }
        
        .chat-item.swipe-selecting .select-indicator {
            transform: translateX(0);
        }
        
        .select-indicator-inner {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-item.selected .select-indicator-inner {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .chat-item.selected .select-indicator-inner::after {
            content: "✓";
            color: black;
            font-weight: bold;
        }

        /* Installation guide dialog */
        .install-guide {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 50;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .install-guide.active {
            display: flex;
        }
        
        .install-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .install-title {
            flex: 1;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }
        
        .install-close {
            color: var(--primary-color);
            padding: 8px;
            cursor: pointer;
        }
        
        .install-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .install-step {
            margin-bottom: 25px;
        }
        
        .install-step-title {
            font-weight: bold;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .install-step-number {
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            color: black;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .install-step-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
            opacity: 0.9;
        }
        
        .install-image {
            width: 100%;
            max-width: 280px;
            margin: 10px auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: block;
        }
        
        /* Dialogue de suppression amélioré */
        .delete-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 85%;
            max-width: 320px;
            padding: 20px;
            z-index: 60;
            display: none;
            animation: scaleInDialog 0.3s ease;
        }
        
        @keyframes scaleInDialog {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .delete-dialog.active {
            display: block;
        }
        
        .delete-icon {
            font-size: 40px;
            color: var(--danger-color);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .delete-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .delete-text {
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
            opacity: 0.8;
        }
        
        .delete-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .delete-option {
            padding: 12px;
            border-radius: 8px;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .delete-option:active, .delete-option.selected {
            background-color: var(--selection-color);
        }
        
        .delete-option.selected {
            border: 1px solid var(--primary-color);
        }
        
        .delete-option-icon {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .delete-option-label {
            font-weight: 500;
        }
        
        .delete-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .delete-button {
            flex-basis: 48%;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
        }
        
        .delete-cancel {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        
        .delete-confirm {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Bouton de suppression dans le mode sélection */
        .conversation-delete-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--danger-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 15;
            transform: scale(0);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .conversation-delete-btn.active {
            transform: scale(1);
        }
        
        .conversation-delete-btn:active {
            transform: scale(0.95);
        }

        /* Écran d'authentification */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .auth-header {
            padding: 40px 0 20px;
            text-align: center;
        }
        
        .auth-logo {
            font-size: 50px;
            color: var(--primary-color);
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .auth-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .auth-subtitle {
            font-size: 16px;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 20px;
            padding: 0 20px;
            text-align: center;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            color: var(--inactive-text);
            transition: color 0.3s;
        }
        
        .auth-tab.active {
            color: var(--primary-color);
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 25%;
            width: 50%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }
        
        .auth-form {
            padding: 20px;
            display: none;
            animation: fadeUp 0.5s ease;
        }
        
        @keyframes fadeUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            transform-origin: left;
            transition: transform 0.3s, color 0.3s;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            font-size: 16px;
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(247, 220, 111, 0.25);
        }
        
        .form-input::placeholder {
            color: var(--input-placeholder);
        }
        
        .form-error {
            color: var(--danger-color);
            font-size: 13px;
            margin-top: 6px;
            display: none;
            animation: shakeX 0.75s ease;
        }
        
        @keyframes shakeX {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        
        .form-footer {
            margin-top: 30px;
            text-align: center;
        }
        
        .form-footer-text {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .form-link {
            color: var(--link-color);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }
        
        .form-link:hover {
            text-decoration: underline;
        }

        /* Message log */
        .log-message {
            margin-top: 15px;
            padding: 12px;
            font-weight: bold;
            border-radius: 6px;
            white-space: pre-line;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
          
        .log-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }
          
        .log-message.success {
            background: #d4edda;
            color: #155724;
        }
          
        .log-message.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Empty state message */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--inactive-text);
        }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        /* ANIMATIONS POUR LES FORMULAIRES */
        .form-input:focus + .form-label {
            color: var(--primary-color);
            transform: translateY(-25px) scale(0.8);
        }
        
        .form-input.has-value + .form-label {
            transform: translateY(-25px) scale(0.8);
        }
        
        /* AMÉLIORATIONS DE L'ACCESSIBILITÉ */
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(247, 220, 111, 0.25);
        }
        
        /* TRANSITION ENTRE LES FORMULAIRES */
        .slide-left-enter {
            opacity: 0;
            transform: translateX(30px);
        }
        
        .slide-left-enter-active {
            opacity: 1;
            transform: translateX(0);
            transition: all 0.3s ease;
        }
        
        .slide-left-exit {
            opacity: 1;
            transform: translateX(0);
        }
        
        .slide-left-exit-active {
            opacity: 0;
            transform: translateX(-30px);
            transition: all 0.3s ease;
        }
        
        /* LOADER POUR LES REQUÊTES */
        .btn-loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--bg-color);
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .button.loading {
            pointer-events: none;
            opacity: 0.8;
        }
        
        .button.loading .btn-text {
            visibility: hidden;
        }
        
        .button.loading .btn-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -10px;
            margin-left: -10px;
            visibility: visible;
        }

        /* Bouton X pour la sélection (nouveau) */
        .select-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            opacity: 0.7;
            transition: opacity 0.2s ease, background-color 0.2s ease;
        }

        .chat-item:hover .select-btn {
            opacity: 1;
        }

        .select-btn:hover {
            background-color: var(--primary-color);
            color: black;
        }

        /* Style pour groupe "BetNews" où seul l'admin peut écrire */
        .admin-only-message {
            text-align: center;
            color: var(--inactive-text);
            padding: 10px;
            font-style: italic;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        /* Popup de succès */
        .success-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            padding: 30px;
            width: 90%;
            max-width: 320px;
            z-index: 1001;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .success-popup.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            visibility: visible;
        }
        
        .success-icon {
            font-size: 60px;
            color: var(--success-color);
            margin-bottom: 20px;
        }
        
        .success-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .success-message {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 25px;
            color: var(--text-color);
            opacity: 0.9;
        }
        
        /* Animation d'erreur pour les entrées */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.6s ease;
        }

        /* Nouveau style pour la barre d'action en sélection */
        .selection-action-bar {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--primary-color);
            color: black;
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 30;
            animation: slideInDown 0.3s ease;
        }

        .selection-action-bar.active {
            display: flex;
        }

        .selection-count {
            font-weight: bold;
            font-size: 16px;
        }

        .selection-actions {
            display: flex;
            gap: 20px;
        }

        .selection-action {
            padding: 5px 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .selection-action.delete {
            color: var(--danger-color);
        }

        /* Style pour longpress visual feedback */
        @keyframes pulse-selection {
            0% { transform: scale(1); }
            50% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }

        .chat-item.longpressing {
            animation: pulse-selection 0.6s ease infinite;
            background-color: var(--selection-color);
        }

        /* ============= FENÊTRE DE LOGS =============== */
        .logs-window {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            max-height: 50%;
            background-color: var(--log-bg);
            color: var(--log-text);
            z-index: 100;
            border-top: 2px solid var(--primary-color);
            display: none;
            flex-direction: column;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .logs-window.active {
            display: flex;
            transform: translateY(0);
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.3);
        }

        .logs-title {
            font-weight: bold;
            font-size: 14px;
        }

        .logs-actions {
            display: flex;
            gap: 10px;
        }

        .logs-action {
            padding: 4px 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--primary-color);
        }

        .logs-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
        }

        .log-entry {
            margin-bottom: 4px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            word-break: break-all;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.info {
            color: var(--log-info);
        }

        .log-entry.warning {
            color: var(--log-warning);
        }

        .log-entry.error {
            color: var(--log-error);
        }

        .log-entry.success {
            color: var(--log-success);
        }

        .log-time {
            font-size: 10px;
            opacity: 0.7;
            margin-right: 6px;
        }

        .logs-toggle {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--log-bg);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 99;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .logs-toggle:active {
            transform: scale(0.95);
        }

        /* Style pour les informations de groupe */
        .group-info-badge {
            display: inline-flex;
            align-items: center;
            background-color: rgba(93, 92, 222, 0.2);
            color: var(--primary-color);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }

        .group-info-badge i {
            margin-right: 4px;
            font-size: 10px;
        }

        /* ============= VISIONNEUSE D'IMAGES PERSONNALISÉE =============== */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--image-viewer-bg);
            z-index: 1000;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }

        .image-viewer.active {
            display: flex;
        }

        .image-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            color: white;
            z-index: 1010;
        }

        .image-viewer-close {
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease;
        }

        .image-viewer-close:active {
            background-color: rgba(0, 0, 0, 0.4);
        }

        .image-viewer-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .image-viewer-img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            user-select: none;
            touch-action: none;
            transform-origin: center;
            transition: transform 0.2s ease;
        }

        .image-viewer-img.zoomed {
            cursor: grab;
        }

        .image-viewer-img.zoomed:active {
            cursor: grabbing;
        }

        .image-viewer-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1010;
        }

        .image-viewer-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .image-viewer-button:active {
            background-color: rgba(0, 0, 0, 0.7);
            transform: scale(0.95);
        }

        .image-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 3px solid var(--loading-spinner);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        /* ============= STYLE DE NOTIFICATION =============== */
        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-width: 80%;
            text-align: center;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--danger-color);
        }

        .notification.info {
            border-left: 4px solid var(--primary-color);
        }

        /* État de livraison des messages */
        .message-status {
            font-size: 10px;
            margin-top: 2px;
            text-align: right;
            color: rgba(255, 255, 255, 0.7);
        }

        .message-status.pending {
            color: rgba(255, 255, 255, 0.5);
        }

        .message-status.error {
            color: var(--danger-color);
        }

        .message-status i {
            margin-left: 3px;
        }

        /* Indicateur de connexion */
        .connection-status {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            padding: 5px;
            background-color: var(--danger-color);
            color: white;
            text-align: center;
            font-size: 12px;
            z-index: 100;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .connection-status.offline {
            transform: translateY(0);
        }

        .connection-status.reconnecting {
            background-color: var(--warning-color);
            transform: translateY(0);
        }
        
        /* Style pour les réactions emoji */
        .reaction-panel {
            position: absolute;
            display: flex;
            background-color: var(--reaction-bg);
            border-radius: 24px;
            padding: 5px;
            box-shadow: 0 2px 10px var(--reaction-shadow);
            z-index: 25;
            animation: scaleIn 0.2s ease;
            transform-origin: center;
        }
        
        @keyframes scaleIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .reaction-emoji {
            font-size: 20px;
            padding: 5px 8px;
            cursor: pointer;
            transition: transform 0.15s ease;
            border-radius: 20px;
        }
        
        .reaction-emoji:hover, .reaction-emoji:active {
            transform: scale(1.2);
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .message-reactions {
            display: flex;
            flex-wrap: wrap;
            margin-top: 5px;
            gap: 4px;
        }
        
        .message-reaction {
            display: inline-flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 3px 6px;
            font-size: 14px;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        
        .reaction-count {
            margin-left: 4px;
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Quoted message style */
        .quoted-message {
            padding: 8px 10px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 2px solid;
            font-size: 14px;
            position: relative;
        }
        
        .quoted-message.from-me {
            border-left-color: var(--chat-sent-bg);
        }
        
        .quoted-message.from-them {
            border-left-color: var(--chat-received-bg);
        }
        
        .quoted-sender {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .quoted-sender.from-me {
            color: var(--chat-sent-bg);
        }
        
        .quoted-sender.from-them {
            color: var(--primary-color);
        }
        
        .quoted-content {
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: none;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
        }
        
        .typing-indicator.active {
            display: block;
        }
        
        .typing-dots {
            display: inline-flex;
            margin-left: 5px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #6b7280;
            border-radius: 50%;
            margin: 0 2px;
            animation: typingDot 1.4s infinite;
            opacity: 0.6;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingDot {
            0% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
            50% { transform: translateY(0); }
            100% { transform: translateY(0); }
        }
        
        /* Create group button */
        .create-group-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
            transition: transform 0.2s ease;
        }
        
        .create-group-btn:active {
            transform: scale(0.95);
        }
        
        /* Create group dialog */
        .create-group-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 320px;
            padding: 20px;
            z-index: 60;
            display: none;
        }
        
        .create-group-dialog.active {
            display: block;
            animation: scaleInDialog 0.3s ease;
        }
        
        .create-group-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .create-group-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            font-size: 16px;
            color: var(--text-color);
            margin-bottom: 15px;
        }
        
        .create-group-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(247, 220, 111, 0.25);
        }
        
        .create-group-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .create-group-btn-cancel, .create-group-btn-create {
            flex-basis: 48%;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
        }
        
        .create-group-btn-cancel {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        
        .create-group-btn-create {
            background-color: var(--primary-color);
            color: black;
        }
    </style>
</head>
<body>
    <!-- Écran d'authentification -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fas fa-futbol"></i>
            </div>
            <h1 class="auth-title">iChat</h1>
            <p class="auth-subtitle">La messagerie moderne et sécurisée</p>
        </div>
        
        <div class="auth-tabs">
            <div class="auth-tab active" id="login-tab">Connexion</div>
            <div class="auth-tab" id="register-tab">Inscription</div>
        </div>
        
        <!-- Formulaire de Connexion -->
        <div id="login-form" class="auth-form active">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="login-email" placeholder="Votre email">
                <div id="login-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="login-password" placeholder="Votre mot de passe">
                <div id="login-password-error" class="form-error">Le mot de passe est obligatoire</div>
            </div>
            
            <div id="login-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="loginBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Se connecter</span>
                </button>
                <p class="form-footer-text">
                    Vous n'avez pas de compte ? <a href="#" class="form-link" id="goto-register">S'inscrire</a>
                </p>
            </div>
        </div>
        
        <!-- Formulaire d'Inscription -->
        <div id="register-form" class="auth-form">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="register-email" placeholder="Votre adresse email">
                <div id="register-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="register-password" placeholder="Créez un mot de passe sécurisé">
                <div id="register-password-error" class="form-error">Le mot de passe doit contenir au moins 6 caractères</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Confirmer le mot de passe</label>
                <input type="password" class="form-input" id="register-confirm-password" placeholder="Confirmez votre mot de passe">
                <div id="register-confirm-password-error" class="form-error">Les mots de passe ne correspondent pas</div>
            </div>
            
            <div id="register-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="registerBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">S'inscrire</span>
                </button>
                <p class="form-footer-text">
                    Vous avez déjà un compte ? <a href="#" class="form-link" id="goto-login">Se connecter</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Écran de chargement -->
    <div id="loading" class="loading">
        <i class="fas fa-futbol football-spinner"></i>
        <div style="font-weight: bold; font-size: 24px; color: var(--primary-color);">iChat</div>
        <div style="margin-top: 10px; color: #6b7280;">Chargement...</div>
    </div>

    <!-- Indicateur de connexion -->
    <div class="connection-status" id="connection-status"></div>

    <!-- En-tête -->
    <div class="header">
        <div id="header-left">
            <span id="header-button" style="display:none;">
                <i class="fas fa-chevron-left"></i>
            </span>
        </div>
        <div id="header-title" class="header-title">Messages</div>
        <div id="header-action">
            <span class="notification-icon" id="options-button">
                <i class="fas fa-ellipsis-v"></i>
            </span>
        </div>
    </div>

    <!-- Barre d'action en mode sélection -->
    <div id="selection-action-bar" class="selection-action-bar">
        <div class="selection-count" id="selection-action-count">1 sélectionné</div>
        <div class="selection-actions">
            <div class="selection-action delete" id="selection-delete">Supprimer</div>
            <div class="selection-action" id="selection-cancel">Annuler</div>
        </div>
    </div>

    <!-- Overlay pour le menu d'options -->
    <div id="overlay" class="overlay"></div>

    <!-- Menu d'options simplifié pour les sections hors messages -->
    <div id="simple-options-menu" class="options-menu">
        <div class="option-item" id="change-theme-option">
            <div class="option-icon"><i class="fas fa-palette"></i></div>
            <div class="option-label">Changer de thème</div>
        </div>
        <div class="option-item" id="show-install-guide-option">
            <div class="option-icon"><i class="fas fa-download"></i></div>
            <div class="option-label">Installer l'application</div>
        </div>
        <div class="option-item" id="show-logs-option">
            <div class="option-icon"><i class="fas fa-bug"></i></div>
            <div class="option-label">Afficher les logs</div>
        </div>
    </div>
    
    <!-- Menu d'options pour la section messages -->
    <div id="messages-options-menu" class="options-menu">
        <div class="option-item" id="create-group-option">
            <div class="option-icon"><i class="fas fa-users"></i></div>
            <div class="option-label">Créer un groupe</div>
        </div>
        <div class="option-item" id="change-theme-messages-option">
            <div class="option-icon"><i class="fas fa-palette"></i></div>
            <div class="option-label">Changer de thème</div>
        </div>
        <div class="option-item" id="show-install-guide-messages-option">
            <div class="option-icon"><i class="fas fa-download"></i></div>
            <div class="option-label">Installer l'application</div>
        </div>
        <div class="option-item" id="show-logs-messages-option">
            <div class="option-icon"><i class="fas fa-bug"></i></div>
            <div class="option-label">Afficher les logs</div>
        </div>
    </div>

    <!-- Menu d'options de chat (avec recherche de messages) -->
    <div id="chat-options-menu" class="options-menu">
        <div class="option-item" id="select-messages-option">
            <div class="option-icon"><i class="fas fa-check-square"></i></div>
            <div class="option-label">Sélectionner des messages</div>
        </div>
        <div class="option-item" id="search-conversation-option">
            <div class="option-icon"><i class="fas fa-search"></i></div>
            <div class="option-label">Rechercher dans la conversation</div>
        </div>
        <div class="option-item" id="clear-conversation-option">
            <div class="option-icon"><i class="fas fa-trash-alt"></i></div>
            <div class="option-label">Effacer la conversation</div>
        </div>
        <div class="option-item" id="show-install-guide-chat-option">
            <div class="option-icon"><i class="fas fa-download"></i></div>
            <div class="option-label">Installer l'application</div>
        </div>
        <div class="option-item" id="show-logs-chat-option">
            <div class="option-icon"><i class="fas fa-bug"></i></div>
            <div class="option-label">Afficher les logs</div>
        </div>
    </div>

    <!-- Contenu principal de l'application -->
    <div class="content">
        <!-- Section Messages -->
        <div id="messages-section" class="section active">
            <div class="search-container">
                <input type="text" class="search-input" id="messages-search" placeholder="Rechercher">
            </div>
            
            <div class="chat-list" id="chat-list">
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <div class="empty-state-title">Aucune conversation</div>
                    <div class="empty-state-text">Vos conversations apparaîtront ici</div>
                </div>
            </div>
            
            <!-- Bouton de création de groupe -->
            <div class="create-group-btn" id="create-group-floating-btn">
                <i class="fas fa-plus"></i>
            </div>
        </div>
        
        <!-- Section Profil -->
        <div id="profile-section" class="section">
            <div class="profile-header">
                <div class="profile-pic">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="profile-name">
                        <span id="profile-name-text">Utilisateur</span>
                        <span class="admin-badge" id="admin-badge" style="display: none;">Admin</span>
                    </div>
                    <div class="profile-email" id="profile-email">user@example.com</div>
                    <div class="profile-status">En ligne</div>
                </div>
            </div>
            
            <div style="padding: 0 16px; margin: 15px 0; font-weight: bold; font-size: 18px;">Paramètres</div>
            
            <div class="settings-container">
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-palette" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Couleur de l'interface</div>
                    </div>
                    <input type="color" id="color-picker" value="#F7DC6F" style="width: 30px; height: 30px; border: none;">
                </div>
                
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-moon" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Mode sombre</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="dark-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-item" id="debug-setting">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-bug" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Mode débogage</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="debug-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <!-- Section "À propos" -->
                <div style="padding: 0; margin: 20px 0 15px 0; font-weight: bold; font-size: 18px;">À propos</div>
                
                <div class="about-container">
                    <div class="about-title">iChat</div>
                    <div class="about-text">Une application de messagerie sécurisée et facile à utiliser qui vous permet de rester en contact avec vos amis et votre famille.</div>
                    
                    <div class="about-divider"></div>
                    
                    <div class="about-text">
                        <strong>Fonctionnalités :</strong>
                        <ul style="padding-left: 20px; margin-top: 5px;">
                            <li>Messagerie instantanée</li>
                            <li>Partage de photos</li>
                            <li>Groupes de discussion</li>
                            <li>Mode sombre</li>
                        </ul>
                    </div>
                    
                    <div class="about-version">Version 3.0.0</div>
                </div>
                
                <button id="logout-btn" class="button">Se déconnecter</button>
                
                <!-- Bouton pour supprimer le compte -->
                <button id="delete-account-btn" class="button danger">Supprimer mon compte</button>
            </div>
        </div>
    </div>

    <!-- Interface de Chat -->
    <div id="chat-interface" class="chat-section">
        <div class="chat-messages-container">
            <div class="chat-messages" id="chat-messages">
                <!-- Les messages seront ajoutés dynamiquement ici -->
            </div>
            <div id="typing-indicator" class="typing-indicator">
                <span id="typing-name"></span> est en train d'écrire
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
        <div id="image-preview" class="image-preview">
            <div style="position: relative; display: inline-block;">
                <img id="preview-img" class="preview-image" src="" alt="Aperçu">
                <div class="preview-close" id="preview-close">
                    <i class="fas fa-times"></i>
                </div>
            </div>
        </div>
        <div class="chat-input-container" id="chat-input-container">
            <div class="chat-input-wrapper">
                <div class="input-icon" id="emoji-button">
                    <i class="far fa-smile"></i>
                </div>
                <input type="text" id="chat-input" class="chat-input" placeholder="Écrire un message..." autocomplete="off">
                <div class="input-icon" id="attachment-button">
                    <i class="fas fa-paperclip"></i>
                </div>
            </div>
            <div class="send-button" id="send-button">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>
        <input type="file" id="image-input" accept="image/*" style="display: none;">
    </div>

    <!-- Interface de recherche dans les messages -->
    <div id="search-overlay" class="search-overlay">
        <div class="search-header">
            <div class="search-back" id="search-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="search-input-container">
                <input type="text" id="message-search-input" class="search-input" placeholder="Rechercher dans les messages...">
            </div>
        </div>
        <div id="search-results" class="search-results">
            <div class="no-results">Saisissez un terme à rechercher</div>
        </div>
    </div>

    <!-- Menu d'actions pour les messages sélectionnés -->
    <div id="message-actions" class="message-actions">
        <div class="message-actions-header">
            <div class="selected-count" id="selected-count">1 sélectionné</div>
            <div class="close-actions" id="close-message-actions">Annuler</div>
        </div>
        <div class="action-buttons">
            <div class="action-button" id="delete-messages-btn">
                <div class="action-icon"><i class="fas fa-trash-alt"></i></div>
                <div class="action-label">Supprimer</div>
            </div>
            <div class="action-button" id="forward-messages-btn">
                <div class="action-icon"><i class="fas fa-share"></i></div>
                <div class="action-label">Transférer</div>
            </div>
            <div class="action-button" id="copy-messages-btn">
                <div class="action-icon"><i class="fas fa-copy"></i></div>
                <div class="action-label">Copier</div>
            </div>
            <div class="action-button" id="reply-message-btn">
                <div class="action-icon"><i class="fas fa-reply"></i></div>
                <div class="action-label">Répondre</div>
            </div>
        </div>
    </div>

    <!-- Menu de réactions emoji rapides -->
    <div id="reaction-panel" class="reaction-panel" style="display: none;">
        <div class="reaction-emoji" data-emoji="👍">👍</div>
        <div class="reaction-emoji" data-emoji="😂">😂</div>
        <div class="reaction-emoji" data-emoji="😡">😡</div>
        <div class="reaction-emoji" data-emoji="👎">👎</div>
        <div class="reaction-emoji" data-emoji="🤯">🤯</div>
        <div class="reaction-emoji" data-emoji="🎉">🎉</div>
    </div>

    <!-- Interface de transfert de messages -->
    <div id="forward-dialog" class="forward-dialog">
        <div class="forward-header">
            <div class="forward-cancel" id="forward-cancel">Annuler</div>
            <div class="forward-title">Transférer à <span id="forward-count-badge" class="forward-badge">1</span></div>
        </div>
        <div class="forward-list" id="forward-contacts-list">
            <!-- Les contacts seront ajoutés dynamiquement ici -->
        </div>
    </div>

    <!-- Boîte de dialogue de confirmation -->
    <div id="confirmation-dialog" class="confirmation-dialog">
        <div class="confirmation-title">Confirmation</div>
        <div class="confirmation-text" id="confirmation-text">Êtes-vous sûr de vouloir effectuer cette action?</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="confirmation-cancel">Annuler</div>
            <div class="confirmation-button confirmation-confirm" id="confirmation-confirm">Confirmer</div>
        </div>
    </div>

    <!-- Boîte de dialogue de suppression de compte -->
    <div id="delete-account-dialog" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer le compte</div>
        <div class="confirmation-text">Êtes-vous sûr de vouloir supprimer votre compte ? Cette action est irréversible et toutes vos données seront perdues.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-account-cancel">Annuler</div>
            <div class="confirmation-button confirmation-danger" id="delete-account-confirm">Supprimer</div>
        </div>
    </div>

    <!-- Dialogue de suppression des messages avec options -->
    <div id="delete-message-dialog" class="delete-dialog">
        <div class="delete-icon">
            <i class="fas fa-trash-alt"></i>
        </div>
        <div class="delete-title">Supprimer les messages</div>
        <div class="delete-text">Comment souhaitez-vous supprimer ces messages ?</div>
        
        <div class="delete-options">
            <div class="delete-option" id="delete-for-me">
                <div class="delete-option-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="delete-option-label">Supprimer pour moi seulement</div>
            </div>
            <div class="delete-option" id="delete-for-all">
                <div class="delete-option-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="delete-option-label">Supprimer pour tout le monde</div>
            </div>
        </div>
        
        <div class="delete-buttons">
            <div class="delete-button delete-cancel" id="delete-messages-cancel">Annuler</div>
            <div class="delete-button delete-confirm" id="delete-messages-confirm">Supprimer</div>
        </div>
    </div>

    <!-- Dialogue de création de groupe -->
    <div id="create-group-dialog" class="create-group-dialog">
        <div class="create-group-title">Créer un groupe</div>
        <input type="text" class="create-group-input" id="group-name-input" placeholder="Nom du groupe">
        <input type="text" class="create-group-input" id="group-description-input" placeholder="Description (optionnel)">
        <div class="create-group-buttons">
            <div class="create-group-btn-cancel" id="create-group-cancel">Annuler</div>
            <div class="create-group-btn-create" id="create-group-submit">Créer</div>
        </div>
    </div>

    <!-- Guide d'installation -->
    <div id="install-guide" class="install-guide">
        <div class="install-header">
            <div class="install-close" id="close-install-guide">
                <i class="fas fa-times"></i>
            </div>
            <div class="install-title">Installer l'application</div>
        </div>
        <div class="install-content">
            <div class="install-step">
                <div class="install-step-title">
                    <div class="install-step-number">1</div>
                    <div>Sur iPhone & iPad (Safari)</div>
                </div>
                <div class="install-step-text">
                    Appuyez sur l'icône de partage dans la barre de navigation (rectangle avec une flèche pointant vers le haut).
                </div>
                <div class="install-step-text" style="margin-top: 10px;">
                    Faites défiler les options et appuyez sur "Sur l'écran d'accueil".
                </div>
            </div>
            
            <div class="install-step">
                <div class="install-step-title">
                    <div class="install-step-number">2</div>
                    <div>Sur Android (Chrome)</div>
                </div>
                <div class="install-step-text">
                    Appuyez sur les trois points dans le coin supérieur droit puis sur "Ajouter à l'écran d'accueil".
                </div>
            </div>
            
            <div class="install-step">
                <div class="install-step-title">
                    <div class="install-step-number">3</div>
                    <div>Sur ordinateur (Chrome)</div>
                </div>
                <div class="install-step-text">
                    Cliquez sur les trois points dans le coin supérieur droit puis sur "Installer iChat".
                </div>
            </div>
            
            <div class="install-step">
                <div class="install-step-text" style="text-align: center; margin-top: 30px;">
                    Une fois installée, l'application fonctionnera en mode plein écran et hors-ligne comme une application native !
                </div>
            </div>
        </div>
    </div>

    <!-- Popup de succès -->
    <div id="success-popup" class="success-popup">
        <div class="success-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h3 class="success-title" id="success-title">Succès !</h3>
        <p class="success-message" id="success-message">Opération réussie avec succès !</p>
        <button class="button" id="success-button">Continuer</button>
    </div>

    <!-- Fenêtre de logs détaillés -->
    <div id="logs-window" class="logs-window">
        <div class="logs-header">
            <div class="logs-title">Logs détaillés</div>
            <div class="logs-actions">
                <div class="logs-action" id="logs-clear">Effacer</div>
                <div class="logs-action" id="logs-close">Fermer</div>
            </div>
        </div>
        <div class="logs-content" id="logs-content">
            <!-- Les logs seront ajoutés ici dynamiquement -->
        </div>
    </div>

    <!-- Bouton pour afficher les logs -->
    <div class="logs-toggle" id="logs-toggle">
        <i class="fas fa-bug"></i>
    </div>

    <!-- Visionneuse d'images personnalisée -->
    <div id="image-viewer" class="image-viewer">
        <div class="image-viewer-header">
            <div class="image-viewer-close" id="image-viewer-close">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="image-viewer-content">
            <div class="image-loader" id="image-loader"></div>
            <img src="" alt="Image agrandie" id="image-viewer-img" class="image-viewer-img">
        </div>
        <div class="image-viewer-controls">
            <div class="image-viewer-button" id="image-viewer-zoom-out">
                <i class="fas fa-search-minus"></i>
            </div>
            <div class="image-viewer-button" id="image-viewer-zoom-in">
                <i class="fas fa-search-plus"></i>
            </div>
            <div class="image-viewer-button" id="image-viewer-download">
                <i class="fas fa-download"></i>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Barre d'onglets -->
    <div class="tabbar" id="tabbar">
        <a href="#" class="tab active" data-section="messages">
            <i class="tab-icon fas fa-comments"></i>
            <span>Messages</span>
        </a>
        <a href="#" class="tab" data-section="profile">
            <i class="tab-icon fas fa-user"></i>
            <span>Profil</span>
        </a>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy, addDoc, onSnapshot, where, deleteDoc, serverTimestamp, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDTPLxUiA8lj82kqc6CyCPLQDITc0CtLUE",
            authDomain: "ichat-betai.firebaseapp.com",
            databaseURL: "https://ichat-betai-default-rtdb.firebaseio.com",
            projectId: "ichat-betai",
            storageBucket: "ichat-betai.appspot.com",
            messagingSenderId: "168337722600",
            appId: "1:168337722600:web:beb331f83cc4778c5b4d5d",
            measurementId: "G-STXPSZN7X8"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables globales
        let isLoggedIn = false;
        let currentUser = null;
        let currentUserData = null;
        let isAdmin = false;
        let isDebugMode = false;
        
        // Variables pour l'interface de chat
        let currentContact = '';
        let currentDiscussionId = null;
        let currentDiscussionType = null;
        let isSelectionMode = false;
        let selectionModeType = '';
        let selectedMessages = new Set();
        let selectedItems = new Set();
        let messagesForForward = [];
        let targetContactForForward = '';
        let messageReactions = {};
        let replyToMessage = null;
        let selectedImage = null;
        let isOptionsMenuOpen = false;
        let lastTap = 0;
        let currentTappedMessage = null;
        let currentSection = 'messages';
        let selectedDeleteOption = 'for-me';
        let pendingMessages = {};
        let longPressTimer = null;
        let longPressDuration = 500; // Durée en ms pour considérer un appui long
        let chatUnsubscribers = {}; // Pour stocker les fonctions d'unsubscribe des écouteurs de chat
        let isOnline = navigator.onLine;
        let messageQueue = []; // Pour stocker les messages à envoyer lorsque hors ligne
        let currentImageScale = 1;
        let currentImagePosition = { x: 0, y: 0 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        
        // ================ FONCTIONS POUR LE SYSTÈME DE LOGS ================
        
        // Système de logs
        const logSystem = {
            logs: [],
            maxLogs: 500,
            
            // Ajouter un log
            log: function(message, type = 'info') {
                const time = new Date().toISOString().substring(11, 23);
                const logEntry = {
                    time: time,
                    message: message,
                    type: type
                };
                
                this.logs.push(logEntry);
                
                // Garder un nombre limité de logs
                if (this.logs.length > this.maxLogs) {
                    this.logs.shift();
                }
                
                // Afficher le log dans la console
                switch(type) {
                    case 'error':
                        console.error(`[${time}] ${message}`);
                        break;
                    case 'warning':
                        console.warn(`[${time}] ${message}`);
                        break;
                    case 'success':
                        console.log(`%c[${time}] ${message}`, 'color: green; font-weight: bold');
                        break;
                    default:
                        console.log(`[${time}] ${message}`);
                }
                
                // Mettre à jour l'interface des logs si elle est visible
                if (document.getElementById('logs-window').classList.contains('active')) {
                    this.updateLogsDisplay();
                }
                
                // Si on est en mode debug, montrer le bouton de logs
                if (isDebugMode) {
                    document.getElementById('logs-toggle').style.display = 'flex';
                }
                
                return logEntry;
            },
            
            // Log d'info
            info: function(message) {
                return this.log(message, 'info');
            },
            
            // Log d'erreur
            error: function(message) {
                return this.log(message, 'error');
            },
            
            // Log d'avertissement
            warning: function(message) {
                return this.log(message, 'warning');
            },
            
            // Log de succès
            success: function(message) {
                return this.log(message, 'success');
            },
            
            // Mettre à jour l'affichage des logs
            updateLogsDisplay: function() {
                const logsContent = document.getElementById('logs-content');
                logsContent.innerHTML = '';
                
                this.logs.forEach(logEntry => {
                    const logElement = document.createElement('div');
                    logElement.className = `log-entry ${logEntry.type}`;
                    
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'log-time';
                    timeSpan.textContent = logEntry.time;
                    
                    logElement.appendChild(timeSpan);
                    logElement.appendChild(document.createTextNode(logEntry.message));
                    
                    logsContent.appendChild(logElement);
                });
                
                // Défiler vers le bas pour voir les logs les plus récents
                logsContent.scrollTop = logsContent.scrollHeight;
            },
            
            // Effacer tous les logs
            clear: function() {
                this.logs = [];
                this.updateLogsDisplay();
            },
            
            // Afficher la fenêtre de logs
            showLogs: function() {
                document.getElementById('logs-window').classList.add('active');
                this.updateLogsDisplay();
            },
            
            // Masquer la fenêtre de logs
            hideLogs: function() {
                document.getElementById('logs-window').classList.remove('active');
            }
        };
        
        // ================ FONCTIONS POUR LA VÉRIFICATION DE CONNEXION ================
        
        // Surveiller la connexion internet
        function setupConnectionMonitoring() {
            const connectionStatus = document.getElementById('connection-status');
            
            function updateConnectionStatus() {
                if (navigator.onLine) {
                    connectionStatus.textContent = '';
                    connectionStatus.classList.remove('offline');
                    connectionStatus.classList.remove('reconnecting');
                    isOnline = true;
                    
                    // Traiter les messages en attente d'envoi
                    processQueuedMessages();
                } else {
                    connectionStatus.textContent = 'Pas de connexion internet';
                    connectionStatus.classList.add('offline');
                    isOnline = false;
                }
            }
            
            window.addEventListener('online', () => {
                logSystem.info('Connexion internet rétablie');
                connectionStatus.textContent = 'Reconnexion en cours...';
                connectionStatus.classList.remove('offline');
                connectionStatus.classList.add('reconnecting');
                
                // Attendre un peu pour s'assurer que la connexion est stable
                setTimeout(() => {
                    updateConnectionStatus();
                    // Recharger les discussions si on est connecté
                    if (isLoggedIn && currentSection === 'messages') {
                        loadConversations();
                    }
                }, 1500);
            });
            
            window.addEventListener('offline', () => {
                logSystem.warning('Connexion internet perdue');
                updateConnectionStatus();
                showNotification('Pas de connexion internet. Les messages seront envoyés lorsque vous serez connecté.', 'error');
            });
            
            // Vérifier l'état initial
            updateConnectionStatus();
        }
        
        // Traiter les messages en attente d'envoi
        async function processQueuedMessages() {
            if (messageQueue.length === 0) return;
            
            logSystem.info(`Traitement de ${messageQueue.length} message(s) en attente d'envoi`);
            
            const processedMessages = [...messageQueue];
            messageQueue = []; // Vider la file d'attente
            
            for (const message of processedMessages) {
                try {
                    await sendMessageToFirestore(
                        message.discussionId, 
                        message.text, 
                        message.image, 
                        message.replyTo
                    );
                    logSystem.success(`Message envoyé après reconnexion`);
                } catch (error) {
                    logSystem.error(`Échec de l'envoi après reconnexion: ${error.message}`);
                    // Remettre le message dans la file d'attente
                    messageQueue.push(message);
                }
            }
            
            if (messageQueue.length > 0) {
                showNotification(`${messageQueue.length} message(s) n'ont pas pu être envoyés`, 'error');
            } else if (processedMessages.length > 0) {
                showNotification('Tous les messages ont été envoyés', 'success');
            }
        }
        
        // Afficher une notification dans l'interface
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            
            // Afficher la notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Masquer la notification après un délai
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.className = 'notification';
                }, 300);
            }, 3000);
        }
        
        // ================ FONCTIONS POUR LES ÉVÉNEMENTS D'INTERFACE ================
        
        // Fonction pour détecter le mode sombre du système
        function setupDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
            
            // Initialiser l'état du toggle
            document.getElementById('dark-toggle').checked = document.documentElement.classList.contains('dark');
        }
        
        // Fonction pour configurer les événements de l'interface
        function setupUIEvents() {
            // Onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionName = tab.getAttribute('data-section');
                    changeTab(sectionName);
                });
            });
            
            // Boutons d'options
            document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            document.getElementById('overlay').addEventListener('click', closeAllDialogs);
            
            // Options menus
            document.getElementById('change-theme-option').addEventListener('click', changeTheme);
            document.getElementById('change-theme-messages-option').addEventListener('click', changeTheme);
            document.getElementById('show-install-guide-option').addEventListener('click', showInstallGuide);
            document.getElementById('show-install-guide-messages-option').addEventListener('click', showInstallGuide);
            document.getElementById('show-install-guide-chat-option').addEventListener('click', showInstallGuide);
            document.getElementById('select-messages-option').addEventListener('click', startMessagesSelectionMode);
            document.getElementById('search-conversation-option').addEventListener('click', searchInConversation);
            document.getElementById('clear-conversation-option').addEventListener('click', clearConversation);
            document.getElementById('create-group-option').addEventListener('click', showCreateGroupDialog);
            
            // Création de groupe
            document.getElementById('create-group-floating-btn').addEventListener('click', showCreateGroupDialog);
            document.getElementById('create-group-submit').addEventListener('click', createNewGroup);
            document.getElementById('create-group-cancel').addEventListener('click', closeCreateGroupDialog);
            
            // Options de logs
            document.getElementById('show-logs-option').addEventListener('click', () => {
                closeOptionsMenu();
                logSystem.showLogs();
            });
            document.getElementById('show-logs-messages-option').addEventListener('click', () => {
                closeOptionsMenu();
                logSystem.showLogs();
            });
            document.getElementById('show-logs-chat-option').addEventListener('click', () => {
                closeOptionsMenu();
                logSystem.showLogs();
            });
            
            // Interface de logs
            document.getElementById('logs-close').addEventListener('click', () => {
                logSystem.hideLogs();
            });
            document.getElementById('logs-clear').addEventListener('click', () => {
                logSystem.clear();
            });
            document.getElementById('logs-toggle').addEventListener('click', () => {
                logSystem.showLogs();
            });
            
            // Activer/désactiver le mode débogage
            document.getElementById('debug-toggle').addEventListener('change', function() {
                isDebugMode = this.checked;
                document.getElementById('logs-toggle').style.display = isDebugMode ? 'flex' : 'none';
                
                if (isDebugMode) {
                    logSystem.info("Mode débogage activé");
                } else {
                    logSystem.info("Mode débogage désactivé");
                }
            });
            
            // Actions en mode sélection
            document.getElementById('selection-delete').addEventListener('click', deleteSelectedItems);
            document.getElementById('selection-cancel').addEventListener('click', exitSelectionMode);
            
            // Fermer guides
            document.getElementById('close-install-guide').addEventListener('click', closeInstallGuide);
            
            // Actions de messages
            document.getElementById('delete-messages-btn').addEventListener('click', showDeleteMessageOptions);
            document.getElementById('forward-messages-btn').addEventListener('click', forwardSelectedMessages);
            document.getElementById('copy-messages-btn').addEventListener('click', copySelectedMessages);
            document.getElementById('reply-message-btn').addEventListener('click', replyToSelectedMessage);
            document.getElementById('close-message-actions').addEventListener('click', () => exitSelectionMode('messages'));
            
            // Options de suppression
            document.getElementById('delete-for-me').addEventListener('click', () => selectDeleteOption('for-me'));
            document.getElementById('delete-for-all').addEventListener('click', () => selectDeleteOption('for-all'));
            document.getElementById('delete-messages-cancel').addEventListener('click', closeDeleteMessageDialog);
            document.getElementById('delete-messages-confirm').addEventListener('click', confirmDeleteMessages);
            
            // Interface de transfert
            document.getElementById('forward-cancel').addEventListener('click', closeForwardDialog);
            
            // Interface de chat
            document.getElementById('chat-input').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('emoji-button').addEventListener('click', openEmojiKeyboard);
            document.getElementById('attachment-button').addEventListener('click', selectImage);
            document.getElementById('preview-close').addEventListener('click', clearImagePreview);
            
            // Interface de recherche
            document.getElementById('search-back').addEventListener('click', closeSearchInterface);
            document.getElementById('message-search-input').addEventListener('input', searchMessages);
            
            // Sélection d'image
            document.getElementById('image-input').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    selectedImage = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('preview-img').src = event.target.result;
                        document.getElementById('image-preview').classList.add('active');
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // Événements pour les paramètres
            document.getElementById('color-picker').addEventListener('input', function(e) {
                changeAppColor(e.target.value);
            });
            
            document.getElementById('dark-toggle').addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.classList.add('dark');
                    // En mode sombre, la couleur du message est la même que la couleur primaire
                    document.documentElement.style.setProperty('--chat-sent-bg', document.documentElement.style.getPropertyValue('--primary-color') || '#F7DC6F');
                } else {
                    document.documentElement.classList.remove('dark');
                    // En mode clair, la couleur du message est violette
                    document.documentElement.style.setProperty('--chat-sent-bg', '#5D5CDE');
                }
                
                // Sauvegarder la préférence
                localStorage.setItem('ichatDarkMode', this.checked ? 'true' : 'false');
            });
            
            // Événements du profil
            document.getElementById('logout-btn').addEventListener('click', logoutUser);
            document.getElementById('delete-account-btn').addEventListener('click', showDeleteAccountConfirmation);
            document.getElementById('delete-account-cancel').addEventListener('click', closeDeleteAccountDialog);
            document.getElementById('delete-account-confirm').addEventListener('click', deleteAccount);
            
            // Événements de confirmation
            document.getElementById('confirmation-cancel').addEventListener('click', closeConfirmationDialog);
            
            // Visionneuse d'images
            document.getElementById('image-viewer-close').addEventListener('click', closeImageViewer);
            document.getElementById('image-viewer-zoom-in').addEventListener('click', zoomInImage);
            document.getElementById('image-viewer-zoom-out').addEventListener('click', zoomOutImage);
            document.getElementById('image-viewer-download').addEventListener('click', downloadViewerImage);
            
            setupImageViewerGestures();
        }
        
        // Configuration des gestes pour la visionneuse d'images
        function setupImageViewerGestures() {
            const imageElement = document.getElementById('image-viewer-img');
            
            // Zoom avec la molette de la souris
            imageElement.addEventListener('wheel', function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                
                // Limiter le zoom entre 0.5 et 5
                const newScale = Math.max(0.5, Math.min(5, currentImageScale + delta));
                zoomImage(newScale);
            });
            
            // Gestion du glisser-déposer
            imageElement.addEventListener('mousedown', function(e) {
                if (currentImageScale > 1) {
                    isDragging = true;
                    dragStart.x = e.clientX - currentImagePosition.x;
                    dragStart.y = e.clientY - currentImagePosition.y;
                    imageElement.style.cursor = 'grabbing';
                }
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    // Calculer la nouvelle position
                    const newX = e.clientX - dragStart.x;
                    const newY = e.clientY - dragStart.y;
                    
                    // Mettre à jour la position
                    currentImagePosition.x = newX;
                    currentImagePosition.y = newY;
                    
                    // Appliquer la transformation
                    imageElement.style.transform = `translate(${newX}px, ${newY}px) scale(${currentImageScale})`;
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    imageElement.style.cursor = 'grab';
                }
            });
            
            // Gestion des gestes tactiles
            imageElement.addEventListener('touchstart', function(e) {
                if (e.touches.length === 1 && currentImageScale > 1) {
                    isDragging = true;
                    dragStart.x = e.touches[0].clientX - currentImagePosition.x;
                    dragStart.y = e.touches[0].clientY - currentImagePosition.y;
                }
            });
            
            imageElement.addEventListener('touchmove', function(e) {
                if (isDragging && e.touches.length === 1) {
                    // Calculer la nouvelle position
                    const newX = e.touches[0].clientX - dragStart.x;
                    const newY = e.touches[0].clientY - dragStart.y;
                    
                    // Mettre à jour la position
                    currentImagePosition.x = newX;
                    currentImagePosition.y = newY;
                    
                    // Appliquer la transformation
                    imageElement.style.transform = `translate(${newX}px, ${newY}px) scale(${currentImageScale})`;
                }
            });
            
            imageElement.addEventListener('touchend', function() {
                isDragging = false;
            });
            
            // Double-clic pour réinitialiser le zoom
            imageElement.addEventListener('dblclick', function() {
                if (currentImageScale !== 1) {
                    resetImageViewer();
                } else {
                    zoomInImage();
                }
            });
        }
        
        // Changer la couleur de l'application et la sauvegarder
        function changeAppColor(color) {
            document.documentElement.style.setProperty('--primary-color', color);
            
            // Mettre à jour l'icône de loading
            const footballSpinner = document.querySelector('.football-spinner');
            if (footballSpinner) {
                footballSpinner.style.color = color;
            }
            
            // En mode sombre, mettre à jour la couleur des messages envoyés
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.style.setProperty('--chat-sent-bg', color);
            }
            
            // Sauvegarder la préférence
            localStorage.setItem('ichatColor', color);
        }
        
        // ================ CONFIGURATION DES ÉVÉNEMENTS D'AUTHENTIFICATION ================
        
        function setupAuthEvents() {
            // Tabs d'authentification
            document.getElementById('login-tab').addEventListener('click', () => changeAuthTab('login'));
            document.getElementById('register-tab').addEventListener('click', () => changeAuthTab('register'));
            
            // Navigation entre les formulaires
            document.getElementById('goto-register').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('register');
            });
            
            document.getElementById('goto-login').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('login');
            });
            
            // Boutons d'action
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            document.getElementById('registerBtn').addEventListener('click', registerUser);
            
            // Validation en temps réel
            document.getElementById('login-email').addEventListener('input', validateLoginEmail);
            document.getElementById('login-password').addEventListener('input', validateLoginPassword);
            document.getElementById('register-email').addEventListener('input', validateRegisterEmail);
            document.getElementById('register-password').addEventListener('input', validateRegisterPassword);
            document.getElementById('register-confirm-password').addEventListener('input', validateRegisterConfirmPassword);
            
            // Validation à la soumission
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateLoginForm()) {
                    loginUser();
                }
            });
            
            document.getElementById('register-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateRegisterForm()) {
                    registerUser();
                }
            });
        }
        
        // ================ FONCTIONS DE NAVIGATION ================
        
        // Fonction pour changer d'onglet
        function changeTab(tabName) {
            // Si le menu d'options est ouvert, le fermer
            if (isOptionsMenuOpen) {
                closeOptionsMenu();
            }
            
            // Si on est dans l'interface de chat, retourner à la liste des messages
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
                if (tabName === 'messages') return;
            }
            
            // Si on est en mode sélection, quitter ce mode
            if (isSelectionMode) {
                exitSelectionMode();
            }
            
            // Masquer le panel de réactions s'il est visible
            document.getElementById('reaction-panel').style.display = 'none';
            
            // Mettre à jour la section active
            currentSection = tabName;
            
            // Mettre à jour les onglets actifs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`.tab[data-section="${tabName}"]`).classList.add('active');
            
            // Mettre à jour le titre dans l'en-tête
            document.getElementById('header-title').textContent = tabName.charAt(0).toUpperCase() + tabName.slice(1);
            
            // Réinitialiser l'en-tête
            document.getElementById('header-left').innerHTML = '';
            document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
            
            // Réattacher les événements
            document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            
            // Masquer toutes les sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Afficher la section active
            document.getElementById(`${tabName}-section`).classList.add('active');
            
            // Charger le contenu approprié selon la section
            if (tabName === 'messages') {
                loadConversations();
            }
        }
        
        // Fonction pour ouvrir une conversation
        function openChat(contact, contactId, discussionId, discussionType = 'group') {
            if (!contact) return;
            
            logSystem.info(`Tentative d'ouverture de la conversation: ${contact} (${discussionId})`);
            
            // Si le menu d'options est ouvert, le fermer
            if (isOptionsMenuOpen) {
                closeOptionsMenu();
            }
            
            // Si on est en mode sélection, ne pas ouvrir le chat
            if (isSelectionMode) {
                return;
            }
            
            // Désabonner des anciens listeners si présents
            unsubscribeFromCurrentChat();
            
            currentContact = contact;
            currentDiscussionId = discussionId;
            currentDiscussionType = discussionType;
            
            // Cacher la barre d'onglets
            document.getElementById('tabbar').style.display = 'none';
            
            // Cacher les sections normales
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mettre à jour l'en-tête
            document.getElementById('header-title').innerText = contact;
            document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
            document.getElementById('header-left').innerHTML = '<div class="back-button" id="header-button"><i class="fas fa-chevron-left"></i></div>';
            
            // Réattacher l'événement d'options
            document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            document.getElementById('header-button').addEventListener('click', closeChat);
            
            // Afficher l'interface de chat
            document.getElementById('chat-interface').style.display = 'block';
            
            // Vérifier si c'est le groupe BetNews (seul l'admin peut écrire)
            if (discussionType === 'group' && contact === 'BetNews') {
                if (isAdmin) {
                    // Montrer la barre de saisie pour l'admin
                    document.getElementById('chat-input-container').style.display = 'flex';
                } else {
                    // Cacher la barre de saisie pour les utilisateurs non-admin
                    document.getElementById('chat-input-container').style.display = 'none';
                }
            } else {
                // Pour les autres conversations, toujours montrer la barre de saisie
                document.getElementById('chat-input-container').style.display = 'flex';
            }
            
            // Charger les messages
            loadChatMessages(discussionId, discussionType);
        }
        
        // Fonction pour fermer une conversation
        function closeChat() {
            // Désabonner des écouteurs de chat
            unsubscribeFromCurrentChat();
            
            // Si on est en mode sélection des messages, le quitter d'abord
            if (isSelectionMode && selectionModeType === 'messages') {
                exitSelectionMode();
            }
            
            // Si l'interface de recherche est ouverte, la fermer
            if (document.getElementById('search-overlay').classList.contains('active')) {
                closeSearchInterface();
            }
            
            // Masquer l'indicateur de frappe
            document.getElementById('typing-indicator').classList.remove('active');
            
            // Masquer le panel de réactions s'il est visible
            document.getElementById('reaction-panel').style.display = 'none';
            
            // Afficher la barre d'onglets
            document.getElementById('tabbar').style.display = 'flex';
            
            // Cacher l'interface de chat
            document.getElementById('chat-interface').style.display = 'none';
            
            // Réinitialiser l'en-tête pour revenir à la liste des messages
            document.getElementById('header-title').innerText = 'Messages';
            document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
            document.getElementById('header-left').innerHTML = '';
            
            // Réattacher les événements
            document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            
            // Afficher la section messages
            document.getElementById('messages-section').classList.add('active');
            currentSection = 'messages';
            
            // Réinitialiser les variables de la conversation active
            currentContact = '';
            currentDiscussionId = null;
            currentDiscussionType = null;
            replyToMessage = null;
        }
        
        // Désabonner des écouteurs de chat
        function unsubscribeFromCurrentChat() {
            if (currentDiscussionId && chatUnsubscribers[currentDiscussionId]) {
                logSystem.info(`Désabonnement des écouteurs pour: ${currentDiscussionId}`);
                chatUnsubscribers[currentDiscussionId]();
                delete chatUnsubscribers[currentDiscussionId];
            }
        }
        
        // ================ FONCTIONS D'AUTHENTIFICATION ================
        
        // Changer l'onglet dans l'écran d'authentification
        function changeAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                
                // Transition animée
                registerForm.style.animation = 'none';
                void registerForm.offsetWidth; // Forcer le reflow pour redémarrer l'animation
                registerForm.style.animation = '';
                
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                
                // Transition animée
                loginForm.style.animation = 'none';
                void loginForm.offsetWidth; // Forcer le reflow pour redémarrer l'animation
                loginForm.style.animation = '';
                
                loginForm.classList.remove('active');
                registerForm.classList.add('active');
            }
            
            // Masquer les messages d'erreur
            hideLog('login-log');
            hideLog('register-log');
            
            // Activer l'animation du formulaire qui apparaît
            const activeForm = tab === 'login' ? loginForm : registerForm;
            activeForm.style.animation = 'fadeUp 0.5s ease';
        }
        
        // Valider l'email de connexion
        function validateLoginEmail() {
            const email = document.getElementById('login-email').value.trim();
            const errorElement = document.getElementById('login-email-error');
            
            if (!email) {
                errorElement.textContent = 'L\'email est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (!isValidEmail(email)) {
                errorElement.textContent = 'Format d\'email invalide';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider le mot de passe de connexion
        function validateLoginPassword() {
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-password-error');
            
            if (!password) {
                errorElement.textContent = 'Le mot de passe est requis';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider l'email d'inscription
        function validateRegisterEmail() {
            const email = document.getElementById('register-email').value.trim();
            const errorElement = document.getElementById('register-email-error');
            
            if (!email) {
                errorElement.textContent = 'L\'email est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (!isValidEmail(email)) {
                errorElement.textContent = 'Format d\'email invalide';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider le mot de passe d'inscription
        function validateRegisterPassword() {
            const password = document.getElementById('register-password').value;
            const errorElement = document.getElementById('register-password-error');
            
            if (!password) {
                errorElement.textContent = 'Le mot de passe est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (password.length < 6) {
                errorElement.textContent = 'Le mot de passe doit contenir au moins 6 caractères';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider la confirmation du mot de passe
        function validateRegisterConfirmPassword() {
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const errorElement = document.getElementById('register-confirm-password-error');
            
            if (!confirmPassword) {
                errorElement.textContent = 'La confirmation du mot de passe est requise';
                errorElement.style.display = 'block';
                return false;
            } else if (password !== confirmPassword) {
                errorElement.textContent = 'Les mots de passe ne correspondent pas';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Valider le formulaire de connexion complet
        function validateLoginForm() {
            return validateLoginEmail() && validateLoginPassword();
        }
        
        // Valider le formulaire d'inscription complet
        function validateRegisterForm() {
            return validateRegisterEmail() && validateRegisterPassword() && validateRegisterConfirmPassword();
        }
        
        // Vérifier si un email est valide
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Afficher un message de log
        function showLog(elementId, text, type="info") {
            const logDiv = document.getElementById(elementId);
            logDiv.textContent = text;
            logDiv.className = `log-message ${type}`;
            logDiv.style.display = "block";
            
            // Ajouter une animation d'apparition
            logDiv.style.animation = 'fadeIn 0.5s ease';
        }
        
        // Masquer un message de log
        function hideLog(elementId) {
            const logDiv = document.getElementById(elementId);
            if (logDiv) {
                logDiv.style.display = "none";
            }
        }
        
        // Connexion d'un utilisateur
        async function loginUser() {
            // Validation finale avant de soumettre
            if (!validateLoginForm()) {
                return;
            }
            
            const email = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value;
            
            // Afficher le loader sur le bouton
            setButtonLoading('loginBtn', true);
            hideLog("login-log");
            
            try {
                showLog("login-log", "Connexion en cours...", "info");
                logSystem.info(`Tentative de connexion pour: ${email}`);
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // Stocker les informations dans les variables globales
                currentUser = userCredential.user;
                
                logSystem.success(`Connexion réussie pour: ${email}`);
                showLog("login-log", "Connexion réussie ! Redirection...", "success");
                
                // Rediriger vers l'application après un court délai
                setTimeout(() => {
                    completeLogin();
                }, 1000);
            } catch (error) {
                let errorMessage = "Erreur de connexion";
                
                logSystem.error(`Échec de connexion pour ${email}: ${error.code} - ${error.message}`);
                
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = "Email ou mot de passe incorrect.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "L'adresse email n'est pas valide.";
                        break;
                    case 'auth/user-disabled':
                        errorMessage = "Ce compte a été désactivé.";
                        break;
                    default:
                        errorMessage = "Erreur de connexion: " + error.message;
                }
                
                showLog("login-log", errorMessage, "error");
                setButtonLoading('loginBtn', false);
                
                // Animation de secousse sur le formulaire
                const loginForm = document.getElementById('login-form');
                loginForm.classList.add('shake');
                setTimeout(() => {
                    loginForm.classList.remove('shake');
                }, 600);
            }
        }
        
        // Inscription d'un utilisateur
        async function registerUser() {
            // Validation finale avant de soumettre
            if (!validateRegisterForm()) {
                return;
            }
            
            const email = document.getElementById("register-email").value.trim();
            const password = document.getElementById("register-password").value;
            
            // Afficher le loader sur le bouton
            setButtonLoading('registerBtn', true);
            hideLog("register-log");
            
            try {
                showLog("register-log", "Inscription en cours...", "info");
                logSystem.info(`Tentative d'inscription pour: ${email}`);
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;
                const statut = await createUserProfile(uid, email);
                
                showLog("register-log", `Inscription réussie ! Compte créé avec succès.`, "success");
                logSystem.success(`Inscription réussie pour: ${email}, statut: ${statut}`);
                
                // Stocker les informations dans les variables globales
                currentUser = userCredential.user;
                
                // Une fois inscrit, ajouter l'utilisateur aux groupes Betforce et BetNews
                await addUserToSpecialGroups(uid);
                
                setTimeout(() => {
                    completeLogin();
                }, 1000);
            } catch (error) {
                let errorMessage = "Erreur d'inscription";
                
                logSystem.error(`Échec d'inscription pour ${email}: ${error.code} - ${error.message}`);
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = "Cette adresse email est déjà utilisée.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "L'adresse email n'est pas valide.";
                        break;
                    case 'auth/weak-password':
                        errorMessage = "Le mot de passe est trop faible.";
                        break;
                    default:
                        errorMessage = "Erreur d'inscription: " + error.message;
                }
                
                showLog("register-log", errorMessage, "error");
                setButtonLoading('registerBtn', false);
                
                // Animation de secousse sur le formulaire
                const registerForm = document.getElementById('register-form');
                registerForm.classList.add('shake');
                setTimeout(() => {
                    registerForm.classList.remove('shake');
                }, 600);
            }
        }
        
        // Afficher/masquer le loader sur un bouton
        function setButtonLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            const loader = button.querySelector('.btn-loader');
            
            if (isLoading) {
                button.classList.add('loading');
                loader.style.display = 'inline-block';
            } else {
                button.classList.remove('loading');
                loader.style.display = 'none';
            }
        }
        
        // Création d'un profil utilisateur dans Firestore
        async function createUserProfile(uid, email) {
            try {
                logSystem.info(`Création du profil utilisateur pour: ${uid} (${email})`);
                
                // Vérifie si admin déjà défini
                const adminRef = doc(db, "Config", "admin");
                const adminSnap = await getDoc(adminRef);

                let statut = "simple";
                if (!adminSnap.exists()) {
                    statut = "admin";
                    // Crée l'admin dans Config
                    await setDoc(adminRef, {
                        uid: uid,
                        email: email,
                        createdAt: new Date().toISOString()
                    });
                    logSystem.info(`Utilisateur ${email} défini comme admin`);
                }

                // Crée le profil utilisateur dans Users
                const userRef = doc(db, "Users", uid);
                await setDoc(userRef, {
                    email: email,
                    statut: statut,
                    createdAt: new Date().toISOString(),
                    displayName: email.split('@')[0] // Utilisez la partie avant @ comme nom d'affichage
                });
                
                logSystem.success(`Profil utilisateur créé avec succès pour: ${email} (statut: ${statut})`);
                return statut;
            } catch (error) {
                logSystem.error(`Erreur lors de la création du profil: ${error.message}`);
                return "simple";
            }
        }
        
        // Ajouter un utilisateur aux groupes spéciaux (Betforce et BetNews)
        async function addUserToSpecialGroups(userId) {
            try {
                logSystem.info(`Ajout de l'utilisateur ${userId} aux groupes spéciaux`);
                
                // Récupérer tous les utilisateurs existants pour les ajouter aux groupes spéciaux
                const usersRef = collection(db, "Users");
                const userSnap = await getDocs(usersRef);
                let allUserIds = userSnap.docs.map(doc => doc.id);
                
                // Vérifier si les groupes existent déjà
                const betforceRef = doc(db, "groups", "Betforce");
                const betforceSnap = await getDoc(betforceRef);
                
                const betnewsRef = doc(db, "groups", "BetNews");
                const betnewsSnap = await getDoc(betnewsRef);
                
                // Créer ou mettre à jour Betforce avec tous les utilisateurs
                if (!betforceSnap.exists()) {
                    // Créer le groupe Betforce avec tous les utilisateurs
                    await setDoc(betforceRef, {
                        name: "Betforce",
                        description: "Groupe de discussion pour les paris sportifs",
                        members: allUserIds,
                        createdAt: serverTimestamp(),
                        isSpecial: true
                    });
                    
                    // Créer la collection de messages pour ce groupe
                    const messagesRef = collection(db, "groups", "Betforce", "messages");
                    await addDoc(messagesRef, {
                        text: "Bienvenue à tous dans le groupe !",
                        senderId: "admin",
                        createdAt: serverTimestamp(),
                        type: "text"
                    });
                    
                    await addDoc(messagesRef, {
                        text: "Ce groupe est dédié aux discussions sur les paris sportifs.",
                        senderId: "admin",
                        createdAt: serverTimestamp(),
                        type: "text"
                    });
                    
                    logSystem.info("Groupe Betforce créé avec tous les utilisateurs");
                } else {
                    // Ajouter l'utilisateur au groupe existant et mettre à jour les membres
                    // S'assurer que tous les utilisateurs sont dans le groupe
                    await updateDoc(betforceRef, {
                        members: allUserIds
                    });
                    logSystem.info(`Groupe Betforce mis à jour avec tous les utilisateurs`);
                }
                
                // Créer ou mettre à jour BetNews avec tous les utilisateurs
                if (!betnewsSnap.exists()) {
                    // Créer le groupe BetNews avec tous les utilisateurs
                    await setDoc(betnewsRef, {
                        name: "BetNews",
                        description: "Canal d'informations pour les paris sportifs (seuls les admins peuvent poster)",
                        members: allUserIds,
                        createdAt: serverTimestamp(),
                        isSpecial: true,
                        adminOnly: true
                    });
                    
                    // Créer la collection de messages pour ce groupe
                    const messagesRef = collection(db, "groups", "BetNews", "messages");
                    await addDoc(messagesRef, {
                        text: "Bienvenue dans le canal d'informations BetNews !",
                        senderId: "admin",
                        createdAt: serverTimestamp(),
                        type: "text"
                    });
                    
                    await addDoc(messagesRef, {
                        text: "Seuls les administrateurs peuvent publier dans ce groupe. Consultez régulièrement pour les dernières actualités et pronostics.",
                        senderId: "admin",
                        createdAt: serverTimestamp(),
                        type: "text"
                    });
                    
                    await addDoc(messagesRef, {
                        text: "Match PSG vs. Marseille ce dimanche à 21h00. Nos analystes prédisent une victoire du PSG 2-0.",
                        senderId: "admin",
                        createdAt: serverTimestamp(),
                        type: "text"
                    });
                    
                    await addDoc(messagesRef, {
                        text: "N'oubliez pas de consulter l'onglet Pronostics pour les cotes et analyses détaillées.",
                        senderId: "admin",
                        createdAt: serverTimestamp(),
                        type: "text"
                    });
                    
                    logSystem.info("Groupe BetNews créé avec tous les utilisateurs");
                } else {
                    // Ajouter l'utilisateur au groupe existant et mettre à jour les membres
                    // S'assurer que tous les utilisateurs sont dans le groupe
                    await updateDoc(betnewsRef, {
                        members: allUserIds
                    });
                    logSystem.info(`Groupe BetNews mis à jour avec tous les utilisateurs`);
                }
                
                logSystem.success(`Utilisateur ajouté avec succès aux groupes spéciaux`);
            } catch (error) {
                logSystem.error(`Erreur lors de l'ajout aux groupes spéciaux: ${error.message}`);
            }
        }
        
        // Déconnexion de l'utilisateur
        async function logoutUser() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').querySelector('div:nth-child(3)').innerText = 'Déconnexion...';
            
            logSystem.info("Déconnexion en cours...");
            
            try {
                // Désabonner de tous les écouteurs
                Object.keys(chatUnsubscribers).forEach(discussionId => {
                    if (chatUnsubscribers[discussionId]) {
                        chatUnsubscribers[discussionId]();
                    }
                });
                chatUnsubscribers = {};
                
                await signOut(auth);
                
                // Réinitialiser les variables globales
                isLoggedIn = false;
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                currentContact = '';
                currentDiscussionId = null;
                currentDiscussionType = null;
                pendingMessages = {};
                
                logSystem.success("Déconnexion réussie");
                
                // Rediriger vers l'écran de connexion
                showLoginScreen();
            } catch (error) {
                logSystem.error(`Erreur lors de la déconnexion: ${error.message}`);
                // Masquer l'écran de chargement
                hideLoading();
            }
        }
        
        // Suppression du compte utilisateur
        async function deleteAccount() {
            closeDeleteAccountDialog();
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').querySelector('div:nth-child(3)').innerText = 'Suppression du compte...';
            
            logSystem.info("Suppression du compte en cours...");
            
            try {
                // Si l'utilisateur est connecté, supprimer son compte
                if (currentUser) {
                    // Désabonner de tous les écouteurs
                    Object.keys(chatUnsubscribers).forEach(discussionId => {
                        if (chatUnsubscribers[discussionId]) {
                            chatUnsubscribers[discussionId]();
                        }
                    });
                    chatUnsubscribers = {};
                    
                    // Supprimer les données de l'utilisateur de Firestore
                    await deleteDoc(doc(db, "Users", currentUser.uid));
                    
                    // Supprimer l'utilisateur des groupes spéciaux
                    await removeUserFromSpecialGroups(currentUser.uid);
                    
                    // Supprimer le compte Firebase Auth
                    await currentUser.delete();
                    
                    logSystem.success("Compte supprimé avec succès");
                }
                
                // Effacer toutes les données locales
                localStorage.clear();
                
                // Réinitialiser les variables globales
                isLoggedIn = false;
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                
                // Afficher l'écran de connexion
                showLoginScreen();
            } catch (error) {
                logSystem.error(`Erreur lors de la suppression du compte: ${error.message}`);
                
                // Masquer l'écran de chargement
                hideLoading();
                
                // Afficher une erreur
                showSuccessPopup(
                    'Erreur',
                    'Une erreur est survenue lors de la suppression du compte. Veuillez vous reconnecter et réessayer.',
                    () => {
                        document.getElementById('success-popup').classList.remove('active');
                    }
                );
            }
        }
        
        // Supprimer l'utilisateur des groupes spéciaux
        async function removeUserFromSpecialGroups(userId) {
            try {
                logSystem.info(`Suppression de l'utilisateur ${userId} des groupes spéciaux`);
                
                // Mettre à jour Betforce
                const betforceRef = doc(db, "groups", "Betforce");
                const betforceSnap = await getDoc(betforceRef);
                
                if (betforceSnap.exists()) {
                    await updateDoc(betforceRef, {
                        members: arrayRemove(userId)
                    });
                    logSystem.info(`Utilisateur retiré du groupe Betforce`);
                }
                
                // Mettre à jour BetNews
                const betnewsRef = doc(db, "groups", "BetNews");
                const betnewsSnap = await getDoc(betnewsRef);
                
                if (betnewsSnap.exists()) {
                    await updateDoc(betnewsRef, {
                        members: arrayRemove(userId)
                    });
                    logSystem.info(`Utilisateur retiré du groupe BetNews`);
                }
                
                logSystem.success(`Utilisateur retiré avec succès des groupes spéciaux`);
            } catch (error) {
                logSystem.error(`Erreur lors de la suppression des groupes: ${error.message}`);
            }
        }
        
        // Récupérer les données utilisateur de Firestore
        async function getUserData(uid) {
            try {
                logSystem.info(`Récupération des données utilisateur pour: ${uid}`);
                
                const userRef = doc(db, "Users", uid);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    logSystem.success(`Données utilisateur récupérées avec succès`);
                    return { id: userSnap.id, ...userSnap.data() };
                } else {
                    logSystem.error(`Utilisateur non trouvé dans Firestore: ${uid}`);
                    return null;
                }
            } catch (error) {
                logSystem.error(`Erreur lors de la récupération des données utilisateur: ${error.message}`);
                return null;
            }
        }
        
        // ================ FONCTIONS POUR LES GROUPES ================
        
        // Afficher le dialogue de création de groupe
        function showCreateGroupDialog() {
            closeOptionsMenu();
            
            // Réinitialiser les champs
            document.getElementById('group-name-input').value = '';
            document.getElementById('group-description-input').value = '';
            
            // Afficher le dialogue
            document.getElementById('create-group-dialog').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            
            // Focus sur le champ de nom
            setTimeout(() => {
                document.getElementById('group-name-input').focus();
            }, 300);
            
            logSystem.info("Dialogue de création de groupe affiché");
        }
        
        // Fermer le dialogue de création de groupe
        function closeCreateGroupDialog() {
            document.getElementById('create-group-dialog').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            
            logSystem.info("Dialogue de création de groupe fermé");
        }
        
        // Créer un nouveau groupe
        async function createNewGroup() {
            const groupName = document.getElementById('group-name-input').value.trim();
            const groupDescription = document.getElementById('group-description-input').value.trim();
            
            if (!groupName) {
                showNotification("Veuillez saisir un nom pour le groupe", "error");
                document.getElementById('group-name-input').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('group-name-input').classList.remove('shake');
                }, 600);
                return;
            }
            
            // Fermer le dialogue
            closeCreateGroupDialog();
            
            // Afficher l'écran de chargement
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').querySelector('div:nth-child(3)').innerText = 'Création du groupe...';
            
            try {
                logSystem.info(`Création du groupe: ${groupName}`);
                
                // Créer un ID pour le groupe (nom sans espaces ni caractères spéciaux)
                const groupId = groupName.toLowerCase().replace(/[^a-z0-9]/g, '');
                
                // Vérifier si le groupe existe déjà
                const groupRef = doc(db, "groups", groupId);
                const groupSnap = await getDoc(groupRef);
                
                if (groupSnap.exists()) {
                    logSystem.warning(`Un groupe avec ce nom existe déjà: ${groupId}`);
                    hideLoading();
                    showNotification("Un groupe avec ce nom existe déjà", "error");
                    return;
                }
                
                // Créer le nouveau groupe
                await setDoc(groupRef, {
                    name: groupName,
                    description: groupDescription || `Groupe ${groupName}`,
                    members: [currentUser.uid],
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.uid,
                    isSpecial: false,
                    adminOnly: false
                });
                
                // Créer un message de bienvenue dans le groupe
                const messagesRef = collection(db, "groups", groupId, "messages");
                await addDoc(messagesRef, {
                    text: `Bienvenue dans le groupe ${groupName} !`,
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    type: "text"
                });
                
                logSystem.success(`Groupe créé avec succès: ${groupId}`);
                
                // Masquer l'écran de chargement
                hideLoading();
                
                // Montrer une notification de succès
                showNotification(`Groupe "${groupName}" créé avec succès`, "success");
                
                // Recharger les conversations
                loadConversations();
                
                // Ouvrir le nouveau groupe
                setTimeout(() => {
                    openChat(groupName, null, groupId, 'group');
                }, 500);
                
            } catch (error) {
                logSystem.error(`Erreur lors de la création du groupe: ${error.message}`);
                hideLoading();
                showNotification("Erreur lors de la création du groupe", "error");
            }
        }
        
        // Charger les conversations dans la liste depuis Firestore
        async function loadConversations() {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';
            
            try {
                // Si pas d'utilisateur authentifié, ne rien faire
                if (!currentUser) {
                    logSystem.warning("Tentative de chargement des conversations sans utilisateur connecté");
                    return;
                }
                
                logSystem.info("Chargement des conversations...");
                
                // Afficher un indicateur de chargement
                chatList.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary-color);"></i>
                        <div style="margin-top: 10px; color: var(--inactive-text);">Chargement des groupes...</div>
                    </div>
                `;
                
                // Récupérer les groupes dont l'utilisateur est membre
                const conversations = [];
                
                try {
                    // Récupérer les groupes où cet utilisateur est membre
                    const groupsRef = collection(db, "groups");
                    const groupsQuery = query(
                        groupsRef,
                        where("members", "array-contains", currentUser.uid)
                    );
                    
                    const groupsSnapshot = await getDocs(groupsQuery);
                    
                    for (const groupDoc of groupsSnapshot.docs) {
                        const groupData = groupDoc.data();
                        
                        // Récupérer le dernier message du groupe
                        let lastMessage = "Aucun message";
                        let lastSenderId = null;
                        let lastMessageTime = null;
                        
                        const messagesRef = collection(db, "groups", groupDoc.id, "messages");
                        const messagesQuery = query(messagesRef, orderBy("createdAt", "desc"), limit(1));
                        const messagesSnapshot = await getDocs(messagesQuery);
                        
                        if (!messagesSnapshot.empty) {
                            const lastMessageDoc = messagesSnapshot.docs[0];
                            const messageData = lastMessageDoc.data();
                            lastMessage = messageData.text || "Image";
                            lastSenderId = messageData.senderId;
                            lastMessageTime = messageData.createdAt;
                        }
                        
                        // Ajouter le groupe à la liste des conversations
                        conversations.push({
                            id: groupDoc.id,
                            name: groupData.name,
                            isGroup: true,
                            isSpecial: groupData.isSpecial || false,
                            lastMessage: lastMessage,
                            lastSender: lastSenderId,
                            time: formatTimestamp(lastMessageTime),
                            adminOnly: groupData.adminOnly || false,
                            description: groupData.description || "Groupe de discussion"
                        });
                    }
                    
                    logSystem.info(`${groupsSnapshot.size} groupes récupérés`);
                } catch (error) {
                    logSystem.error(`Erreur lors de la récupération des groupes: ${error.message}`);
                }
                
                // Trier les conversations par date du dernier message (les plus récentes d'abord)
                conversations.sort((a, b) => {
                    // Priorité aux groupes spéciaux
                    if (a.isSpecial && !b.isSpecial) return -1;
                    if (!a.isSpecial && b.isSpecial) return 1;
                    
                    // Sinon, trier par heure
                    if (!a.time) return 1;
                    if (!b.time) return -1;
                    return 0;
                });
                
                // Si aucune conversation
                if (conversations.length === 0) {
                    logSystem.warning("Aucun groupe trouvé");
                    chatList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <div class="empty-state-title">Aucun groupe</div>
                            <div class="empty-state-text">Créez votre premier groupe en appuyant sur le bouton + ci-dessous</div>
                        </div>
                    `;
                    return;
                }
                
                // Vider la liste
                chatList.innerHTML = '';
                
                // Créer les éléments pour chaque conversation
                conversations.forEach(conv => {
                    const chatItem = document.createElement('div');
                    chatItem.className = `chat-item selectable-item`;
                    chatItem.setAttribute('data-contact', conv.name);
                    chatItem.setAttribute('data-id', conv.id);
                    chatItem.setAttribute('data-type', 'group');
                    
                    // Choisir la classe d'icône appropriée
                    let iconClass = 'group-pic';
                    let iconContent = '<i class="fas fa-users" style="color: white;"></i>';
                    
                    if (conv.name === 'BetNews') {
                        iconClass = 'news-group-pic';
                        iconContent = '<i class="fas fa-newspaper" style="color: white;"></i>';
                    }
                    
                    // Créer le badge de groupe si nécessaire
                    let groupBadge = '';
                    if (conv.isGroup) {
                        if (conv.adminOnly) {
                            groupBadge = '<span class="group-info-badge"><i class="fas fa-lock"></i> Admin uniquement</span>';
                        } else {
                            groupBadge = '<span class="group-info-badge"><i class="fas fa-users"></i> Groupe</span>';
                        }
                    }
                    
                    // Formater le dernier message
                    let lastMessageText = conv.lastMessage;
                    if (conv.isGroup && conv.lastSender && conv.lastSender !== 'me') {
                        lastMessageText = `<strong>${getDisplayName(conv.lastSender)}:</strong> ${conv.lastMessage}`;
                    }
                    
                    chatItem.innerHTML = `
                        <div class="${iconClass}">
                            ${iconContent}
                        </div>
                        <div class="item-content">
                            <div style="display: flex; justify-content: space-between;">
                                <div class="item-title">${conv.name}${groupBadge}</div>
                                <div class="item-time">${conv.time || ''}</div>
                            </div>
                            <div class="item-subtitle">${lastMessageText}</div>
                        </div>
                        <i class="fas fa-check-circle check-circle"></i>
                    `;
                    
                    // Configuration des événements pour la sélection longue
                    setupLongPressSelection(chatItem);
                    
                    // Gestionnaire de clic normal (ouverture de la conversation)
                    chatItem.addEventListener('click', function(e) {
                        if (!isSelectionMode) {
                            const discussionId = this.getAttribute('data-id');
                            const discussionType = this.getAttribute('data-type');
                            const contact = this.getAttribute('data-contact');
                            
                            openChat(contact, null, discussionId, discussionType);
                        } else {
                            // Si en mode sélection, sélectionner/désélectionner cet élément
                            toggleItemSelection(this, this.getAttribute('data-id'));
                        }
                    });
                    
                    chatList.appendChild(chatItem);
                });
                
                logSystem.success(`${conversations.length} conversations chargées avec succès`);
            } catch (error) {
                logSystem.error(`Erreur lors du chargement des conversations: ${error.message}`);
                chatList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="empty-state-title">Erreur de chargement</div>
                        <div class="empty-state-text">Impossible de charger les groupes. Veuillez réessayer.</div>
                    </div>
                `;
            }
        }

        // Formater un timestamp Firestore
        function formatTimestamp(timestamp) {
            if (!timestamp) return "";
            
            // Si c'est un timestamp Firestore
            if (timestamp.toDate) {
                const date = timestamp.toDate();
                return `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
            }
            
            // Si c'est une date standard
            if (timestamp instanceof Date) {
                return `${timestamp.getHours()}:${timestamp.getMinutes().toString().padStart(2, '0')}`;
            }
            
            // Si c'est déjà une chaîne formatée
            return timestamp;
        }
        
        // Configurer la sélection par appui long
        function setupLongPressSelection(element) {
            let startX, startY;
            
            // Gestionnaires pour appareils tactiles
            element.addEventListener('touchstart', function(e) {
                if (isSelectionMode) return;
                
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                
                // Démarrer le timer d'appui long
                longPressTimer = setTimeout(() => {
                    // Effet de vibration pour feedback tactile
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                    
                    // Démarrer le mode sélection
                    startSelectionMode();
                    
                    // Sélectionner cet élément
                    const itemId = this.getAttribute('data-id');
                    toggleItemSelection(this, itemId);
                    
                    // Ajouter une classe pour le feedback visuel
                    this.classList.add('longpressing');
                    
                    // Nettoyer après l'animation
                    setTimeout(() => {
                        this.classList.remove('longpressing');
                    }, 300);
                    
                }, longPressDuration);
            }, { passive: true });
            
            element.addEventListener('touchmove', function(e) {
                if (!longPressTimer) return;
                
                // Calculer la distance de déplacement
                const moveX = e.touches[0].clientX;
                const moveY = e.touches[0].clientY;
                const distance = Math.sqrt(
                    Math.pow(moveX - startX, 2) + 
                    Math.pow(moveY - startY, 2)
                );
                
                // Si le doigt a bougé significativement, annuler l'appui long
                if (distance > 10) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            }, { passive: true });
            
            element.addEventListener('touchend', function() {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }, { passive: true });
            
            element.addEventListener('touchcancel', function() {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }, { passive: true });
        }
        
        // Charger les messages d'une conversation avec écouteur en temps réel
        function loadChatMessages(discussionId, discussionType) {
            if (!discussionId) return;
            
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            // Montrer un indicateur de chargement
            messagesContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--inactive-text);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                    <div style="margin-top: 10px;">Chargement des messages...</div>
                </div>
            `;
            
            logSystem.info(`Mise en place de l'écouteur pour les messages de: ${discussionId} (type: ${discussionType})`);
            
            try {
                let messagesRef;
                
                if (discussionType === 'group') {
                    messagesRef = collection(db, "groups", discussionId, "messages");
                } else {
                    messagesRef = collection(db, "discussions", discussionId, "messages");
                }
                
                const q = query(messagesRef, orderBy("createdAt", "asc"));
                
                // S'abonner aux mises à jour des messages
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    // Initialiser ou vider le conteneur de messages
                    messagesContainer.innerHTML = '';
                    
                    if (snapshot.empty) {
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--inactive-text);">
                                Aucun message. Commencez la conversation !
                            </div>
                        `;
                        return;
                    }
                    
                    // Créer un fragment pour améliorer les performances
                    const fragment = document.createDocumentFragment();
                    
                    // Ajouter les messages dans l'ordre chronologique
                    snapshot.forEach(doc => {
                        const messageData = doc.data();
                        const messageId = doc.id;
                        
                        const fromMe = messageData.senderId === currentUser.uid;
                        
                        const messageElement = createMessageElement(
                            messageId, 
                            messageData, 
                            fromMe, 
                            discussionType === 'group'
                        );
                        
                        fragment.appendChild(messageElement);
                        
                        // Supprimer ce message des messages en attente s'il était présent
                        if (pendingMessages[messageId]) {
                            delete pendingMessages[messageId];
                        }
                    });
                    
                    // Ajouter tous les messages au conteneur
                    messagesContainer.appendChild(fragment);
                    
                    // Défiler vers le bas pour voir les messages les plus récents
                    scrollToBottom();
                }, (error) => {
                    logSystem.error(`Erreur lors de la récupération des messages: ${error.message}`);
                    
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                            <i class="fas fa-exclamation-circle" style="font-size: 24px;"></i>
                            <div style="margin-top: 10px;">Erreur de chargement des messages</div>
                        </div>
                    `;
                });
                
                // Stocker la fonction d'unsubscribe pour pouvoir la désactiver plus tard
                chatUnsubscribers[discussionId] = unsubscribe;
                
                // Pour le groupe BetNews, ajouter un message spécial si l'utilisateur n'est pas admin
                if (discussionType === 'group' && currentContact === 'BetNews' && !isAdmin) {
                    const adminOnlyMsg = document.createElement('div');
                    adminOnlyMsg.className = 'admin-only-message';
                    adminOnlyMsg.textContent = 'Seuls les administrateurs peuvent écrire dans ce groupe';
                    messagesContainer.appendChild(adminOnlyMsg);
                }
                
            } catch (error) {
                logSystem.error(`Erreur lors de l'initialisation de l'écouteur: ${error.message}`);
                
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                        <i class="fas fa-exclamation-circle" style="font-size: 24px;"></i>
                        <div style="margin-top: 10px;">Erreur lors du chargement des messages</div>
                    </div>
                `;
            }
        }
        
        // Créer un élément de message
        function createMessageElement(messageId, messageData, fromMe, isGroup) {
            const messageDiv = document.createElement('div');
            
            if (fromMe) {
                messageDiv.className = 'message message-sent';
            } else {
                messageDiv.className = 'message message-received';
                
                // Ajouter le nom de l'expéditeur pour les messages de groupe
                if (isGroup) {
                    const senderName = document.createElement('div');
                    senderName.className = `message-sender sender-${messageData.senderId}`;
                    
                    // Récupérer le nom de l'expéditeur
                    if (messageData.senderId === 'admin') {
                        senderName.textContent = 'Admin';
                    } else {
                        getDisplayNameFromId(messageData.senderId).then(name => {
                            senderName.textContent = name;
                        });
                    }
                    
                    messageDiv.appendChild(senderName);
                }
            }
            
            messageDiv.setAttribute('data-id', messageId);
            messageDiv.setAttribute('data-from', messageData.senderId || 'unknown');
            
            // Si c'est une réponse à un autre message
            if (messageData.replyTo) {
                const quotedDiv = document.createElement('div');
                // Ajouter des classes différentes selon l'expéditeur du message cité
                const fromClass = messageData.replyTo.senderId === currentUser.uid ? 'from-me' : 'from-them';
                quotedDiv.className = 'quoted-message ' + fromClass;
                
                const quotedSender = document.createElement('div');
                quotedSender.className = 'quoted-sender ' + fromClass;
                
                // Dans un groupe ou si l'expéditeur est connu, utiliser le nom approprié
                if (isGroup || messageData.replyTo.senderName) {
                    quotedSender.textContent = messageData.replyTo.senderName || getDisplayName(messageData.replyTo.senderId);
                } else {
                    quotedSender.textContent = fromClass === 'from-me' ? 'Vous' : currentContact;
                }
                
                const quotedContent = document.createElement('div');
                quotedContent.className = 'quoted-content';
                quotedContent.textContent = messageData.replyTo.text || "Image";
                
                quotedDiv.appendChild(quotedSender);
                quotedDiv.appendChild(quotedContent);
                messageDiv.appendChild(quotedDiv);
            }
            
            // Ajouter le contenu du message
            if (messageData.type === 'text' || !messageData.type) {
                const messageText = document.createElement('div');
                messageText.textContent = messageData.text;
                messageDiv.appendChild(messageText);
            }
            
            // Si le message contient une image
            if (messageData.type === 'image' || messageData.image) {
                const messageImage = document.createElement('img');
                messageImage.className = 'message-image';
                messageImage.src = messageData.image || messageData.imageUrl;
                messageImage.alt = 'Image';
                messageImage.loading = 'lazy';
                
                // Ajouter un événement pour ouvrir l'image en plein écran
                messageImage.addEventListener('click', function() {
                    openImageViewer(this.src);
                });
                
                messageDiv.appendChild(messageImage);
            }
            
            // Ajouter l'heure du message
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            
            // Formater l'heure du message
            if (messageData.createdAt) {
                messageTime.textContent = formatTimestamp(messageData.createdAt);
            } else {
                messageTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            messageDiv.appendChild(messageTime);
            
            // Ajouter l'indicateur de statut du message pour les messages envoyés
            if (fromMe) {
                const messageStatus = document.createElement('div');
                messageStatus.className = 'message-status';
                
                // Déterminer le statut du message
                if (messageData.status === 'error') {
                    messageStatus.innerHTML = 'Erreur <i class="fas fa-exclamation-circle"></i>';
                    messageStatus.classList.add('error');
                } else if (messageData.status === 'pending') {
                    messageStatus.innerHTML = 'Envoi... <i class="fas fa-circle-notch fa-spin"></i>';
                    messageStatus.classList.add('pending');
                } else if (messageData.status === 'sent') {
                    messageStatus.innerHTML = 'Envoyé <i class="fas fa-check"></i>';
                } else if (messageData.status === 'delivered') {
                    messageStatus.innerHTML = 'Livré <i class="fas fa-check-double"></i>';
                } else if (messageData.status === 'read') {
                    messageStatus.innerHTML = 'Lu <i class="fas fa-check-double" style="color: var(--primary-color);"></i>';
                } else {
                    // Par défaut pour les messages déjà dans la base de données
                    messageStatus.innerHTML = 'Envoyé <i class="fas fa-check"></i>';
                }
                
                messageDiv.appendChild(messageStatus);
            }
            
            // Ajouter les réactions si elles existent
            if (messageData.reactions && Object.keys(messageData.reactions).length > 0) {
                const reactionsContainer = document.createElement('div');
                reactionsContainer.className = 'message-reactions';
                
                Object.entries(messageData.reactions).forEach(([emoji, users]) => {
                    const reaction = document.createElement('div');
                    reaction.className = 'message-reaction';
                    reaction.innerHTML = `${emoji} <span class="reaction-count">${Object.keys(users).length}</span>`;
                    reactionsContainer.appendChild(reaction);
                });
                
                messageDiv.appendChild(reactionsContainer);
            }
            
            // Ajouter les gestionnaires d'événements
            // (sauf pour le groupe BetNews si l'utilisateur n'est pas admin)
            if (!(currentContact === 'BetNews' && !isAdmin)) {
                addMessageEventListeners(messageDiv);
            }
            
            return messageDiv;
        }
        
        // Défiler vers le bas de la conversation
        function scrollToBottom() {
            const chatMessagesContainer = document.querySelector('.chat-messages-container');
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
        
        // Ajouter des gestionnaires d'événements aux messages
        function addMessageEventListeners(messageElement) {
            // Gestion du double tap pour les réactions
            messageElement.addEventListener('click', function(e) {
                if (isSelectionMode && selectionModeType === 'messages') {
                    toggleMessageSelection(this);
                    e.preventDefault();
                    return;
                }
                
                const now = new Date().getTime();
                const timeSince = now - lastTap;
                
                // Pour le double tap, il doit être le même élément
                if (timeSince < 300 && timeSince > 0 && currentTappedMessage === this) {
                    // Double tap détecté
                    e.preventDefault();
                    
                    // Afficher le panneau de réactions
                    const messageId = this.getAttribute('data-id');
                    const messageRect = this.getBoundingClientRect();
                    const messageCenter = messageRect.left + messageRect.width / 2;
                    const windowWidth = window.innerWidth;
                    
                    // Positionner le panneau au-dessus du message
                    const panelLeft = Math.min(
                        Math.max(messageCenter - 150, 10), // Ne pas dépasser à gauche
                        windowWidth - 300 - 10 // Ne pas dépasser à droite
                    );
                    
                    showReactionPanel(messageId, panelLeft, messageRect.top - 60);
                    
                    // Vibration pour feedback tactile
                    if (navigator.vibrate) {
                        navigator.vibrate(30);
                    }
                    
                    // Réinitialiser pour éviter des doubles détections
                    lastTap = 0;
                } else {
                    // Premier tap
                    lastTap = now;
                    currentTappedMessage = this;
                }
            });
            
            // Gestion des événements tactiles pour le glissement
            let swipeStartX, swipeStartY;
            
            messageElement.addEventListener('touchstart', function(e) {
                if (isSelectionMode) return;
                
                const touch = e.touches[0];
                swipeStartX = touch.clientX;
                swipeStartY = touch.clientY;
            });
            
            messageElement.addEventListener('touchmove', function(e) {
                if (isSelectionMode) return;
                
                if (!e.touches[0]) return;
                
                const touch = e.touches[0];
                const deltaX = touch.clientX - swipeStartX;
                const deltaY = Math.abs(touch.clientY - swipeStartY);
                
                // Si le déplacement est plus horizontal que vertical
                if (Math.abs(deltaX) > deltaY && Math.abs(deltaX) > 10) {
                    this.style.transform = `translateX(${deltaX / 2}px)`;
                }
            });
            
            messageElement.addEventListener('touchend', function(e) {
                if (isSelectionMode) return;
                
                const touch = e.changedTouches[0];
                const deltaX = touch.clientX - swipeStartX;
                
                // Réponse automatique au swipe
                handleSwipe(this, deltaX > 0 ? 'right' : 'left', Math.abs(deltaX));
                
                // Réinitialiser la position
                this.style.transform = 'translateX(0)';
            });
            
            // Gestion du clic droit (pour les ordinateurs)
            messageElement.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                
                // Utiliser le clic droit pour la sélection directe
                if (!isSelectionMode) {
                    startMessagesSelectionMode();
                }
                toggleMessageSelection(this);
                
                return false;
            });
        }
        
        // Gérer le glissement de message - automatiquement sélectionner pour répondre
        function handleSwipe(messageElement, direction, distance) {
            if (isSelectionMode) return;
            
            // Réinitialiser tous les autres messages
            document.querySelectorAll('.message').forEach(msg => {
                if (msg !== messageElement) {
                    msg.style.transform = 'translateX(0)';
                }
            });
            
            if (Math.abs(distance) > 30) {
                // Déclencher l'animation de sélection
                messageElement.classList.add('replying');
                
                // Après l'animation, préparer la réponse
                setTimeout(() => {
                    const messageId = messageElement.getAttribute('data-id');
                    replyToMessageAction(messageId);
                    messageElement.classList.remove('replying');
                }, 500);
            }
        }
        
        // Préparer une réponse à un message
        async function replyToMessageAction(messageId) {
            if (!currentDiscussionId) return;
            
            try {
                // Récupérer les informations du message
                let messageRef;
                if (currentDiscussionType === 'group') {
                    messageRef = doc(db, "groups", currentDiscussionId, "messages", messageId);
                } else {
                    messageRef = doc(db, "discussions", currentDiscussionId, "messages", messageId);
                }
                
                const messageSnap = await getDoc(messageRef);
                
                if (messageSnap.exists()) {
                    const messageData = messageSnap.data();
                    
                    // Stocker la référence pour l'envoi
                    replyToMessage = {
                        id: messageId,
                        text: messageData.text,
                        senderId: messageData.senderId,
                        senderName: messageData.senderId === currentUser.uid ? 'Vous' : await getDisplayNameFromId(messageData.senderId)
                    };
                    
                    // Focus sur l'input
                    document.getElementById('chat-input').focus();
                    
                    // Vibration pour feedback tactile
                    if (navigator.vibrate) {
                        navigator.vibrate([30, 50, 30]);
                    }
                    
                    // Montrer une notification
                    showNotification('Répondre au message...', 'info');
                }
            } catch (error) {
                logSystem.error(`Erreur lors de la préparation de la réponse: ${error.message}`);
            }
        }
        
        // Récupérer le nom d'affichage d'un utilisateur à partir de son ID
        async function getDisplayNameFromId(userId) {
            // Si c'est l'utilisateur actuel
            if (userId === currentUser.uid) {
                return 'Vous';
            }
            
            // Si c'est l'admin
            if (userId === 'admin') {
                return 'Admin';
            }
            
            try {
                const userRef = doc(db, "Users", userId);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    return userData.displayName || userData.email.split('@')[0];
                }
            } catch (error) {
                logSystem.error(`Erreur lors de la récupération du nom: ${error.message}`);
            }
            
            return 'Utilisateur';
        }
        
        // Afficher le panneau de réactions
        function showReactionPanel(messageId, x, y) {
            const reactionPanel = document.getElementById('reaction-panel');
            
            // Positionner le panel près du message
            reactionPanel.style.left = `${x}px`;
            reactionPanel.style.top = `${y}px`;
            reactionPanel.style.display = 'flex';
            
            // Stocker le message ID pour la réaction
            reactionPanel.setAttribute('data-message-id', messageId);
            
            // Gestionnaire pour masquer le panel quand on clique ailleurs
            document.addEventListener('click', hideReactionPanel);
            
            // Ajouter les gestionnaires pour chaque émoji
            document.querySelectorAll('.reaction-emoji').forEach(emoji => {
                emoji.onclick = function(e) {
                    e.stopPropagation();
                    const emojiValue = this.getAttribute('data-emoji');
                    addReaction(messageId, emojiValue);
                    hideReactionPanel();
                };
            });
        }
        
        // Masquer le panel de réactions
        function hideReactionPanel() {
            document.getElementById('reaction-panel').style.display = 'none';
            document.removeEventListener('click', hideReactionPanel);
        }
        
        // Ajouter une réaction à un message
        async function addReaction(messageId, emoji) {
            if (!currentDiscussionId || !currentUser) return;
            
            try {
                logSystem.info(`Ajout de la réaction ${emoji} au message ${messageId}`);
                
                let messageRef;
                if (currentDiscussionType === 'group') {
                    messageRef = doc(db, "groups", currentDiscussionId, "messages", messageId);
                } else {
                    messageRef = doc(db, "discussions", currentDiscussionId, "messages", messageId);
                }
                
                // Créer le chemin pour les réactions
                const reactionPath = `reactions.${emoji}.${currentUser.uid.replace(/\./g, '_')}`;
                
                // Mettre à jour le document
                await updateDoc(messageRef, {
                    [reactionPath]: true
                });
                
                // Effet de vibration pour feedback
                if (navigator.vibrate) {
                    navigator.vibrate(20);
                }
                
                logSystem.success(`Réaction ajoutée avec succès`);
            } catch (error) {
                logSystem.error(`Erreur lors de l'ajout de la réaction: ${error.message}`);
                showNotification("Impossible d'ajouter la réaction", "error");
            }
        }
        
        // Envoyer un message
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if ((message === '' && !selectedImage) || !currentDiscussionId) return;
            
            // Ne pas autoriser l'envoi pour les non-admins dans BetNews
            if (currentDiscussionType === 'group' && currentContact === 'BetNews' && !isAdmin) {
                logSystem.warning("Tentative d'envoi de message dans BetNews par un non-admin");
                return;
            }
            
            // Générer un ID temporaire pour ce message
            const tempMessageId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
            
            try {
                // Préparer l'image si elle existe
                let imageBase64 = null;
                if (selectedImage) {
                    imageBase64 = document.getElementById('preview-img').src;
                }
                
                // Vider l'entrée immédiatement
                input.value = '';
                clearImagePreview();
                
                // Créer un élément de message "en attente"
                addPendingMessageToUI(tempMessageId, message, imageBase64);
                
                // Défiler vers le bas pour voir le nouveau message
                scrollToBottom();
                
                // Si on est en ligne, envoyer immédiatement le message
                if (isOnline) {
                    await sendMessageToFirestore(currentDiscussionId, message, imageBase64, replyToMessage, tempMessageId);
                } else {
                    // Si hors ligne, ajouter à la file d'attente
                    messageQueue.push({
                        discussionId: currentDiscussionId,
                        text: message,
                        image: imageBase64,
                        replyTo: replyToMessage
                    });
                    
                    logSystem.warning("Message ajouté à la file d'attente (hors ligne)");
                    showNotification("Vous êtes hors ligne. Le message sera envoyé lorsque vous serez connecté.", "info");
                }
                
                // Réinitialiser le message de réponse
                replyToMessage = null;
                
            } catch (error) {
                logSystem.error(`Erreur lors de l'envoi du message: ${error.message}`);
                
                // Mettre à jour l'état du message en attente pour indiquer l'erreur
                updatePendingMessageStatus(tempMessageId, 'error');
                
                showNotification("Erreur lors de l'envoi du message", "error");
            }
        }
        
        // Ajouter un message en attente à l'interface
        function addPendingMessageToUI(messageId, text, imageBase64) {
            const messagesContainer = document.getElementById('chat-messages');
            
            // Créer l'élément de message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-sent';
            messageDiv.setAttribute('data-id', messageId);
            messageDiv.setAttribute('data-from', currentUser.uid);
            
            // Si c'est une réponse à un autre message
            if (replyToMessage) {
                const quotedDiv = document.createElement('div');
                quotedDiv.className = 'quoted-message from-them';
                
                const quotedSender = document.createElement('div');
                quotedSender.className = 'quoted-sender from-them';
                quotedSender.textContent = replyToMessage.senderName || 'Utilisateur';
                
                const quotedContent = document.createElement('div');
                quotedContent.className = 'quoted-content';
                quotedContent.textContent = replyToMessage.text || "Image";
                
                quotedDiv.appendChild(quotedSender);
                quotedDiv.appendChild(quotedContent);
                messageDiv.appendChild(quotedDiv);
            }
            
            // Ajouter le texte s'il existe
            if (text && text.trim() !== '') {
                const messageText = document.createElement('div');
                messageText.textContent = text;
                messageDiv.appendChild(messageText);
            }
            
            // Ajouter l'image si elle existe
            if (imageBase64) {
                const messageImage = document.createElement('img');
                messageImage.className = 'message-image';
                messageImage.src = imageBase64;
                messageImage.alt = 'Image';
                
                // Ajouter un événement pour ouvrir l'image en plein écran
                messageImage.addEventListener('click', function() {
                    openImageViewer(this.src);
                });
                
                messageDiv.appendChild(messageImage);
            }
            
            // Ajouter l'heure du message
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            messageDiv.appendChild(messageTime);
            
            // Ajouter l'indicateur de statut
            const messageStatus = document.createElement('div');
            messageStatus.className = 'message-status pending';
            messageStatus.innerHTML = 'Envoi... <i class="fas fa-circle-notch fa-spin"></i>';
            messageDiv.appendChild(messageStatus);
            
            // Ajouter le message à l'interface
            messagesContainer.appendChild(messageDiv);
            
            // Stocker le message en attente
            pendingMessages[messageId] = {
                id: messageId,
                text: text,
                image: imageBase64,
                replyTo: replyToMessage,
                status: 'pending'
            };
        }
        
        // Mettre à jour le statut d'un message en attente
        function updatePendingMessageStatus(messageId, status) {
            const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
            if (!messageElement) return;
            
            const statusElement = messageElement.querySelector('.message-status');
            if (!statusElement) return;
            
            statusElement.classList.remove('pending', 'error');
            
            if (status === 'error') {
                statusElement.innerHTML = 'Erreur <i class="fas fa-exclamation-circle"></i>';
                statusElement.classList.add('error');
                
                // Mettre à jour le statut dans l'objet pendingMessages
                if (pendingMessages[messageId]) {
                    pendingMessages[messageId].status = 'error';
                }
            } else if (status === 'sent') {
                statusElement.innerHTML = 'Envoyé <i class="fas fa-check"></i>';
                
                // Supprimer de la liste des messages en attente
                if (pendingMessages[messageId]) {
                    delete pendingMessages[messageId];
                }
            }
        }
        
        // Envoyer un message à Firestore
        async function sendMessageToFirestore(discussionId, text, imageBase64, replyToMsg, tempMessageId) {
            if (!discussionId || (!text && !imageBase64)) return;
            
            logSystem.info(`Envoi d'un message à ${discussionId}: ${text ? text.substring(0, 30) + (text.length > 30 ? '...' : '') : 'Image'}`);
            
            try {
                // Déterminer le chemin de la collection de messages
                let messagesRef;
                let discussionRef;
                
                if (currentDiscussionType === 'group') {
                    messagesRef = collection(db, "groups", discussionId, "messages");
                    discussionRef = doc(db, "groups", discussionId);
                } else {
                    messagesRef = collection(db, "discussions", discussionId, "messages");
                    discussionRef = doc(db, "discussions", discussionId);
                }
                
                // Préparer les données du message
                const messageData = {
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    status: 'sent'
                };
                
                // Ajouter le texte s'il existe
                if (text && text.trim() !== '') {
                    messageData.text = text;
                    messageData.type = 'text';
                }
                
                // Ajouter l'image s'il en existe une
                if (imageBase64) {
                    messageData.image = imageBase64;
                    messageData.type = 'image';
                }
                
                // Ajouter la référence au message répondu si existant
                if (replyToMsg) {
                    messageData.replyTo = {
                        id: replyToMsg.id,
                        text: replyToMsg.text,
                        senderId: replyToMsg.senderId,
                        senderName: replyToMsg.senderName
                    };
                }
                
                // Ajouter le message à la collection
                const docRef = await addDoc(messagesRef, messageData);
                
                // Mettre à jour le statut du message en attente s'il existe
                if (tempMessageId) {
                    updatePendingMessageStatus(tempMessageId, 'sent');
                }
                
                // Mettre à jour les informations de la discussion
                await updateDoc(discussionRef, {
                    lastMessage: text || "Image",
                    lastMessageTime: serverTimestamp(),
                    lastSenderId: currentUser.uid
                });
                
                logSystem.success(`Message envoyé avec succès: ${docRef.id}`);
                return docRef.id;
            } catch (error) {
                logSystem.error(`Erreur lors de l'envoi du message: ${error.message}`);
                
                // Mettre à jour le statut du message en attente s'il existe
                if (tempMessageId) {
                    updatePendingMessageStatus(tempMessageId, 'error');
                }
                
                throw error; // Re-throw l'erreur pour la gestion plus haut
            }
        }
        
        // Simuler le statut "en train d'écrire"
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            document.getElementById('typing-name').textContent = getDisplayName('user');
            typingIndicator.classList.add('active');
            
            // Faire défiler vers le bas pour voir l'indicateur
            const chatMessagesContainer = document.querySelector('.chat-messages-container');
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            
            return new Promise(resolve => {
                setTimeout(() => {
                    typingIndicator.classList.remove('active');
                    resolve();
                }, 1500 + Math.random() * 1000); // Durée aléatoire entre 1.5 et 2.5 secondes
            });
        }
        
        // Obtenir le nom d'affichage à partir de l'identifiant utilisateur
        function getDisplayName(userId) {
            switch(userId) {
                case 'user': return 'Utilisateur';
                case 'admin': return 'Admin';
                case currentUser?.uid: return 'Vous';
                default: return userId;
            }
        }
        
        // ================ FONCTIONS POUR LA VISIONNEUSE D'IMAGES ===============
        
        // Ouvrir la visionneuse d'images
        function openImageViewer(imageUrl) {
            const imageViewer = document.getElementById('image-viewer');
            const img = document.getElementById('image-viewer-img');
            const loader = document.getElementById('image-loader');
            
            // Réinitialiser le zoom et la position
            resetImageViewer();
            
            // Afficher le loader
            loader.style.display = 'block';
            img.style.display = 'none';
            
            // Charger l'image
            img.onload = function() {
                loader.style.display = 'none';
                img.style.display = 'block';
            };
            
            img.onerror = function() {
                loader.style.display = 'none';
                showNotification("Erreur lors du chargement de l'image", "error");
                closeImageViewer();
            };
            
            // Définir la source de l'image
            img.src = imageUrl;
            
            // Afficher la visionneuse
            imageViewer.classList.add('active');
            
            // Vibration pour feedback tactile
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }
        }
        
        // Fermer la visionneuse d'images
        function closeImageViewer() {
            const imageViewer = document.getElementById('image-viewer');
            imageViewer.classList.remove('active');
            resetImageViewer();
        }
        
        // Réinitialiser le zoom et la position de l'image
        function resetImageViewer() {
            currentImageScale = 1;
            currentImagePosition = { x: 0, y: 0 };
            
            const img = document.getElementById('image-viewer-img');
            img.style.transform = 'scale(1)';
            img.classList.remove('zoomed');
        }
        
        // Zoomer sur l'image
        function zoomInImage() {
            zoomImage(currentImageScale + 0.5);
        }
        
        // Dézoomer l'image
        function zoomOutImage() {
            zoomImage(Math.max(0.5, currentImageScale - 0.5));
        }
        
        // Appliquer un niveau de zoom spécifique
        function zoomImage(scale) {
            const img = document.getElementById('image-viewer-img');
            
            // Limiter le zoom entre 0.5 et 5
            currentImageScale = Math.max(0.5, Math.min(5, scale));
            
            // Appliquer le zoom
            img.style.transform = `translate(${currentImagePosition.x}px, ${currentImagePosition.y}px) scale(${currentImageScale})`;
            
            // Ajouter/supprimer la classe zoomed
            if (currentImageScale > 1) {
                img.classList.add('zoomed');
            } else {
                img.classList.remove('zoomed');
                // Réinitialiser la position si on revient à l'échelle 1
                if (currentImageScale === 1) {
                    currentImagePosition = { x: 0, y: 0 };
                    img.style.transform = 'scale(1)';
                }
            }
        }
        
        // Télécharger l'image actuellement affichée
        function downloadViewerImage() {
            const img = document.getElementById('image-viewer-img');
            const imageUrl = img.src;
            
            // Créer un lien de téléchargement
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = 'image_' + Date.now() + '.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification("Téléchargement démarré", "success");
        }
        
        // ================ FONCTIONS POUR LA SÉLECTION ================
        
        // Démarrer le mode sélection
        function startSelectionMode() {
            if (isSelectionMode) return;
            
            logSystem.info("Démarrage du mode sélection des conversations");
            
            isSelectionMode = true;
            selectionModeType = 'conversations';
            selectedItems.clear();
            
            // Afficher la barre d'action
            const selectionBar = document.getElementById('selection-action-bar');
            selectionBar.classList.add('active');
            document.getElementById('selection-action-count').textContent = '0 sélectionné';
            
            // Mettre à jour la barre d'actions pour les discussions
            document.getElementById('selection-delete').textContent = 'Supprimer';
            
            updateSelectionCount();
        }
        
        // Fonction pour basculer la sélection d'un élément
        function toggleItemSelection(item, itemId) {
            if (!isSelectionMode) return;
            
            // Obtenir l'ID de l'élément s'il n'est pas fourni
            if (!itemId) {
                itemId = item.getAttribute('data-id');
            }
            
            if (selectedItems.has(itemId)) {
                logSystem.info(`Désélection de l'élément: ${itemId}`);
                selectedItems.delete(itemId);
                item.classList.remove('selected');
            } else {
                logSystem.info(`Sélection de l'élément: ${itemId}`);
                selectedItems.add(itemId);
                item.classList.add('selected');
            }
            
            updateSelectionCount();
        }
        
        // Fonction pour sélectionner/désélectionner un message
        function toggleMessageSelection(message) {
            var messageId = message.getAttribute('data-id');
            
            if (selectedMessages.has(messageId)) {
                logSystem.info(`Désélection du message: ${messageId}`);
                selectedMessages.delete(messageId);
                message.classList.remove('selected');
            } else {
                logSystem.info(`Sélection du message: ${messageId}`);
                selectedMessages.add(messageId);
                message.classList.add('selected');
            }
            
            updateSelectionCount();
        }
        
        // Fonction pour mettre à jour le compteur de sélection
        function updateSelectionCount() {
            var count = selectionModeType === 'messages' ? selectedMessages.size : selectedItems.size;
            
            // Mise à jour du compteur dans la barre d'action
            if (selectionModeType === 'conversations') {
                document.getElementById('selection-action-count').textContent = 
                    count === 0 ? 'Aucune sélection' : 
                    count === 1 ? '1 sélectionné' : 
                    count + ' sélectionnés';
            } else {
                document.getElementById('selected-count').textContent = 
                    count === 0 ? 'Aucune sélection' : 
                    count === 1 ? '1 sélectionné' : 
                    count + ' sélectionnés';
            }
            
            // Sortir du mode sélection si aucun élément n'est sélectionné et après un délai
            if (count === 0 && isSelectionMode) {
                setTimeout(() => {
                    if ((selectionModeType === 'messages' && selectedMessages.size === 0) ||
                        (selectionModeType === 'conversations' && selectedItems.size === 0)) {
                        exitSelectionMode();
                    }
                }, 200);
            }
        }
        
        // Fonction pour démarrer le mode de sélection des messages
        function startMessagesSelectionMode() {
            closeOptionsMenu();
            
            if (isSelectionMode) return;
            
            logSystem.info("Démarrage du mode sélection des messages");
            
            isSelectionMode = true;
            selectionModeType = 'messages';
            selectedMessages.clear();
            
            // Mettre à jour l'en-tête
            document.getElementById('header-action').innerHTML = '<div class="select-all-btn" style="color: var(--primary-color);">Tout</div>';
            document.getElementById('header-action').querySelector('.select-all-btn').addEventListener('click', selectAllMessages);
            
            // Activer le menu d'actions
            document.getElementById('message-actions').classList.add('active');
            
            // Désactiver la saisie de message pour le mode sélection de messages
            document.getElementById('chat-input').disabled = true;
            document.getElementById('send-button').disabled = true;
        }
        
        // Fonction pour quitter le mode de sélection
        function exitSelectionMode(type) {
            if (!isSelectionMode) return;
            
            if (!type) type = selectionModeType;
            
            logSystem.info(`Sortie du mode sélection: ${type}`);
            
            isSelectionMode = false;
            
            // Masquer la barre d'action
            document.getElementById('selection-action-bar').classList.remove('active');
            
            if (type === 'messages') {
                // Réinitialiser les sélections de messages
                selectedMessages.clear();
                document.querySelectorAll('.message.selected').forEach(msg => {
                    msg.classList.remove('selected');
                });
                
                // Fermer le menu des actions de messages
                document.getElementById('message-actions').classList.remove('active');
                
                // Réactiver la saisie
                document.getElementById('chat-input').disabled = false;
                document.getElementById('send-button').disabled = false;
                
                // Restaurer l'en-tête de chat
                document.getElementById('header-title').innerText = currentContact;
                document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
                
                // Réattacher l'événement d'options
                document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            } else {
                // Réinitialiser les sélections de conversations
                selectedItems.clear();
                document.querySelectorAll('.chat-item.selected, .user-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Restaurer l'en-tête
                document.getElementById('header-title').innerText = currentSection.charAt(0).toUpperCase() + currentSection.slice(1);
                document.getElementById('header-action').innerHTML = '<span class="notification-icon" id="options-button"><i class="fas fa-ellipsis-v"></i></span>';
                
                // Réattacher l'événement d'options
                document.getElementById('options-button').addEventListener('click', toggleOptionsMenu);
            }
            
            selectionModeType = '';
        }
        
        // Fonction pour sélectionner tous les messages
        function selectAllMessages() {
            var messages = document.querySelectorAll('.message');
            
            // Si tous les messages sont déjà sélectionnés, désélectionner tous
            const allSelected = selectedMessages.size === messages.length;
            
            logSystem.info(`Sélection de tous les messages: ${allSelected ? 'désélection' : 'sélection'}`);
            
            if (allSelected) {
                // Désélectionner tous les messages
                selectedMessages.clear();
                messages.forEach(msg => {
                    msg.classList.remove('selected');
                });
            } else {
                // Sélectionner tous les messages
                messages.forEach(msg => {
                    const messageId = msg.getAttribute('data-id');
                    selectedMessages.add(messageId);
                    msg.classList.add('selected');
                });
            }
            
            updateSelectionCount();
        }
        
        // ================ FONCTIONS POUR LES ACTIONS ================
        
        // Effacer une conversation
        async function clearConversation() {
            if (!currentDiscussionId) return;
            
            logSystem.info(`Effacement de la conversation: ${currentDiscussionId}`);
            
            try {
                // Afficher une boite de dialogue de confirmation
                document.getElementById('confirmation-text').textContent = 
                    'Êtes-vous sûr de vouloir effacer tous les messages de cette conversation ?';
                
                document.getElementById('confirmation-confirm').onclick = async function() {
                    closeConfirmationDialog();
                    
                    // Afficher un indicateur de chargement
                    const messagesContainer = document.getElementById('chat-messages');
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--inactive-text);">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                            <div style="margin-top: 10px;">Suppression des messages...</div>
                        </div>
                    `;
                    
                    try {
                        // Déterminer le chemin de la collection de messages
                        let messagesRef;
                        
                        if (currentDiscussionType === 'group') {
                            messagesRef = collection(db, "groups", currentDiscussionId, "messages");
                        } else {
                            messagesRef = collection(db, "discussions", currentDiscussionId, "messages");
                        }
                        
                        // Récupérer tous les messages
                        const messagesSnapshot = await getDocs(messagesRef);
                        
                        // Supprimer chaque message
                        for (const doc of messagesSnapshot.docs) {
                            await deleteDoc(doc.ref);
                        }
                        
                        // Mettre à jour l'aperçu de la conversation
                        updateChatUI("Conversation effacée");
                        
                        logSystem.success(`Conversation effacée avec succès`);
                        showNotification("Conversation effacée avec succès", "success");
                        
                        // Les messages seront automatiquement mis à jour grâce à l'écouteur onSnapshot
                    } catch (error) {
                        logSystem.error(`Erreur lors de l'effacement de la conversation: ${error.message}`);
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                                <i class="fas fa-exclamation-circle" style="font-size: 24px;"></i>
                                <div style="margin-top: 10px;">Erreur lors de la suppression des messages</div>
                            </div>
                        `;
                        showNotification("Erreur lors de l'effacement de la conversation", "error");
                    }
                };
                
                // Afficher la boite de dialogue
                document.getElementById('confirmation-dialog').classList.add('active');
                document.getElementById('overlay').classList.add('active');
                
                // Fermer le menu d'options
                closeOptionsMenu();
            } catch (error) {
                logSystem.error(`Erreur lors de la préparation de l'effacement: ${error.message}`);
                showNotification("Erreur lors de la préparation de l'effacement", "error");
                closeOptionsMenu();
            }
        }
        
        // Mettre à jour l'interface après une action sur une discussion
        function updateChatUI(statusMessage) {
            if (!currentDiscussionId) return;
            
            try {
                // Mettre à jour l'aperçu dans la liste des conversations
                const chatItems = document.querySelectorAll('.chat-item');
                for (let i = 0; i < chatItems.length; i++) {
                    if (chatItems[i].getAttribute('data-id') === currentDiscussionId) {
                        const subtitle = chatItems[i].querySelector('.item-subtitle');
                        if (subtitle) {
                            subtitle.innerHTML = statusMessage;
                        }
                        
                        // Mettre à jour l'heure
                        const time = chatItems[i].querySelector('.item-time');
                        if (time) {
                            time.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        }
                        
                        break;
                    }
                }
            } catch (error) {
                logSystem.error(`Erreur lors de la mise à jour de l'interface: ${error.message}`);
            }
        }
        
        // Supprimer les éléments sélectionnés (discussions ou messages)
        function deleteSelectedItems() {
            if (selectionModeType === 'conversations') {
                showDeleteConversationsConfirmation();
            } else if (selectionModeType === 'messages') {
                showDeleteMessageOptions();
            }
        }
        
        // Afficher la confirmation pour supprimer les conversations sélectionnées
        function showDeleteConversationsConfirmation() {
            if (selectedItems.size === 0) return;
            
            document.getElementById('confirmation-text').textContent = 
                `Êtes-vous sûr de vouloir supprimer ${selectedItems.size === 1 ? 'ce groupe' : 'ces ' + selectedItems.size + ' groupes'} ?`;
            
            document.getElementById('confirmation-confirm').onclick = function() {
                deleteSelectedConversations();
                closeConfirmationDialog();
            };
            
            document.getElementById('confirmation-dialog').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // Supprimer les conversations sélectionnées
        async function deleteSelectedConversations() {
            if (selectedItems.size === 0) return;
            
            logSystem.info(`Suppression de ${selectedItems.size} conversations`);
            
            try {
                const itemsToDelete = Array.from(selectedItems);
                let successCount = 0;
                let errorCount = 0;
                
                // Pour chaque conversation sélectionnée
                for (const discussionId of itemsToDelete) {
                    try {
                        // Récupérer le type de discussion
                        const chatItem = document.querySelector(`.chat-item[data-id="${discussionId}"]`);
                        const discussionType = chatItem?.getAttribute('data-type') || 'group';
                        
                        // Ajouter l'animation de suppression
                        if (chatItem) {
                            chatItem.classList.add('deleting');
                        }
                        
                        // Déterminer la référence à la collection de messages
                        let messagesRef;
                        let discussionRef;
                        
                        if (discussionType === 'group') {
                            // Pour les groupes spéciaux, on ne peut que quitter le groupe
                            if (discussionId === 'Betforce' || discussionId === 'BetNews') {
                                const groupRef = doc(db, "groups", discussionId);
                                
                                // Retirer l'utilisateur du groupe
                                await updateDoc(groupRef, {
                                    members: arrayRemove(currentUser.uid)
                                });
                                
                                logSystem.success(`Quitté le groupe ${discussionId}`);
                                successCount++;
                            } else {
                                // Pour les groupes créés par l'utilisateur ou s'il est admin
                                const groupRef = doc(db, "groups", discussionId);
                                const groupData = (await getDoc(groupRef)).data();
                                
                                if (groupData.createdBy === currentUser.uid || isAdmin) {
                                    // Supprimer le groupe et ses messages
                                    await deleteGroupAndMessages(discussionId);
                                } else {
                                    // Quitter le groupe
                                    await updateDoc(groupRef, {
                                        members: arrayRemove(currentUser.uid)
                                    });
                                }
                                
                                successCount++;
                            }
                        }
                    } catch (error) {
                        logSystem.error(`Erreur lors de la suppression de ${discussionId}: ${error.message}`);
                        errorCount++;
                    }
                }
                
                // Rafraîchir la liste des conversations après un court délai pour l'animation
                setTimeout(() => {
                    loadConversations();
                    
                    // Sortir du mode sélection
                    exitSelectionMode();
                    
                    // Afficher un message de succès/erreur
                    if (errorCount === 0) {
                        showNotification(`${successCount} conversation(s) supprimée(s) avec succès`, "success");
                    } else if (successCount === 0) {
                        showNotification(`Erreur: impossible de supprimer les conversations`, "error");
                    } else {
                        showNotification(`${successCount} conversation(s) supprimée(s), ${errorCount} échec(s)`, "info");
                    }
                }, 500);
                
            } catch (error) {
                logSystem.error(`Erreur lors de la suppression des conversations: ${error.message}`);
                showNotification("Erreur lors de la suppression des conversations", "error");
                exitSelectionMode();
            }
        }
        
        // Supprimer un groupe et tous ses messages
        async function deleteGroupAndMessages(groupId) {
            if (!groupId) return;
            
            try {
                // Supprimer tous les messages du groupe
                const messagesRef = collection(db, "groups", groupId, "messages");
                const messagesSnapshot = await getDocs(messagesRef);
                
                // Supprimer chaque message
                for (const doc of messagesSnapshot.docs) {
                    await deleteDoc(doc.ref);
                }
                
                // Supprimer le groupe lui-même
                const groupRef = doc(db, "groups", groupId);
                await deleteDoc(groupRef);
                
                logSystem.success(`Groupe ${groupId} et ses messages supprimés`);
                return true;
            } catch (error) {
                logSystem.error(`Erreur lors de la suppression du groupe ${groupId}: ${error.message}`);
                throw error;
            }
        }
        
        // Afficher le dialogue de suppression des messages avec options
        function showDeleteMessageOptions() {
            if (selectedMessages.size === 0) return;
            
            logSystem.info(`Affichage des options de suppression pour ${selectedMessages.size} messages`);
            
            // Réinitialiser les options
            selectedDeleteOption = 'for-me';
            document.getElementById('delete-for-me').classList.add('selected');
            document.getElementById('delete-for-all').classList.remove('selected');
            
            // Afficher le dialogue
            document.getElementById('delete-message-dialog').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // Sélectionner une option de suppression
        function selectDeleteOption(option) {
            // Réinitialiser les options
            document.getElementById('delete-for-me').classList.remove('selected');
            document.getElementById('delete-for-all').classList.remove('selected');
            
            // Sélectionner l'option cliquée
            if (option === 'for-me') {
                document.getElementById('delete-for-me').classList.add('selected');
            } else {
                document.getElementById('delete-for-all').classList.add('selected');
            }
            
            selectedDeleteOption = option;
            logSystem.info(`Option de suppression sélectionnée: ${option}`);
        }
        
        // Fermer le dialogue de suppression des messages
        function closeDeleteMessageDialog() {
            document.getElementById('delete-message-dialog').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Confirmer la suppression des messages
        async function confirmDeleteMessages() {
            if (selectedMessages.size === 0 || !currentDiscussionId) return;
            
            logSystem.info(`Confirmation de suppression de ${selectedMessages.size} messages (option: ${selectedDeleteOption})`);
            
            // Fermer le dialogue avant l'animation
            closeDeleteMessageDialog();
            
            // Tableau pour stocker les IDs des messages à supprimer
            const messagesToDelete = Array.from(selectedMessages);
            
            try {
                // Déterminer la collection de messages
                let messagesCollection;
                if (currentDiscussionType === 'group') {
                    messagesCollection = collection(db, "groups", currentDiscussionId, "messages");
                } else {
                    messagesCollection = collection(db, "discussions", currentDiscussionId, "messages");
                }
                
                // Animation de désintégration pour les messages
                const messageElements = [];
                for (const messageId of messagesToDelete) {
                    const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
                    if (messageElement) {
                        messageElements.push(messageElement);
                        messageElement.classList.add('disintegrating');
                    }
                }
                
                // Attendre la fin de l'animation avant de supprimer les messages
                setTimeout(async () => {
                    try {
                        // Pour chaque message à supprimer
                        for (const messageId of messagesToDelete) {
                            // Si c'est juste "pour moi", on n'a pas besoin de faire de requête Firestore
                            // car les messages seront rechargés automatiquement via l'écouteur onSnapshot
                            if (selectedDeleteOption === 'for-all') {
                                const messageRef = doc(messagesCollection, messageId);
                                await deleteDoc(messageRef);
                                logSystem.success(`Message ${messageId} supprimé de Firestore`);
                            }
                        }
                        
                        // Sortir du mode sélection
                        exitSelectionMode();
                        
                        // Afficher une notification de succès
                        showNotification(
                            selectedDeleteOption === 'for-me' ? 
                            `${messagesToDelete.length} message(s) supprimé(s) pour vous` : 
                            `${messagesToDelete.length} message(s) supprimé(s) pour tout le monde`,
                            "success"
                        );
                    } catch (error) {
                        logSystem.error(`Erreur lors de la suppression des messages: ${error.message}`);
                        showNotification("Erreur lors de la suppression des messages", "error");
                    }
                }, 800); // Attendre la fin de l'animation
            } catch (error) {
                logSystem.error(`Erreur lors de la suppression des messages: ${error.message}`);
                showNotification("Erreur lors de la suppression des messages", "error");
                exitSelectionMode();
            }
        }
        
        // Ouvrir le dialogue de transfert de messages
        async function forwardSelectedMessages() {
            if (selectedMessages.size === 0 || !currentDiscussionId) return;
            
            logSystem.info(`Préparation du transfert de ${selectedMessages.size} messages`);
            
            try {
                // Déterminer la collection de messages
                let messagesCollection;
                if (currentDiscussionType === 'group') {
                    messagesCollection = collection(db, "groups", currentDiscussionId, "messages");
                } else {
                    messagesCollection = collection(db, "discussions", currentDiscussionId, "messages");
                }
                
                // Collecter les messages sélectionnés
                messagesForForward = [];
                for (const messageId of selectedMessages) {
                    try {
                        const messageDoc = await getDoc(doc(messagesCollection, messageId));
                        if (messageDoc.exists()) {
                            messagesForForward.push({
                                id: messageId,
                                ...messageDoc.data()
                            });
                        }
                    } catch (error) {
                        logSystem.error(`Erreur lors de la récupération du message ${messageId}: ${error.message}`);
                    }
                }
                
                if (messagesForForward.length === 0) {
                    showNotification("Aucun message à transférer", "error");
                    return;
                }
                
                // Mettre à jour le badge du compteur
                document.getElementById('forward-count-badge').textContent = messagesForForward.length;
                
                // Remplir la liste des contacts
                const contactsList = document.getElementById('forward-contacts-list');
                contactsList.innerHTML = '';
                
                // Récupérer tous les groupes dont l'utilisateur est membre
                const conversations = [];
                
                // Récupérer les groupes
                const groupsRef = collection(db, "groups");
                const groupsQuery = query(
                    groupsRef,
                    where("members", "array-contains", currentUser.uid)
                );
                
                const groupsSnapshot = await getDocs(groupsQuery);
                
                for (const groupDoc of groupsSnapshot.docs) {
                    // Ne pas inclure le groupe actuel
                    if (groupDoc.id === currentDiscussionId) continue;
                    
                    const groupData = groupDoc.data();
                    
                    conversations.push({
                        id: groupDoc.id,
                        name: groupData.name,
                        isGroup: true,
                        type: 'group'
                    });
                }
                
                // Trier par nom
                conversations.sort((a, b) => a.name.localeCompare(b.name));
                
                // Créer les éléments pour chaque conversation
                conversations.forEach(conv => {
                    const contactItem = document.createElement('div');
                    contactItem.className = 'chat-item';
                    contactItem.onclick = function() { forwardMessagesTo(conv.id, conv.name, conv.type); };
                    
                    // Choisir la classe d'icône appropriée
                    let iconClass = 'group-pic';
                    let iconContent = '<i class="fas fa-users" style="color: white;"></i>';
                    
                    if (conv.name === 'BetNews') {
                        iconClass = 'news-group-pic';
                        iconContent = '<i class="fas fa-newspaper" style="color: white;"></i>';
                    }
                    
                    contactItem.innerHTML = `
                        <div class="${iconClass}">
                            ${iconContent}
                        </div>
                        <div class="item-content">
                            <div class="item-title">${conv.name}</div>
                        </div>
                    `;
                    
                    contactsList.appendChild(contactItem);
                });
                
                if (conversations.length === 0) {
                    contactsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <div class="empty-state-title">Aucun groupe</div>
                            <div class="empty-state-text">Vous n'avez pas d'autres groupes pour transférer des messages</div>
                        </div>
                    `;
                }
                
                // Afficher le dialogue
                document.getElementById('forward-dialog').classList.add('active');
            } catch (error) {
                logSystem.error(`Erreur lors de la préparation du transfert: ${error.message}`);
                showNotification("Erreur lors de la préparation du transfert", "error");
            }
        }
        
        // Fermer le dialogue de transfert
        function closeForwardDialog() {
            document.getElementById('forward-dialog').classList.remove('active');
            messagesForForward = [];
        }
        
                // Transférer les messages à un destinataire
        async function forwardMessagesTo(targetId, targetName, targetType) {
            if (messagesForForward.length === 0) return;
            
            logSystem.info(`Transfert de ${messagesForForward.length} messages vers ${targetName} (${targetId})`);
            targetContactForForward = targetName;
            
            // Fermer le dialogue de transfert
            closeForwardDialog();
            
            // Afficher une notification de chargement
            showNotification(`Transfert vers ${targetName}...`, "info");
            
            try {
                // Déterminer la collection de messages cible
                let targetMessagesCollection;
                if (targetType === 'group') {
                    targetMessagesCollection = collection(db, "groups", targetId, "messages");
                } else {
                    targetMessagesCollection = collection(db, "discussions", targetId, "messages");
                }
                
                // Pour chaque message
                for (const message of messagesForForward) {
                    // Créer le nouveau message
                    const newMessage = {
                        senderId: currentUser.uid,
                        createdAt: serverTimestamp(),
                        status: 'sent'
                    };
                    
                    // Ajouter le texte s'il existe
                    if (message.text && message.text.trim() !== '') {
                        newMessage.text = message.text;
                        newMessage.type = 'text';
                    }
                    
                    // Ajouter l'image s'il en existe une
                    if (message.image) {
                        newMessage.image = message.image;
                        newMessage.type = 'image';
                    } else if (message.imageUrl) {
                        newMessage.image = message.imageUrl;
                        newMessage.type = 'image';
                    }
                    
                    // Ajouter au message qu'il a été transféré
                    if (!newMessage.text) {
                        newMessage.text = '';
                    }
                    newMessage.forwarded = true;
                    
                    // Ajouter le message à la collection cible
                    await addDoc(targetMessagesCollection, newMessage);
                }
                
                // Mettre à jour le dernier message de la discussion cible
                const discussionRef = targetType === 'group' 
                    ? doc(db, "groups", targetId)
                    : doc(db, "discussions", targetId);
                
                await updateDoc(discussionRef, {
                    lastMessage: "Message transféré",
                    lastMessageTime: serverTimestamp(),
                    lastSenderId: currentUser.uid
                });
                
                // Sortir du mode sélection
                exitSelectionMode();
                
                // Afficher une notification de succès
                showNotification(`${messagesForForward.length} message(s) transféré(s) à ${targetName}`, "success");
                
                logSystem.success(`Messages transférés avec succès`);
            } catch (error) {
                logSystem.error(`Erreur lors du transfert des messages: ${error.message}`);
                showNotification("Erreur lors du transfert des messages", "error");
            } finally {
                // Réinitialiser
                messagesForForward = [];
                targetContactForForward = '';
            }
        }
        
        // Copier les messages sélectionnés
        function copySelectedMessages() {
            if (selectedMessages.size === 0) return;
            
            logSystem.info(`Copie de ${selectedMessages.size} messages`);
            
            try {
                // Collecter le texte des messages sélectionnés
                const messagesToCopy = [];
                
                document.querySelectorAll('.message.selected').forEach(msg => {
                    // Ne pas inclure les images et autres éléments non textuels
                    const textContent = msg.textContent.trim();
                    if (textContent) {
                        messagesToCopy.push(textContent);
                    }
                });
                
                if (messagesToCopy.length === 0) {
                    showNotification("Aucun contenu texte à copier", "error");
                    return;
                }
                
                // Assembler le texte et le copier dans le presse-papiers
                const textToCopy = messagesToCopy.join('\n\n');
                
                // Utiliser l'API Clipboard pour la copie
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        logSystem.success(`Texte copié dans le presse-papiers`);
                        showNotification("Texte copié dans le presse-papiers", "success");
                        
                        // Sortir du mode sélection
                        exitSelectionMode();
                    })
                    .catch((error) => {
                        logSystem.error(`Erreur lors de la copie du texte: ${error.message}`);
                        showNotification("Erreur lors de la copie du texte", "error");
                    });
            } catch (error) {
                logSystem.error(`Erreur lors de la copie des messages: ${error.message}`);
                showNotification("Erreur lors de la copie des messages", "error");
            }
        }
        
        // Répondre au message sélectionné
        function replyToSelectedMessage() {
            if (selectedMessages.size !== 1) {
                showNotification("Veuillez sélectionner un seul message pour répondre", "error");
                return;
            }
            
            logSystem.info(`Préparation de la réponse au message sélectionné`);
            
            try {
                // Récupérer l'élément de message sélectionné
                const messageId = selectedMessages.values().next().value;
                const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
                
                if (!messageElement) {
                    showNotification("Message introuvable", "error");
                    return;
                }
                
                // ID de l'expéditeur
                const senderId = messageElement.getAttribute('data-from');
                
                // Récupérer le texte du message
                let messageText = messageElement.textContent.trim();
                
                // Vérifier s'il y a une image dans le message
                const hasImage = messageElement.querySelector('.message-image') !== null;
                
                // Si le message est uniquement une image
                if (hasImage && messageText === '') {
                    messageText = "Image";
                }
                
                // Créer l'objet de réponse
                replyToMessage = {
                    id: messageId,
                    text: messageText,
                    senderId: senderId,
                    senderName: senderId === currentUser.uid ? 'Vous' : getDisplayName(senderId)
                };
                
                // Sortir du mode sélection
                exitSelectionMode();
                
                // Focus sur l'input
                document.getElementById('chat-input').focus();
                
                // Montrer une notification
                showNotification('Répondre au message...', 'info');
                
                logSystem.success(`Préparation de la réponse terminée`);
            } catch (error) {
                logSystem.error(`Erreur lors de la préparation de la réponse: ${error.message}`);
                showNotification("Erreur lors de la préparation de la réponse", "error");
            }
        }
        
        // Rechercher dans la conversation
        function searchInConversation() {
            closeOptionsMenu();
            
            if (!currentDiscussionId) return;
            
            logSystem.info(`Ouverture de l'interface de recherche pour ${currentDiscussionId}`);
            
            // Afficher l'interface de recherche
            document.getElementById('search-overlay').classList.add('active');
            document.getElementById('message-search-input').value = '';
            document.getElementById('search-results').innerHTML = '<div class="no-results">Saisissez un terme à rechercher</div>';
            
            // Focus sur le champ de recherche
            setTimeout(() => {
                document.getElementById('message-search-input').focus();
            }, 300);
        }
        
        // Fermer l'interface de recherche
        function closeSearchInterface() {
            document.getElementById('search-overlay').classList.remove('active');
            document.getElementById('message-search-input').value = '';
            document.getElementById('search-results').innerHTML = '';
            
            logSystem.info(`Interface de recherche fermée`);
        }
        
        // Rechercher dans les messages
        async function searchMessages() {
            const searchTerm = document.getElementById('message-search-input').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            
            if (searchTerm === '') {
                resultsContainer.innerHTML = '<div class="no-results">Saisissez un terme à rechercher</div>';
                return;
            }
            
            logSystem.info(`Recherche de "${searchTerm}" dans les messages`);
            
            // Afficher un indicateur de chargement
            resultsContainer.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary-color);"></i>
                    <div style="margin-top: 10px; color: var(--inactive-text);">Recherche en cours...</div>
                </div>
            `;
            
            try {
                // Déterminer la collection de messages
                let messagesCollection;
                if (currentDiscussionType === 'group') {
                    messagesCollection = collection(db, "groups", currentDiscussionId, "messages");
                } else {
                    messagesCollection = collection(db, "discussions", currentDiscussionId, "messages");
                }
                
                // Récupérer tous les messages
                const messagesQuery = query(messagesCollection, orderBy("createdAt", "desc"));
                const messagesSnapshot = await getDocs(messagesQuery);
                
                // Filtrer les messages contenant le terme de recherche
                const matchingMessages = [];
                
                messagesSnapshot.forEach(doc => {
                    const messageData = doc.data();
                    
                    // Vérifier si le message contient du texte
                    if (messageData.text && typeof messageData.text === 'string') {
                        // Vérifier si le terme de recherche est présent dans le texte
                        if (messageData.text.toLowerCase().includes(searchTerm)) {
                            matchingMessages.push({
                                id: doc.id,
                                ...messageData,
                                timestamp: messageData.createdAt ? messageData.createdAt.toDate() : new Date()
                            });
                        }
                    }
                });
                
                // Si aucun résultat
                if (matchingMessages.length === 0) {
                    resultsContainer.innerHTML = '<div class="no-results">Aucun résultat trouvé</div>';
                    return;
                }
                
                // Trier les résultats par date (plus récents en premier)
                matchingMessages.sort((a, b) => b.timestamp - a.timestamp);
                
                // Afficher les résultats
                resultsContainer.innerHTML = '';
                
                for (const message of matchingMessages) {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.setAttribute('data-id', message.id);
                    
                    // Mettre en évidence le terme recherché
                    let highlightedText = message.text;
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    highlightedText = highlightedText.replace(regex, '<span class="search-highlight">$1</span>');
                    
                    // Format de la date
                    const dateStr = message.timestamp.toLocaleDateString() + ' ' + 
                                    message.timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    // Afficher le nom de l'expéditeur pour les groupes
                    let senderInfo = '';
                    if (currentDiscussionType === 'group') {
                        senderInfo = `<span><strong>${getDisplayName(message.senderId)}</strong> • </span>`;
                    }
                    
                    resultItem.innerHTML = `
                        <div class="search-result-text">${highlightedText}</div>
                        <div class="search-result-info">
                            ${senderInfo}
                            <span>${dateStr}</span>
                        </div>
                    `;
                    
                    // Ajouter un événement pour aller au message
                    resultItem.addEventListener('click', function() {
                        // Aller au message dans la conversation
                        closeSearchInterface();
                        scrollToMessage(this.getAttribute('data-id'));
                    });
                    
                    resultsContainer.appendChild(resultItem);
                }
                
                logSystem.success(`${matchingMessages.length} résultats trouvés`);
            } catch (error) {
                logSystem.error(`Erreur lors de la recherche: ${error.message}`);
                resultsContainer.innerHTML = `
                    <div class="no-results" style="color: var(--danger-color);">
                        Erreur lors de la recherche
                    </div>
                `;
            }
        }
        
        // Faire défiler vers un message spécifique
        function scrollToMessage(messageId) {
            // Attendre un peu pour être sûr que le message est chargé
            setTimeout(() => {
                const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
                
                if (messageElement) {
                    // Définir la position de défilement
                    const container = document.querySelector('.chat-messages-container');
                    const messageTop = messageElement.offsetTop;
                    container.scrollTop = messageTop - 100; // Décalage pour voir les messages au-dessus
                    
                    // Mettre en évidence le message
                    messageElement.classList.add('selected');
                    
                    // Supprimer la mise en évidence après un délai
                    setTimeout(() => {
                        messageElement.classList.remove('selected');
                    }, 2000);
                }
            }, 300);
        }
        
        // Changer le thème de l'application
        function changeTheme() {
            closeOptionsMenu();
            
            // Basculer le mode sombre
            const isDark = document.documentElement.classList.contains('dark');
            
            if (isDark) {
                document.documentElement.classList.remove('dark');
                document.getElementById('dark-toggle').checked = false;
            } else {
                document.documentElement.classList.add('dark');
                document.getElementById('dark-toggle').checked = true;
            }
            
            // Mettre à jour la couleur des messages envoyés en mode sombre
            if (!isDark) { // Si on vient de passer en mode sombre
                document.documentElement.style.setProperty('--chat-sent-bg', document.documentElement.style.getPropertyValue('--primary-color') || '#F7DC6F');
            } else { // Si on vient de passer en mode clair
                document.documentElement.style.setProperty('--chat-sent-bg', '#5D5CDE');
            }
            
            // Sauvegarder la préférence
            localStorage.setItem('ichatDarkMode', !isDark ? 'true' : 'false');
            
            logSystem.info(`Thème changé: ${!isDark ? 'sombre' : 'clair'}`);
            showNotification(`Thème ${!isDark ? 'sombre' : 'clair'} activé`, "success");
        }
        
        // Afficher le guide d'installation
        function showInstallGuide() {
            closeOptionsMenu();
            document.getElementById('install-guide').classList.add('active');
            logSystem.info("Guide d'installation affiché");
        }
        
        // Fermer le guide d'installation
        function closeInstallGuide() {
            document.getElementById('install-guide').classList.remove('active');
            logSystem.info("Guide d'installation fermé");
        }
        
        // Afficher la fenêtre de confirmation
        function showConfirmationDialog(message, confirmCallback) {
            document.getElementById('confirmation-text').textContent = message;
            document.getElementById('confirmation-confirm').onclick = confirmCallback;
            document.getElementById('confirmation-dialog').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // Fermer la fenêtre de confirmation
        function closeConfirmationDialog() {
            document.getElementById('confirmation-dialog').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Afficher la confirmation de suppression de compte
        function showDeleteAccountConfirmation() {
            document.getElementById('delete-account-dialog').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            logSystem.info("Confirmation de suppression de compte affichée");
        }
        
        // Fermer la confirmation de suppression de compte
        function closeDeleteAccountDialog() {
            document.getElementById('delete-account-dialog').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        // Afficher une popup de succès
        function showSuccessPopup(title, message, buttonCallback) {
            document.getElementById('success-title').textContent = title;
            document.getElementById('success-message').textContent = message;
            
            // Configurer le bouton
            const button = document.getElementById('success-button');
            
            // Supprimer les anciennes gestionnaires
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            // Ajouter le nouveau gestionnaire
            newButton.addEventListener('click', buttonCallback || function() {
                document.getElementById('success-popup').classList.remove('active');
            });
            
            // Afficher la popup
            document.getElementById('success-popup').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        // Fonction pour sélectionner une image
        function selectImage() {
            // Déclencher le sélecteur de fichier
            document.getElementById('image-input').click();
        }
        
        // Fonction pour nettoyer l'aperçu d'image
        function clearImagePreview() {
            document.getElementById('image-preview').classList.remove('active');
            document.getElementById('preview-img').src = '';
            selectedImage = null;
        }
        
        // Ouvrir le clavier d'émojis
        function openEmojiKeyboard() {
            // Utiliser le clavier natif d'émojis en plaçant le focus
            const input = document.getElementById('chat-input');
            input.focus();
            
            // Pour mobile, on peut essayer de simuler l'activation du clavier émoji
            // en ajoutant un emoji au début puis en le supprimant
            if (window.navigator.userAgent.indexOf('Mobile') > -1) {
                const startPos = input.selectionStart;
                const endPos = input.selectionEnd;
                
                // Ajouter l'emoji puis le supprimer
                input.value = input.value.substring(0, startPos) + "😀" + input.value.substring(endPos);
                input.selectionStart = input.selectionEnd = startPos + 2;
                
                // Simuler un appui sur retour arrière
                setTimeout(() => {
                    const backspace = new KeyboardEvent('keydown', {
                        key: 'Backspace',
                        code: 'Backspace',
                        keyCode: 8,
                        which: 8,
                        bubbles: true
                    });
                    input.dispatchEvent(backspace);
                }, 50);
            }
        }
        
        // Afficher ou masquer le menu d'options
        function toggleOptionsMenu() {
            if (isOptionsMenuOpen) {
                closeOptionsMenu();
                return;
            }
            
            // Déterminer quel menu afficher selon le contexte
            const optionsMenu = document.getElementById('chat-interface').style.display === 'block' 
                ? document.getElementById('chat-options-menu')
                : currentSection === 'messages'
                    ? document.getElementById('messages-options-menu')
                    : document.getElementById('simple-options-menu');
            
            logSystem.info(`Affichage du menu d'options: ${optionsMenu.id}`);
            
            // Afficher le menu et l'overlay
            optionsMenu.classList.add('active');
            document.getElementById('overlay').classList.add('active');
            
            isOptionsMenuOpen = true;
        }
        
        // Fermer le menu d'options
        function closeOptionsMenu() {
            document.getElementById('chat-options-menu').classList.remove('active');
            document.getElementById('messages-options-menu').classList.remove('active');
            document.getElementById('simple-options-menu').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            
            isOptionsMenuOpen = false;
        }
        
        // Fermer tous les dialogues
        function closeAllDialogs() {
            closeOptionsMenu();
            closeConfirmationDialog();
            closeDeleteAccountDialog();
            closeDeleteMessageDialog();
            closeForwardDialog();
            closeInstallGuide();
            closeSearchInterface();
            
            document.getElementById('success-popup').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            
            logSystem.info("Tous les dialogues fermés");
        }
        
        // Masquer l'écran de chargement
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // Compléter la connexion
        async function completeLogin() {
            try {
                logSystem.info("Finalisation de la connexion");
                
                // Vérifier que l'utilisateur est défini
                if (!currentUser) {
                    logSystem.error("Utilisateur non défini lors de la finalisation de la connexion");
                    return;
                }
                
                // Récupérer le profil utilisateur
                const userData = await getUserData(currentUser.uid);
                
                if (!userData) {
                    logSystem.error("Profil utilisateur introuvable dans Firestore");
                    return;
                }
                
                // Stocker les données
                currentUserData = userData;
                isAdmin = userData.statut === 'admin';
                isLoggedIn = true;
                
                logSystem.success(`Connexion complétée pour: ${userData.email} (Admin: ${isAdmin})`);
                
                // Mettre à jour l'interface
                document.getElementById('profile-name-text').textContent = userData.displayName || userData.email.split('@')[0];
                document.getElementById('profile-email').textContent = userData.email;
                
                if (isAdmin) {
                    document.getElementById('admin-badge').style.display = 'inline-block';
                } else {
                    document.getElementById('admin-badge').style.display = 'none';
                }
                
                // Charger les préférences
                loadPreferences();
                
                // Masquer l'écran d'authentification
                document.getElementById('auth-screen').style.display = 'none';
                
                // Masquer l'écran de chargement
                hideLoading();
                
                // Charger les conversations
                changeTab('messages');
            } catch (error) {
                logSystem.error(`Erreur lors de la finalisation de la connexion: ${error.message}`);
                hideLoading();
            }
        }
        
        // Afficher l'écran de connexion
        function showLoginScreen() {
            hideLoading();
            document.getElementById('auth-screen').style.display = 'flex';
            changeAuthTab('login');
        }
        
        // Charger les préférences
        function loadPreferences() {
            try {
                // Charger la couleur personnalisée
                const savedColor = localStorage.getItem('ichatColor');
                if (savedColor) {
                    document.getElementById('color-picker').value = savedColor;
                    changeAppColor(savedColor);
                }
                
                // Charger le mode sombre
                const darkMode = localStorage.getItem('ichatDarkMode');
                if (darkMode) {
                    if (darkMode === 'true') {
                        document.documentElement.classList.add('dark');
                        document.getElementById('dark-toggle').checked = true;
                    } else {
                        document.documentElement.classList.remove('dark');
                        document.getElementById('dark-toggle').checked = false;
                    }
                }
                
                // Charger le mode débogage
                const debugMode = localStorage.getItem('ichatDebugMode');
                if (debugMode) {
                    isDebugMode = debugMode === 'true';
                    document.getElementById('debug-toggle').checked = isDebugMode;
                    document.getElementById('logs-toggle').style.display = isDebugMode ? 'flex' : 'none';
                }
            } catch (error) {
                logSystem.error(`Erreur lors du chargement des préférences: ${error.message}`);
            }
        }
        
        // Fonction d'initialisation
        function init() {
            logSystem.info("Initialisation de l'application");
            
            // Configurer les événements de l'interface
            setupUIEvents();
            setupAuthEvents();
            setupDarkMode();
            setupConnectionMonitoring();
            
            // Définir l'état initial
            document.getElementById('chat-interface').style.display = 'none';
            document.getElementById('logs-toggle').style.display = 'none';
            
            // Vérifier si l'utilisateur est déjà connecté
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // L'utilisateur est connecté
                    logSystem.info(`Utilisateur déjà connecté: ${user.email}`);
                    currentUser = user;
                    document.getElementById('auth-screen').style.display = 'none';
                    completeLogin();
                } else {
                    // L'utilisateur n'est pas connecté
                    logSystem.info("Aucun utilisateur connecté");
                    currentUser = null;
                    hideLoading();
                    showLoginScreen();
                }
            });
        }
        
        // Initialiser l'application
        init();
    </script>
    </body>
    </html>
